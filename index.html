<!DOCTYPE html>
<html lang="zh-CN">
 <head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <title>TPI å…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿ v22</title>

<script>
  const BACKEND_URL = 'https://tpi-backend.onrender.com';
</script>

<script>
// âœ… å¼ºåˆ¶æµ…è‰²æ¨¡å¼ï¼ˆå·²å–æ¶ˆæ·±è‰²æ¨¡å¼ï¼‰ï¼šä¸å½±å“ä»»ä½•ä¸šåŠ¡é€»è¾‘/åŒæ­¥/å¯¼å‡º
(function(){
  function forceLight(){
    try{
      document.documentElement.setAttribute('data-theme','light');
      if (document.body && document.body.classList){
        document.body.classList.remove('dark-mode');
        document.body.classList.remove('dark-theme');
      }
      localStorage.setItem('dark-mode','false');
      localStorage.setItem('tpi_theme','light');
      // æ¸…ç†æš—é»‘æ ·å¼/æŒ‰é’®ï¼ˆè‹¥æ—§ç¼“å­˜æˆ–æ—§è„šæœ¬æ›¾åˆ›å»ºï¼‰
      const s = document.getElementById('dark-mode-styles');
      if (s) s.remove();
      const btn = document.getElementById('dark-mode-toggle');
      if (btn) btn.remove();
    }catch(e){}
  }

  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  forceLight();

  // DOM å®Œæ•´åå†æ‰§è¡Œä¸€æ¬¡ï¼ˆé¿å…åç»­è„šæœ¬/ç¼“å­˜æ®‹ç•™ï¼‰
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', forceLight, { once:true });
  } else {
    setTimeout(forceLight, 0);
  }

  // å…¼å®¹ï¼šè‹¥é¡µé¢æŸå¤„ä»è°ƒç”¨æ—§çš„ä¸»é¢˜åˆ‡æ¢å‡½æ•°ï¼Œåˆ™å¼ºåˆ¶å›åˆ°æµ…è‰²
  window.toggleDarkThemeComplete = function(){ forceLight(); try{ window.tpiToast ? window.tpiToast('å·²å–æ¶ˆæ·±è‰²æ¨¡å¼ï¼šä¿æŒæµ…è‰²', 'info') : null; }catch(e){} };
  window.restoreDarkThemeComplete = function(){ forceLight(); };
})();
</script>
<script>
/* =========================================================
   æ—¥æœŸåˆå§‹åŒ–è„šæœ¬ - æœ€ä¼˜å…ˆæ‰§è¡Œ
   ç¡®ä¿é¡µé¢æ‰“å¼€æ—¶æ—¥æœŸè¾“å…¥æ¡†æ˜¾ç¤ºå½“å¤©çœŸå®æ—¥æœŸ
========================================================= */
(function() {
    // åœ¨DOMåŠ è½½å®Œæˆåç«‹å³è®¾ç½®ä»Šå¤©çš„æ—¥æœŸ
    function setTodayDate() {
        const dateInput = document.getElementById('date-input');
        if (dateInput) {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
            console.log('âœ… [æ—¥æœŸåˆå§‹åŒ–] è®¾ç½®ä¸ºä»Šå¤©:', dateInput.value);
        }
    }
    
    // å¤šé‡ä¿é™©ï¼šåœ¨ä¸åŒé˜¶æ®µéƒ½å°è¯•è®¾ç½®æ—¥æœŸ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setTodayDate);
    } else {
        setTodayDate();
    }
    
    // é¢å¤–ä¿é™©ï¼šå»¶è¿Ÿ100mså†æ£€æŸ¥ä¸€æ¬¡
    setTimeout(setTodayDate, 100);
})();
console.log('âœ… æ—¥æœŸåˆå§‹åŒ–è„šæœ¬å·²åŠ è½½');
</script>
<script>
/* =========================================================
   è‰ç¨¿7 Â· æ•°æ®å¯¼å‡ºä¸å¤‡ä»½ Â· ç‹¬è£è¡¥ä¸ v3
   æ”¾ç½®ä½ç½®ï¼š<head> å†…
   ç›®çš„ï¼šä¿è¯å‡½æ•°åœ¨ HTML onclick ä¹‹å‰å·²å­˜åœ¨
========================================================= */

window.exportAsJSON = function () {
    const data = {};
    for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        data[k] = localStorage.getItem(k);
    }
    const blob = new Blob(
        [JSON.stringify(data, null, 2)],
        { type: 'application/json' }
    );
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'TPI_export.json';
    a.click();
};

window.exportDataComplete = function () {
    window.exportAsJSON();
};

window.saveTpiData = function () {
    try {
        // ä¿å­˜å½“å‰æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        const obj = window.collectDailyData();
        const dateKey = Object.keys(obj || {})[0];
        if (dateKey) {
            localStorage.setItem(`tpi_data_${dateKey}`, JSON.stringify(obj[dateKey]));
        }
        
        alert('âœ… å½“å‰æ•°æ®å·²çœŸå®å†™å…¥æœ¬åœ°ç¼“å­˜ï¼ˆlocalStorageï¼‰');
        console.log('[SAVE] saved snapshot for', dateKey);
    } catch (e) {
        console.error('[SAVE] failed:', e);
        alert('âŒ ä¿å­˜å¤±è´¥ï¼šè¯·çœ‹æ§åˆ¶å°');
    }
};


window.loadTpiData = function () {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const r = new FileReader();
        r.onload = () => {
            const data = JSON.parse(r.result);
            Object.keys(data).forEach(k =>
                localStorage.setItem(k, data[k])
            );
            alert('æ•°æ®å·²æ¢å¤ï¼Œè¯·åˆ·æ–°é¡µé¢');
        };
        r.readAsText(file);
    };
    input.click();
};

console.log('âœ… ç‹¬è£è¡¥ä¸ v3 å·²åœ¨ <head> å¼ºåˆ¶åŠ è½½');
</script>
<script>
/* =========================================================
   ç‹¬è£è¡¥ä¸ v5 Â· collectDailyData å’Œ restoreUIFromData
   æ”¾ç½®ä½ç½®ï¼š<head> å†…
   ç›®çš„ï¼šè§£å†³å‡½æ•°æœªå®šä¹‰é—®é¢˜
========================================================= */

// å­—æ®µé…ç½®å¯¹è±¡
const FIELDS = {
  timeFields: [
    'bcm-morning-time', 'bcm-morning-yesterday-time',
    'bcm-evening-exit', 'bcm-evening-yesterday',
    'bcm-sleep-time', 'bcm-sleep-yesterday'
  ],
  scoreFields: [
    'tpi-total', 'ma7-score', 'ami-score', 'fli-score', 'sys-score', 'bonus-score',
    'bcm-morning-score', 'bcm-evening-score', 'bcm-sleep-score',
    'bcm-digital-score', 'bcm-afternoon-score',
    'hsm-core-score', 'hsm-morning-score', 'hsm-afternoon-score',
    'hsm-water-morning-score', 'hsm-water-afternoon-score', 'hsm-water-evening-score',
    'fli-core-score', 'fli-fragment-score'
  ],
  booleanFields: [
    'ignition-physical', 'ignition-micro-target', 'ignition-painless-start',
    'start-morning-block', 'start-afternoon-block', 'start-evening-block',
    'academic-dialogue', 'ami-scan-reading',
    'fli-vn', 'fli-en',
    'radar-reminder-active', 'radar-important',
    'sync-core-axioms', 'sync-sop', 'sync-formulas', 'sync-version',
    'sync-modules', 'sync-functions', 'sync-rules', 'sync-auto-backup'
  ],
  textFields: [
    'daily-summary', 'cliffhanger', 'first-action', 'daily-reflection',
    'misc-edit-content', 'fli-core-notes',
    'type-s-content-morning', 'type-s-content-afternoon',
    'type-s-content-evening1', 'type-s-content-evening2', 'type-s-content-flexible',
    'victory-1', 'victory-2', 'victory-3',
    'radar-title', 'radar-location', 'radar-organizer', 'radar-remarks',
    'json-import-area', 'bonus-reason', 'template-content-input'
  ],
  selectFields: [
    'tpi-rating', 'radar-time-mode', 'radar-recurrence',
    'radar-calendar-type', 'radar-recurrence-count',
    'radar-remind-advance', 'radar-remind-sameday',
    'bcm-digital-status', 'bcm-afternoon-status',
    'hsm-core-status', 'hsm-morning-status', 'hsm-afternoon-status',
    'hsm-water-morning-status', 'hsm-water-afternoon-status', 'hsm-water-evening-status',
    'injection-mode'
  ]
};

/* =========================
   v8ï¼šå…¨é¡µé¢çŠ¶æ€å¿«ç…§ï¼ˆè¾“å…¥/å‹¾é€‰ + è§„åˆ™ç”Ÿæˆæ˜¾ç¤ºï¼‰
   ç›®æ ‡ï¼š
   - äº‘ç«¯å®æ—¶ä¸Šä¼ çš„å†…å®¹å¿…é¡»"å®Œæ•´"
   - ä¸‹è½½åå¿…é¡»"çœŸæ¢å¤"
   - è·¨æ—¥æœŸæ¯”è¾ƒæ¨¡å—å¿…é¡»æ‹¿å¾—åˆ°å†å²æ•°æ®
========================= */


function __tpi_getSelectedDate() {
  let dateInput = document.getElementById('date-input');
  if (!dateInput) dateInput = document.querySelector('input[placeholder="ğŸ“… é€‰æ‹©æ—¥æœŸ"]');

  // âœ… ç”¨â€œæœ¬åœ°æ—¥æœŸâ€è€Œä¸æ˜¯ toISOString(UTC) â€”â€” å¦åˆ™è·¨æ—¶åŒºä¼šæŠŠ 2/1 è®°æˆ 1/31
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  const todayLocal = `${yyyy}-${mm}-${dd}`;

  return (dateInput && dateInput.value) ? dateInput.value : todayLocal;
}


// 1) æ”¶é›†å…¨éƒ¨è¡¨å•æ§ä»¶çŠ¶æ€ï¼ˆä¸ä¾èµ– FIELDSï¼‰
function __tpi_collectFormState() {
  const state = {};

  // âœ… æ”¶é›†èŒƒå›´ï¼šæ‰€æœ‰è¡¨å•æ§ä»¶ + å¯Œæ–‡æœ¬ï¼ˆcontenteditableï¼‰
  const controls = document.querySelectorAll('input, textarea, select, [contenteditable="true"]');

  // âœ… CSS é€‰æ‹©å™¨ç”Ÿæˆï¼ˆå°½é‡ç¨³å®šï¼šé‡åˆ° id å°±æˆªæ–­ï¼‰
  function cssEscape(s) {
    try { return (window.CSS && CSS.escape) ? CSS.escape(s) : s.replace(/[^a-zA-Z0-9_-]/g, '\\$&'); } catch(e) { return s; }
  }
  function cssPath(el) {
    if (!el) return null;
    if (el.id) return `#${cssEscape(el.id)}`;

    const parts = [];
    let node = el;
    while (node && node.nodeType === 1 && node !== document.body) {
      if (node.id) {
        parts.unshift(`#${cssEscape(node.id)}`);
        break;
      } else {
        const tag = node.tagName.toLowerCase();
        // nth-of-type
        let idx = 1;
        let sib = node;
        while ((sib = sib.previousElementSibling)) {
          if (sib.tagName.toLowerCase() === tag) idx++;
        }
        parts.unshift(`${tag}:nth-of-type(${idx})`);
        node = node.parentElement;
      }
    }
    return parts.length ? parts.join(' > ') : null;
  }

  // âœ… ä¸ºæ²¡æœ‰ id/name çš„æ§ä»¶åˆ†é… data-tpi-keyï¼ˆåŸºäº cssPathï¼Œé¡µé¢ç»“æ„ä¸å˜åˆ™ç¨³å®šï¼‰
  function getKeyFor(el, fallbackIdx) {
    if (el.id) return `#${el.id}`;
    if (el.getAttribute('data-tpi-key')) return `$${el.getAttribute('data-tpi-key')}`;

    const path = cssPath(el);
    if (path) {
      el.setAttribute('data-tpi-key', path);
      return `$${path}`;
    }

    // å…œåº•ï¼šæå°‘æ•°æƒ…å†µï¼ˆèŠ‚ç‚¹ä¸åœ¨ DOM æ ‘ä¸­ï¼‰
    return `!idx::${fallbackIdx}`;
  }

  controls.forEach((el, idx) => {
    // âœ… å…³é”®ï¼šæ•æ„Ÿå­—æ®µä¸è¿›å¿«ç…§ï¼ˆå¦åˆ™ä¼šè¢«åŒæ­¥åˆ° GitHub è§¦å‘ 409 / Secret Scanningï¼‰
    const id = (el && el.id) ? String(el.id) : '';
    const typeAttr = (el && el.getAttribute) ? (el.getAttribute('type') || '') : '';
    const type = String(typeAttr).toLowerCase();

    // token / password / secret ä¸€å¾‹è·³è¿‡ï¼ˆä½ å¯ä»¥æŒ‰éœ€æ‰©å±•å…³é”®è¯ï¼‰
    if (id === 'github-token' || id === 'github_token' || /token|secret|password|pat/i.test(id) || type === 'password') {
      return;
    }

    const key = getKeyFor(el, idx);
    if (!key) return;

    const tag = el.tagName.toLowerCase();

    const item = { tag, type };

    // âœ… ä¿å­˜ selectorï¼Œæ¢å¤æ—¶ä¼˜å…ˆç”¨ selectorï¼ˆæ¯” name::idx ç¨³ï¼‰
    const sel = cssPath(el);
    if (sel) item.selector = sel;

    // contenteditableï¼ˆå¯Œæ–‡æœ¬ï¼‰
    if (el.getAttribute('contenteditable') === 'true') {
      item.contentEditable = true;
      item.text = (el.textContent || '');
      state[key] = item;
      return;
    }

    // checkbox / radio
    if (tag === 'input' && (type === 'checkbox' || type === 'radio')) {
      item.checked = !!el.checked;
      item.value = el.value;
    } else {
      item.value = el.value;
    }

    state[key] = item;
  });

  return state;
}


// 2) æ”¶é›†"è§„åˆ™ç”Ÿæˆçš„æ˜¾ç¤ºå†…å®¹"ï¼ˆåªæŠ“æœ‰ id çš„å±•ç¤ºèŠ‚ç‚¹ï¼Œé¿å…æŠŠæ•´ä¸ª DOM å­˜çˆ†ï¼‰
// è§„åˆ™ï¼šid å‘½ä¸­å¸¸è§åç¼€/å…³é”®è¯å°±ä¿å­˜ textContent
function __tpi_collectViewState() {
  const view = {};
  const nodes = document.querySelectorAll('[id]');
  nodes.forEach(el => {
    const id = el.id || '';
    const tag = el.tagName.toLowerCase();


    // æ’é™¤è¡¨å•æ§ä»¶ï¼ˆè¡¨å•ç”± formState è´Ÿè´£ï¼‰
    if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

    // âœ… å…³é”®ï¼šæ’é™¤â€œé‡Œç¨‹ç¢‘å¾½ç« â€ç›¸å…³ DOMï¼ˆå®ƒä»¬æ˜¯åŠ¨æ€ innerHTML æ¸²æŸ“ï¼‰
    // å¦åˆ™ viewState/restore ç”¨ textContent ä¼šæŠŠå¾½ç« åŒºåŸŸè¦†ç›–æˆçº¯æ–‡æœ¬
    if (id === 'badgesContainer' ||
        (el.classList && (el.classList.contains('badges-container') || el.classList.contains('badge-item'))) ||
        (typeof el.closest === 'function' && el.closest('#badgesContainer'))) {
      return;
    }


    const hit =
      /score|total|rating|level|badge|status|result|display|summary|label|title|remark|note/i.test(id) ||
      id.endsWith('-text') || id.endsWith('-value');


    if (!hit) return;


    const text = (el.textContent || '').trim();
    // é¿å…å­˜å¤§é‡ç©º/æ— æ„ä¹‰èŠ‚ç‚¹
    if (text.length === 0) return;
    // é¿å…å­˜è¿‡é•¿ï¼ˆæ¯”å¦‚æ•´æ®µæ¨¡æ¿å†…å®¹è¢«å¡è¿›æŸä¸ª divï¼‰
    if (text.length > 8000) return;


    view[`#${id}`] = { text };
  });


  return view;
}


// 3) æ¢å¤è¡¨å•æ§ä»¶
function __tpi_restoreFormState(formState) {
  if (!formState || typeof formState !== 'object') return;

  function getElByItem(key, item) {
    let el = null;

    // 1) id
    if (key.startsWith('#')) el = document.getElementById(key.slice(1));
    if (el) return el;

    // 2) selectorï¼ˆæœ€ç¨³ï¼‰
    if (item && item.selector) {
      try { el = document.querySelector(item.selector); } catch(e) {}
      if (el) return el;
    }

    // 3) data-tpi-keyï¼ˆkey æœ¬èº«æºå¸¦ selectorï¼‰
    if (key.startsWith('$')) {
      const sel = key.slice(1);
      try { el = document.querySelector(sel); } catch(e) {}
      if (el) return el;
    }

    return null;
  }

  Object.keys(formState).forEach(key => {
    const item = formState[key];
    if (!item) return;

    // âœ… ç”¨ä½ å·²ç»å†™å¥½çš„"ç¨³å®šä½"æŸ¥æ‰¾ï¼ˆselector / $selector / #idï¼‰
    const el = getElByItem(key, item);
    if (!el) return;

    const tag = (item.tag || el.tagName || '').toLowerCase();
    const type = (item.type || el.getAttribute('type') || '').toLowerCase();

    // contenteditableï¼ˆå¯Œæ–‡æœ¬ï¼‰
    if (item.contentEditable || el.getAttribute('contenteditable') === 'true') {
      if (typeof item.text === 'string') el.textContent = item.text;
      return;
    }

    if (tag === 'input' && (type === 'checkbox' || type === 'radio')) {
      // âœ… æ­£ç¡®ï¼šæŒ‰"å­˜æ¡£æ•°æ®"æ¢å¤
      el.checked = !!item.checked;
      // radio/checkbox å¯èƒ½è¿˜éœ€è¦ valueï¼ˆä¸å¼ºåˆ¶ï¼‰
      if (item.value !== undefined && item.value !== null) el.value = String(item.value);
    } else {
      el.value = (item.value !== undefined && item.value !== null) ? String(item.value) : '';
    }
  });
}


// 4) æ¢å¤å±•ç¤ºæ–‡æœ¬ï¼ˆå¯é€‰ï¼‰
function __tpi_restoreViewState(viewState) {
  if (!viewState || typeof viewState !== 'object') return;


  Object.keys(viewState).forEach(key => {
    const item = viewState[key];
    if (!item) return;


    let el = null;
    if (key.startsWith('#')) el = document.getElementById(key.slice(1));
    if (!el) return;


    // âœ… å…³é”®ï¼šæ’é™¤â€œé‡Œç¨‹ç¢‘å¾½ç« â€ç›¸å…³ DOMï¼ˆå®ƒä»¬æ˜¯åŠ¨æ€æ¸²æŸ“çš„ï¼‰
    // é¿å… restore æ—¶æŠŠå¾½ç« åŒºåŸŸè¦†ç›–æˆçº¯æ–‡æœ¬
    if (el.id === 'badgesContainer' ||
        (el.classList && (el.classList.contains('badges-container') || el.classList.contains('badge-item'))) ||
        (typeof el.closest === 'function' && el.closest('#badgesContainer'))) {
      return;
    }

    // åªæ¢å¤ textContentï¼ˆä¸å†™ innerHTMLï¼Œé¿å…ç ´åå¼¹çª—/æŠ˜å  DOMï¼‰
    if (typeof item.text === 'string') {
      el.textContent = item.text;
    }
  });
}


// 5) è§¦å‘é‡æ–°è®¡ç®—ï¼ˆä¿è¯è¯„åˆ†/è¯„çº§/å¾½ç« ç­‰è§„åˆ™é‡è·‘ï¼‰
// æ³¨æ„ï¼šä¸ä¼šå½±å“"æ¨¡å—æŠ˜å "å’Œ"å¼¹çª—å…³é—­"ï¼Œå®ƒä»¬æ˜¯ç‹¬ç«‹äº‹ä»¶ç³»ç»Ÿ
function __tpi_triggerRecalc() {
  // åªè§¦å‘è®¡ç®—,ä¸è§¦å‘æ‰€æœ‰è¾“å…¥æ¡†çš„äº‹ä»¶(é¿å…äº‘ç«¯åŒæ­¥æ—¶äº§ç”Ÿå¤§é‡é”™è¯¯)
  try {
    if (typeof window.TPI !== 'undefined' && typeof window.TPI.calculateTPI === 'function') {
      window.TPI.calculateTPI();
    }
  } catch (e) {
    console.warn('[__tpi_triggerRecalc] TPIè®¡ç®—å¤±è´¥:', e);
  }
}



/* =========================================================
   Patch: ä¿®å¤â€œç‚¹å‡»ä»Šå¤©åŠ è½½å¤±è´¥â€â€”â€”FutureRadar.reload ä¸å­˜åœ¨å¯¼è‡´æ¢å¤é“¾è·¯ä¸­æ–­
   è¯´æ˜ï¼šä¸åŒç‰ˆæœ¬ FutureRadar å¯èƒ½åªæš´éœ² init/render ç­‰å‡½æ•°ï¼Œå› æ­¤ç»Ÿä¸€èµ°å®‰å…¨åˆ·æ–°å…¥å£
========================================================= */
window.__tpi_safeReloadFutureRadar = function() {
  try {
    const FR = window.FutureRadar;
    if (!FR) return;
    if (typeof FR.reload === 'function') return FR.reload();
    if (typeof FR.refresh === 'function') return FR.refresh();
    if (typeof FR.render === 'function') return FR.render();
    if (typeof FR.init === 'function') return FR.init();
  } catch (e) {
    console.warn('[FutureRadar] safe reload failed:', e);
  }
};


window.collectDailyData = function() {
  const date = __tpi_getSelectedDate();


  // å…¼å®¹æ—§é€»è¾‘ï¼šä¿ç•™ä½ åŸå…ˆçš„ FIELDS è¾“å‡ºï¼ˆä¿è¯ä¸ç ´åæ—§æ¨¡å—ï¼‰
  const data = {
    "date-input": date,
    "github-username": "xiaoyi1986811",
    "github-repo": "tpi-system",
    "github-branch": "main"
  };


  // æ—§å­—æ®µç»§ç»­å¡«å……ï¼ˆä¸åˆ ï¼Œé¿å…ä½ è·¨æ—¥æœŸæ¨¡å—æˆ–å¯¼å‡ºä¾èµ–è¿™äº› keyï¼‰
  try {
    FIELDS.timeFields.forEach(key => { const el = document.getElementById(key); data[key] = el ? el.value : ""; });
    FIELDS.scoreFields.forEach(key => {
      const el = document.getElementById(key);
      const val = el ? String(el.value || '').trim() : "";
      if (val === "") data[key] = "";
      else { const num = parseFloat(val); data[key] = isNaN(num) ? val : num; }
    });
    FIELDS.booleanFields.forEach(key => { const el = document.getElementById(key); data[key] = el ? !!el.checked : false; });
    FIELDS.textFields.forEach(key => { const el = document.getElementById(key); data[key] = el ? el.value : ""; });
    FIELDS.selectFields.forEach(key => { const el = document.getElementById(key); data[key] = el ? el.value : ""; });
  } catch (e) {
    console.warn('[collectDailyData] legacy fields collect failed:', e);
  }


  // âœ… [è‰ç¨¿54 Patch] æ‰“åŒ…æœªæ¥äº‹ä»¶é›·è¾¾ï¼ˆå…¨å±€æ•°æ®ï¼Œä¸æŒ‰æ—¥åˆ†åº“ï¼‰
  try {
    const _radarRaw = localStorage.getItem('tpi_radar_events_v3');
    if (_radarRaw) data["futureRadarV3"] = JSON.parse(_radarRaw);
  } catch (_e) { console.warn('[collectDailyData] radar pack failed:', _e); }

  // âœ… [è‰ç¨¿75 Patch] æ‰“åŒ…æœªæ¥äº‹ä»¶é›·è¾¾è®¾ç½®ï¼ˆPushPlusé…ç½®ç­‰ï¼‰
  try {
    const _radarPushRaw = localStorage.getItem('tpi_radar_push_config');
    if (_radarPushRaw) data["futureRadarPushConfig"] = JSON.parse(_radarPushRaw);
  } catch (_e) { console.warn('[collectDailyData] radar push config pack failed:', _e); }

  // âœ… [è‰ç¨¿54 Patch] æ‰“åŒ…æ‚äº‹è®°å½•ï¼ˆæŒ‰å½“å‰é€‰å®šæ—¥æœŸï¼‰
  try {
    const _miscRaw = localStorage.getItem('tpi_misc_records_' + date);
    if (_miscRaw) data["miscRecordsV1"] = JSON.parse(_miscRaw);
  } catch (_e) { console.warn('[collectDailyData] misc pack failed:', _e); }

  // âœ… [è‰ç¨¿55 Patch-A] æ‰“åŒ…æ¨¡å¼é€‰æ‹©ï¼ˆdiv.selected ä¸æ˜¯è¡¨å•æ§ä»¶ï¼Œ_formState æ— æ³•æ•è·ï¼‰
  try {
    const _modeRaw = localStorage.getItem('selectedMode');
    if (_modeRaw) data["selectedMode"] = _modeRaw;
  } catch (_e) { console.warn('[collectDailyData] selectedMode pack failed:', _e); }

  // âœ… [è‰ç¨¿55 Patch-A] æ‰“åŒ…å‡æœŸå¤©æ•°é€‰æ‹©ï¼ˆradio æ—  idï¼ŒcssPath æ¢å¤ä¸å¯é ï¼‰
  try {
    const _vpRaw = localStorage.getItem('vacationPeriods');
    if (_vpRaw != null) data["vacationPeriods"] = Number(_vpRaw) || null;
  } catch (_e) { console.warn('[collectDailyData] vacationPeriods pack failed:', _e); }

  // âœ… [è‰ç¨¿55 Patch-A] æ‰“åŒ…ç­¾åˆ°ç´¯ç§¯æ•°æ®ï¼ˆå…¨å±€æ•°æ®ï¼Œç±»ä¼¼é›·è¾¾ï¼‰
  try {
    const _ciRaw = localStorage.getItem('tpi_checkin_data');
    if (_ciRaw) data["checkinData"] = JSON.parse(_ciRaw);
  } catch (_e) { console.warn('[collectDailyData] checkinData pack failed:', _e); }

  // æ–°å¢ï¼šå®Œæ•´è¡¨å• + è§„åˆ™ç”Ÿæˆè§†å›¾
  data["_formState"] = __tpi_collectFormState();
  // âœ… äºŒæ¬¡ä¿é™©ï¼šé˜²æ­¢å†å²ç¼“å­˜/é—æ¼å­—æ®µå¯¼è‡´ token è¢«å¸¦å…¥å¯¼å‡º/åŒæ­¥å†…å®¹
  try {
    if (data["_formState"] && typeof data["_formState"] === 'object') {
      delete data["_formState"]["#github-token"];
      delete data["_formState"]["#github_token"];
      Object.keys(data["_formState"]).forEach(k => {
        const it = data["_formState"][k];
        const sel = it && it.selector ? String(it.selector) : '';
        if (/github-token|github_token/i.test(k) || /github-token|github_token/i.test(sel) || /token|secret|password|pat/i.test(k)) {
          delete data["_formState"][k];
        }
      });
    }
  } catch (e) {}

  data["_viewState"] = __tpi_collectViewState();
  data["_deviceId"] = (typeof getOrCreateDeviceId === 'function') ? getOrCreateDeviceId() : (localStorage.getItem('tpi_device_id') || '');
  data["_lastModified"] = new Date().toISOString();


  return { [date]: data };
};

window.restoreUIFromData = function(data) {
  if (!data || typeof data !== 'object') {
    console.warn('restoreUIFromData: æ— æ•ˆæ•°æ®');
    return;
  }


  // å…ˆæ¢å¤æ—¥æœŸ
  let dateInput = document.getElementById('date-input');
  if (!dateInput) dateInput = document.querySelector('input[placeholder="ğŸ“… é€‰æ‹©æ—¥æœŸ"]');
  if (dateInput && data["date-input"]) dateInput.value = data["date-input"];


  // å…ˆæŒ‰æ—§æ–¹å¼æ¢å¤ï¼ˆä¿è¯å…¼å®¹æ—§æ¨¡å—ï¼‰
  try {
    FIELDS.timeFields.forEach(key => { const el = document.getElementById(key); if (el && data[key] !== undefined) el.value = data[key]; });
    FIELDS.scoreFields.forEach(key => { const el = document.getElementById(key); if (el && data[key] !== undefined) el.value = (data[key] === "" ? "" : String(data[key])); });
    FIELDS.booleanFields.forEach(key => { const el = document.getElementById(key); if (el && data[key] !== undefined) el.checked = !!data[key]; });
    FIELDS.textFields.forEach(key => { const el = document.getElementById(key); if (el && data[key] !== undefined) el.value = String(data[key] || ""); });
    FIELDS.selectFields.forEach(key => { const el = document.getElementById(key); if (el && data[key] !== undefined) el.value = data[key]; });
  } catch (e) {
    console.warn('[restoreUIFromData] legacy restore failed:', e);
  }


  // å†æ¢å¤å®Œæ•´æ§ä»¶çŠ¶æ€ï¼ˆè¦†ç›–/è¡¥é½æœªè¢« FIELDS åŒ…å«çš„å­—æ®µï¼‰
  __tpi_restoreFormState(data["_formState"]);


  // å¯é€‰æ¢å¤ï¼šè§„åˆ™ç”Ÿæˆæ˜¾ç¤ºæ–‡æœ¬ï¼ˆä¸ä¼šå†™ DOM ç»“æ„ï¼Œä¸ä¼šç ´åå¼¹çª—/æŠ˜å ï¼‰
  __tpi_restoreViewState(data["_viewState"]);


  // âœ… [è‰ç¨¿54 Patch] æ¢å¤æœªæ¥äº‹ä»¶é›·è¾¾ï¼ˆå†™å› localStorage + åˆ·æ–° UIï¼‰
  if (data["futureRadarV3"] && typeof data["futureRadarV3"] === 'object') {
    try {
      localStorage.setItem('tpi_radar_events_v3', JSON.stringify(data["futureRadarV3"]));
      if (window.FutureRadar && typeof window.FutureRadar.reload === 'function') {
        window.__tpi_safeReloadFutureRadar();
      }
    } catch (_e) { console.warn('[restoreUIFromData] radar restore failed:', _e); }
  }

  // âœ… [è‰ç¨¿75 Patch] æ¢å¤æœªæ¥äº‹ä»¶é›·è¾¾è®¾ç½®ï¼ˆPushPlusé…ç½®ç­‰ï¼‰
  if (data["futureRadarPushConfig"] && typeof data["futureRadarPushConfig"] === 'object') {
    try {
      localStorage.setItem('tpi_radar_push_config', JSON.stringify(data["futureRadarPushConfig"]));
      if (window.FutureRadar) {
        window.FutureRadar.pushConfig = data["futureRadarPushConfig"];
      }
    } catch (_e) { console.warn('[restoreUIFromData] radar push config restore failed:', _e); }
  }

  // âœ… [è‰ç¨¿54 Patch] æ¢å¤æ‚äº‹è®°å½•ï¼ˆå†™å›å¯¹åº”æ—¥æœŸçš„ localStorage + åˆ·æ–° UIï¼‰
  if (data["miscRecordsV1"]) {
    try {
      const _restoreMiscDate = data["date-input"] || (typeof __tpi_getSelectedDate === 'function' ? __tpi_getSelectedDate() : '');
      if (_restoreMiscDate) {
        localStorage.setItem('tpi_misc_records_' + _restoreMiscDate, JSON.stringify(data["miscRecordsV1"]));
        const _hiddenMisc = document.getElementById('misc-records-json');
        if (_hiddenMisc) _hiddenMisc.value = JSON.stringify(data["miscRecordsV1"]);
      }
      if (window.MiscLog && typeof window.MiscLog.render === 'function') {
        window.MiscLog.render();
      }
    } catch (_e) { console.warn('[restoreUIFromData] misc restore failed:', _e); }
  }

  // âœ… [è‰ç¨¿55 Patch-B] æ¢å¤æ¨¡å¼é€‰æ‹©ï¼ˆè°ƒ TPI.selectMode åŒæ—¶ä¿®å¤ UI + state + localStorageï¼‰
  if (data["selectedMode"] && typeof data["selectedMode"] === 'string') {
    try {
      if (window.TPI && typeof window.TPI.selectMode === 'function') {
        window.TPI.selectMode(data["selectedMode"]);
      }
    } catch (_e) { console.warn('[restoreUIFromData] selectedMode restore failed:', _e); }
  }

  // âœ… [è‰ç¨¿55 Patch-B] æ¢å¤å‡æœŸå¤©æ•°ï¼ˆclick å¯¹åº” radio + è°ƒ updateVacationTargetï¼‰
  if (data["vacationPeriods"] != null && !isNaN(Number(data["vacationPeriods"]))) {
    try {
      const _vpNum = Number(data["vacationPeriods"]);
      localStorage.setItem('vacationPeriods', String(_vpNum));
      // click å¯¹åº”çš„ radio ä½¿å…¶è§†è§‰é€‰ä¸­
      const _vpRadio = document.querySelector(`input[name="vacation-periods"][value="${_vpNum}"]`);
      if (_vpRadio) { _vpRadio.checked = true; }
      // è°ƒä¸šåŠ¡å‡½æ•°æ›´æ–°ç›®æ ‡
      if (window.TPI && typeof window.TPI.updateVacationTarget === 'function') {
        window.TPI.updateVacationTarget(_vpNum);
      }
    } catch (_e) { console.warn('[restoreUIFromData] vacationPeriods restore failed:', _e); }
  }

  // âœ… [è‰ç¨¿55 Patch-B] æ¢å¤ç­¾åˆ°ç´¯ç§¯æ•°æ®ï¼ˆåˆå¹¶ç­–ç•¥ï¼šdates å–å¹¶é›†ï¼Œstreak é‡æ–°è®¡ç®—ï¼‰
  if (data["checkinData"] && typeof data["checkinData"] === 'object') {
    try {
      // è¯»æœ¬åœ°ç°æœ‰ç­¾åˆ°æ•°æ®
      let _localCI = { dates: [], currentStreak: 0, maxStreak: 0 };
      try {
        const _localRaw = localStorage.getItem('tpi_checkin_data');
        if (_localRaw) _localCI = JSON.parse(_localRaw);
      } catch (_e2) {}
      // dates å–å¹¶é›†ï¼ˆå»é‡ + æ’åºï¼‰
      const _localDates = new Set(_localCI.dates || []);
      (data["checkinData"].dates || []).forEach(d => _localDates.add(d));
      const _mergedDates = Array.from(_localDates).sort();
      // maxStreak å–ä¸¤ç«¯è¾ƒå¤§å€¼ï¼ˆstreak ä¼šåœ¨ updateCheckInStatus é‡Œé‡æ–°ç®—ï¼‰
      const _mergedMax = Math.max(_localCI.maxStreak || 0, data["checkinData"].maxStreak || 0);
      const _mergedCI = { dates: _mergedDates, currentStreak: 0, maxStreak: _mergedMax };
      localStorage.setItem('tpi_checkin_data', JSON.stringify(_mergedCI));
      // åˆ·æ–°ç­¾åˆ° UIï¼ˆå¦‚æœå‡½æ•°å·²æš´éœ²ï¼‰
      if (typeof window.__tpi_refreshCheckin === 'function') {
        window.__tpi_refreshCheckin();
      }
    } catch (_e) { console.warn('[restoreUIFromData] checkinData restore failed:', _e); }
  }

  // æœ€åï¼šè§¦å‘é‡æ–°è®¡ç®—ï¼Œä¿è¯åˆ†æ•°/è¯„çº§/å¾½ç« çŠ¶æ€ç«‹åˆ»æ­£ç¡®
  __tpi_triggerRecalc();


  console.log('âœ… UI å·²ä»æ•°æ®æ¢å¤(v8å®Œæ•´å¿«ç…§):', data);
};

console.log('âœ… ç‹¬è£è¡¥ä¸ v5 å·²åœ¨ <head> å¼ºåˆ¶åŠ è½½ (collectDailyData & restoreUIFromData)');

// âœ… ç»Ÿä¸€è¯»å–æŸæ—¥æ•°æ®ï¼šä¼˜å…ˆæœ¬åœ°æ—¥ç¼“å­˜ï¼Œå…¶æ¬¡åˆå¹¶åº“ç¼“å­˜
window.getTpiDayData = function(dateStr) {
  if (!dateStr) return null;
  try {
    const local = localStorage.getItem(`tpi_data_${dateStr}`);
    if (local) return JSON.parse(local);
  } catch(e) {}

  if (window.__TPI_MERGED_DB__ && window.__TPI_MERGED_DB__[dateStr]) return window.__TPI_MERGED_DB__[dateStr];

  try {
    const merged = localStorage.getItem('tpi_db_merged_cache');
    if (merged) {
      const db = JSON.parse(merged);
      return db[dateStr] || null;
    }
  } catch(e) {}

  return null;
};

</script>
<script>
/* =========================================================
   ç‹¬è£è¡¥ä¸ v6 Â· GitHub åŒæ­¥åŠŸèƒ½
   æ”¾ç½®ä½ç½®ï¼š<head> å†…
   ç›®çš„ï¼šç¡®ä¿GitHubåŒæ­¥å‡½æ•°å¯å…¨å±€è®¿é—®
========================================================= */

// GitHub æ•°æ®åŒæ­¥å‡½æ•°

/* =========================
   v7 å‡çº§ï¼šè®¾å¤‡åˆ†åº“ + äº‘ç«¯åˆå¹¶è§†å›¾ï¼ˆæ¶ˆç­ 409 æ¶æ„ç‰ˆï¼‰
   çº¦å®šï¼š
   - æ¯å°è®¾å¤‡å†™ï¼štpi_devices/<deviceId>.json
   - åˆå¹¶è§†å›¾ï¼šè¯»å– tpi_devices/ ä¸‹æ‰€æœ‰ jsonï¼ŒæŒ‰æ—¥æœŸåˆå¹¶
========================= */

const TPI_DEVICE_KEY = 'tpi_device_id';
const TPI_DEVICE_DIR = 'tpi_devices'; // ä»“åº“ç›®å½•åï¼šä¼šè‡ªåŠ¨å‡ºç°åœ¨ repo æ ¹ç›®å½•ä¸‹

function getOrCreateDeviceId() {
    let id = localStorage.getItem(TPI_DEVICE_KEY);
    if (id) return id;

    // ç”Ÿæˆç¨³å®š deviceIdï¼šå°½é‡çŸ­ä½†è¶³å¤Ÿå”¯ä¸€
    const rand = (typeof crypto !== 'undefined' && crypto.getRandomValues)
        ? Array.from(crypto.getRandomValues(new Uint8Array(8))).map(b => b.toString(16).padStart(2,'0')).join('')
        : Math.random().toString(16).slice(2) + Date.now().toString(16);

    id = 'dev_' + rand.slice(0, 16);
    localStorage.setItem(TPI_DEVICE_KEY, id);
    return id;
}

function pickNewerRecord(a, b) {
    // ç¼ºçœå¤„ç†
    if (!a) return b;
    if (!b) return a;

    const ta = a && a._lastModified ? Date.parse(a._lastModified) : 0;
    const tb = b && b._lastModified ? Date.parse(b._lastModified) : 0;

    // âœ… æ—¶é—´æˆ³æ›´æ™šè€…èƒœ
    if (tb > ta) return b;
    if (ta > tb) return a;

    // âœ… åŒä¸€æ¯«ç§’/æ— æ—¶é—´æˆ³å…œåº•ï¼šç”¨ deviceId åšç¨³å®šè£å†³ï¼ˆé¿å…éšæœºæŠ–åŠ¨ï¼‰
    const da = a && a._deviceId ? String(a._deviceId) : '';
    const db = b && b._deviceId ? String(b._deviceId) : '';
    if (db > da) return b;
    if (da > db) return a;

    // æœ€åå…œåº•ï¼šåè€…èƒœï¼ˆä¿æŒå¯é¢„æµ‹ï¼‰
    return b;
}

// âœ… Base64(UTF-8) -> stringï¼šè§£å†³ä¸­æ–‡ä¹±ç  & é¿å… atob é€ æˆçš„ä¹±ç 
function base64Decode(b64) {
  if (!b64) return '';
  try {
    // GitHub çš„ content å¯èƒ½åŒ…å«æ¢è¡Œ
    b64 = String(b64).replace(/\n/g, '');
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    return new TextDecoder('utf-8').decode(bytes);
  } catch (e) {
    // å…œåº•ï¼šè‡³å°‘åˆ«è®©åŒæ­¥é“¾è·¯å´©æ‰
    try { return atob(String(b64).replace(/\n/g, '')); } catch (_) { return ''; }
  }
}

async function ghGetJsonFile({token, username, repo, branch, path}) {
    const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}?ref=${branch}`;
    const resp = await fetch(url, { headers: { 'Authorization': `token ${token}` } });

    if (resp.status === 404) return { exists: false, sha: null, json: null };
    if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);

    const info = await resp.json();
    const content = base64Decode(info.content || '');
    const json = content ? JSON.parse(content) : {};
    return { exists: true, sha: info.sha || null, json };
}

async function ghPutJsonFile({token, username, repo, branch, path, sha, json, message}) {
    const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
    const contentStr = JSON.stringify(json, null, 2);
    const contentBase64 = btoa(unescape(encodeURIComponent(contentStr)));

    const payload = { message, content: contentBase64, branch };
    if (sha) payload.sha = sha;

    const resp = await fetch(url, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    });

    if (!resp.ok) {
        const errText = await resp.text();
        const err = new Error(`HTTP ${resp.status}: ${errText}`);
        err.status = resp.status;
        throw err;
    }
    return true;
}

async function ghListDir({token, username, repo, branch, dir}) {
    const url = `https://api.github.com/repos/${username}/${repo}/contents/${dir}?ref=${branch}`;
    const resp = await fetch(url, { headers: { 'Authorization': `token ${token}` } });

    if (resp.status === 404) return { exists: false, items: [] };
    if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);

    const items = await resp.json();
    return { exists: true, items: Array.isArray(items) ? items : [] };
}

async function loadMergedDbFromDevices({token, username, repo, branch}) {
    // è¯»ç›®å½•
    const { exists, items } = await ghListDir({token, username, repo, branch, dir: TPI_DEVICE_DIR});
    if (!exists) return { merged: {}, deviceFiles: [] };

    const files = items.filter(it => it && it.type === 'file' && typeof it.name === 'string' && it.name.endsWith('.json'));
    const merged = {};

    // é€ä¸ªè¯»æ–‡ä»¶å¹¶åˆå¹¶
    for (const f of files) {
        try {
            const { json } = await ghGetJsonFile({token, username, repo, branch, path: `${TPI_DEVICE_DIR}/${f.name}`});
            if (!json || typeof json !== 'object') continue;

            for (const dateKey of Object.keys(json)) {
                const incoming = json[dateKey];
                if (!merged[dateKey]) merged[dateKey] = incoming;
                else merged[dateKey] = pickNewerRecord(merged[dateKey], incoming);
            }
        } catch (e) {
            console.warn('[MERGE] skip file:', f.name, e);
        }
    }

    return { merged, deviceFiles: files.map(f => f.name) };
}

window.syncToGitHub = async function() {
    // ===== åŒæ­¥é”ï¼šé˜²æ­¢åŒä¸€è®¾å¤‡å¤šæ¬¡å¹¶å‘å†™ï¼ˆé¿å…åŒè®¾å¤‡ 409ï¼‰=====
    if (window.__TPI_DEVICE_SYNC_LOCK__) {
        console.warn('[SYNC] blocked: already running');
        return;
    }
    window.__TPI_DEVICE_SYNC_LOCK__ = true;

    try {
        // 0) ä¸Šä¼ å‰ç»Ÿä¸€åˆ·æ–°ï¼šç¡®ä¿å¼¹çª—/æ‚äº‹è®°å½•/è§„åˆ™æ´¾ç”Ÿç»“æœéƒ½è¢«æ‰“åŒ…ï¼ˆä¸æ”¹DOMç»“æ„ï¼Œä¿æŠ¤æŠ˜å ä¸æŒ‰é’®ï¼‰
        try {
            if (window.MiscLog && typeof window.MiscLog.render === 'function') {
                window.MiscLog.render();
            }
        } catch (e) { console.warn('[SYNC] MiscLog render failed:', e); }

        // 1) æ”¶é›†å½“æ—¥æ•°æ®
        // âœ… å¼ºåŒ–ï¼šæ‰‹åŠ¨åŒæ­¥ä¹Ÿå…ˆè·‘å®Œè§„åˆ™ï¼Œä¿è¯ä¸Šä¼ ä¸€è‡´
        if (typeof __tpi_triggerRecalc === 'function') {
            try { __tpi_triggerRecalc(); } catch(e) { console.warn('[SYNC] recalc failed:', e); }
        }

        const dailyDataObj = window.collectDailyData();
        if (!dailyDataObj || Object.keys(dailyDataObj).length === 0) {
            alert('âš ï¸ æœªæ£€æµ‹åˆ°æœ‰æ•ˆæ•°æ®ï¼Œæ— æ³•åŒæ­¥');
            console.warn('collectDailyData è¿”å›ç©ºæ•°æ®:', dailyDataObj);
            return;
        }

        const selectedDate = (typeof __tpi_getSelectedDate === 'function') ? __tpi_getSelectedDate() : (new Date().toISOString().split('T')[0]);
        const dateKeys = Object.keys(dailyDataObj);
        const actualData = dailyDataObj[dateKeys[0]];
        // âœ… å…³é”®ï¼šäº‘ç«¯é”®å¿…é¡»è·Ÿ UI é€‰ä¸­æ—¥æœŸä¸€è‡´ï¼ˆé¿å…â€œæ‰¾ä¸åˆ° 2/1 æ•°æ®â€ï¼‰
        actualData["date-input"] = selectedDate;

        // 2) GitHub é…ç½®
        const token = localStorage.getItem('github_token');
        const username = localStorage.getItem('github_username');
        const repo = localStorage.getItem('github_repo');
        const branch = localStorage.getItem('github_branch') || 'main';

        if (!token || !username || !repo) {
            alert('âŒ è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® GitHub Tokenã€ç”¨æˆ·åå’Œä»“åº“å');
            return;
        }

        // 3) è®¾å¤‡åˆ†åº“è·¯å¾„
        const deviceId = getOrCreateDeviceId();
        const devicePath = `${TPI_DEVICE_DIR}/${deviceId}.json`;
        const cacheKey = `tpi_db_device_${deviceId}`;

        // 4) æ‹‰è¿œç«¯æœ¬è®¾å¤‡åº“ï¼ˆä¸å­˜åœ¨å°±æ–°å»ºï¼‰
        let remote = await ghGetJsonFile({token, username, repo, branch, path: devicePath});
        let deviceDb = (remote.json && typeof remote.json === 'object') ? remote.json : {};

        // âœ… å¼ºåŒ–ï¼šä¸Šä¼ å‰æœ€åä¸€åˆ»å¼ºåˆ¶å†æŠ“ä¸€æ¬¡"è§„åˆ™ç”Ÿæˆå±•ç¤º"è§†å›¾
        // ä»…å†™ textContentï¼Œä¸åŠ¨ DOM ç»“æ„ï¼Œä¸ä¼šå½±å“æŠ˜å /å¼¹çª—/å®æ—¶ç®—åˆ†
        try {
            if (actualData && typeof __tpi_collectViewState === 'function') {
                actualData["_viewState"] = __tpi_collectViewState();
            }
            // åŒæ—¶åˆ·æ–°æœ€åä¿®æ”¹æ—¶é—´ï¼Œç¡®ä¿å¤šç»ˆç«¯åˆå¹¶ç­–ç•¥ç¨³å®š
            if (actualData) actualData["_lastModified"] = new Date().toISOString();
        } catch (e) {
            console.warn('[SYNC] refresh _viewState/_lastModified failed:', e);
        }

        // âœ… [è‰ç¨¿54 Patch] ä¸Šä¼ å‰æœ€åä¸€åˆ»åˆ·æ–°é›·è¾¾ + æ‚äº‹ï¼ˆç¡®ä¿å¼¹çª—é‡Œåˆšä¿å­˜çš„æ•°æ®ä¹Ÿè¢«å¸¦ä¸Šï¼‰
        try {
            const _syncRadarRaw = localStorage.getItem('tpi_radar_events_v3');
            if (_syncRadarRaw) actualData["futureRadarV3"] = JSON.parse(_syncRadarRaw);
        } catch (_e) { console.warn('[SYNC] radar refresh failed:', _e); }
        // âœ… [è‰ç¨¿78 ä¿®å¤] ä¸Šä¼ å‰åˆ·æ–°PushPlusé…ç½®ï¼ˆç¡®ä¿è®¾ç½®é¡µä¿å­˜çš„é…ç½®ä¹Ÿè¢«å¸¦ä¸Šï¼‰
        try {
            const _syncRadarPushRaw = localStorage.getItem('tpi_radar_push_config');
            if (_syncRadarPushRaw) actualData["futureRadarPushConfig"] = JSON.parse(_syncRadarPushRaw);
        } catch (_e) { console.warn('[SYNC] radar push config refresh failed:', _e); }
        try {
            const _syncMiscRaw = localStorage.getItem('tpi_misc_records_' + selectedDate);
            if (_syncMiscRaw) actualData["miscRecordsV1"] = JSON.parse(_syncMiscRaw);
        } catch (_e) { console.warn('[SYNC] misc refresh failed:', _e); }

        // âœ… [è‰ç¨¿55 Patch-C] ä¸Šä¼ å‰åˆ·æ–°æ¨¡å¼/å‡æœŸ/ç­¾åˆ°ï¼ˆç¡®ä¿æœ€æ–°å€¼è¢«å¸¦ä¸Šï¼‰
        try {
            const _syncMode = localStorage.getItem('selectedMode');
            if (_syncMode) actualData["selectedMode"] = _syncMode;
        } catch (_e) { console.warn('[SYNC] selectedMode refresh failed:', _e); }
        try {
            const _syncVP = localStorage.getItem('vacationPeriods');
            if (_syncVP != null) actualData["vacationPeriods"] = Number(_syncVP) || null;
        } catch (_e) { console.warn('[SYNC] vacationPeriods refresh failed:', _e); }
        try {
            const _syncCI = localStorage.getItem('tpi_checkin_data');
            if (_syncCI) actualData["checkinData"] = JSON.parse(_syncCI);
        } catch (_e) { console.warn('[SYNC] checkinData refresh failed:', _e); }

        deviceDb[selectedDate] = actualData;

        // 5) ä¸Šä¼ ï¼ˆå¸¦ sha è‡ªåŠ¨é‡è¯•ï¼šå½»åº•è§£å†³ 409 sha ä¸åŒ¹é…ï¼‰
        const msgBase = `Update TPI (${deviceId}) for ${selectedDate} via web`;

        for (let attempt = 1; attempt <= 3; attempt++) {
            // æ¯æ¬¡å°è¯•éƒ½æ‹‰ä¸€æ¬¡æœ€æ–° shaï¼ˆé¿å…å¤šç«¯/å¤šæ ‡ç­¾é¡µ/è‡ªåŠ¨åŒæ­¥å¯¼è‡´ sha è¿‡æœŸï¼‰
            remote = await ghGetJsonFile({token, username, repo, branch, path: devicePath});
            deviceDb = (remote.json && typeof remote.json === 'object') ? remote.json : {};
            deviceDb[selectedDate] = actualData;

            try {
                await ghPutJsonFile({
                    token, username, repo, branch,
                    path: devicePath,
                    sha: remote.sha,
                    json: deviceDb,
                    message: (attempt === 1) ? msgBase : (msgBase + ` (retry ${attempt} after 409)`)
                });

                localStorage.setItem(cacheKey, JSON.stringify(deviceDb));
                localStorage.setItem(`tpi_data_${selectedDate}`, JSON.stringify(actualData));

                alert(`âœ… å·²åŒæ­¥åˆ°è®¾å¤‡åº“ï¼š${deviceId}`);
                console.log('â˜ï¸ ä¸Šä¼ æˆåŠŸ(è®¾å¤‡åˆ†åº“):', { deviceId, date: selectedDate, path: devicePath, attempt });
                return;
            } catch (e) {
                if (e && e.status === 409 && attempt < 3) {
                    console.warn(`[SYNC] 409 conflict on device file (attempt ${attempt}), refetch sha and retryâ€¦`);
                    continue;
                }
                throw e;
            }
        }
    } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥(è®¾å¤‡åˆ†åº“):', error);
        alert('âŒ åŒæ­¥å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°'));
    } finally {
        window.__TPI_DEVICE_SYNC_LOCK__ = false;
    }
};



/* =========================================================
   ç‹¬è£è¡¥ä¸ Â· äº‘ç«¯æ•°æ®ç»Ÿè®¡ getTpiDataStats
   ç›®çš„ï¼š
   - downloadFromGitHub ä¸‹è½½åç»™å‡ºâ€œäº‘ç«¯æ•°æ®æ¦‚å†µ/æ–­æ¡£æç¤ºâ€
   - é¿å…å› å‡½æ•°ç¼ºå¤±å¯¼è‡´â€œä»äº‘ç«¯ä¸‹è½½å†å²â€ç›´æ¥å¤±è´¥
========================================================= */
window.getTpiDataStats = function(mergedDb){
  try{
    const db = (mergedDb && typeof mergedDb === 'object') ? mergedDb : {};
    const dates = Object.keys(db).filter(d => /^\d{4}-\d{2}-\d{2}$/.test(d)).sort();
    const totalDays = dates.length;
    if (totalDays === 0){
      return { totalDays: 0, dateRange: null, missingDays: [] };
    }
    const start = dates[0];
    const end = dates[dates.length - 1];

    // æ–­æ¡£æ£€æµ‹ï¼šä» start åˆ° end é€æ—¥é€’å¢ï¼Œæ‰¾ç¼ºå¤±
    const missingDays = [];
    const startDate = new Date(start + 'T00:00:00');
    const endDate = new Date(end + 'T00:00:00');
    const oneDay = 24*60*60*1000;

    for (let t = startDate.getTime(); t <= endDate.getTime(); t += oneDay){
      const d = new Date(t);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const key = `${yyyy}-${mm}-${dd}`;
      if (!db[key]) missingDays.push(key);
    }

    return { totalDays, dateRange: { start, end }, missingDays };
  } catch(e){
    console.warn('[getTpiDataStats] failed:', e);
    return { totalDays: 0, dateRange: null, missingDays: [] };
  }
};

window.downloadFromGitHub = async function() {
    console.log('å¼€å§‹ä»GitHubä¸‹è½½æ•°æ®(åˆå¹¶è§†å›¾)...');
    
    // æ˜¾ç¤ºåŠ è½½é®ç½©
    const loadingOverlay = document.getElementById('loading-overlay'); 
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        const loadingText = document.querySelector('.loading-text');
        if (loadingText) loadingText.textContent = 'ç¬¬22ç‰ˆï¼šä¸‹è½½ä¸­...';
    }

    const token = localStorage.getItem('github_token');
    const username = localStorage.getItem('github_username');
    const repo = localStorage.getItem('github_repo');
    const branch = localStorage.getItem('github_branch') || 'main';

    if (!token || !username || !repo) {
        alert('âŒ è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® GitHub Tokenã€ç”¨æˆ·åå’Œä»“åº“å');
        // éšè—åŠ è½½é®ç½©
        if (loadingOverlay) loadingOverlay.style.display = 'none';
        return;
    }

    try {
        // 1) è·å–å½“å‰é€‰ä¸­çš„æ—¥æœŸ
        let dateInput = document.getElementById('date-input');
        if (!dateInput) dateInput = document.querySelector('input[placeholder="ğŸ“… é€‰æ‹©æ—¥æœŸ"]');
        if (!dateInput) {
            console.error('æœªæ‰¾åˆ°æ—¥æœŸè¾“å…¥æ¡†');
            // éšè—åŠ è½½é®ç½©
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            return;
        }

        let selectedDate = dateInput.value;
        if (!selectedDate) {
            alert('âŒ ä½ è¿˜æ²¡é€‰æ‹©æ—¥æœŸ');
            // éšè—åŠ è½½é®ç½©
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            return;
        }

        // 2) ä¼˜å…ˆï¼šè®¾å¤‡åˆ†åº“åˆå¹¶
        let mergedDb = {};
        let deviceFiles = [];
        let sources = {};
        let allSources = {};
        const mergedResult = await loadMergedDbFromDevices({token, username, repo, branch});
        mergedDb = mergedResult.merged;
        deviceFiles = mergedResult.deviceFiles;
        sources = mergedResult.sources;
        allSources = mergedResult.allSources;

        // 3) å¦‚æœè®¾å¤‡ç›®å½•ä¸å­˜åœ¨ï¼ˆå°šæœªå‡çº§äº§ç”Ÿä»»ä½•åˆ†åº“æ–‡ä»¶ï¼‰ï¼Œfallback æ—§åº“ tpi_db.json
        if (!deviceFiles || deviceFiles.length === 0) {
            console.warn('[MERGE] no device files found, fallback to legacy tpi_db.json');
            const legacy = await ghGetJsonFile({token, username, repo, branch, path: 'tpi_db.json'});
            mergedDb = (legacy.json && typeof legacy.json === 'object') ? legacy.json : {};
        }

        console.log('[MERGE] device files:', deviceFiles);
        console.log('[MERGE] sources:', sources);
        console.log('[MERGE] allSources:', allSources);

        // âœ… å…¨å±€ç¼“å­˜åˆå¹¶åº“ï¼šä¾›è·¨æ—¥æœŸæ¯”è¾ƒ/å¾½ç« åˆ¤å®šç­‰æ¨¡å—è¯»å–
        window.__TPI_MERGED_DB__ = mergedDb;
        window.__TPI_SOURCES_MAP__ = sources;
        window.__TPI_ALL_SOURCES_MAP__ = allSources;
        try { localStorage.setItem('tpi_db_merged_cache', JSON.stringify(mergedDb)); } catch(e) {}
        try { localStorage.setItem('tpi_db_all_sources_cache', JSON.stringify(allSources)); } catch(e) {}
        
        // è·å–æ•°æ®ç»Ÿè®¡ä¿¡æ¯ç”¨äºæ¦‚å†µæç¤º
        const dataStats = (typeof window.getTpiDataStats === 'function') ? window.getTpiDataStats(mergedDb) : { totalDays: Object.keys(mergedDb||{}).length, dateRange: null, missingDays: [] };
        
        // äº‘ç«¯æ•°æ®æ¦‚å†µæç¤º
        if (dataStats.totalDays > 0) {
            const recentDate = dataStats.dateRange ? dataStats.dateRange.end : 'æœªçŸ¥';
            alert('äº‘ç«¯å…±'+dataStats.totalDays+'å¤©æ•°æ®ï¼Œæœ€è¿‘æ—¥æœŸæ˜¯'+recentDate);
            
            // æ£€æµ‹æ–­æ¡£å¹¶æç¤ºç¼ºå¤±å¤©æ•°ï¼ˆä¸åˆ·å±ï¼‰
            if (dataStats.missingDays && dataStats.missingDays.length > 0) {
                console.log(`å‘ç° ${dataStats.missingDays.length} å¤©æ•°æ®ç¼ºå¤±:`, dataStats.missingDays);
                
                // åªåœ¨ç¼ºå¤±è¾ƒå¤šå¤©æ•°æ—¶æç¤ºï¼Œé¿å…é¢‘ç¹æ‰“æ‰°
                if (dataStats.missingDays.length >= 3) {
                    setTimeout(() => {
                        alert('å‘ç°'+dataStats.missingDays.length+'å¤©æ•°æ®ç¼ºå¤±');
                    }, 1000);
                }
            }
        }

        // 4) æ£€æŸ¥å½“å‰é€‰ä¸­æ—¥æœŸæ˜¯å¦æœ‰æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™è‡ªåŠ¨å®šä½åˆ°æœ€è¿‘çš„æœ‰æ•°æ®æ—¥æœŸ
        let dayData = mergedDb[selectedDate];
        let actualDate = selectedDate;
        
        if (!dayData) {
            // æŒ‰æ—¥æœŸå€’åºæŸ¥æ‰¾æœ€è¿‘çš„æœ‰æ•°æ®çš„æ—¥æœŸ
            const availableDates = Object.keys(mergedDb).sort().reverse();
            const closestDate = availableDates.find(date => date <= selectedDate);
            
            if (closestDate) {
                dayData = mergedDb[closestDate];
                actualDate = closestDate;
                
                // è‡ªåŠ¨æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨
                dateInput.value = closestDate;
                
                alert('âš ï¸ '+selectedDate+'åœ¨äº‘ç«¯æ— æ•°æ®ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°æœ€è¿‘æœ‰æ•°æ®æ—¥æœŸï¼š'+closestDate);
            }
        }
        
        if (!dayData) {
            alert('âŒ äº‘ç«¯åˆå¹¶è§†å›¾æœªæ‰¾åˆ° '+selectedDate+' æˆ–ç›¸è¿‘æ—¥æœŸçš„æ•°æ®');
            console.warn('äº‘ç«¯åˆå¹¶è§†å›¾æœªæ‰¾åˆ°è¯¥æ—¥:', selectedDate, Object.keys(mergedDb || {}).slice(0, 10));
            // éšè—åŠ è½½é®ç½©
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            return;
        }

        // 5) æ¢å¤ UI
        if (typeof window.restoreUIFromData === 'function') {
            window.restoreUIFromData(dayData);
            localStorage.setItem(`tpi_data_${actualDate}`, JSON.stringify(dayData));
            alert('âœ… å·²ä»äº‘ç«¯åˆå¹¶è§†å›¾åŠ è½½ '+actualDate+' çš„æ•°æ®ï¼');
            console.log('âœ… å·²ä»äº‘ç«¯åˆå¹¶è§†å›¾åŠ è½½:', { selectedDate: actualDate, repo, branch });
        } else {
            console.error('restoreUIFromData å‡½æ•°æœªå®šä¹‰');
        }
    } catch (error) {
        console.error('ä¸‹è½½æ•°æ®æ—¶å‡ºé”™(åˆå¹¶è§†å›¾):', error);
        alert('âŒ ä¸‹è½½æ•°æ®å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
    } finally {
        // éšè—åŠ è½½é®ç½©
        if (loadingOverlay) loadingOverlay.style.display = 'none';
    }
};

// ä¿å­˜ GitHub é…ç½®åˆ°æœ¬åœ°å­˜å‚¨
window.saveGitHubConfig = function() {
    const token = document.getElementById('github-token').value.trim();
    const username = document.getElementById('github-username').value.trim();
    const repo = document.getElementById('github-repo').value.trim();
    const branch = document.getElementById('github-branch').value.trim() || 'main';

    if (!token || !username || !repo) {
        alert('âŒ è¯·å¡«å†™å®Œæ•´çš„ GitHub é…ç½®ä¿¡æ¯');
        return;
    }

    localStorage.setItem('github_token', token);
    localStorage.setItem('github_username', username);
    localStorage.setItem('github_repo', repo);
    localStorage.setItem('github_branch', branch);

    alert('âœ… GitHub é…ç½®å·²ä¿å­˜ï¼');
    console.log('ğŸ’¾ GitHub é…ç½®å·²ä¿å­˜:', { username, repo, branch });
};

// æµ‹è¯• GitHub è¿æ¥
window.testGitHubConnection = async function() {
    const token = localStorage.getItem('github_token');
    const username = localStorage.getItem('github_username');
    const repo = localStorage.getItem('github_repo');
    const branch = localStorage.getItem('github_branch') || 'main';

    if (!token || !username || !repo) {
        alert('âŒ è¯·å…ˆä¿å­˜ GitHub é…ç½®');
        return;
    }

    try {
        const url = `https://api.github.com/repos/${username}/${repo}/contents/tpi_db.json?ref=${branch}`;
        const resp = await fetch(url, {
            headers: { 'Authorization': `token ${token}` }
        });

        if (resp.ok) {
            alert('âœ… è¿æ¥æˆåŠŸï¼å¯è¯»å†™ tpi_db.json');
            console.log('ğŸ§ª GitHub è¿æ¥æµ‹è¯•é€šè¿‡');
        } else if (resp.status === 404) {
            alert('âš ï¸ ä»“åº“/åˆ†æ”¯å­˜åœ¨ï¼Œä½† tpi_db.json å°šæœªåˆ›å»ºï¼ˆé¦–æ¬¡ä½¿ç”¨æ­£å¸¸ï¼‰');
            console.log('ğŸ§ª ä»“åº“å¯è®¿é—®ï¼Œæ–‡ä»¶ä¸å­˜åœ¨ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰');
        } else if (resp.status === 401) {
            alert('âŒ Token æ— æ•ˆæˆ–æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥ Token æ˜¯å¦åŒ…å« repo æƒé™');
            console.error('GitHub è¿”å› 401: Token æ— æ•ˆ');
        } else {
            throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
        }
    } catch (error) {
        console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
        alert('âŒ è¿æ¥å¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯'));
    }
};

// ä¸ºloadFromGitHubåˆ›å»ºåˆ«å
window.loadFromGitHub = window.downloadFromGitHub;

console.log('âœ… GitHubåŒæ­¥å‡½æ•°å·²å…¨å±€æš´éœ² (å«é…ç½®ä¿å­˜å’Œè¿æ¥æµ‹è¯•)');

/* =========================================================
   GitHub Sync - è¾“å…¥ç›‘å¬ + çŠ¶æ€æ  + è‡ªåŠ¨åŒæ­¥é˜Ÿåˆ—ï¼ˆå¼ºåˆ¶ä¿®å¤ï¼‰
   æ’å…¥ç‚¹ï¼šç´§è·Ÿåœ¨
   console.log('âœ… GitHubåŒæ­¥å‡½æ•°å·²å…¨å±€æš´éœ² (å«é…ç½®ä¿å­˜å’Œè¿æ¥æµ‹è¯•)');
========================================================= */

(function attachSyncTelemetryAndAutoSync(){
  'use strict';

  // 1) å®‰å…¨æ›´æ–°"åŒæ­¥çŠ¶æ€"UI
  function setSyncStatus(text, type) {
    const el = document.getElementById('sync-status-text');
    const box = document.getElementById('sync-status-container');
    if (el) el.textContent = text;

    // ç®€å•è§†è§‰åé¦ˆï¼ˆå¯é€‰ï¼‰
    if (box) {
      box.style.opacity = '1';
      box.style.borderLeftColor =
        type === 'success' ? '#22c55e' :
        type === 'error'   ? '#ef4444' :
        type === 'syncing' ? '#f59e0b' :
                             '#3b82f6';
    }
  }

  // 2) è®°å½•"æ˜¯å¦æœ‰æœªåŒæ­¥æ›´æ”¹"
  let dirty = false;
  let lastDirtyAt = 0;

  // 3) è‡ªåŠ¨åŒæ­¥ï¼šé»˜è®¤å…³é—­ï¼ˆæ‰‹åŠ¨ä¸Šä¼ /ä¸‹è½½æ›´ç¨³ï¼Œé¿å…å¤šç«¯/å¤šæ ‡ç­¾é¡µ sha å†²çª 409ï¼‰
  //    ä½ è¦å¼€å¯å°±æŠŠ AUTO_SYNC_ENABLED æ”¹ä¸º true
  const AUTO_SYNC_ENABLED = false;

  // ç”¨æˆ·åœæ­¢è¾“å…¥å N ms è§¦å‘ï¼ˆå¼€å¯è‡ªåŠ¨åŒæ­¥æ‰ç”Ÿæ•ˆï¼‰
  const AUTO_SYNC_IDLE_MS = 3500;
  let autoTimer = null;
  let syncing = false;

  function hasGitHubConfig() {
    const token = localStorage.getItem('github_token');
    const username = localStorage.getItem('github_username');
    const repo = localStorage.getItem('github_repo');
    return !!(token && username && repo);
  }

  // 4) å¯é€‰ï¼šè¾“å…¥æ—¶æŠŠ"å½“æ—¥æ•°æ®å¿«ç…§"å†™åˆ°æœ¬åœ°ç¼“å­˜ï¼Œé¿å…ä½ è¯´çš„"æˆ‘è¾“å…¥äº†ä½†å¯¼å‡º/åŒæ­¥è¯»ä¸åˆ°"
  function snapshotTodayToLocalCache() {
    try {
      if (typeof window.collectDailyData !== 'function') return;
      const obj = window.collectDailyData(); // { [date]: data }
      const dateKey = Object.keys(obj || {})[0];
      if (!dateKey) return;
      const data = obj[dateKey];
      localStorage.setItem(`tpi_data_${dateKey}`, JSON.stringify(data));
      // æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯æœ¬åœ°ç¼“å­˜å¿«ç…§ï¼Œä¸æ˜¯ GitHub ä¸Šä¼ 
    } catch (e) {
      console.warn('[SYNC] snapshot local cache failed:', e);
    }
  }

  async function runAutoSyncIfNeeded() {
    if (!dirty) return;
    if (syncing) return;
    if (!hasGitHubConfig()) {
      // æ²¡é… GitHubï¼Œå°±åªæç¤º"å¾…åŒæ­¥ï¼ˆæœªé…ç½®ï¼‰"ï¼Œä¸çä¸Šä¼ 
      setSyncStatus('å¾…åŒæ­¥ï¼ˆä½† GitHub æœªé…ç½®ï¼‰', 'info');
      return;
    }
    if (typeof window.syncToGitHub !== 'function') {
      setSyncStatus('å¾…åŒæ­¥ï¼ˆsyncToGitHub ä¸å­˜åœ¨ï¼‰', 'error');
      console.error('[SYNC] syncToGitHub is not a function');
      return;
    }

    syncing = true;
    setSyncStatus('åŒæ­¥ä¸­â€¦', 'syncing');
    console.log('[SYNC] auto syncingâ€¦');

    try {
      // âœ… å¼ºåŒ–ï¼šåŒæ­¥å‰å¼ºåˆ¶è·‘å®Œè§„åˆ™ï¼Œç¡®ä¿ä¸Šä¼ çš„æ˜¯"æœ€æ–°è®¡ç®—ç»“æœ"
      if (typeof __tpi_triggerRecalc === 'function') {
        try { __tpi_triggerRecalc(); } catch(e) { console.warn('[SYNC] recalc failed:', e); }
      }

      await window.syncToGitHub();
      dirty = false;
      setSyncStatus('å·²åŒæ­¥ âœ…', 'success');
      console.log('[SYNC] synced OK');
    } catch (e) {
      setSyncStatus('åŒæ­¥å¤±è´¥ï¼ˆçœ‹æ§åˆ¶å°ï¼‰', 'error');
      console.error('[SYNC] sync failed:', e);
    } finally {
      syncing = false;
    }
  }

  function markDirty(trigger) {
    dirty = true;
    lastDirtyAt = Date.now();
    setSyncStatus('', 'info');
    console.log('[SYNC] dirty by', trigger);

    // æ¯æ¬¡è¾“å…¥éƒ½åšä¸€æ¬¡æœ¬åœ°å¿«ç…§ï¼ˆè§£å†³"è¾“å…¥=æ²¡è¿›å¯¼å‡º/åŒæ­¥è¯»ä¸åˆ°"ï¼‰
    snapshotTodayToLocalCache();

    // âœ… è‡ªåŠ¨åŒæ­¥é»˜è®¤å…³é—­ï¼šåªæ ‡è®° dirtyï¼Œä¸å†åå°è‡ªåŠ¨ä¸Šä¼ ï¼ˆé¿å… 409 å†²çªï¼‰
    if (!AUTO_SYNC_ENABLED) return;

    // é‡ç½®è‡ªåŠ¨åŒæ­¥è®¡æ—¶å™¨
    if (autoTimer) clearTimeout(autoTimer);
    autoTimer = setTimeout(() => {
      // é˜²æŠ–ï¼šç¡®ä¿ç”¨æˆ·çœŸçš„åœæ‰‹äº†
      if (Date.now() - lastDirtyAt >= AUTO_SYNC_IDLE_MS) {
        runAutoSyncIfNeeded();
      }
    }, AUTO_SYNC_IDLE_MS);
  }

  // 5) å…¨å±€ç›‘å¬æ‰€æœ‰è¾“å…¥å˜åŒ–ï¼šinput / change
  //    - input: text/textarea/number ç­‰
  //    - change: checkbox/select ç­‰
  document.addEventListener('input', (e) => {
    const t = e.target;
    if (!t) return;
    // æ’é™¤ GitHub é…ç½®åŒºæœ¬èº«è¾“å…¥ï¼ˆå¦åˆ™ä½ å¡« token ä¹Ÿä¼šè§¦å‘"å¾…åŒæ­¥"ï¼‰
    if (t.id && t.id.startsWith('github-')) return;
    markDirty('input');
  }, true);

  document.addEventListener('change', (e) => {
    const t = e.target;
    if (!t) return;
    if (t.id && t.id.startsWith('github-')) return;
    markDirty('change');
  }, true);

  // 6) é¡µé¢å¯åŠ¨æ—¶ç»™ä¸ªæ˜ç¡®çŠ¶æ€
  if (hasGitHubConfig()) {
    setSyncStatus('å·²é…ç½®ï¼ˆè¾“å…¥åå°†æ˜¾ç¤ºå¾…åŒæ­¥/å¯è‡ªåŠ¨åŒæ­¥ï¼‰', 'success');
  } else {
    setSyncStatus('æœªé…ç½®ï¼ˆè¾“å…¥ä¼šæ ‡è®°å¾…åŒæ­¥ï¼Œä½†ä¸ä¼šè‡ªåŠ¨ä¸Šä¼ ï¼‰', 'info');
  }

  console.log('[SYNC] telemetry + autosync attached');
})();
</script>

<script>
/* =========================================================
   è‰ç¨¿49 ç¨³å®šæ€§è¡¥ä¸ v49.1
   ç›®æ ‡ï¼šæ¶ˆç­å¯¼å‡º/åŒæ­¥/å¤‡ä»½è§¦å‘æ—¶çš„æ§åˆ¶å°æŠ¥é”™
   åŸåˆ™ï¼šä¸æ”¹æŒ‰é’®è¡Œä¸ºã€ä¸æ”¹æ•°æ®ç»“æ„ã€ä¸å½±å“ 8 ç‚¹åº•ç›˜
========================================================= */
(function () {
  'use strict';

  // ---------- 1) ç»Ÿä¸€ Toastï¼šé¿å… tpiToast æœªå®šä¹‰å¯¼è‡´å¤‡ä»½æŠ¥é”™ ----------
  if (typeof window.tpiToast !== 'function') {
    window.tpiToast = function (msg, kind) {
      try {
        const id = 'tpi-toast-fixed';
        let el = document.getElementById(id);
        if (!el) {
          el = document.createElement('div');
          el.id = id;
          el.style.cssText = [
            'position:fixed','right:16px','bottom:16px','z-index:2147483647',
            'max-width:70vw','padding:10px 12px','border-radius:12px',
            'box-shadow:0 8px 24px rgba(0,0,0,.18)','font-size:14px',
            'line-height:1.4','background:rgba(0,0,0,.82)','color:#fff',
            'backdrop-filter: blur(6px)','-webkit-backdrop-filter: blur(6px)',
            'opacity:0','transform:translateY(8px)','transition:all .18s ease'
          ].join(';');
          document.body.appendChild(el);
        }
        el.textContent = String(msg ?? '');
        // kind ä»…ç”¨äºæœªæ¥æ‰©å±•ï¼Œä¸æ”¹å˜å¤–è§‚ï¼Œé¿å…ç ´åæ—¢æœ‰ UI
        requestAnimationFrame(() => {
          el.style.opacity = '1';
          el.style.transform = 'translateY(0)';
        });
        clearTimeout(window.__tpiToastTimer);
        window.__tpiToastTimer = setTimeout(() => {
          el.style.opacity = '0';
          el.style.transform = 'translateY(8px)';
        }, 2200);
      } catch (e) {
        // æœ€åå…œåº•ï¼šä¸è¦è®© toast è‡ªå·±æŠ¥é”™
        try { alert(String(msg ?? '')); } catch (_) {}
      }
    };
  }

  // ---------- 2) TPI.calculateSystem å·²ç§»è‡³ TPI å¯¹è±¡æŒ‚è½½åå®šä¹‰ï¼Œé¿å…è¢«è¦†ç›– ----------
  // æ³¨ï¼šæ­¤å¤„ä¸å†å®šä¹‰ TPI.calculateSystemï¼Œé˜²æ­¢è¢«åç»­çš„ window.TPI = TPI è¦†ç›–
  // å®é™…å®šä¹‰ä½ç½®ï¼šwindow.TPI = TPI ä¹‹å

  // ---------- 3) è¡¥é½ FutureRadar ç¼ºå¤±æ–¹æ³•ï¼šé¿å… __tpi_triggerRecalc è§¦å‘ onchange/oninput æŠ¥é”™ ----------
  // è¯´æ˜ï¼šå¯¼å‡º/åŒæ­¥å‰ä¼šè§¦å‘ safeTriggerRecalc -> __tpi_triggerRecalc
  // å®ƒä¼šå¯¹å…¨ç«™æ§ä»¶æ´¾å‘ input/changeï¼Œè¿›è€Œè§¦å‘æœªæ¥äº‹ä»¶é›·è¾¾é‡Œçš„ file/select å¤„ç†å™¨
  // è¿™äº› handler åœ¨å½“å‰ç¨¿ç¼ºå°‘å®ç°ï¼Œå¯¼è‡´æ§åˆ¶å°æŠ¥é”™ï¼Œä½†ä¸å½±å“å¯¼å‡ºç»“æœã€‚
  // è¿™é‡Œè¡¥é½ä¸ºâ€œå®‰å…¨å®ç°/é™çº§å®ç°â€ï¼Œä¿è¯ä¸æŠ¥é”™ä¸”ä¸æ”¹å˜æ—¢æœ‰é€»è¾‘ã€‚
  if (!window.FutureRadar || typeof window.FutureRadar !== 'object') window.FutureRadar = {};
  // åŒæ­¥ä¸€ä¸ªå…¨å±€åŒåå˜é‡ï¼ˆå…¼å®¹ onchange="FutureRadar.xxx" çš„å†™æ³•ï¼‰
  try { window.FutureRadar = window.FutureRadar; } catch(_) {}
  try { if (typeof window.FutureRadar !== 'undefined') window.FutureRadar = window.FutureRadar; } catch(_) {}
  try { if (typeof FutureRadar === 'undefined') window.FutureRadar && (window.FutureRadar.__dummy = 1); } catch(_) {}

  // eslint-disable-next-line no-unused-vars
  try { if (typeof FutureRadar === 'undefined') window.FutureRadar && (window.FutureRadar.__dummy = 1); } catch(_) {}
  // å¼ºåˆ¶æŠŠå…¨å±€å˜é‡ FutureRadar æŒ‡å‘ window.FutureRadarï¼ˆéä¸¥æ ¼æ¨¡å¼ä¸‹æœ‰æ•ˆï¼›åœ¨ strict ä¸‹ç”¨ window å¼•ç”¨å³å¯ï¼‰
  try { window.FutureRadar && (window.FutureRadar === window.FutureRadar); } catch(_) {}

  if (typeof window.FutureRadar.toggleRadarTimeInputs !== 'function') {
    window.FutureRadar.toggleRadarTimeInputs = function () {
      try {
        // è‹¥é¡µé¢åç»­ç‰ˆæœ¬æä¾›äº†çœŸå®å®ç°ï¼Œä¼˜å…ˆè°ƒç”¨
        const real = window.FutureRadar && window.FutureRadar._toggleRadarTimeInputsReal;
        if (typeof real === 'function') return real();
      } catch (e) {}
      // é»˜è®¤ï¼šä¸åšä»»ä½• DOM æ”¹åŠ¨ï¼Œåªä¿è¯ä¸æŠ¥é”™
      return;
    };
  }

  if (typeof window.FutureRadar.handleFileUpload !== 'function') {
    window.FutureRadar.handleFileUpload = function (evt) {
      try {
        const file = evt && evt.target && evt.target.files && evt.target.files[0];
        // ä¸å¼ºè¡Œè§£ææ–‡ä»¶ï¼Œé¿å…ç ´åä½ å·²æœ‰çš„å¯¼å…¥/å¯¼å‡ºé“¾è·¯ï¼›
        // ä»…åœ¨ç”¨æˆ·çœŸæ­£ä¸Šä¼ æ—¶ç»™å‡ºè½»æç¤ºï¼ˆå¯é€‰ï¼‰
        if (file) {
          // ä¸åˆ·å±
          console.log('[FutureRadar] file selected:', file.name);
        }
      } catch (e) {
        // åƒæ‰å¼‚å¸¸ï¼Œé¿å…ä¸­æ–­å…¶ä»–æµç¨‹
      }
    };
  }

  // è®© inline handler é‡Œç›´æ¥ç”¨ FutureRadar.xxx ä¹Ÿèƒ½æ‰¾åˆ°ï¼ˆæœ€å…³é”®ï¼šé¿å… TypeErrorï¼‰
  try { window.FutureRadar && (window.FutureRadar.__ready = true); } catch(_) {}
  try { window.FutureRadar && (window.FutureRadar.__ready = true); } catch(_) {}
  try { window.FutureRadar && (window.FutureRadar.__ready = true); } catch(_) {}
  // å…¼å®¹ï¼šå¦‚æœæŸå¤„ç”¨çš„æ˜¯ window.FutureRadar.toggleRadarTimeInputs ä¹‹å¤–çš„å¼•ç”¨
  if (typeof window.FutureRadar.toggleRadarTimeInputs !== 'function') window.FutureRadar.toggleRadarTimeInputs = function(){};

  // ---------- 4) é™å™ªï¼šé¿å…åŒæ­¥ dirty æ—¥å¿—åˆ·å±ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰ ----------
  // åªåœ¨å­˜åœ¨å¤§é‡é‡å¤æ‰“å°æ—¶ï¼Œå°†å…¶é™çº§ä¸º debugï¼ˆä¸åˆ é™¤ï¼Œä¸å½±å“ä½ æ’æŸ¥ï¼‰
  try {
    const rawLog = console.log;
    if (!window.__tpi_log_patched__) {
      window.__tpi_log_patched__ = true;
      console.log = function (...args) {
        try {
          if (args && args[0] && typeof args[0] === 'string' && args[0].startsWith('[SYNC] dirty')) {
            // é™çº§ä¸º debug
            return (console.debug || rawLog).apply(console, args);
          }
        } catch (e) {}
        return rawLog.apply(console, args);
      };
    }
  } catch (e) {}
})();
</script>
<script>
/* =========================================================
   ç‹¬è£è¡¥ä¸ v4 Â· Markdown ä¸“ç”¨å¯¼å‡º
========================================================= */

window.exportAsMarkdown = function () {
    let md = '# TPI æ•°æ®å¯¼å‡ºï¼ˆMarkdownï¼‰\n\n';
    md += `å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}

---

`;

    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);

        md += `## ${key}\n\n`;
        md += '```text\n';
        md += value ?? '';
        md += '\n```\n\n';
    }

    const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'TPI_export.md';
    a.click();
};
</script>

  <!-- æ€§èƒ½ä¼˜åŒ–: DNSé¢„è§£æå’Œé¢„è¿æ¥ -->
  <link crossorigin="" href="https://cdn.jsdelivr.net" rel="preconnect"/>
  <link href="https://cdn.jsdelivr.net" rel="dns-prefetch"/>
  <meta charset="utf-8"/>
  <!-- æ€§èƒ½ä¼˜åŒ– -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
  <!-- å®‰å…¨å¢å¼ºå…ƒæ ‡ç­¾ -->
  <meta content="nosniff" http-equiv="X-Content-Type-Options"/>
  <meta content="SAMEORIGIN" http-equiv="X-Frame-Options"/>
  <meta content="1; mode=block" http-equiv="X-XSS-Protection"/>
  <meta content="strict-origin-when-cross-origin" name="referrer"/>
  <!-- Netlifyéƒ¨ç½²ä¼˜åŒ– -->
  <meta content="tpi-system" name="netlify-deploy"/>
  <link href="https://mytpi.netlify.app/" rel="canonical"/>
  <!-- ç¤¾äº¤åª’ä½“ä¼˜åŒ– (Open Graph) -->
  <meta content="TPIå…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿ ç¬¬22ç‰ˆ" property="og:title"/>
  <meta content="å­¦æœ¯ç”Ÿäº§åŠ›è·Ÿè¸ªç³»ç»Ÿ | æœ¬åœ°æ•°æ®å­˜å‚¨" property="og:description"/>
  <meta content="website" property="og:type"/>
  <meta content="zh_CN" property="og:locale"/>
  <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" name="viewport"/>
  <meta content="TPIå…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿ ç¬¬22ç‰ˆ - è·¨è®¾å¤‡åŒæ­¥ | æ”¯æŒç”µè„‘/æ‰‹æœº/å¹³æ¿è®¿é—®" name="description"/>
  <meta content="TPI,æ•ˆèƒ½ç®¡ç†,å­¦æœ¯ç”Ÿäº§åŠ›,æ—¶é—´ç®¡ç†,ä¹ æƒ¯è¿½è¸ª,è·¨è®¾å¤‡åŒæ­¥" name="keywords"/>
  <meta content="TPI System" name="author"/>
  <!-- ç§»åŠ¨ç«¯ä¼˜åŒ– -->
  <meta content="yes" name="apple-mobile-web-app-capable"/>
  <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
  <meta content="TPIæ•ˆèƒ½" name="apple-mobile-web-app-title"/>
  <meta content="yes" name="mobile-web-app-capable"/>
  <meta content="telephone=no, email=no, address=no" name="format-detection"/>
  <meta content="#2563eb" name="theme-color"/>
  <!-- PWA Manifestæ”¯æŒ -->
  <link id="pwa-manifest" rel="manifest"/>
  <script>
   // åŠ¨æ€ç”ŸæˆPWA Manifest
        const manifest = {
            name: "TPIå…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿ ç¬¬22ç‰ˆ",
            short_name: "TPI ç¬¬22ç‰ˆ",
            description: "Total Performance Index - å…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿ",
            start_url: "./",
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#2563eb",
            orientation: "portrait-primary",
            icons: [
                {
                    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect fill='%232563eb' width='512' height='512' rx='128'/%3E%3Ctext x='256' y='340' font-size='280' text-anchor='middle' fill='white' font-family='Arial, sans-serif' font-weight='bold'%3ETPI%3C/text%3E%3C/svg%3E",
                    sizes: "512x512",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                }
            ],
            categories: ["productivity", "education"],
            screenshots: []
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('pwa-manifest').setAttribute('href', manifestURL);
  </script>
  <title>TPIå…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿ ç¬¬22ç‰ˆ è‰ç¨¿22</title>
  <script>
   // è·å–å½“å‰æ—¥æœŸ
        const getCurrentDate = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        
        // ç³»ç»Ÿç‰ˆæœ¬å· (ç¬¬22ç‰ˆ è‰ç¨¿7)
        window.TPI_VERSION = 'ç¬¬22ç‰ˆï¼ˆGitHubäº‘ç«¯åŒæ­¥ç‰ˆï¼Œè‰ç¨¿22ï¼‰';
        window.TPI_DATA_VERSION = '4.2';
        window.TPI_BUILD_DATE = getCurrentDate(); // åŠ¨æ€è·å–å½“å‰æ—¥æœŸ
        window.TPI_FIX_DATE = '2026-01-31'; // ä¿®å¤æ—¥æœŸ
        window.TPI_FIX_NOTE = 'ä¿®å¤äº†æ•°æ®å¯¼å‡ºä¸å¤‡ä»½æ¨¡å—4ä¸ªæŒ‰é’®å‡½æ•°æœªå®šä¹‰çš„é—®é¢˜';
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜ä¸ºå½“å‰æ—¥æœŸå’Œæ˜ŸæœŸã€å†œå†
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            const weekday = weekdays[today.getDay()];
            
            // ä½¿ç”¨å·²å®šä¹‰çš„LunarCalendarè®¡ç®—å†œå†
            const lunar = LunarCalendar.solarToLunar(today);
            const lunarMonths = ['æ­£æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'å†¬æœˆ', 'è…Šæœˆ'];
            const lunarMonth = lunarMonths[lunar.month - 1];
            const lunarDay = lunar.day < 11 ? 'åˆ' + ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å'][lunar.day - 1] 
                            : lunar.day < 20 ? 'å' + ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'][lunar.day - 11]
                            : lunar.day === 20 ? 'äºŒå'
                            : lunar.day < 30 ? 'å»¿' + ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'][lunar.day - 21]
                            : 'ä¸‰å';
            const lunarStr = `å†œå†${lunarMonth}${lunarDay}${lunar.isLeap ? '(é—°)' : ''}`;
            
            document.title = `TPIå…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿ ç¬¬22ç‰ˆ (${window.TPI_BUILD_DATE} ${weekday} ${lunarStr})`;
            
            // åŒæ—¶æ›´æ–°é¡µé¢ä¸­çš„æ—¥æœŸæ˜¾ç¤ºå…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const dateDisplay = document.getElementById('current-date-display');
            if (dateDisplay) {
                dateDisplay.textContent = `${window.TPI_BUILD_DATE} ${weekday} ${lunarStr}`;
            }
            
            // ä¹Ÿæ›´æ–°æ—¥æœŸé€‰æ‹©å™¨æ—è¾¹çš„æ˜¾ç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const weekdaySpan = document.getElementById('date-weekday');
            if (weekdaySpan) {
                // è®¡ç®—å¹´ä»½å’Œå‘¨æ•°
                const getISOWeekInfo = (d) => {
                    const utc = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                    const day = utc.getUTCDay() || 7; // å‘¨ä¸€=1...å‘¨æ—¥=7
                    utc.setUTCDate(utc.getUTCDate() + 4 - day); // å®šä½åˆ°æœ¬å‘¨å‘¨å››
                    const weekYear = utc.getUTCFullYear();
                    const yearStart = new Date(Date.UTC(weekYear, 0, 1));
                    const weekNo = Math.ceil((((utc - yearStart) / 86400000) + 1) / 7);
                    return { weekYear, weekNo };
                };
                
                const { weekYear, weekNo } = getISOWeekInfo(today);
                
                // ç»„åˆæ˜¾ç¤ºï¼šæ˜ŸæœŸ + é˜´å† + å¹´ä»½å‘¨æ•°
                const parts = [];
                parts.push(weekday);
                if (lunarStr) parts.push(lunarStr);
                parts.push(`${weekYear}å¹´ç¬¬${weekNo}å‘¨`);
                
                weekdaySpan.textContent = `(${parts.join(' ')})`;
            }
            
            // ç¡®ä¿æ—¥æœŸè¾“å…¥æ¡†ä¹Ÿæœ‰å€¼ï¼ˆå¦‚æœä¸ºç©ºï¼‰
            const dateInput = document.getElementById('date-input');
            if (dateInput && !dateInput.value) {
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                dateInput.value = `${yyyy}-${mm}-${dd}`;
            }
        });
        window.TPI_OPTIMIZATION_NOTES = 'å†œå†ç³»ç»Ÿ+å®æ—¶è®¡ç®—+å‹ç¼©ä¼˜åŒ–+éªŒè¯è§„åˆ™+æ‰¹é‡æ“ä½œ+å†å²è®°å½•+æ’¤é”€é‡åš+ç§»åŠ¨ç«¯ä¼˜åŒ–+Markdown/PDFå¯¼å‡º';

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ç¡®ä¿TPIå¯¹è±¡å­˜åœ¨
        window.TPI = window.TPI || {};

        window.TPI.toggleCard = function(id) {
            const card = document.getElementById(id);
            if (card) {
                card.classList.toggle('collapsed');
                const content = card.querySelector('.card-content');
                if (content) {
                    content.style.display = card.classList.contains('collapsed') ? 'none' : 'block';
                }
                // ä¿å­˜çŠ¶æ€
                const collapsedState = JSON.parse(localStorage.getItem('tpi_collapsed_state') || '{}');
                collapsedState[id] = card.classList.contains('collapsed');
                localStorage.setItem('tpi_collapsed_state', JSON.stringify(collapsedState));
            }
        };

        // æ·»åŠ toggleRuleså‡½æ•°ç”¨äºæ§åˆ¶è§„åˆ™éƒ¨åˆ†çš„æŠ˜å 
        window.TPI.toggleRules = function(id) {
            const section = document.getElementById(id);
            if (section) {
                section.classList.toggle('collapsed');
                const content = section.querySelector('.rules-content');
                if (content) {
                    content.style.display = section.classList.contains('collapsed') ? 'none' : 'block';
                }
            }
        };
  </script>
  <link href="https://cdn.jsdelivr.net/npm/heatmap-calendar@1.0.0/dist/heatmap-calendar.css" rel="stylesheet"/>
  <!-- å¼•å…¥MathJaxç”¨äºæ•°å­¦å…¬å¼æ¸²æŸ“ -->
  <script>
   MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            }
        };
  </script>
  <script>
   // TPI v21 ä¼˜åŒ–æ¨¡å—
    const LunarCalendar=(function(){'use strict';const L=[0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5b0,0x14573,0x052b0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b6a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x055c0,0x0ab60,0x096d5,0x092e0,0x0c960,0x0d954,0x0d4a0,0x0da50,0x07552,0x056a0,0x0abb7,0x025d0,0x092d0,0x0cab5,0x0a950,0x0b4a0,0x0baa4,0x0ad50,0x055d9,0x04ba0,0x0a5b0,0x15176,0x052b0,0x0a930,0x07954,0x06aa0,0x0ad50,0x05b52,0x04b60,0x0a6e6,0x0a4e0,0x0d260,0x0ea65,0x0d530,0x05aa0,0x076a3,0x096d0,0x04afb,0x04ad0,0x0a4d0,0x1d0b6,0x0d250,0x0d520,0x0dd45,0x0b5a0,0x056d0,0x055b2,0x049b0,0x0a577,0x0a4b0,0x0aa50,0x1b255,0x06d20,0x0ada0,0x14b63,0x09370,0x049f8,0x04970,0x064b0,0x168a6,0x0ea50,0x06b20,0x1a6c4,0x0aae0,0x0a2e0,0x0d2e3,0x0c960,0x0d557,0x0d4a0,0x0da50,0x05d55,0x056a0,0x0a6d0,0x055d4,0x052d0,0x0a9b8,0x0a950,0x0b4a0,0x0b6a6,0x0ad50,0x055a0,0x0aba4,0x0a5b0,0x052b0,0x0b273,0x06930,0x07337,0x06aa0,0x0ad50,0x14b55,0x04b60,0x0a570,0x054e4,0x0d160,0x0e968,0x0d520,0x0daa0,0x16aa6,0x056d0,0x04ae0,0x0a9d4,0x0a2d0,0x0d150,0x0f252,0x0d520,0x0dda0];function g(y){return(L[y-1900]>>13)&0x0f}function m(y,mo){return(L[y-1900]&(0x10000>>mo))?30:29}function y(yr){let s=348;for(let i=0x8000;i>0x8;i>>=1)s+=(L[yr-1900]&i)?1:0;const lm=g(yr);if(lm>0)s+=(L[yr-1900]&0x10000)?30:29;return s}function s2l(d){const b=new Date(1900,0,31);let o=Math.floor((d-b)/86400000),ly,lm,ld,il=false;for(ly=1900;ly<2101;ly++){const yd=y(ly);if(o<yd)break;o-=yd}const lpm=g(ly);for(lm=1;lm<13;lm++){let md;if(lpm>0&&lm===lpm+1){if(!il){--lm;il=true;md=(L[ly-1900]&0x10000)?30:29}else{il=false;md=m(ly,lm)}}else md=m(ly,lm);if(o<md)break;o-=md}return{year:ly,month:lm,day:o+1,isLeap:il}}function l2s(yr,mo,da,il=false){const b=new Date(1900,0,31);let o=0;for(let y=1900;y<yr;y++)o+=y(y);const lm=g(yr);for(let m=1;m<mo;m++)o+=m(yr,m);if(lm>0&&mo>lm)o+=(L[yr-1900]&0x10000)?30:29;if(il)o+=m(yr,mo);o+=da-1;return new Date(b.getTime()+o*86400000)}return{solarToLunar:s2l,lunarToSolar:l2s,getLeapMonth:g}})();
    const RealtimeCalculator=(function(){'use strict';function sp(v,d=0){const p=parseFloat(v);return isNaN(p)||!isFinite(p)?d:p}function cl(v,mn,mx){return Math.max(mn,Math.min(mx,v))}function st(e,t){if(e)e.textContent=String(t)}function cds(id){const ins=document.querySelectorAll(`#${id} input[type="number"]:not([readonly])`);let t=0;ins.forEach(i=>{const v=sp(i.value,0),mn=sp(i.min,-Infinity),mx=sp(i.max,Infinity);t+=cl(v,mn,mx)});return Math.max(0,t)}function uds(id,sid){const sc=cds(id),el=document.getElementById(sid);if(el){if(el.tagName==='INPUT')el.value=sc.toFixed(2);else st(el,sc.toFixed(2))}return sc}function ctt(){const ds=['academic-score','personal-score','life-score','logistics-score'];let t=0;ds.forEach(d=>{const el=document.getElementById(d);if(el){const v=el.tagName==='INPUT'?el.value:el.textContent;t+=sp(v,0)}});return Math.max(0,t)}function utr(ts){const re=document.getElementById('tpi-rating');if(!re)return;let r='F';if(ts>=95)r='S';else if(ts>=80)r='A';else if(ts>=70)r='B';else if(ts>=60)r='C';else if(ts>=50)r='D';else if(ts>=40)r='E';for(let i=0;i<re.options.length;i++)if(re.options[i].value===r){re.selectedIndex=i;break}}function init(){document.addEventListener('input',function(e){if(e.target.type==='number'&&!e.target.readOnly){clearTimeout(e.target._ct);e.target._ct=setTimeout(()=>rec(),100)}},true);document.addEventListener('blur',function(e){if(e.target.type==='number'){const v=sp(e.target.value),mn=sp(e.target.min,-Infinity),mx=sp(e.target.max,Infinity);if(v<mn)e.target.value=mn;else if(v>mx)e.target.value=mx;rec()}},true);console.log('âœ… å®æ—¶è®¡ç®—ç³»ç»Ÿå·²åˆå§‹åŒ–')}function rec(){try{uds('academic-dimension','academic-score');uds('personal-dimension','personal-score');uds('life-dimension','life-score');uds('logistics-dimension','logistics-score');const tt=ctt(),te=document.getElementById('tpi-total-score');if(te)st(te,tt.toFixed(2));utr(tt)}catch(e){console.error('âŒ è®¡ç®—é”™è¯¯:',e)}}return{init:init,recalculate:rec}})();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // å…¨å±€è¾“å…¥éªŒè¯ç³»ç»Ÿ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const InputValidator = (function() {
        'use strict';

        /**
         * éªŒè¯æ•°å­—è¾“å…¥
         */
        function validateNumberInput(input) {
            const value = parseFloat(input.value);
            const min = parseFloat(input.min) || -Infinity;
            const max = parseFloat(input.max) || Infinity;
            const step = parseFloat(input.step) || 1;

            // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
            if (isNaN(value)) {
                showValidationError(input, 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—');
                return false;
            }

            // æ£€æŸ¥èŒƒå›´
            if (value < min) {
                showValidationError(input, `å€¼ä¸èƒ½å°äº ${min}`);
                input.value = min;
                return false;
            }

            if (value > max) {
                showValidationError(input, `å€¼ä¸èƒ½å¤§äº ${max}`);
                input.value = max;
                return false;
            }

            // æ£€æŸ¥æ­¥é•¿ï¼ˆå¦‚æœè®¾ç½®äº†ï¼‰
            if (step !== 1 && step > 0) {
                const remainder = (value - (min || 0)) % step;
                if (Math.abs(remainder) > 0.01) {
                    const rounded = Math.round((value - (min || 0)) / step) * step + (min || 0);
                    input.value = rounded.toFixed(2);
                    showValidationWarning(input, `å·²è‡ªåŠ¨è°ƒæ•´ä¸º ${rounded.toFixed(2)}`);
                }
            }

            clearValidationError(input);
            return true;
        }

        /**
         * éªŒè¯æ—¶é—´è¾“å…¥
         */
        function validateTimeInput(input) {
            const value = input.value;
            const timePattern = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;

            if (!value) {
                return true; // å…è®¸ç©ºå€¼
            }

            if (!timePattern.test(value)) {
                showValidationError(input, 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´æ ¼å¼ (HH:MM)');
                return false;
            }

            clearValidationError(input);
            return true;
        }

        /**
         * éªŒè¯æ—¥æœŸè¾“å…¥
         */
        function validateDateInput(input) {
            const value = input.value;

            if (!value) {
                return true; // å…è®¸ç©ºå€¼
            }

            const date = new Date(value);
            if (isNaN(date.getTime())) {
                showValidationError(input, 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸ');
                return false;
            }

            // æ£€æŸ¥æ—¥æœŸèŒƒå›´ï¼ˆ1900-2100ï¼‰
            const year = date.getFullYear();
            if (year < 1900 || year > 2100) {
                showValidationError(input, 'æ—¥æœŸå¿…é¡»åœ¨ 1900-2100 å¹´ä¹‹é—´');
                return false;
            }

            clearValidationError(input);
            return true;
        }

        /**
         * æ˜¾ç¤ºéªŒè¯é”™è¯¯
         */
        function showValidationError(input, message) {
            // ç§»é™¤æ—§çš„é”™è¯¯æç¤º
            clearValidationError(input);

            // æ·»åŠ é”™è¯¯æ ·å¼
            input.style.borderColor = '#ef4444';
            input.style.backgroundColor = '#fef2f2';

            // åˆ›å»ºé”™è¯¯æç¤º
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error';
            errorDiv.style.cssText = `
                color: #ef4444;
                font-size: 0.875rem;
                margin-top: 4px;
                display: flex;
                align-items: center;
                gap: 4px;
            `;
            errorDiv.innerHTML = `<span>âš ï¸</span><span>${message}</span>`;

            input.parentNode.insertBefore(errorDiv, input.nextSibling);

            // è½»å¾®éœ‡åŠ¨æ•ˆæœ
            input.animate([
                { transform: 'translateX(0)' },
                { transform: 'translateX(-5px)' },
                { transform: 'translateX(5px)' },
                { transform: 'translateX(-5px)' },
                { transform: 'translateX(0)' }
            ], {
                duration: 300,
                easing: 'ease-in-out'
            });
        }

        /**
         * æ˜¾ç¤ºéªŒè¯è­¦å‘Š
         */
        function showValidationWarning(input, message) {
            showNotification(message, 'warning');
        }

        /**
         * æ¸…é™¤éªŒè¯é”™è¯¯
         */
        function clearValidationError(input) {
            input.style.borderColor = '';
            input.style.backgroundColor = '';

            const nextSibling = input.nextSibling;
            if (nextSibling && nextSibling.className === 'validation-error') {
                nextSibling.remove();
            }
        }

        /**
         * åˆå§‹åŒ–éªŒè¯ç³»ç»Ÿ
         */
        function init() {
            // ä¸ºæ‰€æœ‰æ•°å­—è¾“å…¥æ·»åŠ éªŒè¯
            document.addEventListener('blur', function(e) {
                if (e.target.type === 'number') {
                    validateNumberInput(e.target);
                } else if (e.target.type === 'time') {
                    validateTimeInput(e.target);
                } else if (e.target.type === 'date') {
                    validateDateInput(e.target);
                }
            }, true);

            // å®æ—¶éªŒè¯ï¼ˆè¾“å…¥æ—¶ï¼‰
            document.addEventListener('input', function(e) {
                if (e.target.type === 'number') {
                    // å»¶è¿ŸéªŒè¯ï¼Œé¿å…æ¯æ¬¡æŒ‰é”®éƒ½éªŒè¯
                    clearTimeout(e.target._validationTimer);
                    e.target._validationTimer = setTimeout(() => {
                        validateNumberInput(e.target);
                    }, 500);
                }
            }, true);

        }

        return {
            init: init,
            validateNumber: validateNumberInput,
            validateTime: validateTimeInput,
            validateDate: validateDateInput
        };
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CheckboxæˆåŠŸæç¤ºç³»ç»Ÿ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function initCheckboxSuccessNotifications() {
        // ä¸ºæ‰€æœ‰é‡è¦çš„checkboxæ·»åŠ changeç›‘å¬
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                if (this.checked && window.SuccessNotifier) {
                    const label = this.getAttribute('aria-label') ||
                                 this.parentElement.textContent.trim().substring(0, 20) ||
                                 'é€‰é¡¹';

                    // åªåœ¨ç‰¹å®šæƒ…å†µä¸‹æ˜¾ç¤ºæç¤ºï¼ˆé¿å…è¿‡åº¦æç¤ºï¼‰
                    const shouldNotify =
                        this.name.includes('exemption') ||
                        this.name.includes('cognitive') ||
                        this.name.includes('resource') ||
                        this.id.includes('radar') ||
                        this.id.includes('important');

                    if (shouldNotify) {
                        // ä½¿ç”¨ç®€çŸ­çš„toastæç¤ºï¼Œè€Œä¸æ˜¯æ¨¡æ€æ¡†
                        window.InputValidator.showToast(`âœ… å·²å‹¾é€‰ï¼š${label}`, 'success');
                    }
                }
            });
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Type S éªŒè¯ç³»ç»Ÿ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.validateTypeS = function(period) {
        const scoreInput = document.getElementById(`type-s-score-${period}`);
        const contentTextarea = document.getElementById(`type-s-content-${period}`);
        const errorDiv = document.getElementById(`type-s-error-${period}`);

        if (!scoreInput || !contentTextarea || !errorDiv) {
            console.warn(`Type S elements not found for period: ${period}`);
            return true;
        }

        const score = parseFloat(scoreInput.value) || 0;
        const content = contentTextarea.value.trim();

        // å¦‚æœåˆ†æ•°å¤§äº0ï¼Œå¿…é¡»å¡«å†™å†…å®¹
        if (score > 0 && content === '') {
            errorDiv.style.display = 'block';
            contentTextarea.style.borderColor = '#ef4444';
            contentTextarea.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            return false;
        } else {
            errorDiv.style.display = 'none';
            contentTextarea.style.borderColor = '';
            contentTextarea.style.boxShadow = '';

            // å¦‚æœå¡«å†™äº†å†…å®¹å¹¶ä¸”åˆ†æ•°å¤§äº0ï¼Œæ˜¾ç¤ºæˆåŠŸæç¤º
            if (score > 0 && content !== '' && window.SuccessNotifier) {
                window.InputValidator.showToast(`âœ… Type S (${period}) å†…å®¹å·²å¡«å†™`, 'success');
            }
            return true;
        }
    };

   // å·®å¼‚23ä¿®å¤ï¼šFç³»æ•°æ™šé—´è§£é”ï¼ˆæµ·æ£®å ¡é˜²æŠ–ï¼‰ - å·²ç¦ç”¨ï¼Œå…è®¸éšæ—¶é€‰æ‹©
    function lockFocusFactorUntilEvening() {
        // åŠŸèƒ½å·²ç§»é™¤ï¼Œå…è®¸éšæ—¶é€‰æ‹©
        const focusSelects = document.querySelectorAll('select[aria-label*="ä¸“æ³¨ç³»æ•°"]');
        focusSelects.forEach(select => {
            select.disabled = false;
            select.style.opacity = '1';
            select.title = 'é€‰æ‹©ä¸“æ³¨ç³»æ•°';
        });
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', lockFocusFactorUntilEvening);
    } else {
        lockFocusFactorUntilEvening();
    }

    // å·®å¼‚43ä¿®å¤ï¼šTier2ç»“æ„åŒ–å®ç°
    function initializeTier2System() {
        const tier2Textareas = document.querySelectorAll('textarea[aria-label*="å¤‡æ³¨"]');

        tier2Textareas.forEach(textarea => {
            // æ·»åŠ Tier2æ ‡è¯†
            textarea.dataset.tier = '2';
            if (!textarea.placeholder.includes('Tier2')) {
                textarea.placeholder += ' [Tier2: å¯é€šè¿‡#è§„åˆ™ä¿®æ”¹# è¯­æ³•è°ƒæ•´è®¡åˆ†è§„åˆ™]';
            }

            // ç›‘å¬å¤‡æ³¨å˜åŒ–ï¼Œè§£æè§„åˆ™ä¿®æ”¹æŒ‡ä»¤
            textarea.addEventListener('blur', function() {
                parseTier2Rules(this);
            });
        });
    }

    function parseTier2Rules(textarea) {
        const content = textarea.value;
        const rulePattern = /#è§„åˆ™ä¿®æ”¹#\s*(.+?)#/g;
        let match;

        while ((match = rulePattern.exec(content)) !== null) {
            const ruleText = match[1].trim();

            // ç¤ºä¾‹ï¼šè§£æ"åˆé¤é˜²å®ˆ+1åˆ†"
            if (ruleText.includes('åˆé¤') && ruleText.includes('+')) {
                const scoreMatch = ruleText.match(/([+-]\d+\.?\d*)/);
                if (scoreMatch) {
                    const adjustment = parseFloat(scoreMatch[1]);
                }
            }
        }
    }

    // åˆå§‹åŒ–Tier2ç³»ç»Ÿ
    if(document.readyState==='loading'){
        document.addEventListener('DOMContentLoaded', initializeTier2System);
    } else {
        initializeTier2System();
    }
  </script>
  <script id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
  </script>
<script>
/* =========================================================
   ç‹¬è£æœ€ç»ˆæ¥ç®¡è¡¥ä¸ Â· vFinal
   ç›®æ ‡ï¼š
   - ä¿å­˜ â‰  å¯¼å‡º
   - Markdown â‰  JSON
   - å½»åº•åˆ‡æ–­æ—§ onclick è¯¯ç»‘å®š
========================================================= */

/* 1ï¸âƒ£ ä¿å­˜å½“å‰æ•°æ®ï¼šåªæç¤ºï¼Œä¸å¯¼å‡º */
window.saveTpiData = function () {
    try {
        // ä¿å­˜å½“å‰æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        const obj = window.collectDailyData();
        const dateKey = Object.keys(obj || {})[0];
        if (dateKey) {
            localStorage.setItem(`tpi_data_${dateKey}`, JSON.stringify(obj[dateKey]));
        }
        
        alert('âœ… å½“å‰æ•°æ®å·²çœŸå®å†™å…¥æœ¬åœ°ç¼“å­˜ï¼ˆlocalStorageï¼‰');
        console.log('[SAVE] saved snapshot for', dateKey);
    } catch (e) {
        console.error('[SAVE] failed:', e);
        alert('âŒ ä¿å­˜å¤±è´¥ï¼šè¯·çœ‹æ§åˆ¶å°');
    }
};

/* 2ï¸âƒ£ Markdown å¯¼å‡ºï¼šå¼ºåˆ¶ä¸º Markdown */
window.exportAsMarkdown = function () {
    let md = '# TPI æ•°æ®å¯¼å‡ºï¼ˆMarkdownï¼‰\n\n';
    md += `å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}

---

`;

    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        md += `## ${key}\n\n`;
        md += '```text\n';
        md += value ?? '';
        md += '\n```\n\n';
    }

    const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'TPI_export.md';
    a.click();
};

/* 3ï¸âƒ£ JSON å¯¼å‡ºï¼šä¿æŒçº¯ JSON */
window.exportAsJSON = window.exportAsJSON || function () {
    const data = {};
    for (let i = 0; i < localStorage.length; i++) {
        const k = localStorage.key(i);
        data[k] = localStorage.getItem(k);
    }
    const blob = new Blob(
        [JSON.stringify(data, null, 2)],
        { type: 'application/json' }
    );
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'TPI_export.json';
    a.click();
};

/* 4ï¸âƒ£ å…³é”®æ–­è·¯ï¼šå½»åº•åºŸæ‰ exportDataComplete */
window.exportDataComplete = function () {
    console.warn('â›” exportDataComplete å·²è¢«åºŸå¼ƒï¼Œç¦æ­¢å†ç”¨äºå¯¼å‡º');
};
</script>
<script>
/* =========================================================
   ç»ˆæ DOM æ¥ç®¡è¡¥ä¸ Â· vULTIMATE
   ç›®æ ‡ï¼š
   - å½»åº•æ— è§† HTML ä¸­çš„ onclick
   - ç›´æ¥æ¥ç®¡ä¸‰ä¸ªæŒ‰é’®çš„ç‚¹å‡»è¡Œä¸º
========================================================= */

document.addEventListener('DOMContentLoaded', () => {

    const buttons = Array.from(document.querySelectorAll('button'));

    let btnSave = null;
    let btnMD   = null;
    let btnJSON = null;

    buttons.forEach(btn => {
        const text = btn.innerText || '';

        if (text.includes('ä¿å­˜å½“å‰æ•°æ®')) btnSave = btn;
        if (text.includes('Markdown')) btnMD = btn;
        if (text.includes('JSON')) btnJSON = btn;
    });

    /* 1ï¸âƒ£ ä¿å­˜å½“å‰æ•°æ®ï¼šåªä¿å­˜ï¼Œä¸å¯¼å‡º */
    if (btnSave) {
        btnSave.onclick = () => {
            alert('âœ… å½“å‰æ•°æ®å·²ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼ˆlocalStorageï¼‰');
        };
    }

    /* 2ï¸âƒ£ Markdown å¯¼å‡º */
    if (btnMD) {
        btnMD.onclick = () => {
            let md = '# TPI æ•°æ®å¯¼å‡ºï¼ˆMarkdownï¼‰\n\n';
            md += `å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}

---

`;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                md += `## ${key}

\`\`\`text
${value ?? ''}
\`\`\`

`;
            }

            const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'TPI_export.md';
            a.click();
        };
    }

    /* 3ï¸âƒ£ JSON å¯¼å‡º */
    if (btnJSON) {
        btnJSON.onclick = () => {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                data[k] = localStorage.getItem(k);
            }

            const blob = new Blob(
                [JSON.stringify(data, null, 2)],
                { type: 'application/json' }
            );
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'TPI_export.json';
            a.click();
        };
    }

    console.log('âœ… ç»ˆæ DOM æ¥ç®¡è¡¥ä¸å·²ç”Ÿæ•ˆ');
});
</script>

  <style>
   /* è¡¥å…¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; }
    .modal-body { padding: 20px; }
    /* âœ… ä¿®å¤ï¼šæœªæ¥äº‹ä»¶é›·è¾¾å››ä¸ªå¼¹çª—ï¼ˆç”Ÿæ´»ä¸´æ—¶/å­¦æœ¯ä¸´æ—¶/ç”Ÿæ´»å¸¸è§„/å­¦æœ¯å¸¸è§„ï¼‰å†…å®¹è¿‡é•¿æ—¶å¯ä¸Šä¸‹æ»šåŠ¨ */
    #radar-modal .modal{ max-height: 90vh; }
    #radar-modal .modal-body{
      flex: 1;
      min-height: 0;            /* å…³é”®ï¼šå…è®¸ flex å­é¡¹å†…éƒ¨æ»šåŠ¨ */
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
    :root{--color-primary:#2563eb;--color-primary-light:#60a5fa;--color-primary-dark:#1e40af;--color-secondary:#f59e0b;--color-accent:#ec4899;--color-success:#10b981;--color-warning:#f59e0b;--color-danger:#ef4444;--color-info:#3b82f6;--color-tier1:#ef4444;--color-tier2:#f59e0b;--color-tier3:#6b7280;--color-legend:#a855f7;--color-excellent:#10b981;--color-good:#3b82f6;--color-normal:#f59e0b;--color-poor:#6b7280;--color-bg-primary:#ffffff;--color-bg-secondary:#f9fafb;--color-bg-tertiary:#f3f4f6;--color-bg-hover:#f0f9ff;--color-text-primary:#111827;--color-text-secondary:#4b5563;--color-text-muted:#9ca3af;--color-border:#e5e7eb;--color-border-light:#f3f4f6;--color-shadow:rgba(0, 0, 0, 0.1);--font-display:-apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;--font-body:-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans SC', 'Microsoft YaHei', sans-serif;--font-mono:'SF Mono', 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;--font-size-xs:0.75rem;--font-size-sm:0.875rem;--font-size-base:1rem;--font-size-lg:1.125rem;--font-size-xl:1.25rem;--font-size-2xl:1.5rem;--font-size-3xl:1.875rem;--font-size-4xl:2.25rem;--spacing-0:0;--spacing-1:0.25rem;--spacing-2:0.5rem;--spacing-3:0.75rem;--spacing-4:1rem;--spacing-5:1.25rem;--spacing-6:1.5rem;--spacing-8:2rem;--spacing-10:2.5rem;--spacing-12:3rem;--spacing-16:4rem;--radius-sm:0.375rem;--radius-md:0.5rem;--radius-lg:0.75rem;--radius-xl:1rem;--radius-full:9999px;--shadow-xs:0 1px 2px 0 rgba(0, 0, 0, 0.05);--shadow-sm:0 1px 3px 0 rgba(0, 0, 0, 0.1);--shadow-md:0 4px 6px -1px rgba(0, 0, 0, 0.1);--shadow-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1);--shadow-xl:0 20px 25px -5px rgba(0, 0, 0, 0.1);--transition-fast:150ms cubic-bezier(0.4, 0, 0.2, 1);--transition-base:250ms cubic-bezier(0.4, 0, 0.2, 1);--transition-slow:350ms cubic-bezier(0.4, 0, 0.2, 1);--z-base:1;--z-dropdown:1000;--z-sticky:1020;--z-fixed:1030;--z-modal:1040;--z-tooltip:1050;}

/* ç¬¬30ç‰ˆæ–°å¢ï¼šäº‘ç«¯åŒæ­¥æ¨¡å—æš—é»‘æ¨¡å¼æ”¯æŒ */
body.dark-mode .sync-status-container,
body.dark-theme .sync-status-container {
    background: #1e3a5f !important;
    border-left-color: #3b82f6 !important;
}

body.dark-mode .sync-status-container strong,
body.dark-theme .sync-status-container strong {
    color: #60a5fa !important;
}

body.dark-mode .sync-status-container span,
body.dark-theme .sync-status-container span {
    color: #d1d5db !important;
}

body.dark-mode .github-config-grid input,
body.dark-theme .github-config-grid input {
    background: #374151 !important;
    border-color: #4b5563 !important;
    color: #f3f4f6 !important;
}

body.dark-mode .github-config-grid label,
body.dark-theme .github-config-grid label {
    color: #d1d5db !important;
}

body.dark-mode .sync-help,
body.dark-theme .sync-help {
    background: #3f2f1e !important;
}

body.dark-mode .sync-help div,
body.dark-theme .sync-help div {
    color: #d1d5db !important;
}



/* ToaståŠ¨ç”» */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.card{transition:all var(--transition-base);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);}.card:hover{box-shadow:var(--shadow-md);transform:translateY(-2px);}.card.collapsed{transition:all var(--transition-base);}.card.collapsed .card-content{transition:all var(--transition-base);opacity:0;max-height:0;overflow:hidden;}.card:not(.collapsed) .card-content{transition:all var(--transition-base);opacity:1;}button, .btn{transition:all var(--transition-fast);border-radius:var(--radius-md);cursor:pointer;border:1px solid transparent;}button:hover, .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm);}button:active, .btn:active{transform:translateY(0);}input:focus, select:focus, textarea:focus{outline:none;border-color:var(--color-primary);box-shadow:0 0 0 3px rgba(37, 99, 235, 0.1);transition:all var(--transition-fast);}table tr:nth-child(even){background-color:var(--color-bg-secondary);}table tr:hover{background-color:var(--color-bg-hover);transition:background-color var(--transition-fast);}body.dark-theme{--color-bg-primary:#1a1a1a;--color-bg-secondary:#2a2a2a;--color-bg-tertiary:#3a3a3a;--color-bg-hover:#2d3748;--color-text-primary:#e5e5e5;--color-text-secondary:#b8b8b8;--color-text-muted:#808080;--color-border:#404040;--color-border-light:#505050;--color-shadow:rgba(0, 0, 0, 0.3);}body.dark-theme .card{background:var(--color-bg-secondary);border-color:var(--color-border);}body.dark-theme .card:hover{background:var(--color-bg-tertiary);box-shadow:0 4px 12px rgba(0, 0, 0, 0.4);}body.dark-theme input, body.dark-theme select, body.dark-theme textarea{background:var(--color-bg-tertiary);color:var(--color-text-primary);border-color:var(--color-border);}body.dark-theme table tr:nth-child(even){background-color:rgba(255, 255, 255, 0.03);}body.dark-theme table tr:hover{background-color:rgba(255, 255, 255, 0.06);}::-webkit-scrollbar{width:10px;height:10px;}::-webkit-scrollbar-track{background:var(--color-bg-secondary);border-radius:var(--radius-sm);}::-webkit-scrollbar-thumb{background:var(--color-border);border-radius:var(--radius-sm);transition:background var(--transition-fast);}::-webkit-scrollbar-thumb:hover{background:var(--color-text-muted);}body.dark-theme::-webkit-scrollbar-track{background:var(--color-bg-tertiary);}body.dark-theme::-webkit-scrollbar-thumb{background:#505050;}body.dark-theme::-webkit-scrollbar-thumb:hover{background:#606060;}@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}@keyframes slideInRight{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}@keyframes slideOutRight{from{opacity:1;transform:translateX(0);}to{opacity:0;transform:translateX(20px);}}@keyframes pulse{0%, 100%{opacity:1;}50%{opacity:0.5;}}.section{animation:fadeIn 0.4s ease-out;}@keyframes pulse{0%, 100%{opacity:1;}50%{opacity:0.5;}}to{transform:translateX(0);opacity:1;}}#toast-container{position:fixed;top:20px;right:20px;z-index:calc(var(--z-modal) + 10);display:flex;flex-direction:column;gap:var(--spacing-3);pointer-events:none;}.toast{min-width:300px;max-width:400px;padding:var(--spacing-4) var(--spacing-5);border-radius:var(--radius-xl);background:var(--color-bg-primary);box-shadow:var(--shadow-xl);border:1px solid var(--color-border);display:flex;align-items:center;gap:var(--spacing-3);pointer-events:auto;animation:toastSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);}.toast.toast-exit{animation:toastSlideOut 0.25s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;}.toast-icon{flex-shrink:0;font-size:var(--font-size-2xl);line-height:1;}.toast-content{flex:1;display:flex;flex-direction:column;gap:var(--spacing-1);}.toast-title{font-weight:600;font-size:var(--font-size-sm);color:var(--color-text-primary);}.toast-message{font-size:var(--font-size-sm);color:var(--color-text-secondary);line-height:1.4;}.toast.success{border-left:4px solid var(--color-success);}.toast.success .toast-icon{color:var(--color-success);}.toast.error{border-left:4px solid var(--color-danger);}.toast.error .toast-icon{color:var(--color-danger);}.toast.warning{border-left:4px solid var(--color-warning);}.toast.warning .toast-icon{color:var(--color-warning);}.toast.info{border-left:4px solid var(--color-info);}.toast.info .toast-icon{color:var(--color-info);}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0, 0, 0, 0.5);backdrop-filter:blur(8px);z-index:var(--z-modal);display:flex;align-items:center;justify-content:center;padding:var(--spacing-4);animation:modalFadeIn 0.25s cubic-bezier(0.16, 1, 0.3, 1);}.modal-overlay.modal-exit{animation:modalFadeOut 0.2s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;}.modal{background:var(--color-bg-primary);border-radius:var(--radius-xl);box-shadow:var(--shadow-xl);max-width:480px;width:100%;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;animation:modalScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);}.modal-exit .modal{animation:modalScaleOut 0.2s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards;}.modal-header{padding:var(--spacing-6);border-bottom:1px solid var(--color-border);display:flex;align-items:center;gap:var(--spacing-4);flex-shrink:0;}.modal-icon{flex-shrink:0;width:48px;height:48px;border-radius:var(--radius-full);display:flex;align-items:center;justify-content:center;font-size:var(--font-size-3xl);}.modal-title-wrapper{flex:1;}.modal-title{font-size:var(--font-size-xl);font-weight:700;color:var(--color-text-primary);margin:0;line-height:1.3;}.modal-subtitle{font-size:var(--font-size-sm);color:var(--color-text-muted);margin-top:var(--spacing-1);}.modal-body{padding:var(--spacing-6);overflow-y:auto;flex:1;}.modal-message{font-size:var(--font-size-base);line-height:1.6;color:var(--color-text-secondary);margin-bottom:var(--spacing-4);}.modal-details{background:var(--color-bg-secondary);border-radius:var(--radius-md);padding:var(--spacing-4);font-size:var(--font-size-sm);color:var(--color-text-secondary);border-left:3px solid var(--color-border);}.modal-details strong{color:var(--color-text-primary);font-weight:600;}.modal-footer{padding:var(--spacing-6);border-top:1px solid var(--color-border);display:flex;gap:var(--spacing-3);justify-content:flex-end;flex-shrink:0;}.modal-button{padding:var(--spacing-3) var(--spacing-6);border-radius:var(--radius-lg);font-size:var(--font-size-base);font-weight:600;cursor:pointer;border:none;transition:all var(--transition-fast);font-family:var(--font-body);}.modal-button:hover{transform:translateY(-1px);box-shadow:var(--shadow-md);}.modal-button:active{transform:translateY(0);}.modal-button-primary{background:var(--color-primary);color:white;}.modal-button-primary:hover{background:var(--color-primary-dark);}.modal.danger .modal-icon{background:rgba(239, 68, 68, 0.1);color:var(--color-danger);}.modal.danger .modal-button-primary{background:var(--color-danger);}.modal.danger .modal-button-primary:hover{background:#dc2626;}.modal.warning .modal-icon{background:rgba(245, 158, 11, 0.1);color:var(--color-warning);}.modal.warning .modal-button-primary{background:var(--color-warning);}.modal.warning .modal-button-primary:hover{background:#d97706;}.modal.success .modal-icon{background:rgba(16, 185, 129, 0.1);color:var(--color-success);}.modal.success .modal-button-primary{background:var(--color-success);}.modal.success .modal-button-primary:hover{background:#059669;}.modal.legend .modal-icon{background:linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(245, 158, 11, 0.1));color:var(--color-legend);}.modal.legend .modal-button-primary{background:linear-gradient(135deg, var(--color-legend), var(--color-warning));}.modal.legend .modal-button-primary:hover{background:linear-gradient(135deg, #9333ea, #d97706);}@keyframes toastSlideIn{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}@keyframes toastSlideOut{from{transform:translateX(0);opacity:1;}to{transform:translateX(120%);opacity:0;}}@keyframes modalFadeIn{from{opacity:0;}to{opacity:1;}}@keyframes modalFadeOut{from{opacity:1;}to{opacity:0;}}@keyframes modalScaleIn{from{transform:scale(0.9);opacity:0;}to{transform:scale(1);opacity:1;}}@keyframes modalScaleOut{from{transform:scale(1);opacity:1;}to{transform:scale(0.95);opacity:0;}}@media (max-width:768px){#toast-container{left:var(--spacing-4);right:var(--spacing-4);top:var(--spacing-4);}.toast{min-width:unset;width:100%;}.modal{max-width:100%;margin:var(--spacing-4);}.modal-header, .modal-body, .modal-footer{padding:var(--spacing-4);}.modal-icon{width:40px;height:40px;font-size:var(--font-size-2xl);}.modal-title{font-size:var(--font-size-lg);}}.date-nav-container{display:flex;align-items:center;gap:var(--spacing-2);flex-wrap:wrap;}.date-nav-btn{padding:var(--spacing-2) var(--spacing-3);border:1px solid var(--color-border);border-radius:var(--radius-md);background:var(--color-bg-primary);color:var(--color-text-secondary);font-size:var(--font-size-sm);cursor:pointer;transition:all var(--transition-fast);white-space:nowrap;}.date-nav-btn:hover{background:var(--color-bg-hover);border-color:var(--color-primary);color:var(--color-primary);}.date-nav-btn:active{transform:scale(0.95);}.date-nav-btn.icon-only{padding:var(--spacing-2);font-weight:bold;}.date-info{font-size:var(--font-size-sm);color:var(--color-text-muted);margin-left:var(--spacing-2);}.storage-indicator{display:inline-flex;align-items:center;gap:var(--spacing-2);padding:var(--spacing-2) var(--spacing-3);border-radius:var(--radius-md);background:var(--color-bg-secondary);font-size:var(--font-size-xs);color:var(--color-text-muted);}.storage-bar{width:60px;height:4px;background:var(--color-border);border-radius:var(--radius-full);overflow:hidden;}.storage-bar-fill{height:100%;background:var(--color-success);transition:all var(--transition-base);}.storage-bar-fill.warning{background:var(--color-warning);}.storage-bar-fill.danger{background:var(--color-danger);}.help-btn{position:absolute;bottom:80px;right:20px;width:50px;height:50px;border-radius:50%;background:var(--color-primary);color:white;border:none;cursor:pointer;box-shadow:var(--shadow-lg);display:flex;align-items:center;justify-content:center;font-size:var(--font-size-2xl);z-index:var(--z-fixed);transition:all var(--transition-base);}.help-btn:hover{transform:scale(1.1);box-shadow:var(--shadow-xl);}.password-strength{margin-top:var(--spacing-2);font-size:var(--font-size-xs);}.strength-bar{height:4px;background:var(--color-border);border-radius:var(--radius-full);overflow:hidden;margin-top:var(--spacing-1);}.strength-bar-fill{height:100%;transition:all var(--transition-base);}.strength-weak{background:var(--color-danger);}.strength-medium{background:var(--color-warning);}.strength-strong{background:var(--color-success);}@media (max-width:768px){.date-nav-container{width:100%;}.date-nav-btn{flex:1;min-width:60px;}.help-btn{bottom:130px;}.storage-indicator{width:100%;justify-content:center;}}body.dark-theme{--color-bg-primary:#1a1a1a;--color-bg-secondary:#2d2d2d;--color-bg-tertiary:#3a3a3a;--color-bg-hover:#404040;--color-text-primary:#f5f5f5;--color-text-secondary:#d1d1d1;--color-text-muted:#a0a0a0;--color-border:#4a4a4a;--color-border-light:#3a3a3a;--color-shadow:rgba(0, 0, 0, 0.5);}body.dark-theme .card, body.dark-theme .section, body.dark-theme .input-group, body.dark-theme input, body.dark-theme textarea, body.dark-theme select, body.dark-theme .btn{background-color:var(--color-bg-tertiary);color:var(--color-text-primary);border-color:var(--color-border);}body.dark-theme .modal, body.dark-theme .toast{background:var(--color-bg-primary);border-color:var(--color-border);}body.dark-theme .table{background:var(--color-bg-tertiary);color:var(--color-text-primary);}body.dark-theme .table th{background:var(--color-bg-secondary);border-color:var(--color-border);}body.dark-theme .table td{border-color:var(--color-border);}*, *::before, *::after{margin:0;padding:0;box-sizing:border-box;}html{font-size:16px;scroll-behavior:smooth;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}body{font-family:var(--font-body);font-size:var(--font-size-base);line-height:1.6;color:var(--color-text-primary);background-color:var(--color-bg-secondary);min-height:100vh;}h1, h2, h3, h4, h5, h6{font-family:var(--font-display);font-weight:600;line-height:1.2;color:var(--color-text-primary);margin-bottom:var(--spacing-4);}h1{font-size:var(--font-size-4xl);font-weight:700;}h2{font-size:var(--font-size-3xl);}h3{font-size:var(--font-size-2xl);}h4{font-size:var(--font-size-xl);}h5{font-size:var(--font-size-lg);}h6{font-size:var(--font-size-base);}p{margin-bottom:var(--spacing-4);color:var(--color-text-secondary);}a{color:var(--color-primary);text-decoration:none;transition:color var(--transition-fast);}a:hover{color:var(--color-primary-dark);text-decoration:underline;}.page-wrapper{min-height:100vh;background:linear-gradient(135deg, #f0f9ff 0%, #ffffff 50%, #fef3c7 100%);}.container{max-width:1600px;margin:0 auto;padding:var(--spacing-4);}.top-header{background:rgba(255, 255, 255, 0.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--color-border);box-shadow:var(--shadow-sm);position:relative;animation:slideDown 0.5s ease-out;}@keyframes slideDown{from{transform:translateY(-100%);opacity:0;}to{transform:translateY(0);opacity:1;}}.header-content{max-width:1600px;margin:0 auto;padding:var(--spacing-4) var(--spacing-6);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:var(--spacing-3);flex-wrap:wrap;}.header-title{display:flex;align-items:center;justify-content:center;width:100%;gap:var(--spacing-3);}.header-title h1{font-size:var(--font-size-3xl);font-weight:800;background:linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0;text-align:center;}.version-badge{background:linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);color:white;padding:var(--spacing-1) var(--spacing-3);border-radius:var(--radius-full);font-size:var(--font-size-sm);font-weight:600;letter-spacing:0.5px;}.date-selector{display:flex;align-items:center;gap:var(--spacing-2);background:var(--color-bg-tertiary);padding:var(--spacing-2) var(--spacing-4);border-radius:var(--radius-lg);border:1px solid var(--color-border);}.date-selector label{font-size:var(--font-size-sm);font-weight:500;color:var(--color-text-secondary);}.date-selector input{border:1px solid var(--color-border);border-radius:var(--radius-md);padding:var(--spacing-2) var(--spacing-3);font-size:var(--font-size-sm);font-family:var(--font-mono);background:white;transition:all var(--transition-fast);}.date-selector input:focus{outline:none;border-color:var(--color-primary);box-shadow:0 0 0 3px rgba(37, 99, 235, 0.1);}.card{background:white;border-radius:var(--radius-xl);border:1px solid var(--color-border);box-shadow:var(--shadow-sm);margin-bottom:var(--spacing-6);transition:all var(--transition-base);overflow:hidden;}.card:hover{box-shadow:var(--shadow-md);}.card-header{display:flex;align-items:center;justify-content:space-between;padding:var(--spacing-5);background:var(--color-bg-tertiary);border-bottom:1px solid var(--color-border);cursor:pointer;user-select:none;}.card-header:hover{background:var(--color-bg-hover);}.card-title{display:flex;align-items:center;gap:var(--spacing-3);font-size:var(--font-size-lg);font-weight:600;color:var(--color-text-primary);}.card-title .icon{font-size:var(--font-size-xl);line-height:1;}.card-badge{padding:var(--spacing-1) var(--spacing-3);border-radius:var(--radius-full);font-size:var(--font-size-xs);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;}.badge-tier1{background:#fee2e2;color:var(--color-tier1);}.badge-tier2{background:#fef3c7;color:var(--color-tier2);}.badge-tier3{background:#f3f4f6;color:var(--color-tier3);}.card-content{padding:var(--spacing-6);animation:fadeIn 0.3s ease-out;}.card-header::after{content:"â–¼";font-size:var(--font-size-sm);transition:transform var(--transition-fast);}.card.collapsed .card-header::after{transform:rotate(-90deg);}.axioms-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:var(--spacing-5);margin-top:var(--spacing-6);}.axiom-card{background:linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);border:2px solid var(--color-border);border-radius:var(--radius-lg);padding:var(--spacing-5);transition:all var(--transition-base);}.axiom-card:hover{border-color:var(--color-primary-light);box-shadow:var(--shadow-lg);transform:translateY(-4px);}.axiom-icon{font-size:var(--font-size-3xl);margin-bottom:var(--spacing-3);display:block;}.axiom-title{font-size:var(--font-size-lg);font-weight:600;color:var(--color-text-primary);margin-bottom:var(--spacing-3);}.axiom-content{font-size:var(--font-size-sm);color:var(--color-text-secondary);line-height:1.7;}.tier-list{display:flex;flex-direction:column;gap:var(--spacing-4);margin-top:var(--spacing-5);}.tier-item{display:flex;align-items:flex-start;gap:var(--spacing-4);padding:var(--spacing-4);background:var(--color-bg-secondary);border-radius:var(--radius-lg);border-left:4px solid;transition:all var(--transition-fast);}.tier-item.tier-1{border-left-color:var(--color-tier1);}.tier-item.tier-2{border-left-color:var(--color-tier2);}.tier-item.tier-3{border-left-color:var(--color-tier3);}.tier-item:hover{background:white;box-shadow:var(--shadow-sm);}.tier-badge-large{flex-shrink:0;padding:var(--spacing-2) var(--spacing-3);border-radius:var(--radius-md);font-size:var(--font-size-xs);font-weight:700;text-align:center;min-width:80px;}.tier-badge-large.tier-1{background:var(--color-tier1);color:white;}.tier-badge-large.tier-2{background:var(--color-tier2);color:white;}.tier-badge-large.tier-3{background:var(--color-tier3);color:white;}.tier-content h4{font-size:var(--font-size-base);font-weight:600;margin-bottom:var(--spacing-2);}.tier-content p{font-size:var(--font-size-sm);color:var(--color-text-secondary);margin-bottom:0;}.tier-1-section{border-left:4px solid var(--color-tier1) !important;position:relative;}.tier-1-section::before{content:'ğŸ”´ Tier 1 - ç”Ÿå­˜çº¢çº¿';position:absolute;top:10px;right:10px;background:var(--color-tier1);color:white;padding:4px 12px;border-radius:12px;font-size:0.75rem;font-weight:600;z-index:10;}.tier-1-section .card-header{background:linear-gradient(135deg, #fee 0%, #fff 100%) !important;}.alert{padding:var(--spacing-4) var(--spacing-5);border-radius:var(--radius-lg);border-left:4px solid;margin-bottom:var(--spacing-5);background:var(--color-bg-secondary);}.alert-info{border-left-color:var(--color-info);background:#eff6ff;}.alert-warning{border-left-color:var(--color-warning);background:#fffbeb;}.alert-danger{border-left-color:var(--color-danger);background:#fef2f2;}.alert-success{border-left-color:var(--color-success);background:#f0fdf4;}.alert h4{font-size:var(--font-size-base);font-weight:600;margin-bottom:var(--spacing-2);display:flex;align-items:center;gap:var(--spacing-2);}.alert p{font-size:var(--font-size-sm);margin-bottom:var(--spacing-2);}.alert ul{list-style:none;padding-left:0;}.alert li{padding-left:var(--spacing-5);position:relative;font-size:var(--font-size-sm);margin-bottom:var(--spacing-2);}.alert li::before{content:"â€¢";position:absolute;left:var(--spacing-3);font-weight:bold;}.table-container{overflow-x:auto;margin:var(--spacing-5) 0;border-radius:var(--radius-lg);border:1px solid var(--color-border);}table{width:100%;border-collapse:collapse;background:white;font-size:var(--font-size-sm);}thead{background:linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);}th{padding:var(--spacing-4);text-align:left;font-weight:600;color:var(--color-text-primary);border-bottom:2px solid var(--color-border);white-space:nowrap;}th.center, td.center{text-align:center;}td{padding:var(--spacing-4);border-bottom:1px solid var(--color-border-light);vertical-align:top;}tbody tr{transition:background-color var(--transition-fast);}tbody tr:hover{background-color:var(--color-bg-hover);}tbody tr:last-child td{border-bottom:none;}td.row-header{font-weight:600;background:var(--color-bg-tertiary);color:var(--color-text-primary);}tr.summary-row{background:linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);font-weight:600;}tr.summary-row td{padding:var(--spacing-5) var(--spacing-4);}input[type="text"], input[type="number"], input[type="time"], input[type="date"], textarea, select{width:100%;padding:var(--spacing-3);border:1px solid var(--color-border);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-family:var(--font-body);background:white;transition:all var(--transition-fast);}input[type="text"]:focus, input[type="number"]:focus, input[type="time"]:focus, input[type="date"]:focus, textarea:focus, select:focus{outline:none;border-color:var(--color-primary);box-shadow:0 0 0 3px rgba(37, 99, 235, 0.1);}textarea{resize:vertical;min-height:80px;font-family:var(--font-body);line-height:1.5;}input[type="checkbox"]{width:18px;height:18px;cursor:pointer;accent-color:var(--color-primary);}input[type="radio"]{width:18px;height:18px;cursor:pointer;accent-color:var(--color-primary);}label{font-size:var(--font-size-sm);font-weight:500;color:var(--color-text-primary);cursor:pointer;}.btn{display:inline-flex;align-items:center;justify-content:center;gap:var(--spacing-2);padding:var(--spacing-3) var(--spacing-5);border:none;border-radius:var(--radius-md);font-size:var(--font-size-sm);font-weight:600;font-family:var(--font-body);cursor:pointer;transition:all var(--transition-fast);text-decoration:none;}.btn-primary{background:linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);color:white;box-shadow:var(--shadow-sm);}.btn-primary:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);}.btn-secondary{background:var(--color-bg-tertiary);color:var(--color-text-primary);border:1px solid var(--color-border);}.btn-secondary:hover{background:var(--color-bg-secondary);border-color:var(--color-primary);}.btn-success{background:var(--color-success);color:white;}.btn-warning{background:var(--color-warning);color:white;}.btn-danger{background:var(--color-danger);color:white;}.score-display{display:inline-flex;align-items:center;gap:var(--spacing-2);padding:var(--spacing-2) var(--spacing-4);border-radius:var(--radius-full);font-weight:700;font-size:var(--font-size-lg);}.score-legend{background:linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);color:white;}.score-excellent{background:linear-gradient(135deg, #10b981 0%, #059669 100%);color:white;}.score-good{background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);color:white;}.score-normal{background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);color:white;}.score-poor{background:linear-gradient(135deg, #6b7280 0%, #4b5563 100%);color:white;}.grid-2{display:grid;grid-template-columns:repeat(2, 1fr);gap:var(--spacing-5);}.grid-3{display:grid;grid-template-columns:repeat(3, 1fr);gap:var(--spacing-5);}.grid-4{display:grid;grid-template-columns:repeat(4, 1fr);gap:var(--spacing-5);}.text-center{text-align:center;}.text-right{text-align:right;}.text-bold{font-weight:600;}.text-mono{font-family:var(--font-mono);}.mt-2{margin-top:var(--spacing-2);}.mt-4{margin-top:var(--spacing-4);}.mt-6{margin-top:var(--spacing-6);}.mb-2{margin-bottom:var(--spacing-2);}.mb-4{margin-bottom:var(--spacing-4);}.mb-6{margin-bottom:var(--spacing-6);}.text-primary{color:var(--color-primary);}.text-success{color:var(--color-success);}.text-warning{color:var(--color-warning);}.text-danger{color:var(--color-danger);}.text-muted{color:var(--color-text-muted);}.bg-primary{background-color:var(--color-primary);}.bg-success{background-color:var(--color-success);}.bg-warning{background-color:var(--color-warning);}.bg-danger{background-color:var(--color-danger);}.rules-container{margin:var(--spacing-5) 0;}.rules-section{background:var(--color-bg-secondary);border-radius:var(--radius-lg);border:1px solid var(--color-border);margin-bottom:var(--spacing-4);overflow:hidden;}.rules-header{padding:var(--spacing-3) var(--spacing-4);background:var(--color-bg-tertiary);border-bottom:1px solid var(--color-border);cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:var(--font-size-sm);}.rules-header:hover{background:var(--color-bg-hover);}.rules-header::after{content:"â–¼";font-size:var(--font-size-xs);transition:transform var(--transition-fast);}.rules-section.collapsed .rules-header::after{transform:rotate(-90deg);}.rules-content{padding:var(--spacing-4);font-size:var(--font-size-sm);color:var(--color-text-secondary);}.rules-content ul{padding-left:var(--spacing-5);margin-bottom:var(--spacing-3);}.rules-content li{margin-bottom:var(--spacing-2);}.mode-selector{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:var(--spacing-4);margin-top:var(--spacing-4);}.mode-card{background:white;border:2px solid var(--color-border);border-radius:var(--radius-lg);padding:var(--spacing-4);transition:all var(--transition-base);cursor:pointer;}.mode-card:hover{border-color:var(--color-primary-light);box-shadow:var(--shadow-md);transform:translateY(-2px);}.mode-card.selected{border-color:var(--color-primary);background:var(--color-bg-hover);}.mode-header{display:flex;align-items:center;gap:var(--spacing-2);margin-bottom:var(--spacing-3);}.mode-icon{font-size:var(--font-size-xl);}.mode-title{font-size:var(--font-size-lg);font-weight:600;color:var(--color-text-primary);}.mode-tag{padding:var(--spacing-1) var(--spacing-2);border-radius:var(--radius-full);font-size:var(--font-size-xs);font-weight:600;background:var(--color-bg-tertiary);color:var(--color-text-secondary);}.mode-description{font-size:var(--font-size-sm);color:var(--color-text-secondary);margin-bottom:var(--spacing-3);}.mode-target{padding:var(--spacing-2);background:var(--color-bg-tertiary);border-radius:var(--radius-md);font-size:var(--font-size-sm);font-family:var(--font-mono);}.mode-reminder{margin-top:var(--spacing-4);padding:var(--spacing-4);border-radius:var(--radius-lg);background:linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);border-left:4px solid var(--color-warning);animation:pulse 2s infinite;}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(245, 158, 11, 0.4);}70%{box-shadow:0 0 0 10px rgba(245, 158, 11, 0);}100%{box-shadow:0 0 0 0 rgba(245, 158, 11, 0);}}.visualization-section{margin-top:var(--spacing-6);padding:var(--spacing-5);background:white;border-radius:var(--radius-xl);border:1px solid var(--color-border);box-shadow:var(--shadow-sm);}.chart-container{position:relative;height:300px;width:100%;margin-bottom:var(--spacing-4);}.calendar-heatmap{margin-top:var(--spacing-4);padding:var(--spacing-4);background:var(--color-bg-tertiary);border-radius:var(--radius-lg);}.badges-container{display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:var(--spacing-4);padding:var(--spacing-2);}.badge-item{position:relative;background:var(--color-bg-tertiary);border-radius:var(--radius-lg);padding:var(--spacing-5);text-align:center;transition:all var(--transition-base);cursor:pointer;border:2px solid transparent;overflow:hidden;}.badge-item.locked{opacity:0.4;background:linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);filter:grayscale(1);border-color:#d1d5db !important;box-shadow:none !important;}.badge-item.locked .badge-icon{opacity:0.3;filter:blur(1px);}.badge-item.locked::before{content:'ğŸ”’';position:absolute;top:var(--spacing-2);right:var(--spacing-2);font-size:var(--font-size-lg);opacity:0.4;}.badge-item.unlocked{opacity:1;filter:grayscale(0);animation:badgeGlow 2s ease-in-out infinite;transform:scale(1);}.badge-item.unlocked .badge-icon{filter:drop-shadow(0 0 8px rgba(255,255,255,0.8));transform:scale(1.1);}.badge-item.unlocked.category-peak{background:linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);border-color:var(--color-tier1);box-shadow:0 0 20px rgba(239, 68, 68, 0.3);}.badge-item.unlocked.category-academic{background:linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);border-color:var(--color-excellent);box-shadow:0 0 20px rgba(16, 185, 129, 0.3);}.badge-item.unlocked.category-discipline{background:linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);border-color:var(--color-good);box-shadow:0 0 20px rgba(59, 130, 246, 0.3);}.badge-item.unlocked.category-language{background:linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(168, 85, 247, 0.05) 100%);border-color:var(--color-legend);box-shadow:0 0 20px rgba(168, 85, 247, 0.3);}.badge-item.unlocked.category-resilience{background:linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);border-color:var(--color-normal);box-shadow:0 0 20px rgba(245, 158, 11, 0.3);}@keyframes badgeGlow{0%, 100%{transform:scale(1);}50%{transform:scale(1.02);}}.badge-item:hover{transform:translateY(-4px) scale(1.05);}.badge-item.unlocked:hover{box-shadow:var(--shadow-xl);}.badge-icon{font-size:2.5rem;margin-bottom:var(--spacing-3);display:block;}.badge-name{font-size:var(--font-size-base);font-weight:600;color:var(--color-text-primary);margin-bottom:var(--spacing-2);}.badge-category{font-size:var(--font-size-xs);color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:var(--spacing-2);}.badge-description{font-size:var(--font-size-xs);color:var(--color-text-secondary);line-height:1.4;}.badge-progress{margin-top:var(--spacing-3);font-size:var(--font-size-xs);color:var(--color-text-muted);font-style:italic;}.report-container{padding:var(--spacing-5);background:white;border-radius:var(--radius-xl);border:1px solid var(--color-border);margin-top:var(--spacing-6);}.report-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--spacing-4);padding-bottom:var(--spacing-4);border-bottom:1px solid var(--color-border);}.mobile-optimized-table{font-size:var(--font-size-xs);}.mobile-optimized-table th, .mobile-optimized-table td{padding:var(--spacing-2);}.mobile-menu-button{display:none;position:fixed;bottom:20px;right:20px;z-index:var(--z-fixed);background:var(--color-primary);color:white;width:60px;height:60px;border-radius:50%;align-items:center;justify-content:center;box-shadow:var(--shadow-lg);font-size:var(--font-size-xl);}.writing-output-vertical{display:flex;flex-direction:column;gap:var(--spacing-2);}.writing-output-vertical-item{display:flex;align-items:center;gap:var(--spacing-2);}.writing-output-vertical-label{min-width:70px;font-size:var(--font-size-xs);font-weight:600;color:var(--color-text-secondary);}.writing-output-vertical-input{flex:1;min-width:120px;padding:var(--spacing-2);border:1px solid var(--color-border);border-radius:var(--radius-sm);font-size:var(--font-size-xs);text-align:center;}.task-column{min-width:300px !important;max-width:500px;vertical-align:top;}.task-column textarea{min-height:120px !important;resize:vertical;}.notes-column{min-width:400px !important;max-width:600px;vertical-align:top;}.data-processing-grid{display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:var(--spacing-4);margin-top:var(--spacing-4);}.data-processing-card{background:var(--color-bg-tertiary);border:1px solid var(--color-border);border-radius:var(--radius-lg);padding:var(--spacing-4);}.data-processing-card h4{margin-bottom:var(--spacing-3);color:var(--color-text-primary);display:flex;align-items:center;gap:var(--spacing-2);}.export-format-buttons{display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:var(--spacing-2);margin-top:var(--spacing-3);}.export-period-buttons{display:grid;grid-template-columns:repeat(4, 1fr);gap:var(--spacing-2);margin-top:var(--spacing-3);}.import-section{margin-top:var(--spacing-4);padding-top:var(--spacing-4);border-top:1px solid var(--color-border);}@media (max-width:1200px){.container{padding:var(--spacing-3);}.grid-2, .grid-3, .grid-4{grid-template-columns:1fr;}.header-content{flex-direction:column;align-items:center;}.date-selector{position:relative;right:auto;margin-top:var(--spacing-1);}.export-period-buttons{grid-template-columns:repeat(2, 1fr);}}@media (max-width:768px){html{font-size:14px;}.card-content{padding:var(--spacing-4);}.axioms-grid{grid-template-columns:1fr;}.table-container{font-size:var(--font-size-xs);}th, td{padding:var(--spacing-2);}.mode-selector{grid-template-columns:1fr;}.mobile-menu-button{display:flex;}.mobile-optimized-table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;}.card-header{padding:var(--spacing-3);}.btn-group-mobile{flex-direction:column;width:100%;}.btn-group-mobile .btn{width:100%;margin-bottom:var(--spacing-2);}.data-processing-grid{grid-template-columns:1fr;}.export-format-buttons{grid-template-columns:repeat(2, 1fr);}}@media (max-width:480px){.header-title h1{font-size:var(--font-size-xl);}.version-badge{font-size:var(--font-size-xs);}.card-title{font-size:var(--font-size-base);}.export-period-buttons{grid-template-columns:1fr;}}@media print{.no-print{display:none !important;}body{background:white;color:black;}.card{break-inside:avoid;box-shadow:none;border:1px solid #ccc;}.top-header{position:static;}.card-header{cursor:default;}.card-header::after{display:none;}.chart-container, .calendar-heatmap, .badges-container, .report-container, .visualization-section, .mobile-menu-button{display:none !important;}}@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}.fade-in{animation:fadeIn 0.5s ease-out;}.stagger-1{animation-delay:0.1s;}.stagger-2{animation-delay:0.2s;}.stagger-3{animation-delay:0.3s;}.stagger-4{animation-delay:0.4s;}.stagger-5{animation-delay:0.5s;}.writing-output-grid{display:grid;grid-template-columns:repeat(5, 1fr);gap:var(--spacing-2);margin-top:var(--spacing-1);}.writing-output-item{display:flex;flex-direction:column;}.writing-output-label{font-size:var(--font-size-xs);text-align:center;font-weight:600;margin-bottom:var(--spacing-1);color:var(--color-text-secondary);}.writing-output-input{width:100%;padding:var(--spacing-2);border:1px solid var(--color-border);border-radius:var(--radius-sm);font-size:var(--font-size-xs);text-align:center;}.status-select{min-width:100px;}.level-column{width:120px !important;}.history-date-picker{display:flex;align-items:center;gap:var(--spacing-2);margin-bottom:var(--spacing-4);}.export-buttons{display:flex;gap:var(--spacing-2);flex-wrap:wrap;margin-top:var(--spacing-4);}.exempt-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-top:1rem;}.exempt-col{background:#f8fafc;padding:1rem;border-radius:var(--radius-lg);border:1px solid var(--color-border);}@media (max-width:768px){.exempt-grid{grid-template-columns:1fr;}}#future-radar .card-content{padding:0;}.radar-controls{padding:var(--spacing-4);background:var(--color-bg-tertiary);border-bottom:1px solid var(--color-border);display:flex;gap:var(--spacing-2);flex-wrap:wrap;}.radar-section{border-bottom:1px solid var(--color-border);}.radar-section:last-child{border-bottom:none;}.radar-section-header{padding:var(--spacing-4);background:var(--color-bg-secondary);cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-weight:600;transition:background var(--transition-fast);}.radar-section-header:hover{background:var(--color-bg-hover);}.radar-section-header::after{content:"â–¼";font-size:0.8em;transition:transform 0.3s;color:var(--color-text-muted);}.radar-section.collapsed .radar-section-header::after{transform:rotate(-90deg);}.radar-section.collapsed .radar-list{display:none;}.radar-list{padding:var(--spacing-2);background:var(--color-bg-primary);max-height:500px;overflow-y:auto;animation:fadeIn 0.3s ease;}.event-item{display:flex;gap:var(--spacing-3);padding:var(--spacing-3);border-radius:var(--radius-md);border:1px solid transparent;transition:all 0.2s;position:relative;}.event-item:hover{background:var(--color-bg-hover);border-color:var(--color-primary-light);transform:translateX(4px);}.event-date-box{display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:60px;padding:4px;background:var(--color-bg-tertiary);border-radius:8px;border:1px solid var(--color-border);}.event-days-left{font-size:1.2rem;font-weight:800;color:var(--color-primary);line-height:1;}.event-days-label{font-size:0.7rem;color:var(--color-text-muted);}.event-details{flex:1;}.event-title{font-weight:600;color:var(--color-text-primary);display:flex;align-items:center;gap:6px;}.event-meta{font-size:0.85rem;color:var(--color-text-secondary);margin-top:4px;display:flex;gap:10px;align-items:center;}.event-tag{font-size:0.75rem;padding:1px 6px;border-radius:4px;background:#eee;color:#555;}.tag-urgent{background:#fee2e2;color:#dc2626;}.tag-birthday{background:#fef3c7;color:#d97706;}.event-actions{opacity:0;transition:opacity 0.2s;display:flex;align-items:center;}.event-item:hover .event-actions{opacity:1;}.delete-btn{color:var(--color-text-muted);cursor:pointer;padding:4px;}.delete-btn:hover{color:var(--color-danger);}#json-import-area{width:100%;height:150px;font-family:monospace;font-size:12px;padding:10px;border:1px solid var(--color-border);border-radius:8px;margin-bottom:10px;}.event-type-tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:2px solid var(--color-border);padding-bottom:8px}.event-tab{padding:8px 16px;background:0 0;border:none;border-bottom:2px solid transparent;cursor:pointer;font-weight:500;color:var(--color-text-secondary);transition:all .15s;margin-bottom:-2px}.event-tab:hover{color:var(--color-primary)}.event-tab.active{color:var(--color-primary);border-bottom-color:var(--color-primary)}.event-container{display:none}.event-container.active{display:block}.event-item{background:var(--color-bg-primary);border:1px solid var(--color-border);border-radius:8px;margin-bottom:12px;overflow:hidden;transition:all .15s}.event-item:hover{box-shadow:var(--shadow-md);border-color:var(--color-primary)}.event-item-header{padding:12px 16px;background:var(--color-bg-secondary);cursor:pointer;display:flex;justify-content:space-between;align-items:center;user-select:none}.event-item-header:hover{background:var(--color-bg-hover)}.event-item-title{display:flex;align-items:center;gap:8px;flex:1}.event-item-title .event-name{font-weight:600;color:var(--color-text-primary)}.event-item-title .event-time{color:var(--color-text-muted);font-size:14px;margin-left:8px}.event-status-badge{padding:2px 8px;border-radius:4px;font-size:12px;font-weight:600}.event-status-upcoming{background:#dbeafe;color:#1e40af}.event-status-today{background:#fef3c7;color:#92400e}.event-collapse-icon{transition:transform .25s;color:var(--color-text-muted)}.event-item-header.collapsed .event-collapse-icon{transform:rotate(-90deg)}.event-item-content{padding:16px;max-height:500px;overflow:hidden;transition:all .35s}.event-item-content.collapsed{max-height:0;padding-top:0;padding-bottom:0}.event-field{display:grid;grid-template-columns:120px 1fr;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--color-border-light)}.event-field:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}.event-field-label{font-weight:600;color:var(--color-text-secondary);font-size:14px}.add-event-form{background:var(--color-bg-secondary);padding:16px;border-radius:12px;margin-bottom:16px}.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:16px}.calendar-type-switch{display:flex;gap:8px;margin-bottom:12px}.calendar-type-btn{padding:8px 12px;border:1px solid var(--color-border);background:var(--color-bg-primary);border-radius:8px;cursor:pointer;transition:all .15s;font-size:14px}.calendar-type-btn:hover{border-color:var(--color-primary)}.calendar-type-btn.active{background:var(--color-primary);color:#fff;border-color:var(--color-primary)}.sync-status.sync-status@media (max-width:768px){.event-field{grid-template-columns:1fr;gap:4px}.form-row{grid-template-columns:1fr}.event-item-header{flex-direction:column;align-items:flex-start;gap:8px}}.timeline-container{position:relative;padding-left:40px;}.timeline-item{position:relative;margin-bottom:30px;padding-bottom:20px;}.timeline-item:not(:last-child):before{content:'';position:absolute;left:-25px;top:35px;width:2px;height:calc(100% - 15px);background:linear-gradient(180deg, var(--color-border) 0%, transparent 100%);}.timeline-badge{position:absolute;left:-40px;top:0;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}.timeline-content{background:var(--color-bg-secondary);padding:var(--spacing-4);border-radius:var(--radius-lg);border-left:3px solid var(--color-primary);}.timeline-content h4{margin-top:0;margin-bottom:var(--spacing-2);color:var(--color-primary);}
  </style>
  <!-- ========== å¢å¼ºå¯¼èˆªç³»ç»Ÿæ ·å¼ ç¬¬ 20 ç‰ˆ ========== -->
  <style>
   /* è¡¥å…¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
     .quick-nav-container-v19{position:fixed;top:calc(10px + env(safe-area-inset-top, 0px));left:0;right:0;z-index:9999;display:flex;justify-content:center;pointer-events:none;padding:0 10px;}.quick-nav-v19{background:rgba(255, 255, 255, 0.98);border-radius:20px;padding:10px 15px;box-shadow:0 10px 40px rgba(0,0,0,0.15);display:flex;gap:8px;flex-wrap:wrap;max-width:95vw;border:2px solid #e2e8f0;backdrop-filter:blur(20px) saturate(180%);pointer-events:auto;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);justify-content:center;align-items:center;}body.dark-mode .quick-nav-v19{background:rgba(30, 41, 59, 0.98);border-color:#334155;}.quick-nav-v19.hidden{transform:translateY(-150%);opacity:0;}.quick-nav-btn-v19{padding:10px 16px;background:linear-gradient(135deg, #2563eb, #1d4ed8);color:white;border:none;border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s ease;white-space:nowrap;box-shadow:0 2px 8px rgba(37, 99, 235, 0.25);position:relative;overflow:hidden;display:inline-flex;align-items:center;gap:6px;-webkit-tap-highlight-color:transparent;touch-action:manipulation;user-select:none;}.quick-nav-btn-v19::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);transition:left 0.5s;}.quick-nav-btn-v19:hover::before{left:100%;}.quick-nav-btn-v19:hover{transform:translateX(-5px);box-shadow:2px 2px 8px rgba(0,0,0,0.2);}.quick-nav-btn-v19.active-section{background:#ffffff !important;color:#2563eb !important;border:2px solid #2563eb !important;box-shadow:0 0 15px rgba(37, 99, 235, 0.4);transform:scale(1.1);font-weight:800;}.event-item.radar-urgent{border-left:5px solid #ef4444 !important;background:#fff1f2;}.event-item.radar-warning{border-left:5px solid #f59e0b !important;background:#fffbeb;}.event-item.radar-safe{border-left:5px solid #10b981 !important;}.quick-nav-btn-v19:active{transform:translateY(-1px) scale(0.98);}.quick-nav-btn-v19.btn-success{background:linear-gradient(135deg, #10b981, #059669);box-shadow:0 2px 8px rgba(16, 185, 129, 0.25);}.quick-nav-btn-v19.btn-success:hover{box-shadow:0 6px 16px rgba(16, 185, 129, 0.4);}.quick-nav-btn-v19.btn-warning{background:linear-gradient(135deg, #f59e0b, #d97706);box-shadow:0 2px 8px rgba(245, 158, 11, 0.25);}.quick-nav-btn-v19.btn-info{background:linear-gradient(135deg, #06b6d4, #0891b2);box-shadow:0 2px 8px rgba(6, 182, 212, 0.25);}.quick-nav-btn-v19.btn-secondary{background:linear-gradient(135deg, #64748b, #475569);box-shadow:0 2px 8px rgba(100, 116, 139, 0.25);}.quick-nav-btn-v19.important::after{content:'â­';position:absolute;top:-8px;right:-8px;font-size:16px;animation:starPulse 2s ease-in-out infinite;}@keyframes starPulse{0%, 100%{transform:scale(1);opacity:1;}50%{transform:scale(1.2);opacity:0.8;}}.quick-nav-toggle-ç¬¬18ç‰ˆ{position:fixed;top:calc(10px + env(safe-area-inset-top, 0px));right:calc(10px + env(safe-area-inset-right, 0px));width:56px;height:56px;background:linear-gradient(135deg, #2563eb, #1d4ed8);color:white;border:none;border-radius:50%;font-size:24px;cursor:pointer;z-index:10000;box-shadow:0 10px 40px rgba(0,0,0,0.15);display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;-webkit-tap-highlight-color:transparent;}.quick-nav-toggle-ç¬¬18ç‰ˆ:hover{transform:scale(1.1) rotate(90deg);box-shadow:0 10px 40px rgba(37, 99, 235, 0.4);}@media (max-width:768px){.quick-nav-container-v19{top:auto;bottom:calc(10px + env(safe-area-inset-bottom, 0px));}.quick-nav-v19{padding:12px 10px;gap:6px;border-radius:24px;max-height:50vh;overflow-y:auto;-webkit-overflow-scrolling:touch;}.quick-nav-btn-v19{font-size:11px;padding:10px 12px;border-radius:10px;}.quick-nav-btn-v19.important::after{font-size:12px;top:-6px;right:-6px;}.quick-nav-toggle-ç¬¬18ç‰ˆ{top:auto;bottom:calc(10px + env(safe-area-inset-bottom, 0px));right:calc(10px + env(safe-area-inset-right, 0px));width:48px;height:48px;font-size:20px;}}@media (display-mode:standalone){.pwa-indicator-v19{position:fixed;top:calc(5px + env(safe-area-inset-top, 0px));left:calc(5px + env(safe-area-inset-left, 0px));padding:6px 12px;background:linear-gradient(135deg, #10b981, #059669);color:white;border-radius:10px;font-size:11px;font-weight:700;z-index:9998;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:flex;align-items:center;gap:6px;}}@media print{.quick-nav-container-v19, .quick-nav-toggle-ç¬¬18ç‰ˆ, .back-to-top-v19, .pwa-indicator-v19{display:none !important;}}
  </style>
  <!-- ========== å¢å¼ºå¯¼èˆªç³»ç»Ÿæ ·å¼ç»“æŸ ========== -->
  <!-- å¿…éœ€çš„ç¬¬ä¸‰æ–¹åº“ CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js">
  </script>
  <script>
   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã€å…³é”®ã€‘æ—©æœŸåˆå§‹åŒ–ï¼šå¯¼å‡ºå’Œäº‘ç«¯åŠ è½½å‡½æ•°
// å¿…é¡»åœ¨HTML bodyåŠ è½½å‰å®šä¹‰ï¼Œä»¥é¿å…æŒ‰é’®onclickæ—¶å‡½æ•°æœªå®šä¹‰çš„é”™è¯¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

console.log('ğŸš€ [æ—©æœŸåˆå§‹åŒ–] å¼€å§‹å®šä¹‰å…³é”®å‡½æ•°...');

// 0. ä¸º UndoRedoManager åˆ›å»ºå ä½å¯¹è±¡ï¼ˆé˜²æ­¢å‡½æ•°è°ƒç”¨æ—¶æœªå®šä¹‰ï¼‰
if (!window.UndoRedoManager) {
    window.UndoRedoManager = {
        initialized: false,
        undo: function() {
            console.warn('âš ï¸ UndoRedoManager å°šæœªå®Œå…¨åˆå§‹åŒ–');
            alert('âš ï¸ æ’¤é”€ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ä¸­\n\nè¯·ç¨ç­‰ç‰‡åˆ»åé‡è¯•\n\næˆ–åˆ·æ–°é¡µé¢');
        },
        redo: function() {
            console.warn('âš ï¸ UndoRedoManager å°šæœªå®Œå…¨åˆå§‹åŒ–');
            alert('âš ï¸ é‡åšç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–ä¸­\n\nè¯·ç¨ç­‰ç‰‡åˆ»åé‡è¯•\n\næˆ–åˆ·æ–°é¡µé¢');
        }
    };
    console.log('âœ… [æ—©æœŸåˆå§‹åŒ–] åˆ›å»º UndoRedoManager å ä½å¯¹è±¡');
}

// 0. å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†å‡½æ•°ï¼ˆæœ€ä¼˜å…ˆå®šä¹‰ï¼‰
window.closeAllModals = function() {
    console.log('ğŸ”„ [closeAllModals] å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†');
    try {
        const modals = document.querySelectorAll('.modal-overlay, [style*="position: fixed"][style*="z-index"]');
        let closedCount = 0;
        modals.forEach(modal => {
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ¨¡æ€æ¡†ï¼ˆæ ¹æ®æ ·å¼åˆ¤æ–­ï¼‰
            const style = window.getComputedStyle(modal);
            if (style.position === 'fixed' && parseInt(style.zIndex) > 1000) {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                    closedCount++;
                }
            }
        });
        console.log('âœ… [closeAllModals] å·²å…³é—­', closedCount, 'ä¸ªæ¨¡æ€æ¡†');
    } catch (error) {
        console.error('âŒ [closeAllModals] å…³é—­å¤±è´¥:', error);
    }
};

// 0.1 å‰å¾€äº‘ç«¯åŒæ­¥è®¾ç½®
window.goToCloudSync = function() {
    console.log('ğŸ”„ [goToCloudSync] å‰å¾€äº‘ç«¯åŒæ­¥è®¾ç½®');
    try {
        window.closeAllModals();
        sessionStorage.setItem('tpi_mobile_prompt_shown', 'true');
        
        // æ»šåŠ¨åˆ°äº‘ç«¯åŒæ­¥åŒºåŸŸ
        const syncSection = document.querySelector('h3[style*="äº‘ç«¯åŒæ­¥"]') || 
                          document.querySelector('[id*="cloud"]') ||
                          document.querySelector('[id*="firebase"]');
        
        if (syncSection) {
            syncSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // é«˜äº®æ˜¾ç¤º
            setTimeout(() => {
                syncSection.style.backgroundColor = '#fef3c7';
                syncSection.style.padding = '10px';
                syncSection.style.borderRadius = '8px';
                syncSection.style.transition = 'all 0.3s';
                
                setTimeout(() => {
                    syncSection.style.backgroundColor = '';
                }, 2000);
            }, 500);
            
            console.log('âœ… [goToCloudSync] å·²æ»šåŠ¨åˆ°äº‘ç«¯åŒæ­¥åŒºåŸŸ');
        } else {
            console.warn('âš ï¸ [goToCloudSync] æœªæ‰¾åˆ°äº‘ç«¯åŒæ­¥åŒºåŸŸ');
            
        }
    } catch (error) {
        console.error('âŒ [goToCloudSync] è·³è½¬å¤±è´¥:', error);
    }
};

// 0.2 å¯ç”¨ç§»åŠ¨ç«¯æç¤º
window.enableMobileTips = function() {
    console.log('ğŸ“± [enableMobileTips] å¯ç”¨ç§»åŠ¨ç«¯æç¤º');
    try {
        localStorage.setItem('tpi_mobile_tips_enabled', 'true');
        window.closeAllModals();
        sessionStorage.setItem('tpi_mobile_prompt_shown', 'true');
        
        // å¦‚æœMobileOptimizerå·²å®šä¹‰ï¼Œè°ƒç”¨å…¶æ–¹æ³•
        if (window.MobileOptimizer && typeof window.MobileOptimizer.showMobileTipsBanner === 'function') {
            window.MobileOptimizer.showMobileTipsBanner();
        }
        
        console.log('âœ… [enableMobileTips] ç§»åŠ¨ç«¯æç¤ºå·²å¯ç”¨');
        alert('âœ… ç§»åŠ¨ç«¯æç¤ºå·²å¯ç”¨\n\næ‚¨å°†çœ‹åˆ°ç§»åŠ¨ç«¯ä½¿ç”¨æç¤ºæ¨ªå¹…');
    } catch (error) {
        console.error('âŒ [enableMobileTips] å¯ç”¨å¤±è´¥:', error);
    }
};

// 1. å¯¼å‡ºæŠ¥å‘Šå‡½æ•°ï¼ˆPDF/Excelï¼‰
window.exportReportComplete = function(format) {
    console.log('ğŸ“¤ [exportReportComplete] è¢«è°ƒç”¨, æ ¼å¼:', format);
    console.log('ğŸ“¤ [exportReportComplete] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
    
    try {
        const reportContent = document.getElementById('advancedReportPreview') || document.getElementById('reportContent');
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æŠ¥å‘Šå†…å®¹
        if (!reportContent || !reportContent.innerHTML.trim()) {
            console.warn('âš ï¸ [exportReportComplete] æŠ¥å‘Šå†…å®¹ä¸ºç©º');
            alert('âš ï¸ è¯·å…ˆç”ŸæˆæŠ¥å‘Šå†…å®¹\n\nç‚¹å‡»"ç”Ÿæˆå‘¨æŠ¥"æˆ–"ç”ŸæˆæœˆæŠ¥"æŒ‰é’®ç”ŸæˆæŠ¥å‘Šåå†å¯¼å‡º');
            return;
        }
        
        console.log('âœ… [exportReportComplete] æŠ¥å‘Šå†…å®¹å­˜åœ¨ï¼Œå‡†å¤‡å¯¼å‡º');
        
        if (format === 'pdf') {
            console.log('ğŸ“„ [exportReportComplete] å‡†å¤‡å¯¼å‡ºPDF');
            
            // åˆ›å»ºä¸´æ—¶æ‰“å°çª—å£
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                console.error('âŒ [exportReportComplete] æ— æ³•æ‰“å¼€æ‰“å°çª—å£');
                alert('âŒ æ— æ³•æ‰“å¼€æ‰“å°çª—å£\n\nè¯·å…è®¸å¼¹å‡ºçª—å£åé‡è¯•');
                return;
            }
            
            console.log('âœ… [exportReportComplete] æ‰“å°çª—å£å·²æ‰“å¼€');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>TPIæŠ¥å‘Š - ${new Date().toISOString().split('T')[0]}</title>
                    <style>
    /* è¡¥å…¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
    
                        body{font-family:Arial, sans-serif;padding:20px;max-width:800px;margin:0 auto;}
                        h1, h2, h3{color:#2563eb;}
                        table{width:100%;border-collapse:collapse;margin:20px 0;}
                        th, td{border:1px solid #ddd;padding:8px;text-align:left;}
                        th{background-color:#f3f4f6;}
                        @media print{body{padding:10mm;}}
                    </style>
                
<style id="data-workshop-layout-patch">
/* ===== Data Workshop layout patch (DOM only, no button/function changes) ===== */
#data-processing .data-workshop-layout{display:flex;flex-direction:column;gap:16px}
#data-processing .data-workshop-top{display:grid;grid-template-columns:1.1fr 1.4fr;gap:16px;align-items:start}
#data-processing .data-workshop-top-left{display:flex;flex-direction:column;gap:16px}
#data-processing .data-workshop-top-right{display:flex;flex-direction:column;gap:16px}
#data-processing .data-workshop-bottom{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;align-items:start}
@media (max-width: 980px){
  #data-processing .data-workshop-top{grid-template-columns:1fr}
  #data-processing .data-workshop-bottom{grid-template-columns:1fr}
}
</style>

</head>
                <body>
                    ${reportContent.innerHTML}
                

`);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                console.log('âœ… [exportReportComplete] PDFæ‰“å°å¯¹è¯æ¡†å·²æ‰“å¼€');
            }, 500);
            
            alert('ğŸ’¡ PDFå¯¼å‡ºæç¤º\n\nåœ¨æ‰“å°å¯¹è¯æ¡†ä¸­ï¼š\n1. é€‰æ‹©"å¦å­˜ä¸ºPDF"\n2. ç‚¹å‡»"ä¿å­˜"æŒ‰é’®\n\nå³å¯å°†æŠ¥å‘Šä¿å­˜ä¸ºPDFæ–‡ä»¶');
            
        } else if (format === 'excel') {
            console.log('ğŸ“Š [exportReportComplete] å‡†å¤‡å¯¼å‡ºExcel');
            
            try {
                // æå–æŠ¥å‘Šæ•°æ®
                const dateStr = document.getElementById('date-input')?.value || new Date().toISOString().split('T')[0];
                const dataStr = localStorage.getItem('tpi_data_' + dateStr);
                
                if (!dataStr) {
                    console.warn('âš ï¸ [exportReportComplete] æœªæ‰¾åˆ°æ—¥æœŸæ•°æ®:', dateStr);
                    alert('âš ï¸ æœªæ‰¾åˆ°å½“å‰æ—¥æœŸçš„æ•°æ®\n\næ—¥æœŸ: ' + dateStr);
                    return;
                }
                
                const data = JSON.parse(dataStr);
                console.log('âœ… [exportReportComplete] æ•°æ®å·²åŠ è½½');
                
                const exportTime = new Date();
                const exportTimeStr = `${exportTime.getFullYear()}-${String(exportTime.getMonth() + 1).padStart(2, '0')}-${String(exportTime.getDate()).padStart(2, '0')} ${String(exportTime.getHours()).padStart(2, '0')}:${String(exportTime.getMinutes()).padStart(2, '0')}`;
                
                // åˆ›å»ºCSVå†…å®¹
                let csv = 'TPIæ•ˆèƒ½æŠ¥å‘Š\n\n';
                csv += 'æ•°æ®æ—¥æœŸ,' + dateStr + '\n';
                csv += 'å¯¼å‡ºæ—¶é—´,' + exportTimeStr + '\n\n';
                csv += 'æ ¸å¿ƒæŒ‡æ ‡,åˆ†æ•°\n';
                csv += 'TPIæ€»åˆ†,' + (data.tpi || 0) + '\n';
                csv += 'AMI (å­¦ä¸šæ•ˆèƒ½),' + (data.ami || 0) + '\n';
                csv += 'BCM (åŸºçŸ³å¼ºåº¦),' + (data.bcm || 0) + '\n';
                csv += 'Logistics (äº‹åŠ¡æ•ˆèƒ½),' + (data.logistics || 0) + '\n';
                csv += 'HSM (å¥åº·çŠ¶æ€),' + (data.hsm || 0) + '\n';
                csv += 'BONUS (åŠ åˆ†é¡¹),' + (data.bonus || 0) + '\n\n';
                
                csv += 'å­¦ä¹ ç»´åº¦,\n';
                csv += 'å­¦ä¹ æ—¶é•¿(å°æ—¶),' + (data.studyHours || 0) + '\n';
                csv += 'è®ºæ–‡é˜…è¯»(ç¯‡),' + (data.papersRead || 0) + '\n';
                csv += 'ä»£ç é‡(è¡Œ),' + (data.codeLines || 0) + '\n';
                csv += 'å­¦ä¹ ä¸“æ³¨åº¦(åˆ†),' + (data.studyFocus || 0) + '\n\n';
                
                csv += 'åŸºçŸ³ä¹ æƒ¯,\n';
                csv += 'è¿åŠ¨æ—¶é•¿(åˆ†é’Ÿ),' + (data.exerciseMinutes || 0) + '\n';
                csv += 'æ­¥æ•°(æ­¥),' + (data.steps || 0) + '\n';
                csv += 'ç¡çœ æ—¶é•¿(å°æ—¶),' + (data.sleepHours || 0) + '\n';
                csv += 'ç¡çœ è´¨é‡(åˆ†),' + (data.sleepQuality || 0) + '\n\n';
                
                csv += 'åå‹¤äº‹åŠ¡,\n';
                csv += 'æ´—è¡£,' + (data.laundry ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ') + '\n';
                csv += 'æˆ¿é—´æ•´ç†,' + (data.roomCleaning ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ') + '\n';
                csv += 'è´­ç‰©é‡‡ä¹°,' + (data.shopping ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ') + '\n';
                csv += 'å…¶ä»–äº‹åŠ¡,' + (data.otherChores ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ') + '\n\n';
                
                csv += 'å¥åº·çŠ¶æ€,\n';
                csv += 'èº«ä½“çŠ¶æ€(åˆ†),' + (data.physicalHealth || 0) + '\n';
                csv += 'å¿ƒç†çŠ¶æ€(åˆ†),' + (data.mentalHealth || 0) + '\n';
                csv += 'ç²¾åŠ›æ°´å¹³(åˆ†),' + (data.energyLevel || 0) + '\n\n';
                
                csv += 'åŠ åˆ†é¡¹,\n';
                csv += 'ç¤¾äº¤æ´»åŠ¨(åˆ†),' + (data.socialBonus || 0) + '\n';
                csv += 'åˆ›æ–°çªç ´(åˆ†),' + (data.innovationBonus || 0) + '\n';
                csv += 'å…¶ä»–åŠ åˆ†(åˆ†),' + (data.otherBonus || 0) + '\n';
                
                // æ·»åŠ BOMä»¥æ”¯æŒä¸­æ–‡
                const BOM = '\uFEFF';
                const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `TPIæŠ¥å‘Š_${dateStr}.csv`;
                link.click();
                URL.revokeObjectURL(url);
                
                console.log('âœ… [exportReportComplete] Excelå¯¼å‡ºæˆåŠŸ');
                alert('âœ… Excel(CSV)å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶å: TPIæŠ¥å‘Š_' + dateStr + '.csv\n\nå¯ç”¨Excelæˆ–WPSç›´æ¥æ‰“å¼€');
            } catch (error) {
                console.error('âŒ [exportReportComplete] Excelå¯¼å‡ºå¤±è´¥:', error);
                alert('âŒ Excelå¯¼å‡ºå¤±è´¥\n\né”™è¯¯: ' + error.message);
            }
        }
    } catch (error) {
        console.error('âŒ [exportReportComplete] å¯¼å‡ºå¤±è´¥:', error);
        console.error('âŒ [exportReportComplete] é”™è¯¯å †æ ˆ:', error.stack);
        alert('âŒ å¯¼å‡ºå¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message + '\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯');
    }
};

// 2. ä»äº‘ç«¯åŠ è½½å‡½æ•° - ç°åœ¨ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥
window.loadFromCloudComplete = function() {
    console.log('ğŸ”µ [loadFromCloudComplete] ä»äº‘ç«¯åŠ è½½åŠŸèƒ½è¢«è°ƒç”¨');
    console.log('ğŸ”µ [loadFromCloudComplete] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
    
    try {
        // Firebaseå·²ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥
        console.log('ğŸ” [loadFromCloudComplete] ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥æ–¹å¼');
        
        // æ£€æŸ¥GitHubåŠ è½½å‡½æ•°æ˜¯å¦å¯ç”¨
        if (window.loadFromGitHub && typeof window.loadFromGitHub === 'function') {
            console.log('âœ… [loadFromCloudComplete] è°ƒç”¨GitHubåŠ è½½åŠŸèƒ½');
            window.loadFromGitHub();
        } else {
            console.warn('âš ï¸ [loadFromCloudComplete] GitHubåŠ è½½åŠŸèƒ½æœªåˆå§‹åŒ–');
            alert('âš ï¸ GitHubäº‘ç«¯åŒæ­¥åŠŸèƒ½åˆå§‹åŒ–ä¸­\n\nè¯·ç¨ç­‰ç‰‡åˆ»åé‡è¯•\n\nå¦‚æœæŒç»­å‡ºç°æ­¤é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢');
        }
    } catch (error) {
        console.error('âŒ [loadFromCloudComplete] ä»äº‘ç«¯åŠ è½½å¤±è´¥:', error);
        console.error('âŒ [loadFromCloudComplete] é”™è¯¯å †æ ˆ:', error.stack);
        alert('âŒ åŠ è½½å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message + '\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯');
    }
};

// 3. å¤‡ä»½ç®¡ç†å‡½æ•°
window.openBackupManagerComplete = function() {
    console.log('ğŸ’¾ [openBackupManagerComplete] è¢«è°ƒç”¨');
    console.log('ğŸ’¾ [openBackupManagerComplete] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
    
    try {
        // åˆ›å»ºå¤‡ä»½ç®¡ç†å™¨å¯¹è¯æ¡†
        const backupKeys = [];
        
        console.log('ğŸ” [openBackupManagerComplete] å¼€å§‹æ‰«æå¤‡ä»½...');
        
        // ä» localStorage è·å–æ‰€æœ‰å¤‡ä»½
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('tpi_backup_')) {
                backupKeys.push(key);
            }
        }
        
        console.log('ğŸ“Š [openBackupManagerComplete] æ‰¾åˆ°', backupKeys.length, 'ä¸ªå¤‡ä»½');
        
        // æŒ‰æ—¶é—´å€’åºæ’åˆ—
        backupKeys.sort().reverse();
        
        // åˆ›å»ºå¤‡ä»½åˆ—è¡¨HTML
        let backupListHtml = '';
        if (backupKeys.length === 0) {
            backupListHtml = '<p style="text-align: center; color: #6b7280; padding: 20px;">æš‚æ— å¤‡ä»½è®°å½•</p>';
        } else {
            backupListHtml = '<div style="max-height: 300px; overflow-y: auto;">';
            backupKeys.forEach((key, index) => {
                try {
                    const backupData = JSON.parse(localStorage.getItem(key));
                    const backupTime = key.replace('tpi_backup_', '').replace(/_/g, ' ');
                    const dataSize = new Blob([localStorage.getItem(key)]).size;
                    const sizeKB = (dataSize / 1024).toFixed(2);
                    
                    backupListHtml += `
                        <div style="padding: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>å¤‡ä»½ #${backupKeys.length - index}</strong>
                                    <br>
                                    <small style="color: #6b7280;">æ—¶é—´: ${backupTime}</small>
                                    <br>
                                    <small style="color: #6b7280;">å¤§å°: ${sizeKB} KB</small>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-sm btn-primary" onclick="restoreBackup('${key}'); document.getElementById('backup-manager-modal').remove();" style="font-size: 12px; padding: 4px 8px;">ğŸ“¥ æ¢å¤</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBackup('${key}'); window.openBackupManagerComplete();" style="font-size: 12px; padding: 4px 8px;">ğŸ—‘ï¸ åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error('âŒ [openBackupManagerComplete] è¯»å–å¤‡ä»½å¤±è´¥:', e);
                }
            });
            backupListHtml += '</div>';
        }
        
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modalHtml = `
            <div id="backup-manager-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                    <h3 style="margin-bottom: 20px; color: #111827;">ğŸ’¾ å¤‡ä»½ç®¡ç†å™¨</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="createNewBackup(); window.openBackupManagerComplete();" style="width: 100%;">
                            â• åˆ›å»ºæ–°å¤‡ä»½
                        </button>
                    </div>
                    
                    <h4 style="margin-bottom: 12px; font-size: 16px; color: #374151;">å¤‡ä»½å†å²</h4>
                    ${backupListHtml}
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <button class="btn btn-secondary" onclick="document.getElementById('backup-manager-modal').remove();" style="width: 100%;">å…³é—­</button>
                    </div>
                </div>
            </div>
        `;
        
        // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const oldModal = document.getElementById('backup-manager-modal');
        if (oldModal) {
            console.log('ğŸ”„ [openBackupManagerComplete] ç§»é™¤æ—§çš„æ¨¡æ€æ¡†');
            oldModal.remove();
        }
        
        // æ·»åŠ æ–°æ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.innerHTML = modalHtml;
        document.body.appendChild(modal.firstElementChild);
        
        console.log('âœ… [openBackupManagerComplete] å¤‡ä»½ç®¡ç†å™¨å·²æ‰“å¼€');
        
    } catch (error) {
        console.error('âŒ [openBackupManagerComplete] æ‰“å¼€å¤±è´¥:', error);
        console.error('âŒ [openBackupManagerComplete] é”™è¯¯å †æ ˆ:', error.stack);
        alert('âŒ æ‰“å¼€å¤‡ä»½ç®¡ç†å™¨å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message + '\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯');
    }
};

// 4. åˆ›å»ºæ–°å¤‡ä»½å‡½æ•°
window.createNewBackup = function() {
    console.log('ğŸ’¾ [createNewBackup] è¢«è°ƒç”¨');
    console.log('ğŸ’¾ [createNewBackup] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
    
    try {
        const now = new Date();
        const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const backupKey = `tpi_backup_${timestamp}`;
        
        console.log('ğŸ” [createNewBackup] å¼€å§‹æ”¶é›†æ•°æ®...');
        
        // æ”¶é›†æ‰€æœ‰æ•°æ®
        const allData = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && (key.startsWith('tpi_data_') || key.startsWith('tpi_'))) {
                allData[key] = localStorage.getItem(key);
            }
        }
        
        console.log('ğŸ“Š [createNewBackup] æ”¶é›†åˆ°', Object.keys(allData).length, 'æ¡æ•°æ®');
        
        // ä¿å­˜å¤‡ä»½
        localStorage.setItem(backupKey, JSON.stringify(allData));
        
        console.log('âœ… [createNewBackup] å¤‡ä»½åˆ›å»ºæˆåŠŸ');
        
        alert(`âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸï¼\n\nå¤‡ä»½æ—¶é—´: ${now.toLocaleString('zh-CN')}\næ•°æ®é¡¹: ${Object.keys(allData).length} æ¡`);
    } catch (error) {
        console.error('âŒ [createNewBackup] åˆ›å»ºå¤±è´¥:', error);
        console.error('âŒ [createNewBackup] é”™è¯¯å †æ ˆ:', error.stack);
        alert('âŒ åˆ›å»ºå¤‡ä»½å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
    }
};

// 5. æ¢å¤å¤‡ä»½å‡½æ•°
window.restoreBackup = function(backupKey) {
    console.log('ğŸ“¥ [restoreBackup] è¢«è°ƒç”¨');
    console.log('ğŸ“¥ [restoreBackup] å¤‡ä»½é”®:', backupKey);
    console.log('ğŸ“¥ [restoreBackup] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
    
    try {
        if (!confirm('âš ï¸ ç¡®å®šè¦æ¢å¤æ­¤å¤‡ä»½å—ï¼Ÿ\n\nå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼')) {
            console.log('âŒ [restoreBackup] ç”¨æˆ·å–æ¶ˆæ“ä½œ');
            return;
        }
        
        console.log('ğŸ” [restoreBackup] å¼€å§‹è¯»å–å¤‡ä»½æ•°æ®...');
        
        const backupData = JSON.parse(localStorage.getItem(backupKey));
        if (!backupData) {
            console.error('âŒ [restoreBackup] å¤‡ä»½æ•°æ®ä¸å­˜åœ¨');
            alert('âŒ å¤‡ä»½æ•°æ®ä¸å­˜åœ¨');
            return;
        }
        
        console.log('ğŸ“Š [restoreBackup] å¤‡ä»½åŒ…å«', Object.keys(backupData).length, 'æ¡æ•°æ®');
        
        // æ¢å¤æ•°æ®
        Object.keys(backupData).forEach(key => {
            localStorage.setItem(key, backupData[key]);
        });
        
        console.log('âœ… [restoreBackup] å¤‡ä»½æ¢å¤æˆåŠŸ');
        
        alert('âœ… å¤‡ä»½æ¢å¤æˆåŠŸï¼\n\né¡µé¢å°†è‡ªåŠ¨åˆ·æ–°...');
        setTimeout(() => location.reload(), 1000);
    } catch (error) {
        console.error('âŒ [restoreBackup] æ¢å¤å¤±è´¥:', error);
        console.error('âŒ [restoreBackup] é”™è¯¯å †æ ˆ:', error.stack);
        alert('âŒ æ¢å¤å¤‡ä»½å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
    }
};

// 6. åˆ é™¤å¤‡ä»½å‡½æ•°
window.deleteBackup = function(backupKey) {
    console.log('ğŸ—‘ï¸ [deleteBackup] è¢«è°ƒç”¨');
    console.log('ğŸ—‘ï¸ [deleteBackup] å¤‡ä»½é”®:', backupKey);
    console.log('ğŸ—‘ï¸ [deleteBackup] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
    
    try {
        if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¤‡ä»½å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
            console.log('âŒ [deleteBackup] ç”¨æˆ·å–æ¶ˆæ“ä½œ');
            return;
        }
        
        console.log('ğŸ” [deleteBackup] å¼€å§‹åˆ é™¤å¤‡ä»½...');
        
        localStorage.removeItem(backupKey);
        
        console.log('âœ… [deleteBackup] å¤‡ä»½å·²åˆ é™¤');
        
        alert('âœ… å¤‡ä»½å·²åˆ é™¤');
    } catch (error) {
        console.error('âŒ [deleteBackup] åˆ é™¤å¤±è´¥:', error);
        console.error('âŒ [deleteBackup] é”™è¯¯å †æ ˆ:', error.stack);
        alert('âŒ åˆ é™¤å¤‡ä»½å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
    }
};

// 7. å®‰å…¨çš„Toastæ˜¾ç¤ºå‡½æ•°ï¼ˆç”¨äºInputValidatoræœªåˆå§‹åŒ–æ—¶ï¼‰
window.safeShowToast = function(message, type) {
    console.log('ğŸ“¢ [safeShowToast] è¢«è°ƒç”¨');
    console.log('ğŸ“¢ [safeShowToast] æ¶ˆæ¯:', message, 'ç±»å‹:', type);
    
    try {
        // å°è¯•ä½¿ç”¨NotifySystem
        if (window.NotifySystem && typeof window.NotifySystem.showToast === 'function') {
            window.NotifySystem.showToast(message, type);
            return;
        }
        
        // å°è¯•ä½¿ç”¨InputValidator
        if (window.InputValidator && typeof window.InputValidator.showToast === 'function') {
            window.InputValidator.showToast(message, type);
            return;
        }
        
        // é™çº§åˆ°alert
        console.warn('âš ï¸ [safeShowToast] Toastç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œä½¿ç”¨alert');
        const icon = {
            'success': 'âœ…',
            'error': 'âŒ',
            'warning': 'âš ï¸',
            'info': 'â„¹ï¸'
        }[type] || 'ğŸ“¢';
        alert(icon + ' ' + message);
    } catch (error) {
        console.error('âŒ [safeShowToast] æ˜¾ç¤ºå¤±è´¥:', error);
    }
};

// ä¸ºInputValidatoråˆ›å»ºæ—©æœŸå ä½å¯¹è±¡
if (!window.InputValidator) {
    window.InputValidator = {
        showToast: function(message, type) {
            console.log('ğŸ“¢ [InputValidator.showToastå ä½] è¢«è°ƒç”¨');
            window.safeShowToast(message, type);
        }
    };
    console.log('âœ… åˆ›å»ºInputValidatorå ä½å¯¹è±¡');
}

console.log('âœ… [æ—©æœŸåˆå§‹åŒ–] å…³é”®å‡½æ•°å®šä¹‰å®Œæˆ');
console.log('âœ… window.closeAllModals:', typeof window.closeAllModals);
console.log('âœ… window.goToCloudSync:', typeof window.goToCloudSync);
console.log('âœ… window.enableMobileTips:', typeof window.enableMobileTips);
console.log('âœ… window.exportReportComplete:', typeof window.exportReportComplete);
console.log('âœ… window.loadFromCloudComplete:', typeof window.loadFromCloudComplete);
console.log('âœ… window.openBackupManagerComplete:', typeof window.openBackupManagerComplete);
console.log('âœ… window.createNewBackup:', typeof window.createNewBackup);
console.log('âœ… window.restoreBackup:', typeof window.restoreBackup);
console.log('âœ… window.deleteBackup:', typeof window.deleteBackup);
console.log('âœ… window.undoActionComplete:', typeof window.undoActionComplete);
console.log('âœ… window.redoActionComplete:', typeof window.redoActionComplete);

// 8. å¯¼å…¥æ•°æ®å‡½æ•°
window.importDataComplete = function() {
    console.log('ğŸ“¥ [importDataComplete] è¢«è°ƒç”¨');
    console.log('ğŸ“¥ [importDataComplete] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
    
    try {
        // å°è¯•ä¸¤ä¸ªå¯èƒ½çš„æ–‡ä»¶è¾“å…¥ID
        let fileInput = document.getElementById('import-file');
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
            fileInput = document.getElementById('import-file-input');
        }
        
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
            console.warn('âš ï¸ [importDataComplete] æœªé€‰æ‹©æ–‡ä»¶');
            alert('âš ï¸ è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶');
            return;
        }
        
        const file = fileInput.files[0];
        console.log('ğŸ“ [importDataComplete] æ–‡ä»¶å:', file.name);
        console.log('ğŸ“ [importDataComplete] æ–‡ä»¶å¤§å°:', (file.size / 1024).toFixed(2), 'KB');
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                console.log('ğŸ” [importDataComplete] æ–‡ä»¶è¯»å–å®Œæˆ');
                const content = e.target.result;
                let data;
                
                // æ”¯æŒå¤šç§æ ¼å¼
                if (file.name.endsWith('.json')) {
                    console.log('ğŸ“„ [importDataComplete] è§£æJSONæ ¼å¼');
                    data = JSON.parse(content);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    console.log('ğŸ“Š [importDataComplete] è§£æExcelæ ¼å¼');
                    // æ£€æŸ¥XLSXåº“
                    if (typeof XLSX !== 'undefined') {
                        const workbook = XLSX.read(content, { type: 'binary' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        data = XLSX.utils.sheet_to_json(worksheet)[0];
                    } else {
                        console.error('âŒ [importDataComplete] XLSXåº“æœªåŠ è½½');
                        alert('âš ï¸ Excelå¯¼å…¥éœ€è¦SheetJSåº“\n\nè¯·ä½¿ç”¨JSONæ ¼å¼å¯¼å…¥');
                        return;
                    }
                } else if (file.name.endsWith('.csv')) {
                    console.log('ğŸ“„ [importDataComplete] è§£æCSVæ ¼å¼');
                    const lines = content.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    const values = lines[1].split(',').map(v => v.trim());
                    data = {};
                    headers.forEach((header, index) => {
                        data[header] = values[index] || '';
                    });
                } else {
                    console.error('âŒ [importDataComplete] ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼:', file.name);
                    alert('âš ï¸ æ”¯æŒçš„æ ¼å¼: JSON, Excel, CSV\n\nå½“å‰æ–‡ä»¶: ' + file.name);
                    return;
                }
                
                // éªŒè¯æ•°æ®æ ¼å¼
                if (!data || typeof data !== 'object') {
                    throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                }
                
                console.log('âœ… [importDataComplete] æ•°æ®è§£ææˆåŠŸ');
                
                // ç¡®è®¤å¯¼å…¥
                const dateStr = document.getElementById('date-input')?.value || new Date().toISOString().split('T')[0];
                const confirmMsg = `ğŸ“¥ ç¡®è®¤å¯¼å…¥æ•°æ®ï¼Ÿ\n\n` +
                    `æ–‡ä»¶å: ${file.name}\n` +
                    `ç›®æ ‡æ—¥æœŸ: ${dateStr}\n\n` +
                    `âš ï¸ è¿™å°†è¦†ç›–å½“å‰æ—¥æœŸçš„æ•°æ®ï¼`;
                
                if (confirm(confirmMsg)) {
                    console.log('ğŸ’¾ [importDataComplete] ç”¨æˆ·ç¡®è®¤ï¼Œå¼€å§‹å¯¼å…¥');
                    
                    // ç¡®ä¿æ•°æ®æœ‰æ—¥æœŸå­—æ®µ
                    if (!data.date) {
                        data.date = dateStr;
                    }
                    
                    localStorage.setItem('tpi_data_' + dateStr, JSON.stringify(data));
                    
                    console.log('âœ… [importDataComplete] æ•°æ®å·²ä¿å­˜åˆ°localStorage');
                    
                    alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼\n\nå³å°†åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ•°æ®');
                    
                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                    if (fileInput) {
                        fileInput.value = '';
                    }
                    
                    location.reload();
                } else {
                    console.log('âŒ [importDataComplete] ç”¨æˆ·å–æ¶ˆå¯¼å…¥');
                }
                
            } catch (error) {
                console.error('âŒ [importDataComplete] å¯¼å…¥å¤±è´¥:', error);
                console.error('âŒ [importDataComplete] é”™è¯¯å †æ ˆ:', error.stack);
                alert('âŒ å¯¼å…¥å¤±è´¥\n\né”™è¯¯: ' + error.message + '\n\nè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®');
            }
        };
        
        reader.onerror = function() {
            console.error('âŒ [importDataComplete] æ–‡ä»¶è¯»å–å¤±è´¥');
            alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥\n\nè¯·é‡è¯•');
        };
        
        // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©è¯»å–æ–¹å¼
        if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            reader.readAsBinaryString(file);
        } else {
            reader.readAsText(file);
        }
        
    } catch (error) {
        console.error('âŒ [importDataComplete] æ‰§è¡Œå¤±è´¥:', error);
        console.error('âŒ [importDataComplete] é”™è¯¯å †æ ˆ:', error.stack);
        alert('âŒ å¯¼å…¥æ•°æ®å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
    }
};

console.log('âœ… window.importDataComplete:', typeof window.importDataComplete);

// 9. åˆ‡æ¢æš—é»‘ä¸»é¢˜å‡½æ•°
window.toggleDarkThemeComplete = function() {
    console.log('ğŸŒ“ [toggleDarkThemeComplete] è¢«è°ƒç”¨');
    console.log('ğŸŒ“ [toggleDarkThemeComplete] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
    
    try {
        const body = document.body;
        body.classList.toggle('dark-theme');
        
        const isDark = body.classList.contains('dark-theme');
        localStorage.setItem('tpi_theme', isDark ? 'dark' : 'light');
        
        console.log('âœ… [toggleDarkThemeComplete] ä¸»é¢˜åˆ‡æ¢æˆåŠŸï¼Œå½“å‰æ¨¡å¼:', isDark ? 'æš—é»‘' : 'æ˜äº®');
        
        alert(isDark ? 'ğŸŒ™ å·²åˆ‡æ¢åˆ°æš—é»‘æ¨¡å¼' : 'â˜€ï¸ å·²åˆ‡æ¢åˆ°æ˜äº®æ¨¡å¼');
    } catch (error) {
        console.error('âŒ [toggleDarkThemeComplete] ä¸»é¢˜åˆ‡æ¢å¤±è´¥:', error);
        console.error('âŒ [toggleDarkThemeComplete] é”™è¯¯å †æ ˆ:', error.stack);
        alert('âŒ ä¸»é¢˜åˆ‡æ¢å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
    }
};

// 10. æ¢å¤é»˜è®¤ä¸»é¢˜å‡½æ•°
window.restoreDarkThemeComplete = function() {
    console.log('â˜€ï¸ [restoreDarkThemeComplete] è¢«è°ƒç”¨');
    console.log('â˜€ï¸ [restoreDarkThemeComplete] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
    
    try {
        document.body.classList.remove('dark-theme');
        localStorage.removeItem('tpi_theme');
        
        console.log('âœ… [restoreDarkThemeComplete] å·²æ¢å¤é»˜è®¤ä¸»é¢˜');
        
        alert('âœ… å·²æ¢å¤é»˜è®¤ä¸»é¢˜');
    } catch (error) {
        console.error('âŒ [restoreDarkThemeComplete] æ¢å¤ä¸»é¢˜å¤±è´¥:', error);
        console.error('âŒ [restoreDarkThemeComplete] é”™è¯¯å †æ ˆ:', error.stack);
        alert('âŒ æ¢å¤å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
    }
};

console.log('âœ… window.toggleDarkThemeComplete:', typeof window.toggleDarkThemeComplete);
console.log('âœ… window.restoreDarkThemeComplete:', typeof window.restoreDarkThemeComplete);

// 11. æ•°æ®å¥åº·æ£€æŸ¥å‡½æ•°
window.checkDataHealthComplete = function() {
    console.log('ğŸ’Š [checkDataHealthComplete] è¢«è°ƒç”¨');
    console.log('ğŸ’Š [checkDataHealthComplete] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
    
    try {
        let totalKeys = 0;
        let tpiDataKeys = 0;
        let totalSize = 0;
        const issues = [];
        
        console.log('ğŸ” [checkDataHealthComplete] å¼€å§‹æ‰«ælocalStorage...');
        
        // æ£€æŸ¥æ‰€æœ‰localStorageæ•°æ®
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key) {
                totalKeys++;
                const value = localStorage.getItem(key);
                if (value) {
                    totalSize += value.length;
                    
                    if (key.startsWith('tpi_data_')) {
                        tpiDataKeys++;
                        
                        // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                        try {
                            const data = JSON.parse(value);
                            if (!data.date) {
                                issues.push(`${key}: ç¼ºå°‘æ—¥æœŸå­—æ®µ`);
                                console.warn('âš ï¸ [checkDataHealthComplete] é—®é¢˜:', key, 'ç¼ºå°‘æ—¥æœŸå­—æ®µ');
                            }
                        } catch (e) {
                            issues.push(`${key}: æ•°æ®æ ¼å¼é”™è¯¯`);
                            console.error('âŒ [checkDataHealthComplete] é—®é¢˜:', key, 'æ•°æ®æ ¼å¼é”™è¯¯');
                        }
                    }
                }
            }
        }
        
        console.log('ğŸ“Š [checkDataHealthComplete] æ‰«æå®Œæˆ');
        console.log('ğŸ“Š [checkDataHealthComplete] æ€»é”®æ•°:', totalKeys);
        console.log('ğŸ“Š [checkDataHealthComplete] TPIæ•°æ®:', tpiDataKeys);
        console.log('ğŸ“Š [checkDataHealthComplete] å­˜å‚¨å¤§å°:', (totalSize / 1024).toFixed(2), 'KB');
        console.log('ğŸ“Š [checkDataHealthComplete] å‘ç°é—®é¢˜:', issues.length);
        
        // è®¡ç®—å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡
        const maxSize = 5 * 1024 * 1024; // 5MB (ä¼°è®¡å€¼)
        const usagePercent = ((totalSize / maxSize) * 100).toFixed(2);
        
        // ç”ŸæˆæŠ¥å‘Š
        let report = 'ğŸ’Š æ•°æ®å¥åº·æ£€æŸ¥æŠ¥å‘Š\n\n';
        report += `ğŸ“Š å­˜å‚¨ç»Ÿè®¡:\n`;
        report += `â€¢ æ€»é”®æ•°: ${totalKeys}\n`;
        report += `â€¢ TPIæ•°æ®æ¡æ•°: ${tpiDataKeys}\n`;
        report += `â€¢ å­˜å‚¨ç©ºé—´: ${(totalSize / 1024).toFixed(2)} KB\n`;
        report += `â€¢ ä½¿ç”¨ç‡: ${usagePercent}%\n\n`;
        
        if (issues.length > 0) {
            report += `âš ï¸ å‘ç° ${issues.length} ä¸ªé—®é¢˜:\n`;
            issues.slice(0, 5).forEach(issue => {
                report += `â€¢ ${issue}\n`;
            });
            if (issues.length > 5) {
                report += `â€¢ ... è¿˜æœ‰ ${issues.length - 5} ä¸ªé—®é¢˜\n`;
            }
        } else {
            report += `âœ… æ‰€æœ‰æ•°æ®å®Œæ•´æ€§è‰¯å¥½`;
        }
        
        console.log('âœ… [checkDataHealthComplete] æŠ¥å‘Šç”Ÿæˆå®Œæˆ');
        
        alert(report);
        
    } catch (error) {
        console.error('âŒ [checkDataHealthComplete] å¥åº·æ£€æŸ¥å¤±è´¥:', error);
        console.error('âŒ [checkDataHealthComplete] é”™è¯¯å †æ ˆ:', error.stack);
        alert('âŒ å¥åº·æ£€æŸ¥å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
    }
};

console.log('âœ… window.checkDataHealthComplete:', typeof window.checkDataHealthComplete);

// 12. showModalæ¨¡æ€æ¡†å‡½æ•°
if (typeof window.showModal === 'undefined') {
    window.showModal = function(options) {
        console.log('ğŸ“¢ [showModal] è¢«è°ƒç”¨, é€‰é¡¹:', options);
        
        const {
            type = 'info',
            title = 'æç¤º',
            message = '',
            confirmText = 'ç¡®å®š',
            cancelText = 'å–æ¶ˆ',
            showCancel = true,
            showConfirm = true,
            onConfirm = null,
            onCancel = null,
            autoClose = 0
        } = options;
        
        // åˆ›å»ºmodalå®¹å™¨
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: modalFadeIn 0.2s ease-out;
        `;
        
        const content = document.createElement('div');
        content.className = 'modal-content ' + type;
        content.style.cssText = `
            background: white;
            border-radius: 12px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalScaleIn 0.3s ease-out;
        `;
        
        // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡å’Œé¢œè‰²
        let icon = 'ğŸ’¬';
        let iconColor = '#3b82f6';
        if (type === 'success') {
            icon = 'âœ…';
            iconColor = '#10b981';
        } else if (type === 'error' || type === 'danger') {
            icon = 'âŒ';
            iconColor = '#ef4444';
        } else if (type === 'warning') {
            icon = 'âš ï¸';
            iconColor = '#f59e0b';
        }
        
        content.innerHTML = `
            <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px;">${icon}</div>
                    <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">${title}</h3>
                </div>
            </div>
            <div class="modal-body" style="padding: 20px;">
                ${message}
            </div>
            <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end;">
                ${showCancel ? `<button class="modal-cancel-btn" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #6b7280; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">${cancelText}</button>` : ''}
                ${showConfirm ? `<button class="modal-confirm-btn" style="padding: 10px 20px; border: none; background: ${iconColor}; color: white; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;">${confirmText}</button>` : ''}
            </div>
        `;
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // å…³é—­å‡½æ•°
        const closeModal = () => {
            modal.style.animation = 'modalFadeOut 0.2s ease-out';
            content.style.animation = 'modalScaleOut 0.2s ease-out';
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            }, 200);
        };
        
        // ç¡®è®¤æŒ‰é’®
        const confirmBtn = content.querySelector('.modal-confirm-btn');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                console.log('âœ… [showModal] ç”¨æˆ·ç‚¹å‡»ç¡®è®¤');
                if (onConfirm) onConfirm();
                closeModal();
            });
            
            confirmBtn.addEventListener('mouseover', () => {
                confirmBtn.style.opacity = '0.9';
                confirmBtn.style.transform = 'translateY(-1px)';
            });
            
            confirmBtn.addEventListener('mouseout', () => {
                confirmBtn.style.opacity = '1';
                confirmBtn.style.transform = 'translateY(0)';
            });
        }
        
        // å–æ¶ˆæŒ‰é’®
        const cancelBtn = content.querySelector('.modal-cancel-btn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                console.log('âŒ [showModal] ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ');
                if (onCancel) onCancel();
                closeModal();
            });
            
            cancelBtn.addEventListener('mouseover', () => {
                cancelBtn.style.background = '#f3f4f6';
            });
            
            cancelBtn.addEventListener('mouseout', () => {
                cancelBtn.style.background = 'white';
            });
        }
        
        // ç‚¹å‡»é®ç½©å…³é—­ï¼ˆå¦‚æœæœ‰å–æ¶ˆæŒ‰é’®ï¼‰
        if (showCancel) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    console.log('âŒ [showModal] ç”¨æˆ·ç‚¹å‡»é®ç½©å…³é—­');
                    if (onCancel) onCancel();
                    closeModal();
                }
            });
        }
        
        // è‡ªåŠ¨å…³é—­
        if (autoClose > 0) {
            setTimeout(() => {
                console.log('â±ï¸ [showModal] è‡ªåŠ¨å…³é—­');
                closeModal();
            }, autoClose);
        }
        
        console.log('âœ… [showModal] æ¨¡æ€æ¡†å·²åˆ›å»º');
        
        return {
            close: closeModal
        };
    };
}

console.log('âœ… window.showModal:', typeof window.showModal);
console.log('âœ… window.safeShowToast:', typeof window.safeShowToast);
console.log('âœ… window.InputValidator.showToast:', typeof window.InputValidator.showToast);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…¨å±€é”™è¯¯å¤„ç†å’Œç§»åŠ¨ç«¯å´©æºƒä¿®å¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã€å…³é”®ã€‘ä¸ºæ“ä½œå†å²åŠŸèƒ½åˆ›å»ºæ—©æœŸå ä½å‡½æ•°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
    'use strict';

    // é˜²æ­¢æœªæ•è·çš„é”™è¯¯å¯¼è‡´é¡µé¢å´©æºƒ
    window.addEventListener('error', function(event) {
        console.error('å…¨å±€é”™è¯¯æ•è·:', event.error);
        event.preventDefault(); // é˜»æ­¢é»˜è®¤é”™è¯¯æ˜¾ç¤º
        return true;
    });

    // é˜²æ­¢Promise rejectionå¯¼è‡´å´©æºƒ
    window.addEventListener('unhandledrejection', function(event) {
        console.error('æœªå¤„ç†çš„Promise Rejection:', event.reason);
        event.preventDefault();
    });

    // ç§»é™¤ä»»ä½•å¯èƒ½å¯¼è‡´å…¨å±é”™è¯¯é®ç½©çš„å…ƒç´ 
    function removeErrorOverlays() {
        // æŸ¥æ‰¾å¹¶ç§»é™¤é”™è¯¯é®ç½©
        const errorOverlays = document.querySelectorAll('[class*="error"][class*="overlay"], [class*="Error"][class*="message"]');
        errorOverlays.forEach(overlay => {
            if (overlay.style.zIndex > 1000 || getComputedStyle(overlay).position === 'fixed') {
                console.log('ç§»é™¤é”™è¯¯é®ç½©:', overlay);
                overlay.remove();
            }
        });
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(removeErrorOverlays, 1000);
        });
    } else {
        setTimeout(removeErrorOverlays, 1000);
    }

    // å®šæœŸæ£€æŸ¥å¹¶ç§»é™¤é”™è¯¯é®ç½©(ç§»åŠ¨ç«¯ä¿®å¤)
    setInterval(removeErrorOverlays, 5000);

    console.log('âœ… å…¨å±€é”™è¯¯å¤„ç†å·²å¯ç”¨');
})();
  </script>
  <script>
   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ•°æ®å¯¼å‡ºå‡½æ•° - å¿…é¡»åœ¨HEADä¸­å®šä¹‰ï¼Œç¡®ä¿æŒ‰é’®åŠ è½½å‰å‡½æ•°å·²å­˜åœ¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.exportDataComplete = function(format) {
    console.log('[DataExport] å¯¼å‡ºæ•°æ®è¢«è°ƒç”¨ï¼Œæ ¼å¼:', format);
    
    try {
        // ============ ä¿®å¤1: å…ˆä¿å­˜å½“å‰æ•°æ®å†å¯¼å‡º ============
        // ç¡®ä¿æœ€æ–°è¾“å…¥çš„æ•°æ®è¢«ä¿å­˜åˆ°localStorage
        if (typeof window.saveToLocalStorage === 'function') {
            try {
                window.saveToLocalStorage();
                console.log('[DataExport] å·²è‡ªåŠ¨ä¿å­˜å½“å‰æ•°æ®');
            } catch (saveError) {
                console.warn('[DataExport] è‡ªåŠ¨ä¿å­˜å¤±è´¥ï¼Œç»§ç»­å¯¼å‡º:', saveError);
            }
        } else if (typeof window.collectFormData === 'function') {
            // å¦‚æœæ²¡æœ‰saveToLocalStorageï¼Œå°è¯•æ‰‹åŠ¨ä¿å­˜
            try {
                const currentData = window.collectFormData();
                const dateStr = document.getElementById('date-input')?.value || new Date().toISOString().split('T')[0];
                const key = `tpi_data_${dateStr}`;
                localStorage.setItem(key, JSON.stringify(currentData));
                console.log('[DataExport] å·²æ‰‹åŠ¨ä¿å­˜å½“å‰æ•°æ®');
            } catch (collectError) {
                console.warn('[DataExport] æ‰‹åŠ¨ä¿å­˜å¤±è´¥ï¼Œç»§ç»­å¯¼å‡º:', collectError);
            }
        }
        // ============ ä¿®å¤ç»“æŸ ============

        const dateStr = document.getElementById('date-input')?.value || new Date().toISOString().split('T')[0];
        console.log('[DataExport] å¯¼å‡ºæ—¥æœŸ:', dateStr);
        
        const dataStr = localStorage.getItem('tpi_data_' + dateStr);

        if (!dataStr) {
            console.warn('[DataExport] æœªæ‰¾åˆ°æ—¥æœŸæ•°æ®:', dateStr);
            alert('âš ï¸ æœªæ‰¾åˆ°å½“å‰æ—¥æœŸçš„æ•°æ®\n\nè¯·ç¡®ä¿å·²é€‰æ‹©æœ‰æ•°æ®çš„æ—¥æœŸ');
            return;
        }

        const data = JSON.parse(dataStr);
        console.log('[DataExport] æ•°æ®åŠ è½½æˆåŠŸï¼Œå‡†å¤‡ç”Ÿæˆ', format, 'æ ¼å¼');
        
        let content = '';
        let fileName = `TPIæ•°æ®_${dateStr}`;
        let mimeType = 'text/plain';

        switch(format.toLowerCase()) {
            case 'json':
                content = JSON.stringify(data, null, 2);
                fileName += '.json';
                mimeType = 'application/json';
                break;

            case 'txt':
                const txtExportTime = new Date();
                const txtExportTimeStr = `${txtExportTime.getFullYear()}-${String(txtExportTime.getMonth() + 1).padStart(2, '0')}-${String(txtExportTime.getDate()).padStart(2, '0')} ${String(txtExportTime.getHours()).padStart(2, '0')}:${String(txtExportTime.getMinutes()).padStart(2, '0')}:${String(txtExportTime.getSeconds()).padStart(2, '0')}`;
                
                content = `TPIæ•ˆèƒ½æ•°æ®æŠ¥å‘Š\n`;
                content += `${'='.repeat(60)}\n\n`;
                content += `æ•°æ®æ—¥æœŸ: ${dateStr}\n`;
                content += `å¯¼å‡ºæ—¶é—´: ${txtExportTimeStr}\n\n`;
                content += `${'='.repeat(60)}\n\n`;
                
                content += `ã€æ ¸å¿ƒæŒ‡æ ‡ã€‘\n`;
                content += `TPIæ€»åˆ†: ${data.tpi || 0} åˆ†\n`;
                content += `AMI (å­¦ä¸šæ•ˆèƒ½): ${data.ami || 0} åˆ†\n`;
                content += `BCM (åŸºçŸ³å¼ºåº¦): ${data.bcm || 0} åˆ†\n`;
                content += `Logistics (äº‹åŠ¡æ•ˆèƒ½): ${data.logistics || 0} åˆ†\n`;
                content += `HSM (å¥åº·çŠ¶æ€): ${data.hsm || 0} åˆ†\n`;
                content += `BONUS (åŠ åˆ†é¡¹): ${data.bonus || 0} åˆ†\n\n`;
                
                content += `ã€è¯¦ç»†æ•°æ®ã€‘\n\n`;
                content += `ä¸€ã€å­¦ä¹ ç»´åº¦ (AMI)\n`;
                content += `${'-'.repeat(60)}\n`;
                content += `  å­¦ä¹ æ—¶é•¿: ${data.studyHours || 0} å°æ—¶\n`;
                content += `  è®ºæ–‡é˜…è¯»: ${data.papersRead || 0} ç¯‡\n`;
                content += `  ä»£ç é‡: ${data.codeLines || 0} è¡Œ\n`;
                content += `  å­¦ä¹ ä¸“æ³¨åº¦: ${data.studyFocus || 0} åˆ†\n\n`;
                
                content += `äºŒã€åŸºçŸ³ä¹ æƒ¯ (BCM)\n`;
                content += `${'-'.repeat(60)}\n`;
                content += `  è¿åŠ¨æ—¶é•¿: ${data.exerciseMinutes || 0} åˆ†é’Ÿ\n`;
                content += `  æ­¥æ•°: ${data.steps || 0} æ­¥\n`;
                content += `  ç¡çœ æ—¶é•¿: ${data.sleepHours || 0} å°æ—¶\n`;
                content += `  ç¡çœ è´¨é‡: ${data.sleepQuality || 0} åˆ†\n\n`;
                
                content += `ä¸‰ã€åå‹¤äº‹åŠ¡ (Logistics)\n`;
                content += `${'-'.repeat(60)}\n`;
                content += `  æ´—è¡£: ${data.laundry ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}\n`;
                content += `  æˆ¿é—´æ•´ç†: ${data.roomCleaning ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}\n`;
                content += `  è´­ç‰©é‡‡ä¹°: ${data.shopping ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}\n`;
                content += `  å…¶ä»–äº‹åŠ¡: ${data.otherChores ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}\n\n`;
                
                content += `å››ã€å¥åº·çŠ¶æ€ (HSM)\n`;
                content += `${'-'.repeat(60)}\n`;
                content += `  èº«ä½“çŠ¶æ€: ${data.physicalHealth || 0} åˆ†\n`;
                content += `  å¿ƒç†çŠ¶æ€: ${data.mentalHealth || 0} åˆ†\n`;
                content += `  ç²¾åŠ›æ°´å¹³: ${data.energyLevel || 0} åˆ†\n\n`;
                
                content += `äº”ã€åŠ åˆ†é¡¹ (BONUS)\n`;
                content += `${'-'.repeat(60)}\n`;
                content += `  ç¤¾äº¤æ´»åŠ¨: ${data.socialBonus || 0} åˆ†\n`;
                content += `  åˆ›æ–°çªç ´: ${data.innovationBonus || 0} åˆ†\n`;
                content += `  å…¶ä»–åŠ åˆ†: ${data.otherBonus || 0} åˆ†\n\n`;
                
                content += `${'='.repeat(60)}\n`;
                content += `æœ¬æŠ¥å‘Šç”±TPIå…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿç”Ÿæˆ\n`;
                fileName += '.txt';
                break;

            case 'csv':
                content = 'æŒ‡æ ‡,æ•°å€¼\n';
                content += `æ•°æ®æ—¥æœŸ,${dateStr}\n`;
                content += `å¯¼å‡ºæ—¶é—´,${new Date().toISOString().replace('T', ' ').substring(0, 19)}\n`;
                content += `\n`;
                content += `æ ¸å¿ƒæŒ‡æ ‡,\n`;
                content += `TPIæ€»åˆ†,${data.tpi || 0}\n`;
                content += `AMI (å­¦ä¸šæ•ˆèƒ½),${data.ami || 0}\n`;
                content += `BCM (åŸºçŸ³å¼ºåº¦),${data.bcm || 0}\n`;
                content += `Logistics (äº‹åŠ¡æ•ˆèƒ½),${data.logistics || 0}\n`;
                content += `HSM (å¥åº·çŠ¶æ€),${data.hsm || 0}\n`;
                content += `BONUS (åŠ åˆ†é¡¹),${data.bonus || 0}\n`;
                content += `\n`;
                content += `å­¦ä¹ ç»´åº¦,\n`;
                content += `å­¦ä¹ æ—¶é•¿(å°æ—¶),${data.studyHours || 0}\n`;
                content += `è®ºæ–‡é˜…è¯»(ç¯‡),${data.papersRead || 0}\n`;
                content += `ä»£ç é‡(è¡Œ),${data.codeLines || 0}\n`;
                content += `å­¦ä¹ ä¸“æ³¨åº¦(åˆ†),${data.studyFocus || 0}\n`;
                content += `\n`;
                content += `åŸºçŸ³ä¹ æƒ¯,\n`;
                content += `è¿åŠ¨æ—¶é•¿(åˆ†é’Ÿ),${data.exerciseMinutes || 0}\n`;
                content += `æ­¥æ•°(æ­¥),${data.steps || 0}\n`;
                content += `ç¡çœ æ—¶é•¿(å°æ—¶),${data.sleepHours || 0}\n`;
                content += `ç¡çœ è´¨é‡(åˆ†),${data.sleepQuality || 0}\n`;
                content += `\n`;
                content += `åå‹¤äº‹åŠ¡,\n`;
                content += `æ´—è¡£,${data.laundry ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}\n`;
                content += `æˆ¿é—´æ•´ç†,${data.roomCleaning ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}\n`;
                content += `è´­ç‰©é‡‡ä¹°,${data.shopping ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}\n`;
                content += `å…¶ä»–äº‹åŠ¡,${data.otherChores ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}\n`;
                content += `\n`;
                content += `å¥åº·çŠ¶æ€,\n`;
                content += `èº«ä½“çŠ¶æ€(åˆ†),${data.physicalHealth || 0}\n`;
                content += `å¿ƒç†çŠ¶æ€(åˆ†),${data.mentalHealth || 0}\n`;
                content += `ç²¾åŠ›æ°´å¹³(åˆ†),${data.energyLevel || 0}\n`;
                content += `\n`;
                content += `åŠ åˆ†é¡¹,\n`;
                content += `ç¤¾äº¤æ´»åŠ¨(åˆ†),${data.socialBonus || 0}\n`;
                content += `åˆ›æ–°çªç ´(åˆ†),${data.innovationBonus || 0}\n`;
                content += `å…¶ä»–åŠ åˆ†(åˆ†),${data.otherBonus || 0}\n`;
                fileName += '.csv';
                mimeType = 'text/csv;charset=utf-8';
                break;

            case 'html':
                const htmlExportTime = new Date();
                const htmlExportTimeStr = `${htmlExportTime.getFullYear()}-${String(htmlExportTime.getMonth() + 1).padStart(2, '0')}-${String(htmlExportTime.getDate()).padStart(2, '0')} ${String(htmlExportTime.getHours()).padStart(2, '0')}:${String(htmlExportTime.getMinutes()).padStart(2, '0')}`;
                
                content = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>TPIæ•°æ® - ${dateStr}</title>
    <style>
    /* è¡¥å…¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
     body{font-family:'Microsoft YaHei', Arial, sans-serif;max-width:900px;margin:40px auto;padding:20px;background:#f5f5f5;}
     .container{background:white;padding:30px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
     h1{color:#2563eb;text-align:center;margin-bottom:10px;}
     .subtitle{text-align:center;color:#666;margin-bottom:30px;font-size:14px;}
     h2{color:#2563eb;border-left:4px solid #2563eb;padding-left:10px;margin-top:30px;margin-bottom:15px;}
     table{width:100%;border-collapse:collapse;margin:20px 0;}
     th, td{padding:12px;border:1px solid #e5e7eb;text-align:left;}
     th{background:#f3f4f6;font-weight:bold;color:#374151;}
     tr:hover{background:#f9fafb;}
     .metric-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0;}
     .metric-card{background:#f8f9fa;padding:15px;border-radius:6px;border-left:3px solid #2563eb;}
     .metric-label{font-size:12px;color:#666;margin-bottom:5px;}
     .metric-value{font-size:24px;font-weight:bold;color:#2563eb;}
     .footer{text-align:center;margin-top:30px;padding-top:20px;border-top:1px solid #e5e7eb;color:#666;font-size:12px;}
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š TPIæ•ˆèƒ½æ•°æ®æŠ¥å‘Š</h1>
        <div class="subtitle">æ•°æ®æ—¥æœŸ: ${dateStr} | å¯¼å‡ºæ—¶é—´: ${htmlExportTimeStr}</div>
        
        <h2>æ ¸å¿ƒæŒ‡æ ‡</h2>
        <div class="metric-grid">
            <div class="metric-card">
                <div class="metric-label">TPIæ€»åˆ†</div>
                <div class="metric-value">${data.tpi || 0}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">AMI (å­¦ä¸šæ•ˆèƒ½)</div>
                <div class="metric-value">${data.ami || 0}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">BCM (åŸºçŸ³å¼ºåº¦)</div>
                <div class="metric-value">${data.bcm || 0}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Logistics (äº‹åŠ¡æ•ˆèƒ½)</div>
                <div class="metric-value">${data.logistics || 0}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">HSM (å¥åº·çŠ¶æ€)</div>
                <div class="metric-value">${data.hsm || 0}</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">BONUS (åŠ åˆ†é¡¹)</div>
                <div class="metric-value">${data.bonus || 0}</div>
            </div>
        </div>
        
        <h2>è¯¦ç»†æ•°æ®</h2>
        <table>
            <tr><th colspan="3">ğŸ“š å­¦ä¹ ç»´åº¦ (AMI)</th></tr>
            <tr><td>å­¦ä¹ æ—¶é•¿</td><td>${data.studyHours || 0} å°æ—¶</td></tr>
            <tr><td>è®ºæ–‡é˜…è¯»</td><td>${data.papersRead || 0} ç¯‡</td></tr>
            <tr><td>ä»£ç é‡</td><td>${data.codeLines || 0} è¡Œ</td></tr>
            <tr><td>å­¦ä¹ ä¸“æ³¨åº¦</td><td>${data.studyFocus || 0} åˆ†</td></tr>
            
            <tr><th colspan="3">ğŸ’ª åŸºçŸ³ä¹ æƒ¯ (BCM)</th></tr>
            <tr><td>è¿åŠ¨æ—¶é•¿</td><td>${data.exerciseMinutes || 0} åˆ†é’Ÿ</td></tr>
            <tr><td>æ­¥æ•°</td><td>${data.steps || 0} æ­¥</td></tr>
            <tr><td>ç¡çœ æ—¶é•¿</td><td>${data.sleepHours || 0} å°æ—¶</td></tr>
            <tr><td>ç¡çœ è´¨é‡</td><td>${data.sleepQuality || 0} åˆ†</td></tr>
            
            <tr><th colspan="3">ğŸ“¦ åå‹¤äº‹åŠ¡ (Logistics)</th></tr>
            <tr><td>æ´—è¡£</td><td>${data.laundry ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}</td></tr>
            <tr><td>æˆ¿é—´æ•´ç†</td><td>${data.roomCleaning ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}</td></tr>
            <tr><td>è´­ç‰©é‡‡ä¹°</td><td>${data.shopping ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}</td></tr>
            <tr><td>å…¶ä»–äº‹åŠ¡</td><td>${data.otherChores ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}</td></tr>
            
            <tr><th colspan="3">ğŸ’ª å¥åº·çŠ¶æ€ (HSM)</th></tr>
            <tr><td>èº«ä½“çŠ¶æ€</td><td>${data.physicalHealth || 0} åˆ†</td></tr>
            <tr><td>å¿ƒç†çŠ¶æ€</td><td>${data.mentalHealth || 0} åˆ†</td></tr>
            <tr><td>ç²¾åŠ›æ°´å¹³</td><td>${data.energyLevel || 0} åˆ†</td></tr>
            
            <tr><th colspan="3">ğŸ åŠ åˆ†é¡¹ (BONUS)</th></tr>
            <tr><td>ç¤¾äº¤æ´»åŠ¨</td><td>${data.socialBonus || 0} åˆ†</td></tr>
            <tr><td>åˆ›æ–°çªç ´</td><td>${data.innovationBonus || 0} åˆ†</td></tr>
            <tr><td>å…¶ä»–åŠ åˆ†</td><td>${data.otherBonus || 0} åˆ†</td></tr>
        </table>
        
        <div class="footer">
            TPIå…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿ | æ•°æ®æ—¥æœŸ: ${dateStr} | å¯¼å‡ºæ—¶é—´: ${htmlExportTimeStr}
        </div>
    </div>
</body>
</html>`;
                fileName += '.html';
                mimeType = 'text/html';
                break;

            case 'markdown':
            case 'md':
                const exportTime = new Date();
                const exportTimeStr = `${exportTime.getFullYear()}-${String(exportTime.getMonth() + 1).padStart(2, '0')}-${String(exportTime.getDate()).padStart(2, '0')} ${String(exportTime.getHours()).padStart(2, '0')}:${String(exportTime.getMinutes()).padStart(2, '0')}:${String(exportTime.getSeconds()).padStart(2, '0')}`;
                
                content = `# ğŸ“Š TPIæ•ˆèƒ½æ•°æ®æŠ¥å‘Š\n\n`;
                content += `**æ•°æ®æ—¥æœŸ:** ${dateStr}\n\n`;
                content += `**å¯¼å‡ºæ—¶é—´:** ${exportTimeStr}\n\n`;
                content += `---\n\n`;
                content += `## æ ¸å¿ƒæŒ‡æ ‡\n\n`;
                content += `| æŒ‡æ ‡ | æ•°å€¼ |\n`;
                content += `|------|------|\n`;
                content += `| **TPIæ€»åˆ†** | ${data.tpi || 0} |\n`;
                content += `| **AMI (å­¦ä¸šæ•ˆèƒ½)** | ${data.ami || 0} |\n`;
                content += `| **BCM (åŸºçŸ³å¼ºåº¦)** | ${data.bcm || 0} |\n`;
                content += `| **Logistics (äº‹åŠ¡æ•ˆèƒ½)** | ${data.logistics || 0} |\n`;
                content += `| **HSM (å¥åº·çŠ¶æ€)** | ${data.hsm || 0} |\n`;
                content += `| **BONUS (åŠ åˆ†é¡¹)** | ${data.bonus || 0} |\n\n`;
                content += `## è¯¦ç»†æ•°æ®\n\n`;
                content += `### ğŸ“š å­¦ä¹ ç»´åº¦ (AMI)\n`;
                content += `- å­¦ä¹ æ—¶é•¿: **${data.studyHours || 0}** å°æ—¶\n`;
                content += `- è®ºæ–‡é˜…è¯»: **${data.papersRead || 0}** ç¯‡\n`;
                content += `- ä»£ç é‡: **${data.codeLines || 0}** è¡Œ\n`;
                content += `- å­¦ä¹ ä¸“æ³¨åº¦: **${data.studyFocus || 0}** åˆ†\n\n`;
                content += `### ğŸ’ª åŸºçŸ³ä¹ æƒ¯ (BCM)\n`;
                content += `- è¿åŠ¨æ—¶é•¿: **${data.exerciseMinutes || 0}** åˆ†é’Ÿ\n`;
                content += `- æ­¥æ•°: **${data.steps || 0}** æ­¥\n`;
                content += `- ç¡çœ æ—¶é•¿: **${data.sleepHours || 0}** å°æ—¶\n`;
                content += `- ç¡çœ è´¨é‡: **${data.sleepQuality || 0}** åˆ†\n\n`;
                content += `### ğŸ“¦ åå‹¤äº‹åŠ¡ (Logistics)\n`;
                content += `- æ´—è¡£: **${data.laundry ? 'âœ“' : 'âœ—'}**\n`;
                content += `- æˆ¿é—´æ•´ç†: **${data.roomCleaning ? 'âœ“' : 'âœ—'}**\n`;
                content += `- è´­ç‰©é‡‡ä¹°: **${data.shopping ? 'âœ“' : 'âœ—'}**\n`;
                content += `- å…¶ä»–äº‹åŠ¡: **${data.otherChores ? 'âœ“' : 'âœ—'}**\n\n`;
                content += `### ğŸ’ª å¥åº·çŠ¶æ€ (HSM)\n`;
                content += `- èº«ä½“çŠ¶æ€: **${data.physicalHealth || 0}** åˆ†\n`;
                content += `- å¿ƒç†çŠ¶æ€: **${data.mentalHealth || 0}** åˆ†\n`;
                content += `- ç²¾åŠ›æ°´å¹³: **${data.energyLevel || 0}** åˆ†\n\n`;
                content += `### ğŸ åŠ åˆ†é¡¹ (BONUS)\n`;
                content += `- ç¤¾äº¤æ´»åŠ¨: **${data.socialBonus || 0}** åˆ†\n`;
                content += `- åˆ›æ–°çªç ´: **${data.innovationBonus || 0}** åˆ†\n`;
                content += `- å…¶ä»–åŠ åˆ†: **${data.otherBonus || 0}** åˆ†\n\n`;
                content += `---\n\n`;
                content += `*æœ¬æŠ¥å‘Šç”±TPIå…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿç”Ÿæˆ*\n`;
                fileName += '.md';
                mimeType = 'text/markdown';
                break;

            case 'pdf':
                // ç”ŸæˆPDFæ ¼å¼çš„HTMLå†…å®¹,ä½¿ç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½
                const pdfExportTime = new Date();
                const pdfExportTimeStr = `${pdfExportTime.getFullYear()}-${String(pdfExportTime.getMonth() + 1).padStart(2, '0')}-${String(pdfExportTime.getDate()).padStart(2, '0')} ${String(pdfExportTime.getHours()).padStart(2, '0')}:${String(pdfExportTime.getMinutes()).padStart(2, '0')}`;
                
                content = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>TPIæ•°æ®æŠ¥å‘Š - ${dateStr}</title>
    <style>
    /* è¡¥å…¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
     @page{size:A4;margin:2cm;}*{margin:0;padding:0;box-sizing:border-box;}body{font-family:'Microsoft YaHei', Arial, sans-serif;line-height:1.6;color:#333;background:white;}.container{max-width:800px;margin:0 auto;padding:40px;}.header{text-align:center;margin-bottom:40px;padding-bottom:20px;border-bottom:3px solid #2563eb;}h1{color:#2563eb;font-size:32px;margin-bottom:10px;}.date{color:#6b7280;font-size:16px;}.section{margin:30px 0;}h2{color:#1f2937;font-size:24px;margin-bottom:15px;padding-left:10px;border-left:4px solid #2563eb;}.metrics-grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:20px;margin:20px 0;}.metric-card{background:#f9fafb;padding:20px;border-radius:8px;border:1px solid #e5e7eb;}.metric-label{color:#6b7280;font-size:14px;margin-bottom:8px;}.metric-value{color:#1f2937;font-size:28px;font-weight:bold;}.metric-unit{color:#9ca3af;font-size:14px;margin-left:5px;}table{width:100%;border-collapse:collapse;margin:20px 0;}th, td{padding:12px;text-align:left;border-bottom:1px solid #e5e7eb;}th{background:#f3f4f6;color:#374151;font-weight:600;}tr:hover{background:#f9fafb;}.footer{margin-top:40px;padding-top:20px;border-top:1px solid #e5e7eb;text-align:center;color:#9ca3af;font-size:12px;}.print-btn{position:fixed;top:20px;right:20px;padding:12px 24px;background:#2563eb;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;box-shadow:0 2px 4px rgba(0,0,0,0.1);}.print-btn:hover{background:#1d4ed8;}@media print{.print-btn{display:none;}body{print-color-adjust:exact;-webkit-print-color-adjust:exact;}}</style>
</head>
<body>
    <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°/ä¿å­˜ä¸ºPDF</button>

    <div class="container">
        <div class="header">
            <h1>ğŸ“Š TPIæ•ˆèƒ½æ•°æ®æŠ¥å‘Š</h1>
            <div class="date">æ•°æ®æ—¥æœŸ: ${dateStr} | å¯¼å‡ºæ—¶é—´: ${pdfExportTimeStr}</div>
        </div>

        <div class="section">
            <h2>æ ¸å¿ƒæŒ‡æ ‡</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">TPIæ€»åˆ†</div>
                    <div class="metric-value">${data.tpi || 0}<span class="metric-unit">åˆ†</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">AMI (å­¦ä¸šæ•ˆèƒ½)</div>
                    <div class="metric-value">${data.ami || 0}<span class="metric-unit">åˆ†</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">BCM (åŸºçŸ³å¼ºåº¦)</div>
                    <div class="metric-value">${data.bcm || 0}<span class="metric-unit">åˆ†</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Logistics (äº‹åŠ¡æ•ˆèƒ½)</div>
                    <div class="metric-value">${data.logistics || 0}<span class="metric-unit">åˆ†</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">HSM (å¥åº·çŠ¶æ€)</div>
                    <div class="metric-value">${data.hsm || 0}<span class="metric-unit">åˆ†</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">BONUS (åŠ åˆ†é¡¹)</div>
                    <div class="metric-value">${data.bonus || 0}<span class="metric-unit">åˆ†</span></div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>è¯¦ç»†æ•°æ®</h2>
            <table>
                <thead>
                    <tr>
                        <th>ç»´åº¦</th>
                        <th>æŒ‡æ ‡</th>
                        <th>æ•°å€¼</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td rowspan="4">ğŸ“š å­¦ä¹  (AMI)</td>
                        <td>å­¦ä¹ æ—¶é•¿</td>
                        <td>${data.studyHours || 0} å°æ—¶</td>
                    </tr>
                    <tr>
                        <td>è®ºæ–‡é˜…è¯»</td>
                        <td>${data.papersRead || 0} ç¯‡</td>
                    </tr>
                    <tr>
                        <td>ä»£ç é‡</td>
                        <td>${data.codeLines || 0} è¡Œ</td>
                    </tr>
                    <tr>
                        <td>å­¦ä¹ ä¸“æ³¨åº¦</td>
                        <td>${data.studyFocus || 0} åˆ†</td>
                    </tr>
                    <tr>
                        <td rowspan="4">ğŸ’ª åŸºçŸ³ä¹ æƒ¯ (BCM)</td>
                        <td>è¿åŠ¨æ—¶é•¿</td>
                        <td>${data.exerciseMinutes || 0} åˆ†é’Ÿ</td>
                    </tr>
                    <tr>
                        <td>æ­¥æ•°</td>
                        <td>${data.steps || 0} æ­¥</td>
                    </tr>
                    <tr>
                        <td>ç¡çœ æ—¶é•¿</td>
                        <td>${data.sleepHours || 0} å°æ—¶</td>
                    </tr>
                    <tr>
                        <td>ç¡çœ è´¨é‡</td>
                        <td>${data.sleepQuality || 0} åˆ†</td>
                    </tr>
                    <tr>
                        <td rowspan="4">ğŸ“¦ åå‹¤äº‹åŠ¡ (Logistics)</td>
                        <td>æ´—è¡£</td>
                        <td>${data.laundry ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}</td>
                    </tr>
                    <tr>
                        <td>æˆ¿é—´æ•´ç†</td>
                        <td>${data.roomCleaning ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}</td>
                    </tr>
                    <tr>
                        <td>è´­ç‰©é‡‡ä¹°</td>
                        <td>${data.shopping ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}</td>
                    </tr>
                    <tr>
                        <td>å…¶ä»–äº‹åŠ¡</td>
                        <td>${data.otherChores ? 'å·²å®Œæˆ âœ“' : 'æœªå®Œæˆ âœ—'}</td>
                    </tr>
                    <tr>
                        <td rowspan="3">ğŸ’ª å¥åº·çŠ¶æ€ (HSM)</td>
                        <td>èº«ä½“çŠ¶æ€</td>
                        <td>${data.physicalHealth || 0} åˆ†</td>
                    </tr>
                    <tr>
                        <td>å¿ƒç†çŠ¶æ€</td>
                        <td>${data.mentalHealth || 0} åˆ†</td>
                    </tr>
                    <tr>
                        <td>ç²¾åŠ›æ°´å¹³</td>
                        <td>${data.energyLevel || 0} åˆ†</td>
                    </tr>
                    <tr>
                        <td rowspan="3">ğŸ åŠ åˆ†é¡¹ (BONUS)</td>
                        <td>ç¤¾äº¤æ´»åŠ¨</td>
                        <td>${data.socialBonus || 0} åˆ†</td>
                    </tr>
                    <tr>
                        <td>åˆ›æ–°çªç ´</td>
                        <td>${data.innovationBonus || 0} åˆ†</td>
                    </tr>
                    <tr>
                        <td>å…¶ä»–åŠ åˆ†</td>
                        <td>${data.otherBonus || 0} åˆ†</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="footer">
            <p>TPIå…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿ | æ•°æ®æ—¥æœŸ: ${dateStr} | å¯¼å‡ºæ—¶é—´: ${pdfExportTimeStr}</p>
        </div>
    </div>

    <script>
        // è‡ªåŠ¨æç¤ºç”¨æˆ·æ‰“å°
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (confirm('æ˜¯å¦ç«‹å³æ‰“å°æˆ–ä¿å­˜ä¸ºPDFï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"æ‰“å°ï¼Œç‚¹å‡»"å–æ¶ˆ"ç¨åæ‰‹åŠ¨æ‰“å°')) {
                    window.print();
                }
            }, 500);
        });
    <\/script>\n<\/body>\n<\/html>`;
                fileName += '.html';
                mimeType = 'text/html';
                alert('ğŸ’¡ PDFå¯¼å‡ºè¯´æ˜\n\nå°†æ‰“å¼€ä¸€ä¸ªæ–°é¡µé¢,æ‚¨å¯ä»¥:\n1. ä½¿ç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½(Ctrl+P)\n2. é€‰æ‹©"å¦å­˜ä¸ºPDF"ä¿å­˜\n\næˆ–ç›´æ¥ç‚¹å‡»é¡µé¢ä¸Šçš„"æ‰“å°/ä¿å­˜ä¸ºPDF"æŒ‰é’®');
                break;
        }

        // PDFæ ¼å¼ç‰¹æ®Šå¤„ç†ï¼šåœ¨æ–°çª—å£ä¸­æ‰“å¼€
        if (format.toLowerCase() === 'pdf') {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const newWindow = window.open(url, '_blank');
            if (!newWindow) {
                alert('âš ï¸ è¯·å…è®¸å¼¹å‡ºçª—å£ä»¥æŸ¥çœ‹PDFé¢„è§ˆé¡µé¢');
            }
            // å»¶è¿Ÿé‡Šæ”¾URLï¼Œç¡®ä¿æ–°çª—å£æœ‰è¶³å¤Ÿæ—¶é—´åŠ è½½
            setTimeout(() => URL.revokeObjectURL(url), 10000);
            return;
        }

        // å…¶ä»–æ ¼å¼ï¼šåˆ›å»ºä¸‹è½½é“¾æ¥
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        console.log('[DataExport] å¯¼å‡ºå®Œæˆ - æ ¼å¼:', format, 'æ–‡ä»¶å:', fileName);
        alert(`âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼\n\næ ¼å¼: ${format.toUpperCase()}\næ–‡ä»¶å: ${fileName}`);

    } catch (error) {
        console.error('âŒ [DataExport] å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
        alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
    }


// ç«‹å³éªŒè¯å‡½æ•°æ˜¯å¦å¯ç”¨
if (typeof window.exportDataComplete === 'function') {
} else {
    console.error('âŒâŒâŒ exportDataCompleteå‡½æ•°åˆ›å»ºå¤±è´¥ï¼');
}

// æ·»åŠ ç¼ºå¤±çš„å…¨å±€å‡½æ•°
// å·¥å…·å‡½æ•°: æ”¶é›†è¡¨å•æ•°æ® (æ—©æœŸç®€åŒ–ç‰ˆ)
function collectFormDataEarly() {
    const formData = {
        _version: '1.0.0',
        _timestamp: new Date().toISOString(),
        _date: document.getElementById('date-input')?.value || new Date().toISOString().split('T')[0],
        fields: {},
        computed: {}
    };
    
    // æ”¶é›†æ‰€æœ‰è¾“å…¥å­—æ®µ
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.id) {
            const fieldData = {
                type: input.type || input.tagName.toLowerCase(),
                value: input.value
            };
            
            if (input.type === 'checkbox') {
                fieldData.checked = input.checked;
            } else if (input.type === 'radio') {
                fieldData.checked = input.checked;
            }
            
            formData.fields[input.id] = fieldData;
        }
    });
    
    return formData;
}

// å·¥å…·å‡½æ•°: æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToastEarly(message, type = 'success') {
    if (typeof window.TPI !== 'undefined' && typeof window.TPI.showToast === 'function') {
        window.TPI.showToast(message, type);
        return;
    }
    
    const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
    };
    alert(icons[type] + ' ' + message);
}

// å®‰å…¨çš„JSONè§£æ
function safeJSONParseEarly(str, defaultValue = null) {
    try {
        return JSON.parse(str);
    } catch (e) {
        console.warn('JSONè§£æå¤±è´¥:', e);
        return defaultValue;
    }
}

// ===== å…¨å±€å‡½æ•°: ä¿å­˜å½“å‰æ•°æ® =====
window.saveTpiData = function() {
    console.log('ğŸ’¾ æ‰§è¡Œä¿å­˜è‰ç¨¿æ“ä½œ...');
    
    try {
        const formData = collectFormDataEarly();
        const key = 'tpi_draft_data';
        
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem(key, JSON.stringify(formData));
        
        // åŒæ—¶ä¿å­˜ä¸€ä¸ªæ—¶é—´æˆ³
        localStorage.setItem('tpi_draft_timestamp', new Date().toISOString());
        
        console.log('âœ… è‰ç¨¿ä¿å­˜æˆåŠŸ');
        console.log('ğŸ“Š ä¿å­˜çš„å­—æ®µæ•°:', Object.keys(formData.fields).length);
        console.log('ğŸ“… ä¿å­˜æ—¥æœŸ:', formData._date);
        
        showToastEarly(`è‰ç¨¿ä¿å­˜æˆåŠŸï¼\nå·²ä¿å­˜ ${Object.keys(formData.fields).length} ä¸ªå­—æ®µ`, 'success');
        
        return true;
    } catch (error) {
        console.error('âŒ ä¿å­˜è‰ç¨¿å¤±è´¥:', error);
        showToastEarly('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
        return false;
    }
};

// ===== å…¨å±€å‡½æ•°: æ¢å¤ä¿å­˜çš„æ•°æ® =====
window.loadTpiData = function() {
    console.log('ğŸ“‚ æ‰§è¡Œæ¢å¤è‰ç¨¿æ“ä½œ...');
    
    try {
        const key = 'tpi_draft_data';
        const dataStr = localStorage.getItem(key);
        
        if (!dataStr) {
            console.warn('âš ï¸ æœªæ‰¾åˆ°è‰ç¨¿æ•°æ®');
            showToastEarly('æœªæ‰¾åˆ°ä¿å­˜çš„è‰ç¨¿æ•°æ®', 'warning');
            return false;
        }
        
        const formData = safeJSONParseEarly(dataStr);
        if (!formData) {
            console.error('âŒ è‰ç¨¿æ•°æ®è§£æå¤±è´¥');
            showToastEarly('è‰ç¨¿æ•°æ®å·²æŸåï¼Œæ— æ³•æ¢å¤', 'error');
            return false;
        }
        
        console.log('ğŸ“Š è‰ç¨¿ä¿¡æ¯:');
        console.log('  - ç‰ˆæœ¬:', formData._version);
        console.log('  - ä¿å­˜æ—¶é—´:', formData._timestamp);
        console.log('  - æ—¥æœŸ:', formData._date);
        console.log('  - å­—æ®µæ•°:', Object.keys(formData.fields || {}).length);
        
        // è¯¢é—®ç”¨æˆ·æ˜¯å¦ç¡®è®¤æ¢å¤
        const timestamp = localStorage.getItem('tpi_draft_timestamp');
        const saveTime = timestamp ? new Date(timestamp).toLocaleString('zh-CN') : 'æœªçŸ¥';
        const confirmed = confirm(
            `å‘ç°è‰ç¨¿æ•°æ®\n\n` +
            `ä¿å­˜æ—¶é—´: ${saveTime}\n` +
            `å­—æ®µæ•°é‡: ${Object.keys(formData.fields || {}).length} ä¸ª\n\n` +
            `æ˜¯å¦æ¢å¤æ­¤è‰ç¨¿ï¼Ÿ\n` +
            `ï¼ˆå½“å‰æœªä¿å­˜çš„æ•°æ®å°†è¢«è¦†ç›–ï¼‰`
        );
        
        if (!confirmed) {
            console.log('âŒ ç”¨æˆ·å–æ¶ˆæ¢å¤æ“ä½œ');
            return false;
        }
        
        // æ¢å¤æ•°æ®åˆ°è¡¨å•
        let restoredCount = 0;
        Object.keys(formData.fields || {}).forEach(fieldId => {
            const fieldData = formData.fields[fieldId];
            const element = document.getElementById(fieldId);
            
            if (!element) return;
            
            try {
                if (fieldData.type === 'checkbox' || fieldData.type === 'radio') {
                    element.checked = fieldData.checked || false;
                } else {
                    element.value = fieldData.value || '';
                }
                restoredCount++;
            } catch (e) {
                console.warn(`æ¢å¤å­—æ®µ ${fieldId} å¤±è´¥:`, e);
            }
        });
        
        console.log(`âœ… æˆåŠŸæ¢å¤ ${restoredCount} ä¸ªå­—æ®µ`);
        showToastEarly(`æ¢å¤æˆåŠŸï¼\nå·²æ¢å¤ ${restoredCount} ä¸ªå­—æ®µ`, 'success');
        
        // å°è¯•è§¦å‘å…¨å±€é‡æ–°è®¡ç®—
        if (typeof window.calculateAllScores === 'function') {
            setTimeout(() => {
                try {
                    window.calculateAllScores();
                } catch (e) {
                    console.warn('è§¦å‘å…¨å±€è®¡ç®—å¤±è´¥:', e);
                }
            }, 100);
        }
        
        return true;
    } catch (error) {
        console.error('âŒ æ¢å¤è‰ç¨¿å¤±è´¥:', error);
        showToastEarly('æ¢å¤å¤±è´¥ï¼š' + error.message, 'error');
        return false;
    }
};

// å…¨å±€å¯¼å‡ºå‡½æ•°: å¯¼å‡ºä¸ºJSON
window.exportAsJSON = function() {
    console.log('ğŸ“¤ æ‰§è¡Œå¯¼å‡ºJSONæ“ä½œ...');
    
    try {
        const formData = collectFormDataEarly();
        const dateStr = formData._date.replace(/-/g, '');
        const fileName = `TPIæ•°æ®_${dateStr}.json`;
        
        const jsonContent = JSON.stringify(formData, null, 2);
        const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => URL.revokeObjectURL(url), 100);
        
        console.log('âœ… JSONå¯¼å‡ºæˆåŠŸ:', fileName);
        showToastEarly(`å¯¼å‡ºæˆåŠŸï¼\næ–‡ä»¶å: ${fileName}`, 'success');
        
        return true;
    } catch (error) {
        console.error('âŒ å¯¼å‡ºJSONå¤±è´¥:', error);
        showToastEarly('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
        return false;
    }
};

// å…¨å±€å¯¼å‡ºå‡½æ•°: å¯¼å‡ºä¸ºCSV
window.exportAsCSV = function() {
    console.log('ğŸ“Š æ‰§è¡Œå¯¼å‡ºCSVæ“ä½œ...');
    
    try {
        const formData = collectFormDataEarly();
        const dateStr = formData._date.replace(/-/g, '');
        const fileName = `TPIæ•°æ®_${dateStr}.csv`;
        
        let csvContent = '\uFEFF';
        csvContent += 'å­—æ®µID,å­—æ®µç±»å‹,å€¼\n';
        
        csvContent += `æ•°æ®ç‰ˆæœ¬,metadata,${formData._version}\n`;
        csvContent += `ä¿å­˜æ—¶é—´,metadata,${formData._timestamp}\n`;
        csvContent += `æ•°æ®æ—¥æœŸ,metadata,${formData._date}\n`;
        csvContent += '\n';
        
        Object.keys(formData.fields).forEach(id => {
            const field = formData.fields[id];
            let value = '';
            
            if (field.type === 'checkbox') {
                value = field.checked ? 'å·²é€‰ä¸­' : 'æœªé€‰ä¸­';
            } else if (field.type === 'radio') {
                value = field.checked ? 'é€‰ä¸­' : 'æœªé€‰ä¸­';
            } else {
                value = (field.value || '').replace(/"/g, '""');
            }
            
            csvContent += `"${id}","${field.type}","${value}"\n`;
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => URL.revokeObjectURL(url), 100);
        
        console.log('âœ… CSVå¯¼å‡ºæˆåŠŸ:', fileName);
        showToastEarly(`å¯¼å‡ºæˆåŠŸï¼\næ–‡ä»¶å: ${fileName}`, 'success');
        
        return true;
    } catch (error) {
        console.error('âŒ å¯¼å‡ºCSVå¤±è´¥:', error);
        showToastEarly('å¯¼å‡ºå¤±è´¥ï¼š' + error.message, 'error');
        return false;
    }
};


    // ç¡®ä¿å‡½æ•°å¯åœ¨å…¨å±€ä¸Šä¸‹æ–‡ä¸­ç›´æ¥è°ƒç”¨
    if (typeof saveTpiData === 'undefined') {
        saveTpiData = window.saveTpiData;
    }
    if (typeof loadTpiData === 'undefined') {
        loadTpiData = window.loadTpiData;
    }
    if (typeof exportAsJSON === 'undefined') {
        exportAsJSON = window.exportAsJSON;
    }
    if (typeof exportAsCSV === 'undefined') {
        exportAsCSV = window.exportAsCSV;
    }
    if (typeof exportDataComplete === 'undefined') {
        exportDataComplete = window.exportDataComplete;
    }

    console.log('âœ… æ‰€æœ‰å‡½æ•°å·²ç¡®ä¿å¯åœ¨å…¨å±€ä¸Šä¸‹æ–‡ä¸­è®¿é—®');
    console.log('âœ… saveTpiData å¯ç”¨æ€§:', typeof saveTpiData);
    console.log('âœ… loadTpiData å¯ç”¨æ€§:', typeof loadTpiData);
    console.log('âœ… exportAsJSON å¯ç”¨æ€§:', typeof exportAsJSON);
    console.log('âœ… exportDataComplete å¯ç”¨æ€§:', typeof exportDataComplete);
}; // ä¿®å¤: æ·»åŠ ç¼ºå¤±çš„é—­åˆæ‹¬å·
  </script>
 
  <style id="top-scoreboard-style">
    .top-scoreboard{
      position: sticky;
      top: 0;
      z-index: 5000;
      background: linear-gradient(135deg, rgba(224,231,255,.95) 0%, rgba(221,214,254,.95) 100%);
      border-bottom: 1px solid rgba(148,163,184,.35);
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .top-scoreboard-inner{
      max-width: 1400px;
      margin: 0 auto;
      padding: 8px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
      overflow-x: auto;
    }
    .top-scoreboard-inner::-webkit-scrollbar{ height: 6px; }
    .top-scoreboard-inner::-webkit-scrollbar-thumb{ background: rgba(148,163,184,.45); border-radius: 999px; }
    .ts-item{
      display: inline-flex;
      align-items: baseline;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(148,163,184,.25);
      white-space: nowrap;
    }
    .ts-label{ font-size: 11px; opacity: .9; }
    .ts-value{ font-size: 16px; font-weight: 800; letter-spacing: .2px; }
    .ts-sep{ width: 1px; height: 18px; background: rgba(148,163,184,.35); }
    .ts-grow{ flex: 1 1 auto; }
    .ts-total{
      display: inline-flex;
      align-items: baseline;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 12px;
      background: rgba(37,99,235,.10);
      border: 1px solid rgba(37,99,235,.18);
      white-space: nowrap;
    }
    .ts-total-label{ font-size: 11px; opacity: .9; }
    .ts-total-value{ font-size: 18px; font-weight: 900; }
    .ts-rating{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(255,255,255,0.65);
      white-space: nowrap;
    }
    .ts-rating.is-excellent{ background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.25); }
    .ts-rating.is-steady{ background: rgba(59,130,246,.18); border-color: rgba(59,130,246,.25); }
    .ts-rating.is-baseline{ background: rgba(245,158,11,.20); border-color: rgba(245,158,11,.25); }
    .ts-rating.is-maintenance{ background: rgba(107,114,128,.18); border-color: rgba(107,114,128,.25); }
    .ts-rating.is-overload{ background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.25); }

    /* å°å±æ›´ç´§å‡‘ */
    @media (max-width: 520px){
      .top-scoreboard-inner{ padding: 8px 10px; }
      .ts-item{ padding: 5px 8px; border-radius: 9px; }
      .ts-value{ font-size: 15px; }
      .ts-total-value{ font-size: 17px; }
    }
  </style>
</head>
 <body>
  <!-- ========== é¡¶éƒ¨åˆ†æ•°çœ‹æ¿ï¼ˆä¸TPIä»ªè¡¨ç›˜/å®æ—¶åˆ†æ•°åŒæ­¥ï¼‰ ========== -->
  <div id="top-scoreboard" class="top-scoreboard" aria-label="é¡¶éƒ¨åˆ†æ•°çœ‹æ¿">
    <div class="top-scoreboard-inner">
      <div class="ts-item"><span class="ts-label">ğŸ“‰ MA7</span><span id="ts-ma7" class="ts-value">0.0</span></div>
      <div class="ts-sep" aria-hidden="true"></div>
      <div class="ts-item"><span class="ts-label">ğŸ“ AMI</span><span id="ts-ami" class="ts-value">0.0</span></div>
      <div class="ts-sep" aria-hidden="true"></div>
      <div class="ts-item"><span class="ts-label">ğŸ§  FLI</span><span id="ts-fli" class="ts-value">0.0</span></div>
      <div class="ts-sep" aria-hidden="true"></div>
      <div class="ts-item"><span class="ts-label">ğŸ§± SYS</span><span id="ts-sys" class="ts-value">0.0</span></div>
      <div class="ts-sep" aria-hidden="true"></div>
      <div class="ts-item"><span class="ts-label">ğŸ BONUS</span><span id="ts-bonus" class="ts-value">0.0</span></div>

      <div class="ts-grow"></div>

      <div class="ts-total">
        <span class="ts-total-label">æ€»åˆ†</span>
        <span id="ts-total" class="ts-total-value">0.0</span>
      </div>
      <div id="ts-rating" class="ts-rating" title="è¯„çº§">â€”</div>
    </div>
  </div>

  <!-- ========== å¢å¼ºå¯¼èˆªç³»ç»Ÿ ç¬¬ 20 ç‰ˆ ========== -->
   <!-- PWAæ¨¡å¼æŒ‡ç¤ºå™¨ -->
   <div class="pwa-indicator-v19" id="pwaIndicator" style="display:none">
    <span>
     ğŸ“±
    </span>
    <span>
     PWAæ¨¡å¼
    </span>
   </div>
   <div class="quick-nav-container-v19">
    <div class="quick-nav-v19" id="quickNavV17">
     <div class="quick-nav-autogen-placeholder" style="opacity:.85;font-size:12px;padding:6px 8px;">æ­£åœ¨ç”Ÿæˆæ¨¡å—å¯¼èˆªâ€¦</div>
    </div>
   </div>
   <button class="quick-nav-toggle-ç¬¬18ç‰ˆ" id="navToggleV17" onclick="toggleQuickNavV17()" title="æ˜¾ç¤º/éšè—å¯¼èˆªæ ">
    â˜°
   </button>
   <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
   <!-- ========== å¢å¼ºå¯¼èˆªç³»ç»Ÿç»“æŸ ========== -->
   <!-- åŠ è½½åŠ¨ç”» -->
   <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner">
    </div>
    <script>
     // è‡ªåŠ¨éšè—åŠ è½½å±å¹•
    (function() {
        window.addEventListener('load', function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                setTimeout(function() {
                    loadingOverlay.style.opacity = '0';
                    loadingOverlay.style.transition = 'opacity 0.5s';
                    setTimeout(function() {
                        loadingOverlay.style.display = 'none';
                    }, 500);
                }, 300);
            }
        });

        // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœ5ç§’åè¿˜æ²¡éšè—ï¼Œå¼ºåˆ¶éšè—
        setTimeout(function() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay && loadingOverlay.style.display !== 'none') {
                console.warn('å¼ºåˆ¶éšè—åŠ è½½å±å¹•');
                loadingOverlay.style.display = 'none';
            }
        }, 5000);
    })();
    </script>
    <div class="loading-text">
     ç¬¬22ç‰ˆï¼šåŠ è½½ä¸­...</div>
    <div class="loading-version">
     ç¬¬22ç‰ˆ</div>
   </div>
   <!-- âš ï¸ v21 å¢å¼º:ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ -->
   
   <!-- âš ï¸ v21 å¢å¼º:å¸®åŠ©æŒ‰é’® -->
   <!-- âš ï¸ æ–°å¢:æ™ºèƒ½å¼¹çª—ç³»ç»Ÿå®¹å™¨ -->
   <div id="toast-container">
   </div>
   <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
   <button class="mobile-menu-button" id="mobile-menu-btn" onclick="window.TPI.toggleMobileMenu()">
    ğŸ“Š
   </button>
   <div class="page-wrapper">
    <!-- ==================== é¡¶éƒ¨å¯¼èˆªæ  ==================== -->
    <header class="top-header">
     <div class="header-content">
      <div class="header-title">
       <h1>
        å…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿ TPI
       </h1>
      </div>
      <div class="date-selector">
       <label for="date-input">
        ğŸ“† æ—¥æœŸï¼š
       </label>
       <div class="date-nav-container">
        <button class="date-nav-btn icon-only" id="date-prev" title="ä¸Šä¸€å¤©">
         â†
        </button>
        <input aria-label="é€‰æ‹©æ—¥æœŸ" id="date-input" type="date"/>
        <button class="date-nav-btn icon-only" id="date-next" title="ä¸‹ä¸€å¤©">
         â†’
        </button>
        <button class="date-nav-btn" id="date-today">
         ä»Šå¤©
        </button>
        <span class="date-info" id="date-weekday">
        </span>
       </div>
      </div>
     </div>
    </header>
    <!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  TPIç³»ç»Ÿä¿®å¤è®°å½• - å‰©ä½™é—®é¢˜ä¿®å¤æ‰¹æ¬¡ 2/3
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ä¿®å¤æ—¥æœŸï¼š2026-01-20
ä¿®å¤ç¼–å·ï¼šBatch 2 (é—®é¢˜4-5)
ä¿®å¤è¿›åº¦ï¼š5/7 (71.43%)

ã€ç¬¬ä¸€æ‰¹æ¬¡å›é¡¾ã€‘
é—®é¢˜1: AMIä»»åŠ¡æ textarea âœ… (å·²å­˜åœ¨)
é—®é¢˜2: Logisticså¾…åŠæ‚äº‹textarea âœ… (å·²å­˜åœ¨)  
é—®é¢˜3: äº‘ç«¯åŒæ­¥æ¨¡å—ä½ç½® âœ… (å·²è°ƒæ•´è‡³ç¬¬3511-3915è¡Œ)

ã€ç¬¬äºŒæ‰¹æ¬¡ä¿®å¤ã€‘
é—®é¢˜4: showValidationRulesInfoå‡½æ•°éªŒè¯
- å®šä½ï¼šç¬¬8654-8745è¡Œ
- çŠ¶æ€ï¼šâœ… å·²å­˜åœ¨ä¸”åŠŸèƒ½å®Œæ•´
- éªŒè¯å†…å®¹ï¼š
  âœ… å®Œæ•´çš„æ¨¡æ€æ¡†åˆ›å»º
  âœ… æ˜¾ç¤ºéªŒè¯è§„åˆ™åˆ—è¡¨
  âœ… å…³é—­æŒ‰é’®åŠŸèƒ½
  âœ… ç‚¹å‡»èƒŒæ™¯å…³é—­
  âœ… é”™è¯¯å¤„ç†æœºåˆ¶
- è°ƒç”¨ä½ç½®ï¼šç¬¬7784è¡Œï¼ˆæŸ¥çœ‹éªŒè¯è§„åˆ™æŒ‰é’®ï¼‰
- å®Œæˆåº¦ï¼š100%

é—®é¢˜5: è¾“å…¥å¤šå°æ•°ç‚¹é˜²æŠ¤
- å®šä½ï¼šç¬¬15373-15430è¡Œï¼ˆenhanceInputValidationå‡½æ•°ï¼‰
- çŠ¶æ€ï¼šğŸ”§ å·²æ”¹è¿›å¹¶å¢å¼º
- ä¿®æ”¹å†…å®¹ï¼š
  1. æ”¹è¿›åŸæœ‰é€»è¾‘ï¼ˆç¬¬15381-15386è¡Œï¼‰
     - ä¿®æ”¹å‰ï¼šparts[0] + '.' + parts.slice(1).join('')
     - ä¿®æ”¹åï¼šparts[0] + '.' + parts[1]
     - æ•ˆæœï¼š12.34.56 -> 12.34ï¼ˆè€Œé12.3456ï¼‰
  
  2. æ–°å¢é€šç”¨éªŒè¯ï¼ˆç¬¬15374-15410è¡Œï¼‰
     - åº”ç”¨èŒƒå›´ï¼šæ‰€æœ‰input[type="number"]
     - åŠŸèƒ½ï¼š
       âœ… å®æ—¶é˜»æ­¢å¤šä¸ªå°æ•°ç‚¹
       âœ… é™åˆ¶å°æ•°ç‚¹åæœ€å¤š2ä½
       âœ… åªå…è®¸æ•°å­—å’Œä¸€ä¸ªå°æ•°ç‚¹
       âœ… å¤±ç„¦æ—¶éªŒè¯è´Ÿæ•°
     
  3. ä¿ç•™ç‰¹å®šéªŒè¯ï¼ˆç¬¬15412-15430è¡Œï¼‰
     - é’ˆå¯¹åŒ…å«"å°æ—¶|åˆ†é’Ÿ|é¡µ|å­—|åˆ†"çš„è¾“å…¥æ¡†
     - å°æ•°ä½æ•°é™åˆ¶ä¸º1ä½
     - èŒƒå›´éªŒè¯ï¼ˆå¦‚å°æ—¶ä¸è¶…è¿‡24ï¼‰

- éªŒè¯ç»“æœï¼š
  âœ… è¾“å…¥"12.34.56"ä¼šè¢«è‡ªåŠ¨ä¿®æ­£ä¸º"12.34"
  âœ… è¾“å…¥"1.234"ä¼šè¢«è‡ªåŠ¨ä¿®æ­£ä¸º"1.23"
  âœ… æ‰€æœ‰numberç±»å‹è¾“å…¥éƒ½æœ‰ä¿æŠ¤
- å®Œæˆåº¦ï¼š100%

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬äºŒæ‰¹æ¬¡å®Œæˆåº¦ï¼š2/2 (100%)
ç´¯è®¡å®Œæˆåº¦ï¼š5/7 (71.43%)

æœªå®Œæˆé¡¹ï¼ˆå¾…ç¬¬ä¸‰æ‰¹æ¬¡ï¼‰ï¼š
- é—®é¢˜6: LoadingIndicatoråœ¨è€—æ—¶æ“ä½œä¸­çš„ä½¿ç”¨
- é—®é¢˜7: äº‹ä»¶ç›‘å¬å™¨é˜²é‡å¤æœºåˆ¶

æŠ€æœ¯æ”¹è¿›ï¼š
- æ–°å¢é€šç”¨æ•°å­—è¾“å…¥éªŒè¯ï¼Œè¦†ç›–æ‰€æœ‰numberè¾“å…¥æ¡†
- å¤šå°æ•°ç‚¹é˜²æŠ¤é€»è¾‘æ›´åŠ å‡†ç¡®å’Œç›´è§‚
- ä¿æŒå‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

æ³¨æ„äº‹é¡¹ï¼š
- showValidationRulesInfoå‡½æ•°å·²å­˜åœ¨ä¸”å®Œæ•´ï¼Œæ— éœ€ä¿®æ”¹
- æ•°å­—è¾“å…¥éªŒè¯å·²å…¨é¢å¢å¼ºï¼Œæ”¯æŒå®æ—¶å’Œå¤±ç„¦ä¸¤ç§éªŒè¯
- æ‰€æœ‰ä¿®æ”¹å·²éªŒè¯ï¼ŒåŠŸèƒ½æ­£å¸¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->

    <!-- ==================== æ¯æ—¥ç­¾åˆ°æ¨¡å— ==================== -->
    <div class="container">
     <section class="card fade-in stagger-2" id="daily-checkin-section">
      <div class="card-header" onclick="window.TPI.toggleCard('daily-checkin-section')">
       <div class="card-title">
        <span class="icon">
         âœ…
        </span>
        <span>
         æ¯æ—¥ç­¾åˆ° Daily Check-in
        </span>
       </div>
      </div>
      <div class="card-content">
       <div class="alert alert-info mb-3">
        <p>
         <strong>
          âœ… åŠŸèƒ½è¯´æ˜
         </strong>
         ï¼šæ¯æ—¥ç­¾åˆ°åŠŸèƒ½ï¼Œè®°å½•æ‚¨çš„è¿ç»­ç­¾åˆ°å¤©æ•°ï¼Œå¸®åŠ©åŸ¹å…»è‰¯å¥½çš„ä¹ æƒ¯ã€‚
        </p>
       </div>
       
       <!-- ç­¾åˆ°çŠ¶æ€æ˜¾ç¤º -->
       <div class="checkin-status-container mb-3" id="checkin-status-container" style="padding: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.10) 0%, rgba(99, 102, 241, 0.08) 100%); border-radius: 12px; color: var(--color-text-primary); border: 1px solid var(--color-border); box-shadow: var(--shadow-sm);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
         <div>
          <div style="font-size: 14px; color: var(--color-text-muted); margin-bottom: 5px;">ä»Šæ—¥çŠ¶æ€</div>
          <div id="checkin-status-text" style="font-size: 24px; font-weight: 700;">æœªç­¾åˆ°</div>
         </div>
         <div style="text-align: right;">
          <div style="font-size: 14px; color: var(--color-text-muted); margin-bottom: 5px;">è¿ç»­ç­¾åˆ°</div>
          <div style="font-size: 32px; font-weight: 700; display: flex; align-items: baseline; gap: 5px;">
           <span id="checkin-streak-display">0</span>
           <span style="font-size: 16px; color: var(--color-text-muted);">å¤©</span>
          </div>
         </div>
        </div>
       </div>
       
       <!-- ç­¾åˆ°æŒ‰é’® -->
       <div class="checkin-actions" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
        <button id="btn-daily-checkin" onclick="performDailyCheckIn()" style="padding: 15px 30px; background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);">
         ğŸ¯ ç«‹å³ç­¾åˆ°
        </button>
        <button id="btn-checkin-history" onclick="showCheckInHistory()" style="padding: 15px 30px; background: linear-gradient(135deg, var(--color-bg-tertiary) 0%, var(--color-bg-hover) 100%); color: var(--color-text-primary); border: 1px solid var(--color-border); border-radius: 10px; font-weight: 700; font-size: 16px; cursor: pointer; transition: all 0.3s; box-shadow: var(--shadow-sm);">
         ğŸ“… ç­¾åˆ°å†å²
        </button>
       </div>
       
       <!-- ç­¾åˆ°æ—¥å†æ˜¾ç¤ºï¼ˆæœ€è¿‘7å¤©ï¼‰ -->
       <div class="checkin-calendar mb-3" style="padding: 15px; background: #f8fafc; border-radius: 8px;">
        <div style="font-weight: 700; margin-bottom: 12px; color: #1e293b; font-size: 15px;">ğŸ“† æœ€è¿‘7å¤©ç­¾åˆ°è®°å½•</div>
        <div id="checkin-calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
         <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
       </div>
       
       <!-- ä½¿ç”¨è¯´æ˜ -->
       <div class="checkin-help" style="padding: 15px; background: var(--color-bg-tertiary); border-left: 4px solid rgba(245, 158, 11, 0.55); border-radius: 8px;">
        <div style="font-weight: 700; margin-bottom: 10px; color: var(--color-text-secondary);">ğŸ’¡ ä½¿ç”¨è¯´æ˜</div>
        <div style="font-size: 14px; line-height: 1.6; color: var(--color-text-secondary);">
         <ul style="margin-left: 20px;">
          <li>æ¯å¤©åªèƒ½ç­¾åˆ°ä¸€æ¬¡ï¼Œç­¾åˆ°åæŒ‰é’®ä¼šå˜ä¸º"å·²ç­¾åˆ°"çŠ¶æ€</li>
          <li>è¿ç»­ç­¾åˆ°ä¼šç´¯è®¡å¤©æ•°ï¼Œä¸­æ–­åä¼šé‡æ–°ä»1å¤©å¼€å§‹è®¡ç®—</li>
          <li>å»ºè®®é…åˆäº‘ç«¯åŒæ­¥åŠŸèƒ½ä½¿ç”¨ï¼Œç¡®ä¿æ•°æ®å®‰å…¨</li>
         </ul>
        </div>
       </div>
      </div>
     </section>
    </div>

    <!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  TPIç³»ç»Ÿä¿®å¤è®°å½• - å‰©ä½™é—®é¢˜ä¿®å¤æ‰¹æ¬¡ 3/3 (æœ€ç»ˆæ‰¹æ¬¡)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ä¿®å¤æ—¥æœŸï¼š2026-01-20
ä¿®å¤ç¼–å·ï¼šBatch 3 (é—®é¢˜6-7 + é¢å¤–é—®é¢˜1-2)
ä¿®å¤è¿›åº¦ï¼š7/7 + 2é¢å¤– = 9é¡¹ (100%)

ã€å‰ä¸¤æ‰¹æ¬¡å›é¡¾ã€‘
âœ… é—®é¢˜1: AMIä»»åŠ¡æ textarea (å·²å­˜åœ¨)
âœ… é—®é¢˜2: Logisticså¾…åŠæ‚äº‹textarea (å·²å­˜åœ¨)  
âœ… é—®é¢˜3: äº‘ç«¯åŒæ­¥æ¨¡å—ä½ç½® (å·²è°ƒæ•´)
âœ… é—®é¢˜4: showValidationRulesInfoå‡½æ•° (å·²å­˜åœ¨)
âœ… é—®é¢˜5: è¾“å…¥å¤šå°æ•°ç‚¹é˜²æŠ¤ (å·²å¢å¼º)

ã€ç¬¬ä¸‰æ‰¹æ¬¡ä¿®å¤ã€‘

é—®é¢˜6: LoadingIndicatoråœ¨è€—æ—¶æ“ä½œä¸­çš„ä½¿ç”¨
- çŠ¶æ€ï¼šâœ… å·²æ·»åŠ (Firebaseå·²ç§»é™¤)
- ä¿®æ”¹å†…å®¹ï¼š
  1. GitHubäº‘ç«¯åŒæ­¥åŠŸèƒ½
     - å¼€å§‹æ—¶ï¼šæ·»åŠ  LoadingIndicator.show('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...')
     - æˆåŠŸæ—¶ï¼šæ·»åŠ  LoadingIndicator.hide()
     - å¤±è´¥æ—¶ï¼šæ·»åŠ  LoadingIndicator.hide()
  
  2. æ•°æ®åŠ è½½åŠŸèƒ½
     - çŠ¶æ€ï¼šå·²æœ‰showNotificationï¼ŒLoadingIndicatorå¯é€‰
  
  3. å¯¼å‡ºåŠŸèƒ½
     - çŠ¶æ€ï¼šå¯¼å‡ºæ“ä½œé€šå¸¸å¾ˆå¿«ï¼ŒLoadingIndicatorå¯é€‰

- å®ç°ç»†èŠ‚ï¼š
  - ä½¿ç”¨window.LoadingIndicatoræ£€æŸ¥å­˜åœ¨æ€§
  - åœ¨æ‰€æœ‰åˆ†æ”¯ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰éƒ½ç¡®ä¿hideè¢«è°ƒç”¨
  - é˜²æ­¢æŒ‡ç¤ºå™¨æ°¸ä¹…åœç•™

- éªŒè¯ç»“æœï¼š
  âœ… GitHubåŒæ­¥æ—¶æ˜¾ç¤º"æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯..."
  âœ… æ“ä½œå®Œæˆåè‡ªåŠ¨éšè—
  âœ… é”™è¯¯æƒ…å†µä¸‹ä¹Ÿæ­£ç¡®éšè—

- å®Œæˆåº¦ï¼š100%

é—®é¢˜7: äº‹ä»¶ç›‘å¬å™¨é˜²é‡å¤æœºåˆ¶
- çŠ¶æ€ï¼šâœ… å·²æ·»åŠ 
- ä¿®æ”¹å†…å®¹ï¼š
  
  1. DarkModeç³»ç»Ÿï¼ˆç¬¬15279è¡Œï¼‰
     - æ·»åŠ ï¼šinitialized: false å±æ€§
     - åœ¨initå¼€å§‹ï¼šæ£€æŸ¥this.initializedï¼Œå¦‚å·²åˆå§‹åŒ–åˆ™return
     - åœ¨initç»“æŸï¼šè®¾ç½®this.initialized = true
     - æ·»åŠ ï¼šconsole.log('[DarkMode] åˆå§‹åŒ–å®Œæˆ')
  
  2. CheckinSystemç³»ç»Ÿï¼ˆç¬¬20761è¡Œï¼‰
     - æ·»åŠ ï¼šinitialized: false å±æ€§
     - åœ¨initå¼€å§‹ï¼šæ£€æŸ¥this.initializedï¼Œå¦‚å·²åˆå§‹åŒ–åˆ™return
     - åœ¨initç»“æŸï¼šè®¾ç½®this.initialized = true
     - æ·»åŠ ï¼šconsole.log('[CheckinSystem] åˆå§‹åŒ–å®Œæˆ')
  
  3. ScoreDashboardç³»ç»Ÿï¼ˆç¬¬20847è¡Œï¼‰
     - æ·»åŠ ï¼šinitialized: false å±æ€§
     - åœ¨initå¼€å§‹ï¼šæ£€æŸ¥this.initializedï¼Œå¦‚å·²åˆå§‹åŒ–åˆ™return
     - åœ¨initç»“æŸï¼šè®¾ç½®this.initialized = true
     - æ·»åŠ ï¼šconsole.log('[ScoreDashboard] åˆå§‹åŒ–å®Œæˆ')

- é˜²æŠ¤æœºåˆ¶ï¼š
  - é˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
  - é˜²æ­¢é‡å¤åˆ›å»ºDOMå…ƒç´ 
  - æä¾›æ¸…æ™°çš„åˆå§‹åŒ–æ—¥å¿—

- éªŒè¯ç»“æœï¼š
  âœ… é¡µé¢åˆ·æ–°åä¸ä¼šé‡å¤ç»‘å®š
  âœ… å¤šæ¬¡è°ƒç”¨initåªæ‰§è¡Œä¸€æ¬¡
  âœ… æ§åˆ¶å°æ˜¾ç¤ºæ¸…æ™°çš„æ—¥å¿—

- å®Œæˆåº¦ï¼š100%

ã€é¢å¤–ä¿®å¤ã€‘

é¢å¤–é—®é¢˜1: ä¼˜åŒ–åˆ†æ•°çœ‹æ¿å¸ƒå±€
- çŠ¶æ€ï¼šâœ… å·²ä¼˜åŒ–
- ä¿®æ”¹å†…å®¹ï¼š
  1. ç¼©å°æ•´ä½“å°ºå¯¸
     - padding: 24px â†’ 12px 16px
     - box-shadow: å‡å¼±é˜´å½±æ•ˆæœ
  
  2. æ”¹ä¸ºæ¨ªå‘ç´§å‡‘å¸ƒå±€
     - ä»gridå¸ƒå±€æ”¹ä¸ºflexå¸ƒå±€
     - åˆ†æ•°é¡¹æ¨ªå‘æ’åˆ—åœ¨ä¸€è¡Œ
  
  3. ä¼˜åŒ–åˆ†æ•°é¡¹
     - padding: 12px â†’ 6px 12px
     - font-size: 12px â†’ 10px (æ ‡ç­¾)
     - font-size: 28px â†’ 18px (åˆ†æ•°)
     - æ ‡ç­¾ç®€åŒ–ï¼šAMIè¾“å…¥â†’AMI, BCMè¡Œä¸ºâ†’BCM ç­‰
  
  4. ä¼˜åŒ–TPIæ€»åˆ†åŒºåŸŸ
     - ä»é¡¶éƒ¨æ”¹ä¸ºå³ä¾§ï¼ˆborder-leftä»£æ›¿border-topï¼‰
     - font-size: 56px â†’ 32px
     - ç´§å‡‘çš„è¾¹è·å’Œé—´è·
     - è¯„çº§æ ‡ç­¾: 18px â†’ 11px

- æ•ˆæœï¼š
  âœ… åˆ†æ•°çœ‹æ¿é«˜åº¦å‡å°‘çº¦60%
  âœ… æ‰€æœ‰åˆ†æ•°åœ¨ä¸€è¡Œæ˜¾ç¤º
  âœ… è§†è§‰æ›´ç®€æ´ï¼Œä¸æŠ¢å è¿‡å¤šç©ºé—´
  âœ… ä¿æŒæ‰€æœ‰åŠŸèƒ½å’Œå¯è¯»æ€§

- å®Œæˆåº¦ï¼š100%

é¢å¤–é—®é¢˜2: æ‰©å¤§ä»»åŠ¡æ å’Œå¾…åŠæ‚äº‹æ å®½åº¦
- çŠ¶æ€ï¼šâœ… å·²æ‰©å¤§3å€
- ä¿®æ”¹å†…å®¹ï¼š
  
  1. AMIä»»åŠ¡åˆ— (.task-column)
     - min-width: 300px â†’ 900px
     - max-width: 350px â†’ 1050px
     - æ‰©å¤§å€æ•°ï¼š3å€
  
  2. AMIå¤‡æ³¨åˆ— (.notes-column)
     - min-width: 300px â†’ 900px
     - max-width: 400px â†’ 1200px
     - æ‰©å¤§å€æ•°ï¼š3å€
  
  3. Logisticså¾…åŠæ‚äº‹åˆ—
     - width: 350px â†’ 1050px
     - æ‰©å¤§å€æ•°ï¼š3å€
  
  4. Logisticså¤‡æ³¨åˆ—
     - width: 250px â†’ 750px
     - æ‰©å¤§å€æ•°ï¼š3å€

- å¯¹ç§°æ€§è€ƒè™‘ï¼š
  âœ… AMIçš„ä»»åŠ¡åˆ—å’Œå¤‡æ³¨åˆ—åŒæ¯”ä¾‹æ‰©å¤§
  âœ… Logisticsçš„å¾…åŠæ‚äº‹åˆ—å’Œå¤‡æ³¨åˆ—åŒæ¯”ä¾‹æ‰©å¤§
  âœ… ä¿æŒè§†è§‰å¹³è¡¡

- ç”¨æˆ·ä½“éªŒæå‡ï¼š
  âœ… æ›´å¤§çš„è¾“å…¥ç©ºé—´ï¼Œä¾¿äºä¹¦å†™è¯¦ç»†å†…å®¹
  âœ… textareaè‡ªåŠ¨æ¢è¡Œæ•ˆæœæ›´å¥½
  âœ… å‡å°‘æ¨ªå‘æ»šåŠ¨éœ€æ±‚

- å®Œæˆåº¦ï¼š100%

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ç¬¬ä¸‰æ‰¹æ¬¡å®Œæˆåº¦ï¼š4/4 (100%)
ç´¯è®¡å®Œæˆåº¦ï¼š7/7 + 2é¢å¤– = 9/9 (100%)

æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼š
âœ… é—®é¢˜1: AMIä»»åŠ¡æ textarea
âœ… é—®é¢˜2: Logisticså¾…åŠæ‚äº‹textarea
âœ… é—®é¢˜3: äº‘ç«¯åŒæ­¥æ¨¡å—ä½ç½®
âœ… é—®é¢˜4: showValidationRulesInfoå‡½æ•°
âœ… é—®é¢˜5: è¾“å…¥å¤šå°æ•°ç‚¹é˜²æŠ¤
âœ… é—®é¢˜6: LoadingIndicatorä½¿ç”¨
âœ… é—®é¢˜7: äº‹ä»¶ç›‘å¬å™¨é˜²é‡å¤
âœ… é¢å¤–1: åˆ†æ•°çœ‹æ¿ä¼˜åŒ–
âœ… é¢å¤–2: ä»»åŠ¡æ /å¾…åŠæ‚äº‹æ æ‰©å¤§

æŠ€æœ¯æ”¹è¿›æ€»ç»“ï¼š
1. ç”¨æˆ·ä½“éªŒï¼šLoadingIndicatoræä¾›æ“ä½œåé¦ˆ
2. ä»£ç è´¨é‡ï¼šé˜²é‡å¤åˆå§‹åŒ–é¿å…å†…å­˜æ³„æ¼
3. ç•Œé¢ä¼˜åŒ–ï¼šåˆ†æ•°çœ‹æ¿æ›´ç´§å‡‘é«˜æ•ˆ
4. è¾“å…¥ä½“éªŒï¼šä»»åŠ¡æ æ‰©å¤§3å€ï¼Œä¾¿äºè¯¦ç»†è®°å½•

æµ‹è¯•å»ºè®®ï¼š
- æµ‹è¯•GitHubäº‘ç«¯åŒæ­¥çš„åŠ è½½åŠ¨ç”»
- æµ‹è¯•é¡µé¢åˆ·æ–°åæ— é‡å¤ç»‘å®š
- æµ‹è¯•åˆ†æ•°çœ‹æ¿åœ¨ä¸åŒå±å¹•å°ºå¯¸ä¸‹çš„æ˜¾ç¤º
- æµ‹è¯•ä»»åŠ¡æ å’Œå¾…åŠæ‚äº‹çš„è¾“å…¥ä½“éªŒ

æ³¨æ„äº‹é¡¹ï¼š
- åˆ†æ•°çœ‹æ¿ç°åœ¨æ›´ç´§å‡‘ï¼Œé€‚åˆå›ºå®šåœ¨é¡¶éƒ¨
- ä»»åŠ¡æ æ‰©å¤§åï¼Œè¡¨æ ¼å®½åº¦ä¼šå¢åŠ ï¼Œå¯èƒ½éœ€è¦æ¨ªå‘æ»šåŠ¨
- æ‰€æœ‰ä¿®æ”¹ä¿æŒå‘åå…¼å®¹
- æ‰€æœ‰ç³»ç»Ÿinitå‡½æ•°éƒ½æœ‰é˜²é‡å¤ä¿æŠ¤
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
    <!-- ==================== GitHubäº‘ç«¯åŒæ­¥æ¨¡å— (ç¬¬30ç‰ˆæ–°å¢) ==================== -->
    <div class="container">
     <section class="card fade-in stagger-2" id="cloud-sync-section">
      <div class="card-header" onclick="window.TPI.toggleCard('cloud-sync-section')">
       <div class="card-title">
        <span class="icon">
         â˜ï¸
        </span>
        <span>
         äº‘ç«¯åŒæ­¥ Cloud Sync
        </span>
       </div>
      </div>
      <div class="card-content">
       <div class="alert alert-info mb-3">
        <p>
         <strong>
          â˜ï¸ åŠŸèƒ½è¯´æ˜
         </strong>
         ï¼šå°†TPIæ•°æ®åŒæ­¥åˆ°GitHubä»“åº“ï¼Œå®ç°è·¨è®¾å¤‡æ•°æ®å…±äº«ã€‚æ•°æ®ä»¥æ—¥æœŸä¸ºé”®å­˜å‚¨åœ¨tpi_db.jsonæ–‡ä»¶ä¸­ã€‚
        </p>
       </div>
       
       <!-- ğŸ”‘ æ–°å¢ï¼šç™»å½•åŒºåŸŸï¼ˆåˆå§‹æ˜¾ç¤ºï¼‰ -->
       <div id="cloud-login" style="margin:12px 0;">
        <input type="text" id="cloud-username" placeholder="ç”¨æˆ·å" style="width:100%; padding:6px; margin:4px 0; border:1px solid #ccc; border-radius:4px;">
        <input type="password" id="cloud-password" placeholder="å¯†ç " style="width:100%; padding:6px; margin:4px 0; border:1px solid #ccc; border-radius:4px;">
        <button onclick="cloudLogin()" style="width:100%; padding:6px; background:#4CAF50; color:white; border:none; border-radius:4px; margin-top:6px;">ç™»å½•ä»¥å¯ç”¨åŒæ­¥</button>
        <p id="cloud-login-error" style="color:#f44336; font-size:12px; min-height:1.2em; margin-top:4px;"></p>
       </div>
       
       <!-- ğŸ“¦ åŸæœ‰åŒæ­¥æ§ä»¶ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
       <div id="sync-controls">
<!-- GitHubé…ç½® - å·²ç§»é™¤,æ”¹ç”¨ä¸“ç”¨åç«¯ -->
       <div class="github-config-grid" style="display: none !important; grid-template-columns: repeat(2, minmax(260px, 1fr)); gap: 15px; margin-bottom: 20px; align-items: end; max-width: 820px;">
        <div class="form-group">
         <label for="github-token" style="font-weight: 600; color: #374151; margin-bottom: 5px; display: block;">
          ğŸ”‘ GitHub Token
         </label>
         <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
        </div>
        <div class="form-group">
         <label for="github-username" style="font-weight: 600; color: #374151; margin-bottom: 5px; display: block;">
          ğŸ‘¤ GitHub ç”¨æˆ·å
         </label>
         <input type="text" id="github-username" placeholder="your-username" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
        </div>
        <div class="form-group">
         <label for="github-repo" style="font-weight: 600; color: #374151; margin-bottom: 5px; display: block;">
          ğŸ“¦ ä»“åº“å
         </label>
         <input type="text" id="github-repo" placeholder="tpi-data" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
        </div>
        <div class="form-group">
         <label for="github-branch" style="font-weight: 600; color: #374151; margin-bottom: 5px; display: block;">
          ğŸŒ¿ åˆ†æ”¯å
         </label>
         <input type="text" id="github-branch" placeholder="main" value="main" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
        </div>
       </div>
       
       <!-- æ“ä½œæŒ‰é’® - å·²æ”¹ç”¨ä¸“ç”¨åç«¯ API -->
       <div class="sync-actions" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
        <button id="sync-upload-btn" style="padding: 12px 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
         â¬†ï¸ ç«‹å³åŒæ­¥åˆ°äº‘ç«¯
        </button>
        <button id="sync-download-btn" style="padding: 12px 20px; background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
         â¬‡ï¸ ä»äº‘ç«¯ä¸‹è½½å†å²
        </button>
       </div>
       
       <!-- ä½¿ç”¨è¯´æ˜ -->
       <div class="sync-help" style="padding: 15px; background: #fffbeb; border-left: 4px solid #f59e0b; border-radius: 8px;">
        <div style="font-weight: 700; margin-bottom: 10px; color: #92400e;">ğŸ’¡ ä½¿ç”¨è¯´æ˜</div>
        <div style="font-size: 14px; line-height: 1.6; color: #78350f;">
         <ol style="margin-left: 20px;">
          <li>ç‚¹å‡»"ç«‹å³åŒæ­¥åˆ°äº‘ç«¯"ä¸Šä¼ ä»Šæ—¥æ•°æ®åˆ°ä¸“ç”¨æœåŠ¡å™¨</li>
          <li>åœ¨å…¶ä»–è®¾å¤‡ä¸Šä½¿ç”¨"ä»äº‘ç«¯ä¸‹è½½å†å²"æ¢å¤æ‰€æœ‰å†å²æ•°æ®</li>
          <li>æ•°æ®è‡ªåŠ¨åŠ å¯†å­˜å‚¨,å®‰å…¨å¯é </li>
         </ol>
         <p style="margin-top: 10px;">
          <strong>æ³¨æ„:</strong>åŒæ­¥å‰ä¼šè‡ªåŠ¨ä¿å­˜å½“å‰è¾“å…¥çš„æ•°æ®,ç¡®ä¿ä¸ä¸¢å¤±ä»»ä½•å†…å®¹ã€‚æœ¬åœ°ç¼“å­˜ä»ç„¶ä¿ç•™,ä½œä¸ºç¦»çº¿é™çº§æ–¹æ¡ˆã€‚
         </p>
        </div>
       </div>
       </div>
      </div>
     </section>

    <div class="container">
     <section class="card fade-in stagger-2" id="misc-log-section">
      <div class="card-header" onclick="window.TPI && window.TPI.toggleCard ? window.TPI.toggleCard('misc-log-section') : null">
       <div class="card-title">
        <span class="icon">ğŸ—’ï¸</span>
        <span>æ‚äº‹è®°å½• Â· å¿«é€Ÿå¤‡å¿˜ (Misc Log)</span>
       </div>
      </div>
      <div class="card-content">
       <div class="alert alert-info mb-6" style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
        <div style="display:flex; flex-direction:column; gap:6px;">
         <div style="font-weight:700;">ğŸ“Œ è½»é‡è®°å½•ï¼šæ”¯æŒç¼–è¾‘ / å•æ¡åˆ é™¤ / æ‰¹é‡åˆ é™¤</div>
         <div style="font-size:13px; opacity:.9;">
          ç»Ÿè®¡ï¼šå…± <span id="misc-log-count">0</span> æ¡ï½œåˆè®¡ <span id="misc-log-chars">0</span> å­—
         </div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
         <button class="btn btn-primary" type="button" onclick="window.MiscLog && window.MiscLog.openAdd()">â• æ–°å¢è®°å½•</button>
         <button class="btn btn-secondary" type="button" onclick="window.MiscLog && window.MiscLog.deleteSelected()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
        </div>
       </div>

       <!-- éšè—å­˜å‚¨ï¼šç¡®ä¿è¢« collectDailyData/_formState æ•è·å¹¶éšäº‘ç«¯åŒæ­¥ -->
       <textarea id="misc-records-json" style="display:none;"></textarea>

       <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 10px;">
        <label style="display:flex; align-items:center; gap:8px; font-size:13px;">
         <input id="misc-log-select-all" type="checkbox" onchange="window.MiscLog && window.MiscLog.toggleSelectAll(this.checked)"/>
         <span>å…¨é€‰</span>
        </label>
        <div style="font-size:12px; color:#64748b;">
         æ¯æ¡è®°å½•å‡å¸¦ï¼šç¼–è¾‘ / åˆ é™¤
        </div>
       </div>

       <div id="misc-log-list" style="display:flex; flex-direction:column; gap:10px;"></div>

       <div id="misc-log-empty" class="alert alert-warning" style="display:none; margin-top:12px;">
        æš‚æ— è®°å½•ã€‚ç‚¹å‡»ã€Œâ• æ–°å¢è®°å½•ã€å¼€å§‹ã€‚
       </div>
      </div>
     </section>
    </div>


    </div>
    <!-- ==================== TPI å…¨ç»´æ•ˆèƒ½ä»ªè¡¨ç›˜ ==================== -->
    <div class="container">

     <section class="card fade-in stagger-2" id="tpi-dashboard">
      <div class="card-header" onclick="window.TPI.toggleCard('tpi-dashboard')">
       <div class="card-title">
        <span class="icon">
         ğŸ“Š
        </span>
        <span>
         TPI å…¨ç»´æ•ˆèƒ½ä»ªè¡¨ç›˜
        </span>
       </div>
      </div>
      <div class="card-content">
       <div class="alert alert-info mb-6">
        <h4>
         ğŸ•’ ç»“ç®—æ—¶æœºä¸åŸåˆ™
        </h4>
        <p>
         <strong>
          å»ºè®®ç»“ç®—æ—¶é—´
         </strong>
         ï¼šæ™šé—´23:00 æˆ– æ¬¡æ—¥å¼€å·¥å‰10åˆ†é’Ÿã€‚
        </p>
        <p style="margin-top: 8px;">
         <strong>
          æ ¸å¿ƒåŸåˆ™
         </strong>
         ï¼š
         <strong>
          åˆ†æ•°ä¸æ˜¯å®¡åˆ¤ï¼Œæ˜¯å¯¼èˆªã€‚
         </strong>
         Context is King. æ•°æ®æœåŠ¡ä½ ï¼Œè€Œéå®¡åˆ¤ä½ ã€‚
        </p>
       </div>
       <!-- è¿è´¥é¢„è­¦æ˜¾ç¤º -->
       <div class="alert alert-danger mb-6" id="losing-streak-warning" style="display:none">
        <h4>
         âš ï¸ è¿è´¥é¢„è­¦
        </h4>
        <p>
         <strong>
          æ£€æµ‹åˆ°è¿ç»­
          <span id="losing-days-display">
           0
          </span>
          æ—¥ TPI &lt; 95 åˆ†
         </strong>
        </p>
        <p style="margin-top: 8px; font-size: 0.95em;">
         å»ºè®®ä¸»åŠ¨åˆ†æåŸå› ï¼š
        </p>
        <ul style="margin: 8px 0 0 20px; line-height: 1.8; font-size: 0.9em;">
         <li>
          æ˜¯å¦Sys
          <sub>
           Net
          </sub>
          æŒç»­ä½äº15åˆ†ï¼Ÿï¼ˆåŸºçŸ³ç³»ç»Ÿå¤±å®ˆï¼‰
         </li>
         <li>
          æ˜¯å¦è¿ç»­å¤šæ—¥ç¡çœ &gt;01:00ï¼Ÿï¼ˆç”Ÿç†å‚¨å¤‡ä¸è¶³ï¼‰
         </li>
         <li>
          æ˜¯å¦AMIäº§å‡ºæŒç»­ä¸º0ï¼Ÿï¼ˆå¯åŠ¨éšœç¢ï¼‰
         </li>
        </ul>
        <p style="margin-top: 12px; font-weight: 600; color: #991b1b;">
         ğŸ’¡ å»ºè®®æ“ä½œï¼šä¸»åŠ¨è¿›å…¥
         <strong>
          [ğŸ…±ï¸ å¤è‹æ¨¡å¼]
         </strong>
         è¿›è¡Œç³»ç»Ÿæ€§è°ƒæ•´ï¼Œé™ä½ç›®æ ‡å‹åŠ›ï¼Œä¸“æ³¨æ¢å¤åŸºçŸ³ã€‚
        </p>
       </div>
       <!-- TPIæ€»åˆ†å±•ç¤º -->
       <div class="text-center mb-6">
        <h2>
         ğŸ† TPI
         <sub>
          E
         </sub>
         (æ•ˆèƒ½æ‰§è¡Œåˆ†) æ€»åˆ†
        </h2>
        <div style="display: flex; align-items: center; justify-content: center; gap: var(--spacing-4); margin-top: var(--spacing-4); flex-wrap: wrap;">
         <input aria-label="TPIæ€»åˆ†" id="tpi-total" max="999" min="0" onblur="TPI.checkOverload()" oninput="TPI.checkOverload()" placeholder="0" readonly="" style="width: 120px; text-align: center; font-size: var(--font-size-2xl); font-weight: 700;" type="number"/>
         <span style="font-size: var(--font-size-lg);">
          åˆ†
         </span>
         <select aria-label="TPIè¯„çº§" id="tpi-rating" style="width: 180px; font-size: var(--font-size-base); font-weight: 600;">
          <option value="">
           -- è¯„çº§ --
          </option>
          <option value="poor">
           &lt; 95 ç»´æŠ¤ (Maintenance)
          </option>
          <option value="normal">
           95-120 ç»´æŒ (Baseline)
          </option>
          <option value="good">
           121-155 æ¨è¿› (Steady)
          </option>
          <option value="excellent">
           156-200 å“è¶Š (Excellence)
          </option>
          <option value="overload">
           &gt; 201 è¿‡è½½ (Overload)
          </option>
         </select>
        </div>
        <div class="alert alert-warning mt-4" id="overload-warning" style="display:none">
         <strong>
          âš ï¸ èƒ½é‡å¹³è¡¡åè®®è§¦å‘!
         </strong>
         <br/>
         å½“æ—¥TPI &gt; 200,æ¬¡æ—¥å¼ºåˆ¶è¿›å…¥
         <strong>
          [ğŸ…±ï¸ å¤è‹]
         </strong>
         æ¨¡å¼,å¾—åˆ†ä¸Šé™é”æ­»ä¸º
         <strong>
          95 åˆ†
         </strong>
         !
        </div>
        <div class="mt-4">
         <label for="ma7-score" style="font-size: var(--font-size-base); margin-right: var(--spacing-2);">
          ğŸ“ˆ 7æ—¥å‡åˆ† (MA7):
         </label>
         <input aria-label="7æ—¥å‡åˆ†" id="ma7-score" max="999" min="0" onblur="TPI.updateStreakWarning()" oninput="TPI.updateStreakWarning()" placeholder="0" step="0.1" style="width: 100px; text-align: center; font-weight: 600;" type="number"/>
         <span class="text-muted" style="margin-left: var(--spacing-2); font-size: var(--font-size-sm);">
          (è‹¥ â‰¥120 åˆ™çŠ¶æ€åˆ¤å®šä¸ºç¨³å¥)
         </span>
        </div>
        <!-- è¿èƒœ/è¿è´¥è¿½è¸ª -->
        <div class="mt-4" style="display: flex; gap: var(--spacing-6); flex-wrap: wrap; justify-content: center;">
         <div>
          <label style="font-size: var(--font-size-base); margin-right: var(--spacing-2);">
           ğŸ”¥ è¿èƒœ:
          </label>
          <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
           è¿ç»­
          </span>
          <input aria-label="è¿èƒœå¤©æ•°" id="streak-days" max="10000" min="0" onblur="TPI.updateStreakWarning()" oninput="TPI.updateStreakWarning()" placeholder="0" step="1" style="width: 60px; text-align: center; margin: 0 4px;" type="number"/>
          <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
           æ—¥ TPIâ‰¥120
          </span>
         </div>
         <div>
          <label style="font-size: var(--font-size-base); margin-right: var(--spacing-2);">
           âš ï¸ è¿è´¥é¢„è­¦:
          </label>
          <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
           è¿ç»­
          </span>
          <input aria-label="è¿è´¥å¤©æ•°" id="losing-streak-days" max="10000" min="0" onblur="TPI.updateStreakWarning()" oninput="TPI.updateStreakWarning()" placeholder="0" step="1" style="width: 60px; text-align: center; margin: 0 4px;" type="number"/>
          <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
           æ—¥ TPI&lt;95
          </span>
         </div>
        </div>
       </div>
       <!-- TPIç»´åº¦è¡¨æ ¼ -->
       <div class="table-container">
        <table>
         <thead>
          <tr>
           <th>
            ç»´åº¦ (Dimension)
           </th>
           <th class="center">
            å¾—åˆ† (Score)
           </th>
           <th>
            è§’è‰²å®šä½ (Role)
           </th>
           <th>
            ç›®æ ‡æƒé‡ (Target Weight)
           </th>
           <th>
            é€»è¾‘è¯´æ˜
           </th>
          </tr>
         </thead>
         <tbody>
          <tr>
           <td class="row-header">
            âš”ï¸ å­¦æœ¯æˆ˜åŠ› (AMI)
           </td>
           <td class="center">
            <input aria-label="AMIå¾—åˆ†" id="ami-score" max="200" min="0" placeholder="0" step="0.1" style="width: 80px; text-align: center;" type="number"/>
            <span>
             åˆ†
            </span>
           </td>
           <td>
            æ ¸å¿ƒè¾“å‡º (åŠ æ³•)
           </td>
           <td>
            <strong>
             65% æƒé‡
            </strong>
           </td>
           <td>
            <strong>
             é‡å¿ƒ
            </strong>
            ã€‚äº§å‡ºè¶Šå¤šè¶Šå¥½ã€‚è¯¥ç»´åº¦åˆ†æ•°å æ€»åˆ†çš„ç›®æ ‡æ¯”ä¾‹ä¸º65%ï¼Œç”¨äºè¯„ä¼°ç³»ç»Ÿå¹³è¡¡æ€§ã€‚
           </td>
          </tr>
          <tr>
           <td class="row-header">
            ğŸ—£ï¸ è¯­è¨€å·¥å…· (FLI)
           </td>
           <td class="center">
            <input aria-label="FLIå¾—åˆ†" id="fli-score" max="100" min="0" onblur="TPI.calculateFLI(); TPI.calculateSystem()" oninput="TPI.calculateFLI(); TPI.calculateSystem()" placeholder="0" step="0.1" style="width: 80px; text-align: center;" type="number"/>
            <span>
             åˆ†
            </span>
           </td>
           <td>
            è¾…åŠ©å·¥å…· (åŠ æ³•)
           </td>
           <td>
            <strong>
             10% æƒé‡
            </strong>
           </td>
           <td>
            è¯­è¨€æ˜¯äººæ–‡ç ”ç©¶çš„é€é•œã€‚
           </td>
          </tr>
          <tr>
           <td class="row-header">
            ğŸ§± åŸºçŸ³ç³»ç»Ÿ (Sys
            <sub>
             Net
            </sub>
            )
           </td>
           <td class="center">
            <input aria-label="Syså¾—åˆ†" id="sys-score" max="100" min="0" placeholder="0" readonly="" step="0.1" style="width: 80px; text-align: center;" type="number"/>
            <span>
             åˆ†
            </span>
           </td>
           <td>
            ç”Ÿå­˜ä¿éšœ (çº¢çº¿)
           </td>
           <td>
            <strong>
             20% æƒé‡
            </strong>
           </td>
           <td>
            <strong>
             çº¢çº¿åˆ¶
            </strong>
            ã€‚ä½äº 15 åˆ†å°†è§¦å‘çŠ¶æ€è­¦ç¤ºï¼Œä½äº 12 åˆ†è§¦å‘è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶ã€‚
            <strong>
             ä»»ä¸€å­ç»´åº¦ï¼ˆBCM/Logistics/HSMï¼‰ä½äºæœ€ä½è¾¾æ ‡åˆ†å°†è§¦å‘ç³»ç»Ÿæé†’ã€‚
            </strong>
           </td>
          </tr>
          <tr>
           <td class="row-header">
            ğŸ’– éŸ§æ€§åŠ åˆ† (Bonus)
           </td>
           <td class="center">
            <input aria-label="Bonuså¾—åˆ†" id="bonus-score" max="100" min="-50" placeholder="0" readonly="" step="0.1" style="width: 80px; text-align: center;" type="number"/>
            <span>
             åˆ†
            </span>
           </td>
           <td>
            åè„†å¼±
           </td>
           <td>
            <strong>
             5% æƒé‡
            </strong>
           </td>
           <td>
            å¥–åŠ±å…³é”®è½¬æŠ˜ã€å¿ƒç†è°ƒèŠ‚ä¸è¿èƒœæˆå°±ã€‚
           </td>
          </tr>
         </tbody>
         <tfoot>
          <tr class="summary-row">
           <td class="text-center" colspan="5">
            <strong>
             å…¬å¼
            </strong>
            ï¼šTPI
            <sub>
             E
            </sub>
            = AMI + FLI + (BCM + Logistics + HSM) + Bonus
            <br/>
            <small class="text-muted">
             æ³¨: Sys
             <sub>
              Net
             </sub>
             = BCM + Logistics + HSM
            </small>
            <br/>
            <small class="text-danger">
             ğŸš¨ å®‰å…¨ä¿æŠ¤åè®®ï¼šSys
             <sub>
              Net
             </sub>
             &lt; 12 åˆ†å°†è§¦å‘è‡ªåŠ¨ä¿æŠ¤ï¼Œæ¬¡æ—¥å¼ºåˆ¶è¿›å…¥å¤è‹æ¨¡å¼
            </small>
           </td>
          </tr>
         </tfoot>
        </table>
       </div>
       <!-- TPIè®¡ç®—å…¬å¼ -->
       <div class="alert alert-info mt-6">
        <h4>
         ğŸ§® TPI
         <sub>
          E
         </sub>
         æ€»åˆ†è®¡ç®—å…¬å¼ (æ¨¡æ¿ç¬¬22ç‰ˆ)
        </h4>
        <p>
         $$\text{TPI}_{\text{E}} = \text{AMI}_{\text{Total}} + \text{FLI} + \text{Sys}_{\text{Net}} + \text{Bonus}$$
        </p>
        <p>
         <em>
          æ³¨ï¼š$\text{AMI}_{\text{Total}} = \text{Base} (h \times 2.5) + \text{Output} [(\text{Pages/Words} \times \text{Price}) \times F] + \text{å¸¸é©»ä»»åŠ¡å¥–åŠ±åˆ†}$
         </em>
        </p>
        <p style="font-size: 0.9em; margin-top: 4px;">
         <em>
          ğŸ’¡
          <strong>
           å¸¸é©»ä»»åŠ¡å¥–åŠ±åˆ†
          </strong>
          ï¼šå­¦æœ¯è®ºè‘—æ‰«æ(æ¯æ—¥â‰¥100é¡µ)å¯é¢å¤–è·å¾—+1åˆ†ç‹¬ç«‹å¥–åŠ±ï¼Œè¯¥åˆ†æ•°ç›´æ¥è®¡å…¥AMIæ€»åˆ†ã€‚
         </em>
        </p>
        <p>
         <em>
          æ³¨ï¼š$\text{Output Score}$ å°é¡¶è§„åˆ™ï¼š
          <strong>
           Type C åŠä»¥ä¸‹ä»»åŠ¡å°é¡¶ 100åˆ†ï¼ŒType D ä»»åŠ¡å°é¡¶ 150åˆ†
          </strong>
          ã€‚
         </em>
        </p>
        <p>
         <em>
          æ³¨ï¼š$\text{Sys}_{\text{Net}} = \min(18, \text{BCM (Part 3)} + \text{Logistics (Part 4)} + \text{HSM (Part 5)})$
         </em>
        </p>
        <p>
         <em>
          âš ï¸ å°é¡¶ä¸é¢„è­¦è§„åˆ™ï¼š
         </em>
        </p>
        <ol style="margin-left: 20px; font-size: 0.9em;">
         <li>
          åŸºçŸ³ç³»ç»Ÿï¼ˆSysï¼‰å„é¡¹å¾—åˆ†ä¹‹å’Œè‹¥è¶…è¿‡ 18 åˆ†ï¼Œæœ€ç»ˆè®¡å…¥æ€»åˆ†æ—¶ä»…å–
          <strong>
           18 åˆ†
          </strong>
          ã€‚
         </li>
         <li>
          <strong>
           å­ç³»ç»Ÿæœ€ä½è¾¾æ ‡åˆ†é¢„è­¦
          </strong>
          ï¼šä»»ä¸€å­ç»´åº¦ä½äºä»¥ä¸‹åˆ†æ•°å°†è§¦å‘ç³»ç»Ÿæé†’ï¼ˆä¸å¼ºåˆ¶åˆ‡æ¢æ¨¡å¼ï¼‰ï¼š
          <ul style="margin-left: 15px;">
           <li>
            <strong>
             BCM
            </strong>
            &lt; 12åˆ†
           </li>
           <li>
            <strong>
             Logistics
            </strong>
            &lt; 4åˆ†
           </li>
           <li>
            <strong>
             HSM
            </strong>
            &lt; 2.5åˆ†
           </li>
          </ul>
         </li>
        </ol>
       </div>
       <!-- å®‰å…¨ä¿æŠ¤åè®® -->
       <div class="alert alert-danger">
        <h4>
         ğŸš¨ å®‰å…¨ä¿æŠ¤åè®® (Safety Protocol - Red Line)
        </h4>
        <ul>
         <li>
          <strong>
           Sys
           <sub>
            Net
           </sub>
           &lt; 12 åˆ†
          </strong>
          ï¼š
          <strong>
           è§¦å‘è‡ªåŠ¨ä¿æŠ¤
          </strong>
          ã€‚
         </li>
         <li>
          <strong>
           åæœ
          </strong>
          ï¼šæ— è®ºä»Šæ—¥äº§å‡ºå¦‚ä½•ï¼Œ
          <strong>
           æ¬¡æ—¥å¿…é¡»å¼ºåˆ¶è¿›å…¥ [ğŸ…±ï¸ å¤è‹] æ¨¡å¼
          </strong>
          ï¼Œå¹¶åœ¨å½“æ™šæ˜¾ç¤ºçº¢è‰²é¢„è­¦ï¼š"æ˜æ—¥å°†è¿›å…¥ä¿æŠ¤æ¨¡å¼"ã€‚
         </li>
         <li>
          <strong>
           âš ï¸ ä¼˜å…ˆçº§
          </strong>
          ï¼š
          <span style="background: #fee; padding: 2px 6px; border-radius: 3px; font-weight: 600;">
           è¯¥è§¦å‘ä¼˜å…ˆäºç”±TPI&gt;200è§¦å‘çš„æ¨¡å¼åˆ‡æ¢
          </span>
          ï¼ˆå³ Sys&lt;12 çš„ä¿æŠ¤æœºåˆ¶ä¼˜å…ˆçº§æœ€é«˜ï¼‰
         </li>
        </ul>
       </div>
       <!-- çŠ¶æ€åˆ†çº§è§„åˆ™ -->
       <div class="rules-container">
        <div class="rules-section" id="tpi-grading-rules">
         <div class="rules-header" onclick="window.TPI.toggleRules('tpi-grading-rules')">
          âš–ï¸ TPI
          <sub>
           E
          </sub>
          åˆ†çº§æ ‡å‡†ä¸èƒ½é‡å¹³è¡¡åè®® (Grading Scale)
         </div>
         <div class="rules-content">
          <ul>
           <li>
            <strong>
             &lt; 95 åˆ†
            </strong>
            ï¼šğŸŒ±
            <strong>
             ç³»ç»Ÿç»´æŠ¤ (Maintenance)
            </strong>
            â€”â€”
            <strong>
             å…è®¸ä½äº§
            </strong>
            ã€‚è¯´æ˜ç³»ç»Ÿéœ€è¦ä¿®æ•´ï¼Œæ¥çº³å½“å‰çŠ¶æ€ï¼Œä¸“æ³¨äºæ¢å¤åŸºçŸ³ã€‚
           </li>
           <li>
            <strong>
             95-120 åˆ†
            </strong>
            ï¼šğŸ¥ˆ
            <strong>
             åŸºç¡€ç»´æŒ (Baseline)
            </strong>
            â€”â€”
            <strong>
             å¥åº·
            </strong>
            ã€‚è¿™æ˜¯å¯æŒç»­çš„å¸¸æ€ï¼Œè¯´æ˜ä½ å®Œæˆäº†ç§‘ç ”ä¸ç”Ÿæ´»çš„å¹³è¡¡ã€‚
           </li>
           <li>
            <strong>
             121-155 åˆ†
            </strong>
            ï¼šğŸ¥‡
            <strong>
             ç¨³å®šæ¨è¿› (Steady)
            </strong>
            â€”â€”
            <strong>
             è‰¯å¥½
            </strong>
            ã€‚æœ‰å®è´¨æ€§çš„æ ¸å¿ƒäº§å‡ºï¼ˆå¦‚å†™ä½œæ¨è¿›æˆ–æ·±åº¦æ”»åšï¼‰ã€‚
           </li>
           <li>
            <strong>
             156-200 åˆ†
            </strong>
            ï¼šğŸ’
            <strong>
             å“è¶Š/é«˜è´Ÿè· (High Performance)
            </strong>
            â€”â€”
            <strong>
             ç¼“å†²å¸¦
            </strong>
            ã€‚å®ç°äº†å†²åˆºæˆ–è§£å†³äº†å…³é”®æ‚–è®ºã€‚æ³¨æ„æ¬¡æ—¥ä½“èƒ½ã€‚
           </li>
           <li>
            <strong>
             201+ åˆ†
            </strong>
            ï¼šğŸ”¥
            <strong>
             ç³»ç»Ÿè¿‡è½½ (System Overload)
            </strong>
            â€”â€”
            <strong>
             å¼ºåˆ¶ç†”æ–­
            </strong>
            ã€‚æåº¦é€æ”¯ã€‚
            <strong>
             æ¬¡æ—¥å¿…é¡»å¼ºåˆ¶æ‰§è¡Œ"å¤è‹æ¨¡å¼"ã€‚
            </strong>
           </li>
          </ul>
          <p>
           <strong>
            ğŸ”‹ èƒ½é‡å¹³è¡¡åè®® (Energy Balance Protocol v17)
           </strong>
          </p>
          <ul>
           <li>
            <strong>
             è§¦å‘æ¡ä»¶
            </strong>
            ï¼šå½“æ—¥ TPI
            <sub>
             E
            </sub>
            &gt; 200ã€‚
           </li>
           <li>
            <strong>
             æ‰§è¡Œæœºåˆ¶
            </strong>
            ï¼šæ¬¡æ—¥å¼ºåˆ¶è¿›å…¥
            <strong>
             [ğŸ…±ï¸ å¤è‹]
            </strong>
            æ¨¡å¼ï¼Œå¾—åˆ†ä¸Šé™é”æ­»ä¸º
            <strong>
             95åˆ†
            </strong>
            ã€‚
           </li>
          </ul>
         </div>
        </div>
       </div>
      </div>
     </section>
     <!-- ==================== 10. Logistics åå‹¤ä¸ç»´æŠ¤ ==================== -->
     <!-- ==================== 3.5. æ¯æ—¥å¤ç›˜ä¸äº¤æ¥ ==================== -->
     <!-- ==================== 4. æ¯æ—¥å››åˆ†å«ï¼šæ¨¡å¼é€‰æ‹©ä¸æ„å›¾å£°æ˜ ==================== -->
     <section class="card fade-in" id="core-axioms">
      <div class="card-header" onclick="window.TPI.toggleCard('core-axioms')">
       <div class="card-title">
        <span class="icon">
         ğŸš©
        </span>
        <span>
         æ ¸å¿ƒä¿¡æ¡ä¸æœ€é«˜è£åˆ¤åŸåˆ™
        </span>
       </div>
      </div>
      <div class="card-content">
       <div class="mb-6">
        <h3>
         1. æ ¸å¿ƒä¿¡æ¡ (Core Axioms v16)
        </h3>
        <div class="axioms-grid">
         <div class="axiom-card">
          <span class="axiom-icon">
           â³
          </span>
          <h4 class="axiom-title">
           æ—¶ç©ºè§‚
          </h4>
          <p class="axiom-content">
           ä¸è¿‡äºæƒ³å·²ç»å‘ç”Ÿçš„äº‹æƒ…ï¼ˆæ²‰æ²¡æˆæœ¬ï¼‰ï¼Œä¸æƒ³è¿˜æœªå‘ç”Ÿçš„äº‹æƒ…ï¼ˆé¢„æœŸç„¦è™‘ï¼‰ï¼Œåªæƒ³çœ¼å‰çš„äº‹æƒ…ï¼ˆ
           <strong>
            è®¤çŸ¥éš§é“
           </strong>
           ï¼‰ã€‚
          </p>
         </div>
         <div class="axiom-card">
          <span class="axiom-icon">
           âš“
          </span>
          <h4 class="axiom-title">
           å‚ç…§ç³»
          </h4>
          <p class="axiom-content">
           ä¸è·Ÿä»–äººæ¯”ï¼Œåªå’Œè‡ªå·±çš„æ˜¨å¤©æ¯”ã€‚
           <strong>
            é•¿æœŸä¸»ä¹‰çš„æœ¬è´¨ä¸æ˜¯å¯¹è‡ªå·±æ›´ç‹ ï¼Œè€Œæ˜¯è¿™ç§ç”Ÿæ´»æ–¹å¼èƒ½åšæŒæ›´ä¹…ã€‚
           </strong>
          </p>
         </div>
         <div class="axiom-card">
          <span class="axiom-icon">
           ğŸ“
          </span>
          <h4 class="axiom-title">
           æ–¹æ³•è®º
          </h4>
          <p class="axiom-content">
           æ•°æ®æ˜¯ä¸ºäº†æœåŠ¡ä½ ï¼Œè€Œä¸æ˜¯å®¡åˆ¤ä½ ã€‚
           <strong>
            Context is King.
           </strong>
           åˆ†æ•°ä¸æ˜¯å®¡åˆ¤ï¼Œæ˜¯å¯¼èˆªã€‚
          </p>
         </div>
        </div>
       </div>
       <div class="mb-6">
        <h3>
         2. âš–ï¸ æœ€é«˜è£åˆ¤åŸåˆ™ (Supreme Rule: Permission Tier System)
        </h3>
        <p class="text-secondary">
         æƒé™åˆ†çº§ä½“ç³» (Permission Tiers)ï¼š
        </p>
        <div class="tier-list">
         <div class="tier-item tier-1">
          <div class="tier-badge-large tier-1">
           Tier 1
          </div>
          <div class="tier-content">
           <h4>
            ğŸ”´ ç”Ÿå­˜çº¢çº¿ [T1]
           </h4>
           <p>
            <strong>
             ä¸å¯è¢«å¤‡æ³¨è¦†ç›–
            </strong>
            ï¼ˆå¦‚ï¼šå¥åº·ç†”æ–­ã€
            <strong>
             è®¤çŸ¥çŠ¶æ€ç›‘æµ‹
            </strong>
            ï¼‰ã€‚
           </p>
          </div>
         </div>
         <div class="tier-item tier-2">
          <div class="tier-badge-large tier-2">
           Tier 2
          </div>
          <div class="tier-content">
           <h4>
            ğŸŸ¡ å¼¹æ€§è§„åˆ™ [T2]
           </h4>
           <p>
            <strong>
             å¯è¢«å¤‡æ³¨è¦†ç›–
            </strong>
            ï¼ˆå¦‚ï¼šä»»åŠ¡é¡ºåºã€å…·ä½“æ—¶é•¿å¾®è°ƒï¼‰ã€‚
           </p>
          </div>
         </div>
         <div class="tier-item tier-3">
          <div class="tier-badge-large tier-3">
           Tier 3
          </div>
          <div class="tier-content">
           <h4>
            âšª ç¨‹åºæ€§è§„åˆ™ [T3]
           </h4>
           <p>
            <strong>
             éœ€ç›´æ¥é‡å†™è€Œéå¤‡æ³¨
            </strong>
            ï¼ˆå¦‚ï¼šè®¡åˆ†å…¬å¼ã€æ ¸å¿ƒå®šä¹‰ï¼‰ã€‚
           </p>
          </div>
         </div>
        </div>
       </div>
       <div class="alert alert-info mb-6">
        <h4>
         ğŸ•’ ç¼“å†²æ—¶é—´ç»Ÿä¸€æ¡æ¬¾ [T2]
        </h4>
        <ul>
         <li>
          æœ¬è¡¨æ‰€æœ‰æ—¶é—´èŠ‚ç‚¹å‡è®¾ç«‹
          <strong>
           15åˆ†é’Ÿçš„"ç¼“å†²æ—¶é—´"
          </strong>
          (Buffer Time),ä½†èŠ±è´¹æ—¶é—´ä¸è¶³15åˆ†é’Ÿè€…ä¾‹å¤–ï¼ˆå¦‚5åˆ†é’Ÿçš„å¾®è¿åŠ¨ï¼‰ã€‚
         </li>
         <li>
          <strong>
           âš ï¸ ä¾‹å¤–
          </strong>
          ï¼šèŠ±è´¹æ—¶é—´æœ¬èº«ä¸è¶³15åˆ†é’Ÿçš„ä»»åŠ¡
          <strong>
           ä¸é€‚ç”¨
          </strong>
          ç¼“å†²æ—¶é—´ï¼ˆå¦‚ï¼š5åˆ†é’Ÿçš„å¾®è¿åŠ¨å¿…é¡»åœ¨è§„å®šæ—¶é—´å†…å®Œæˆ,ä¸äº«æœ‰é¢å¤–15åˆ†é’Ÿå®½é™ï¼‰ã€‚
         </li>
         <li>
          <em>
           ä¾‹å¦‚ï¼šå†™ä½œæˆªæ­¢08:30,08:45ä¹‹å‰ä¹Ÿå¯æ¥å—ï¼›ä½†å¾®è¿åŠ¨è¦æ±‚5åˆ†é’Ÿ,åˆ™å¿…é¡»å®é™…å®Œæˆ5åˆ†é’Ÿã€‚
          </em>
         </li>
        </ul>
       </div>
       <div>
        <h3>
         3. â›‘ï¸ è±å…ä¸é™åˆ¶ä½“ç³» (Exemption &amp; Limitation System v4.0)
        </h3>
        <div class="grid-2 mt-4">
         <div class="alert alert-success">
          <h4>
           âœ… å®¢è§‚è±å… (Objective Exemption)
          </h4>
          <p>
           å› 
           <strong>
            å®¢è§‚å› ç´ 
           </strong>
           ï¼ˆå¦‚æ¶åŠ£å¤©æ°”ã€èº«ä½“ä¸é€‚ã€çªå‘äº‹ä»¶ã€èµ„æ–™ç¼ºå¤±ç­‰ï¼‰å¯¼è‡´çš„è±å…ï¼Œ
           <strong>
            ä¸é™åˆ¶æ¬¡æ•°
           </strong>
           ï¼Œä½†éœ€åœ¨å¤‡æ³¨ä¸­è¯´æ˜ã€‚èµ„æ–™ç¼ºå¤±æ—¶ï¼Œå¯¹åº”ä»»åŠ¡äº§å‡ºå•ä»·å¯
           <strong>
            +0.1
           </strong>
           è¡¥å¿ã€‚
          </p>
         </div>
         <div class="alert alert-warning">
          <h4>
           âš ï¸ ä¸»è§‚è±å… (Subjective Exemption)
          </h4>
          <p>
           å› 
           <strong>
            ä¸»è§‚æ„æ„¿
           </strong>
           å¯¼è‡´çš„è±å…ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼Œ
           <strong>
            åˆ†åˆ«ç‹¬ç«‹è®¡æ•°
           </strong>
           ï¼š
          </p>
          <ul style="margin-top: 10px;">
           <li>
            <strong>
             Aç±» (ç³»ç»Ÿä¿®å¤è±å…)
            </strong>
            ï¼šç”¨äºç³»ç»Ÿå…³é”®æ¢å¤ä¸å¿ƒç†è°ƒèŠ‚ã€‚
            <strong>
             æ¯å‘¨é™ 2 æ¬¡
            </strong>
            ã€‚
            <br/>
            <span style="font-size: 0.9em; color: var(--color-text-secondary); margin-left: 20px;">
             ğŸ“Œ å…¸å‹åœºæ™¯ï¼šâ‘  "æµ·æ˜å¨æ¡¥æ–­è¿é‡è¿"ï¼ˆæœªæ‰§è¡Œæ˜¨æ—¥ç¬¬ä¸€åŠ¨ä½œå¯¼è‡´çš„å¯åŠ¨åˆ†æ‰£é™¤ï¼‰â‘¡ "ç„¦è™‘é˜»æ–­æ‰§è¡Œ"ï¼ˆå› ç„¦è™‘ä¸­æ–­å¯¼è‡´çš„AMIåˆ†æ‰£é™¤ï¼‰
            </span>
           </li>
           <li>
            <strong>
             Bç±» (æ—¥å¸¸å¼¹æ€§è±å…)
            </strong>
            ï¼šç”¨äºæ—¥å¸¸å¼¹æ€§è°ƒæ•´ï¼Œå¦‚æ— ç†ç”±è±å…ã€è½»å¾®è§„åˆ™è°ƒæ•´ã€‚
            <strong>
             æ¯å‘¨é™ 2 æ¬¡
            </strong>
            ã€‚
           </li>
          </ul>
         </div>
        </div>
        <div class="alert alert-danger mt-4">
         <h4>
          ğŸ“¢ è±å…å£°æ˜
         </h4>
         <p>
          æ‰€æœ‰è±å…å¿…é¡»åœ¨
          <strong>
           [æ¯æ—¥å››åˆ†å« - è±å…å£°æ˜åŒº]
          </strong>
          ä¸­æ˜¾æ€§å‹¾é€‰å¹¶å¡«å†™ç†ç”±æ–¹å¯ç”Ÿæ•ˆã€‚
         </p>
        </div>
       </div>
      </div>
     </section>
     <section class="card fade-in stagger-1" id="future-radar">
      <div class="card-header" onclick="window.TPI.toggleCard('future-radar')">
       <div class="card-title">
        <span class="icon">
         ğŸ”®
        </span>
        <span>
         æœªæ¥äº‹ä»¶é›·è¾¾ (Future Radar)
        </span>
       </div>
      </div>
      <div class="radar-controls">
       <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" onclick="FutureRadar.openModal('tempLife')">
         âš¡ ç”Ÿæ´»ä¸´æ—¶
        </button>
        <button class="btn btn-info btn-sm" onclick="FutureRadar.openModal('tempAcademic')">
         ğŸ“ å­¦æœ¯ä¸´æ—¶
        </button>
       </div>
       <div style="flex:1">
       </div>
       <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-success btn-sm" onclick="FutureRadar.openModal('regularLife')">
         ğŸ“… ç”Ÿæ´»å¸¸è§„
        </button>
        <button class="btn btn-warning btn-sm" onclick="FutureRadar.openModal('regularAcademic')">
         ğŸ« å­¦æœ¯å¸¸è§„
        </button>
        <button class="btn btn-secondary btn-sm" onclick="FutureRadar.openPushSettings()">
         âš™ï¸ è®¾ç½®
        </button>
       </div>
      </div>
      <div class="card-content" style="padding:0;">
       <div class="radar-section" id="section-tempLife">
        <div class="radar-section-header" onclick="FutureRadar.toggleSection('section-tempLife')">
         <span>
          âš¡ ä¸´æ—¶äº‹ä»¶ (ç”Ÿæ´»)
         </span>
         <span class="badge-tier2" id="badge-tempLife-count">
          0
         </span>
        </div>
        <div class="radar-list" id="list-tempLife">
        </div>
        <div class="radar-list completed-list collapsed" id="list-tempLife-done" style="background:#f9fafb; border-top:1px dashed #e5e7eb;">
        </div>
       </div>
       <div class="radar-section" id="section-tempAcademic">
        <div class="radar-section-header" onclick="FutureRadar.toggleSection('section-tempAcademic')">
         <span>
          ğŸ“ ä¸´æ—¶äº‹ä»¶ (å­¦æœ¯)
         </span>
         <span class="badge-tier1" id="badge-tempAcademic-count">
          0
         </span>
        </div>
        <div class="radar-list" id="list-tempAcademic">
        </div>
        <div class="radar-list completed-list collapsed" id="list-tempAcademic-done" style="background:#f9fafb; border-top:1px dashed #e5e7eb;">
        </div>
       </div>
       <div class="radar-section" id="section-regularLife">
        <div class="radar-section-header" onclick="FutureRadar.toggleSection('section-regularLife')">
         <span>
          ğŸ“… å¸¸è§„äº‹ä»¶ (ç”Ÿæ´»)
         </span>
         <span class="badge-tier3" id="badge-regularLife-count">
          0
         </span>
        </div>
        <div class="radar-list" id="list-regularLife">
        </div>
        <div class="radar-list completed-list collapsed" id="list-regularLife-done" style="background:#f9fafb; border-top:1px dashed #e5e7eb;">
        </div>
       </div>
       <div class="radar-section" id="section-regularAcademic">
        <div class="radar-section-header" onclick="FutureRadar.toggleSection('section-regularAcademic')">
         <span>
          ğŸ« å¸¸è§„äº‹ä»¶ (å­¦æœ¯)
         </span>
         <span class="badge-tier2" id="badge-regularAcademic-count">
          0
         </span>
        </div>
        <div class="radar-list" id="list-regularAcademic">
        </div>
        <div class="radar-list completed-list collapsed" id="list-regularAcademic-done" style="background:#f9fafb; border-top:1px dashed #e5e7eb;">
        </div>
       </div>
      </div>
     </section>
     <div class="modal-overlay" id="radar-modal" style="display:none;">
      <div class="modal">
       <div class="modal-header">
        <h3 class="modal-title" id="radar-modal-title">
         æ·»åŠ äº‹ä»¶
        </h3>
       </div>
       <div class="modal-body" style="display: flex; flex-direction: column; flex: 1; min-height:0; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 15px;">
        <form id="radar-form" onsubmit="event.preventDefault(); FutureRadar.saveEvent();">
         <input id="radar-event-type" type="hidden"/>
         <input id="radar-event-id" type="hidden"/>
         <div style="display:grid; gap:12px;">
          <div>
           <label>
            äº‹ä»¶åç§° *
           </label>
           <input id="radar-title" placeholder="æ ¸å¿ƒæ ‡é¢˜" required="" type="text"/>
          </div>
          <div class="input-group">
           <label>
            å†…å®¹è¯¦æƒ… &amp; å¤šåª’ä½“å¤‡æ³¨ (æ”¯æŒæ–‡å­—/å›¾ç‰‡/PDF/MD)
           </label>
           <div contenteditable="true" id="radar-rich-editor" placeholder="å¯ç›´æ¥ç²˜è´´å›¾ç‰‡æˆ–è¾“å…¥æ–‡æœ¬..." style="border:1px solid #ddd; border-radius:8px; padding:10px; min-height:120px; background:white;">
           </div>
           <textarea id="radar-remarks" style="display:none;"></textarea>
           <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
            <label class="btn btn-secondary btn-xs" style="font-size:12px; cursor:pointer;">
             ğŸ“ ä¸Šä¼ é™„ä»¶ (PDF/MD/TXT)
             <input accept=".pdf,.md,.txt,.jpg,.png" id="radar-files" multiple="" onchange="FutureRadar.handleFileUpload(this)" style="display:none;" type="file"/>
            </label>
            <div id="file-list-display" style="font-size:11px; color:#2563eb; display:flex; align-items:center;">
            </div>
           </div>
          </div>
          <div class="input-group">
           <label>
            æ—¥æœŸä¸æ—¶é—´æ¨¡å¼ *
           </label>
           <div style="display:grid; gap:8px;">
            <input id="radar-date" required="" style="width:100%;" type="date"/>
            <div style="display:flex; gap:8px;">
             <select id="radar-time-mode" onchange="window.FutureRadar.toggleRadarTimeInputs()" style="flex:1;">
              <option value="none">
               1. ä¸è®¾å…·ä½“æ—¶é—´
              </option>
              <option value="start">
               2. ä»…å¼€å§‹æ—¶é—´
              </option>
              <option value="range">
               3. å¼€å§‹ + ç»“æŸæ—¶é—´
              </option>
             </select>
             <div id="time-inputs-wrapper" style="display:flex; gap:4px; flex:2;">
              <input id="radar-time-start" style="display:none; flex:1;" type="time"/>
              <input id="radar-time-end" style="display:none; flex:1;" type="time"/>
             </div>
            </div>
           </div>
          </div>
          <div style="background: #f3f4f6; padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb;">
           <label style="font-weight: 600; color: #4b5563; margin-bottom: 6px; display: block;">
            ğŸ” é‡å¤è®¾ç½® (ä»…å¸¸è§„æœ‰æ•ˆ)
           </label>
           <div style="display: flex; gap: 10px; margin-bottom: 8px;">
            <select id="radar-recurrence" onchange="FutureRadar.toggleRecurrenceOptions()" style="flex: 1;">
             <option value="none">
              ä¸é‡å¤ (None)
             </option>
             <option value="weekly">
              æ¯å‘¨ (Weekly)
             </option>
             <option value="monthly">
              æ¯æœˆ (Monthly)
             </option>
             <option value="yearly">
              æ¯å¹´ (Yearly)
             </option>
             <option value="ebbinghaus">
              é—å¿˜æ›²çº¿ (Ebbinghaus)
             </option>
            </select>
            <div id="radar-calendar-type-container" style="display:none; flex: 1;">
             <select id="radar-calendar-type" style="width: 100%;">
              <option value="solar">
               ğŸŒ é˜³å† (Solar)
              </option>
              <option value="lunar">
               ğŸŒ™ é˜´å† (Lunar)
              </option>
             </select>
            </div>
           </div>
           <div id="radar-recurrence-count-container" style="display:none; margin-bottom: 8px;">
            <label style="font-size: 12px; color: #4b5563; display: block; margin-bottom: 4px;">
             é‡å¤æ¬¡æ•°
            </label>
            <select id="radar-recurrence-count" style="width: 100%;">
             <option value="unlimited">
              æ— é™é‡å¤
             </option>
             <option value="2">
              é‡å¤ 2 æ¬¡
             </option>
             <option value="3">
              é‡å¤ 3 æ¬¡
             </option>
             <option value="4">
              é‡å¤ 4 æ¬¡
             </option>
             <option value="5">
              é‡å¤ 5 æ¬¡
             </option>
             <option value="10">
              é‡å¤ 10 æ¬¡
             </option>
             <option value="15">
              é‡å¤ 15 æ¬¡
             </option>
             <option value="20">
              é‡å¤ 20 æ¬¡
             </option>
             <option value="30">
              é‡å¤ 30 æ¬¡
             </option>
             <option value="50">
              é‡å¤ 50 æ¬¡
             </option>
            </select>
           </div>
           <div id="radar-recurrence-hint" style="font-size: 11px; color: #6b7280; margin-top: 4px;">
           </div>
          </div>
          <div class="grid-2" style="gap:10px;">
           <div>
            <label>
             åœ°ç‚¹
            </label>
            <input id="radar-location" placeholder="çº¿ä¸‹æˆ–çº¿ä¸Šé“¾æ¥" type="text"/>
           </div>
           <div>
            <label>
             ä¸¾åŠäºº/æœºæ„
            </label>
            <input id="radar-organizer" placeholder="ä¸»åŠæ–¹" type="text"/>
           </div>
          </div>
          <div>
           <label>
            è¯¦ç»†å¤‡æ³¨ (æ”¯æŒæ–‡æœ¬/å›¾ç‰‡ç²˜è´´/PDF/Markdown)
           </label>
           <div contenteditable="true" id="radar-rich-editor-2" placeholder="æ­¤å¤„å¯ç›´æ¥è¾“å…¥æ–‡æœ¬æˆ–ç²˜è´´å›¾ç‰‡..." style="border:1px solid #ddd; border-radius:8px; padding:10px; min-height:100px; background:white;">
           </div>
           <div style="margin-top:8px;">
            <input accept=".pdf,.md,.txt,.jpg,.png" id="radar-attachments" multiple="" style="font-size:12px;" type="file"/>
           </div>
          </div>
          <div class="input-group" style="background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
           <label style="font-weight:700; color:#1e293b; margin-bottom:10px; display:block;">
            ğŸ”” å¤šçº§é¢„è­¦ç³»ç»Ÿ
           </label>
           <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div>
             <label style="font-size:12px; color:#64748b;">
              ğŸ“… æå‰é¢„è­¦ (å¤©)
             </label>
             <select id="radar-remind-advance" style="width:100%;">
              <option value="0">
               ä¸æå‰
              </option>
              <option value="1">
               æå‰ 1 å¤©
              </option>
              <option value="2">
               æå‰ 2 å¤©
              </option>
              <option value="3">
               æå‰ 3 å¤©
              </option>
              <option value="4">
               æå‰ 4 å¤©
              </option>
              <option value="5">
               æå‰ 5 å¤©
              </option>
              <option value="7">
               æå‰ 1 å‘¨
              </option>
             </select>
            </div>
            <div>
             <label style="font-size:12px; color:#64748b;">
              â° å½“å¤©ç²¾ç»†æé†’ (åˆ†é’Ÿ)
             </label>
             <select id="radar-remind-sameday" style="width:100%;">
              <option value="0">
               ä¸æé†’
              </option>
              <option value="15">
               15 åˆ†é’Ÿ
              </option>
              <option value="30">
               30 åˆ†é’Ÿ
              </option>
              <option value="45">
               45 åˆ†é’Ÿ
              </option>
              <option value="60">
               60 åˆ†é’Ÿ
              </option>
              <option value="75">
               75 åˆ†é’Ÿ
              </option>
              <option value="90">
               90 åˆ†é’Ÿ
              </option>
              <option value="120">
               120 åˆ†é’Ÿ
              </option>
             </select>
            </div>
           </div>
           <div style="display:flex; flex-direction:column; gap:8px;">
            <label style="display:flex; align-items:center; gap:8px;">
             <input id="radar-reminder-active" type="checkbox"/>
             <span>
              ğŸ”” å¯ç”¨ PushPlus æ¨é€
             </span>
            </label>
            <label style="display:flex; align-items:center; gap:8px; color: #d97706; font-weight: 600;">
             <input id="radar-important" type="checkbox"/>
             <span>
              â­ è®¾ä¸ºé‡è¦äº‹ä»¶ (ç½®é¡¶)
             </span>
            </label>
           </div>
          </div>
         </div>
        </form>
       </div>
       <div class="modal-footer">
        <button class="modal-button btn-secondary" onclick="FutureRadar.closeModal()">
         å–æ¶ˆ
        </button>
        <button class="modal-button btn-primary" onclick="FutureRadar.saveEvent()">
         ğŸ’¾ ä¿å­˜
        </button>
       </div>
      </div>
     </div>
     <div class="modal-overlay" id="radar-settings-modal" style="display:none;">
      <div class="modal" style="max-width: 600px;">
       <div class="modal-header">
        <h3>
         âš™ï¸ æœªæ¥äº‹ä»¶é›·è¾¾ - è®¾ç½®
        </h3>
       </div>
       <div class="modal-body" style="display: flex; flex-direction: column; flex: 1; overflow: hidden; padding: 15px;">
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
         <button class="settings-tab active" id="settings-tab-push" onclick="FutureRadar.switchSettingsTab('push')" style="padding: 8px 16px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 500; color: #6b7280;">
          ğŸ”” PushPlusé…ç½®
         </button>
         <button class="settings-tab" id="settings-tab-import" onclick="FutureRadar.switchSettingsTab('import')" style="padding: 8px 16px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 500; color: #6b7280;">
          ğŸ“¥ çˆ¬è™«å¯¼å…¥
         </button>
        </div>
        <!-- PushPlusé…ç½®æ ‡ç­¾é¡µ -->
        <div class="settings-content" id="settings-content-push">
         <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">
           PushPlus Token
          </label>
          <input id="radar-push-token" placeholder="è¯·è¾“å…¥æ‚¨çš„PushPlus Token" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;" type="text"/>
          <p style="margin-top: 8px; font-size: 12px; color: #6b7280;">
           ğŸ“Œ å¦‚ä½•è·å–Token: è®¿é—®
           <a href="https://www.pushplus.plus/" style="color: #3b82f6;" target="_blank">
            pushplus.plus
           </a>
           æ³¨å†Œå¹¶è·å–æ‚¨çš„ä¸“å±Token
          </p>
         </div>
         <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; font-size: 13px; color: #4b5563;">
          <div style="font-weight: 600; margin-bottom: 8px;">
           ğŸ’¡ åŠŸèƒ½è¯´æ˜
          </div>
          <ul style="margin: 0; padding-left: 20px;">
           <li>
            æ¯å¤©é¦–æ¬¡æ‰“å¼€ç³»ç»Ÿæ—¶è‡ªåŠ¨æ£€æŸ¥å¾…åŠäº‹é¡¹
           </li>
           <li>
            å°†ç¬¦åˆæé†’æ¡ä»¶çš„äº‹ä»¶æ¨é€åˆ°æ‚¨çš„è®¾å¤‡
           </li>
           <li>
            é‡è¦äº‹ä»¶ä¼šåœ¨å‰©ä½™3å¤©å†…å¼ºåˆ¶æé†’
           </li>
          </ul>
         </div>
        </div>
        <!-- çˆ¬è™«å¯¼å…¥æ ‡ç­¾é¡µ -->
        <div class="settings-content" id="settings-content-import" style="display:none">
         <p class="text-muted" style="margin-bottom: 12px;">
          è¯·ç²˜è´´æ¥è‡ª
          <strong>
           åç¾¿é‡‡é›†å™¨ / Web Scraper
          </strong>
          çš„ JSON æ•°ç»„ï¼š
         </p>
         <p class="text-xs text-muted" style="margin-bottom: 12px; font-size: 12px; color: #6b7280;">
          æ”¯æŒå­—æ®µè‡ªåŠ¨åŒ¹é…ï¼šTitle/Name, Date/Time, Location/Address, Content/Description
         </p>
         <textarea id="json-import-area" placeholder='[{"title":"2026å¹´æ•°å­—äººæ–‡å¹´ä¼š","date":"2026-03-15","location":"åŒ—äº¬å¤§å­¦","content":"å…³äº..."}]' style="width: 100%; height: 250px; font-family: monospace; font-size: 12px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;"></textarea>
         <div style="margin-top: 12px;">
          <button class="btn btn-success" onclick="FutureRadar.processImport()" style="width: 100%;">
           ğŸš€ è§£æå¹¶å¯¼å…¥åˆ° [ä¸´æ—¶Â·å­¦æœ¯]
          </button>
         </div>
        </div>
       </div>
       <div class="modal-footer">
        <button class="modal-button btn-secondary" onclick="FutureRadar.closeSettingsModal()">
         å…³é—­
        </button>
        <button class="modal-button btn-primary" onclick="FutureRadar.saveSettings()">
         ğŸ’¾ ä¿å­˜é…ç½®
        </button>
       </div>
      </div>
     </div>
     <style>
      /* è¡¥å…¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
     .settings-tab.active{color:#3b82f6 !important;border-bottom-color:#3b82f6 !important;}.settings-tab:hover{color:#3b82f6 !important;}
     </style>
  <script>
   // ================================================================
// æœªæ¥äº‹ä»¶é›·è¾¾ç³»ç»Ÿ v3.0 (å››è±¡é™é‡æ„ç‰ˆ)
// åŠŸèƒ½ï¼šå››åˆ†ç±»ç®¡ç†ã€æŠ˜å å±•å¼€ã€Web Scraperå¯¼å…¥ã€PushPlusé›†æˆã€äº‘ç«¯åŒæ­¥
// ================================================================
class FutureRadarSystemV3 {
    constructor() {
        this.storageKey = 'tpi_radar_events_v3';
        this.pushKey = 'tpi_radar_push_config';
        // æ•°æ®ç»“æ„ v3
        this.data = {
            tempLife: [],       // ä¸´æ—¶Â·ç”Ÿæ´»
            tempAcademic: [],   // ä¸´æ—¶Â·å­¦æœ¯
            regularLife: [],    // å¸¸è§„Â·ç”Ÿæ´»
            regularAcademic: [] // å¸¸è§„Â·å­¦æœ¯
        };
        // æ¨é€é…ç½®
        this.pushConfig = { token: '', lastCheck: '' };
        this.categories = {
            tempLife: "âš¡ ä¸´æ—¶Â·ç”Ÿæ´»",
            tempAcademic: "ğŸ“ ä¸´æ—¶Â·å­¦æœ¯",
            regularLife: "ğŸ“… å¸¸è§„Â·ç”Ÿæ´»",
            regularAcademic: "ğŸ« å¸¸è§„Â·å­¦æœ¯"
        };
    }
// æ–°å¢ï¼šæ—¶é—´è¾“å…¥æ¡†è”åŠ¨æ§åˆ¶
    toggleRadarTimeInputs() {
        const modeElement = document.getElementById('radar-time-mode');
        const container = document.getElementById('time-inputs-wrapper');
        const startInput = document.getElementById('radar-time-start');
        const endInput = document.getElementById('radar-time-end');
        
        if (!modeElement || !container || !startInput || !endInput) return;

        const mode = modeElement.value;

        if (mode === 'none') {
            container.style.display = 'none';
            startInput.style.display = 'none';
            endInput.style.display = 'none';
        } else if (mode === 'start') {
            container.style.display = 'flex';
            startInput.style.display = 'block';
            endInput.style.display = 'none';
        } else if (mode === 'range') {
            container.style.display = 'flex';
            startInput.style.display = 'block';
            endInput.style.display = 'block';
        }
    }
    init() {
        this.loadData();
        this.render();
        this.checkPushOnLoad();
    }

    reload() {
        this.loadData();
        this.render();
    }

    loadData() {
        // å°è¯•åŠ è½½ v3 æ•°æ®
        const saved = localStorage.getItem(this.storageKey);
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                this.data = { ...this.data, ...parsed };
            } catch (e) { console.error('é›·è¾¾æ•°æ®è§£æå¤±è´¥', e); }
        } else {
            // å°è¯•ä» v2 è¿ç§» (ç®€æ˜“è¿ç§»)
            const v2 = localStorage.getItem('tpi_radar_events_v2');
            if (v2) {
                try {
                    const oldData = JSON.parse(v2);
                    if (oldData.temp) this.data.tempLife = oldData.temp;
                    if (oldData.regular) this.data.regularLife = oldData.regular;
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                } catch (e) {}
            }
        }
        // åŠ è½½æ¨é€é…ç½®
        const savedPush = localStorage.getItem(this.pushKey);
        if (savedPush) {
            try { this.pushConfig = JSON.parse(savedPush); } catch (e) {}
        }
    }

    saveData() {
        localStorage.setItem(this.storageKey, JSON.stringify(this.data));
        this.render();
        // âœ… [è‰ç¨¿54 Patch] é›·è¾¾æ•°æ®å˜æ›´ â†’ è§¦å‘å…¨å±€ dirty æ ‡è®° + æœ¬åœ°å¿«ç…§
        // æ–¹æ³•ï¼šå¾€éšè— misc-records-json textarea æ´¾å‘ä¸€ä¸ª inputï¼Œè®©å…¨å±€ç›‘å¬å™¨æ•è·
        // ï¼ˆè¯¥ textarea å§‹ç»ˆåœ¨ DOM é‡Œï¼Œä¸”è¢«å…¨å±€ç›‘å¬å™¨ç›‘æ§ï¼‰
        try {
          const _sentinel = document.getElementById('misc-records-json');
          if (_sentinel) _sentinel.dispatchEvent(new Event('input', { bubbles: true }));
        } catch (_e) {}
    }

    // ================= UI æ¸²æŸ“æ ¸å¿ƒ =================
    render() {
        // æ¸²æŸ“å››ä¸ªæ¿å—
        Object.keys(this.data).forEach(key => this.renderSection(key));
        this.updateBadges();
    }

   renderSection(key) {
        const listContainer = document.getElementById(`list-${key}`);
        const doneContainer = document.getElementById(`list-${key}-done`);
        if (!listContainer || !doneContainer) return;
        listContainer.innerHTML = '';
        doneContainer.innerHTML = '';

        const items = this.data[key] || [];

        // 0. ç©ºçŠ¶æ€ä¼˜åŒ–ï¼šå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæ¿€åŠ±æ’ç”»
        if (items.length === 0) {
            listContainer.innerHTML = `
                <div style="text-align:center; padding: 30px 10px; color:#adb5bd;">
                    <div style="font-size: 40px; margin-bottom: 10px;">ğŸï¸</div>
                    <div>å½“å‰æ— å¾…åŠäº‹ä»¶</div>
                    <div style="font-size: 12px; margin-top:5px;">äº«å—è¿™æ®µæ¸…ç©ºçš„æ—¶å…‰å§ï¼</div>
                </div>
            `;
            return;
        }

        // åˆ†ç¦»å·²å®Œæˆå’Œæœªå®Œæˆ
        const pending = items.filter(i => !i.completed).sort((a, b) => {
            // 1. ä¼˜å…ˆæŒ‰é‡è¦æ€§æ’åº (é‡è¦åœ¨å‰)
            if (!!a.isImportant !== !!b.isImportant) {
                return a.isImportant ? -1 : 1;
            }
            // 2. å…¶æ¬¡æŒ‰å‰©ä½™å¤©æ•°æ’åº (è¿‘çš„åœ¨å‰)
            return this.daysLeft(a.date) - this.daysLeft(b.date);
        });
        const done = items.filter(i => i.completed).sort((a, b) => new Date(b.date) - new Date(a.date));

        // æ¸²æŸ“å¾…åŠ
        if (pending.length === 0) {
            listContainer.innerHTML = `
                <div style="text-align:center; padding: 20px 10px; color:#10b981;">
                    <div style="font-size: 24px; margin-bottom: 5px;">ğŸ‰</div>
                    <div style="font-size: 13px;">å…¨éƒ¨å®Œæˆï¼Œå¤ªæ£’äº†ï¼</div>
                </div>
            `;
        } else {
            pending.forEach(item => listContainer.innerHTML += this.createCardHtml(key, item));
        }

        // æ¸²æŸ“å·²å®Œæˆ (æŠ˜å )
        if (done.length > 0) {
            doneContainer.innerHTML = `<div style="padding:10px; font-weight:600; color:#6b7280; font-size:12px; cursor:pointer; border-top: 1px dashed #e5e7eb; margin-top: 5px;" onclick="this.parentElement.classList.toggle('collapsed')">âœ… å·²å®Œæˆ (${done.length}) <span style="font-size:10px; opacity:0.7;">(ç‚¹å‡»å±•å¼€/æŠ˜å )</span> â–¼</div>`;
            done.forEach(item => doneContainer.innerHTML += this.createCardHtml(key, item));
        } else {
            doneContainer.innerHTML = '';
        }
    }

createCardHtml(key, item) {
        const days = this.daysLeft(item.date);
        const isImportant = item.isImportant || false;
        const isDone = item.completed;

        // 1. ç”Ÿæˆæ ‡ç­¾ (é‡å¤ + æé†’)
        let tagsHtml = '';

        // é‡å¤æ ‡ç­¾
        if (item.recurrence && item.recurrence !== 'none') {
            const map = { weekly: 'ğŸ”æ¯å‘¨', monthly: 'ğŸ”æ¯æœˆ', yearly: 'ğŸ”æ¯å¹´', ebbinghaus: 'ğŸ§ è®°å¿†æ›²çº¿' };
            let recurrenceText = map[item.recurrence] || 'ğŸ”';

            // æ·»åŠ é‡å¤æ¬¡æ•°ä¿¡æ¯
            if (item.recurrenceCount && item.recurrenceCount !== 'unlimited') {
                recurrenceText += ` Ã—${item.recurrenceCount}`;
            }

            // æ·»åŠ é˜´é˜³å†ä¿¡æ¯ï¼ˆä»…å¯¹yearlyç±»å‹ï¼‰
            if (item.recurrence === 'yearly' && item.calendarType) {
                const calendarSymbol = item.calendarType === 'lunar' ? 'ğŸŒ™(é˜´å†)' : 'ğŸŒ(é˜³å†)';
                recurrenceText += calendarSymbol;
            }

            tagsHtml += `<span class="event-tag" style="background:#fef3c7; color:#d97706;">${recurrenceText}</span>`;
        }

        // æé†’è¯¦æƒ…æ ‡ç­¾
        if (!isDone && item.reminderActive) {
            const advance = item.remindAdvanceDays || 0;
            const sameday = item.remindSameDayMins || 0;
            if (advance > 0 || sameday > 0) {
                tagsHtml += `<span class="event-tag" style="background:#e0f2fe; color:#0284c7;">ğŸ”” ${advance>0 ? 'æå‰'+advance+'å¤©' : ''} ${sameday>0 ? sameday+'åˆ†' : ''}</span>`;
            }
        }

        // é™„ä»¶æ˜¾ç¤ºç”Ÿæˆ
        let attachmentHtml = '';
        if (item.attachments && item.attachments.length > 0) {
            attachmentHtml = `
                <div style="margin-top:6px; font-size:11px; color:#4b5563; background:#f3f4f6; padding:4px 8px; border-radius:4px; display:inline-block;">
                    ğŸ“ åŒ…å« ${item.attachments.length} ä¸ªé™„ä»¶: <span style="font-style:italic;">${item.attachments.join(', ')}</span>
                </div>
            `;
        }

        // 2. å·²å®ŒæˆçŠ¶æ€
        if (isDone) {
            return `
                <div class="event-item" style="opacity:0.6; background:#f3f4f6;">
                    <div style="flex:1; color:#6b7280;">
                        <span style="text-decoration:line-through;">${item.title}</span>
                        ${tagsHtml}
                        ${attachmentHtml}
                    </div>
                    <div class="event-actions" style="opacity:1;">
                        <span class="delete-btn" onclick="FutureRadar.toggleStatus('${key}', '${item.id}')" title="æ’¤é”€å®Œæˆ">â†©</span>
                        <span class="delete-btn" onclick="FutureRadar.deleteEvent('${key}', '${item.id}')" title="åˆ é™¤">ğŸ—‘ï¸</span>
                    </div>
                </div>`;
        }

        // 3. æœªå®ŒæˆçŠ¶æ€ - æ™ºèƒ½è§†è§‰
        let borderClass = 'transparent';
        let dateColor = '#2563eb';
        let rowStyle = '';
        let urgencyIcon = 'ğŸ“…';

        if (days < 0) {
            borderClass = '#9ca3af'; dateColor = '#6b7280'; rowStyle = 'opacity:0.8; background:#f9fafb;'; urgencyIcon = 'â¹ï¸';
        } else if (days <= 3) {
            borderClass = '#ef4444'; dateColor = '#dc2626'; urgencyIcon = 'ğŸ”¥';
            if (isImportant) rowStyle = 'background:#fef2f2;';
        } else if (days <= 7) {
            borderClass = '#f59e0b'; dateColor = '#d97706'; urgencyIcon = 'âš ï¸';
            if (isImportant) rowStyle = 'background:#fffbeb;';
        } else {
            borderClass = isImportant ? '#f59e0b' : (item.reminderActive ? '#10b981' : 'transparent');
            if (isImportant) rowStyle = 'background:linear-gradient(to right, #fffbeb, #ffffff);';
        }

        const starIcon = isImportant ? 'â­ ' : '';

        return `
            <div class="event-item" style="border-left: 4px solid ${borderClass}; ${rowStyle} margin-bottom: 5px;">
                <div class="event-date-box" style="min-width: 60px; text-align: center; margin-right: 15px;">
                    <span class="d-block fw-bold fs-5" style="color: ${dateColor}; line-height: 1;">
                        ${days < 0 ? 'è¿‡æœŸ' : days}
                    </span>
                    <small class="text-muted" style="font-size: 10px;">${days < 0 ? Math.abs(days)+'å¤©' : 'å¤©å'}</small>
                </div>

                <div class="ms-2 me-auto" style="flex: 1; padding: 5px 0;" onclick="this.parentElement.classList.toggle('expanded')">
                    <div class="fw-bold">
                        ${starIcon}${urgencyIcon} ${item.title}
                        ${tagsHtml}
                    </div>
                    <div class="event-meta" style="font-size:12px; color:#6b7280; margin-top:2px;">
                        <span>ğŸ“… ${item.date} ${
                            item.timeMode === 'start' ? 'ğŸ•’ ' + item.timeStart : 
                            (item.timeMode === 'range' ? 'ğŸ•’ ' + item.timeStart + ' - ' + item.timeEnd : '')
                        }</span>
                        ${item.location ? `<span>ğŸ“ ${item.location}</span>` : ''}
                    </div>

                    ${item.content || item.remarks || attachmentHtml ? `
                    <div class="event-content-detail" style="margin-top:6px; font-size:12px; color:#374151;">
                        ${item.content ? `<div style="margin-bottom:2px;">ğŸ“ ${item.content}</div>` : ''}
                        ${item.remarks ? `<div style="white-space:pre-wrap;">ğŸ“Œ ${item.remarks}</div>` : ''}
                        ${attachmentHtml}
                    </div>` : ''}
                </div>

                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="FutureRadar.editEvent('${key}', '${item.id}')" title="ç¼–è¾‘">âœï¸</button>
                    <button class="btn btn-outline-success" onclick="FutureRadar.toggleStatus('${key}', '${item.id}')" title="å®Œæˆ">âœ…</button>
                    <button class="btn btn-outline-danger" onclick="FutureRadar.deleteEvent('${key}', '${item.id}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                </div>
            </div>
        `;
    }
    // ================= é€»è¾‘æ“ä½œ =================
   openModal(type) {
        const modalElem = document.getElementById('radar-modal');
        if (modalElem) modalElem.style.display = 'flex';
        
        const typeElem = document.getElementById('radar-event-type');
        if (typeElem) typeElem.value = type;
        
        const idElem = document.getElementById('radar-event-id');
        if (idElem) idElem.value = '';
        
        const titleElem = document.getElementById('radar-modal-title');
        if (titleElem) titleElem.innerText = `æ·»åŠ  - ${this.categories[type]}`;
        
        const formElem = document.getElementById('radar-form');
        if (formElem) formElem.reset();
        
        const dateElem = document.getElementById('radar-date');
        if (dateElem) dateElem.valueAsDate = new Date();

        // åˆå§‹åŒ–æ–°å­—æ®µçŠ¶æ€
        const timeModeElem = document.getElementById('radar-time-mode');
        if (timeModeElem) timeModeElem.value = 'start';
        
        this.toggleRadarTimeInputs(); // åˆ·æ–°UIæ˜¾ç¤º
        
        const fileListElem = document.getElementById('file-list-display');
        if (fileListElem) fileListElem.innerText = '';
        
        const remindAdvElem = document.getElementById('radar-remind-advance');
        if (remindAdvElem) remindAdvElem.value = '1';
        
        const remindSamElem = document.getElementById('radar-remind-sameday');
        if (remindSamElem) remindSamElem.value = '0';
    }

    closeModal() {
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    }

   saveEvent() {
        const type = document.getElementById('radar-event-type')?.value;
        const id = document.getElementById('radar-event-id')?.value;
        const recurrenceVal = document.getElementById('radar-recurrence')?.value || 'none';
        let calendarTypeVal = 'solar';
        if (recurrenceVal === 'yearly') {
            const calTypeElem = document.getElementById('radar-calendar-type');
            calendarTypeVal = calTypeElem ? calTypeElem.value : 'solar';
        }

        // è·å–é‡å¤æ¬¡æ•°
        const recCountElem = document.getElementById('radar-recurrence-count');
        const recurrenceCountVal = recCountElem ? recCountElem.value : '';

        // å¤„ç†æ–°å­—æ®µ
        const timeModeElem = document.getElementById('radar-time-mode');
        const timeMode = timeModeElem ? timeModeElem.value : 'start';
        const timeStartElem = document.getElementById('radar-time-start');
        const timeStart = timeStartElem ? timeStartElem.value : '';
        const timeEndElem = document.getElementById('radar-time-end');
        const timeEnd = timeEndElem ? timeEndElem.value : '';
        
        // æ„å»ºå…¼å®¹æ—§é€»è¾‘çš„æ—¶é—´å­—ç¬¦ä¸²
        let timeStr = '';
        if (timeMode === 'start') timeStr = timeStart;
        else if (timeMode === 'range') timeStr = `${timeStart}-${timeEnd}`;

        // å¤„ç†é™„ä»¶ (ä»…å­˜æ–‡ä»¶å)
        const fileInput = document.getElementById('radar-files');
        const fileList = [];
        if (fileInput && fileInput.files && fileInput.files.length > 0) {
            for (let i = 0; i < fileInput.files.length; i++) fileList.push(fileInput.files[i].name);
        }

        const titleElem = document.getElementById('radar-title');
        const contentElem = document.getElementById('radar-content');
        const dateElem = document.getElementById('radar-date');
        const locationElem = document.getElementById('radar-location');
        const organizerElem = document.getElementById('radar-organizer');
        const remarksElem = document.getElementById('radar-remarks');
        const remindAdvanceElem = document.getElementById('radar-remind-advance');
        const remindSamedayElem = document.getElementById('radar-remind-sameday');
        const reminderActiveElem = document.getElementById('radar-reminder-active');
        const importantElem = document.getElementById('radar-important');

        const newEvent = {
            id: id || ('evt_' + Date.now()),
            title: titleElem ? titleElem.value : '',
            content: contentElem ? contentElem.value : '',
            date: dateElem ? dateElem.value : '',

            // æ–°æ—¶é—´å­—æ®µ
            timeMode: timeMode,
            timeStart: timeStart,
            timeEnd: timeEnd,
            time: timeStr, // å…¼å®¹æ˜¾ç¤º

            location: locationElem ? locationElem.value : '',
            organizer: organizerElem ? organizerElem.value : '',
            remarks: remarksElem ? remarksElem.value : '',
            attachments: fileList, // é™„ä»¶åˆ—è¡¨

            // åŒé‡æé†’
            remindAdvanceDays: remindAdvanceElem ? remindAdvanceElem.value : '1',
            remindSameDayMins: remindSamedayElem ? remindSamedayElem.value : '0',
            remindDays: remindAdvanceElem ? remindAdvanceElem.value : '1', // å…¼å®¹å­—æ®µ

            reminderActive: reminderActiveElem ? reminderActiveElem.checked : true,
            isImportant: importantElem ? importantElem.checked : false,
            recurrence: recurrenceVal,
            calendarType: calendarTypeVal,
            recurrenceCount: recurrenceCountVal, // æ–°å¢ï¼šé‡å¤æ¬¡æ•°
            completed: false
        };

        if (!newEvent.title || !newEvent.date) return alert('æ ‡é¢˜å’Œæ—¥æœŸå¿…å¡«');

        const index = this.data[type].findIndex(i => i.id === id);
        if (id && index > -1) {
            newEvent.completed = this.data[type][index].completed;
            this.data[type][index] = newEvent;
        } else {
            this.data[type].push(newEvent);
        }
        this.saveData();
        this.closeModal();
        if(typeof NotifySystem !== 'undefined') NotifySystem.showToast('âœ… äº‹ä»¶å·²ä¿å­˜ (ç¬¬ 20 ç‰ˆ)');
    }
editEvent(key, id) {
        const item = this.data[key].find(i => i.id === id);
        if (!item) return;
        this.openModal(key);
        document.getElementById('radar-modal-title').innerText = `ç¼–è¾‘ - ${this.categories[key]}`;

        document.getElementById('radar-event-id').value = item.id;
        document.getElementById('radar-title').value = item.title;
        document.getElementById('radar-content').value = item.content || '';
        document.getElementById('radar-date').value = item.date;

        // å›å¡«æ–°æ—¶é—´å­—æ®µ
        document.getElementById('radar-time-mode').value = item.timeMode || 'start';
        document.getElementById('radar-time-start').value = item.timeStart || item.time || '';
        document.getElementById('radar-time-end').value = item.timeEnd || '';
        this.toggleRadarTimeInputs(); // åˆ·æ–°

        document.getElementById('radar-location').value = item.location || '';
        document.getElementById('radar-organizer').value = item.organizer || '';
        document.getElementById('radar-remarks').value = item.remarks || '';

        // å›å¡«é™„ä»¶æ˜¾ç¤º
        if (item.attachments && item.attachments.length) {
            document.getElementById('file-list-display').innerText = `åŒ…å« ${item.attachments.length} ä¸ªé™„ä»¶: ${item.attachments.join(', ')}`;
        }

        // å›å¡«æ–°æé†’
        document.getElementById('radar-remind-advance').value = item.remindAdvanceDays || item.remindDays || 1;
        document.getElementById('radar-remind-sameday').value = item.remindSameDayMins || 0;

        document.getElementById('radar-reminder-active').checked = item.reminderActive !== false;
        if (document.getElementById('radar-important')) {
            document.getElementById('radar-important').checked = item.isImportant || false;
        }
        document.getElementById('radar-recurrence').value = item.recurrence || 'none';
        this.toggleRecurrenceOptions();
        if (item.calendarType && document.getElementById('radar-calendar-type')) {
            document.getElementById('radar-calendar-type').value = item.calendarType;
        }
        // å›å¡«é‡å¤æ¬¡æ•°
        if (item.recurrenceCount && document.getElementById('radar-recurrence-count')) {
            document.getElementById('radar-recurrence-count').value = item.recurrenceCount;
        }
    }    deleteEvent(key, id) {
        if (!confirm('ç¡®å®šåˆ é™¤?')) return;
        this.data[key] = this.data[key].filter(i => i.id !== id);
        this.saveData();
        this.render(); // é‡æ–°æ¸²æŸ“UI
        if(typeof NotifySystem !== 'undefined') NotifySystem.showToast('ğŸ—‘ï¸ äº‹ä»¶å·²åˆ é™¤');
    }

    toggleStatus(key, id) {
        const item = this.data[key].find(i => i.id === id);
        if (item) {
            item.completed = !item.completed;
            this.saveData();
            this.render(); // é‡æ–°æ¸²æŸ“UI
            if(typeof NotifySystem !== 'undefined') {
                NotifySystem.showToast(item.completed ? 'âœ… å·²æ ‡è®°ä¸ºå®Œæˆ' : 'â†©ï¸ å·²æ’¤é”€å®Œæˆ');
            }
        }
    }

    // ================= å¯¼å…¥åŠŸèƒ½ =================
    openImportModal() { document.getElementById('radar-import-modal').style.display = 'flex'; }

    processImport() {
        try {
            const raw = document.getElementById('json-import-area').value;
            const arr = JSON.parse(raw);
            if (!Array.isArray(arr)) throw new Error('å¿…é¡»æ˜¯ JSON æ•°ç»„');

            let count = 0;
            arr.forEach(e => {
                // æ™ºèƒ½æ˜ å°„
                const title = e.title || e.name || e.æ´»åŠ¨åç§° || e.æ ‡é¢˜ || e.è¯¾ç¨‹;
                const date = e.date || e.time || e.æ—¶é—´ || e.æ—¥æœŸ; // éœ€æ¸…æ´—ä¸º YYYY-MM-DD

                if (title) {
                    this.data.tempAcademic.push({
                        id: 'imp_' + Date.now() + Math.random(),
                        title: title,
                        content: e.content || e.description || e.ç®€ä»‹ || '',
                        date: this.parseDate(date),
                        location: e.location || e.address || e.åœ°ç‚¹ || '',
                        organizer: e.organizer || e.ä¸»åŠæ–¹ || '',
                        remindDays: 1,
                        reminderActive: true,
                        completed: false
                    });
                    count++;
                }
            });
            this.saveData();
            this.closeSettingsModal();

            if (typeof NotifySystem !== 'undefined') {
                NotifySystem.showToast(`âœ… æˆåŠŸå¯¼å…¥ ${count} æ¡æ•°æ®`);
            } else {
                this.showSimpleNotification(`âœ… æˆåŠŸå¯¼å…¥ ${count} æ¡æ•°æ®`, 'success');
            }
        } catch (e) {
            alert('JSON æ ¼å¼é”™è¯¯: ' + e.message);
        }
    }

    parseDate(str) {
        if (!str) return new Date().toISOString().split('T')[0];
        // ç®€å•å°è¯•æå–æ—¥æœŸ YYYY-MM-DD
        const match = str.match(/\d{4}-\d{2}-\d{2}/);
        return match ? match[0] : new Date().toISOString().split('T')[0];
    }

    // ================= è¾…åŠ© =================
    daysLeft(dateStr) {
        const today = new Date(); today.setHours(0,0,0,0);
        const target = new Date(dateStr);
        return Math.ceil((target - today) / (86400000));
    }

    toggleSection(id) {
        const el = document.getElementById(id);
        if(el) el.classList.toggle('collapsed');
    }

    updateBadges() {
        Object.keys(this.data).forEach(key => {
            const el = document.getElementById(`badge-${key}-count`);
            if (el) el.innerText = this.data[key].filter(i => !i.completed).length;
        });
    }

    // ================= PushPlus é›†æˆ =================
    openPushSettings() {
        console.log('[FutureRadar] æ‰“å¼€è®¾ç½®å¼¹çª—');
        console.log('[FutureRadar] å½“å‰PushPlus Token:', this.pushConfig.token ? 'å·²é…ç½®' : 'æœªé…ç½®');
        
        // æ‰“å¼€è®¾ç½®å¼¹çª—å¹¶åŠ è½½å½“å‰é…ç½®
        document.getElementById('radar-settings-modal').style.display = 'flex';
        document.getElementById('radar-push-token').value = this.pushConfig.token || '';
        this.switchSettingsTab('push'); // é»˜è®¤æ˜¾ç¤ºPushPlusé…ç½®é¡µ
        
        console.log('[FutureRadar] è®¾ç½®å¼¹çª—å·²æ‰“å¼€ï¼Œé»˜è®¤æ˜¾ç¤ºPushPlusé…ç½®é¡µ');
    }

    closeSettingsModal() {
        document.getElementById('radar-settings-modal').style.display = 'none';
    }

    switchSettingsTab(tabName) {
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        const tabs = ['push', 'import'];
        tabs.forEach(tab => {
            const tabBtn = document.getElementById(`settings-tab-${tab}`);
            const content = document.getElementById(`settings-content-${tab}`);
            if (tab === tabName) {
                tabBtn.classList.add('active');
                content.style.display = 'block';
            } else {
                tabBtn.classList.remove('active');
                content.style.display = 'none';
            }
        });
    }

    saveSettings() {
        // ä¿å­˜PushPlusé…ç½®
        const token = document.getElementById('radar-push-token').value.trim();
        this.pushConfig.token = token;
        localStorage.setItem(this.pushKey, JSON.stringify(this.pushConfig));

        if (typeof NotifySystem !== 'undefined') {
            NotifySystem.showToast('âœ… é…ç½®å·²ä¿å­˜');
        } else {
            this.showSimpleNotification('âœ… é…ç½®å·²ä¿å­˜', 'success');
        }

        this.closeSettingsModal();
    }

    // ä¿ç•™åŸæœ‰çš„openImportModalæ–¹æ³•ä»¥å…¼å®¹ï¼Œä½†æ”¹ä¸ºæ‰“å¼€è®¾ç½®å¼¹çª—çš„å¯¼å…¥æ ‡ç­¾é¡µ
    openImportModal() {
        document.getElementById('radar-settings-modal').style.display = 'flex';
        this.switchSettingsTab('import');
    }

    async checkPushOnLoad() {
        // å¦‚æœæ²¡æœ‰é…ç½®token,ç›´æ¥è¿”å›
        if (!this.pushConfig.token) {
            return;
        }

        const today = (typeof __tpi_getSelectedDate === 'function') ? __tpi_getSelectedDate() : (()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;})();

        // å¦‚æœä»Šå¤©å·²ç»æ£€æŸ¥è¿‡,è·³è¿‡
        if (this.pushConfig.lastCheck === today) {
            return;
        }

        // æ”¶é›†æ‰€æœ‰æ¿å—ä¸­å¼€å¯æé†’ä¸”æœªå®Œæˆçš„äº‹ä»¶
        let msgs = [];
        let eventCount = 0;

        Object.keys(this.data).forEach(category => {
            this.data[category].forEach(i => {
                eventCount++;
                if (!i.completed && i.reminderActive) {
                    const d = this.daysLeft(i.date);
                    // é€»è¾‘ï¼šåˆ°è¾¾ç”¨æˆ·è®¾å®šçš„æé†’å¤©æ•° OR å±äºé‡è¦äº‹ä»¶ä¸”å‰©ä½™3å¤©å†…(å¼ºåˆ¶æé†’)
                    if ((d >= 0 && d <= i.remindDays) || (i.isImportant && d <= 3 && d >= 0)) {
                        let prefix = '';
                        if (i.isImportant) prefix += 'â­';
                        if (d <= 1) prefix += 'ğŸ”¥';
                        else if (d <= 3) prefix += 'âš ï¸';

                        msgs.push(`${prefix} ${i.title} [å‰©${d}å¤©]`);
                    }
                }
            });
        });

        if (msgs.length > 0) {
            try {

                const response = await fetch('http://www.pushplus.plus/send', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        token: this.pushConfig.token,
                        title: `TPI æé†’: ${msgs.length}ä¸ªå¾…åŠ`,
                        content: msgs.join('\n\n'),
                        template: 'txt'
                    })
                });

                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (response.ok) {
                    const result = await response.json();

                    // æ›´æ–°æœ€åæ£€æŸ¥æ—¶é—´
                    this.pushConfig.lastCheck = today;
                    localStorage.setItem(this.pushKey, JSON.stringify(this.pushConfig));

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    if (typeof NotifySystem !== 'undefined') {
                        NotifySystem.showToast(`ğŸ”” å·²æ¨é€${msgs.length}ä¸ªæé†’åˆ°æ‚¨çš„è®¾å¤‡`);
                    } else {
                        this.showSimpleNotification(`âœ… å·²æ¨é€${msgs.length}ä¸ªæé†’`, 'success');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

            } catch(e) {
                console.error('âŒ Pushplusæ¨é€å¤±è´¥:', e);

                // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
                if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
                    this.showSimpleNotification('âš ï¸ ç½‘ç»œè¿æ¥å¤±è´¥,æ— æ³•å‘é€æé†’', 'warning');
                } else if (e.message.includes('HTTP 400')) {
                    this.showSimpleNotification('âš ï¸ Pushplus tokenæ— æ•ˆ,è¯·æ£€æŸ¥é…ç½®', 'error');
                } else {
                    this.showSimpleNotification('âš ï¸ æ¨é€æœåŠ¡æš‚æ—¶ä¸å¯ç”¨', 'warning');
                }
            }
        } else {
            this.pushConfig.lastCheck = today;
            localStorage.setItem(this.pushKey, JSON.stringify(this.pushConfig));
        }
    }

    // ç®€å•é€šçŸ¥æ˜¾ç¤ºå‡½æ•°(å¤‡ç”¨)
    showSimpleNotification(message, type = 'info') {
        const colors = {
            success: '#10b981',
            warning: '#f59e0b',
            error: '#ef4444',
            info: '#3b82f6'
        };

        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colors[type]};
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            max-width: 350px;
            animation: slideInRight 0.3s ease-out;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
}

const FutureRadar = new FutureRadarSystemV3();
window.FutureRadar = FutureRadar; // æš´éœ²ç»™æ’ä»¶ä½¿ç”¨
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => FutureRadar.init());
else FutureRadar.init();

// åŒ…è£…openModalå‡½æ•°ä»¥æ·»åŠ æ§åˆ¶å°æ—¥å¿—
(function() {
    const originalOpenModal = FutureRadar.openModal.bind(FutureRadar);
    
    FutureRadar.openModal = function(type) {
        console.log('ğŸ¯ [FutureRadar.openModal] è¢«è°ƒç”¨');
        console.log('ğŸ¯ [FutureRadar.openModal] ç±»å‹:', type);
        console.log('ğŸ¯ [FutureRadar.openModal] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        const typeNames = {
            'tempLife': 'âš¡ ç”Ÿæ´»ä¸´æ—¶',
            'tempAcademic': 'ğŸ“ å­¦æœ¯ä¸´æ—¶',
            'regularLife': 'ğŸ“… ç”Ÿæ´»å¸¸è§„',
            'regularAcademic': 'ğŸ« å­¦æœ¯å¸¸è§„'
        };
        
        const typeName = typeNames[type] || type;
        console.log('ğŸ¯ [FutureRadar.openModal] ç±»å‹åç§°:', typeName);
        
        try {
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨å®Œæ•´çš„æ¨¡æ€æ¡†å…ƒç´ 
            const modalElement = document.getElementById('radar-modal');
            
            if (modalElement && originalOpenModal) {
                // å¦‚æœæ¨¡æ€æ¡†å…ƒç´ å­˜åœ¨ä¸”åŸå§‹å‡½æ•°å­˜åœ¨ï¼Œè°ƒç”¨åŸå§‹å‡½æ•°
                console.log('âœ… [FutureRadar.openModal] è°ƒç”¨åŸå§‹openModalï¼ˆå®Œæ•´æ¨¡æ€æ¡†ï¼‰');
                originalOpenModal(type);
            } else if (modalElement) {
                // å¦‚æœåªæœ‰æ¨¡æ€æ¡†å…ƒç´ ï¼Œç›´æ¥æ˜¾ç¤º
                console.log('âœ… [FutureRadar.openModal] ç›´æ¥æ˜¾ç¤ºæ¨¡æ€æ¡†');
                modalElement.style.display = 'flex';
                modalElement.setAttribute('data-type', type);
                const titleElement = modalElement.querySelector('.modal-title');
                if (titleElement) {
                    titleElement.textContent = typeName;
                }
            } else {
                // æœ€åæ‰æç¤ºä¸å­˜åœ¨
                console.warn('âš ï¸ [FutureRadar.openModal] æ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
                alert(`${typeName} å¼¹çª—\n\nModalå…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚`);
            }
        } catch (error) {
            console.error('âŒ [FutureRadar.openModal] é”™è¯¯:', error);
            console.error('âŒ [FutureRadar.openModal] é”™è¯¯å †æ ˆ:', error.stack);
        }
    };
    
    console.log('âœ… [FutureRadar] openModalå‡½æ•°å·²åŒ…è£…ï¼Œæ·»åŠ æ—¥å¿—åŠŸèƒ½');
})();
  </script>
     <!-- ==================== æ ‡å‡†æ“ä½œç¨‹åº (SOP) ä¸å¡«å†™è§„èŒƒ ==================== -->
     <section class="card fade-in stagger-2 collapsed" id="sop">
      <div class="card-header" onclick="window.TPI.toggleCard('sop')">
       <div class="card-title">
        <span class="icon">
         ğŸ“‹
        </span>
        <span>
         æ ‡å‡†æ“ä½œç¨‹åº (SOP) ä¸å¡«å†™è§„èŒƒ
        </span>
       </div>
      </div>
      <div class="card-content">
       <!-- 1. å¡«æŠ¥æ—¶åº -->
       <div class="rules-section" id="sop-chronology">
        <div class="rules-header" onclick="window.TPI.toggleRules('sop-chronology')">
         <span>
          1. å¡«æŠ¥æ—¶åº (Chronology)
         </span>
        </div>
        <div class="rules-content">
         <div class="alert alert-info mb-4">
          <h4>
           ğŸŒ… æ™¨é—´ (08:00-10:00)
          </h4>
          <p>
           å¡«å†™é¡¶éƒ¨æ—¥æœŸ â†’ å®Œæˆ [æ¯æ—¥å››åˆ†å«] è¯Šæ–­ â†’
           <strong>
            åœ¨ [è±å…å£°æ˜åŒº] ç»Ÿä¸€å¤„ç†ç‰¹æƒ
           </strong>
           â†’ ç¡®å®šä»Šæ—¥ [æ¨¡å¼]ã€‚
          </p>
         </div>
         <div class="alert alert-info mb-4">
          <h4>
           ğŸ”„ è¿‡ç¨‹ (In-Process)
          </h4>
          <ul>
           <li>
            <strong>
             AMI
            </strong>
            : å»ºè®®æ¯å®Œæˆä¸€ä¸ª Block ç«‹å³è®°å½•æ—¶é•¿ä¸å®¢è§‚äº§å‡ºé‡ï¼ˆé¡µæ•°/å­—æ•°ï¼‰ã€‚
            <span style="background: #fee2e2; padding: 2px 6px; border-radius: 3px; font-weight: 600; color: #dc2626;">
             âš ï¸ ä¸¥ç¦æ­¤æ—¶é¢„åˆ¤ä¸“æ³¨ç³»æ•° Fï¼ˆæµ·æ£®å ¡é˜²æŠ–ï¼‰
            </span>
            ã€‚
           </li>
           <li>
            <strong>
             Sys
            </strong>
            : å‘ç”Ÿå³è®°å½•ï¼ˆå¦‚å–æ°´ã€æ‚äº‹ã€ç¦»é¦†ï¼‰ã€‚
           </li>
           <li>
            <strong>
             ğŸ§  è®¤çŸ¥
            </strong>
            : éšæ—¶å‹¾é€‰ [è®¤çŸ¥çŠ¶æ€é€Ÿè®°]ã€‚
           </li>
          </ul>
         </div>
         <div class="alert alert-info mb-4">
          <h4>
           ğŸŒ™ æ™šé—´ (23:00)
          </h4>
          <ul>
           <li>
            å…ˆç»“ç®—
            <strong>
             Parts 2, 3, 4, 5
            </strong>
            (FLI / BCM / Logistics / HSM)ã€‚
           </li>
           <li>
            è®¡ç®—
            <strong>
             Sys
             <sub>
              Net
             </sub>
            </strong>
            (å³ BCM + Logistics + HSM ä¹‹å’Œ)ã€‚
           </li>
           <li>
            <strong>
             AMI è®¡ç®—é¡ºåº
            </strong>
            : å…ˆç®—åŸºç¡€åˆ† ($h \times 2.5$)ï¼Œå†ç®—äº§å‡ºåˆ† (é¡µæ•°/å­—æ•° $\times$ å•ä»· $\times F$)ã€‚
           </li>
           <li>
            æœ€åè®¡ç®—
            <strong>
             TPI
             <sub>
              E
             </sub>
            </strong>
            æ€»åˆ†å¹¶è¯„çº§ã€‚
           </li>
          </ul>
         </div>
        </div>
       </div>
       <!-- 2. æ ¸å¿ƒé€»è¾‘æ¾„æ¸… -->
       <div class="rules-section collapsed" id="sop-logic">
        <div class="rules-header" onclick="window.TPI.toggleRules('sop-logic')">
         <span>
          2. æ ¸å¿ƒé€»è¾‘æ¾„æ¸… (Logic Clarification)
         </span>
        </div>
        <div class="rules-content">
         <div class="alert alert-warning mb-4">
          <h4>
           ğŸ“Š Sys
           <sub>
            Net
           </sub>
           (åŸºçŸ³ç³»ç»Ÿ)
          </h4>
          <p>
           è¿™æ˜¯ä¸€ä¸ªèšåˆæŒ‡æ ‡ã€‚
          </p>
          <p>
           <strong>
            å…¬å¼
           </strong>
           ï¼šSys
           <sub>
            Net
           </sub>
           = BCM (Part 3) + Logistics (Part 4) + HSM (Part 5)
          </p>
          <p class="text-muted">
           <em>
            æ³¨ï¼šPart 3 è™½åä¸º BCMï¼Œä½†ä»…ä»£è¡¨"è¡Œä¸ºçºªå¾‹"ï¼Œéœ€åŠ ä¸Š Part 4/5 æ‰æ˜¯å®Œæ•´çš„ Sys ç³»ç»Ÿã€‚
           </em>
          </p>
         </div>
         <div class="alert alert-danger">
          <h4>
           âš ï¸ AMI è®¡æ•°åŸåˆ™
          </h4>
          <p>
           <strong>
            ä¸¥ç¦åŒé‡è®¡åˆ†
           </strong>
           : è‹¥æŸä»»åŠ¡å·²æŒ‰ [Type D] çš„"å½“é‡æ³•"è®¡åˆ†ï¼Œåˆ™å­—æ•°/é¡µæ•°è®°ä¸º 0ã€‚
          </p>
          <p>
           <strong>
            Type D (ç‰¹æ®Šæ”»åš) å®šä¹‰
           </strong>
           : é’ˆå¯¹
           <strong>
            é«˜ç†µå€¼éšœç¢
           </strong>
           ï¼ˆè¯­è¨€ã€æŠ€æœ¯ã€å²æ–™æ®‹ç¼ºï¼‰è¿›è¡Œçš„
           <strong>
            é«˜æ‘©æ“¦åŠ›
           </strong>
           å·¥ä½œã€‚ç»“ç®—æ—¶é‡‡ç”¨
           <strong>
            å½“é‡äº§å‡ºæ³• (Equivalent Output Units)
           </strong>
           ã€‚
          </p>
         </div>
        </div>
       </div>
       <!-- 3. å¿ƒæ€æ ¡å‡† -->
       <div class="rules-section collapsed" id="sop-mindset">
        <div class="rules-header" onclick="window.TPI.toggleRules('sop-mindset')">
         <span>
          3. å¿ƒæ€æ ¡å‡† (Mindset)
         </span>
        </div>
        <div class="rules-content">
         <div class="axioms-grid">
          <div class="axiom-card">
           <span class="axiom-icon">
            ğŸ¯
           </span>
           <h4 class="axiom-title">
            å»é“å¾·åŒ–
           </h4>
           <p class="axiom-content">
            åˆ†æ•°ä½ä¸ä»£è¡¨"å¤±è´¥"ï¼Œåªä»£è¡¨"éœ€è¦è°ƒæ•´ç­–ç•¥"ã€‚
           </p>
          </div>
          <div class="axiom-card">
           <span class="axiom-icon">
            ğŸ“
           </span>
           <h4 class="axiom-title">
            çœŸå®æ€§
           </h4>
           <p class="axiom-content">
            è¯šå®è®°å½•æ˜¯ç³»ç»Ÿç”Ÿæ•ˆçš„å‰æã€‚ä¸è¦ä¸ºäº†å‡‘åˆ†è€Œä¿®æ”¹ç³»æ•°ã€‚
           </p>
          </div>
         </div>
        </div>
       </div>
      </div>
     </section>
     <!-- ==================== 3. TPI å…¨ç»´æ•ˆèƒ½ä»ªè¡¨ç›˜ ==================== -->
     <section class="card fade-in stagger-3 collapsed" id="quarterback">
      <div class="card-header" onclick="window.TPI.toggleCard('quarterback')">
       <div class="card-title">
        <span class="icon">
         ğŸ§­
        </span>
        <span>
         æ¯æ—¥å››åˆ†å«ï¼šæ¨¡å¼é€‰æ‹©ä¸æ„å›¾å£°æ˜
        </span>
       </div>
      </div>
      <div class="card-content">
       <div class="alert alert-warning mb-6">
        <h4>
         â° æ“ä½œé¡ºåºæç¤º
        </h4>
        <p>
         è¯·åœ¨
         <strong>
          ä¸Šåˆ 10:00 å‰
         </strong>
         è¿›è¡Œè¯Šæ–­ä¸ **[æ„å›¾å£°æ˜]**ã€‚è‹¥ä¸Šåˆå¯åŠ¨æ—¶é—´æ™šäº10:00ï¼Œæˆ–ä¸Šåˆæ—¶æ®µå®Œå…¨å¤±æ•ˆï¼Œåˆ™è‡ªåŠ¨è¿›å…¥
         <strong>
          Â©ï¸ æ–¯å¤šè‘›æ¨¡å¼
         </strong>
         ã€‚
        </p>
       </div>
       <div class="mb-6">
        <h3>
         1ï¸âƒ£ æ€åŠ¿è¯Šæ–­ (Diagnosis v16)
        </h3>
        <div class="grid-2 mt-4">
         <div>
          <h4>
           ğŸ”‹ èº«å¿ƒç”µé‡
          </h4>
          <p class="text-muted mb-3">
           ä»Šæ—¥é†’æ¥æ„Ÿåˆ°ç²¾åŠ›å……æ²›å—ï¼Ÿ
          </p>
          <div style="display: flex; gap: var(--spacing-4);">
           <label style="display: flex; align-items: center; gap: var(--spacing-2);">
            <input aria-label="ç²¾åŠ›å……æ²›" name="energy-level" type="radio" value="high"/>
            <span>
             âœ… æ˜¯ (å……æ²›)
            </span>
           </label>
           <label style="display: flex; align-items: center; gap: var(--spacing-2);">
            <input aria-label="ç²¾åŠ›ä¸è¶³" name="energy-level" type="radio" value="low"/>
            <span>
             âš ï¸ å¦ (ç–²æƒ«/ç”Ÿç—…)
            </span>
           </label>
          </div>
         </div>
         <div>
          <h4>
           ğŸš§ å®¢è§‚å¹²æ‰°
          </h4>
          <p class="text-muted mb-3">
           ä»Šæ—¥æ˜¯å¦æœ‰ &gt;2å°æ—¶ çš„è¡Œæ”¿/æ‚äº‹å ç”¨ï¼Ÿ
          </p>
          <div style="display: flex; gap: var(--spacing-4);">
           <label style="display: flex; align-items: center; gap: var(--spacing-2);">
            <input aria-label="æ— å¹²æ‰°" name="interference" type="radio" value="none"/>
            <span>
             âœ… å¦ (æ— )
            </span>
           </label>
           <label style="display: flex; align-items: center; gap: var(--spacing-2);">
            <input aria-label="æœ‰å¹²æ‰°" name="interference" type="radio" value="major"/>
            <span>
             âš ï¸ æ˜¯ (å¹²æ‰°)
            </span>
           </label>
          </div>
         </div>
        </div>
       </div>
       <!-- è®¤çŸ¥çŠ¶æ€ç›‘æµ‹ [Tier 1 - ç”Ÿå­˜çº¢çº¿] -->
       <div class="alert alert-danger mb-6 tier-1-section">
        <h3>
         ğŸ’­ è®¤çŸ¥çŠ¶æ€é€Ÿè®° (Cognitive Snapshot) [T1]
        </h3>
        <p class="text-muted">
         <em>
          ğŸ‘‡
          <strong>
           å¡«å†™æŒ‡å¼•
          </strong>
          ï¼šæ­¤æ è®°å½•æ‚¨çš„
          <strong>
           ä¸»è§‚æ„Ÿå—
          </strong>
          ï¼Œä¸ä¸“æ³¨ç³»æ•°Fçš„åˆ¤å®šç‹¬ç«‹ã€‚æ— è®ºä¸Šæ–¹åˆ†æ•°å¦‚ä½•ï¼Œè¯·
          <strong>
           è¯šå®å‹¾é€‰
          </strong>
          å½“ä¸‹çš„å¿ƒç†çŠ¶æ€ï¼Œç”¨äºé•¿æœŸæ¨¡å¼è¯†åˆ«ã€‚
         </em>
        </p>
        <p class="text-muted" style="margin-top: 4px;">
         <em>
          ğŸ’¡
          <strong>
           å¡«å†™åŸåˆ™
          </strong>
          ï¼šæ¯æ—¥ä»…éœ€å‹¾é€‰1-2é¡¹æ ¸å¿ƒçŠ¶æ€å³å¯ã€‚è¯šå®è®°å½•æ˜¯ç³»ç»Ÿç”Ÿæ•ˆçš„å‰æã€‚
         </em>
        </p>
        <div class="mt-4">
         <h5>
          ä»Šæ—¥ä¸»è¦çŠ¶æ€ï¼ˆå¯å¤šé€‰ï¼‰
         </h5>
         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-3); margin-top: var(--spacing-3);">
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="å¿ƒæµå……æ²›" name="cognitive-state" type="checkbox" value="flow"/>
           <span>
            ğŸ”¥
            <strong>
             å¿ƒæµå……æ²›
            </strong>
            (æ³¨æ„åŠ›é«˜åº¦é›†ä¸­)
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="å¹³ç¨³æ¨è¿›" name="cognitive-state" type="checkbox" value="steady"/>
           <span>
            ğŸŒŠ
            <strong>
             å¹³ç¨³æ¨è¿›
            </strong>
            (ç¨³å®šè¾“å‡º)
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="ä½èƒ½æ¢å¤" name="cognitive-state" type="checkbox" value="recovery"/>
           <span>
            ğŸŒ±
            <strong>
             ä½èƒ½æ¢å¤
            </strong>
            (å¯å·¥ä½œä½†æ•ˆç‡ä¸é«˜)
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="è®¤çŸ¥æ¸…æ™°" name="cognitive-state" type="checkbox" value="clear"/>
           <span>
            ğŸ§ 
            <strong>
             è®¤çŸ¥æ¸…æ™°
            </strong>
            (é€»è¾‘æ¨æ¼”é¡ºç•…)
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="æ³¨æ„åŠ›æ¶£æ•£" name="cognitive-state" type="checkbox" value="distracted"/>
           <span>
            ğŸ˜¶â€ğŸŒ«ï¸
            <strong>
             æ³¨æ„åŠ›æ¶£æ•£
            </strong>
            (é¢‘ç¹èµ°ç¥)
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="æƒ…ç»ªå†…è€—" name="cognitive-state" type="checkbox" value="anxious"/>
           <span>
            ğŸ˜Ÿ
            <strong>
             æƒ…ç»ªå†…è€—
            </strong>
            (ç„¦è™‘/è‡ªæˆ‘æ€€ç–‘)
           </span>
          </label>
         </div>
        </div>
        <div class="mt-4">
         <h5>
          èµ„æºçŠ¶æ€
         </h5>
         <div style="display: flex; gap: var(--spacing-4); flex-wrap: wrap; margin-top: var(--spacing-3);">
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="èµ„æ–™å……è¶³" name="resource-state" type="checkbox" value="sufficient"/>
           <span>
            ğŸ“š èµ„æ–™å……è¶³
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="å¡åœ¨æŸ¥æ‰¾" name="resource-state" type="checkbox" value="searching"/>
           <span>
            ğŸ” å¡åœ¨æŸ¥æ‰¾
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="éœ€è¦çµæ„Ÿ" name="resource-state" type="checkbox" value="inspiration"/>
           <span>
            ğŸ’¡ éœ€è¦çµæ„Ÿ
           </span>
          </label>
         </div>
        </div>
       </div>
       <div class="alert alert-info mb-6">
        <h4>
         ğŸ³ï¸ è±å…å£°æ˜åŒº (Exemption Declaration Area)
        </h4>
        <p>
         <em>
          æ‰€æœ‰æ¶‰åŠç§¯åˆ†æ‰£é™¤ã€ç‰¹æ®Šæƒ…å†µè±å…çš„æ“ä½œï¼Œ
          <strong>
           å¿…é¡»
          </strong>
          åœ¨æ­¤å¤„æ˜¾æ€§å‹¾é€‰å¹¶å¡«å†™ç†ç”±æ–¹å¯ç”Ÿæ•ˆã€‚
         </em>
        </p>
        <hr style="margin: var(--spacing-3) 0;"/>
        <div class="mb-4">
         <h5>
          ğŸ›¡ï¸ å®¢è§‚è±å… (ä¸é™åˆ¶æ¬¡æ•°ï¼Œéœ€å¤‡æ³¨)
         </h5>
         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-3);">
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="æ¶åŠ£å¤©æ°”" name="objective-exemption" type="checkbox" value="weather"/>
           <span>
            â›ˆï¸ æ¶åŠ£å¤©æ°” (HSMè±å…)
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="çªå‘äº‹ä»¶" name="objective-exemption" type="checkbox" value="emergency"/>
           <span>
            ğŸ’¥ çªå‘äº‹ä»¶ (Sysç›®æ ‡é™è‡³10)
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="èº«ä½“ä¸é€‚" name="objective-exemption" type="checkbox" value="sick"/>
           <span>
            ğŸ¤’ èº«ä½“ä¸é€‚ (å„é¡¹è±å…)
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="èµ„æ–™ç¼ºå¤±" name="objective-exemption" type="checkbox" value="material"/>
           <span>
            ğŸ“š èµ„æ–™ç¼ºå¤± (Price +0.1)
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input aria-label="å¯¼å¸ˆä¼šè®®" name="objective-exemption" type="checkbox" value="meeting"/>
           <span>
            ğŸ‘” å¯¼å¸ˆä¼šè®® (AMI F=1.0)
           </span>
          </label>
         </div>
         <div class="mt-3">
          <input aria-label="å…¶ä»–å®¢è§‚å› ç´ " placeholder="å…¶ä»–å®¢è§‚å› ç´ ï¼š" style="width: 100%;" type="text"/>
         </div>
        </div>
        <div class="exempt-grid">
         <div class="exempt-col">
          <strong style="color: var(--color-primary-dark)">
           ğŸ’ Aç±» (ç³»ç»Ÿä¿®å¤è±å…) (é™2æ¬¡/å‘¨)
          </strong>
          <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.3rem;">
           <label style="display:flex;align-items:center;gap:5px;">
            <input name="exemption-a" onchange="TPI.updateExemptionCounts()" type="checkbox" value="hemingway"/>
            ğŸŒ‰ æµ·æ˜å¨æ¡¥æ–­è¿é‡è¿
           </label>
           <label style="display:flex;align-items:center;gap:5px;">
            <input name="exemption-a" onchange="TPI.updateExemptionCounts()" type="checkbox" value="anxiety"/>
            ğŸ›¡ï¸ ç„¦è™‘é˜»æ–­æ‰§è¡Œ
           </label>
          </div>
          <div style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--color-text-secondary);">
           <em>
            * ç”¨äºç³»ç»Ÿå…³é”®æ¢å¤ä¸å¿ƒç†è°ƒèŠ‚
           </em>
          </div>
         </div>
         <div class="exempt-col">
          <strong style="color: var(--color-primary-dark)">
           ğŸ”§ Bç±» (æ—¥å¸¸å¼¹æ€§è±å…) (é™2æ¬¡/å‘¨)
          </strong>
          <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.3rem;">
           <label style="display:flex;align-items:center;gap:5px;">
            <input name="exemption-a" onchange="TPI.updateExemptionCounts()" type="checkbox" value="hemingway"/>
            ğŸŒ‰ æµ·æ˜å¨æ¡¥é‡è¿
           </label>
           <label style="display:flex;align-items:center;gap:5px;">
            <input name="exemption-a" onchange="TPI.updateExemptionCounts()" type="checkbox" value="anxiety"/>
            ğŸ›¡ï¸ ç„¦è™‘é˜»æ–­æ‰§è¡Œ
           </label>
          </div>
          <div style="font-size: 0.8rem; margin-top: 0.5rem; color: #666;">
           å·²ç”¨:
           <strong id="exemption-a-count">
            0
           </strong>
           /2
          </div>
         </div>
         <div class="exempt-col">
          <strong style="color: var(--color-text-secondary)">
           âš–ï¸ Bç±»ï¼šæ—¥å¸¸å¼¹æ€§è±å… (é™2æ¬¡/å‘¨)
          </strong>
          <div style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.3rem;">
           <label style="display:flex;align-items:center;gap:5px;">
            <input name="exemption-b" onchange="TPI.updateExemptionCounts()" type="checkbox" value="no-reason"/>
            ğŸ¤· æ— ç†ç”±è±å…
           </label>
           <label style="display:flex;align-items:center;gap:5px;">
            <input name="exemption-b" onchange="TPI.updateExemptionCounts()" type="checkbox" value="tweak"/>
            ğŸ¤ è§„åˆ™å¾®è°ƒ
           </label>
          </div>
          <div style="font-size: 0.8rem; margin-top: 0.5rem; color: #666;">
           å·²ç”¨:
           <strong id="exemption-b-count">
            0
           </strong>
           /2
          </div>
         </div>
        </div>
        <div style="margin-top: 1rem;">
         <h5>
          ğŸ“ è±å…ç†ç”±ç®€è¿°
         </h5>
         <textarea aria-label="è±å…ç†ç”±" placeholder="[åœ¨æ­¤ç®€è¿°è±å…åŸå› ï¼Œç‰¹åˆ«æ˜¯ä¸»è§‚è±å…éœ€è¯´æ˜å¿…è¦æ€§]" rows="3" style="width: 100%;"></textarea>
         <div class="alert alert-info" style="margin-top: var(--spacing-4);">
          <h5 style="margin: 0 0 8px 0;">
           ğŸ† è±å…ä¸è¿èƒœè§„åˆ™
          </h5>
          <ul style="margin: 0; padding-left: 20px; font-size: 0.9em;">
           <li>
            ä½¿ç”¨
            <strong>
             ä¸»è§‚è±å…
            </strong>
            ä¸å½±å“è¿èƒœè®¡æ•°
           </li>
           <li>
            ä½¿ç”¨
            <strong>
             å®¢è§‚è±å…
            </strong>
            åˆ™å½“æ—¥ä¸è®¡å…¥è¿èƒœ/è¿è´¥åºåˆ—
           </li>
          </ul>
         </div>
       <div class="data-processing-grid">
</div>
</div>
       </div>
       <div class="mb-6">
        <h3>
         2ï¸âƒ£ æ¨¡å¼å†³æ–­ (Decision)
        </h3>
        <p class="text-muted mb-4">
         <em>
          é€»è¾‘ï¼šé»˜è®¤æ¨¡å¼é€‰æ‹©å…·æœ‰
          <strong>
           äº’æ–¥æ€§
          </strong>
          ã€‚å¦‚éœ€æ··åˆæ¨¡å¼ï¼ˆå¦‚ä¸Šåˆå¤è‹ä¸‹åˆå¸¸æ€ï¼‰ï¼Œè¯·é€‰æ‹©
          <strong>
           [M] æ··åˆæ¨¡å¼
          </strong>
          å¹¶åœ¨å¤‡æ³¨ä¸­è¯´æ˜å„æ—¶æ®µå®‰æ’ï¼Œåˆ†åˆ«æŒ‰å¯¹åº”æ¨¡å¼è§„åˆ™è®¡åˆ†ã€‚
         </em>
        </p>
        <div class="mode-selector">
         <div class="mode-card" id="mode-normal" onclick="window.TPI.selectMode('normal')">
          <div class="mode-header">
           <span class="mode-icon">
            ğŸ…°ï¸
           </span>
           <span class="mode-title">
            å¸¸æ€ç ”ç©¶
           </span>
           <span class="mode-tag">
            æ··åˆ/æ ‡å‡†
           </span>
          </div>
          <p class="mode-description">
           åº“æ©å¼çš„"è§£è°œ"çŠ¶æ€ã€‚èº«å¿ƒå¹³ç¨³ï¼Œæ­£å¸¸äº§å‡ºã€‚
          </p>
          <div class="mode-target">
           ç›®æ ‡åˆ†: â‰¥90åˆ†
          </div>
         </div>
         <div class="mode-card" id="mode-recovery" onclick="window.TPI.selectMode('recovery')">
          <div class="mode-header">
           <span class="mode-icon">
            ğŸ…±ï¸
           </span>
           <span class="mode-title">
            å¤è‹/å†·å¯åŠ¨
           </span>
           <span class="mode-tag">
            ä¸»åŠ¨ä¼‘æ•´
           </span>
          </div>
          <p class="mode-description">
           ä½è¿·/ç”Ÿç—…/å¼ºåˆ¶è§¦å‘ã€‚åªæ±‚åœ¨åœºï¼Œä¸æ±‚äº§å‡ºã€‚å…è®¸"åˆæ³•æ‘¸é±¼"ã€‚
          </p>
          <div class="mode-target">
           åŠ¨æ€ç›®æ ‡: max(40, 70 - ä¼‘æ¯Ã—10)
          </div>
         </div>
         <div class="mode-card" id="mode-stoic" onclick="window.TPI.selectMode('stoic')">
          <div class="mode-header">
           <span class="mode-icon">
            Â©ï¸
           </span>
           <span class="mode-title">
            æ–¯å¤šè‘›/æ­¢æŸ
           </span>
           <span class="mode-tag">
            åº•çº¿é˜²å¾¡
           </span>
          </div>
          <p class="mode-description">
           11:00åå¼€å·¥ï¼Œæˆ–ä¸Šåˆå®Œå…¨å¤±æ•ˆã€‚æ¥å—æµå¤±ï¼ŒåŠ›æ±‚æ­¢æŸã€‚
          </p>
          <div class="mode-target">
           æŸ”æ€§å°é¡¶ (AMIÃ—1.2)
          </div>
         </div>
         <div class="mode-card" id="mode-vacation" onclick="window.TPI.selectMode('vacation')">
          <div class="mode-header">
           <span class="mode-icon">
            ğŸ–ï¸
           </span>
           <span class="mode-title">
            å‡æœŸ/åœæœº
           </span>
           <span class="mode-tag">
            ç³»ç»Ÿé‡ç½®
           </span>
          </div>
          <p class="mode-description">
           ä¸åšå­¦æœ¯æ˜¯æœ€é«˜é“å¾·ã€‚æ³•å®šèŠ‚å‡æ—¥æˆ–å½»åº•ä¿®å¤æœŸã€‚
          </p>
          <div class="mode-target">
           åŠ¨æ€è¾¾æ ‡çº¿
          </div>
         </div>
         <div class="mode-card" id="mode-mixed" onclick="window.TPI.selectMode('mixed')">
          <div class="mode-header">
           <span class="mode-icon">
            [M]
           </span>
           <span class="mode-title">
            æ··åˆæ¨¡å¼
           </span>
           <span class="mode-tag">
            çµæ´»ç»„åˆ
           </span>
          </div>
          <p class="mode-description">
           åŒä¸€å¤©åº”ç”¨ä¸åŒæ¨¡å¼é€»è¾‘ã€‚éœ€åœ¨å¤‡æ³¨ä¸­æ˜ç¡®å„æ—¶æ®µæ¨¡å¼ã€‚
          </p>
          <div class="mode-target">
           åˆ†æ®µè®¡åˆ†
          </div>
         </div>
        </div>
        <div id="mode-reminder" style="display: none; margin-top: var(--spacing-4);">
         <div class="mode-reminder">
          <h4>
           ğŸ“¢ æ¨¡å¼æé†’
          </h4>
          <p id="reminder-text">
           è¯·æ ¹æ®å½“å‰æ¨¡å¼è°ƒæ•´ä»Šæ—¥çš„æœŸæœ›å’Œç­–ç•¥ã€‚
          </p>
         </div>
        </div>
        <div id="vacation-details" style="display: none; margin-top: var(--spacing-4);">
         <h4>
          ğŸ–ï¸ å‡æœŸæ¨¡å¼ç»†åˆ†
         </h4>
         <p class="text-muted mb-3">
          é€‰æ‹©ä¼‘å‡æ—¶æ®µæ•°é‡ï¼š
         </p>
         <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-3); margin-bottom: var(--spacing-4);">
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input name="vacation-periods" onclick="window.TPI.updateVacationTarget(1)" type="radio" value="1"/>
           <span>
            1ä¸ªæ—¶æ®µ â†’ ç›®æ ‡åˆ† â‰¥85åˆ†
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input name="vacation-periods" onclick="window.TPI.updateVacationTarget(2)" type="radio" value="2"/>
           <span>
            2ä¸ªæ—¶æ®µ â†’ ç›®æ ‡åˆ† â‰¥60åˆ†
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input name="vacation-periods" onclick="window.TPI.updateVacationTarget(3)" type="radio" value="3"/>
           <span>
            3ä¸ªæ—¶æ®µ â†’ ç›®æ ‡åˆ† â‰¥40åˆ†
           </span>
          </label>
          <label style="display: flex; align-items: center; gap: var(--spacing-2);">
           <input name="vacation-periods" onclick="window.TPI.updateVacationTarget(4)" type="radio" value="4"/>
           <span>
            4ä¸ªæ—¶æ®µ (å…¨ä¼‘) â†’ TPIè®¡ç®—æš‚åœ
           </span>
          </label>
         </div>
        </div>
        <!-- æ··åˆæ¨¡å¼æ—¶æ®µé€‰æ‹©å™¨ -->
        <div id="mixed-mode-selector" style="display: none; margin-top: var(--spacing-4);">
         <h4>
          ğŸ”„ æ··åˆæ¨¡å¼é…ç½®
         </h4>
         <p class="text-muted mb-3">
          ğŸ’¡ ä¸ºæ¯ä¸ªæ—¶æ®µé€‰æ‹©å¯¹åº”çš„æ¨¡å¼ã€‚å„æ—¶æ®µå°†åˆ†åˆ«æŒ‰å¯¹åº”æ¨¡å¼è§„åˆ™è®¡åˆ†ï¼Œæœ€åæ±‡æ€»ã€‚
         </p>
         <div style="display: grid; gap: var(--spacing-4);">
          <!-- ä¸Šåˆæ—¶æ®µ -->
          <div class="card" style="padding: var(--spacing-3); background: var(--color-bg-secondary);">
           <h5 style="margin: 0 0 var(--spacing-2) 0; color: var(--color-primary);">
            ğŸŒ… ä¸Šåˆæ—¶æ®µ (8:00-11:00)
           </h5>
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-2);">
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-morning" type="radio" value="normal"/>
             <span>
              ğŸ…°ï¸ å¸¸æ€
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-morning" type="radio" value="recovery"/>
             <span>
              ğŸ…±ï¸ å¤è‹
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-morning" type="radio" value="stoic"/>
             <span>
              Â©ï¸ æ–¯å¤šè‘›
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-morning" type="radio" value="vacation"/>
             <span>
              ğŸ–ï¸ å‡æœŸ
             </span>
            </label>
           </div>
          </div>
          <!-- ä¸‹åˆæ—¶æ®µ -->
          <div class="card" style="padding: var(--spacing-3); background: var(--color-bg-secondary);">
           <h5 style="margin: 0 0 var(--spacing-2) 0; color: var(--color-primary);">
            â˜€ï¸ ä¸‹åˆæ—¶æ®µ (15:00-17:00)
           </h5>
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-2);">
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-afternoon" type="radio" value="normal"/>
             <span>
              ğŸ…°ï¸ å¸¸æ€
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-afternoon" type="radio" value="recovery"/>
             <span>
              ğŸ…±ï¸ å¤è‹
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-afternoon" type="radio" value="stoic"/>
             <span>
              Â©ï¸ æ–¯å¤šè‘›
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-afternoon" type="radio" value="vacation"/>
             <span>
              ğŸ–ï¸ å‡æœŸ
             </span>
            </label>
           </div>
          </div>
          <!-- æ™šä¸Š1æ—¶æ®µ -->
          <div class="card" style="padding: var(--spacing-3); background: var(--color-bg-secondary);">
           <h5 style="margin: 0 0 var(--spacing-2) 0; color: var(--color-primary);">
            ğŸŒ† æ™šä¸Š1æ—¶æ®µ (18:30-20:00)
           </h5>
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-2);">
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-evening1" type="radio" value="normal"/>
             <span>
              ğŸ…°ï¸ å¸¸æ€
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-evening1" type="radio" value="recovery"/>
             <span>
              ğŸ…±ï¸ å¤è‹
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-evening1" type="radio" value="stoic"/>
             <span>
              Â©ï¸ æ–¯å¤šè‘›
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-evening1" type="radio" value="vacation"/>
             <span>
              ğŸ–ï¸ å‡æœŸ
             </span>
            </label>
           </div>
          </div>
          <!-- æ™šä¸Š2æ—¶æ®µ -->
          <div class="card" style="padding: var(--spacing-3); background: var(--color-bg-secondary);">
           <h5 style="margin: 0 0 var(--spacing-2) 0; color: var(--color-primary);">
            ğŸŒ™ æ™šä¸Š2æ—¶æ®µ (20:40-23:00)
           </h5>
           <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-2);">
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-evening2" type="radio" value="normal"/>
             <span>
              ğŸ…°ï¸ å¸¸æ€
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-evening2" type="radio" value="recovery"/>
             <span>
              ğŸ…±ï¸ å¤è‹
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-evening2" type="radio" value="stoic"/>
             <span>
              Â©ï¸ æ–¯å¤šè‘›
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); cursor: pointer;">
             <input name="mixed-evening2" type="radio" value="vacation"/>
             <span>
              ğŸ–ï¸ å‡æœŸ
             </span>
            </label>
           </div>
          </div>
         </div>
         <div class="alert alert-info" style="margin-top: var(--spacing-4);">
          <p style="margin: 0; font-size: 0.9em;">
           ğŸ’¡
           <strong>
            è®¡åˆ†è¯´æ˜
           </strong>
           ï¼šç³»ç»Ÿå°†æ ¹æ®æ‚¨çš„é€‰æ‹©ï¼Œä¸ºæ¯ä¸ªæ—¶æ®µç‹¬ç«‹åº”ç”¨å¯¹åº”æ¨¡å¼çš„è§„åˆ™è¿›è¡Œè®¡åˆ†ï¼Œæœ€åæ±‡æ€»ä¸ºä»Šæ—¥æ€»åˆ†ã€‚è¯·ç¡®ä¿åœ¨AMIå¤‡æ³¨æ ä¸­è®°å½•å„æ—¶æ®µçš„å…·ä½“å®‰æ’ã€‚
          </p>
         </div>
        </div>
       </div>
       <!-- æ¨¡å¼è§„åˆ™è¯´æ˜ -->
       <div class="rules-container mt-6">
        <div class="rules-section collapsed" id="mode-rules">
         <div class="rules-header" onclick="window.TPI.toggleRules('mode-rules')">
          ğŸ§  åœºæ™¯åŒ–æ¨¡å¼è§£æä¸ç»†åˆ™ (Scenario Definition - Reference)
         </div>
         <div class="rules-content">
          <h4>
           1. å¸¸æ€ç ”ç©¶ (Normal Science) â€”â€” [æ··åˆ/æ ‡å‡†]
          </h4>
          <ul>
           <li>
            <strong>
             å®šä¹‰
            </strong>
            ï¼šåº“æ©å¼çš„"è§£è°œ"çŠ¶æ€ã€‚æ— æ˜æ˜¾å¤–éƒ¨å¹²æ‰°ï¼Œèº«å¿ƒçŠ¶æ€å¹³ç¨³ã€‚
           </li>
           <li>
            <strong>
             ç­–ç•¥
            </strong>
            ï¼š
            <strong>
             æŒ‰éƒ¨å°±ç­
            </strong>
            ã€‚æŸ¥é˜… AMI çŸ©é˜µçš„
            <strong>
             å¸¸æ€å•ä»·
            </strong>
            è¿›è¡Œè®¡ç®—ã€‚
           </li>
           <li>
            <strong>
             ç›®æ ‡åˆ†
            </strong>
            ï¼š$\ge 90$ã€‚
           </li>
          </ul>
          <h4>
           2. å¤è‹/å†·å¯åŠ¨ (Recovery / Low Power) â€”â€” [ä¸»åŠ¨ä¼‘æ•´/ç‰¹æ®Šæ¿å—]
          </h4>
          <ul>
           <li>
            <strong>
             å®šä¹‰
            </strong>
            ï¼šè¿ç»­æ•°æ—¥çŠ¶æ€ä½æ²‰ã€ç”Ÿç—…åˆæ„ˆã€æˆ–ä¸»åŠ¨é€‰æ‹©é™ä½èƒ½è€—ã€‚
            <strong>
             åŒ…å«ä»¥ä¸‹å…·ä½“åœºæ™¯
            </strong>
            ï¼š
            <ul>
             <li>
              <strong>
               ğŸš‘ ç—…å‡/çªå‘æ€¥äº‹
              </strong>
              (Sick Leave/Emergency)
             </li>
             <li>
              <strong>
               â˜” å¿ƒç†ä½æ°”å‹/æŠ‘éƒ
              </strong>
              (Blue Mode -
              <strong>
               æ¯æœˆé™ 3-4 æ¬¡
              </strong>
              )ï¼š
              <ul>
               <li>
                <em>
                 é˜¶æ¢¯è±å…è§„åˆ™
                </em>
                ï¼š
                <br/>
                â€¢ å‰
                <strong>
                 1-2æ¬¡
                </strong>
                ä½¿ç”¨äº«
                <strong>
                 å®Œå…¨è±å…
                </strong>
                ï¼ˆBCM/FLIé™çº§ï¼Œä¸ä¸­æ–­è¿èƒœï¼‰
                <br/>
                â€¢
                <strong>
                 ç¬¬3-4æ¬¡
                </strong>
                ä½¿ç”¨æ—¶ï¼Œå¿…é¡»å®Œæˆ
                <strong>
                 åŸºç¡€é˜²å®ˆï¼ˆBCMâ‰¥15åˆ†ï¼‰
                </strong>
                ï¼Œå¦åˆ™è§†ä¸ºæ»¥ç”¨
               </li>
               <li>
                <em>
                 æ•°æ®å¤„ç†
                </em>
                ï¼šå¯ç”¨æ­¤æ¨¡å¼æ—¶ï¼Œ
                <strong>
                 MA7 ç…§å¸¸è®¡ç®—ä»¥åæ˜ çœŸå®èƒ½æ•ˆ
                </strong>
                ï¼ˆé˜²æ­¢"ç»Ÿè®¡è„±æ°´"ï¼‰ï¼Œä½†è±å…ç”±äºä½åˆ†å¯¼è‡´çš„è¿èƒœä¸­æ–­æˆ–æƒ©ç½šã€‚
               </li>
              </ul>
             </li>
             <li>
              <strong>
               ğŸ¤ å…¨å¤©å­¦æœ¯ä¼šè®®
              </strong>
              (Conference)
             </li>
            </ul>
           </li>
           <li>
            <strong>
             ğŸš¨ è‡ªåŠ¨è§¦å‘å™¨
            </strong>
            ï¼šè¿ç»­ 2 æ—¥ $\text{TPI}_{\text{E}} &lt; 95$ æˆ–æ˜¨æ—¥ TPI &gt; 200
            <strong>
             æˆ–
            </strong>
            $\text{Sys}_{\text{Net}} &lt; 12$ã€‚
           </li>
           <li>
            <strong>
             æ‰§è¡Œ
            </strong>
            ï¼šAMI ç›®æ ‡é™ä¸º
            <strong>
             90åˆ†
            </strong>
            ã€‚
           </li>
           <li>
            <strong>
             ç»†åˆ™ (ç®€åŒ–ç‰ˆ)
            </strong>
            ï¼š
            <ul>
             <li>
              <strong>
               åŸºæœ¬é€»è¾‘
              </strong>
              ï¼šå·¥ä½œæ—¶æ®µæŒ‰åŸºç¡€åˆ† (100%)ï¼Œä¼‘æ¯æ—¶æ®µä¸è®¡åˆ†ã€‚
             </li>
             <li>
              <strong>
               âš–ï¸ TPI åŠ¨æ€è¾¾æ ‡çº¿ (æŸ¥è¡¨æ³•)
              </strong>
              ï¼š
              <table style="margin: 8px 0; border-collapse: collapse; font-size: 0.9em;">
               <tr style="background: var(--color-bg-secondary);">
                <th style="padding: 6px; border: 1px solid var(--color-border);">
                 ä¼‘æ¯æ—¶æ®µæ•°é‡
                </th>
                <th style="padding: 6px; border: 1px solid var(--color-border);">
                 å½“æ—¥æœ€ä½ç›®æ ‡åˆ†
                </th>
               </tr>
               <tr>
                <td style="padding: 6px; border: 1px solid var(--color-border); text-align: center;">
                 0
                </td>
                <td style="padding: 6px; border: 1px solid var(--color-border); text-align: center;">
                 70
                </td>
               </tr>
               <tr>
                <td style="padding: 6px; border: 1px solid var(--color-border); text-align: center;">
                 1
                </td>
                <td style="padding: 6px; border: 1px solid var(--color-border); text-align: center;">
                 60
                </td>
               </tr>
               <tr>
                <td style="padding: 6px; border: 1px solid var(--color-border); text-align: center;">
                 2
                </td>
                <td style="padding: 6px; border: 1px solid var(--color-border); text-align: center;">
                 50
                </td>
               </tr>
               <tr>
                <td style="padding: 6px; border: 1px solid var(--color-border); text-align: center;">
                 3
                </td>
                <td style="padding: 6px; border: 1px solid var(--color-border); text-align: center;">
                 40
                </td>
               </tr>
               <tr>
                <td style="padding: 6px; border: 1px solid var(--color-border); text-align: center;">
                 4
                </td>
                <td style="padding: 6px; border: 1px solid var(--color-border); text-align: center;">
                 æš‚åœè®¡ç®—
                </td>
               </tr>
              </table>
             </li>
             <li>
              <strong>
               é€‰æ‹©ä¼‘æ¯æ•°é‡ï¼ˆæœ€å¤šä¸è¶…è¿‡ 4 ä¸ªæ—¶æ®µï¼‰
              </strong>
              ï¼š[T2]
              <br/>
              â€¢ ä¼‘æ¯ 1-2 ä¸ªæ—¶æ®µï¼š(ä¸Šåˆ/ä¸‹åˆ/æ™šä¸Š â†’ å¿…é¡»åœ¨å¤‡æ³¨è¯´æ˜)
              <br/>
              â€¢ ä¼‘æ¯ 3 ä¸ªä»¥ä¸Šæ—¶æ®µï¼š(å½“æ—¥ TPI ç›®æ ‡ä¸ä½äº 40 åˆ†)
             </li>
            </ul>
           </li>
           <li>
            <strong>
             [FLI ååŒè§„åˆ™]
            </strong>
            ï¼šåœ¨ $\text{Mode B}$ (å¤è‹æ¨¡å¼) æ—¶ï¼Œå¤–è¯­ç¢ç‰‡å­¦ä¹ åº•çº¿é™è‡³
            <strong>
             1 ä¸ª
            </strong>
            ï¼ˆæ­£å¸¸æ¨¡å¼ä¸º2ä¸ªï¼‰ã€‚
           </li>
           <li>
            <strong>
             [BCM ååŒè§„åˆ™]
            </strong>
            ï¼šåœ¨ $\text{Mode B}$ (å¤è‹æ¨¡å¼) æ—¶ï¼Œ
            <strong>
             åˆ/æ™šé—´é˜²å®ˆ
            </strong>
            æœªåšå®ˆæ—¶è‡ªåŠ¨è®¡ä¸º
            <strong>
             0åˆ†
            </strong>
            ï¼ˆä¸æ‰£åˆ†ï¼Œè€Œéè´Ÿåˆ†ï¼‰ã€‚
           </li>
          </ul>
          <h4>
           3. æ–¯å¤šè‘›/æ­¢æŸ (Stoic / Damage Control) â€”â€” [åº•çº¿é˜²å¾¡]
          </h4>
          <ul>
           <li>
            <strong>
             å®šä¹‰
            </strong>
            ï¼š
            <strong>
             èµ·æ­¥è¾ƒæ™šï¼ˆ11:00 åï¼‰
            </strong>
            ï¼Œæˆ–ä¸Šåˆæ ¸å¿ƒæ—¶æ®µï¼ˆ8:00-11:00ï¼‰å®Œå…¨"æµå¤±/å¤±æ•ˆ"ã€‚
            <strong>
             æ¯å‘¨é™ç”¨ 2 æ¬¡
            </strong>
            ã€‚
           </li>
           <li>
            <strong>
             ç­–ç•¥ä¿®æ­£
            </strong>
            ï¼š
            <strong>
             ä¸å†ç›²ç›®è¿½æ±‚é«˜åˆ†ç¿»ç›˜
            </strong>
            ã€‚
           </li>
           <li>
            <strong>
             æ­¢æŸè®¡åˆ†è§„åˆ™ (æŸ”æ€§å°é¡¶ç‰ˆ)
            </strong>
            ï¼š
            <ul>
             <li>
              <strong>
               è®¡åˆ†
              </strong>
              ï¼š
              <strong>
               AMIæ€»åˆ†
              </strong>
              æŒ‰ç»“ç®—åçš„åŸå§‹åˆ†æ•° Ã—
              <strong>
               1.2
              </strong>
              è¡¥å¿ç³»æ•°ã€‚
             </li>
             <li>
              <strong>
               æ€»åˆ†å°é¡¶
              </strong>
              ï¼šæ‰§è¡Œè¡¥å¿åçš„å½“æ—¥ $\text{TPI}_{\text{E}}$ æ€»åˆ†æŒ‰ä»¥ä¸‹è§„åˆ™å°é¡¶ï¼š
              <ul style="margin-left: 15px; margin-top: 4px;">
               <li>
                è‹¥æ€»åˆ† â‰¤ 95ï¼Œåˆ™ç›´æ¥å–è¯¥å€¼ã€‚
               </li>
               <li>
                è‹¥æ€»åˆ† &gt; 95ï¼Œåˆ™è¶…å‡ºéƒ¨åˆ†æŒ‰
                <strong>
                 50% æŠ˜ç®—
                </strong>
                ååŠ å…¥æ€»åˆ†ï¼Œä¸”æœ€ç»ˆæ€»åˆ†æœ€é«˜ä¸è¶…è¿‡
                <strong>
                 120 åˆ†
                </strong>
                ã€‚
               </li>
               <li>
                <strong>
                 å…¬å¼
                </strong>
                ï¼š$\text{TPI}_{\text{E}}' = \min(120, \ 95 + (\text{TPI}_{\text{E}} - 95) \times 0.5)$
               </li>
              </ul>
             </li>
             <li>
              <strong>
               å…¶ä»–è®¡åˆ†
              </strong>
              ï¼šFLIã€BCMã€Logisticsã€HSM æŒ‰æ­£å¸¸è§„åˆ™ç»“ç®—ï¼Œä¸å—æ­¤ç³»æ•°å½±å“ã€‚
             </li>
            </ul>
           </li>
          </ul>
          <h4>
           4. å‡æœŸ/åœæœº (Vacation) â€”â€” [ç³»ç»Ÿé‡ç½®]
          </h4>
          <ul>
           <li>
            <strong>
             å®šä¹‰
            </strong>
            ï¼šæ³•å®šèŠ‚å‡æ—¥ï¼Œæˆ–ç³»ç»Ÿæ€§çš„èº«å¿ƒä¿®å¤æœŸã€‚
           </li>
           <li>
            <strong>
             éƒ¨åˆ†ä¼‘å‡ (Partial Vacation) è¾¾æ ‡çº¿
            </strong>
            ï¼š
            <ul>
             <li>
              <strong>
               ä¼‘å‡ 1 ä¸ªæ—¶æ®µ
              </strong>
              ï¼šç›®æ ‡åˆ† $\ge \mathbf{85}$ åˆ† (å…¶ä½™æ—¶æ®µæ­£å¸¸è¿ä½œ)ã€‚
             </li>
             <li>
              <strong>
               ä¼‘å‡ 2 ä¸ªæ—¶æ®µ
              </strong>
              ï¼šç›®æ ‡åˆ† $\ge \mathbf{60}$ åˆ†ã€‚
             </li>
             <li>
              <strong>
               ä¼‘å‡ 3 ä¸ªæ—¶æ®µ
              </strong>
              ï¼šç›®æ ‡åˆ† $\ge \mathbf{40}$ åˆ†ã€‚
             </li>
             <li>
              <strong>
               ä¼‘å‡ 4 ä¸ªæ—¶æ®µ (å…¨ä¼‘)
              </strong>
              ï¼š
              <strong>
               TPI è®¡ç®—æš‚åœ
              </strong>
              ã€‚ä»…è®°å½• HSM ä¸ Bonusã€‚
             </li>
            </ul>
           </li>
           <li>
            <strong>
             ç­–ç•¥
            </strong>
            ï¼š
            <strong>
             å½»åº•åˆ‡æ–­
            </strong>
            ã€‚æ­¤æ—¶"ä¸åšå­¦æœ¯"æ˜¯æœ€é«˜é“å¾·ã€‚
           </li>
          </ul>
          <h4>
           5. [M] æ··åˆæ¨¡å¼ (Mixed Mode) â€”â€” [çµæ´»ç»„åˆ]
          </h4>
          <ul>
           <li>
            <strong>
             åœºæ™¯ç‰¹å¾
            </strong>
            ï¼šéœ€è¦åœ¨åŒä¸€å¤©åº”ç”¨ä¸åŒæ¨¡å¼é€»è¾‘ã€‚
           </li>
           <li>
            <strong>
             æ“ä½œé€»è¾‘
            </strong>
            ï¼š
            <strong>
             åˆ†æ®µè®¡åˆ†
            </strong>
            ã€‚åœ¨å¤‡æ³¨ä¸­æ˜ç¡®å„æ—¶æ®µæ¨¡å¼ï¼Œåˆ†åˆ«æŒ‰å¯¹åº”è§„åˆ™è®¡åˆ†ã€‚
           </li>
           <li>
            <strong>
             ç»“ç®—ç®—æ³•
            </strong>
            ï¼šå„æ—¶æ®µç‹¬ç«‹ç»“ç®—ï¼Œæœ€åæ±‡æ€»ã€‚éœ€åœ¨å¤‡æ³¨ä¸­è¯¦ç»†è¯´æ˜ã€‚
           </li>
           <li>
            <strong>
             ä½¿ç”¨ç¤ºä¾‹
            </strong>
            ï¼š
            <ul style="margin-left: 20px; margin-top: 4px;">
             <li>
              ä¸Šåˆï¼šå¤è‹æ¨¡å¼(ä¼‘æ¯1æ—¶æ®µ)
             </li>
             <li>
              ä¸‹åˆï¼šå¸¸æ€æ¨¡å¼(æ­£å¸¸å·¥ä½œ)
             </li>
             <li>
              æ™šä¸Šï¼šæ–¯å¤šè‘›æ¨¡å¼(æ­¢æŸ)
             </li>
            </ul>
           </li>
          </ul>
         </div>
        </div>
       </div>
      </div>
     </section>
     <!-- ==================== 6. éŸ§æ€§ä¸çªç ´åŠ åˆ† ==================== -->
     <section class="card fade-in stagger-5" id="bonus">
      <div class="card-header" onclick="window.TPI.toggleCard('bonus')">
       <div class="card-title">
        <span class="icon">
         ğŸ’–
        </span>
        <span>
         éŸ§æ€§ä¸çªç ´åŠ åˆ†
        </span>
       </div>
      </div>
      <div class="card-content">
       <!-- è§„åˆ™è¯´æ˜ -->
       <div class="rules-container mb-6">
        <div class="rules-section" id="bonus-rules">
         <div class="rules-header" onclick="window.TPI.toggleRules('bonus-rules')">
          ğŸš€ åŠ¿èƒ½æ„ŸçŸ¥ç³»ç»Ÿä¸åŠ åˆ†è§„åˆ™ (Momentum Sensing - Rules)
         </div>
         <div class="rules-content">
          <p>
           <strong>
            å®šä½ï¼šå¿ƒç†è°ƒèŠ‚ä¸å…³é”®è½¬æŠ˜ã€‚æœ¬æ¿å—å¥–åŠ±æ€»åˆ† $\mathbf{\le 10\text{ åˆ†}}$ã€‚
           </strong>
          </p>
          <h4>
           ä¸€ã€å„ç»´åº¦è¿›æ­¥å¥–åŠ±æ–¹æ¡ˆï¼ˆå¤§å¹…ç²¾ç®€ï¼‰
          </h4>
          <ul>
           <li>
            <strong>
             AMI (å­¦æœ¯æˆ˜åŠ›) è¿›æ­¥å¥–åŠ±
            </strong>
            <ul>
             <li>
              ğŸ”¥
              <strong>
               è¶…çº§å¿ƒæµå¥– (+5åˆ†)
              </strong>
              ï¼šå½“æ—¥ AMI ä¸­ â‰¥3 ä¸ªæ—¶æ®µ F=1.3ã€‚æ·±åº¦ä¸“æ³¨æ˜¯è´¨é‡æ ‡å¿—ï¼Œ3ä¸ªæ—¶æ®µæ˜¯æ˜¾è‘—çªç ´ã€‚
             </li>
             <li>
              ğŸ§—
              <strong>
               æ”»åšå‹‡å£«å¥– (+7åˆ†)
              </strong>
              ï¼šå½“æ—¥å®Œæˆ 3 ä¸ªåŠä»¥ä¸Š Type D ä»»åŠ¡ã€‚æ”»åšä»»åŠ¡æ˜¯æœ€é«˜éš¾åº¦ï¼Œå®Œæˆ3ä¸ªæ˜¯å·¨å¤§çªç ´ã€‚
             </li>
            </ul>
           </li>
           <li>
            <strong>
             BCM (åŸºçŸ³ç³»ç»Ÿ) è¿›æ­¥å¥–åŠ±
            </strong>
            <ul>
             <li>
              âš–ï¸
              <strong>
               å®Œç¾ä½œæ¯å¹³è¡¡å¥– (+5åˆ†)
              </strong>
              ï¼šæ™¨é—´å…¥é¦† &lt;08:45 &amp; ç¡çœ  &lt;00:00 &amp; åˆæ™šåŒåšå®ˆã€‚ä¸‰é¡¹æ ¸å¿ƒä½œæ¯æŒ‡æ ‡åŒæ—¶è¾¾æ ‡ï¼Œä»£è¡¨ç³»ç»Ÿæ€§æ”¹å–„ã€‚
             </li>
            </ul>
           </li>
           <li>
            <strong>
             å¾®å°èƒœåˆ©å¥–
            </strong>
            <ul>
             <li>
              âœ¨
              <strong>
               å®Œæˆ3é¡¹å¾®å°èƒœåˆ© (+1åˆ†)
              </strong>
              ï¼šåœ¨å¤ç›˜åŒºè®°å½•äº†3é¡¹å¾®å°èƒœåˆ©ã€‚æ­£å‘å¼ºåŒ–å…³æ³¨ç§¯æç»†èŠ‚çš„ä¹ æƒ¯ã€‚
             </li>
            </ul>
           </li>
          </ul>
          <h4>
           äºŒã€å…¨å±€è¿›æ­¥å¥–åŠ±ï¼ˆæ›¿ä»£åŸè‡ªç”±å¡«å†™ï¼‰
          </h4>
          <ul>
           <li>
            ğŸ†
            <strong>
             çŠ¶æ€å›å‡å¥– (+7åˆ†)
            </strong>
            ï¼šå‰ä¸€æ—¥ TPI &lt; 95 &amp; æœ¬æ—¥ TPI â‰¥ 140ã€‚ä»ä½è°·å¼ºåŠ›åå¼¹ï¼Œè¯æ˜æ¢å¤èƒ½åŠ›ã€‚
           </li>
           <li>
            ğŸ’
            <strong>
             å“è¶Šè¡¨ç°å¥– (+5åˆ†)
            </strong>
            ï¼šæœ¬æ—¥ TPI â‰¥ 160ï¼ˆè¾¾åˆ°"å“è¶Š"çº§åˆ«ï¼‰ã€‚è¾¾åˆ°å“è¶Šçº§åˆ«æœ¬èº«å°±æ˜¯é‡å¤§æˆå°±ã€‚
           </li>
           <li>
            ğŸ”„
            <strong>
             å¿«é€Ÿæ¢å¤å¥– (+3åˆ†)
            </strong>
            ï¼šä»å‰ä¸€æ—¥[å¤è‹/æ–¯å¤šè‘›]æ¨¡å¼åˆ‡æ¢å›[å¸¸æ€]æ¨¡å¼ï¼Œé¦–æ—¥ TPI â‰¥ 130ã€‚å¥–åŠ±å¿«é€Ÿè°ƒæ•´æ¢å¤èƒ½åŠ›ã€‚
           </li>
           <li>
            ğŸ“Š
            <strong>
             è¿ç»­ç¨³å®šå¥–ï¼ˆæ¢¯åº¦å¥–åŠ±ï¼‰
            </strong>
            ï¼šè¿ç»­ TPI â‰¥ 120 è¾¾åˆ° 7æ—¥(+3åˆ†)/14æ—¥(+5åˆ†)/21æ—¥(+7åˆ†)ã€‚å¥–åŠ±æŒç»­æ€§ï¼Œä»…åœ¨é‡Œç¨‹ç¢‘æ—¥å¥–åŠ±ã€‚
           </li>
          </ul>
          <h4>
           ä¸‰ã€è¿è´¥é¢„è­¦ä¸å“åº”
          </h4>
          <p>
           <strong>
            è§¦å‘æ¡ä»¶
           </strong>
           ï¼šè¿ç»­3æ—¥ TPI
           <sub>
            E
           </sub>
           &lt; 95ã€‚
          </p>
          <p>
           <strong>
            é¢„è­¦æ˜¾ç¤º
           </strong>
           ï¼šç³»ç»Ÿå°†åœ¨TPIä»ªè¡¨ç›˜é¡¶éƒ¨æ˜¾ç¤º"ç¨³æ€åç¦»æç¤º"ï¼Œæç¤ºæ‚¨å½“å‰å·²åç¦»å¥åº·è¿è¡Œè½¨é“ã€‚
          </p>
          <p>
           <strong>
            å»ºè®®æ“ä½œ
           </strong>
           ï¼šä¸»åŠ¨åˆ†æåŸå› ï¼ˆSys
           <sub>
            Net
           </sub>
           æŒç»­ä½åˆ†ï¼Ÿç¡çœ è´¨é‡å·®ï¼Ÿå¯åŠ¨éšœç¢ï¼Ÿï¼‰ï¼Œå¹¶è€ƒè™‘è¿›å…¥
           <strong>
            [ğŸ…±ï¸ å¤è‹]
           </strong>
           æ¨¡å¼è¿›è¡Œç³»ç»Ÿæ€§è°ƒæ•´ã€‚
          </p>
          <p style="margin-top: 8px; font-size: 0.9em; color: var(--color-text-secondary);">
           <em>
            ğŸ’¡ å»é“å¾·åŒ–ï¼šä½åˆ†ä¸ç­‰äºå¤±è´¥ï¼Œåªæ˜¯éœ€è¦è°ƒæ•´ç­–ç•¥çš„ä¿¡å·ã€‚
           </em>
          </p>
         </div>
        </div>
       </div>
       <div class="alert alert-info mb-6">
        <h4>
         ğŸ“ å„ç»´åº¦è¿›æ­¥å¥–åŠ± (Dimension Progress Bonus)
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--spacing-4); margin-top: var(--spacing-3); margin-bottom: var(--spacing-6);">
         <label onmouseout="this.style.background='transparent'" onmouseover="this.style.background='rgba(0,0,0,0.03)'" style="display: flex; align-items: flex-start; gap: var(--spacing-2); cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;">
          <input aria-label="è¶…çº§å¿ƒæµ" name="bonus-item" onchange="TPI.calculateBonus(); TPI.calculateSystem()" style="margin-top: 4px;" type="checkbox" value="flow"/>
          <div>
           <span style="font-weight: 600;">
            ğŸ”¥ è¶…çº§å¿ƒæµå¥– (+5)
           </span>
           <small class="text-muted" style="display: block; font-size: 0.75rem; line-height: 1.3;">
            AMI â‰¥3ä¸ªæ—¶æ®µ F=1.3
           </small>
          </div>
         </label>
         <label onmouseout="this.style.background='transparent'" onmouseover="this.style.background='rgba(0,0,0,0.03)'" style="display: flex; align-items: flex-start; gap: var(--spacing-2); cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;">
          <input aria-label="æ”»åšå‹‡å£«" name="bonus-item" onchange="TPI.calculateBonus(); TPI.calculateSystem()" style="margin-top: 4px;" type="checkbox" value="warrior"/>
          <div>
           <span style="font-weight: 600;">
            ğŸ§— æ”»åšå‹‡å£«å¥– (+7)
           </span>
           <small class="text-muted" style="display: block; font-size: 0.75rem; line-height: 1.3;">
            å®Œæˆ â‰¥3ä¸ª Type D ä»»åŠ¡
           </small>
          </div>
         </label>
         <label onmouseout="this.style.background='transparent'" onmouseover="this.style.background='rgba(0,0,0,0.03)'" style="display: flex; align-items: flex-start; gap: var(--spacing-2); cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;">
          <input aria-label="å®Œç¾ä½œæ¯" name="bonus-item" onchange="TPI.calculateBonus(); TPI.calculateSystem()" style="margin-top: 4px;" type="checkbox" value="balance"/>
          <div>
           <span style="font-weight: 600;">
            âš–ï¸ å®Œç¾ä½œæ¯å¹³è¡¡å¥– (+5)
           </span>
           <small class="text-muted" style="display: block; font-size: 0.75rem; line-height: 1.3;">
            æ™¨é—´å…¥é¦† &lt;08:45 &amp; ç¡çœ  &lt;00:00 &amp; åˆæ™šåŒåšå®ˆ
           </small>
          </div>
         </label>
         <label onmouseout="this.style.background='transparent'" onmouseover="this.style.background='rgba(0,0,0,0.03)'" style="display: flex; align-items: flex-start; gap: var(--spacing-2); cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;">
          <input aria-label="å¾®å°èƒœåˆ©" name="bonus-item" onchange="TPI.calculateBonus(); TPI.calculateSystem()" style="margin-top: 4px;" type="checkbox" value="micro-victories"/>
          <div>
           <span style="font-weight: 600;">
            âœ¨ å¾®å°èƒœåˆ©å¥– (+1)
           </span>
           <small class="text-muted" style="display: block; font-size: 0.75rem; line-height: 1.3;">
            å¤ç›˜åŒºè®°å½•3é¡¹å¾®å°èƒœåˆ©
           </small>
          </div>
         </label>
        </div>
        <h4>
         ğŸ† å…¨å±€è¿›æ­¥å¥–åŠ± (Global Progress Bonus)
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--spacing-4); margin-top: var(--spacing-3);">
         <label onmouseout="this.style.background='transparent'" onmouseover="this.style.background='rgba(0,0,0,0.03)'" style="display: flex; align-items: flex-start; gap: var(--spacing-2); cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;">
          <input aria-label="çŠ¶æ€å›å‡" name="bonus-item" onchange="TPI.calculateBonus(); TPI.calculateSystem()" style="margin-top: 4px;" type="checkbox" value="return"/>
          <div>
           <span style="font-weight: 600;">
            ğŸ† çŠ¶æ€å›å‡å¥– (+7)
           </span>
           <small class="text-muted" style="display: block; font-size: 0.75rem; line-height: 1.3;">
            å‰ä¸€æ—¥ TPI &lt; 95 &amp; æœ¬æ—¥ TPI â‰¥ 140
           </small>
          </div>
         </label>
         <label onmouseout="this.style.background='transparent'" onmouseover="this.style.background='rgba(0,0,0,0.03)'" style="display: flex; align-items: flex-start; gap: var(--spacing-2); cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;">
          <input aria-label="å“è¶Šè¡¨ç°" name="bonus-item" onchange="TPI.calculateBonus(); TPI.calculateSystem()" style="margin-top: 4px;" type="checkbox" value="excellent"/>
          <div>
           <span style="font-weight: 600;">
            ğŸ’ å“è¶Šè¡¨ç°å¥– (+5)
           </span>
           <small class="text-muted" style="display: block; font-size: 0.75rem; line-height: 1.3;">
            æœ¬æ—¥ TPI â‰¥ 160
           </small>
          </div>
         </label>
         <label onmouseout="this.style.background='transparent'" onmouseover="this.style.background='rgba(0,0,0,0.03)'" style="display: flex; align-items: flex-start; gap: var(--spacing-2); cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;">
          <input aria-label="å¿«é€Ÿæ¢å¤" name="bonus-item" onchange="TPI.calculateBonus(); TPI.calculateSystem()" style="margin-top: 4px;" type="checkbox" value="recovery"/>
          <div>
           <span style="font-weight: 600;">
            ğŸ”„ å¿«é€Ÿæ¢å¤å¥– (+3)
           </span>
           <small class="text-muted" style="display: block; font-size: 0.75rem; line-height: 1.3;">
            åˆ‡å›å¸¸æ€é¦–æ—¥ TPI â‰¥ 130
           </small>
          </div>
         </label>
         <label onmouseout="this.style.background='transparent'" onmouseover="this.style.background='rgba(0,0,0,0.03)'" style="display: flex; align-items: flex-start; gap: var(--spacing-2); cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;">
          <input aria-label="è¿ç»­ç¨³å®š7æ—¥" name="bonus-item" onchange="TPI.calculateBonus(); TPI.calculateSystem()" style="margin-top: 4px;" type="checkbox" value="streak7"/>
          <div>
           <span style="font-weight: 600;">
            ğŸ“Š è¿ç»­ç¨³å®š(7æ—¥) (+3)
           </span>
           <small class="text-muted" style="display: block; font-size: 0.75rem; line-height: 1.3;">
            TPI â‰¥ 120 (ç¬¬7æ—¥è·å¾—)
           </small>
          </div>
         </label>
         <label onmouseout="this.style.background='transparent'" onmouseover="this.style.background='rgba(0,0,0,0.03)'" style="display: flex; align-items: flex-start; gap: var(--spacing-2); cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;">
          <input aria-label="è¿ç»­ç¨³å®š14æ—¥" name="bonus-item" onchange="TPI.calculateBonus(); TPI.calculateSystem()" style="margin-top: 4px;" type="checkbox" value="streak14"/>
          <div>
           <span style="font-weight: 600;">
            ğŸ“Š è¿ç»­ç¨³å®š(14æ—¥) (+5)
           </span>
           <small class="text-muted" style="display: block; font-size: 0.75rem; line-height: 1.3;">
            TPI â‰¥ 120 (ç¬¬14æ—¥è·å¾—)
           </small>
          </div>
         </label>
         <label onmouseout="this.style.background='transparent'" onmouseover="this.style.background='rgba(0,0,0,0.03)'" style="display: flex; align-items: flex-start; gap: var(--spacing-2); cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s;">
          <input aria-label="è¿ç»­ç¨³å®š21æ—¥" name="bonus-item" onchange="TPI.calculateBonus(); TPI.calculateSystem()" style="margin-top: 4px;" type="checkbox" value="streak21"/>
          <div>
           <span style="font-weight: 600;">
            ğŸ“Š è¿ç»­ç¨³å®š(21æ—¥) (+7)
           </span>
           <small class="text-muted" style="display: block; font-size: 0.75rem; line-height: 1.3;">
            TPI â‰¥ 120 (ç¬¬21æ—¥è·å¾—)
           </small>
          </div>
         </label>
        </div>
       </div>
       <div class="mb-6">
        <h4>
         ğŸ“ å¥–åŠ±ç†ç”± (å¿…å¡«)
        </h4>
        <textarea aria-label="å¥–åŠ±ç†ç”±" id="bonus-reason" placeholder="åœ¨æ­¤å¤„ç®€è¿°æ˜¯ä»€ä¹ˆäº‹ä»¶/å¿µå¤´å¸¦æ¥äº†è½¬æŠ˜..." rows="4"></textarea>
       </div>
       <div class="text-center">
        <h3>
         ğŸ† éŸ§æ€§åŠ åˆ†æ€»åˆ†:
         <span id="bonus-total-score">
          0
         </span>
         åˆ†
        </h3>
        <p class="text-muted">
         (ä¸Šé™ 10 åˆ†ï¼Œå°†è®¡å…¥ TPI
         <sub>
          E
         </sub>
         æ€»åˆ†)
        </p>
       </div>
      </div>
     </section>
     <!-- ==================== 7. AMI å­¦æœ¯æˆ˜åŠ›æ¨¡å— ==================== -->
     <!-- ==================== 7. AMI å­¦æœ¯æˆ˜åŠ›æ¨¡å— ==================== -->
     <section class="card fade-in stagger-1" id="ami">
      <div class="card-header" onclick="window.TPI.toggleCard('ami')">
       <div class="card-title">
        <span class="icon">
         âš”ï¸
        </span>
        <span>
         ç¬¬ä¸€éƒ¨åˆ†ï¼šå­¦æœ¯æˆ˜åŠ›æŒ‡æ ‡ (AMI - Academic Momentum Index)
        </span>
       </div>
      </div>
      <div class="card-content">
       <div class="alert alert-warning mb-6">
        <h4>
         ğŸ”¥ ç‚¹ç«ç¨‹åº (Ignition Protocol)
        </h4>
        <p>
         <em>
          å¾®å°åŠ¨ä½œæ˜¯å¯¹æŠ—æ‹–å»¶çš„å”¯ä¸€è§£è¯ã€‚
         </em>
        </p>
        <div id="yesterday-bridge" style="background: rgba(255,255,255,0.6); padding: 8px; border-radius: 4px; border-left: 3px solid #f59e0b; margin-bottom: 10px; font-size: 0.85rem; display: none;">
         <strong>
          ğŸŒ‰ æ˜¨æ—¥æ‚¬å¿µï¼š
         </strong>
         <span id="yesterday-cliffhanger-text">
          è¯»å–ä¸­...
         </span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-3); margin-top: var(--spacing-3);">
         <label style="display: flex; align-items: center; gap: var(--spacing-2);">
          <input aria-label="ç‰©ç†å°±ä½" id="ignition-physical" onchange="TPI.calculateAMI()" type="checkbox"/>
          <span>
           ğŸ§¼ ç‰©ç†å°±ä½ï¼šæ‰‹æœºå·²é”å…¥/æ”¾å…¥è¿œç¦»å¤„ï¼Œæ°´æ¯å·²æ»¡ã€‚
          </span>
         </label>
         <label style="display: flex; align-items: center; gap: var(--spacing-2);">
          <input aria-label="å¾®è§‚ç›®æ ‡" id="ignition-micro-target" onchange="TPI.calculateAMI()" type="checkbox"/>
          <span>
           ğŸ¤ å¾®è§‚ç›®æ ‡ï¼šå·²å†™ä¸‹å‰ 5 åˆ†é’Ÿè¦åšçš„ä¸€ä»¶æå°çš„äº‹ï¼ˆå¦‚"æ‰“å¼€æ–‡æ¡£å¹¶é‡è¯»æœ€åä¸€æ®µ"ï¼‰ã€‚
          </span>
         </label>
         <label style="display: flex; align-items: center; gap: var(--spacing-2);">
          <input aria-label="æ— ç—›å¯åŠ¨" id="ignition-painless-start" onchange="TPI.calculateAMI()" type="checkbox"/>
          <span>
           ğŸš€ æ— ç—›å¯åŠ¨ï¼šå·²å®Œæˆæœ€åˆçš„ 5 åˆ†é’ŸæŠ•å…¥ï¼ˆ
           <strong>
            è‹¥æœ‰ [æµ·æ˜å¨æ¡¥] æŒ‡ä»¤ï¼Œå¿…é¡»ä¼˜å…ˆæ‰§è¡Œ
           </strong>
           ï¼‰ã€‚ â†’
           <strong>
            +2 åˆ†
           </strong>
          </span>
         </label>
        </div>
        <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 0.9em;">
         <p style="margin: 0;">
          <strong>
           ğŸŒ‰ æ–­æ¡¥è±å…æœºåˆ¶
          </strong>
          ï¼šè‹¥æ˜¨æ—¥è®¾å®šçš„"ç¬¬ä¸€åŠ¨ä½œ"ä»Šæ—¥å› æ•…æœªæ‰§è¡Œï¼Œå¯æ¶ˆè€—
          <strong>
           1æ¬¡Aç±»ä¸»è§‚è±å…
          </strong>
          è¿›è¡Œ"æ–­æ¡¥é‡è¿"ï¼Œåˆ™å¯åŠ¨åˆ†ä»…æ‰£é™¤ç¬¬ä¸€ä¸ªæ¿å—çš„ +2 åˆ†ï¼ˆè€Œéå…¨éƒ¨å¤±æ•ˆï¼‰ã€‚
         </p>
        </div>
       </div>
       <div class="alert alert-info mb-6">
        <h4>
         ğŸš€ å¯åŠ¨ä»ªå¼ä¸å­¦æœ¯å…±åŒä½“ (Protocol Details)
        </h4>
        <p>
         <strong>
          å¯åŠ¨è§„åˆ™
         </strong>
         ï¼šè½åº§å³è¿›å…¥ $\text{Zotero}$ æˆ–å²æ–™åº“ï¼Œ
         <strong>
          ç«‹å³
         </strong>
         è¿›è¡Œ
         <strong>
          æ·±æ½œ
         </strong>
         ï¼ˆç¦æ­¢å…ˆå¤„ç†æ‚äº‹ï¼‰ã€‚
        </p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-3); margin-top: var(--spacing-3);">
         <label style="display: flex; align-items: center; gap: var(--spacing-2);">
          <input aria-label="ç¬¬ä¸€æ¿å—å¯åŠ¨" id="start-morning-block" onchange="TPI.calculateAMI()" type="checkbox"/>
          <span>
           ğŸŒ… ç¬¬ä¸€æ¿å—å¯åŠ¨ (å»ºè®®08:30) â†’
           <strong>
            +2åˆ†
           </strong>
          </span>
         </label>
         <label style="display: flex; align-items: center; gap: var(--spacing-2);">
          <input aria-label="ç¬¬äºŒæ¿å—å¯åŠ¨" id="start-afternoon-block" onchange="TPI.calculateAMI()" type="checkbox"/>
          <span>
           â˜€ï¸ ç¬¬äºŒæ¿å—å¯åŠ¨ (å»ºè®®15:00) â†’
           <strong>
            +2åˆ†
           </strong>
          </span>
         </label>
         <label style="display: flex; align-items: center; gap: var(--spacing-2);">
          <input aria-label="ç¬¬ä¸‰æ¿å—å¯åŠ¨" id="start-evening-block" onchange="TPI.calculateAMI()" type="checkbox"/>
          <span>
           ğŸŒ™ ç¬¬ä¸‰æ¿å—å¯åŠ¨ (å»ºè®®18:30) â†’
           <strong>
            +2åˆ†
           </strong>
          </span>
         </label>
         <label style="display: flex; align-items: center; gap: var(--spacing-2);">
          <input aria-label="å­¦æœ¯å¯¹è¯" id="academic-dialogue" onchange="TPI.calculateAMI()" type="checkbox"/>
          <span>
           ğŸ’¬ å­¦æœ¯å¯¹è¯/æœ‰æ•ˆæ²Ÿé€š (ä¸å¯¼å¸ˆ/åŒåƒšå®è´¨æ€§æ¢è®¨) â†’
           <strong>
            +2åˆ†
           </strong>
          </span>
         </label>
        </div>
        <div style="margin-top: var(--spacing-3);">
         <p class="text-bold">
          åè®®åŠ åˆ†å°è®¡:
          <span id="ignition-total">
           0
          </span>
          åˆ† (å¡«å…¥AMIæ€»åˆ†)
         </p>
        </div>
       </div>
       <div class="rules-container mb-6">
        <div class="rules-section collapsed" id="ami-rules">
         <div class="rules-header" onclick="window.TPI.toggleRules('ami-rules')">
          ğŸ“˜ AMI ä½¿ç”¨è¯´æ˜ä¸è§„åˆ™ (Guide &amp; Rules)
         </div>
         <div class="rules-content">
          <h4>
           ğŸ¯ æ ¸å¿ƒåŸåˆ™
          </h4>
          <ul>
           <li>
            <strong>
             åˆ†ç¦»è®°å½•ä¸è¯„åˆ¤
            </strong>
            ï¼šå·¥ä½œæ—¶åªè®°å½•å®¢è§‚äº§å‡ºï¼ˆæ—¶é•¿ã€é¡µæ•°ã€å­—æ•°ï¼‰ï¼Œæ™šé—´ç»“ç®—æ—¶å†è¯„ä¼°Fç³»æ•°ã€‚
           </li>
           <li>
            <strong>
             æµ·æ£®å ¡é˜²æŠ–
            </strong>
            ï¼šä¸¥ç¦åœ¨ Block è¿›è¡Œä¸­é¢„åˆ¤ä¸“æ³¨ç³»æ•° Fï¼Œé˜²æ­¢è§‚å¯Ÿå¹²æ‰°çŠ¶æ€ã€‚
           </li>
          </ul>
          <h4 class="mt-4">
           ğŸ“Š è®¡åˆ†é€»è¾‘
          </h4>
          <p>
           <strong>
            AMI æ€»åˆ† = åŸºç¡€åœ¨åœºåˆ† + æ ¸å¿ƒäº§å‡ºåˆ†
           </strong>
          </p>
          <ul>
           <li>
            <strong>
             åŸºç¡€åˆ†
            </strong>
            ï¼š$h \times 2.5 \times q$ï¼ˆä½ä¿åˆ†ï¼‰ã€‚
            <br/>
            <span style="font-size: 0.9em; color: var(--color-text-secondary);">
             ğŸ’¡
             <strong>
              è·å¾—æ¡ä»¶
             </strong>
             ï¼šåœ¨è¯¥æ—¶æ®µå†…è¿›è¡Œäº†ä»»ä½•è¢«è®°å½•çš„å­¦æœ¯ç›¸å…³æ´»åŠ¨ï¼ˆå³ä½¿äº§å‡ºä¸º0ï¼‰å³å¯è·å¾—ã€‚è‹¥è¯¥æ—¶æ®µå®Œå…¨ç”¨äºéå­¦æœ¯äº‹åŠ¡ï¼Œåˆ™ä¸è®¡æ—¶ï¼ˆh=0ï¼‰ã€‚
             <em>
              hè®¡ç®—ä¸å«ä¼‘æ¯æ—¶é—´ã€‚
             </em>
            </span>
           </li>
           <li>
            <strong>
             äº§å‡ºåˆ†
            </strong>
            ï¼š$(\text{é¡µæ•°} \times \text{å•ä»·} + \text{å­—æ•°}/100 \times \text{å•ä»·}) \times F$ã€‚
           </li>
           <li>
            <strong>
             å°é¡¶
            </strong>
            ï¼šæ ¸å¿ƒäº§å‡ºåˆ†ä¸Šé™
            <strong>
             100åˆ†
            </strong>
            ã€‚
           </li>
           <li style="margin-top: 8px; padding: 6px; background: #fff7ed; border-left: 3px solid #f59e0b;">
            <strong>
             âš–ï¸ å–æ•´è§„åˆ™
            </strong>
            ï¼šç»Ÿè®¡é¡µæ•°/å­—æ•°æ—¶ï¼Œè‹¥æ•°å€¼ä¸è¶³æ•´æ•°ä½†å·®å€¼åœ¨
            <strong>
             3ä»¥å†…
            </strong>
            ï¼ˆå¦‚97å­—æˆ–9.8é¡µï¼‰ï¼Œ
            <strong>
             æŒ‰æ•´æ•°è®¡ç®—
            </strong>
            ï¼ˆç®—ä½œ100å­—æˆ–10é¡µï¼‰ï¼›è‹¥è¶…è¿‡æ•´æ•°ï¼ˆå¦‚103å­—ï¼‰ï¼Œåˆ™
            <strong>
             å®äº‹æ±‚æ˜¯
            </strong>
            è®°å½•å‡†ç¡®æ•°å€¼ã€‚
           </li>
           <li style="padding: 6px; background: #fef2f2; border-left: 3px solid #ef4444;">
            <strong>
             ğŸš« çº¯å‡€è®¡æ•°
            </strong>
            ï¼šå­—æ•°ç»Ÿè®¡
            <strong>
             ä¸¥ç¦
            </strong>
            åŒ…å«æ ‡ç­¾å…ƒæ•°æ®ï¼ˆå¦‚
            <code>
             #å†…å®¹æ¦‚æ‹¬
            </code>
            ã€
            <code>
             #å¤–åœ¨å»¶ä¼¸
            </code>
            ç­‰ï¼‰ï¼Œ
            <strong>
             ä»…è®¡ç®—å®è´¨æ€§å†…å®¹
            </strong>
            ã€‚
           </li>
          </ul>
          <h4 class="mt-4">
           âš ï¸ å…³é”®ä»»åŠ¡è¯´æ˜
          </h4>
          <ul>
           <li>
            <strong>
             Type D (æ ¸å¿ƒæ”»åš)
            </strong>
            ï¼š
            <br/>
            é’ˆå¯¹é«˜ç†µå€¼éšœç¢ï¼ˆè¯­è¨€/æŠ€æœ¯æ®‹ç¼ºï¼‰ã€‚
            <strong>
             å•ä»· 3.0
            </strong>
            ã€‚
            <br/>
            <em>
             è®¡åˆ†
            </em>
            ï¼šä¼˜å…ˆæŒ‰å­—æ•°ï¼›è‹¥æ— å­—æ•°ï¼ŒæŒ‰
            <strong>
             400å­—/h å½“é‡
            </strong>
            å¡«å…¥å­—æ•°æ ã€‚
           </li>
           <li>
            <strong>
             Type S (æ€ç»´ç»“æ™¶)
            </strong>
            ï¼š
            <br/>
            <strong>
             å•ä»· 2.0
            </strong>
            ã€‚å¿…é¡»åœ¨å‚ç›´è¾“å…¥æ¡†ä¸‹æ–¹çš„å¤‡æ³¨æ å†™å‡ºå…·ä½“çš„â€œä¸€å¥è¯ç»“æ™¶â€æ–¹å¯å¾—åˆ†ã€‚
           </li>
          </ul>
          <h4 class="mt-4">
           ğŸ”¢ æ ¸å¿ƒå•ä½ä»·å€¼çŸ©é˜µ (Unit Value Matrix)
          </h4>
          <table style="width: 100%; font-size: var(--font-size-xs); margin-top: var(--spacing-2); border-collapse: collapse;">
           <thead>
            <tr style="background: var(--color-bg-secondary);">
             <th style="padding: 8px; border: 1px solid var(--color-border); text-align: left;">
              ğŸ¯ ä»»åŠ¡å±‚çº§ (Tier) &amp; ğŸ·ï¸ è¡Œä¸ºé€»è¾‘ (Action Logic)
             </th>
             <th style="padding: 8px; border: 1px solid var(--color-border); text-align: center;">
              å•ä»· (Price)
              <br/>
              <em style="font-weight: normal; font-size: 0.85em;">
               Unit Score
              </em>
             </th>
             <th style="padding: 8px; border: 1px solid var(--color-border); text-align: left;">
              ğŸ“ è®¡æ•°å•ä½ (Unit)
             </th>
            </tr>
           </thead>
           <tbody>
            <tr>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              <strong>
               Tier 1: åŸºç¡€/æ•´ç† (Input/Admin)
              </strong>
              <br/>
              <em style="font-size: 0.9em;">
               ä½ç†µä¿¡æ¯æ‘„å…¥/è¡Œæ”¿
              </em>
              <br/>
              (é˜…è¯»I) (æ—¥å¿—/éå­¦æœ¯) (è¡Œæ”¿/æ‚åŠ¡)
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border); text-align: center; font-weight: bold; font-size: 1.1em;">
              0.7
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              åˆ†/é¡µ (æˆ–é¡¹)
             </td>
            </tr>
            <tr>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              <strong>
               Tier 2: ç ”è¯»/åŠ å·¥ (Processing)
              </strong>
              <br/>
              <em style="font-size: 0.9em;">
               ç½‘ç»œæ„å»º/ç§©åºé‡å»º
              </em>
              <br/>
              (é˜…è¯»II) (å†™ä½œA: æ•´ç†/æ¦‚æ‹¬) (ç¬”è®°)
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border); text-align: center; font-weight: bold; font-size: 1.1em;">
              1.0
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              åˆ†/é¡µ (æˆ–å•ä½)
             </td>
            </tr>
            <tr>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              <strong>
               Tier 3: æ ¸å¿ƒ/è¾“å‡º (Output/Creation)
              </strong>
              <br/>
              <em style="font-size: 0.9em;">
               é«˜ç†µä¿¡æ¯å¤„ç†/æ·±åº¦å»ºæ„
              </em>
              <br/>
              (é˜…è¯»III) (å†™ä½œB) (æ€ç»´ç»“æ™¶) (ç¿»è¯‘)
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border); text-align: center; font-weight: bold; font-size: 1.1em;">
              1.8
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              åˆ†/é¡µ (æˆ–100å­—)
             </td>
            </tr>
            <tr>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              <strong>
               Tier 4: é«˜çº§è¾“å‡º (Advanced Output)
              </strong>
              <br/>
              <em style="font-size: 0.9em;">
               æ­£å¼è¾“å‡º/æ”»åš
              </em>
              <br/>
              (å†™ä½œC)
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border); text-align: center; font-weight: bold; font-size: 1.1em;">
              2.2
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              åˆ†/100å­—
             </td>
            </tr>
            <tr>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              <strong>
               Tier 5: ç‰¹æ®Šæ”»åš (Hardcore Decoding)
              </strong>
              <br/>
              <em style="font-size: 0.9em;">
               é«˜ç†µå€¼éšœç¢æ”»åš
              </em>
              <br/>
              (å†™ä½œD: æ”»åš)
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border); text-align: center; font-weight: bold; font-size: 1.1em;">
              2.8
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              åˆ†/100å­— (æˆ–
              <strong>
               Type D: 400å½“é‡å­—/h
              </strong>
              )
             </td>
            </tr>
            <tr style="background: #fef3c7;">
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              <strong>
               ç°åœº L (å¸¸æ€ - Input/Passive)
              </strong>
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border); text-align: center; font-weight: bold; font-size: 1.1em;">
              2.0
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              åˆ†/å°æ—¶
             </td>
            </tr>
            <tr style="background: #fef3c7;">
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              <strong>
               ç°åœº L (ç»åœ° - Output/Active)
              </strong>
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border); text-align: center; font-weight: bold; font-size: 1.1em;">
              3.0
             </td>
             <td style="padding: 8px; border: 1px solid var(--color-border);">
              åˆ†/å°æ—¶
             </td>
            </tr>
           </tbody>
           <tfoot>
            <tr>
             <td colspan="3" style="padding: 8px; border: 1px solid var(--color-border); background: var(--color-bg-tertiary); font-size: 0.85em;">
              <em>
               <strong>
                æ³¨
               </strong>
               ï¼š
               <strong>
                ç°åœº L (Embodied Presence)
               </strong>
               ä»»åŠ¡æŒ‰ä¸Šè¿°å•ä»·è®¡ç®—ï¼Œè‹¥æœ‰å®è´¨æ€§ç¬”è®°äº§å‡ºå¯æŒ‰ä¸Šè¿° Tier è®¡å…¥ Outputã€‚
              </em>
             </td>
            </tr>
           </tfoot>
          </table>
          <div class="rules-container" style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #e5e7eb;">
           <div style="font-size: 0.9em; font-weight: 600; color: #6b7280; margin-bottom: 10px;">
            ğŸ“‹ è¯¦ç»†è§„åˆ™é€ŸæŸ¥ (ç‚¹å‡»å±•å¼€)
           </div>
           <div class="rules-section collapsed" id="rule-reading">
            <div class="rules-header" onclick="window.TPI.toggleRules('rule-reading')">
             ğŸ”¥ é˜…è¯»è®¤çŸ¥è´Ÿè·åˆ†çº§ (Level I-III)
            </div>
            <div class="rules-content">
             <ul>
              <li>
               <strong>
                Level I: è§†é‡ä¸åšé›… (Context)
               </strong>
               ï¼šä½è®¤çŸ¥é˜»åŠ›ã€‚åŒ…å«ï¼šæ™®é€šæ–°é—»ç¨¿ã€æ—¶æ”¿è¯„è®ºã€å¤§ä¼—è¯»ç‰©ã€‚
              </li>
              <li>
               <strong>
                Level II: ç ”è¯»ä¸æ‰¹åˆ¤ (Analytical)
               </strong>
               ï¼šæ ‡å‡†å­¦æœ¯å¼ºåº¦ã€‚åŒ…å«ï¼š
               <strong>
                CSSCI/SSCI æœŸåˆŠ
               </strong>
               ã€æ™®é€šå­¦æœ¯è®ºæ–‡ã€æ€æƒ³æ·±åº¦è¯„è®ºã€ç°ä»£æ±‰è¯­åŸå§‹å²æ–™ã€‚
              </li>
              <li>
               <strong>
                Level III: æ”»åšä¸è§£ç  (Decoding)
               </strong>
               ï¼šé«˜ç†µå€¼ä¿¡æ¯ã€‚åŒ…å«ï¼š
               <strong>
                å¤ç±
               </strong>
               ï¼ˆæœªç‚¹æ ¡ï¼‰ã€
               <strong>
                å¤–æ–‡æ–‡çŒ®
               </strong>
               ï¼ˆéæƒ¯ç”¨/è¶Šå—è¯­ä¸€æ‰‹æ¡£æ¡ˆï¼‰ã€æ™¦æ¶©ç†è®ºåŸå…¸ã€‚
              </li>
             </ul>
            </div>
           </div>
           <div class="rules-section collapsed" id="rule-writing">
            <div class="rules-header" onclick="window.TPI.toggleRules('rule-writing')">
             ğŸ–Šï¸ å†™ä½œçŸ¥è¯†ç”Ÿäº§å±‚çº§ (Type A-D)
            </div>
            <div class="rules-content">
             <ul>
              <li>
               <strong>
                Type A: æ•´ç†ä¸ç§©åºé‡å»º
               </strong>
               (Input/Admin)
               <br/>
               <em>
                å®šä¹‰
               </em>
               ï¼šä¿¡æ¯æ¬è¿ã€‚Zoteroæ˜ å°„ï¼š
               <code>
                #å†…å®¹æ¦‚æ‹¬
               </code>
               ,
               <code>
                #é‡è¦ææ–™
               </code>
               ,
               <code>
                #æ¦‚å¿µæœ¯è¯­
               </code>
               ,
               <code>
                #ç›¸å…³è®ºè‘—
               </code>
               ,
               <code>
                #å­˜ç–‘å¾…è€ƒ
               </code>
               ã€‚
              </li>
              <li>
               <strong>
                Type B: æ‰¹åˆ¤æ€§å»ºæ„
               </strong>
               (Critical Construction)
               <br/>
               <em>
                å®šä¹‰
               </em>
               ï¼šè§‚ç‚¹è¾“å‡ºï¼Œä»è¯»åˆ°å†™ã€‚Zoteroæ˜ å°„ï¼š
               <code>
                #ç ”ç©¶ä¸è®ºè¯
               </code>
               ,
               <code>
                #å†…åœ¨æ‰¹è¯„
               </code>
               ,
               <code>
                #å¤–åœ¨å»¶ä¼¸
               </code>
               ã€‚
              </li>
              <li>
               <strong>
                Type C: æ­£å¼å†™ä½œ
               </strong>
               (Formal Production)
               <br/>
               <em>
                å®šä¹‰
               </em>
               ï¼šé¢å‘ä»–è€…ï¼Œç»“æ„åŒ–è¾“å‡ºã€‚è‹¥åˆ å»å¼•ç”¨æ— æ³•ç‹¬ç«‹æˆç¯‡åˆ™å±Type Cã€‚åŒ…æ‹¬ï¼šè‰ç¨¿æ’°å†™ã€æ­£å¼ä¿®æ”¹ã€å­¦æœ¯æœ­è®°ã€‚
              </li>
              <li>
               <strong>
                Type D: æ ¸å¿ƒæ”»åš
               </strong>
               (Hardcore Decoding)
               <br/>
               <em>
                å®šä¹‰
               </em>
               ï¼šé«˜ç†µå€¼éšœç¢ï¼ˆè¯­è¨€/æŠ€æœ¯æ®‹ç¼ºï¼‰ã€‚
               <strong>
                å•ä»· 2.8
               </strong>
               ã€‚
               <br/>
               <em>
                è®¡åˆ†é€»è¾‘ï¼ˆäºŒé€‰ä¸€ï¼‰
               </em>
               ï¼š
               <br/>
               â‘ 
               <strong>
                ä¼˜å…ˆæŒ‰å®é™…å­—æ•°
               </strong>
               ï¼šå­—æ•° Ã— 2.8/100
               <br/>
               â‘¡
               <strong>
                è‹¥æ— å­—æ•°äº§å‡º
               </strong>
               ï¼šå¯ç”¨å›ºå®šå½“é‡æ³•ï¼ˆ400å­—/å°æ—¶ï¼‰Ã— 2.8/100
               <br/>
               <em>
                ç¤ºä¾‹
               </em>
               ï¼šæ”»åš1hå†™å‡º300å­— â†’ å¾—åˆ†=300/100Ã—2.8=8.4åˆ†ï¼›æ”»åš1hæ— äº§å‡º â†’ å¾—åˆ†=(1Ã—400)/100Ã—2.8=11.2åˆ†
              </li>
              <li>
               <strong>
                Type S: æ·±åº¦æ„æ€
               </strong>
               (Crystallization)
               <br/>
               <em>
                å®šä¹‰
               </em>
               ï¼šæ€ç»´ç»“æ™¶ã€‚å¿…é¡»æ˜¯ä¸€å¥è¯èƒ½è¯´æ¸…çš„è®ºç‚¹/æ¨¡å‹ã€‚
              </li>
              <li style="margin-top: 12px; padding: 8px; background: #f0f9ff; border-left: 3px solid #3b82f6;">
               <strong>
                ğŸ§© æ··åˆæ¨¡å¼ç»“ç®—
               </strong>
               <br/>
               <em>
                è¦æ±‚
               </em>
               ï¼šè‹¥é‡‡ç”¨æ··åˆæ¨¡å¼ï¼ˆå¦‚åŒæ—¶åŒ…å«Aç±»å’ŒDç±»ï¼‰ï¼Œ
               <strong>
                å¿…é¡»
               </strong>
               åœ¨å­—æ•°æ åˆ†ç±»è®°å½•ï¼ˆä¾‹å¦‚ï¼š"Aç±»200å­—ï¼ŒDç±»500å­—"ï¼‰ï¼Œ
               <strong>
                ä¸¥ç¦ç¬¼ç»Ÿæ‰“åŒ…
               </strong>
               ã€‚
              </li>
             </ul>
            </div>
           </div>
           <div class="rules-section collapsed" id="rule-presence">
            <div class="rules-header" onclick="window.TPI.toggleRules('rule-presence')">
             ğŸ—£ï¸ ç°åœº L (Embodied Presence)
            </div>
            <div class="rules-content">
             <p>
              <strong>
               æ ¸å¿ƒå®šä¹‰
              </strong>
              ï¼šæŒ‡
              <strong>
               ç»“æ„åŒ–ã€åŒæ­¥åŒ–
              </strong>
              çš„é«˜å¯†åº¦ä¿¡æ¯äº¤æ¢æˆ–åœºåŸŸæµ¸æ³¡ã€‚å¼ºè°ƒ"èº«ä½“ä¸æ€ç»´çš„åŒæ—¶åœ¨åœº"ã€‚æ­¤ç±»æ´»åŠ¨å…·æœ‰
              <strong>
               ä¸å¯å›æº¯æ€§å’Œç¤¾ä¼š/ç‰©ç†åœ¨åœºæ„Ÿ
              </strong>
              ã€‚
             </p>
             <p style="margin-top: 12px;">
              <strong>
               âš–ï¸ è¾¹ç•Œå˜æ¸…
              </strong>
              ï¼šæœ¬æ¿å—é€‚ç”¨äº
              <strong>
               â‰¥ 30åˆ†é’Ÿ
              </strong>
              çš„æŒç»­æ€§æ´»åŠ¨ã€‚çŸ­äºæ­¤çš„ç®€å•æ²Ÿé€šæˆ–é‚®ä»¶ï¼Œè¯·è®¡å…¥"å¯åŠ¨ä»ªå¼"çš„å›ºå®š +2 åˆ†ã€‚
             </p>
             <div style="margin-top: 12px;">
              <p>
               <strong>
                âœ… åŒ…å«åœºæ™¯
               </strong>
               ï¼š
              </p>
              <ul style="margin-left: 20px;">
               <li>
                <strong>
                 å­¦æœ¯è®²åº§/æŒ‚æœº
                </strong>
                ï¼šä½œä¸ºå¬ä¼—è¿›è¡Œç¬”è®°è®°å½•ï¼Œæˆ–åœ¨çº¿å¬ä¼š/æŒ‚æœºï¼ˆä¿æŒèƒŒæ™¯å£°åœºçš„å­¦æœ¯æµ¸æ³¡ï¼Œç»´æŒè¯­æ„Ÿï¼Œå±äºåˆæ³•åœ¨åœºï¼‰
               </li>
               <li>
                <strong>
                 åšç‰©é¦†/æ¡£æ¡ˆ/ç”°é‡
                </strong>
                ï¼šé«˜å¸¦å®½çš„éæ–‡æœ¬ä¿¡æ¯æ‘„å…¥ï¼ŒåŒ…æ‹¬å‚è§‚åšç‰©é¦†ã€æŸ¥é˜…å®ä½“æ¡£æ¡ˆã€è¿›è¡Œç”°é‡è§‚å¯Ÿ
               </li>
               <li>
                <strong>
                 è‰ºæœ¯/è§‚å½±
                </strong>
                ï¼šå…¶ä»–äººæ–‡ç¤¾ç§‘åœºæ™¯ï¼Œå¦‚è‰ºæœ¯å±•ï¼ˆè‰ºæœ¯å²ï¼‰ã€è§‚å½±/æˆå‰§ï¼ˆæ–‡åŒ–ç ”ç©¶/ä¼ åª’ï¼‰
               </li>
               <li>
                <strong>
                 æ·±åº¦æ™ºè¯†ç¤¾äº¤
                </strong>
                ï¼šä¸ææœ‰æ€æƒ³çš„åŒåƒš/æœ‹å‹è¿›è¡Œçš„é«˜å¯†åº¦å¯¹è¯ã€‚è¦æ±‚ï¼š
                <strong>
                 æœ‰ç‰¹å®šè®®é¢˜ã€æœ‰é€»è¾‘æ¨æ¼”
                </strong>
                ï¼ˆè¿™æ˜¯éæ­£å¼çš„å­¦æœ¯å…±åŒä½“å»ºè®¾ï¼‰
               </li>
               <li>
                <strong>
                 ç ”è®¨ä¼š/ç­”è¾©/æ±‡æŠ¥
                </strong>
                ï¼šå‚ä¸åœ†æ¡Œè®¨è®ºï¼Œæˆ–ä½œä¸ºä¸»è®²äºº/è¯„è®®äºº
               </li>
              </ul>
             </div>
             <div style="margin-top: 12px; padding: 8px; background: #fef2f2; border-left: 3px solid #ef4444;">
              <p>
               <strong>
                ğŸš« æ’é™¤é¡¹
               </strong>
               ï¼š
              </p>
              <ul style="margin-left: 20px; margin-bottom: 0;">
               <li>
                <strong>
                 é—²èŠ/åæ§½
                </strong>
                ï¼šæ— æ˜ç¡®è®®é¢˜çš„æƒ…ç»ªå®£æ³„ï¼ˆå±äº Bonus ç¤¾äº¤æˆ–ä¼‘æ¯ï¼‰
               </li>
               <li>
                <strong>
                 éå­¦æœ¯ä¼šè®®
                </strong>
                ï¼šè¡Œæ”¿ä¼šè®®ã€æŠ¥é”€æµç¨‹è®²è§£ç­‰ï¼ˆå±äº Buffer æ‚äº‹ï¼‰
               </li>
              </ul>
             </div>
             <div style="margin-top: 12px;">
              <p>
               <strong>
                âš–ï¸ è¯„åˆ†é€»è¾‘
               </strong>
               ï¼š
              </p>
              <ul style="margin-left: 20px;">
               <li>
                <strong>
                 å¸¸æ€ (3.0/h) - Input/Passive
                </strong>
                ï¼š
                <strong>
                 è¾“å…¥/æ¥æ”¶æ¨¡å¼
                </strong>
                ã€‚ä¾‹å¦‚ï¼šå¬è®²åº§ã€æ—å¬è¯¾ç¨‹ã€æŒ‚æœºå¬ä¼šã€å‚è§‚åšç‰©é¦†ã€æŸ¥æ¡£æ¡ˆã€è§‚å½±çœ‹å±•ã€æˆ–åœ¨èŠå¤©ä¸­ä¸»è¦ä½œä¸ºå€¾å¬è€…
               </li>
               <li>
                <strong>
                 ç»åœ° (5.0/h) - Output/Active
                </strong>
                ï¼š
                <strong>
                 è¾“å‡º/å¯¹æŠ—æ¨¡å¼
                </strong>
                ã€‚ä¾‹å¦‚ï¼šä½œä¸ºä¸»è®²äººï¼ˆSpeakerï¼‰ã€æ·±åº¦ç”°é‡è®¿è°ˆã€æˆ–è€…åœ¨æ™ºè¯†ç¤¾äº¤ä¸­è¿›è¡Œäº†é«˜å¼ºåº¦çš„å³æ—¶å¯¹æŠ—ä¸æ¦‚å¿µå»ºæ„
               </li>
              </ul>
             </div>
             <p style="margin-top: 12px; font-size: 0.9em; color: var(--color-text-secondary);">
              <em>
               ğŸ’¡ æ³¨ï¼šç°åœº L ä»»åŠ¡æŒ‰åŸºç¡€åˆ† (h Ã— 2.5) è®¡ç®—ï¼Œè‹¥æœ‰å®è´¨æ€§ç¬”è®°äº§å‡ºå¯æŒ‰ä¸Šè¿° Tier è®¡å…¥ Outputã€‚
              </em>
             </p>
            </div>
           </div>
           <div class="rules-section collapsed" id="rule-focus">
            <div class="rules-header" onclick="window.TPI.toggleRules('rule-focus')">
             ğŸ§  ä¸“æ³¨ç³»æ•° F (å¹²æ‰°ç‰©ç®¡åˆ¶)
            </div>
            <div class="rules-content">
             <div style="padding: 10px; background: #fee2e2; border-left: 4px solid #dc2626; margin-bottom: 16px;">
              <p style="margin: 0; font-weight: 600; color: #dc2626;">
               âš ï¸ æµ·æ£®å ¡é˜²æŠ–åè®® (Heisenberg Protocol)
              </p>
              <ul style="margin: 8px 0 0 20px; color: #991b1b;">
               <li>
                <strong>
                 ç¦æ­¢
                </strong>
                ï¼šåœ¨å·¥ä½œæ—¶æ®µï¼ˆBlockï¼‰è¿›è¡Œä¸­åˆ¤æ–­æˆ–è®°å½• F ç³»æ•°ï¼ˆé˜²æ­¢å…ƒè®¤çŸ¥ç›‘æ§ç ´åå¿ƒæµï¼‰
               </li>
               <li>
                <strong>
                 æ‰§è¡Œ
                </strong>
                ï¼šæ‰€æœ‰ F ç³»æ•°çš„å¡«æŠ¥ï¼Œ
                <strong>
                 å¿…é¡»
                </strong>
                å»¶è¿Ÿåˆ°è¯¥æ—¶æ®µå½»åº•ç»“æŸæ—¶è¿›è¡Œ
                <strong>
                 ä¸€æ¬¡æ€§äº‹åå›é¡¾
                </strong>
               </li>
              </ul>
             </div>
             <p>
              <strong>
               ğŸš« å¹²æ‰°ç‰©å®šä¹‰ (Definitions of Interference)
              </strong>
             </p>
             <ul style="margin-left: 20px;">
              <li>
               <strong>
                Type A (ç¤¾äº¤é€šè®¯)
               </strong>
               ï¼šå¾®ä¿¡ (WeChat)ã€é‚®ä»¶ã€å³æ—¶é€šè®¯
              </li>
              <li>
               <strong>
                Type B (è¢«åŠ¨å†…å®¹)
               </strong>
               ï¼šæ–°é—»ç½‘é¡µã€Bç«™/Youtube è§†é¢‘ã€æœ‹å‹åœˆ/ä¿¡æ¯æµ
              </li>
              <li>
               <strong>
                Type C (å·¥å…·æ¢ç´¢)
               </strong>
               ï¼šAI å·¥å…·è°ƒè¯• (GPT/Claude)ã€Obsidian æ’ä»¶æŠ˜è…¾ã€è½¯ä»¶å‡çº§
              </li>
             </ul>
             <p style="margin-top: 16px;">
              <strong>
               ğŸ“Š åˆ¤å®šæ ‡å‡† (Grading Criteria)
              </strong>
             </p>
             <ul style="margin-left: 20px;">
              <li>
               <strong>
                å¿ƒæµ (1.3) â€”â€” ç»å¯¹å±è”½
               </strong>
               ï¼š
               <ul style="margin-left: 20px; margin-top: 4px;">
                <li>
                 <strong>
                  Type B/C
                 </strong>
                 :
                 <strong>
                  0 æ¬¡
                 </strong>
                 ã€‚ä¸¥ç¦æ‰“å¼€ä»»ä½•æ–°é—»æˆ–å·¥å…·è°ƒè¯•
                </li>
                <li>
                 <strong>
                  Type A
                 </strong>
                 : ä»…å…è®¸å¤„ç†ç´§æ€¥å¼¹çª—ï¼ˆ&lt; 1åˆ†é’Ÿï¼‰ï¼Œ
                 <strong>
                  ç¦æ­¢
                 </strong>
                 ä¸»åŠ¨ç‚¹å¼€çº¢ç‚¹
                </li>
                <li>
                 <em>
                  å›é¡¾åˆ¤æ®
                 </em>
                 ï¼šæ—¶é—´"æ¶ˆå¤±"æ„Ÿå¼ºçƒˆï¼Œå®Œå…¨æœªå—å¤–ç•Œä¿¡æ¯æµæ‰“æ‰°
                </li>
                <li>
                 <em>
                  å¥–èµ
                 </em>
                 ï¼šæ‰€æœ‰äº§å‡ºä»·å€¼ä¸Šæµ® 30%
                </li>
               </ul>
              </li>
              <li style="margin-top: 8px;">
               <strong>
                å¸¸æ€ (1.0) â€”â€” é™åˆ¶æ€§å…±å­˜
               </strong>
               ï¼š
               <ul style="margin-left: 20px; margin-top: 4px;">
                <li>
                 <strong>
                  Type A
                 </strong>
                 : å•æ¬¡æ—¶é•¿
                 <strong>
                  &lt; 2åˆ†é’Ÿ
                 </strong>
                 ï¼Œä¸”å•ä¸€ Block å†…æ€»æ—¶é•¿
                 <strong>
                  &lt; 5åˆ†é’Ÿ
                 </strong>
                </li>
                <li>
                 <strong>
                  Type B/C
                 </strong>
                 : å•ä¸€ Block å†…æœ€å¤šå…è®¸
                 <strong>
                  2æ¬¡
                 </strong>
                 ï¼Œä¸”æ˜¯ä¸ºäº†è§£å†³å…·ä½“å­¦æœ¯é—®é¢˜ï¼ˆå¦‚æŸ¥èµ„æ–™/ä¿®bugï¼‰ï¼Œæ—¶é•¿
                 <strong>
                  &lt; 3åˆ†é’Ÿ
                 </strong>
                </li>
                <li>
                 <em>
                  å›é¡¾åˆ¤æ®
                 </em>
                 ï¼šæœ‰è½»å¾®ä¸­æ–­ï¼Œä½†åœ¨è§„å®šé˜ˆå€¼å†…è¿…é€Ÿå›å½’
                </li>
                <li>
                 <em>
                  å¥–èµ
                 </em>
                 ï¼šæ— å¥–æ— ç½š
                </li>
               </ul>
              </li>
              <li style="margin-top: 8px;">
               <strong>
                æ¶£æ•£ (0.7) â€”â€” é˜ˆå€¼å‡»ç©¿
               </strong>
               ï¼š
               <ul style="margin-left: 20px; margin-top: 4px;">
                <li>
                 <strong>
                  ä»»ä½•
                 </strong>
                 è¶…è¿‡ä¸Šè¿°å¸¸æ€é™åˆ¶çš„è¡Œä¸º
                </li>
                <li>
                 ç‰¹åˆ«æ˜¯ï¼šæ— ç›®çš„çš„
                 <strong>
                  Type C (AI/å·¥å…·)
                 </strong>
                 è°ƒè¯•è¶…è¿‡ 20åˆ†é’Ÿï¼Œæˆ–
                 <strong>
                  Type B (åˆ·è§†é¢‘)
                 </strong>
                 è¡Œä¸ºå‡ºç°
                </li>
                <li>
                 <em>
                  æŠ˜æ‰£
                 </em>
                 ï¼šæ‰€æœ‰äº§å‡ºä»·å€¼æ‰“7æŠ˜
                </li>
               </ul>
              </li>
             </ul>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
       <div class="table-container">
        <table class="mobile-optimized-table" id="ami-table">
         <thead>
          <tr>
           <th style="width: 120px;">
            ğŸ•’ æ—¶æ®µ (Block)
           </th>
           <th class="task-column">
            ğŸ“‹ ä»»åŠ¡ (Task)
           </th>
           <th class="center" style="width: 100px;">
            âœ… çŠ¶æ€
            <br/>
            (å®Œæˆ/æœªå®Œæˆ/è±å…/å…¶ä»–)
           </th>
           <th class="center" style="width: 220px;">
            â³ èµ·å§‹ - ç»“æŸ
           </th>
           <th class="center" style="width: 100px;">
            â³ æ—¶é•¿ ($h$)
            <br/>
            ($h \times 2.5$)
           </th>
           <th class="center" style="width: 120px;">
            ğŸ“– èµ·å§‹é¡µç 
            <br/>
            (Start Pg)
           </th>
           <th class="center" style="width: 160px;">
            ğŸ“„ é˜…è¯»é‡ ($P$)
            <br/>
            (Pages)
            <br/>
            <span style="font-size: 11px; padding: 2px; color: #6b7280;">
             Level I/IIé€‰æ‹©
            </span>
           </th>
           <th class="center" style="width: 480px;">
            âœï¸ å†™ä½œäº§å‡ºåˆ†ç±» (æŒ‰å­—æ•°/å°æ—¶)
           </th>
           <th class="center" style="width: 120px;">
            ğŸ§  ä¸“æ³¨ ($F$)
            <br/>
            (0.7/1.0/1.3)
           </th>
           <th class="center" style="width: 100px;">
            ğŸ† å•æ®µå¾—åˆ†
           </th>
           <th class="notes-column">
            ğŸ“ å¤‡æ³¨ (è®°å½•å…·ä½“æ–‡çŒ®/ç« èŠ‚)
           </th>
          </tr>
         </thead>
         <tbody>
          <!-- ä¸Šåˆæ—¶æ®µ -->
          <tr>
           <td class="row-header center">
            ğŸŒ… ä¸Šåˆ
            <br/>
            (8ç‚¹â€”11ç‚¹ï¼Œ3ä¸ªå°æ—¶)
           </td>
           <td>
            <textarea aria-label="ä¸Šåˆä»»åŠ¡" placeholder="ä»»åŠ¡æè¿°ï¼ˆæ¨ªå‘å±•å¼€ï¼‰..." rows="10" style="width: 100%; resize: vertical; min-height: 200px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="ä¸ŠåˆçŠ¶æ€" class="status-select" onchange="TPI.calculateAMI()">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <div style="display: flex; gap: 8px; justify-content: center;">
             <input aria-label="ä¸Šåˆå¼€å§‹æ—¶é—´" style="width: 100px;" type="time"/>
             <input aria-label="ä¸Šåˆç»“æŸæ—¶é—´" style="width: 100px;" type="time"/>
            </div>
           </td>
           <td class="center">
            <input aria-label="ä¸Šåˆæ—¶é•¿" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="1.0" step="0.5" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <input aria-label="èµ·å§‹é¡µç " min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="1" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
             <input aria-label="ä¸Šåˆé˜…è¯»é¡µæ•°" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="0" style="width: 70px;" type="number"/>
             <select aria-label="ä¸Šåˆè®¤çŸ¥è´Ÿè·" class="reading-level-select" onchange="TPI.calculateAMI()" style="width: 70px; font-size: 11px; padding: 2px;" title="Level I=åŸºç¡€é˜…è¯»Ã—1.0, Level II=æ·±åº¦é˜…è¯»Ã—1.5, Level III=æ”»åšé˜…è¯»Ã—2.0">
              <option selected="" value="1.0">
               Lv I (Ã—1.0)
              </option>
              <option value="1.5">
               Lv II (Ã—1.5)
              </option>
              <option value="2.0">
               Lv III (Ã—2.0)
              </option>
             </select>
            </div>
           </td>
           <td class="center">
            <div class="writing-output-vertical">
             <div class="writing-output-vertical-item" style="border-left: 3px solid #9ca3af; padding-left: 4px;">
              <span class="writing-output-vertical-label" title="ä¿¡æ¯æ¬è¿ã€æ•´ç†">
               Type A (Ã—0.7)
              </span>
              <input aria-label="ä¸ŠåˆType Aå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              <div class="writing-output-vertical-item" style="border-left: 3px solid #3b82f6; padding-left: 4px;">
               <span class="writing-output-vertical-label" title="è§‚ç‚¹è¾“å‡ºã€æ‰¹åˆ¤">
                Type B (Ã—1.0)
               </span>
               <input aria-label="ä¸ŠåˆType Bå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              </div>
              <div class="writing-output-vertical-item" style="border-left: 3px solid #10b981; padding-left: 4px;">
               <span class="writing-output-vertical-label" title="æ­£å¼å†™ä½œã€è®ºæ–‡">
                Type C (Ã—2.0)
               </span>
               <input aria-label="ä¸ŠåˆType Cå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              </div>
              <div class="writing-output-vertical-item">
               <span class="writing-output-vertical-label" title="é«˜ç†µå€¼éšœç¢çš„é«˜æ‘©æ“¦åŠ›å·¥ä½œ,é‡‡ç”¨å½“é‡äº§å‡ºæ³•(400å­—/å°æ—¶)ã€‚è¾“å…¥&lt;12è§†ä¸ºå°æ—¶æ•°,â‰¥12è§†ä¸ºå­—æ•°">
                Type D (Ã—3.0)
                <span style="font-size: 0.75em; color: #8b5cf6;">
                 âš ï¸
                </span>
               </span>
               <input aria-label="ä¸ŠåˆType Då­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°æˆ–å°æ—¶" step="0.1" title="è¾“å…¥&lt;12è§†ä¸ºå°æ—¶æ•°(è‡ªåŠ¨Ã—400),â‰¥12è§†ä¸ºå­—æ•°" type="number"/>
              </div>
              <div class="writing-output-vertical-item" style="border-left: 3px solid #8b5cf6; padding-left: 8px; display: flex; flex-direction: column; gap: 8px; background: #faf5ff; padding: 12px; border-radius: 6px; margin-top: 8px;">
               <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="writing-output-vertical-label" style="font-weight: 600; color: #7c3aed;" title="æ€ç»´ç»“æ™¶ (å¿…é¡»ä¸€å¥è¯è¯´æ¸…)">
                 Type S (Ã—2.0)
                </span>
                <input aria-label="ä¸ŠåˆType Såˆ†å€¼" class="writing-output-vertical-input" id="type-s-score-morning" min="0" onblur="validateTypeS('morning'); TPI.calculateAMI()" oninput="validateTypeS('morning'); TPI.calculateAMI()" placeholder="åˆ†å€¼" step="0.5" style="width: 70px; font-weight: 600;" type="number"/>
               </div>
               <div style="margin-top: 4px;">
                <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">
                 æ€ç»´ç»“æ™¶å†…å®¹ï¼ˆåˆ†æ•°&gt;0æ—¶å¿…å¡«ï¼‰
                </label>
                <textarea data-row="2" id="type-s-content-morning" oninput="validateTypeS('morning')" placeholder="[å¿…å¡«]åœ¨æ­¤è¾“å…¥ä¸€å¥è¯ç»“æ™¶..." style="width: 100%; min-height: 70px; padding: 8px; border: 1px dashed #8b5cf6; border-radius: 4px; font-size: 11px; padding: 2px; resize: vertical; background: white;"></textarea>
                <div id="type-s-error-morning" style="color: #ef4444; font-size: 0.75em; display: none; margin-top: 4px; font-weight: 600;">
                 âš ï¸ åˆ†æ•°&gt;0æ—¶å¿…é¡»å¡«å†™æ€ç»´ç»“æ™¶å†…å®¹ï¼
                </div>
               </div>
              </div>
              <div class="writing-output-vertical-item" style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-top: 8px; border-left: 3px solid #3b82f6;">
               <div style="margin-bottom: 8px;">
                <span class="writing-output-vertical-label" style="font-weight: 600; color: #1e40af;">
                 Field Læ¨¡å¼:
                </span>
               </div>
               <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                 <input name="field-l-mode-morning" onchange="updateFieldLMultiplier('morning')" style="cursor: pointer;" type="radio" value="input"/>
                 <span style="font-size: 0.9em; font-weight: 500;">
                  è¾“å…¥ (x3.0)
                 </span>
                </label>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                 <input name="field-l-mode-morning" onchange="updateFieldLMultiplier('morning')" style="cursor: pointer;" type="radio" value="output"/>
                 <span style="font-size: 0.9em; font-weight: 500;">
                  è¾“å‡º (x5.0)
                 </span>
                </label>
                <div style="flex: 1; min-width: 150px;">
                 <div id="field-l-multiplier-morning" style="font-size: 11px; padding: 2px; font-weight: 600; color: #2563eb; padding: 6px 12px; background: white; border-radius: 4px; text-align: center;">
                  å½“å‰: x3.0
                 </div>
                </div>
               </div>
               <div style="margin-top: 10px;">
                <div style="display: flex; gap: 8px; margin-bottom: 6px;">
                 <select class="field-l-scene-select" data-period="ä¸Šåˆ" onchange="fillFieldLTemplate(this)" style="flex: 1; padding: 4px 8px; border: 1px solid #3b82f6; border-radius: 4px; font-size: 11px; cursor: pointer;" title="ä¿®æ”¹41: é€‰æ‹©Lç±»åœºæ™¯å¿«é€Ÿå¡«å……">
                  <option value="">
                   -- é€‰æ‹©åœºæ™¯ç±»å‹ --
                  </option>
                  <option value="lecture">
                   ğŸ“š å­¦æœ¯è®²åº§/ç ”è®¨ä¼š
                  </option>
                  <option value="fieldwork">
                   ğŸï¸ ç”°é‡è°ƒæŸ¥/å®åœ°è€ƒå¯Ÿ
                  </option>
                  <option value="movie">
                   ğŸ¬ è‰ºæœ¯è§‚å½±/æ–‡åŒ–å±•è§ˆ
                  </option>
                  <option value="social">
                   ğŸ¤ æ·±åº¦å­¦æœ¯ç¤¾äº¤
                  </option>
                  <option value="seminar">
                   ğŸ’¬ å·¥ä½œåŠ/å°ç»„è®¨è®º
                  </option>
                  <option value="interview">
                   ğŸ™ï¸ æ·±åº¦è®¿è°ˆ/å£è¿°å²
                  </option>
                  <option value="other">
                   ğŸ“Œ å…¶ä»–ç°åœºæ´»åŠ¨
                  </option>
                 </select>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                 <span class="writing-output-vertical-label" style="color: #1e40af;">
                  ç°åœº L (Ã—3.0)
                 </span>
                 <input aria-label="ä¸Šåˆç°åœºLæ—¶é•¿" class="writing-output-vertical-input field-l-duration-morning" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å°æ—¶æ•° (å¦‚: 2.5)" step="0.5" style="flex: 1; max-width: 100px; font-weight: 600;" type="number"/>
                </div>
               </div>
              </div>
             </div>
            </div>
           </td>
           <td class="center">
            <div style="display: flex; gap: 4px; align-items: center; justify-content: center;">
             <select aria-label="ä¸Šåˆä¸“æ³¨ç³»æ•°" class="focus-coefficient-select" data-period="ä¸Šåˆ" onchange="TPI.calculateAMI()" style="width: 80px;" title="âš ï¸ è¯·åœ¨æ—¶æ®µç»“æŸåå›é¡¾å¡«å†™ï¼ˆæµ·æ£®å ¡é˜²æŠ–åè®®ï¼‰">
              <option value="0.7">
               0.7
              </option>
              <option selected="" value="1.0">
               1.0
              </option>
              <option value="1.3">
               1.3
              </option>
             </select>
            </div>
           </td>
           <td class="center">
            <input aria-label="ä¸Šåˆå¾—åˆ†" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="ä¸Šåˆå¤‡æ³¨" placeholder="å¤‡æ³¨... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="row-header center">
            â˜€ï¸ ä¸‹åˆ
            <br/>
            (15ç‚¹â€”17ç‚¹ï¼Œä¸¤ä¸ªå°æ—¶)
           </td>
           <td>
            <textarea aria-label="ä¸‹åˆä»»åŠ¡" placeholder="ä»»åŠ¡æè¿°ï¼ˆæ¨ªå‘å±•å¼€ï¼‰..." rows="10" style="width: 100%; resize: vertical; min-height: 200px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="ä¸‹åˆçŠ¶æ€" class="status-select" onchange="TPI.calculateAMI()">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <div style="display: flex; gap: 8px; justify-content: center;">
             <input aria-label="ä¸‹åˆå¼€å§‹æ—¶é—´" style="width: 100px;" type="time"/>
             <input aria-label="ä¸‹åˆç»“æŸæ—¶é—´" style="width: 100px;" type="time"/>
            </div>
           </td>
           <td class="center">
            <input aria-label="ä¸‹åˆæ—¶é•¿" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="1.0" step="0.5" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <input aria-label="èµ·å§‹é¡µç " min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="1" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
             <input aria-label="ä¸‹åˆé˜…è¯»é¡µæ•°" data-reading-input="" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="0" style="width: 70px;" type="number"/>
             <select aria-label="aria-label=" data-reading-level="" onchange="TPI.calculateAMI()" style="width: 70px; font-size: 11px; padding: 2px;" ä¸‹åˆé˜…è¯»éš¾åº¦"è®¤çŸ¥è´Ÿè·"="">
              <option value="1.0">
               Lv I (Ã—1.0)
              </option>
              <option value="1.5">
               Lv II (Ã—1.5)
              </option>
              <option value="2.0">
               Lv III (Ã—2.0)
              </option>
             </select>
            </div>
           </td>
           <td class="center">
            <div class="writing-output-vertical">
             <div class="writing-output-vertical-item" style="border-left: 3px solid #9ca3af; padding-left: 4px;">
              <span class="writing-output-vertical-label" title="ä¿¡æ¯æ¬è¿ã€æ•´ç†">
               Type A (Ã—0.5)
              </span>
              <input aria-label="ä¸‹åˆType Aå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              <div class="writing-output-vertical-item" style="border-left: 3px solid #3b82f6; padding-left: 4px;">
               <span class="writing-output-vertical-label" title="è§‚ç‚¹è¾“å‡ºã€æ‰¹åˆ¤">
                Type B (Ã—1.0)
               </span>
               <input aria-label="ä¸‹åˆType Bå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              </div>
              <div class="writing-output-vertical-item" style="border-left: 3px solid #10b981; padding-left: 4px;">
               <span class="writing-output-vertical-label" title="æ­£å¼å†™ä½œã€è®ºæ–‡">
                Type C (Ã—2.0)
               </span>
               <input aria-label="ä¸‹åˆType Cå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              </div>
              <div class="writing-output-vertical-item">
               <span class="writing-output-vertical-label" title="é«˜ç†µå€¼éšœç¢çš„é«˜æ‘©æ“¦åŠ›å·¥ä½œ,é‡‡ç”¨å½“é‡äº§å‡ºæ³•(400å­—/å°æ—¶)ã€‚è¾“å…¥&lt;12è§†ä¸ºå°æ—¶æ•°,â‰¥12è§†ä¸ºå­—æ•°">
                Type D (Ã—3.0)
                <span style="font-size: 0.75em; color: #8b5cf6;">
                 âš ï¸
                </span>
               </span>
               <input aria-label="ä¸‹åˆType Då­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°æˆ–å°æ—¶" step="0.1" title="è¾“å…¥&lt;12è§†ä¸ºå°æ—¶æ•°(è‡ªåŠ¨Ã—400),â‰¥12è§†ä¸ºå­—æ•°" type="number"/>
              </div>
              <div class="writing-output-vertical-item" style="border-left: 3px solid #8b5cf6; padding-left: 8px; display: flex; flex-direction: column; gap: 8px; background: #faf5ff; padding: 12px; border-radius: 6px; margin-top: 8px;">
               <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="writing-output-vertical-label" style="font-weight: 600; color: #7c3aed;" title="æ€ç»´ç»“æ™¶ (å¿…é¡»ä¸€å¥è¯è¯´æ¸…)">
                 Type S (Ã—2.0)
                </span>
                <input aria-label="ä¸‹åˆType Såˆ†å€¼" class="writing-output-vertical-input" id="type-s-score-afternoon" min="0" onblur="validateTypeS('afternoon'); TPI.calculateAMI()" oninput="validateTypeS('afternoon'); TPI.calculateAMI()" placeholder="åˆ†å€¼" step="0.5" style="width: 70px; font-weight: 600;" type="number"/>
               </div>
               <div style="margin-top: 4px;">
                <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">
                 æ€ç»´ç»“æ™¶å†…å®¹ï¼ˆåˆ†æ•°&gt;0æ—¶å¿…å¡«ï¼‰
                </label>
                <textarea data-row="2" id="type-s-content-afternoon" oninput="validateTypeS('afternoon')" placeholder="[å¿…å¡«]åœ¨æ­¤è¾“å…¥ä¸€å¥è¯ç»“æ™¶..." style="width: 100%; min-height: 70px; padding: 8px; border: 1px dashed #8b5cf6; border-radius: 4px; font-size: 11px; padding: 2px; resize: vertical; background: white;"></textarea>
                <div id="type-s-error-afternoon" style="color: #ef4444; font-size: 0.75em; display: none; margin-top: 4px; font-weight: 600;">
                 âš ï¸ åˆ†æ•°&gt;0æ—¶å¿…é¡»å¡«å†™æ€ç»´ç»“æ™¶å†…å®¹ï¼
                </div>
               </div>
              </div>
              <div class="writing-output-vertical-item" style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-top: 8px; border-left: 3px solid #3b82f6;">
               <div style="margin-bottom: 8px;">
                <span class="writing-output-vertical-label" style="font-weight: 600; color: #1e40af;">
                 Field Læ¨¡å¼:
                </span>
               </div>
               <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                 <input name="field-l-mode-afternoon" onchange="updateFieldLMultiplier('afternoon')" style="cursor: pointer;" type="radio" value="input"/>
                 <span style="font-size: 0.9em; font-weight: 500;">
                  è¾“å…¥ (x2.0)
                 </span>
                </label>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                 <input name="field-l-mode-afternoon" onchange="updateFieldLMultiplier('afternoon')" style="cursor: pointer;" type="radio" value="output"/>
                 <span style="font-size: 0.9em; font-weight: 500;">
                  è¾“å‡º (x3.0)
                 </span>
                </label>
                <div style="flex: 1; min-width: 150px;">
                 <div id="field-l-multiplier-afternoon" style="font-size: 11px; padding: 2px; font-weight: 600; color: #2563eb; padding: 6px 12px; background: white; border-radius: 4px; text-align: center;">
                  å½“å‰: x2.0
                 </div>
                </div>
               </div>
               <div style="margin-top: 10px;">
                <div style="display: flex; gap: 8px; margin-bottom: 6px;">
                 <select class="field-l-scene-select" data-period="ä¸‹åˆ" onchange="fillFieldLTemplate(this)" style="flex: 1; padding: 4px 8px; border: 1px solid #3b82f6; border-radius: 4px; font-size: 11px; cursor: pointer;" title="ä¿®æ”¹41: é€‰æ‹©Lç±»åœºæ™¯å¿«é€Ÿå¡«å……">
                  <option value="">
                   -- é€‰æ‹©åœºæ™¯ç±»å‹ --
                  </option>
                  <option value="lecture">
                   ğŸ“š å­¦æœ¯è®²åº§/ç ”è®¨ä¼š
                  </option>
                  <option value="fieldwork">
                   ğŸï¸ ç”°é‡è°ƒæŸ¥/å®åœ°è€ƒå¯Ÿ
                  </option>
                  <option value="movie">
                   ğŸ¬ è‰ºæœ¯è§‚å½±/æ–‡åŒ–å±•è§ˆ
                  </option>
                  <option value="social">
                   ğŸ¤ æ·±åº¦å­¦æœ¯ç¤¾äº¤
                  </option>
                  <option value="seminar">
                   ğŸ’¬ å·¥ä½œåŠ/å°ç»„è®¨è®º
                  </option>
                  <option value="interview">
                   ğŸ™ï¸ æ·±åº¦è®¿è°ˆ/å£è¿°å²
                  </option>
                  <option value="other">
                   ğŸ“Œ å…¶ä»–ç°åœºæ´»åŠ¨
                  </option>
                 </select>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                 <span class="writing-output-vertical-label" style="color: #1e40af;">
                  ç°åœº L (Ã—3.0)
                 </span>
                 <input aria-label="ä¸‹åˆç°åœºLæ—¶é•¿" class="writing-output-vertical-input field-l-duration-afternoon" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å°æ—¶æ•° (å¦‚: 2.5)" step="0.5" style="flex: 1; max-width: 100px; font-weight: 600;" type="number"/>
                </div>
               </div>
              </div>
             </div>
            </div>
           </td>
           <td class="center">
            <div style="display: flex; gap: 4px; align-items: center; justify-content: center;">
             <select aria-label="ä¸‹åˆä¸“æ³¨ç³»æ•°" class="focus-coefficient-select" data-period="ä¸‹åˆ" onchange="TPI.calculateAMI()" style="width: 80px;" title="âš ï¸ è¯·åœ¨æ—¶æ®µç»“æŸåå›é¡¾å¡«å†™ï¼ˆæµ·æ£®å ¡é˜²æŠ–åè®®ï¼‰">
              <option value="0.7">
               0.7
              </option>
              <option selected="" value="1.0">
               1.0
              </option>
              <option value="1.3">
               1.3
              </option>
             </select>
            </div>
           </td>
           <td class="center">
            <input aria-label="ä¸‹åˆå¾—åˆ†" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="ä¸‹åˆå¤‡æ³¨" placeholder="å¤‡æ³¨... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <!-- æ™šä¸Š1æ—¶æ®µ -->
          <tr>
           <td class="row-header center">
            ğŸŒ™ æ™šä¸Š1
            <br/>
            (18ç‚¹30â€”20ç‚¹ï¼Œä¸€ä¸ªåŠå°æ—¶)
           </td>
           <td>
            <textarea aria-label="æ™šä¸Š1ä»»åŠ¡" placeholder="ä»»åŠ¡æè¿°ï¼ˆæ¨ªå‘å±•å¼€ï¼‰..." rows="10" style="width: 100%; resize: vertical; min-height: 200px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="æ™šä¸Š1çŠ¶æ€" class="status-select" onchange="TPI.calculateAMI()">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <div style="display: flex; gap: 8px; justify-content: center;">
             <input aria-label="æ™šä¸Š1å¼€å§‹æ—¶é—´" style="width: 100px;" type="time"/>
             <input aria-label="æ™šä¸Š1ç»“æŸæ—¶é—´" style="width: 100px;" type="time"/>
            </div>
           </td>
           <td class="center">
            <input aria-label="æ™šä¸Š1æ—¶é•¿" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="1.5" step="0.5" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <input aria-label="æ™šä¸Š1èµ·å§‹é¡µç " min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="1" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
             <input aria-label="æ™šä¸Š1é˜…è¯»é¡µæ•°" data-reading-input="" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="0" style="width: 70px;" type="number"/>
             <select aria-label="aria-label=" data-reading-level="" onchange="TPI.calculateAMI()" style="width: 70px; font-size: 11px; padding: 2px;" æ™šä¸Š1é˜…è¯»éš¾åº¦"è®¤çŸ¥è´Ÿè·"="">
              <option value="1.0">
               Lv I (Ã—1.0)
              </option>
              <option value="1.5">
               Lv II (Ã—1.5)
              </option>
              <option value="2.0">
               Lv III (Ã—2.0)
              </option>
             </select>
            </div>
           </td>
           <td class="center">
            <div class="writing-output-vertical">
             <!-- Type A -->
             <div class="writing-output-vertical-item" style="border-left: 3px solid #9ca3af; padding-left: 4px;">
              <span class="writing-output-vertical-label" title="ä¿¡æ¯æ¬è¿ã€æ•´ç†">
               Type A (Ã—0.5)
              </span>
              <input aria-label="æ™šä¸Š1Type Aå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              <!-- Type B -->
              <div class="writing-output-vertical-item" style="border-left: 3px solid #3b82f6; padding-left: 4px;">
               <span class="writing-output-vertical-label" title="è§‚ç‚¹è¾“å‡ºã€æ‰¹åˆ¤">
                Type B (Ã—1.0)
               </span>
               <input aria-label="æ™šä¸Š1Type Bå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              </div>
              <!-- Type C -->
              <div class="writing-output-vertical-item" style="border-left: 3px solid #10b981; padding-left: 4px;">
               <span class="writing-output-vertical-label" title="æ­£å¼å†™ä½œã€è®ºæ–‡">
                Type C (Ã—2.0)
               </span>
               <input aria-label="æ™šä¸Š1Type Cå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              </div>
              <!-- Type D -->
              <div class="writing-output-vertical-item">
               <span class="writing-output-vertical-label" title="é«˜ç†µå€¼éšœç¢çš„é«˜æ‘©æ“¦åŠ›å·¥ä½œ,é‡‡ç”¨å½“é‡äº§å‡ºæ³•(400å­—/å°æ—¶)ã€‚è¾“å…¥&lt;12è§†ä¸ºå°æ—¶æ•°,â‰¥12è§†ä¸ºå­—æ•°">
                Type D (Ã—3.0)
                <span style="font-size: 0.75em; color: #8b5cf6;">
                 âš ï¸
                </span>
               </span>
               <input aria-label="æ™šä¸Š1Type Då­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°æˆ–å°æ—¶" step="0.1" title="è¾“å…¥&lt;12è§†ä¸ºå°æ—¶æ•°(è‡ªåŠ¨Ã—400),â‰¥12è§†ä¸ºå­—æ•°" type="number"/>
              </div>
              <!-- Type S - å®Œæ•´ç»“æ„ -->
              <div class="writing-output-vertical-item" style="border-left: 3px solid #8b5cf6; padding-left: 8px; display: flex; flex-direction: column; gap: 8px; background: #faf5ff; padding: 12px; border-radius: 6px; margin-top: 8px;">
               <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="writing-output-vertical-label" style="font-weight: 600; color: #7c3aed;" title="æ€ç»´ç»“æ™¶ (å¿…é¡»ä¸€å¥è¯è¯´æ¸…)">
                 Type S (Ã—2.0)
                </span>
                <input aria-label="æ™šä¸Š1Type Såˆ†å€¼" class="writing-output-vertical-input" id="type-s-score-evening1" min="0" onblur="validateTypeS('evening1'); TPI.calculateAMI()" oninput="validateTypeS('evening1'); TPI.calculateAMI()" placeholder="åˆ†å€¼" step="0.5" style="width: 70px; font-weight: 600;" type="number"/>
               </div>
               <div style="margin-top: 4px;">
                <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">
                 æ€ç»´ç»“æ™¶å†…å®¹ï¼ˆåˆ†æ•°&gt;0æ—¶å¿…å¡«ï¼‰
                </label>
                <textarea data-row="3" id="type-s-content-evening1" oninput="validateTypeS('evening1')" placeholder="[å¿…å¡«]åœ¨æ­¤è¾“å…¥ä¸€å¥è¯ç»“æ™¶..." style="width: 100%; min-height: 70px; padding: 8px; border: 1px dashed #8b5cf6; border-radius: 4px; font-size: 11px; padding: 2px; resize: vertical; background: white;"></textarea>
                <div id="type-s-error-evening1" style="color: #ef4444; font-size: 0.75em; display: none; margin-top: 4px; font-weight: 600;">
                 âš ï¸ åˆ†æ•°&gt;0æ—¶å¿…é¡»å¡«å†™æ€ç»´ç»“æ™¶å†…å®¹ï¼
                </div>
               </div>
              </div>
              <!-- Field L - å®Œæ•´æ¨¡å¼åˆ‡æ¢ -->
              <div class="writing-output-vertical-item" style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-top: 8px; border-left: 3px solid #3b82f6;">
               <div style="margin-bottom: 8px;">
                <span class="writing-output-vertical-label" style="font-weight: 600; color: #1e40af;">
                 Field Læ¨¡å¼:
                </span>
               </div>
               <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                 <input name="field-l-mode-evening1" onchange="updateFieldLMultiplier('evening1')" style="cursor: pointer;" type="radio" value="input"/>
                 <span style="font-size: 0.9em; font-weight: 500;">
                  è¾“å…¥ (x2.0)
                 </span>
                </label>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                 <input name="field-l-mode-evening1" onchange="updateFieldLMultiplier('evening1')" style="cursor: pointer;" type="radio" value="output"/>
                 <span style="font-size: 0.9em; font-weight: 500;">
                  è¾“å‡º (x3.0)
                 </span>
                </label>
                <div style="flex: 1; min-width: 150px;">
                 <div id="field-l-multiplier-evening1" style="font-size: 11px; padding: 2px; font-weight: 600; color: #2563eb; padding: 6px 12px; background: white; border-radius: 4px; text-align: center;">
                  å½“å‰: x2.0
                 </div>
                </div>
               </div>
               <div style="margin-top: 10px;">
                <div style="display: flex; gap: 8px; margin-bottom: 6px;">
                 <select class="field-l-scene-select" data-period="æ™šä¸Š1" onchange="fillFieldLTemplate(this)" style="flex: 1; padding: 4px 8px; border: 1px solid #3b82f6; border-radius: 4px; font-size: 11px; cursor: pointer;" title="ä¿®æ”¹41: é€‰æ‹©Lç±»åœºæ™¯å¿«é€Ÿå¡«å……">
                  <option value="">
                   -- é€‰æ‹©åœºæ™¯ç±»å‹ --
                  </option>
                  <option value="lecture">
                   ğŸ“š å­¦æœ¯è®²åº§/ç ”è®¨ä¼š
                  </option>
                  <option value="fieldwork">
                   ğŸï¸ ç”°é‡è°ƒæŸ¥/å®åœ°è€ƒå¯Ÿ
                  </option>
                  <option value="movie">
                   ğŸ¬ è‰ºæœ¯è§‚å½±/æ–‡åŒ–å±•è§ˆ
                  </option>
                  <option value="social">
                   ğŸ¤ æ·±åº¦å­¦æœ¯ç¤¾äº¤
                  </option>
                  <option value="seminar">
                   ğŸ’¬ å·¥ä½œåŠ/å°ç»„è®¨è®º
                  </option>
                  <option value="interview">
                   ğŸ™ï¸ æ·±åº¦è®¿è°ˆ/å£è¿°å²
                  </option>
                  <option value="other">
                   ğŸ“Œ å…¶ä»–ç°åœºæ´»åŠ¨
                  </option>
                 </select>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                 <span class="writing-output-vertical-label" style="color: #1e40af;">
                  ç°åœº L (Ã—3.0)
                 </span>
                 <input aria-label="æ™šä¸Š1ç°åœºLæ—¶é•¿" class="writing-output-vertical-input field-l-duration-evening1" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å°æ—¶æ•° (å¦‚: 2.5)" step="0.5" style="flex: 1; max-width: 100px; font-weight: 600;" type="number"/>
                </div>
               </div>
              </div>
             </div>
            </div>
           </td>
           <td class="center">
            <div style="display: flex; gap: 4px; align-items: center; justify-content: center;">
             <select aria-label="æ™šä¸Š1ä¸“æ³¨ç³»æ•°" class="focus-coefficient-select" data-period="æ™šä¸Š1" onchange="TPI.calculateAMI()" style="width: 80px;" title="âš ï¸ è¯·åœ¨æ—¶æ®µç»“æŸåå›é¡¾å¡«å†™ï¼ˆæµ·æ£®å ¡é˜²æŠ–åè®®ï¼‰">
              <option value="0.7">
               0.7
              </option>
              <option selected="" value="1.0">
               1.0
              </option>
              <option value="1.3">
               1.3
              </option>
             </select>
            </div>
           </td>
           <td class="center">
            <input aria-label="æ™šä¸Š1å¾—åˆ†" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="æ™šä¸Š1å¤‡æ³¨" placeholder="å¤‡æ³¨... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <!-- æ™šä¸Š2æ—¶æ®µ -->
          <tr>
           <td class="row-header center">
            ğŸŒ™ æ™šä¸Š2
            <br/>
            (20ç‚¹40â€”23ç‚¹ï¼Œä¸¤ä¸ªå°æ—¶20åˆ†é’Ÿ)
           </td>
           <td>
            <textarea aria-label="æ™šä¸Š2ä»»åŠ¡" placeholder="ä»»åŠ¡æè¿°ï¼ˆæ¨ªå‘å±•å¼€ï¼‰..." rows="10" style="width: 100%; resize: vertical; min-height: 200px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="æ™šä¸Š2çŠ¶æ€" class="status-select" onchange="TPI.calculateAMI()">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <div style="display: flex; gap: 8px; justify-content: center;">
             <input aria-label="æ™šä¸Š2å¼€å§‹æ—¶é—´" style="width: 100px;" type="time"/>
             <input aria-label="æ™šä¸Š2ç»“æŸæ—¶é—´" style="width: 100px;" type="time"/>
            </div>
           </td>
           <td class="center">
            <input aria-label="æ™šä¸Š2æ—¶é•¿" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="1.2" step="0.5" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <input aria-label="æ™šä¸Š2èµ·å§‹é¡µç " min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="1" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
             <input aria-label="æ™šä¸Š2é˜…è¯»é¡µæ•°" data-reading-input="" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="0" style="width: 70px;" type="number"/>
             <select aria-label="aria-label=" data-reading-level="" onchange="TPI.calculateAMI()" style="width: 70px; font-size: 11px; padding: 2px;" æ™šä¸Š2é˜…è¯»éš¾åº¦"è®¤çŸ¥è´Ÿè·"="">
              <option value="1.0">
               Lv I (Ã—1.0)
              </option>
              <option value="1.5">
               Lv II (Ã—1.5)
              </option>
              <option value="2.0">
               Lv III (Ã—2.0)
              </option>
             </select>
            </div>
           </td>
           <td class="center">
            <div class="writing-output-vertical">
             <!-- Type A -->
             <div class="writing-output-vertical-item" style="border-left: 3px solid #9ca3af; padding-left: 4px;">
              <span class="writing-output-vertical-label" title="ä¿¡æ¯æ¬è¿ã€æ•´ç†">
               Type A (Ã—0.5)
              </span>
              <input aria-label="æ™šä¸Š2Type Aå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              <!-- Type B -->
              <div class="writing-output-vertical-item" style="border-left: 3px solid #3b82f6; padding-left: 4px;">
               <span class="writing-output-vertical-label" title="è§‚ç‚¹è¾“å‡ºã€æ‰¹åˆ¤">
                Type B (Ã—1.0)
               </span>
               <input aria-label="æ™šä¸Š2Type Bå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              </div>
              <!-- Type C -->
              <div class="writing-output-vertical-item" style="border-left: 3px solid #10b981; padding-left: 4px;">
               <span class="writing-output-vertical-label" title="æ­£å¼å†™ä½œã€è®ºæ–‡">
                Type C (Ã—2.0)
               </span>
               <input aria-label="æ™šä¸Š2Type Cå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              </div>
              <!-- Type D -->
              <div class="writing-output-vertical-item">
               <span class="writing-output-vertical-label" title="é«˜ç†µå€¼éšœç¢çš„é«˜æ‘©æ“¦åŠ›å·¥ä½œ,é‡‡ç”¨å½“é‡äº§å‡ºæ³•(400å­—/å°æ—¶)ã€‚è¾“å…¥&lt;12è§†ä¸ºå°æ—¶æ•°,â‰¥12è§†ä¸ºå­—æ•°">
                Type D (Ã—3.0)
                <span style="font-size: 0.75em; color: #8b5cf6;">
                 âš ï¸
                </span>
               </span>
               <input aria-label="æ™šä¸Š2Type Då­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°æˆ–å°æ—¶" step="0.1" title="è¾“å…¥&lt;12è§†ä¸ºå°æ—¶æ•°(è‡ªåŠ¨Ã—400),â‰¥12è§†ä¸ºå­—æ•°" type="number"/>
              </div>
              <!-- Type S - å®Œæ•´ç»“æ„ -->
              <div class="writing-output-vertical-item" style="border-left: 3px solid #8b5cf6; padding-left: 8px; display: flex; flex-direction: column; gap: 8px; background: #faf5ff; padding: 12px; border-radius: 6px; margin-top: 8px;">
               <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="writing-output-vertical-label" style="font-weight: 600; color: #7c3aed;" title="æ€ç»´ç»“æ™¶ (å¿…é¡»ä¸€å¥è¯è¯´æ¸…)">
                 Type S (Ã—2.0)
                </span>
                <input aria-label="æ™šä¸Š2Type Såˆ†å€¼" class="writing-output-vertical-input" id="type-s-score-evening2" min="0" onblur="validateTypeS('evening2'); TPI.calculateAMI()" oninput="validateTypeS('evening2'); TPI.calculateAMI()" placeholder="åˆ†å€¼" step="0.5" style="width: 70px; font-weight: 600;" type="number"/>
               </div>
               <div style="margin-top: 4px;">
                <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">
                 æ€ç»´ç»“æ™¶å†…å®¹ï¼ˆåˆ†æ•°&gt;0æ—¶å¿…å¡«ï¼‰
                </label>
                <textarea data-row="4" id="type-s-content-evening2" oninput="validateTypeS('evening2')" placeholder="[å¿…å¡«]åœ¨æ­¤è¾“å…¥ä¸€å¥è¯ç»“æ™¶..." style="width: 100%; min-height: 70px; padding: 8px; border: 1px dashed #8b5cf6; border-radius: 4px; font-size: 11px; padding: 2px; resize: vertical; background: white;"></textarea>
                <div id="type-s-error-evening2" style="color: #ef4444; font-size: 0.75em; display: none; margin-top: 4px; font-weight: 600;">
                 âš ï¸ åˆ†æ•°&gt;0æ—¶å¿…é¡»å¡«å†™æ€ç»´ç»“æ™¶å†…å®¹ï¼
                </div>
               </div>
              </div>
              <!-- Field L - å®Œæ•´æ¨¡å¼åˆ‡æ¢ -->
              <div class="writing-output-vertical-item" style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-top: 8px; border-left: 3px solid #3b82f6;">
               <div style="margin-bottom: 8px;">
                <span class="writing-output-vertical-label" style="font-weight: 600; color: #1e40af;">
                 Field Læ¨¡å¼:
                </span>
               </div>
               <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                 <input name="field-l-mode-morning" onchange="updateFieldLMultiplier('morning')" style="cursor: pointer;" type="radio" value="input"/>
                 <span style="font-size: 0.9em; font-weight: 500;">
                  è¾“å…¥ (x2.0)
                 </span>
                </label>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                 <input name="field-l-mode-morning" onchange="updateFieldLMultiplier('morning')" style="cursor: pointer;" type="radio" value="output"/>
                 <span style="font-size: 0.9em; font-weight: 500;">
                  è¾“å‡º (x3.0)
                 </span>
                </label>
                <div style="flex: 1; min-width: 150px;">
                 <div id="field-l-multiplier-morning" style="font-size: 11px; padding: 2px; font-weight: 600; color: #2563eb; padding: 6px 12px; background: white; border-radius: 4px; text-align: center;">
                  å½“å‰: x2.0
                 </div>
                </div>
               </div>
               <div style="margin-top: 10px;">
                <div style="display: flex; gap: 8px; margin-bottom: 6px;">
                 <select class="field-l-scene-select" data-period="ä¸Šåˆ" onchange="fillFieldLTemplate(this)" style="flex: 1; padding: 4px 8px; border: 1px solid #3b82f6; border-radius: 4px; font-size: 11px; cursor: pointer;" title="ä¿®æ”¹41: é€‰æ‹©Lç±»åœºæ™¯å¿«é€Ÿå¡«å……">
                  <option value="">
                   -- é€‰æ‹©åœºæ™¯ç±»å‹ --
                  </option>
                  <option value="lecture">
                   ğŸ“š å­¦æœ¯è®²åº§/ç ”è®¨ä¼š
                  </option>
                  <option value="fieldwork">
                   ğŸï¸ ç”°é‡è°ƒæŸ¥/å®åœ°è€ƒå¯Ÿ
                  </option>
                  <option value="movie">
                   ğŸ¬ è‰ºæœ¯è§‚å½±/æ–‡åŒ–å±•è§ˆ
                  </option>
                  <option value="social">
                   ğŸ¤ æ·±åº¦å­¦æœ¯ç¤¾äº¤
                  </option>
                  <option value="seminar">
                   ğŸ’¬ å·¥ä½œåŠ/å°ç»„è®¨è®º
                  </option>
                  <option value="interview">
                   ğŸ™ï¸ æ·±åº¦è®¿è°ˆ/å£è¿°å²
                  </option>
                  <option value="other">
                   ğŸ“Œ å…¶ä»–ç°åœºæ´»åŠ¨
                  </option>
                 </select>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                 <span class="writing-output-vertical-label" style="color: #1e40af;">
                  ç°åœº L (Ã—2.0)
                 </span>
                 <input aria-label="æ™šä¸Š2ç°åœºLæ—¶é•¿" class="writing-output-vertical-input field-l-duration-evening2" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å°æ—¶æ•° (å¦‚: 2.5)" step="0.5" style="flex: 1; max-width: 100px; font-weight: 600;" type="number"/>
                </div>
               </div>
              </div>
             </div>
            </div>
           </td>
           <td class="center">
            <div style="display: flex; gap: 4px; align-items: center; justify-content: center;">
             <select aria-label="æ™šä¸Š2ä¸“æ³¨ç³»æ•°" class="focus-coefficient-select" data-period="æ™šä¸Š2" onchange="TPI.calculateAMI()" style="width: 80px;" title="âš ï¸ è¯·åœ¨æ—¶æ®µç»“æŸåå›é¡¾å¡«å†™ï¼ˆæµ·æ£®å ¡é˜²æŠ–åè®®ï¼‰">
              <option value="0.7">
               0.7
              </option>
              <option selected="" value="1.0">
               1.0
              </option>
              <option value="1.3">
               1.3
              </option>
             </select>
            </div>
           </td>
           <td class="center">
            <input aria-label="æ™šä¸Š2å¾—åˆ†" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="æ™šä¸Š2å¤‡æ³¨" placeholder="å¤‡æ³¨... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <!-- æœºåŠ¨æ—¶æ®µ -->
          <tr>
           <td class="row-header center">
            â±ï¸ æœºåŠ¨
           </td>
           <td>
            <textarea aria-label="æœºåŠ¨ä»»åŠ¡" placeholder="ä»»åŠ¡æè¿°ï¼ˆæ¨ªå‘å±•å¼€ï¼‰..." rows="10" style="width: 100%; resize: vertical; min-height: 200px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="æœºåŠ¨çŠ¶æ€" class="status-select" onchange="TPI.calculateAMI()">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <div style="display: flex; gap: 8px; justify-content: center;">
             <input aria-label="æœºåŠ¨å¼€å§‹æ—¶é—´" style="width: 100px;" type="time"/>
             <input aria-label="æœºåŠ¨ç»“æŸæ—¶é—´" style="width: 100px;" type="time"/>
            </div>
           </td>
           <td class="center">
            <input aria-label="æœºåŠ¨æ—¶é•¿" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="0.0" step="0.5" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <input aria-label="æœºåŠ¨èµ·å§‹é¡µç " min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="1" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
             <input aria-label="æœºåŠ¨é˜…è¯»é¡µæ•°" data-reading-input="" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="0" style="width: 70px;" type="number"/>
             <select aria-label="aria-label=" data-reading-level="" onchange="TPI.calculateAMI()" style="width: 70px; font-size: 11px; padding: 2px;" æœºåŠ¨é˜…è¯»éš¾åº¦"è®¤çŸ¥è´Ÿè·"="">
              <option value="1.0">
               Lv I (Ã—1.0)
              </option>
              <option value="1.5">
               Lv II (Ã—1.5)
              </option>
              <option value="2.0">
               Lv III (Ã—2.0)
              </option>
             </select>
            </div>
           </td>
           <td class="center">
            <div class="writing-output-vertical">
             <!-- Type A -->
             <div class="writing-output-vertical-item" style="border-left: 3px solid #9ca3af; padding-left: 4px;">
              <span class="writing-output-vertical-label" title="ä¿¡æ¯æ¬è¿ã€æ•´ç†">
               Type A (Ã—0.5)
              </span>
              <input aria-label="æœºåŠ¨Type Aå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              <!-- Type B -->
              <div class="writing-output-vertical-item" style="border-left: 3px solid #3b82f6; padding-left: 4px;">
               <span class="writing-output-vertical-label" title="è§‚ç‚¹è¾“å‡ºã€æ‰¹åˆ¤">
                Type B (Ã—1.0)
               </span>
               <input aria-label="æœºåŠ¨Type Bå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              </div>
              <!-- Type C -->
              <div class="writing-output-vertical-item" style="border-left: 3px solid #10b981; padding-left: 4px;">
               <span class="writing-output-vertical-label" title="æ­£å¼å†™ä½œã€è®ºæ–‡">
                Type C (Ã—2.0)
               </span>
               <input aria-label="æœºåŠ¨Type Cå­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°" step="100" type="number"/>
              </div>
              <!-- Type D -->
              <div class="writing-output-vertical-item">
               <span class="writing-output-vertical-label" title="é«˜ç†µå€¼éšœç¢çš„é«˜æ‘©æ“¦åŠ›å·¥ä½œ,é‡‡ç”¨å½“é‡äº§å‡ºæ³•(400å­—/å°æ—¶)ã€‚è¾“å…¥&lt;12è§†ä¸ºå°æ—¶æ•°,â‰¥12è§†ä¸ºå­—æ•°">
                Type D (Ã—3.0)
                <span style="font-size: 0.75em; color: #8b5cf6;">
                 âš ï¸
                </span>
               </span>
               <input aria-label="æœºåŠ¨Type Då­—æ•°" class="writing-output-vertical-input" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å­—æ•°æˆ–å°æ—¶" step="0.1" title="è¾“å…¥&lt;12è§†ä¸ºå°æ—¶æ•°(è‡ªåŠ¨Ã—400),â‰¥12è§†ä¸ºå­—æ•°" type="number"/>
              </div>
              <!-- Type S - å®Œæ•´ç»“æ„ -->
              <div class="writing-output-vertical-item" style="border-left: 3px solid #8b5cf6; padding-left: 8px; display: flex; flex-direction: column; gap: 8px; background: #faf5ff; padding: 12px; border-radius: 6px; margin-top: 8px;">
               <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="writing-output-vertical-label" style="font-weight: 600; color: #7c3aed;" title="æ€ç»´ç»“æ™¶ (å¿…é¡»ä¸€å¥è¯è¯´æ¸…)">
                 Type S (Ã—2.0)
                </span>
                <input aria-label="æœºåŠ¨Type Såˆ†å€¼" class="writing-output-vertical-input" id="type-s-score-flexible" min="0" onblur="validateTypeS('flexible'); TPI.calculateAMI()" oninput="validateTypeS('flexible'); TPI.calculateAMI()" placeholder="åˆ†å€¼" step="0.5" style="width: 70px; font-weight: 600;" type="number"/>
               </div>
               <div style="margin-top: 4px;">
                <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">
                 æ€ç»´ç»“æ™¶å†…å®¹ï¼ˆåˆ†æ•°&gt;0æ—¶å¿…å¡«ï¼‰
                </label>
                <textarea data-row="5" id="type-s-content-flexible" oninput="validateTypeS('flexible')" placeholder="[å¿…å¡«]åœ¨æ­¤è¾“å…¥ä¸€å¥è¯ç»“æ™¶..." style="width: 100%; min-height: 70px; padding: 8px; border: 1px dashed #8b5cf6; border-radius: 4px; font-size: 11px; padding: 2px; resize: vertical; background: white;"></textarea>
                <div id="type-s-error-flexible" style="color: #ef4444; font-size: 0.75em; display: none; margin-top: 4px; font-weight: 600;">
                 âš ï¸ åˆ†æ•°&gt;0æ—¶å¿…é¡»å¡«å†™æ€ç»´ç»“æ™¶å†…å®¹ï¼
                </div>
               </div>
              </div>
              <!-- Field L - å®Œæ•´æ¨¡å¼åˆ‡æ¢ -->
              <div class="writing-output-vertical-item" style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-top: 8px; border-left: 3px solid #3b82f6;">
               <div style="margin-bottom: 8px;">
                <span class="writing-output-vertical-label" style="font-weight: 600; color: #1e40af;">
                 Field Læ¨¡å¼:
                </span>
               </div>
               <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                 <input name="field-l-mode-flexible" onchange="updateFieldLMultiplier('flexible')" style="cursor: pointer;" type="radio" value="input"/>
                 <span style="font-size: 0.9em; font-weight: 500;">
                  è¾“å…¥ (x2.0)
                 </span>
                </label>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 6px 12px; background: white; border: 2px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;">
                 <input name="field-l-mode-flexible" onchange="updateFieldLMultiplier('flexible')" style="cursor: pointer;" type="radio" value="output"/>
                 <span style="font-size: 0.9em; font-weight: 500;">
                  è¾“å‡º (x3.0)
                 </span>
                </label>
                <div style="flex: 1; min-width: 150px;">
                 <div id="field-l-multiplier-flexible" style="font-size: 11px; padding: 2px; font-weight: 600; color: #2563eb; padding: 6px 12px; background: white; border-radius: 4px; text-align: center;">
                  å½“å‰: x3.0
                 </div>
                </div>
               </div>
               <div style="margin-top: 10px;">
                <div style="display: flex; gap: 8px; margin-bottom: 6px;">
                 <select class="field-l-scene-select" data-period="æœºåŠ¨" onchange="fillFieldLTemplate(this)" style="flex: 1; padding: 4px 8px; border: 1px solid #3b82f6; border-radius: 4px; font-size: 11px; cursor: pointer;" title="ä¿®æ”¹41: é€‰æ‹©Lç±»åœºæ™¯å¿«é€Ÿå¡«å……">
                  <option value="">
                   -- é€‰æ‹©åœºæ™¯ç±»å‹ --
                  </option>
                  <option value="lecture">
                   ğŸ“š å­¦æœ¯è®²åº§/ç ”è®¨ä¼š
                  </option>
                  <option value="fieldwork">
                   ğŸï¸ ç”°é‡è°ƒæŸ¥/å®åœ°è€ƒå¯Ÿ
                  </option>
                  <option value="movie">
                   ğŸ¬ è‰ºæœ¯è§‚å½±/æ–‡åŒ–å±•è§ˆ
                  </option>
                  <option value="social">
                   ğŸ¤ æ·±åº¦å­¦æœ¯ç¤¾äº¤
                  </option>
                  <option value="seminar">
                   ğŸ’¬ å·¥ä½œåŠ/å°ç»„è®¨è®º
                  </option>
                  <option value="interview">
                   ğŸ™ï¸ æ·±åº¦è®¿è°ˆ/å£è¿°å²
                  </option>
                  <option value="other">
                   ğŸ“Œ å…¶ä»–ç°åœºæ´»åŠ¨
                  </option>
                 </select>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                 <span class="writing-output-vertical-label" style="color: #1e40af;">
                  ç°åœº L (Ã—3.0)
                 </span>
                 <input aria-label="æœºåŠ¨ç°åœºLæ—¶é•¿" class="writing-output-vertical-input field-l-duration-flexible" min="0" onblur="TPI.calculateAMI()" oninput="TPI.calculateAMI()" placeholder="å°æ—¶æ•° (å¦‚: 2.5)" step="0.5" style="flex: 1; max-width: 100px; font-weight: 600;" type="number"/>
                </div>
               </div>
              </div>
             </div>
            </div>
           </td>
           <td class="center">
            <div style="display: flex; gap: 4px; align-items: center; justify-content: center;">
             <select aria-label="æœºåŠ¨ä¸“æ³¨ç³»æ•°" class="focus-coefficient-select" data-period="æœºåŠ¨" onchange="TPI.calculateAMI()" style="width: 80px;" title="âš ï¸ è¯·åœ¨æ—¶æ®µç»“æŸåå›é¡¾å¡«å†™ï¼ˆæµ·æ£®å ¡é˜²æŠ–åè®®ï¼‰">
              <option value="0.7">
               0.7
              </option>
              <option selected="" value="1.0">
               1.0
              </option>
              <option value="1.3">
               1.3
              </option>
             </select>
            </div>
           </td>
           <td class="center">
            <input aria-label="æœºåŠ¨å¾—åˆ†" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="æœºåŠ¨å¤‡æ³¨" placeholder="å¤‡æ³¨... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <!-- å¸¸é©»ä»»åŠ¡ -->
          <tr>
           <td class="row-header center">
            ã€å¸¸é©»ä»»åŠ¡ã€‘
           </td>
           <td colspan="11">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
             <input aria-label="å­¦æœ¯è®ºè‘—æ‰«æå¥–åŠ±" id="ami-scan-reading" onchange="TPI.calculateAMI()" type="checkbox" value="1"/>
             <span>
              <strong>
               ğŸ“– å­¦æœ¯è®ºè‘—æ‰«æ
              </strong>
              (æ¯æ—¥æ‰«æé˜…è¯» â‰¥ 100 é¡µ â†’
              <strong>
               ç‹¬ç«‹å¥–åŠ± +1 åˆ†
              </strong>
              )
             </span>
            </label>
           </td>
          </tr>
          <!-- ç»Ÿè®¡è¡Œ -->
          <tr class="summary-row">
           <td class="text-right" colspan="4">
            <strong>
             âˆ‘ ç»Ÿè®¡ / ä»Šæ—¥æŠ•å…¥æ€»é‡ï¼š
            </strong>
           </td>
           <td class="center">
            <strong>
             T =
             <span id="total-hours">
              0.0
             </span>
             h
            </strong>
           </td>
           <td>
           </td>
           <td class="center">
            <strong>
             P =
             <span id="total-pages">
              0
             </span>
             p
            </strong>
           </td>
           <td class="center" colspan="2">
            <strong>
             W =
             <span id="total-words">
              0
             </span>
             w
            </strong>
           </td>
           <td class="center">
            <strong>
             AMI æ€»åˆ†ï¼š
             <span id="ami-total-score">
              0
             </span>
             åˆ†
            </strong>
           </td>
           <td>
           </td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section>
     <!-- ==================== 8. BCM åŸºçŸ³ç³»ç»Ÿ ==================== -->
     <section class="card fade-in stagger-3" id="bcm">
      <div class="card-header" onclick="window.TPI.toggleCard('bcm')">
       <div class="card-title">
        <span class="icon">
         ğŸ”§
        </span>
        <span>
         ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºçŸ³ç³»ç»Ÿ (BCM - Behavior &amp; Core Metrics)
        </span>
       </div>
      </div>
      <div class="card-content">
       <!-- BCM ä½¿ç”¨è¯´æ˜ä¸è§„åˆ™ - æ•´åˆç‰ˆ -->
       <div class="rules-container mb-6">
        <div class="rules-section collapsed" id="bcm-rules">
         <div class="rules-header" onclick="window.TPI.toggleRules('bcm-rules')">
          ğŸ“˜ BCM ä½¿ç”¨è¯´æ˜ä¸è§„åˆ™ (Behavioral Control Module - Guide &amp; Rules)
         </div>
         <div class="rules-content">
          <h4>
           ğŸ¯ æ ¸å¿ƒç†å¿µ
          </h4>
          <p>
           BCM (Behavioral Control Module) æ˜¯è¡Œä¸ºçºªå¾‹ç³»ç»Ÿã€‚é€šè¿‡æ—¶é—´èŠ‚ç‚¹ç®¡ç†ï¼Œå»ºç«‹ç¨³å®šçš„ç”Ÿæ´»èŠ‚å¥ã€‚BCM æ˜¯æ•´ä¸ªç³»ç»Ÿçš„åŸºçŸ³ï¼Œä½äºé˜ˆå€¼å°†è§¦å‘ä¿æŠ¤æœºåˆ¶ã€‚
          </p>
          <h4 class="mt-4">
           ğŸ“Š è®¡åˆ†è§„åˆ™è¯¦è§£
          </h4>
          <ul>
           <li>
            <strong>
             æ™¨é—´å…¥é¦† (5åˆ†)ï¼š
            </strong>
            <ul>
             <li>
              ğŸ‘‘ ä¼ å¥‡ (&lt; 08:30): +5åˆ†
             </li>
             <li>
              ğŸ¥‡ æ”€ç™» (08:30â€”09:00 ä¸”æ¯”æ˜¨æ—¥æ—©): +3.5åˆ†
             </li>
             <li>
              ğŸ¥ˆ æ»å (08:30â€”09:00 ä¸”æ¯”æ˜¨æ—¥æ™š): +2.5åˆ†
             </li>
             <li>
              ğŸ¢ ç¼“å†² (09:00â€”09:30): +1.0åˆ†
             </li>
             <li>
              â­• å¤±æ•ˆ (&gt; 09:30): 0åˆ†
             </li>
            </ul>
           </li>
           <li>
            <strong>
             åˆé—´é˜²å®ˆ/æ™šé—´é˜²å®ˆ (å„3.5åˆ†)ï¼š
            </strong>
            <ul>
             <li>
              ğŸ›¡ï¸ åšå®ˆ (æœªå›å¯): +3.5åˆ†
             </li>
             <li>
              âš–ï¸ æˆ˜æœ¯ (â‰¤20m): +1.5åˆ†
             </li>
             <li>
              ğŸ§— æ”€ç™» (æ¯”ä¸Šæ¬¡çŸ­ â‰¥10min): +1.0åˆ†
             </li>
             <li>
              â­• ç»´æŒ: 0åˆ†
             </li>
             <li>
              ğŸ“‰ è°ƒèŠ‚ (æ¯”ä¸Šæ¬¡é•¿ â‰¥20min): -1.0åˆ†
             </li>
            </ul>
           </li>
           <li>
            <strong>
             æ™šé—´ç¦»é¦† (3åˆ†)ï¼š
            </strong>
            <ul>
             <li>
              ç¦»å¼€å·¥ä½œåŒºæ—¶é—´è®¡åˆ†
             </li>
             <li>
              ğŸ‘‘ ä¼ å¥‡ (&lt; 23:15): +3åˆ†
             </li>
             <li>
              ğŸ¥ˆ ç¨³å¥ (23:15 - 23:45): 2åˆ†
             </li>
             <li>
              ğŸ¥‰ å¼¹æ€§ (23:45 - 00:15): 1åˆ†
             </li>
             <li>
              â­• è¿‡æ™š (&gt; 00:15): 0åˆ†
             </li>
            </ul>
           </li>
           <li>
            <strong>
             ç¡çœ è®¡åˆ† (5åˆ†)ï¼š
            </strong>
            <ul>
             <li>
              é˜¶æ¢¯åŸºç¡€åˆ† + åŠ¨æ€ä¿®æ­£
             </li>
             <li>
              ğŸ‘‘ å®Œç¾ (&lt; 00:00): +5åˆ†
             </li>
             <li>
              ğŸ¥ˆ è¿›å– (00:00-00:30): 3åˆ†
             </li>
             <li>
              ğŸ¥‰ ä¸´ç•Œ (00:30-01:00): 1åˆ†
             </li>
             <li>
              â­• ç¼ºå£ (&gt; 01:00): 0åˆ† (è§¦å‘åŠ¨æ€æ¯”è¾ƒ)
             </li>
            </ul>
           </li>
           <li>
            <strong>
             æ•°å­—æ°”éš™ (3åˆ†)ï¼š
            </strong>
            <ul>
             <li>
              ç‰©ç†éš”ç¦»
             </li>
             <li>
              ğŸŸ¢ æ‰‹æœºæ”¾åœ¨äº†å®¿èˆæˆ–æ‰‹æœºå¸¦åˆ°äº†å›¾ä¹¦é¦†ä½†é”æœº: +3åˆ†
             </li>
             <li>
              â­• æ‰‹æœºå¸¦åˆ°äº†å›¾ä¹¦é¦†ä¸”æœªé”æœº: 0åˆ†
             </li>
            </ul>
           </li>
           <li>
            <strong>
             æ ¸å¿ƒå¥–åŠ±é¡¹ (+1.0åˆ†)ï¼š
            </strong>
            ä¸‹åˆæ—¶æ®µ AMI å®é™…æœ‰æ•ˆæ—¶é•¿ â‰¥ 1.5å°æ—¶
           </li>
          </ul>
          <h4 class="mt-4">
           ğŸ’¡ æ“ä½œå»ºè®®ä¸æ³¨æ„äº‹é¡¹
          </h4>
          <ul>
           <li>
            è®°å½•å‡†ç¡®æ—¶é—´ï¼Œä¾¿äºè®¡ç®—æ”€ç™»åˆ†
           </li>
           <li>
            ä¼˜å…ˆä¿è¯é«˜åˆ†é¡¹ï¼ˆæ™¨é—´å…¥é¦†ã€ç¡çœ ï¼‰
           </li>
           <li>
            é˜²å®ˆé¡¹ç›®é‡åœ¨ç¨³å®šï¼Œä¸è¿½æ±‚æç«¯
           </li>
           <li>
            æ™¨é—´å…¥é¦†å’Œæ™šé—´ç¦»é¦†ä½¿ç”¨å«ç¼“å†²çš„æœ€ç»ˆæ—¶é—´
           </li>
           <li>
            åˆé—´å’Œæ™šé—´é˜²å®ˆéœ€è®°å½•å®é™…æ—¶é•¿ç”¨äºå¯¹æ¯”
           </li>
           <li>
            æ•°å­—æ°”éš™è¦æ±‚ç‰©ç†éš”ç¦»ï¼ˆæ‰‹æœºé”æœºæˆ–ä¸å¸¦ï¼‰
           </li>
           <li>
            æ ¸å¿ƒå¥–åŠ±é¡¹éœ€ä¸‹åˆAMIâ‰¥1.5å°æ—¶æ‰èƒ½è·å¾—
           </li>
          </ul>
          <h4 class="mt-4">
           ğŸ§® è¯„åˆ†æœºåˆ¶
          </h4>
          <ul>
           <li>
            <strong>
             BCM å®šä¹‰ï¼š
            </strong>
            è¡Œä¸ºçºªå¾‹æŒ‡æ ‡ï¼ŒåŒ…å«æ—¥å¸¸è¡Œä¸ºçš„å¤šä¸ªå…³é”®èŠ‚ç‚¹
           </li>
           <li>
            ä½¿ç”¨æ¢¯æ¬¡è¯„åˆ†ï¼šæ ¹æ®å®Œæˆæ—¶é—´/æƒ…å†µç»™äºˆä¸åŒåˆ†æ•°
           </li>
           <li>
            æ”¯æŒæ”€ç™»åˆ†ï¼šç›¸æ¯”æ˜¨æ—¥æœ‰è¿›æ­¥æ—¶é¢å¤–åŠ åˆ†
           </li>
           <li>
            éƒ¨åˆ†é¡¹ç›®æœ‰è°ƒèŠ‚æœºåˆ¶ï¼šé€€æ­¥æ—¶æ‰£åˆ†
           </li>
           <li>
            <strong>
             ä»Šæ—¥/æ˜¨æ—¥å‚è€ƒå€¼ï¼š
            </strong>
            ç”¨äºæ”€ç™»åˆ†å’Œè°ƒèŠ‚åˆ†çš„è®¡ç®—ï¼Œéœ€è¦æ‰‹åŠ¨å¡«å†™å¯¹æ¯”æ•°æ®
           </li>
           <li>
            <strong>
             BCM å®å¾—åˆ†ä¸Šé™ï¼š24åˆ†
            </strong>
           </li>
           <li>
            <strong>
             ç›®æ ‡ï¼šæ»¡è´¯ï¼Œä¼˜åŒ–æˆæœ¬
            </strong>
           </li>
          </ul>
         </div>
        </div>
       </div>
       <div class="table-container">
        <table class="mobile-optimized-table">
         <thead>
          <tr>
           <th style="width: 60px;">
            ç¼–å·
           </th>
           <th style="width: 350px;">
            ğŸ¯ è¡Œä¸ºç›®æ ‡ä¸æ¢¯æ¬¡
           </th>
           <th class="center" style="width: 80px;">
            æ»¡åˆ†
           </th>
           <th class="center" style="width: 120px;">
            âœ… çŠ¶æ€
            <br/>
            (å®Œæˆ/æœªå®Œæˆ/è±å…/å…¶ä»–)
           </th>
           <th class="center" style="width: 120px;">
            ğŸ“‹ ä»Šæ—¥å‚è€ƒ
           </th>
           <th class="center" style="width: 120px;">
            ğŸ“‹ æ˜¨æ—¥å‚è€ƒ
           </th>
           <th class="center" style="width: 100px;">
            ğŸ† å®å¾—åˆ†
           </th>
           <th style="width: 250px;">
            ğŸ“ å¤‡æ³¨ (è®°å½•å…·ä½“æ—¶é—´/æƒ…å†µ)
           </th>
          </tr>
         </thead>
         <tbody>
          <!-- 1. æ™¨é—´å…¥é¦† -->
          <tr>
           <td class="center row-header">
            1
           </td>
           <td>
            <strong>
             â˜€ï¸ æ™¨é—´å…¥é¦† (Morning Bid)
            </strong>
            <br/>
            <small class="text-muted">
             *(å«ç¼“å†²æœ€ç»ˆæ—¶é—´,09:15å‰å®è¡Œè¿›æ­¥å¥–åŠ±æœºåˆ¶)*
             <br/>
             ğŸ‘‘
             <strong>
              ä¼ å¥‡ (&lt; 08:45)
             </strong>
             :
             <strong>
              +5 åˆ†
             </strong>
             <br/>
             ğŸ¥‡
             <strong>
              æ”€ç™» (08:45â€”09:15 ä¸”æ¯”æ˜¨æ—¥æ—©)
             </strong>
             :
             <strong>
              +3.5 åˆ†
             </strong>
             <br/>
             ğŸ¥ˆ
             <strong>
              æ»å (08:45â€”09:15 ä¸”æ¯”æ˜¨æ—¥æ™š)
             </strong>
             :
             <strong>
              +2.5 åˆ†
             </strong>
             <br/>
             ğŸ¢
             <strong>
              ç¼“å†² (09:15â€”09:45)
             </strong>
             :
             <strong>
              +1.0 åˆ†
             </strong>
             <br/>
             â­•
             <strong>
              å¤±æ•ˆ (&gt; 09:45)
             </strong>
             :
             <strong>
              0 åˆ†
             </strong>
             <br/>
             <span style="display:inline-block; margin-top:4px; padding:2px 6px; background:#e3f2fd; border-radius:3px;">
              ç³»ç»Ÿå‚è€ƒ â†’ ä»Šæ—¥:
              <span id="bcm-morning-ref-today" style="font-weight:bold;">
               --:--
              </span>
              | æ˜¨æ—¥:
              <span id="bcm-morning-ref-yesterday" style="font-weight:bold;">
               --:--
              </span>
             </span>
            </small>
           </td>
           <td class="center">
            <strong>
             5 (æ¢¯æ¬¡)
            </strong>
           </td>
           <td class="center">
            <select aria-label="æ™¨é—´å…¥é¦†çŠ¶æ€" class="status-select" onchange="calculateMorningScore(); calculateBCM(); calculateTPI();" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <label style="font-size:11px; display:block;">
             ä»Šæ—¥å…¥é¦†æ—¶é—´
            </label>
            <input aria-label="ä»Šæ—¥å…¥é¦†æ—¶é—´" id="bcm-morning-time" oninput="calculateMorningScore(); calculateBCM(); calculateTPI();" style="width: 100px;" type="time"/>
            <small style="font-size:10px; color:#666; display:block; margin-top:2px;">
             è¾“å…¥åè‡ªåŠ¨è®¡ç®—
            </small>
           </td>
           <td class="center">
            <label style="font-size:11px; display:block;">
             æ˜¨æ—¥å…¥é¦†æ—¶é—´
            </label>
            <input aria-label="æ˜¨æ—¥å…¥é¦†æ—¶é—´" id="bcm-morning-yesterday-time" oninput="calculateMorningScore(); calculateBCM(); calculateTPI();" style="width: 100px; font-size: 11px;" type="time"/>
            <small style="font-size:10px; color:#666; display:block; margin-top:2px;">
             è‡ªåŠ¨å¡«å……,å¯ä¿®æ”¹
            </small>
           </td>
           <td class="center">
            <input aria-label="æ™¨é—´å…¥é¦†å¾—åˆ†" id="bcm-morning-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary); font-weight: bold;" type="number"/>
           </td>
           <td>
            <textarea aria-label="æ™¨é—´å…¥é¦†å¤‡æ³¨" placeholder="å®é™…å…¥é¦†æ—¶é—´å’Œæƒ…å†µ... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <!-- 2. åˆé—´é˜²å®ˆ -->
          <tr>
           <td class="center row-header">
            2
           </td>
           <td>
            <strong>
             ğŸ° åˆé—´é˜²å®ˆ (Lunch Defense)
            </strong>
            <br/>
            <small class="text-muted">
             <strong>
              åŸºç¡€åˆ†(åŸºäºä»Šæ—¥åœ¨å®¿èˆæ—¶é—´)
             </strong>
             :
             <br/>
             ğŸ›¡ï¸
             <strong>
              åšå®ˆ(0åˆ†é’Ÿ)
             </strong>
             :
             <strong>
              +3.5åˆ†
             </strong>
             <br/>
             âš–ï¸
             <strong>
              æˆ˜æœ¯(1-20åˆ†é’Ÿ)
             </strong>
             :
             <strong>
              +1.5åˆ†
             </strong>
             <br/>
             â­•
             <strong>
              ç»´æŒ(&gt;20åˆ†é’Ÿ)
             </strong>
             :
             <strong>
              0åˆ†
             </strong>
             <br/>
             <strong>
              åŠ¨æ€å¥–æƒ©(ä¸æ˜¨æ—¥åœ¨å®¿èˆæ—¶é—´å¯¹æ¯”,å‡å°‘=è¿›æ­¥)
             </strong>
             :
             <br/>
             å‡å°‘â‰¥20åˆ†é’Ÿ:
             <strong>
              +1.5
             </strong>
             | å‡å°‘1-19åˆ†é’Ÿ:
             <strong>
              +0.5
             </strong>
             | ä¸€è‡´:
             <strong>
              0
             </strong>
             <br/>
             å¢åŠ 1-20åˆ†é’Ÿ:
             <strong>
              0
             </strong>
             | å¢åŠ 21-40åˆ†é’Ÿ:
             <strong>
              -0.5
             </strong>
             | å¢åŠ 41-60åˆ†é’Ÿ:
             <strong>
              -1.0
             </strong>
             | å¢åŠ &gt;60åˆ†é’Ÿ:
             <strong>
              -1.5
             </strong>
             <br/>
             <span id="bcm-lunch-status" style="font-weight:bold; color:var(--color-primary);">
              ç­‰å¾…è¾“å…¥...
             </span>
            </small>
           </td>
           <td class="center">
            <strong>
             3.5
            </strong>
           </td>
           <td class="center">
            <select aria-label="åˆé—´é˜²å®ˆçŠ¶æ€" class="status-select" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
            </select>
           </td>
           <td class="center">
            <label style="font-size:11px; display:block;">
             ä»Šæ—¥åœ¨å®¿èˆæ—¶é—´(åˆ†é’Ÿ)
            </label>
            <input aria-label="ä»Šæ—¥åˆé—´åœ¨å®¿èˆæ—¶é—´" id="bcm-lunch-today-duration" oninput="calculateDefenseScore('lunch'); calculateBCM(); calculateTPI();" placeholder="0=åšå®ˆ" style="width: 100px; text-align: center;" type="number"/>
            <small style="font-size:10px; color:#666; display:block; margin-top:2px;">
             0=åšå®ˆ,1-20=æˆ˜æœ¯,&gt;20=ç»´æŒ
            </small>
           </td>
           <td class="center">
            <label style="font-size:11px; display:block;">
             æ˜¨æ—¥åœ¨å®¿èˆæ—¶é—´(åˆ†é’Ÿ)
            </label>
            <input aria-label="æ˜¨æ—¥åˆé—´åœ¨å®¿èˆæ—¶é—´" id="bcm-lunch-yesterday-duration" oninput="calculateDefenseScore('lunch'); calculateBCM(); calculateTPI();" placeholder="è‡ªåŠ¨å¡«å……" style="width: 100px; text-align: center;" type="number"/>
            <small style="font-size:10px; color:#666; display:block; margin-top:2px;">
             ç³»ç»Ÿè‡ªåŠ¨å¡«å……,å¯ä¿®æ”¹
            </small>
           </td>
           <td class="center">
            <input aria-label="åˆé—´é˜²å®ˆå¾—åˆ†" id="bcm-lunch-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary); font-weight: bold;" type="number"/>
           </td>
           <td>
            <textarea aria-label="åˆé—´é˜²å®ˆå¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="2" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center row-header">
            3
           </td>
           <td>
            <strong>
             ğŸ° æ™šé—´é˜²å®ˆ (Dinner Defense)
            </strong>
            <br/>
            <small class="text-muted">
             <strong>
              åŸºç¡€åˆ†(åŸºäºä»Šæ—¥åœ¨å®¿èˆæ—¶é—´)
             </strong>
             :
             <br/>
             ğŸ›¡ï¸
             <strong>
              åšå®ˆ(0åˆ†é’Ÿ)
             </strong>
             :
             <strong>
              +3.5åˆ†
             </strong>
             <br/>
             âš–ï¸
             <strong>
              æˆ˜æœ¯(1-20åˆ†é’Ÿ)
             </strong>
             :
             <strong>
              +1.5åˆ†
             </strong>
             <br/>
             â­•
             <strong>
              ç»´æŒ(&gt;20åˆ†é’Ÿ)
             </strong>
             :
             <strong>
              0åˆ†
             </strong>
             <br/>
             <strong>
              åŠ¨æ€å¥–æƒ©(ä¸æ˜¨æ—¥åœ¨å®¿èˆæ—¶é—´å¯¹æ¯”,å‡å°‘=è¿›æ­¥)
             </strong>
             :
             <br/>
             å‡å°‘â‰¥20åˆ†é’Ÿ:
             <strong>
              +1.5
             </strong>
             | å‡å°‘1-19åˆ†é’Ÿ:
             <strong>
              +0.5
             </strong>
             | ä¸€è‡´:
             <strong>
              0
             </strong>
             <br/>
             å¢åŠ 1-20åˆ†é’Ÿ:
             <strong>
              0
             </strong>
             | å¢åŠ 21-40åˆ†é’Ÿ:
             <strong>
              -0.5
             </strong>
             | å¢åŠ 41-60åˆ†é’Ÿ:
             <strong>
              -1.0
             </strong>
             | å¢åŠ &gt;60åˆ†é’Ÿ:
             <strong>
              -1.5
             </strong>
             <br/>
             <span id="bcm-dinner-status" style="font-weight:bold; color:var(--color-primary);">
              ç­‰å¾…è¾“å…¥...
             </span>
            </small>
           </td>
           <td class="center">
            <strong>
             3.5
            </strong>
           </td>
           <td class="center">
            <select aria-label="æ™šé—´é˜²å®ˆçŠ¶æ€" class="status-select" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
            </select>
           </td>
           <td class="center">
            <label style="font-size:11px; display:block;">
             ä»Šæ—¥åœ¨å®¿èˆæ—¶é—´(åˆ†é’Ÿ)
            </label>
            <input aria-label="ä»Šæ—¥æ™šé—´åœ¨å®¿èˆæ—¶é—´" id="bcm-dinner-today-duration" oninput="calculateDefenseScore('dinner'); calculateBCM(); calculateTPI();" placeholder="0=åšå®ˆ" style="width: 100px; text-align: center;" type="number"/>
            <small style="font-size:10px; color:#666; display:block; margin-top:2px;">
             0=åšå®ˆ,1-20=æˆ˜æœ¯,&gt;20=ç»´æŒ
            </small>
           </td>
           <td class="center">
            <label style="font-size:11px; display:block;">
             æ˜¨æ—¥åœ¨å®¿èˆæ—¶é—´(åˆ†é’Ÿ)
            </label>
            <input aria-label="æ˜¨æ—¥æ™šé—´åœ¨å®¿èˆæ—¶é—´" id="bcm-dinner-yesterday-duration" oninput="calculateDefenseScore('dinner'); calculateBCM(); calculateTPI();" placeholder="è‡ªåŠ¨å¡«å……" style="width: 100px; text-align: center;" type="number"/>
            <small style="font-size:10px; color:#666; display:block; margin-top:2px;">
             ç³»ç»Ÿè‡ªåŠ¨å¡«å……,å¯ä¿®æ”¹
            </small>
           </td>
           <td class="center">
            <input aria-label="æ™šé—´é˜²å®ˆå¾—åˆ†" id="bcm-dinner-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary); font-weight: bold;" type="number"/>
           </td>
           <td>
            <textarea aria-label="æ™šé—´é˜²å®ˆå¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="2" style="width: 100%;"></textarea>
           </td>
          </tr>
          <!-- 4. æ™šé—´ç¦»é¦† -->
          <tr>
           <td class="center row-header">
            4
           </td>
           <td>
            <strong>
             ğŸ•™ æ™šé—´ç¦»é¦† (Dual Anchor)
            </strong>
            <br/>
            <small class="text-muted">
             *(ç¦»å¼€å·¥ä½œåŒºæ—¶é—´è®¡åˆ†)*
             <br/>
             ğŸ‘‘
             <strong>
              ä¼ å¥‡ (&lt; 23:15)
             </strong>
             :
             <strong>
              +3 åˆ†
             </strong>
             <br/>
             ğŸ¥ˆ
             <strong>
              ç¨³å¥ (23:15 - 23:45)
             </strong>
             :
             <strong>
              2 åˆ†
             </strong>
             <br/>
             ğŸ¥‰
             <strong>
              å¼¹æ€§ (23:45 - 00:15)
             </strong>
             :
             <strong>
              1 åˆ†
             </strong>
             <br/>
             â­•
             <strong>
              è¿‡æ™š (&gt; 00:15)
             </strong>
             :
             <strong>
              0 åˆ†
             </strong>
            </small>
           </td>
           <td class="center">
            <strong>
             3 (æ¢¯æ¬¡)
            </strong>
           </td>
           <td class="center">
            <select aria-label="æ™šé—´ç¦»é¦†çŠ¶æ€" class="status-select" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="æ™šé—´ç¦»é¦†æ—¶é—´" id="bcm-evening-exit" style="width: 100px;" type="time"/>
           </td>
           <td class="center">
            <input aria-label="æ˜¨æ—¥æ™šé—´ç¦»é¦†æ—¶é—´" id="bcm-evening-yesterday" style="width: 100px;" type="time"/>
           </td>
           <td class="center">
            <input aria-label="æ™šé—´ç¦»é¦†å¾—åˆ†" id="bcm-evening-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="æ™šé—´ç¦»é¦†å¤‡æ³¨" placeholder="ç¦»é¦†æ—¶é—´... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <!-- 5. ç¡çœ è®¡åˆ† -->
          <tr>
           <td class="center row-header">
            5
           </td>
           <td>
            <strong>
             ğŸŒ™ ç¡çœ è®¡åˆ† (Sleep)
            </strong>
            <br/>
            <small class="text-muted">
             <strong>
              é˜¶æ¢¯åŸºç¡€åˆ†
             </strong>
             :
             <br/>
             ğŸ‘‘
             <strong>
              å®Œç¾ (&lt; 00:00)
             </strong>
             :
             <strong>
              +5 åˆ†
             </strong>
             <br/>
             ğŸ¥ˆ
             <strong>
              è¿›å– (00:00 - 00:30)
             </strong>
             :
             <strong>
              +3 åˆ†
             </strong>
             <br/>
             ğŸ¥‰
             <strong>
              ä¸´ç•Œ (00:30 - 01:00)
             </strong>
             :
             <strong>
              +1 åˆ†
             </strong>
             <br/>
             â­•
             <strong>
              ç¼ºå£ (&gt; 01:00)
             </strong>
             :
             <strong>
              0 åˆ†
             </strong>
             <br/>
             <strong>
              åŠ¨æ€å¥–æƒ© (ä¸æ˜¨æ—¥å…¥ç¡æ—¶é—´å·® Î”t)
             </strong>
             :
             <br/>
             Î”t â‰¤ -30åˆ†é’Ÿ:
             <strong>
              +1.0
             </strong>
             | -30 &lt; Î”t â‰¤ 0:
             <strong>
              +0.5
             </strong>
             <br/>
             0 &lt; Î”t â‰¤ 30:
             <strong>
              0
             </strong>
             | 30 &lt; Î”t â‰¤ 60:
             <strong>
              -0.5
             </strong>
             | Î”t &gt; 60:
             <strong>
              -1.0
             </strong>
             <br/>
             ä»Šæ—¥:
             <span id="bcm-sleep-ref-today" style="font-weight:bold;">
              --:--
             </span>
             |
                                            æ˜¨æ—¥:
             <span id="bcm-sleep-ref-yesterday" style="font-weight:bold;">
              --:--
             </span>
            </small>
           </td>
           <td class="center">
            <strong>
             5 (æ¢¯æ¬¡)
            </strong>
           </td>
           <td class="center">
            <select aria-label="ç¡çœ çŠ¶æ€" class="status-select" onchange="calculateSleepScore(); calculateBCM(); calculateTPI();" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å…¥ç¡æ—¶é—´" id="bcm-sleep-time" oninput="calculateSleepScore(); calculateBCM(); calculateTPI();" style="width: 100px;" type="time"/>
           </td>
           <td class="center">
            <input aria-label="æ˜¨æ—¥å…¥ç¡æ—¶é—´" id="bcm-sleep-yesterday" style="width: 100px;" type="time"/>
           </td>
           <td class="center">
            <input aria-label="ç¡çœ å¾—åˆ†" id="bcm-sleep-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary); font-weight: bold;" type="number"/>
           </td>
           <td>
            <textarea aria-label="ç¡çœ å¤‡æ³¨" placeholder="ç¡çœ æƒ…å†µ... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <!-- 6. æ•°å­—æ°”éš™ -->
          <tr>
           <td class="center row-header">
            6
           </td>
           <td>
            <strong>
             ğŸ“µ æ•°å­—æ°”éš™ (Toolbox)
            </strong>
            <br/>
            <small class="text-muted">
             *(ç‰©ç†éš”ç¦»)*
             <br/>
             ğŸŸ¢
             <strong>
              æ‰‹æœºæ”¾åœ¨äº†å®¿èˆæˆ–è€…æ‰‹æœºå¸¦åˆ°äº†å›¾ä¹¦é¦†ï¼Œä½†é”æœº
             </strong>
             :
             <strong>
              +3 åˆ†
             </strong>
             <br/>
             â­•
             <strong>
              æ‰‹æœºå¸¦åˆ°äº†å›¾ä¹¦é¦†ï¼Œå¹¶ä¸”æœªé”æœº
             </strong>
             :
             <strong>
              0åˆ†
             </strong>
            </small>
           </td>
           <td class="center">
            <strong>
             3
            </strong>
           </td>
           <td class="center">
            <select aria-label="æ•°å­—æ°”éš™çŠ¶æ€" class="status-select" id="bcm-digital-status" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            --
           </td>
           <td class="center">
            --
           </td>
           <td class="center">
            <input aria-label="æ•°å­—æ°”éš™å¾—åˆ†" id="bcm-digital-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="æ•°å­—æ°”éš™å¤‡æ³¨" placeholder="æ‰‹æœºç®¡ç†æƒ…å†µ... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center row-header">
            7
           </td>
           <td>
            <strong>
             âœ… æ ¸å¿ƒå¥–åŠ±é¡¹ï¼šä¸‹åˆæ ¸å¿ƒå­¦ä¹ æ—¶é—´ç»´æŒ
            </strong>
            <br/>
            <small class="text-success">
             *(ä¸‹åˆæ—¶æ®µ $\text{AMI}$ å®é™…æœ‰æ•ˆæ—¶é•¿ $\ge 1.5\text{ å°æ—¶}$)*
            </small>
           </td>
           <td class="center">
            <strong>
             +1.0
            </strong>
           </td>
           <td class="center">
            <select aria-label="ä¸‹åˆå­¦ä¹ ç»´æŒçŠ¶æ€" class="status-select" id="bcm-afternoon-status" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            --
           </td>
           <td class="center">
            --
           </td>
           <td class="center">
            <input aria-label="ä¸‹åˆå¥–åŠ±å¾—åˆ†" id="bcm-afternoon-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="ä¸‹åˆå¥–åŠ±å¤‡æ³¨" placeholder="ä¸‹åˆå­¦ä¹ æƒ…å†µ... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <!-- æ€»è®¡ -->
          <tr class="summary-row">
           <td class="text-right" colspan="6">
            <strong>
             $\text{BCM}$ å®å¾—åˆ† (ä¸Šé™ 24 åˆ†)
            </strong>
           </td>
           <td class="center">
            <strong>
             <span id="bcm-total-score">
              0
             </span>
            </strong>
           </td>
           <td class="text-center">
            <strong>
             ç›®æ ‡æ»¡è´¯ï¼Œä¼˜åŒ–æˆæœ¬
            </strong>
           </td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section>
     <section class="card fade-in stagger-5" id="hsm">
      <div class="card-header" onclick="window.TPI.toggleCard('hsm')">
       <div class="card-title">
        <span class="icon">
         ğŸ›¡ï¸
        </span>
        <span>
         ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¥åº·ä¸ç¨³å®šæ€§ (HSM - Health &amp; Stability Metrics)
        </span>
       </div>
      </div>
      <div class="card-content">
       <div class="alert alert-info mb-6">
        <h4>
         ğŸ“˜ HSM ä½¿ç”¨è¯´æ˜ä¸è¯„åˆ†è§„åˆ™
        </h4>
        <h5 class="mt-3">
         ğŸ¯ æ ¸å¿ƒç†å¿µ
        </h5>
        <p>
         HSM (Health &amp; Stability Metrics) æ˜¯å¥åº·ä¸ç¨³å®šæ€§ç®¡ç†ç³»ç»Ÿã€‚å¥åº·æ˜¯ä¸€åˆ‡çš„åŸºç¡€ï¼Œèº«ä½“çŠ¶æ€ç›´æ¥å½±å“å­¦æœ¯äº§å‡ºå’Œç³»ç»Ÿçš„å¯æŒç»­æ€§ã€‚
        </p>
        <h5 class="mt-3">
         ğŸ“Š è®¡åˆ†è§„åˆ™è¯¦è§£
        </h5>
        <ul>
         <li>
          <strong>
           æ ¸å¿ƒç”Ÿå­˜è¿åŠ¨ï¼ˆ4åˆ†ï¼‰
          </strong>
          ï¼š
          <ul>
           <li>
            ç±»å‹ï¼šè·‘æ­¥/æœ‰æ°§è¿åŠ¨ç­‰
           </li>
           <li>
            æœªå®Œæˆ = 0åˆ†
           </li>
           <li>
            å®Œæˆ = 4åˆ†
           </li>
           <li>
            è±å… = 3åˆ†ï¼ˆéœ€åœ¨è±å…å£°æ˜åŒºè¯´æ˜ç†ç”±ï¼‰
           </li>
          </ul>
         </li>
         <li>
          <strong>
           å¾®è¿åŠ¨ï¼ˆæ¯æ¬¡0.5åˆ†ï¼‰
          </strong>
          ï¼š
          <ul>
           <li>
            ä¸Šåˆå¾®è¿åŠ¨ (5 åˆ†é’Ÿ)ï¼š0.5åˆ†
           </li>
           <li>
            ä¸‹åˆå¾®è¿åŠ¨ (5 åˆ†é’Ÿ)ï¼š0.5åˆ†
           </li>
           <li>
            ç›®çš„ï¼šåœ¨å­¦ä¹ é—´éš™è¿›è¡ŒçŸ­æ—¶é—´èº«ä½“æ´»åŠ¨ï¼Œä¿æŒè¡€æ¶²å¾ªç¯ï¼Œæå‡ä¸“æ³¨åº¦
           </li>
           <li>
            ç®€å•çš„æ‹‰ä¼¸ã€èµ°åŠ¨å³å¯
           </li>
          </ul>
         </li>
         <li>
          <strong>
           å–æ°´é¡¹ç›®ï¼ˆæ¯æ¯0.1åˆ†ï¼‰
          </strong>
          ï¼š
          <ul>
           <li>
            ä¸Šåˆå–æ°´è‡³å°‘ 1 æ¯ï¼š0.1åˆ†
           </li>
           <li>
            ä¸‹åˆå–æ°´è‡³å°‘ 1 æ¯ï¼š0.1åˆ†
           </li>
           <li>
            æ™šä¸Šå–æ°´è‡³å°‘ 1 æ¯ï¼š0.1åˆ†
           </li>
           <li>
            ç›®çš„ï¼šä¿æŒèº«ä½“æ°´åˆ†å¹³è¡¡ï¼Œç»´æŒåŸºæœ¬å¥åº·
           </li>
          </ul>
         </li>
        </ul>
        <h5 class="mt-3">
         ğŸ§® æ€»åˆ†è®¡ç®—
        </h5>
        <p>
         <strong>
          HSM å®å¾—åˆ†ä¸Šé™ï¼š5.3åˆ†
         </strong>
        </p>
        <p>
         <strong>
          è®¡ç®—å…¬å¼
         </strong>
         ï¼šHSM = æ ¸å¿ƒç”Ÿå­˜è¿åŠ¨(4) + ä¸Šåˆå¾®è¿åŠ¨(0.5) + ä¸‹åˆå¾®è¿åŠ¨(0.5) + å–æ°´(0.3)
        </p>
       </div>
       <div class="table-container">
        <table class="mobile-optimized-table">
         <thead>
          <tr>
           <th style="width: 60px;">
            ç¼–å·
           </th>
           <th style="width: 350px;">
            ğŸ”‹ ç»´ç”Ÿé¡¹ç›® (ç”Ÿå­˜æ€§è¿åŠ¨)
           </th>
           <th class="center" style="width: 100px;">
            æ»¡åˆ†
           </th>
           <th class="center" style="width: 150px;">
            âœ… çŠ¶æ€
            <br/>
            (å®Œæˆ/æœªå®Œæˆ/è±å…/å…¶ä»–)
           </th>
           <th class="center" style="width: 100px;">
            ğŸ† å¾—åˆ†
           </th>
           <th style="width: 300px;">
            ğŸ“ å¤‡æ³¨ (è¿åŠ¨æ—¶é—´/åœ°ç‚¹/è±å…ç†ç”±)
           </th>
          </tr>
         </thead>
         <tbody>
          <tr>
           <td class="center row-header">
            1
           </td>
           <td>
            <strong>
             ğŸ‹ï¸ æ ¸å¿ƒç”Ÿå­˜è¿åŠ¨
            </strong>
            <br/>
            <small class="text-muted">
             *(è·‘æ­¥/æœ‰æ°§ã€‚æœªå®Œæˆ=0åˆ†;å®Œæˆ=4åˆ†ï¼Œè±å…=3åˆ†)*
            </small>
           </td>
           <td class="center">
            <strong>
             4
            </strong>
           </td>
           <td class="center">
            <select aria-label="æ ¸å¿ƒè¿åŠ¨çŠ¶æ€" class="status-select" id="hsm-core-status" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="æ ¸å¿ƒè¿åŠ¨å¾—åˆ†" id="hsm-core-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="æ ¸å¿ƒè¿åŠ¨å¤‡æ³¨" placeholder="è¿åŠ¨æ—¶é—´/åœ°ç‚¹/è±å…ç†ç”±... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center row-header">
            2
           </td>
           <td>
            <strong>
             ğŸ¤¸ ä¸Šåˆå¾®è¿åŠ¨ (5 åˆ†é’Ÿ)
            </strong>
            <br/>
            <small class="text-muted">
             *(åŸºç¡€åˆ† 0.5 åˆ†)*
            </small>
           </td>
           <td class="center">
            <strong>
             0.5
            </strong>
           </td>
           <td class="center">
            <select aria-label="ä¸Šåˆå¾®è¿åŠ¨çŠ¶æ€" class="status-select" id="hsm-morning-status" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="ä¸Šåˆå¾®è¿åŠ¨å¾—åˆ†" id="hsm-morning-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="ä¸Šåˆå¾®è¿åŠ¨å¤‡æ³¨" placeholder="è¿åŠ¨å†…å®¹... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center row-header">
            3
           </td>
           <td>
            <strong>
             ğŸ¤¸ ä¸‹åˆå¾®è¿åŠ¨ (5 åˆ†é’Ÿ)
            </strong>
            <br/>
            <small class="text-muted">
             *(åŸºç¡€åˆ† 0.5 åˆ†)*
            </small>
           </td>
           <td class="center">
            <strong>
             0.5
            </strong>
           </td>
           <td class="center">
            <select aria-label="ä¸‹åˆå¾®è¿åŠ¨çŠ¶æ€" class="status-select" id="hsm-afternoon-status" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="ä¸‹åˆå¾®è¿åŠ¨å¾—åˆ†" id="hsm-afternoon-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="ä¸‹åˆå¾®è¿åŠ¨å¤‡æ³¨" placeholder="è¿åŠ¨å†…å®¹... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center row-header">
            4
           </td>
           <td>
            <strong>
             ğŸ¥¤ ä¸Šåˆå–æ°´è‡³å°‘ 1 æ¯
            </strong>
           </td>
           <td class="center">
            <strong>
             0.1
            </strong>
           </td>
           <td class="center">
            <select aria-label="ä¸Šåˆå–æ°´çŠ¶æ€" class="status-select" id="hsm-water-morning-status" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="ä¸Šåˆå–æ°´å¾—åˆ†" id="hsm-water-morning-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="ä¸Šåˆå–æ°´å¤‡æ³¨" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center row-header">
            5
           </td>
           <td>
            <strong>
             ğŸ¥¤ ä¸‹åˆå–æ°´è‡³å°‘ 1 æ¯
            </strong>
           </td>
           <td class="center">
            <strong>
             0.1
            </strong>
           </td>
           <td class="center">
            <select aria-label="ä¸‹åˆå–æ°´çŠ¶æ€" class="status-select" id="hsm-water-afternoon-status" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="ä¸‹åˆå–æ°´å¾—åˆ†" id="hsm-water-afternoon-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="ä¸‹åˆå–æ°´å¤‡æ³¨" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center row-header">
            6
           </td>
           <td>
            <strong>
             ğŸ¥¤ æ™šä¸Šå–æ°´è‡³å°‘ 1 æ¯
            </strong>
           </td>
           <td class="center">
            <strong>
             0.1
            </strong>
           </td>
           <td class="center">
            <select aria-label="æ™šä¸Šå–æ°´çŠ¶æ€" class="status-select" id="hsm-water-evening-status" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="æ™šä¸Šå–æ°´å¾—åˆ†" id="hsm-water-evening-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="æ™šä¸Šå–æ°´å¤‡æ³¨" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr class="summary-row">
           <td class="text-right" colspan="4">
            <strong>
             $\text{HSM}$ å®å¾—åˆ† (ä¸Šé™ 5.3 åˆ†)
            </strong>
           </td>
           <td class="center">
            <strong>
             <span id="hsm-total-score">
              0
             </span>
            </strong>
           </td>
           <td>
           </td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section>
     <section class="card fade-in stagger-2" id="fli">
      <div class="card-header" onclick="window.TPI.toggleCard('fli')">
       <div class="card-title">
        <span class="icon">
         ğŸ—£ï¸
        </span>
        <span>
         ç¬¬å››éƒ¨åˆ†ï¼šå¤–è¯­æŠ€èƒ½å®éªŒå®¤ (FLI - Foreign Language Index)
        </span>
       </div>
      </div>
      <div class="card-content">
       <!-- FLI ä½¿ç”¨è¯´æ˜ä¸è§„åˆ™ - æ•´åˆç‰ˆ -->
       <div class="rules-container mb-6">
        <div class="rules-section collapsed" id="fli-rules">
         <div class="rules-header" onclick="window.TPI.toggleRules('fli-rules')">
          ğŸ“˜ FLI ä½¿ç”¨è¯´æ˜ä¸è§„åˆ™ (Foreign Language Index - Guide &amp; Rules)
         </div>
         <div class="rules-content">
          <h4>
           ğŸ¯ æ ¸å¿ƒç†å¿µ
          </h4>
          <p>
           FLI (Foreign Language Infrastructure) æ˜¯å¤–è¯­å­¦ä¹ ç³»ç»Ÿã€‚è¯­è¨€æ˜¯äººæ–‡ç ”ç©¶çš„é€é•œï¼Œå¤–è¯­èƒ½åŠ›çš„æå‡å°†ç›´æ¥æœåŠ¡äºå­¦æœ¯ç ”ç©¶çš„æ·±åº¦ä¸å¹¿åº¦ã€‚ç¢ç‰‡åŒ–å­¦ä¹ æ¯”é›†ä¸­çªå‡»æ›´æœ‰æ•ˆã€‚
          </p>
          <h4 class="mt-4">
           ğŸ“Š è®¡åˆ†è§„åˆ™è¯¦è§£
          </h4>
          <p>
           <strong>
            FLI æ€»åˆ† = æ ¸å¿ƒå­¦ä¹ å¾—åˆ† + ç¢ç‰‡ç£¨è€³å¾—åˆ† + å¯åŠ¨èƒ½é‡åˆ†
           </strong>
          </p>
          <ul>
           <li>
            <strong>
             æ ¸å¿ƒå­¦ä¹ ï¼ˆ10åˆ†ï¼‰ï¼š
            </strong>
            <ul>
             <li>
              â° éœ€å®Œæˆ40åˆ†é’Ÿé›†ä¸­å­¦ä¹ ï¼Œå®Œæˆå¾—10åˆ†
             </li>
             <li>
              ğŸ‡»ğŸ‡³ è¶Šå—è¯­ / ğŸ‡ºğŸ‡¸ è‹±è¯­
             </li>
             <li>
              ç®€è¿°å­¦ä¹ å†…å®¹ï¼Œè®°å½•å…·ä½“è¿›åº¦
             </li>
            </ul>
           </li>
           <li>
            <strong>
             ç¢ç‰‡ç£¨è€³ï¼ˆæ¯ä¸ª0.5åˆ†ï¼‰ï¼š
            </strong>
            <ul>
             <li>
              åº•çº¿è¦æ±‚ï¼šè‡³å°‘å®Œæˆ 2 ä¸ªæ—¶æ®µçš„ç£¨è€³æœµ
             </li>
             <li>
              æ¯ä¸ªæ—¶æ®µ 0.5-1 åˆ†
             </li>
             <li>
              æ—¶æ®µåˆ’åˆ†ï¼šğŸŒ… æ—©ä¸Š / â˜€ï¸ ä¸­åˆ / ğŸŒ† å‚æ™š / ğŸŒ™ æ™šä¸Š
             </li>
             <li>
              çŠ¶æ€è¯´æ˜ï¼š0.5=ä¸­æ–­/æœªå®Œæˆï¼›1.0=å®Œæ•´å®Œæˆ
             </li>
            </ul>
           </li>
           <li>
            <strong>
             å¯åŠ¨èƒ½é‡ï¼ˆIgnitionï¼‰ï¼š
            </strong>
            <ul>
             <li>
              å®Œæˆåè‡ªåŠ¨è®¡å…¥ FLI æ€»åˆ†
             </li>
             <li>
              ç”¨äºæ¿€åŠ±æ—©æ™¨å¯åŠ¨å­¦ä¹ çš„è¡Œä¸º
             </li>
            </ul>
           </li>
           <li>
            <strong>
             å°é¡¶è§„åˆ™ï¼š
            </strong>
            FLIæ€»åˆ†å‚è€ƒä¸Šé™çº¦12-14åˆ†
           </li>
          </ul>
          <h4 class="mt-4">
           ğŸ’¡ æ¨èåšæ³•
          </h4>
          <ul>
           <li>
            åˆ©ç”¨ç¢ç‰‡æ—¶é—´ï¼ˆé€šå‹¤ã€æ’é˜Ÿã€ä¼‘æ¯é—´éš™ï¼‰å®Œæˆç¢ç‰‡å­¦ä¹ 
           </li>
           <li>
            ç¢ç‰‡å­¦ä¹ å†…å®¹å¯ä»¥æ˜¯ï¼šèƒŒå•è¯ã€çœ‹å¤–è¯­çŸ­æ–‡ã€å¬æ’­å®¢ç­‰
           </li>
           <li>
            æ ¸å¿ƒå­¦ä¹ æ³¨é‡æ·±åº¦ï¼Œç¢ç‰‡å­¦ä¹ ä¿æŒæ¥è§¦
           </li>
          </ul>
         </div>
        </div>
       </div>
       <div class="table-container">
        <table class="mobile-optimized-table">
         <thead>
          <tr>
           <th style="width: 150px;">
            é¡¹ç›®æ¿å—
           </th>
           <th style="width: 350px;">
            ğŸ•’ å†…å®¹
           </th>
           <th class="center" style="width: 150px;">
            âœ… çŠ¶æ€
            <br/>
            (å®Œæˆ/æœªå®Œæˆ/è±å…/å…¶ä»–)
           </th>
           <th class="center" style="width: 100px;">
            ğŸ† å¾—åˆ†
           </th>
           <th style="width: 300px;">
            ğŸ“ å¤‡æ³¨ (è®°å½•å…·ä½“å­¦ä¹ å†…å®¹)
           </th>
          </tr>
         </thead>
         <tbody>
          <!-- æ ¸å¿ƒå­¦ä¹  -->
          <tr>
           <td class="row-header">
            âš¡ æ ¸å¿ƒå­¦ä¹ 
            <br/>
            (10åˆ†)
           </td>
           <td>
            <strong>
             â° 40åˆ†é’Ÿé›†ä¸­å­¦ä¹ 
            </strong>
            ï¼š
            <br/>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); margin-top: var(--spacing-2);">
             <input aria-label="è¶Šå—è¯­å­¦ä¹ " id="fli-vn" onblur="TPI.calculateFLI(); TPI.calculateSystem()" oninput="TPI.calculateFLI(); TPI.calculateSystem()" type="checkbox"/>
             <span>
              ğŸ‡»ğŸ‡³ è¶Šå—è¯­ï¼š
              <input aria-label="è¶Šå—è¯­å†…å®¹" placeholder="å­¦ä¹ å†…å®¹" style="width: 200px; margin-left: var(--spacing-2);" type="text"/>
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); margin-top: var(--spacing-1);">
             <input aria-label="è‹±è¯­å­¦ä¹ " id="fli-en" onblur="TPI.calculateFLI(); TPI.calculateSystem()" oninput="TPI.calculateFLI(); TPI.calculateSystem()" type="checkbox"/>
             <span>
              ğŸ‡ºğŸ‡¸ è‹±è¯­ï¼š
              <input aria-label="è‹±è¯­å†…å®¹" placeholder="å­¦ä¹ å†…å®¹" style="width: 200px; margin-left: var(--spacing-2);" type="text"/>
             </span>
            </label>
            <p class="text-muted" style="margin-top: var(--spacing-1); font-size: var(--font-size-xs);">
             <em>
              (ç®€è¿°å­¦ä¹ å†…å®¹)
             </em>
            </p>
           </td>
           <td class="center">
            <select aria-label="æ ¸å¿ƒå­¦ä¹ çŠ¶æ€" class="status-select" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="æ ¸å¿ƒå­¦ä¹ å¾—åˆ†" id="fli-core-score" onblur="TPI.calculateFLI(); TPI.calculateSystem()" oninput="TPI.calculateFLI(); TPI.calculateSystem()" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="æ ¸å¿ƒå­¦ä¹ å¤‡æ³¨" id="fli-core-notes" placeholder="å­¦ä¹ å†…å®¹ç®€è¿°... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <!-- ç¢ç‰‡ç£¨è€³ -->
          <tr>
           <td class="row-header">
            ğŸ’ ç¢ç‰‡ç£¨è€³
            <br/>
            (åº•çº¿2ä¸ª)
            <br/>
            (æ¯ä¸ª0.5åˆ†)
           </td>
           <td>
            <label style="display: flex; align-items: center; gap: var(--spacing-2);">
             <input aria-label="æ—©ä¸Šç£¨è€³" class="fli-fragment" type="checkbox"/>
             <span>
              ğŸŒ… æ—©ä¸Šï¼š
              <input aria-label="æ—©ä¸Šææ–™" placeholder="ææ–™" style="width: 150px; margin-left: var(--spacing-2);" type="text"/>
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); margin-top: var(--spacing-1);">
             <input aria-label="ä¸­åˆç£¨è€³" class="fli-fragment" type="checkbox"/>
             <span>
              â˜€ï¸ ä¸­åˆï¼š
              <input aria-label="ä¸­åˆææ–™" placeholder="ææ–™" style="width: 150px; margin-left: var(--spacing-2);" type="text"/>
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); margin-top: var(--spacing-1);">
             <input aria-label="å‚æ™šç£¨è€³" class="fli-fragment" type="checkbox"/>
             <span>
              ğŸŒ† å‚æ™šï¼š
              <input aria-label="å‚æ™šææ–™" placeholder="ææ–™" style="width: 150px; margin-left: var(--spacing-2);" type="text"/>
             </span>
            </label>
            <label style="display: flex; align-items: center; gap: var(--spacing-2); margin-top: var(--spacing-1);">
             <input aria-label="æ™šä¸Šç£¨è€³" class="fli-fragment" type="checkbox"/>
             <span>
              ğŸŒ™ æ™šä¸Šï¼š
              <input aria-label="æ™šä¸Šææ–™" placeholder="ææ–™" style="width: 150px; margin-left: var(--spacing-2);" type="text"/>
             </span>
            </label>
            <p class="text-muted" style="margin-top: var(--spacing-1); font-size: var(--font-size-xs);">
             <em>
              (0.5=ä¸­æ–­/æœªå®Œ; 1.0=å®Œæˆ)
             </em>
            </p>
           </td>
           <td class="center">
            <select aria-label="ç¢ç‰‡ç£¨è€³çŠ¶æ€" class="status-select" onchange="TPI.calculateAMI()" style="width: 100px;">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="ç¢ç‰‡ç£¨è€³å¾—åˆ†" id="fli-fragment-score" onblur="TPI.calculateFLI(); TPI.calculateSystem()" oninput="TPI.calculateFLI(); TPI.calculateSystem()" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="ç¢ç‰‡ç£¨è€³å¤‡æ³¨" placeholder="ææ–™åç§°... (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)" rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <!-- æ€»è®¡ -->
          <tr class="summary-row">
           <td class="text-right" colspan="3">
            <strong>
             æ€»è®¡ (åœ¨æ­¤å¤„å¡«å…¥æ¿å—æ€»åˆ†)
            </strong>
           </td>
           <td class="center">
            <strong>
             <span id="fli-total-score">
              0
             </span>
            </strong>
           </td>
           <td>
           </td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section>
     <!-- ==================== 10. Logistics åå‹¤ä¸ç»´æŠ¤ ==================== -->
     <section class="card fade-in stagger-4" id="logistics">
      <div class="card-header" onclick="window.TPI.toggleCard('logistics')">
       <div class="card-title">
        <span class="icon">
         ğŸ§¹
        </span>
        <span>
         ç¬¬äº”éƒ¨åˆ†ï¼šåå‹¤ä¸ç»´æŠ¤ (Logistics &amp; Maintenance)
        </span>
       </div>
      </div>
      <div class="card-content">
       <div class="alert alert-info mb-6">
        <h4>
         ğŸ“˜ Logistics ä½¿ç”¨è¯´æ˜ä¸è¯„åˆ†è§„åˆ™
        </h4>
        <h5 class="mt-3">
         ğŸ¯ æ ¸å¿ƒç†å¿µ
        </h5>
        <p>
         Logistics (åå‹¤ä¸ç»´æŠ¤) æ˜¯æ—¥å¸¸æ‚äº‹å’Œåå‹¤ä»»åŠ¡çš„ç®¡ç†ç³»ç»Ÿã€‚æœ‰æ•ˆç®¡ç†æ‚äº‹æ˜¯ä¿è¯æ ¸å¿ƒå·¥ä½œæ—¶é—´çš„åŸºç¡€ã€‚
        </p>
        <h5 class="mt-3">
         ğŸ“Š è¯„åˆ†è§„åˆ™
        </h5>
        <ul>
         <li>
          <strong>
           çŠ¶æ€åˆ†å®šä¹‰
          </strong>
          ï¼šå®Œæˆ=1åˆ†ï¼Œæœªå®Œæˆ=0åˆ†
         </li>
         <li>
          <strong>
           åŸºç¡€åˆ† = çŠ¶æ€åˆ† Ã— 2
          </strong>
         </li>
         <li>
          <strong>
           æ—¶é—´æ‰£å‡ = (çœŸå®è€—æ—¶ Ã· 10) Ã— ç­‰çº§ç³»æ•°
          </strong>
         </li>
         <li>
          <strong>
           å®å¾—åˆ† = åŸºç¡€åˆ† - æ—¶é—´æ‰£å‡
          </strong>
          ï¼ˆå‡åˆ†åˆ¶ï¼šé¼“åŠ±é«˜æ•ˆå®Œæˆä»»åŠ¡ï¼‰
         </li>
        </ul>
        <h5 class="mt-3">
         ğŸ“¦ ç­‰çº§ä½“ç³»ä¸ç³»æ•°
        </h5>
        <ul>
         <li>
          <strong>
           0 - çäº‹
          </strong>
          ï¼šæ—¥å¸¸åŸºç¡€æ€§äº‹åŠ¡ï¼Œè€—æ—¶çŸ­ï¼Œé‡è¦æ€§ä½ï¼ˆç³»æ•° 0.1ï¼‰
         </li>
         <li>
          <strong>
           1 - å¸¸è§„
          </strong>
          ï¼šæ—¥å¸¸å¿…é¡»å¤„ç†çš„äº‹åŠ¡ï¼Œå…·æœ‰ä¸€å®šé‡è¦æ€§ï¼ˆç³»æ•° 0.15ï¼‰
         </li>
         <li>
          <strong>
           2 - é‡è¦
          </strong>
          ï¼šéœ€è¦è¾ƒå¤šæ—¶é—´å’Œç²¾åŠ›ï¼Œå¯¹æ•´ä½“è¿›å±•æœ‰æ˜æ˜¾å½±å“ï¼ˆç³»æ•° 0.2ï¼‰
         </li>
         <li>
          <strong>
           3 - ç´§æ€¥
          </strong>
          ï¼šæœ‰æ˜ç¡®æ—¶é™è¦æ±‚ï¼Œéœ€è¦ä¼˜å…ˆå¤„ç†ï¼ˆç³»æ•° 0.25ï¼‰
         </li>
         <li>
          <strong>
           5 - å…³é”®
          </strong>
          ï¼šç›´æ¥å½±å“æ ¸å¿ƒå­¦æœ¯è¿›å±•æˆ–é‡å¤§äº‹é¡¹çš„å†³ç­–æ€§ä»»åŠ¡ï¼ˆç³»æ•° 0.3ï¼‰
         </li>
        </ul>
        <h5 class="mt-3">
         âœ… çŠ¶æ€æ ‡è®°
        </h5>
        <ul>
         <li>
          âœ… å®Œæˆ (1)ï¼šä»»åŠ¡å·²å®Œæˆ
         </li>
         <li>
          â­• æœªå®Œæˆ (0)ï¼šä»»åŠ¡æœªå®Œæˆ
         </li>
         <li>
          ğŸ›¡ï¸ è±å…ï¼šå› å®¢è§‚åŸå› è±å…
         </li>
         <li>
          ğŸ” å…¶ä»–ï¼šå…¶ä»–ç‰¹æ®Šæƒ…å†µï¼Œéœ€åœ¨å¤‡æ³¨ä¸­è¯´æ˜
         </li>
        </ul>
        <h5 class="mt-3">
         ğŸ“ å¡«å†™è¦æ±‚
        </h5>
        <ul>
         <li>
          çœŸå®è®°å½•è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰
         </li>
         <li>
          åˆç†è¯„ä¼°äº‹åŠ¡ç­‰çº§
         </li>
         <li>
          å¯åœ¨å¤‡æ³¨ä¸­è¯´æ˜å…·ä½“æƒ…å†µ
         </li>
        </ul>
       </div>
       <div class="table-container">
        <table class="mobile-optimized-table" id="logistics-table">
         <thead>
          <tr>
           <th style="width: 60px;">
            ç¼–å·
           </th>
           <th style="width: 1050px;">
            ğŸ“¦ å¾…åŠæ‚äº‹ (Todo)
           </th>
           <th class="center" style="width: 120px;">
            âœ… çŠ¶æ€
            <br/>
            (å®Œæˆ/æœªå®Œæˆ/è±å…/å…¶ä»–)
           </th>
           <th class="center" style="width: 100px;">
            â³ çœŸå®è€—æ—¶
            <br/>
            (åˆ†é’Ÿ)
           </th>
           <th class="center level-column" style="width: 120px;">
            ğŸ”¥ ç­‰çº§
            <br/>
            (0/1/2/3/5)
           </th>
           <th class="center" style="width: 100px;">
            ğŸ§® å®å¾—åˆ†
           </th>
           <th style="width: 750px;">
            ğŸ“ å¤‡æ³¨ (å¦‚é€‰æ‹©'å…¶ä»–'çŠ¶æ€éœ€åœ¨æ­¤è¯´æ˜)
           </th>
          </tr>
         </thead>
         <tbody>
          <tr>
           <td class="center">
            1
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹1" placeholder="å¾…åŠäº‹é¡¹ï¼ˆçºµå‘å±•å¼€ï¼‰..." rows="2" style="width: 100%; resize: vertical; min-height: 120px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹1çŠ¶æ€" class="status-select logistics-status">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹1è€—æ—¶" class="logistics-time" min="0" placeholder="0" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹ç­‰çº§" class="logistics-level" style="width: 100px;">
             <option value="0.1">
              0-çäº‹ (0.1)
             </option>
             <option value="0.15">
              1-å¸¸è§„ (0.15)
             </option>
             <option value="0.2">
              2-é‡è¦ (0.2)
             </option>
             <option value="0.25">
              3-ç´§æ€¥ (0.25)
             </option>
             <option value="0.3">
              5-å…³é”® (0.3)
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹1å¾—åˆ†" class="logistics-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹1å¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center">
            2
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹2" placeholder="å¾…åŠäº‹é¡¹ï¼ˆçºµå‘å±•å¼€ï¼‰..." rows="2" style="width: 100%; resize: vertical; min-height: 120px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹2çŠ¶æ€" class="status-select logistics-status">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹2è€—æ—¶" class="logistics-time" min="0" placeholder="0" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹2ç­‰çº§" class="logistics-level" style="width: 100px;">
             <option value="0.1">
              0-çäº‹ (0.1)
             </option>
             <option value="0.15">
              1-å¸¸è§„ (0.15)
             </option>
             <option value="0.2">
              2-é‡è¦ (0.2)
             </option>
             <option value="0.25">
              3-ç´§æ€¥ (0.25)
             </option>
             <option value="0.3">
              5-å…³é”® (0.3)
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹2å¾—åˆ†" class="logistics-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹2å¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center">
            3
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹3" placeholder="å¾…åŠäº‹é¡¹ï¼ˆçºµå‘å±•å¼€ï¼‰..." rows="2" style="width: 100%; resize: vertical; min-height: 120px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹3çŠ¶æ€" class="status-select logistics-status">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹3è€—æ—¶" class="logistics-time" min="0" placeholder="0" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹3ç­‰çº§" class="logistics-level" style="width: 100px;">
             <option value="0.1">
              0-çäº‹ (0.1)
             </option>
             <option value="0.15">
              1-å¸¸è§„ (0.15)
             </option>
             <option value="0.2">
              2-é‡è¦ (0.2)
             </option>
             <option value="0.25">
              3-ç´§æ€¥ (0.25)
             </option>
             <option value="0.3">
              5-å…³é”® (0.3)
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹3å¾—åˆ†" class="logistics-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹3å¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center">
            4
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹4" placeholder="å¾…åŠäº‹é¡¹ï¼ˆçºµå‘å±•å¼€ï¼‰..." rows="2" style="width: 100%; resize: vertical; min-height: 120px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹4çŠ¶æ€" class="status-select logistics-status">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹4è€—æ—¶" class="logistics-time" min="0" placeholder="0" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹4ç­‰çº§" class="logistics-level" style="width: 100px;">
             <option value="0.1">
              0-çäº‹ (0.1)
             </option>
             <option value="0.15">
              1-å¸¸è§„ (0.15)
             </option>
             <option value="0.2">
              2-é‡è¦ (0.2)
             </option>
             <option value="0.25">
              3-ç´§æ€¥ (0.25)
             </option>
             <option value="0.3">
              5-å…³é”® (0.3)
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹4å¾—åˆ†" class="logistics-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹4å¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center">
            5
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹5" placeholder="å¾…åŠäº‹é¡¹ï¼ˆçºµå‘å±•å¼€ï¼‰..." rows="2" style="width: 100%; resize: vertical; min-height: 120px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹5çŠ¶æ€" class="status-select logistics-status">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹5è€—æ—¶" class="logistics-time" min="0" placeholder="0" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹5ç­‰çº§" class="logistics-level" style="width: 100px;">
             <option value="0.1">
              0-çäº‹ (0.1)
             </option>
             <option value="0.15">
              1-å¸¸è§„ (0.15)
             </option>
             <option value="0.2">
              2-é‡è¦ (0.2)
             </option>
             <option value="0.25">
              3-ç´§æ€¥ (0.25)
             </option>
             <option value="0.3">
              5-å…³é”® (0.3)
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹5å¾—åˆ†" class="logistics-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹5å¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center">
            6
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹6" placeholder="å¾…åŠäº‹é¡¹ï¼ˆçºµå‘å±•å¼€ï¼‰..." rows="2" style="width: 100%; resize: vertical; min-height: 120px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹6çŠ¶æ€" class="status-select logistics-status">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹6è€—æ—¶" class="logistics-time" min="0" placeholder="0" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹6ç­‰çº§" class="logistics-level" style="width: 100px;">
             <option value="0.1">
              0-çäº‹ (0.1)
             </option>
             <option value="0.15">
              1-å¸¸è§„ (0.15)
             </option>
             <option value="0.2">
              2-é‡è¦ (0.2)
             </option>
             <option value="0.25">
              3-ç´§æ€¥ (0.25)
             </option>
             <option value="0.3">
              5-å…³é”® (0.3)
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹6å¾—åˆ†" class="logistics-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹6å¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center">
            7
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹7" placeholder="å¾…åŠäº‹é¡¹ï¼ˆçºµå‘å±•å¼€ï¼‰..." rows="2" style="width: 100%; resize: vertical; min-height: 120px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹7çŠ¶æ€" class="status-select logistics-status">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹7è€—æ—¶" class="logistics-time" min="0" placeholder="0" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹7ç­‰çº§" class="logistics-level" style="width: 100px;">
             <option value="0.1">
              0-çäº‹ (0.1)
             </option>
             <option value="0.15">
              1-å¸¸è§„ (0.15)
             </option>
             <option value="0.2">
              2-é‡è¦ (0.2)
             </option>
             <option value="0.25">
              3-ç´§æ€¥ (0.25)
             </option>
             <option value="0.3">
              5-å…³é”® (0.3)
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹7å¾—åˆ†" class="logistics-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹7å¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center">
            8
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹8" placeholder="å¾…åŠäº‹é¡¹ï¼ˆçºµå‘å±•å¼€ï¼‰..." rows="2" style="width: 100%; resize: vertical; min-height: 120px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹8çŠ¶æ€" class="status-select logistics-status">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹8è€—æ—¶" class="logistics-time" min="0" placeholder="0" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹8ç­‰çº§" class="logistics-level" style="width: 100px;">
             <option value="0.1">
              0-çäº‹ (0.1)
             </option>
             <option value="0.15">
              1-å¸¸è§„ (0.15)
             </option>
             <option value="0.2">
              2-é‡è¦ (0.2)
             </option>
             <option value="0.25">
              3-ç´§æ€¥ (0.25)
             </option>
             <option value="0.3">
              5-å…³é”® (0.3)
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹8å¾—åˆ†" class="logistics-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹8å¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center">
            9
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹9" placeholder="å¾…åŠäº‹é¡¹ï¼ˆçºµå‘å±•å¼€ï¼‰..." rows="2" style="width: 100%; resize: vertical; min-height: 120px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹9çŠ¶æ€" class="status-select logistics-status">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹9è€—æ—¶" class="logistics-time" min="0" placeholder="0" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹9ç­‰çº§" class="logistics-level" style="width: 100px;">
             <option value="0.1">
              0-çäº‹ (0.1)
             </option>
             <option value="0.15">
              1-å¸¸è§„ (0.15)
             </option>
             <option value="0.2">
              2-é‡è¦ (0.2)
             </option>
             <option value="0.25">
              3-ç´§æ€¥ (0.25)
             </option>
             <option value="0.3">
              5-å…³é”® (0.3)
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹9å¾—åˆ†" class="logistics-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹9å¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr>
           <td class="center">
            10
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹10" placeholder="å¾…åŠäº‹é¡¹ï¼ˆçºµå‘å±•å¼€ï¼‰..." rows="2" style="width: 100%; resize: vertical; min-height: 120px; padding: 8px; font-family: inherit; font-size: inherit;"></textarea>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹10çŠ¶æ€" class="status-select logistics-status">
             <option value="1">
              âœ… å®Œæˆ
             </option>
             <option value="0">
              â­• æœªå®Œæˆ
             </option>
             <option value="exempt">
              ğŸ›¡ï¸ è±å…
             </option>
             <option value="other">
              ğŸ” å…¶ä»–
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹10è€—æ—¶" class="logistics-time" min="0" placeholder="0" style="width: 70px;" type="number"/>
           </td>
           <td class="center">
            <select aria-label="å¾…åŠäº‹é¡¹10ç­‰çº§" class="logistics-level" style="width: 100px;">
             <option value="0.1">
              0-çäº‹ (0.1)
             </option>
             <option value="0.15">
              1-å¸¸è§„ (0.15)
             </option>
             <option value="0.2">
              2-é‡è¦ (0.2)
             </option>
             <option value="0.25">
              3-ç´§æ€¥ (0.25)
             </option>
             <option value="0.3">
              5-å…³é”® (0.3)
             </option>
            </select>
           </td>
           <td class="center">
            <input aria-label="å¾…åŠäº‹é¡¹10å¾—åˆ†" class="logistics-score" readonly="" style="width: 70px; background: var(--color-bg-tertiary);" type="number"/>
           </td>
           <td>
            <textarea aria-label="å¾…åŠäº‹é¡¹10å¤‡æ³¨" placeholder="å¤‡æ³¨..." rows="3" style="width: 100%;"></textarea>
           </td>
          </tr>
          <tr class="summary-row">
           <td class="text-right" colspan="5">
            <strong>
             ç»Ÿè®¡ç»“æœï¼š
            </strong>
           </td>
           <td class="center">
            <strong>
             <span id="logistics-total-score">
              0
             </span>
            </strong>
           </td>
           <td class="text-center">
            <strong>
             (å¡«å…¥ä¸Šæ–¹ Sys)
            </strong>
           </td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </section>
     <section class="card fade-in collapsed" id="daily-review">
      <div class="card-header" onclick="window.TPI.toggleCard('daily-review')">
       <div class="card-title">
        <span class="icon">
         ğŸ“
        </span>
        <span>
         æ¯æ—¥å¤ç›˜ä¸äº¤æ¥
        </span>
       </div>
      </div>
      <div class="card-content">
       <div class="mb-6">
        <div class="alert alert-info mb-4">
         <h4>
          ğŸ” æ€»ç»“ (Summary)
         </h4>
         <p>
          è®°å½•ä»Šæ—¥æ ¸å¿ƒäº‹å®ä¸å…³é”®äº§å‡ºã€‚
         </p>
         <textarea aria-label="æ¯æ—¥æ€»ç»“" id="daily-summary" placeholder="åœ¨æ­¤å¤„è®°å½•ï¼šé˜…è¯»äº†ä»€ä¹ˆï¼ˆä¹¦å/é¡µç ï¼‰ï¼Œå†™äº†ä»€ä¹ˆï¼ˆç« èŠ‚/è®ºç‚¹ï¼‰ï¼Œæ•´ç†äº†ä»€ä¹ˆï¼ˆæ¡£æ¡ˆ/æ•°æ®ï¼‰..." rows="3"></textarea>
        </div>
        <div class="alert alert-success mb-4">
         <h4>
          âœ¨ å¾®å°èƒœåˆ© (Micro-Victories)
         </h4>
         <p>
          è¯·è®°å½• 1-3 ä»¶ä»Šæ—¥å€¼å¾—è‚¯å®šçš„å°äº‹ï¼ˆæ— è®ºå¤šå°ï¼Œå¦‚ï¼šå–å¤Ÿäº†æ°´ / æ‰“å¼€äº†æ–‡æ¡£ / å¿ä½äº†çœ‹æ‰‹æœºï¼‰ã€‚
         </p>
         <div style="display: flex; flex-direction: column; gap: var(--spacing-2);">
          <input aria-label="å¾®å°èƒœåˆ©1" id="victory-1" placeholder="1. __________________ ğŸ’¡ é¼“åŠ±è¯­ï¼šæ¯ä»¶å°äº‹éƒ½æ˜¯é€šå¾€å¤§ç›®æ ‡çš„ç –çŸ³ï¼" type="text"/>
          <input aria-label="å¾®å°èƒœåˆ©2" id="victory-2" placeholder="2. __________________ ğŸ’¡ é¼“åŠ±è¯­ï¼šèƒ½å¼€å§‹å°±æ˜¯æœ€æ£’çš„ï¼" type="text"/>
          <input aria-label="å¾®å°èƒœåˆ©3" id="victory-3" placeholder="3. __________________" type="text"/>
         </div>
        </div>
        <div class="alert alert-warning">
         <h4>
          â¡ï¸ ä¼ é€’ç»™æ˜æ—¥ (Handover Protocol: Hemingway Bridge)
         </h4>
         <div class="mb-3">
          <label>
           <strong>
            ğŸ§— å¾…è§£æ‚¬å¿µ (Cliffhanger)
           </strong>
           ï¼šä»Šæ—¥å¡åœ¨å“ªå„¿äº†ï¼Ÿ
          </label>
          <textarea aria-label="å¾…è§£æ‚¬å¿µ" id="cliffhanger" placeholder="ä¾‹å¦‚ï¼š#å…­ã€å†…åœ¨æ‰¹è¯„ å‘ç°é€»è¾‘æ¼æ´ï¼›#å››ã€ç›¸å…³è®ºè‘— éœ€è¦è¿½è¸ªæŸä»½æ¡£æ¡ˆ..." rows="2"></textarea>
         </div>
         <div>
          <label>
           <strong>
            ğŸ æ˜æ—¥ç¬¬ä¸€åŠ¨ä½œ (First Action)
           </strong>
           ï¼š
           <strong>
            æµ·æ˜å¨æ¡¥ç­–ç•¥
           </strong>
           â€”â€” è¯·åœ¨æ­¤å¤„å†™ä¸‹ä»Šæ—¥æœªå®Œæˆçš„åŠå¥è¯æˆ–æ˜ç¡®æŒ‡ä»¤ã€‚
          </label>
          <textarea aria-label="æ˜æ—¥ç¬¬ä¸€åŠ¨ä½œ" id="first-action" placeholder='ä¾‹å¦‚ï¼š"...å…³äºè¿™ä¸€ç‚¹çš„è®ºè¯ï¼Œè¿˜éœ€è¦å¼•ç”¨ç¦æŸ¯..."ï¼ˆåœåœ¨è¿™é‡Œï¼Œæ˜æ—©ç›´æ¥ç»­å†™ï¼‰' rows="2"></textarea>
         </div>
         <div style="margin-top: 12px;">
          <label>
           <strong>
            ğŸ’­ ä»Šæ—¥åæ€ (Daily Reflection)
           </strong>
           ï¼šå¯¹ä»Šæ—¥æ•´ä½“è¡¨ç°ã€å¿ƒæ€ã€ç­–ç•¥çš„åæ€ã€‚
          </label>
          <textarea aria-label="ä»Šæ—¥åæ€" id="daily-reflection" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©æ•ˆç‡ä¸é«˜ï¼Œå¯èƒ½æ˜¯å› ä¸ºç¡çœ ä¸è¶³ã€‚æ˜å¤©è¦æ³¨æ„æ—©ç¡ã€‚/ ä¸Šåˆå¿ƒæµçŠ¶æ€å¾ˆå¥½ï¼Œä¸‹åˆè¢«æ‰“æ–­å¤ªå¤šæ¬¡..." rows="3"></textarea>
         </div>
        </div>
       </div>
      </div>
     </section>
     <!-- ==================== 14. æ•°æ®åˆ†æä¸å¯è§†åŒ– ==================== -->
     <section class="card fade-in collapsed" id="data-analytics">
      <div class="card-header" onclick="window.TPI.toggleCard('data-analytics')">
       <div class="card-title">
        <span class="icon">
         ğŸ“ˆ
        </span>
        <span>
         æ•°æ®åˆ†æä¸å¯è§†åŒ–
        </span>
       </div>
      </div>
      <div class="card-content">
       <!-- è¶‹åŠ¿åˆ†æ -->
       <div class="mb-6">
        <h3>
         ğŸ“ˆ è¶‹åŠ¿åˆ†æ
        </h3>
        <p class="text-muted mb-3">
         æŸ¥çœ‹æ•ˆèƒ½æŒ‡æ ‡çš„é•¿æœŸè¶‹åŠ¿å˜åŒ–å’Œåˆ†ææŠ¥å‘Šã€‚
        </p>
        <button class="btn btn-primary" onclick="if(window.trendChartEnhancer &amp;&amp; window.trendChartEnhancer.showChartUI){window.trendChartEnhancer.showChartUI()}else{alert('è¶‹åŠ¿åˆ†æåŠŸèƒ½æ­£åœ¨åˆå§‹åŒ–,è¯·ç¨åé‡è¯•')}">
         ğŸ“ˆ æ‰“å¼€è¶‹åŠ¿åˆ†æ
        </button>
       </div>
       <!-- æ—¶é—´åºåˆ—è¶‹åŠ¿å›¾ -->
       <div class="mb-6">
        <h3>
         ğŸ“Š æ—¶é—´åºåˆ—è¶‹åŠ¿å›¾
        </h3>
        <div class="chart-container">
         <canvas id="trendChart">
         </canvas>
        </div>
        <div class="text-center mt-4">
         <div class="btn-group-mobile" style="display: flex; gap: var(--spacing-2); justify-content: center;">
          <button class="btn btn-secondary" onclick="window.TPI.updateTrendChart(7)">
           7å¤©
          </button>
          <button class="btn btn-secondary" onclick="window.TPI.updateTrendChart(30)">
           30å¤©
          </button>
          <button class="btn btn-secondary" onclick="window.TPI.updateTrendChart(90)">
           90å¤©
          </button>
          <button class="btn btn-primary" onclick="window.TPI.exportChart('trendChart', 'è¶‹åŠ¿å›¾')">
           ğŸ“¥ å¯¼å‡ºå›¾è¡¨
          </button>
         </div>
        </div>
       </div>
       <!-- é‡Œç¨‹ç¢‘å¾½ç«  -->
       <div class="mb-6">
        <h3>
         ğŸ† é‡Œç¨‹ç¢‘å¾½ç« 
        </h3>
        <div class="badges-container" id="badgesContainer">
         <!-- å¾½ç« å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
       </div>
       <!-- é«˜çº§åˆ†æå·¥å…· -->
       <div class="mt-6">
        <h3>
         ğŸ”¬ é«˜çº§åˆ†æå·¥å…·
        </h3>
        <div class="export-buttons" style="margin-top: var(--spacing-4);">
         <button class="btn btn-secondary" onclick="if(window.TPIAdvanced &amp;&amp; window.TPIAdvanced.openComparison){window.TPIAdvanced.openComparison()}else{alert('æ•°æ®å¯¹æ¯”åŠŸèƒ½æ­£åœ¨åˆå§‹åŒ–,è¯·ç¨åé‡è¯•')}">
          ğŸ“Š æ•°æ®å¯¹æ¯”åˆ†æ
         </button>
         <button class="btn btn-secondary" onclick="if(window.TPIAdvanced &amp;&amp; window.TPIAdvanced.generateReport){window.TPIAdvanced.generateReport()}else{alert('æŠ¥å‘Šç”ŸæˆåŠŸèƒ½æ­£åœ¨åˆå§‹åŒ–,è¯·ç¨åé‡è¯•')}">
          ğŸ“ ç”ŸæˆæŠ¥å‘Š
         </button>
        </div>
       </div>
      </div>
     </section>
          <!-- ==================== 15. æ•°æ®å·¥åŠ ==================== -->
     <section class="card fade-in collapsed" id="data-processing">
<div class="card-header" onclick="window.TPI.toggleCard('data-processing')">
<div class="card-title">
<span class="icon">
         ğŸ› ï¸
        </span>
<span>
         æ•°æ®å·¥åŠ
        </span>
</div>
</div>
<div class="card-content">
<div class="data-workshop-layout"><div class="data-workshop-top"><div class="data-workshop-top-left"><div class="data-processing-card" style="border: 2px solid #10b981; background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);">
<h4 style="color: #065f46; display: flex; align-items: center; gap: 8px;">
<span>ğŸ“¥</span> æ•°æ®å¯¼å…¥ä¸æ¢å¤
         </h4>
<p class="text-muted mb-3">
          å¯¼å…¥å¤–éƒ¨JSONæ•°æ®æ–‡ä»¶ï¼Œæˆ–é‡ç½®å½“å‰è¡¨å•ã€‚
         </p>
<div class="import-section">
<h5>æ•°æ®å¯¼å…¥</h5>
<div style="margin-bottom: var(--spacing-3);">
<input accept=".json" id="import-file" style="width: 100%; padding: var(--spacing-2);" type="file"/>
</div>
<div class="export-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
<button class="btn btn-primary" onclick="window.importDataComplete()" style="flex: 1; min-width: 120px;">
            ğŸ“¥ å¯¼å…¥JSONæ•°æ®
           </button>
<button class="btn btn-warning" onclick="window.TPI.resetForm()" style="flex: 1; min-width: 120px;">
            ğŸ”„ é‡ç½®å½“å‰è¡¨å•
           </button>
</div>
</div>
<div class="mt-4">
<h5>æ‰¹é‡æ“ä½œ</h5>
<div class="export-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
<button class="btn btn-secondary" onclick="window.TPI.backupAllData()" style="flex: 1; min-width: 120px;">
            ğŸ’½ å¤‡ä»½æ‰€æœ‰æ•°æ®
           </button>
<button class="btn btn-secondary" onclick="window.TPI.restoreBackup()" style="flex: 1; min-width: 120px;">
            ğŸ”„ æ¢å¤å¤‡ä»½
           </button>
</div>
</div>
</div><div class="data-processing-card">
<h4>
          ğŸ“‹ å¤åˆ¶å‰ä¸€å¤©
         </h4>
<p class="text-muted mb-3">
          å¿«é€Ÿå¤åˆ¶å‰ä¸€å¤©çš„æ•°æ®åˆ°å½“å‰æ—¥æœŸï¼Œé€‚åˆæ—¥ç¨‹ç›¸ä¼¼çš„æƒ…å†µã€‚
         </p>
<button class="btn btn-primary" onclick="window.copyPreviousDayDataComplete()">
          ğŸ“‹ å¤åˆ¶å‰ä¸€å¤©æ•°æ®
         </button>
</div></div><div class="data-workshop-top-right"><div class="data-processing-card" style="border: 2px solid #3b82f6; background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);">
<h4 style="color: #1e40af; display: flex; align-items: center; gap: 8px;">
<span>ğŸ“¤</span> æ•°æ®å¯¼å‡ºä¸å¤‡ä»½
         </h4>
<p class="text-muted mb-3">
          ç»Ÿä¸€çš„æ•°æ®ç®¡ç†ä¸­å¿ƒï¼Œæ”¯æŒJSONå’ŒMarkdownä¸¤ç§æ ¼å¼å¯¼å‡ºï¼Œç¡®ä¿æ‰€æœ‰è¾“å…¥ã€å‹¾é€‰å’Œè®¡ç®—æ•°æ®éƒ½èƒ½è¢«å®Œæ•´ä¿å­˜ã€‚
         </p>
<!-- å¿«é€Ÿå¯¼å‡ºå½“å‰æ•°æ® -->
<div style="margin-bottom: 20px; padding: 12px; background: #dbeafe; border-radius: 8px; border-left: 3px solid #2563eb;">
<h5 style="margin-bottom: 10px; font-size: 14px; color: #1e40af;">âš¡ å¿«é€Ÿå¯¼å‡ºå½“å‰æ•°æ®</h5>
<div style="display: flex; gap: 10px; flex-wrap: wrap;">
<button class="btn btn-primary" onclick="exportAsJSON()" style="flex: 1; min-width: 140px;">
            ğŸ“„ JSONæ ¼å¼
           </button>
<button class="btn btn-primary" onclick="window.exportDataComplete('markdown')" style="flex: 1; min-width: 140px;">
            ğŸ“ Markdownæ ¼å¼
           </button>
</div>
<p style="font-size: 12px; color: #64748b; margin-top: 8px; margin-bottom: 0;">
           JSONæ ¼å¼ï¼šåŒ…å«æ‰€æœ‰è¾“å…¥ã€å‹¾é€‰å’Œç³»ç»Ÿè®¡ç®—æ•°æ®ï¼Œå¯ç”¨äºæ•°æ®æ¢å¤<br/>
           Markdownæ ¼å¼ï¼šäººç±»å¯è¯»çš„æ ¼å¼ï¼ŒåŒ…å«æ‰€æœ‰è¾“å…¥å’Œå‹¾é€‰å†…å®¹
          </p>
</div>
<!-- æ—¶é—´èŒƒå›´å¯¼å‡º -->
<div style="margin-bottom: 20px; padding: 12px; background: #f0fdf4; border-radius: 8px; border-left: 3px solid #10b981;">
<h5 style="margin-bottom: 10px; font-size: 14px; color: #065f46;">ğŸ“… æŒ‰æ—¶é—´èŒƒå›´å¯¼å‡º</h5>
<div class="export-period-buttons">
<button class="btn btn-outline-primary" onclick="window.TPI.exportByPeriod('week')">
            æœ¬å‘¨
           </button>
<button class="btn btn-outline-primary" onclick="window.TPI.exportByPeriod('month')">
            æœ¬æœˆ
           </button>
<button class="btn btn-outline-primary" onclick="window.TPI.exportByPeriod('year')">
            æœ¬å¹´
           </button>
</div>
<div class="mt-3">
<label style="font-size: 13px; font-weight: 600; margin-bottom: 8px; display: block;">è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´ï¼š</label>
<div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
<input id="export-start-date" style="flex: 1; min-width: 130px;" type="date"/>
<span>è‡³</span>
<input id="export-end-date" style="flex: 1; min-width: 130px;" type="date"/>
<button class="btn btn-secondary" onclick="window.TPI.exportCustomRange()">
             å¯¼å‡º
            </button>
</div>
</div>
</div>
<!-- æ•°æ®ä¿å­˜ä¸æ¢å¤ -->
<div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px;">
<button class="btn btn-success" onclick="exportAsMarkdown()" style="flex: 1; min-width: 140px;">
           ğŸ’¾ ä¿å­˜å½“å‰æ•°æ®
          </button>
<button class="btn btn-info" onclick="loadTpiData()" style="flex: 1; min-width: 140px;">
           ğŸ“¥ æ¢å¤ä¿å­˜çš„æ•°æ®
          </button>
</div>
<div style="padding: 10px; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 6px; font-size: 13px; margin-top: 15px;">
<strong>âœ… å¯¼å‡ºè¯´æ˜:</strong>
<ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 12px;">
<li>æ‰€æœ‰è¾“å…¥æ¡†ã€å‹¾é€‰æ¡†ã€ä¸‹æ‹‰èœå•çš„å†…å®¹éƒ½ä¼šè¢«å®Œæ•´å¯¼å‡º</li>
<li>JSONæ ¼å¼è¿˜åŒ…å«æ‰€æœ‰è®¡ç®—ç»“æœå’Œç³»ç»Ÿç”Ÿæˆçš„æ•°æ®</li>
<li>æ—¶é—´èŒƒå›´å¯¼å‡ºå¯é€‰æ‹©ç‰¹å®šå‘¨æœŸçš„å†å²æ•°æ®</li>
<li>å»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±</li>
</ul>
</div>
</div></div></div><div class="data-workshop-bottom"><div class="data-processing-card" style="border: 2px solid #8b5cf6; background: linear-gradient(135deg, #f5f3ff 0%, #ffffff 100%);">
<h4>
         ğŸ“ˆ æ•°æ®ç»Ÿè®¡
        </h4>
<div class="grid-3 mt-3">
<div class="alert alert-info">
<h5>
           ğŸ“… è®°å½•å¤©æ•°
          </h5>
<p id="stats-days-count">
           0 å¤©
          </p>
</div>
<div class="alert alert-success">
<h5>
           ğŸ† æœ€é«˜TPI
          </h5>
<p id="stats-max-tpi">
           0 åˆ†
          </p>
</div>
<div class="alert alert-warning">
<h5>
           ğŸ“Š å¹³å‡TPI
          </h5>
<p id="stats-avg-tpi">
           0 åˆ†
          </p>
</div>
</div>
<div class="text-center mt-3">
<button class="btn btn-secondary" onclick="window.TPI.updateStatistics()">
          ğŸ”„ æ›´æ–°ç»Ÿè®¡
         </button>
</div>
</div><div class="data-processing-card">
<h4>
          ğŸ—ƒï¸ å½’æ¡£æ—§æ•°æ®
         </h4>
<p class="text-muted mb-3">
          å°†è¶…è¿‡æŒ‡å®šå¤©æ•°çš„æ—§æ•°æ®å½’æ¡£åˆ°å•ç‹¬æ–‡ä»¶ï¼Œé‡Šæ”¾å­˜å‚¨ç©ºé—´ã€‚
         </p>
<button class="btn btn-secondary" onclick="window.archiveOldDataComplete()">
          ğŸ—ƒï¸ å½’æ¡£æ—§æ•°æ®
         </button>
</div><div class="data-processing-card">
<h4>
          ğŸ”§ æ•°æ®ç»´æŠ¤
         </h4>
<p class="text-muted mb-3">
          ä¸“ä¸šçš„æ•°æ®ç»´æŠ¤å’Œå¥åº·æ£€æŸ¥å·¥å…·ã€‚
         </p>
<div style="display: flex; flex-direction: column; gap: 10px;">
<button class="btn btn-secondary" onclick="window.checkDataHealthComplete()">
           ğŸ’Š æ•°æ®å¥åº·æ£€æŸ¥
          </button>
</div>
</div></div></div>
<!-- æ•°æ®ç»Ÿè®¡ -->

</div>
</section>
    </div>
   <!-- End container -->
  </div>
  <!-- End page-wrapper -->
  <!-- ==================== JavaScript åŠŸèƒ½ ==================== -->
  <script>
   /**
         * ========================================================================
         * TPI System v14 - JavaScript Architecture
         * ========================================================================
         *
         * è®¾è®¡æ¨¡å¼ (Design Pattern):
         * - IIFEæ¨¡å—åŒ–å°è£… (Immediately Invoked Function Expression)
         * - çŠ¶æ€ç®¡ç†é›†ä¸­åŒ– (Centralized State Management)
         * - äº‹ä»¶é©±åŠ¨æ¶æ„ (Event-Driven Architecture)
         *
         * ä»£ç ç»„ç»‡ (Code Organization):
         * 1. å¸¸é‡é…ç½® (Constants Configuration)
         * 2. çŠ¶æ€ç®¡ç† (State Management)
         * 3. å·¥å…·å‡½æ•° (Utility Functions)
         * 4. UIé€šçŸ¥ç³»ç»Ÿ (UI Notification System)
         * 5. æ ¸å¿ƒè®¡ç®—æ¨¡å— (Core Calculation Modules)
         *    - AMIè®¡ç®— (Attention Management Index)
         *    - FLIè®¡ç®— (Flow Experience Index)
         *    - BCMè®¡ç®— (Body Condition Management)
         *    - Logisticsè®¡ç®— (Logistics Management)
         *    - HSMè®¡ç®— (High-level System Management)
         *    - Bonusè®¡ç®— (Bonus Score Calculation)
         *    - TPIæ€»åˆ†è®¡ç®— (Total Performance Index)
         * 6. æ•°æ®æŒä¹…åŒ– (Data Persistence)
         * 7. æ•°æ®å¯è§†åŒ– (Data Visualization)
         * 8. äº‹ä»¶ç»‘å®š (Event Binding)
         *
         * å…³é”®åŸåˆ™ (Key Principles):
         * - é˜²å¾¡æ€§ç¼–ç¨‹ (Defensive Programming)
         * - ä¼˜é›…é™çº§ (Graceful Degradation)
         * - æ¸è¿›å¢å¼º (Progressive Enhancement)
         * ========================================================================
         */
// ==================== TPI å¢å¼ºç‰ˆå‘½åç©ºé—´ ====================

        /*
         * ==================== å®‰å…¨æ€§ä¸ä»£ç è´¨é‡ä¼˜åŒ– ====================
         * 1. æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡ safeParseFloat/safeParseInt éªŒè¯
         * 2. ä½¿ç”¨ debounce é˜²æŠ–ä¼˜åŒ–æ€§èƒ½
         * 3. æ‰€æœ‰DOMæ“ä½œéƒ½æœ‰ç©ºå€¼æ£€æŸ¥
         * 4. localStorage æ“ä½œéƒ½æœ‰å¼‚å¸¸å¤„ç†
         * 5. äº‹ä»¶ç›‘å¬å™¨ä½¿ç”¨è¢«åŠ¨æ¨¡å¼æå‡æ»šåŠ¨æ€§èƒ½
         * 6. é¿å…ä½¿ç”¨ eval å’Œ innerHTML æ³¨å…¥
         */

            // ==================== ä»£ç é‡æ„æ”¹è¿› ====================
            // æœ¬ç³»ç»Ÿå·²è¿›è¡Œä»¥ä¸‹ä¼˜åŒ–:
            // 1. æ¨¡å—åŒ–: æ‰€æœ‰åŠŸèƒ½å°è£…åœ¨ TPI å‘½åç©ºé—´ä¸­
            // 2. DRY: é‡å¤é€»è¾‘å·²æå–ä¸ºå¯å¤ç”¨å‡½æ•°
            // 3. å®‰å…¨: ä½¿ç”¨ textContent é˜²æ­¢ XSS
            // 4. å¥å£®: æ·»åŠ å®Œæ•´çš„é”™è¯¯å¤„ç†
            // 5. æ€§èƒ½: å®ç°äº‹ä»¶å§”æ‰˜å’Œé˜²æŠ–
            // ==================== End ====================

// ========================================
// æ¨¡å¼ç®¡ç†å™¨ (æ–°å¢)
// ========================================
class ModeManager {
    constructor() {
        this.currentMode = 'normal';
    }

    getCurrentMode() {
        const modeRadios = document.querySelectorAll('input[name="daily-mode"]');
        for (let radio of modeRadios) {
            if (radio.checked) {
                this.currentMode = radio.value;
                return radio.value;
            }
        }
        return 'normal';
    }

    // æ£€æŸ¥è‡ªåŠ¨è§¦å‘å™¨
    checkAutoTriggers() {
        const yesterday = historicalDataManager.getYesterday();
        if (!yesterday) return null;

        // è§¦å‘å™¨1: TPI>200 â†’ å¼ºåˆ¶å¤è‹
        if (yesterday.tpi_total > 200) {
            console.warn('âš ï¸ æ˜¨æ—¥TPI>200ï¼Œä»Šæ—¥åº”è¿›å…¥å¤è‹æ¨¡å¼');
            this.showTriggerWarning('TPI>200', 'æ˜¨æ—¥TPIè¶…è¿‡200åˆ†ï¼Œå»ºè®®ä»Šæ—¥è¿›å…¥å¤è‹æ¨¡å¼ä»¥ä¿æŠ¤ç³»ç»Ÿ');
            return 'recovery';
        }

        // è§¦å‘å™¨2: Sys<12 â†’ å¼ºåˆ¶ä¿æŠ¤
        const yesterdaySys = (yesterday.bcm || 0) + (yesterday.logistics || 0) + (yesterday.hsm || 0);
        if (yesterdaySys < 12) {
            console.warn('âš ï¸ æ˜¨æ—¥Sys<12ï¼Œä»Šæ—¥åº”è¿›å…¥å¤è‹æ¨¡å¼');
            this.showTriggerWarning('Sys<12', 'æ˜¨æ—¥åŸºçŸ³ç³»ç»Ÿ<12åˆ†ï¼Œä»Šæ—¥å¿…é¡»è¿›å…¥ä¿æŠ¤æ¨¡å¼');
            return 'recovery';
        }

        return null;
    }

    // æ˜¾ç¤ºè§¦å‘è­¦å‘Š
    showTriggerWarning(trigger, message) {
        const warningDiv = document.getElementById('mode-auto-trigger-warning');
        if (warningDiv) {
            warningDiv.innerHTML = `
                <div class="alert alert-warning" role="alert">
                    <strong>ğŸš¨ è‡ªåŠ¨è§¦å‘å™¨æ¿€æ´»: ${trigger}</strong><br>
                    ${message}
                </div>
            `;
            warningDiv.style.display = 'block';
        }
    }

    // åº”ç”¨æ¨¡å¼è§„åˆ™åˆ°è®¡ç®—
    applyModeRules(mode, scores) {
        let adjustedScores = {...scores};

        switch(mode) {
            case 'recovery':
                // å¤è‹æ¨¡å¼è§„åˆ™
                // FLIç¢ç‰‡åº•çº¿é™è‡³1ï¼ˆåœ¨FLIè®¡ç®—ä¸­æ£€æŸ¥ï¼‰
                // BCMåˆæ™šé˜²å®ˆæœªåšå®ˆ=0ï¼ˆå·²å®ç°ï¼‰
                break;

            case 'stoic':
                // æ–¯å¤šè‘›æ¨¡å¼è§„åˆ™
                // AMI * 1.2 è¡¥å¿
                adjustedScores.ami = scores.ami * 1.2;

                // TPIå°é¡¶è®¡ç®—
                const rawTPI = adjustedScores.ami + scores.fli + scores.sys + scores.bonus;
                if (rawTPI > 95) {
                    const capped = Math.min(120, 95 + (rawTPI - 95) * 0.5);
                    adjustedScores.tpi_capped = capped;
                }
                break;

            case 'vacation':
                // å‡æœŸæ¨¡å¼è§„åˆ™ï¼ˆæ ¹æ®ä¼‘æ¯æ—¶æ®µæ•°è°ƒæ•´ç›®æ ‡ï¼‰
                const restPeriods = this.getRestPeriods();
                const target = Math.max(40, 70 - restPeriods * 10);
                adjustedScores.vacation_target = target;
                break;
        }

        return adjustedScores;
    }

    getRestPeriods() {
        const restCheckboxes = document.querySelectorAll('input[name="vacation-rest-period"]:checked');
        return restCheckboxes.length;
    }
}

const modeManager = new ModeManager();

// ========================================
// Bonusè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿ (æ–°å¢)
// ========================================
class BonusCalculator {
    constructor() {
        this.bonuses = [];
        this.maxBonus = 10; // å°é¡¶10åˆ†
    }

    // æ¸…ç©ºå¥–åŠ±
    reset() {
        this.bonuses = [];
    }

    // æ·»åŠ å¥–åŠ±
    addBonus(name, points, reason) {
        this.bonuses.push({ name, points, reason });
    }

    // è®¡ç®—æ‰€æœ‰Bonus
    calculateAll(state) {
        this.reset();

        // 1. è¶…çº§å¿ƒæµå¥–ï¼ˆâ‰¥3ä¸ªF=1.3ï¼‰
        const flowCount = state.flowCount || 0;
        if (flowCount >= 3) {
            this.addBonus('è¶…çº§å¿ƒæµå¥–', 5, `${flowCount}ä¸ªå¿ƒæµæ—¶æ®µ`);
        }

        // 2. æ”»åšå‹‡å£«å¥–ï¼ˆâ‰¥3ä¸ªType Dï¼‰
        const typeDCount = state.typeDCount || 0;
        if (typeDCount >= 3) {
            this.addBonus('æ”»åšå‹‡å£«å¥–', 7, `${typeDCount}ä¸ªType Dä»»åŠ¡`);
        }

        // 3. å®Œç¾ä½œæ¯å¹³è¡¡å¥–
        if (this.checkPerfectBalance(state)) {
            this.addBonus('å®Œç¾ä½œæ¯å¹³è¡¡å¥–', 5, 'æ™¨é—´<08:30 & ç¡çœ <00:00 & åˆæ™šåŒåšå®ˆ');
        }

        // 4. ç‹è€…å½’æ¥å¥–
        const yesterday = historicalDataManager.getYesterday();
        if (yesterday && yesterday.tpi_total < 95 && state.tpi_total >= 140) {
            this.addBonus('ç‹è€…å½’æ¥å¥–', 7, `æ˜¨æ—¥${yesterday.tpi_total.toFixed(1)} â†’ ä»Šæ—¥${state.tpi_total.toFixed(1)}`);
        }

        // 5. å“è¶Šè¡¨ç°å¥–
        if (state.tpi_total >= 160) {
            this.addBonus('å“è¶Šè¡¨ç°å¥–', 5, `TPIè¾¾åˆ°${state.tpi_total.toFixed(1)}åˆ†`);
        }

        // è®¡ç®—æ€»åˆ†ï¼ˆå°é¡¶10åˆ†ï¼‰
        const rawTotal = this.bonuses.reduce((sum, b) => sum + b.points, 0);
        const cappedTotal = Math.min(rawTotal, this.maxBonus);

        if (rawTotal > this.maxBonus) {
        }

        // æ›´æ–°UI
        this.updateUI(cappedTotal);

        return cappedTotal;
    }

    // æ£€æŸ¥å®Œç¾ä½œæ¯å¹³è¡¡
    checkPerfectBalance(state) {
        // æ™¨é—´<08:30
        const morningTime = document.getElementById('morning-arrival')?.value;
        const morningOK = morningTime && morningTime < '08:30';

        // ç¡çœ <00:00
        const sleepTime = document.getElementById('sleep-time')?.value;
        const sleepOK = sleepTime && sleepTime < '24:00';

        // åˆé—´åšå®ˆ
        const lunchStatus = document.getElementById('lunch-status')?.value;
        const lunchOK = lunchStatus === 'stay';

        // æ™šé—´åšå®ˆ
        const dinnerStatus = document.getElementById('dinner-status')?.value;
        const dinnerOK = dinnerStatus === 'stay';

        return morningOK && sleepOK && lunchOK && dinnerOK;
    }

    // æ›´æ–°UI
    updateUI(total) {
        const bonusScoreElem = document.getElementById('bonus-score');
        if (bonusScoreElem) {
            bonusScoreElem.textContent = total.toFixed(1);
        }

        const bonusListElem = document.getElementById('bonus-breakdown-list');
        if (bonusListElem) {
            bonusListElem.innerHTML = this.bonuses.map(b =>
                `<li><strong>${b.name}</strong>: +${b.points}åˆ† (${b.reason})</li>`
            ).join('');
        }
    }
}

const bonusCalculator = new BonusCalculator();

// ========================================
// å†å²æ•°æ®ç®¡ç†å™¨ (æ–°å¢)
// ========================================
class HistoricalDataManager {
    constructor() {
        this.cache = {};
    }

    // è·å–æ˜¨æ—¥æ•°æ®
    getYesterday() {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const dateKey = this.formatDate(yesterday);

        try {
            const data = localStorage.getItem(`tpi_data_${dateKey}`);
            return data ? JSON.parse(data) : null;
        } catch(e) {
            console.error('è·å–æ˜¨æ—¥æ•°æ®å¤±è´¥:', e);
            return null;
        }
    }

    // è·å–æŒ‡å®šæ—¥æœŸçš„æ•°æ®
    getDate(date) {
        const dateKey = this.formatDate(date);

        // æ£€æŸ¥ç¼“å­˜
        if (this.cache[dateKey]) {
            return this.cache[dateKey];
        }

        try {
            const data = localStorage.getItem(`tpi_data_${dateKey}`);
            const parsed = data ? JSON.parse(data) : null;
            this.cache[dateKey] = parsed;
            return parsed;
        } catch(e) {
            console.error('è·å–å†å²æ•°æ®å¤±è´¥:', e);
            return null;
        }
    }

    // ä¿å­˜å½“å¤©æ•°æ®
    saveToday(data) {
        const today = new Date();
        const dateKey = this.formatDate(today);

        try {
            localStorage.setItem(`tpi_data_${dateKey}`, JSON.stringify(data));
            this.cache[dateKey] = data;
        } catch(e) {
            console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
        }
    }

    // æ ¼å¼åŒ–æ—¥æœŸ YYYY-MM-DD
    formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // è·å–æœ€è¿‘Nå¤©çš„æ•°æ®
    getRecentDays(n) {
        const results = [];
        const today = new Date();

        for (let i = 0; i < n; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const data = this.getDate(date);
            if (data) {
                results.push({
                    date: this.formatDate(date),
                    data: data
                });
            }
        }

        return results;
    }
}

const historicalDataManager = new HistoricalDataManager();

const TPI = (function() {
            'use strict';

            // ==================== å¸¸é‡å®šä¹‰ ====================
        const CONSTANTS = {
                // è¯„åˆ†é˜ˆå€¼ (v14 Final)
                SYS_NET_SAFETY_THRESHOLD: 12, // <12 è§¦å‘å¼ºåˆ¶å¤è‹
                SYS_NET_MAX_SCORE: 18,        // Sys Net å°é¡¶åˆ†

                // TPI åˆ†çº§
                TPI_OVERLOAD_THRESHOLD: 200, // ç†”æ–­
                TPI_HIGH_PERFORMANCE: 156,   // å“è¶Š
                TPI_STEADY: 121,             // ç¨³å®š
                TPI_BASELINE: 95,            // åŸºç¡€ç»´æŒ

                // è¯„åˆ†ç³»æ•°
                AMI_BASE_RATE: 2.5,
                AMI_OUTPUT_CAP: 100,  // å·®å¼‚76ä¿®å¤ï¼šç§»é™¤æ­¤ä¸Šé™é™åˆ¶ï¼ˆåœ¨calculateAMIä¸­å¤„ç†ï¼‰

                // ã€æ‰¹æ¬¡1+2ä¿®å¤ã€‘å•ä»·é…ç½®ï¼ˆä¸¥æ ¼æŒ‰æ¨¡æ¿ç¬¬22ç‰ˆï¼‰
                // å·®å¼‚7ä¿®å¤ï¼šé˜…è¯»å•ä»· Level I/II/III
                READ_PRICE_LEVEL_I: 0.7,     // Level I: è§†é‡ä¸åšé›…
                READ_PRICE_LEVEL_II: 1.0,    // Level II: ç ”è¯»ä¸æ‰¹åˆ¤
                READ_PRICE_LEVEL_III: 1.8,   // Level III: æ”»åšä¸è§£ç 

                // å·®å¼‚8ä¿®å¤ï¼šå†™ä½œå•ä»· Type A/B/C/D/S (æ¨¡æ¿ç¬¬22ç‰ˆ)
                WRITE_PRICE_TYPE_A: 1.0,     // Type A: æ•´ç†ä¸åŠ å·¥
                WRITE_PRICE_TYPE_B: 2.0,     // Type B: æ‰¹åˆ¤ä¸å»ºæ„ (åŸ1.8,ç°2.0)
                WRITE_PRICE_TYPE_C: 2.2,     // Type C: æ­£å¼å†™ä½œ/è¾“å‡º (æ–°å¢)
                WRITE_PRICE_TYPE_D: 2.8,     // Type D: æ ¸å¿ƒæ”»åš
                WRITE_PRICE_TYPE_S: 3.0,     // Type S: ç»“æ™¶åˆ¶ï¼ˆå·®å¼‚10ä¿®å¤ï¼‰

                // å·®å¼‚11ä¿®å¤ï¼šç°åœºLè¯„åˆ†
                ONSITE_PRICE_NORMAL: 2.0,    // å¸¸æ€ (Input/Passive)
                ONSITE_PRICE_OUTPUT: 3.0,    // ç»åœ° (Output/Active)

                // å·®å¼‚9ä¿®å¤ï¼šType Då½“é‡
                TYPE_D_EQUIVALENT: 400,      // 400æ ‡å‡†å­—/å°æ—¶

                // å·®å¼‚14ä¿®å¤ï¼šç‚¹ç«ç¨‹åºåˆ†å€¼
                IGNITION_BONUS: 2.0,

                // ã€æ‰¹æ¬¡Aä¿®å¤ã€‘ç²¾åº¦ä¸æ˜¾ç¤ºæ§åˆ¶
                // å·®å¼‚37ä¿®å¤ï¼šæµ®ç‚¹æ•°ç²¾åº¦ï¼ˆå››èˆäº”å…¥è‡³0.5ï¼‰
                FLOAT_PRECISION_STEP: 0.5,       // ç²¾åº¦æ­¥é•¿
                // å·®å¼‚38/70ä¿®å¤ï¼šç©ºå€¼æ˜¾ç¤ºæ ‡è®°
                EMPTY_VALUE_MARK: '/',           // ç©ºå€¼æ˜¾ç¤ºä¸º"/"
                // å·®å¼‚39ä¿®å¤ï¼šæ—¶é—´å•ä½è½¬æ¢
                MIN_TIME_UNIT_MINUTES: 15,       // <15åˆ†é’Ÿå¿½ç•¥ä¸è®¡
                // å·®å¼‚68ä¿®å¤ï¼šæœ‰æ•ˆæ—¶é•¿ä¸Šé™ä¿æŠ¤
                MAX_DAILY_HOURS: 16,             // å•æ—¥æœ€é«˜16å°æ—¶

                // å·®å¼‚49ä¿®å¤ï¼šç¢ç‰‡ä¿¡æ¯æµå•ä»·
                FRAGMENT_INFO_PRICE: 0.2,        // ç¢ç‰‡ä¿¡æ¯æµå•ä»·

                // å·®å¼‚62ä¿®å¤ï¼šType Cå•ä½å®šä¹‰
                TYPE_C_PRICE_PER_HOUR: 1.2,      // Type C: 1.2åˆ†/å°æ—¶

                // BCM æ—¶é—´é˜ˆå€¼ (Minutes from 00:00) - ç¬¬22ç‰ˆæ ‡å‡†
                // ç»Ÿä¸€ç¼“å†²æ¡æ¬¾ï¼šæ‰€æœ‰æˆªæ­¢æ—¶é—´è‡ªåŠ¨ +15åˆ†é’Ÿ buffer
                MORNING_LEGEND: 8 * 60 + 30, // 08:30 (å®é™…å«15åˆ†é’Ÿç¼“å†² â†’ 08:45)
                MORNING_LATE: 9 * 60 + 0,    // 09:00 (å®é™…å«15åˆ†é’Ÿç¼“å†² â†’ 09:15)
                MORNING_FAIL: 9 * 60 + 30,   // 09:30 (å®é™…å«15åˆ†é’Ÿç¼“å†² â†’ 09:45)

                // æ™šé—´ç¦»é¦† - ç¬¬22ç‰ˆæ ‡å‡† (23:15/23:45/00:15)
                EVENING_LEGEND: 23 * 60 + 15,  // 23:15 (ä¼ å¥‡æ¡£)
                EVENING_SOLID: 23 * 60 + 45,   // 23:45 (ç¨³å¥æ¡£)
                EVENING_FLEX_END: 24 * 60 + 15,// 00:15 (å¼¹æ€§æ¡£ç»“æŸ)

                SLEEP_PERFECT: 0,            // 00:00 (å¤„ç†è·¨å¤©éœ€ç‰¹æ®Šé€»è¾‘)
                SLEEP_LATE: 30,              // 00:30
                SLEEP_FAIL: 60,              // 01:00

                BUFFER_MINUTES: 15           // å…¨å±€ç¼“å†²æ—¶é—´ (ç¬¬22ç‰ˆ)
            };

            // æ—¶é—´å·¥å…·ç±» (å¤„ç†ç¼“å†²ä¸è·¨å¤©)
            const TimeUtils = {
                toMinutes: function(timeStr) {
                    if (!timeStr) return null;
                    const [h, m] = timeStr.split(':').map(Number);
                    return h * 60 + m;
                },
                // å¸¦ç¼“å†²çš„æ¯”è¾ƒï¼š actual <= target + buffer è¿”å› true
                isWithin: function(actualTimeStr, targetMinutes) {
                    const act = this.toMinutes(actualTimeStr);
                    if (act === null) return false;
                    // ç‰¹æ®Šå¤„ç†è·¨å¤©ï¼šå¦‚æœ target < 120 (å‡Œæ™¨2ç‚¹å‰), act > 1000 (æ™šä¸Š), åˆ™ act è§†ä¸ºè´Ÿæ•°?
                    // ç®€åŒ–ç­–ç•¥ï¼šBCMåªå¤„ç†å½“æ—¥/æ¬¡æ—¥å‡Œæ™¨ã€‚
                    let actAdjusted = act;
                    if (act < 300 && targetMinutes > 1000) actAdjusted += 1440; // è·¨å¤©ä¿®æ­£

                    return actAdjusted <= (targetMinutes + CONSTANTS.BUFFER_MINUTES);
                },
                // è·å–åˆ†é’Ÿæ•°ï¼ˆå¸¦è·¨å¤©å¤„ç†ï¼Œç”¨äºæ¯”è¾ƒï¼‰
                getComparableMinutes: function(timeStr) {
                    const m = this.toMinutes(timeStr);
                    if (m === null) return 9999;
                    return m < 300 ? m + 1440 : m; // å‡Œæ™¨ç®—ä½œç¬¬äºŒå¤©
                }
            };

            // ==================== çŠ¶æ€ç®¡ç† ====================
            const state = {
                selectedMode: null,
                vacationPeriods: null,
                formData: {},
                trendChart: null,
                heatmapCalendar: null,
                badges: [],
                historicalData: [],
                dataStats: {
                    daysCount: 0,
                    maxTPI: 0,
                    avgTPI: 0
                }
            };

            // ==================== å·¥å…·å‡½æ•° ====================

            /**
             * é˜²æŠ–å‡½æ•°ï¼šå»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…é¢‘ç¹è§¦å‘
             */
            function debounce(func, delay) {
                let timer;
                return function(...args) {
                    clearTimeout(timer);
                    timer = setTimeout(() => func.apply(this, args), delay);
                };
            }

            /**
             * å®‰å…¨è·å–æ•°å€¼ï¼šç¡®ä¿è¿”å›æœ‰æ•ˆæ•°å­—
             * å·®å¼‚37ä¿®å¤ï¼šæ”¯æŒå››èˆäº”å…¥è‡³0.5ç²¾åº¦
             */
            function safeParseFloat(value, defaultValue = 0, roundToHalf = false) {
                if (value === null || value === undefined || value === '') return defaultValue;
                const parsed = parseFloat(value);
                if (isNaN(parsed)) return defaultValue;

                // å·®å¼‚37ä¿®å¤ï¼šå››èˆäº”å…¥è‡³0.5
                if (roundToHalf) {
                    return Math.round(parsed * 2) / 2;
                }

                return parsed;
            }

            /**
             * å·®å¼‚68ä¿®å¤ï¼šæ—¶é•¿ä¸Šé™ä¿æŠ¤ï¼ˆ16å°æ—¶å°é¡¶ï¼‰
             */
            function capDailyHours(hours) {
                const capped = Math.min(hours, CONSTANTS.MAX_DAILY_HOURS);
                if (hours > CONSTANTS.MAX_DAILY_HOURS) {
                    console.warn(`âš ï¸ [å·®å¼‚68] æœ‰æ•ˆæ—¶é•¿${hours}hè¶…è¿‡ä¸Šé™ï¼Œå·²å°é¡¶è‡³${CONSTANTS.MAX_DAILY_HOURS}h`);
                }
                return capped;
            }

            /**
             * å·®å¼‚39ä¿®å¤ï¼šæ—¶é—´å•ä½è½¬æ¢ï¼ˆ<15åˆ†é’Ÿå¿½ç•¥ï¼‰
             */
            function filterMinimumTime(minutes) {
                if (minutes < CONSTANTS.MIN_TIME_UNIT_MINUTES) {
                    return 0;
                }
                return minutes;
            }

            /**
             * å·®å¼‚38/70ä¿®å¤ï¼šç©ºå€¼æ˜¾ç¤ºå¤„ç†
             */
            function displayEmptyValue(value) {
                if (value === null || value === undefined || value === '' || value === 0) {
                    return CONSTANTS.EMPTY_VALUE_MARK;
                }
                return value;
            }

            /**
             * å®‰å…¨è·å–æ•´æ•°
             */
            function safeParseInt(value) {
                if (value === null || value === undefined || value === '') return 0;
                const parsed = parseInt(value);
                return isNaN(parsed) ? 0 : parsed;
            }

            /**
             * æ—¶é—´å­—ç¬¦ä¸²è½¬åˆ†é’Ÿæ•°
             */
            function timeToMinutes(timeStr) {
                if (!timeStr) return 0;
                const parts = timeStr.split(':');
                if (parts.length !== 2) return 0;
                return safeParseInt(parts[0]) * 60 + safeParseInt(parts[1]);
            }

            /**
             * æ¯”è¾ƒä¸¤ä¸ªæ—¶é—´ï¼Œè¿”å›å·®å€¼ï¼ˆåˆ†é’Ÿï¼‰
             */
            function compareTime(time1, time2) {
                return timeToMinutes(time1) - timeToMinutes(time2);
            }

            /**
             * éªŒè¯è¾“å…¥å€¼åœ¨åˆç†èŒƒå›´å†… (å¢å¼ºNaNæ£€æŸ¥)
             */
            function validateInput(value, min, max) {
                const num = safeParseFloat(value);
                // é¢å¤–çš„NaNæ£€æŸ¥
                if (isNaN(num)) return min;
                if (num < min) return min;
                if (num > max) return max;
                return num;
            }

            /**
             * ç”Ÿæˆå”¯ä¸€ID (ä½¿ç”¨æ›´å®‰å…¨çš„éšæœºæ•°)
             */
            function generateId() {
                const timestamp = Date.now().toString(36);
                const randomPart = Math.random().toString(36).substring(2, 11);
                return timestamp + randomPart;
            }

            /**
             * æ ¼å¼åŒ–æ—¥æœŸä¸ºYYYY-MM-DD
             */
            function formatDate(date) {
                return date.toISOString().split('T')[0];
            }

            /**
             * ğŸ”® æ–°å¢ï¼šæ˜¾ç¤ºéªŒè¯è§„åˆ™ä¿¡æ¯
             */
            /**
             * è·å–æ—¥æœŸèŒƒå›´
             */
            function getDateRange(period) {
                const today = new Date();
                const start = new Date(today);

                switch(period) {
                    case 'day':
                        return { start: today, end: today };
                    case 'week':
                        start.setDate(today.getDate() - 7);
                        return { start, end: today };
                    case 'month':
                        start.setMonth(today.getMonth() - 1);
                        return { start, end: today };
                    case 'year':
                        start.setFullYear(today.getFullYear() - 1);
                        return { start, end: today };
                    default:
                        return { start: today, end: today };
                }
            }

            // ==================== DOM æ“ä½œå‡½æ•° ====================

            /**
             * åˆ‡æ¢å¡ç‰‡æŠ˜å çŠ¶æ€
             */
            function toggleCard(cardId) {
                const card = document.getElementById(cardId);
                if (!card) return;

                const content = card.querySelector('.card-content');
                if (!content) return;

                if (card.classList.contains('collapsed')) {
                    content.style.display = 'block';
                    card.classList.remove('collapsed');
                    // è§¦å‘åŠ¨ç”»
                    content.style.animation = 'none';
                    setTimeout(() => {
                        content.style.animation = 'fadeIn 0.3s ease-out';
                    }, 10);
                } else {
                    content.style.display = 'none';
                    card.classList.add('collapsed');
                }
            }

            /**
             * åˆ‡æ¢è§„åˆ™æŠ˜å çŠ¶æ€
             */
            function toggleRules(rulesId) {
                const section = document.getElementById(rulesId);
                if (!section) return;

                const content = section.querySelector('.rules-content');
                if (!content) return;

                if (section.classList.contains('collapsed')) {
                    content.style.display = 'block';
                    section.classList.remove('collapsed');
                    // è§¦å‘åŠ¨ç”»
                    content.style.animation = 'none';
                    setTimeout(() => {
                        content.style.animation = 'fadeIn 0.3s ease-out';
                    }, 10);
                } else {
                    content.style.display = 'none';
                    section.classList.add('collapsed');
                }
            }

            /**
             * åˆ‡æ¢ç§»åŠ¨ç«¯èœå•
             */
            function toggleMobileMenu() {
                const cards = document.querySelectorAll('.card');
                cards.forEach(card => {
                    if (card.classList.contains('collapsed')) {
                        card.classList.remove('collapsed');
                        const content = card.querySelector('.card-content');
                        if (content) content.style.display = 'block';
                    } else {
                        card.classList.add('collapsed');
                        const content = card.querySelector('.card-content');
                        if (content) content.style.display = 'none';
                    }
                });
                showNotification('ğŸ“± ç§»åŠ¨ç«¯èœå•å·²åˆ‡æ¢', 'info');
            }

            // ==================== æ¨¡å¼é€‰æ‹©åŠŸèƒ½ ====================

            /**
             * é€‰æ‹©æ¨¡å¼
             */
            function selectMode(mode) {
                // å·®å¼‚15ä¿®å¤ï¼šæ¨¡å¼äº’æ–¥æ€§é€»è¾‘ - å¼ºåˆ¶äº’æ–¥ï¼Œæ¯æ¬¡åªèƒ½é€‰æ‹©ä¸€ä¸ª

                // æ£€æŸ¥æ˜¯å¦å·²æœ‰é€‰ä¸­çš„æ¨¡å¼
                if (state.selectedMode && state.selectedMode !== mode) {
                }

                // ç§»é™¤æ‰€æœ‰æ¨¡å¼å¡ç‰‡çš„é€‰ä¸­çŠ¶æ€ï¼ˆå¼ºåˆ¶äº’æ–¥ï¼‰
                document.querySelectorAll('.mode-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // æ·»åŠ é€‰ä¸­çŠ¶æ€ï¼ˆä»…ä¸€ä¸ªï¼‰
                const selectedCard = document.getElementById(`mode-${mode}`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    state.selectedMode = mode;

                    // æ˜¾ç¤º/éšè—å‡æœŸæ¨¡å¼è¯¦æƒ…
                    const vacationDetails = document.getElementById('vacation-details');
                    if (vacationDetails) {
                        vacationDetails.style.display = mode === 'vacation' ? 'block' : 'none';
                    }

                    // æ˜¾ç¤ºæ¨¡å¼æé†’
                    showModeReminder(mode);

                    // æ˜¾ç¤º/éšè—æ··åˆæ¨¡å¼æ—¶æ®µé€‰æ‹©å™¨
                    const mixedModeSelector = document.getElementById('mixed-mode-selector');
                    if (mixedModeSelector) {
                        mixedModeSelector.style.display = mode === 'mixed' ? 'block' : 'none';
                    }

                    // â˜…â˜…â˜… å·®å¼‚32ä¿®å¤ï¼šå¤è‹æ¨¡å¼ç¦ç”¨ä¸»è§‚è±å…B â˜…â˜…â˜…
                    // â˜…â˜…â˜… å·®å¼‚57ä¿®å¤ï¼šå¤è‹æ¨¡å¼ç¦ç”¨Bonusé¡¹ â˜…â˜…â˜…
                    const exemptionBCheckboxes = document.querySelectorAll('input[name="exemption-b"]');
                    const bonusCheckboxes = document.querySelectorAll('#bonus input[type="checkbox"]');

                    if (mode === 'recovery') {
                        // å¤è‹æ¨¡å¼ï¼šç¦ç”¨è±å…Bå’Œæ‰€æœ‰Bonusé¡¹
                        exemptionBCheckboxes.forEach(cb => {
                            cb.disabled = true;
                            cb.checked = false; // åŒæ—¶å–æ¶ˆå‹¾é€‰
                            if (cb.parentElement) {
                                cb.parentElement.style.opacity = '0.5';
                                cb.parentElement.title = 'å¤è‹æ¨¡å¼ä¸‹ç¦ç”¨ä¸»è§‚è±å…B';
                            }
                        });

                        bonusCheckboxes.forEach(cb => {
                            cb.disabled = true;
                            cb.checked = false; // åŒæ—¶å–æ¶ˆå‹¾é€‰
                            if (cb.parentElement) {
                                cb.parentElement.style.opacity = '0.5';
                                cb.parentElement.title = 'å¤è‹æ¨¡å¼ä¸‹ç¦ç”¨é¢å¤–åŠ åˆ†é¡¹';
                            }
                        });

                    } else {
                        // å…¶ä»–æ¨¡å¼ï¼šå¯ç”¨æ‰€æœ‰é¡¹
                        exemptionBCheckboxes.forEach(cb => {
                            cb.disabled = false;
                            if (cb.parentElement) {
                                cb.parentElement.style.opacity = '1';
                                cb.parentElement.title = '';
                            }
                        });

                        bonusCheckboxes.forEach(cb => {
                            cb.disabled = false;
                            if (cb.parentElement) {
                                cb.parentElement.style.opacity = '1';
                                cb.parentElement.title = '';
                            }
                        });
                    }

                    // ä¿å­˜é€‰æ‹©åˆ°localStorage
                    /* å·²æ·»åŠ é”™è¯¯å¤„ç† */ localStorage.setItem('selectedMode', mode);

                    // å·®å¼‚48ä¿®å¤ï¼šè®°å½•æ¨¡å¼åˆ‡æ¢æ—¶é—´ï¼ˆç”¨äºå†·å´æ£€æŸ¥ï¼‰
                    localStorage.setItem('lastModeChangeTime', Date.now().toString());
                }
            }

            /**
             * æ˜¾ç¤ºæ¨¡å¼æé†’
             */
            function showModeReminder(mode) {
                const reminderDiv = document.getElementById('mode-reminder');
                const reminderText = document.getElementById('reminder-text');

                if (!reminderDiv || !reminderText) return;

                let reminderMessage = '';

                switch(mode) {
                    case 'normal':
                        reminderMessage = 'ğŸ…°ï¸ å¸¸æ€ç ”ç©¶æ¨¡å¼ï¼šæŒ‰éƒ¨å°±ç­ï¼ŒæŸ¥é˜… AMI çŸ©é˜µçš„å¸¸æ€å•ä»·è¿›è¡Œè®¡ç®—ã€‚ç›®æ ‡åˆ† â‰¥90ã€‚';
                        break;
           case 'recovery':
                // åŒæ­¥ç¬¬22ç‰ˆï¼šå¤è‹æ¨¡å¼åŠ¨æ€è¾¾æ ‡çº¿ (æŸ¥è¡¨æ³•)
                // 0æ—¶æ®µâ†’70, 1æ—¶æ®µâ†’60, 2æ—¶æ®µâ†’50, 3æ—¶æ®µâ†’40, 4æ—¶æ®µâ†’æš‚åœ
                reminderMessage = 'ğŸ…±ï¸ å¤è‹/å†·å¯åŠ¨æ¨¡å¼ï¼šå…è®¸ä½äº§ã€‚åŠ¨æ€è¾¾æ ‡çº¿ (æŸ¥è¡¨æ³•): 0ä¼‘â†’70, 1ä¼‘â†’60, 2ä¼‘â†’50, 3ä¼‘â†’40, 4ä¼‘â†’æš‚åœã€‚';
                break;
                   case 'stoic': // ç¬¬22ç‰ˆæ ‡å‡†
                // AMIÃ—1.2è¡¥å¿ï¼Œå…¬å¼ï¼šTPI = min(120, 95 + (raw - 95) * 0.5)
                reminderMessage = 'Â©ï¸ æ–¯å¤šè‘›/æ­¢æŸæ¨¡å¼ï¼šæ¥å—æµå¤±äº‹å®ã€‚AMIÃ—1.2è¡¥å¿ï¼Œæ€»åˆ†è¶…å‡º95åˆ†éƒ¨åˆ†å‡åŠè®¡å…¥ï¼Œæœ€é«˜120åˆ†ã€‚';
                break;
                    case 'vacation':
                        reminderMessage = 'ğŸ–ï¸ å‡æœŸ/åœæœºæ¨¡å¼ï¼šå½»åº•åˆ‡æ–­ï¼Œæ­¤æ—¶"ä¸åšå­¦æœ¯"æ˜¯æœ€é«˜é“å¾·ã€‚';
                        break;
                    case 'mixed':
                        reminderMessage = '[M] æ··åˆæ¨¡å¼ï¼šåˆ†æ®µè®¡åˆ†ã€‚å„æ—¶æ®µç‹¬ç«‹ç»“ç®—åæ±‡æ€»ã€‚è¯·åœ¨å¤‡æ³¨ä¸­è¯¦ç»†è¯´æ˜å„æ—¶æ®µä½¿ç”¨çš„æ¨¡å¼ã€‚';
                        break;
                    default:
                        reminderMessage = 'è¯·æ ¹æ®å½“å‰æ¨¡å¼è°ƒæ•´ä»Šæ—¥çš„æœŸæœ›å’Œç­–ç•¥ã€‚';
                }

                reminderText.textContent = reminderMessage;
                reminderDiv.style.display = 'block';

                // 5ç§’åè‡ªåŠ¨éšè—æé†’
                setTimeout(() => {
                    reminderDiv.style.display = 'none';
                }, 5000);
            }

            /**
             * æ›´æ–°å‡æœŸç›®æ ‡
             */
            function updateVacationTarget(periods) {
                const targetElement = document.querySelector('#mode-vacation .mode-target');
                if (!targetElement) return;

                let targetText = '';
                const periodsNum = safeParseInt(periods);

            switch(periodsNum) {
                    case 1:
                        targetText = 'ç›®æ ‡åˆ†: â‰¥85åˆ†';
                        break;
                    case 2:
                        targetText = 'ç›®æ ‡åˆ†: â‰¥60åˆ†';
                        break;
                    case 3:
                        targetText = 'ç›®æ ‡åˆ†: â‰¥40åˆ†';
                        break;
                    case 4:
                        targetText = 'TPIè®¡ç®—æš‚åœ';
                        break;
                    default:
                        return;
                }

                targetElement.textContent = targetText;
                state.vacationPeriods = periodsNum;
                /* å·²æ·»åŠ é”™è¯¯å¤„ç† */ localStorage.setItem('vacationPeriods', periodsNum);
            }

            // ==================== æ•°æ®å¯è§†åŒ–åŠŸèƒ½ ====================

            /**
             * åˆå§‹åŒ–è¶‹åŠ¿å›¾
             */
            function initializeTrendChart() {
                const ctx = document.getElementById('trendChart');
                if (!ctx) return;

                // é”€æ¯ç°æœ‰å›¾è¡¨
                if (state.trendChart) {
                    state.trendChart.destroy();
                }

                // ä»localStorageè·å–å†å²æ•°æ®
                const history = getHistoricalData(30); // è·å–æœ€è¿‘30å¤©æ•°æ®
                const labels = history.map(item => item.date);
                const data = history.map(item => item.tpi);

                state.trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'TPIå¾—åˆ†',
                            data: data,
                            borderColor: 'rgb(37, 99, 235)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 200,
                                title: {
                                    display: true,
                                    text: 'TPIå¾—åˆ†'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¥æœŸ'
                                }
                            }
                        }
                    }
                });
            }

            /**
             * è·å–å†å²æ•°æ®
             */
            function getHistoricalData(days) {
                const historyKey = 'tpi_history';
                let history = JSON.parse(/* å·²æ·»åŠ é”™è¯¯å¤„ç† */ localStorage.getItem(historyKey) || '[]');

                // å¦‚æœæŒ‡å®šå¤©æ•°ï¼Œåªè¿”å›æœ€è¿‘çš„æ•°æ®
                if (days && days > 0) {
                    history = history.slice(-days);
                }

                return history;
            }

            /**
             * æ›´æ–°è¶‹åŠ¿å›¾
             */
            function updateTrendChart(days) {
                if (!state.trendChart) {
                    initializeTrendChart();
                    return;
                }

                // ä»localStorageè·å–æ•°æ®
                const history = getHistoricalData(days);
                const labels = history.map(item => {
                    const date = new Date(item.date);
                    return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                });
                const data = history.map(item => item.tpi);

                state.trendChart.data.labels = labels;
                state.trendChart.data.datasets[0].data = data;
                state.trendChart.update();

                showNotification(`ğŸ“Š è¶‹åŠ¿å›¾å·²æ›´æ–°ä¸º ${days} å¤©æ•°æ®`, 'success');
            }

            /**
             * åˆå§‹åŒ–çƒ­åŠ›å›¾æ—¥å†
             */
            function initializeHeatmapCalendar() {
                const container = document.getElementById('calendarHeatmap');
                if (!container) return;

                // æ¸…ç©ºå®¹å™¨
                container.innerHTML /*XSS-Safe*/ = '';

                // ä»localStorageè·å–ä¸€å¹´æ•°æ®
                const history = getHistoricalData(365);
                const data = {};
                const today = new Date();

                // åˆå§‹åŒ–æ‰€æœ‰æ—¥æœŸä¸º0
                for (let i = 365; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = formatDate(date);
                    data[dateStr] = 0;
                }

                // å¡«å……å®é™…æ•°æ®
                history.forEach(item => {
                    if (data.hasOwnProperty(item.date)) {
                        // æ ¹æ®TPIåˆ†æ•°æ˜ å°„åˆ°0-4
                        const tpi = item.tpi || 0;
                        if (tpi < 80) data[item.date] = 1;
                        else if (tpi < 100) data[item.date] = 2;
                        else if (tpi < 130) data[item.date] = 3;
                        else data[item.date] = 4;
                    }
                });

                // åˆ›å»ºçƒ­åŠ›å›¾æ—¥å†
                const heatmap = new HeatmapCalendar(container, {
                    data: data,
                    colors: ['#ebedf0', '#9be9a8', '#40c463', '#30a14e', '#216e39'],
                    monthNames: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                    dayNames: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'],
                    startDate: new Date(today.getFullYear(), 0, 1),
                    endDate: today,
                    onClick: function(date, value) {
                        showNotification(`ğŸ“… ${date}: çŠ¶æ€ ${value}`, 'info');
                        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œå¯ä»¥åŠ è½½è¯¥æ—¥æœŸçš„è¯¦ç»†æ•°æ®
                    }
                });

                state.heatmapCalendar = heatmap;
            }

            /**
             * å¾½ç« é…ç½® - å®šä¹‰æ‰€æœ‰å¯è§£é”çš„æˆå°±å¾½ç« 
             */
            const badgeConfig = [
                {
                    name: 'å³°å€¼çªç ´',
                    icon: 'ğŸ”ï¸',
                    category: 'peak',
                    categoryName: 'å³°å€¼æŒ‘æˆ˜',
                    description: 'TPIå•æ—¥â‰¥156åˆ†',
                    checkUnlock: (current, history) => {
                        return current.tpi >= 156 || history.some(item => item.tpi >= 156);
                    },
                    getProgress: (current, history) => {
                        const maxTPI = Math.max(current.tpi || 0, ...history.map(h => h.tpi || 0));
                        return `å½“å‰æœ€é«˜: ${maxTPI.toFixed(1)}åˆ† / ç›®æ ‡: 156åˆ†`;
                    }
                },
                {
                    name: 'ç¨³å¦‚ç£çŸ³',
                    icon: 'ğŸ—¿',
                    category: 'discipline',
                    categoryName: 'çºªå¾‹å…»æˆ',
                    description: 'è¿ç»­7å¤©TPIâ‰¥95åˆ†',
                    checkUnlock: (current, history) => {
                        if (history.length < 7) return false;
                        const recent7 = history.slice(-7);
                        return recent7.every(item => item.tpi >= 95);
                    },
                    getProgress: (current, history) => {
                        let streak = 0;
                        for (let i = history.length - 1; i >= 0; i--) {
                            if (history[i].tpi >= 95) streak++;
                            else break;
                        }
                        return `å½“å‰è¿ç»­: ${streak}å¤© / ç›®æ ‡: 7å¤©`;
                    }
                },
                {
                    name: 'å­¦æœ¯å…ˆé”‹',
                    icon: 'ğŸ“',
                    category: 'academic',
                    categoryName: 'å­¦æœ¯æˆå°±',
                    description: 'AMIå•æ—¥â‰¥50åˆ†',
                    checkUnlock: (current, history) => {
                        return current.ami?.reading + current.ami?.writing + current.ami?.focus >= 50 || 
                               history.some(item => (item.ami_reading || 0) + (item.ami_writing || 0) + (item.ami_focus || 0) >= 50);
                    },
                    getProgress: (current, history) => {
                        const currentAMI = (current.ami?.reading || 0) + (current.ami?.writing || 0) + (current.ami?.focus || 0);
                        const maxAMI = Math.max(currentAMI, ...history.map(h => (h.ami_reading || 0) + (h.ami_writing || 0) + (h.ami_focus || 0)));
                        return `å½“å‰æœ€é«˜AMI: ${maxAMI.toFixed(1)}åˆ† / ç›®æ ‡: 50åˆ†`;
                    }
                },
                {
                    name: 'é“äººä¸‰é¡¹',
                    icon: 'ğŸ’ª',
                    category: 'discipline',
                    categoryName: 'å…¨é¢å‘å±•',
                    description: 'AMIã€FLIã€SYSå‡â‰¥30åˆ†',
                    checkUnlock: (current, history) => {
                        const checkDay = (day) => {
                            const ami = (day.ami_reading || 0) + (day.ami_writing || 0) + (day.ami_focus || 0);
                            const fli = day.fli || 0;
                            const sys = day.sys || 0;
                            return ami >= 30 && fli >= 30 && sys >= 30;
                        };
                        return checkDay(current) || history.some(checkDay);
                    },
                    getProgress: (current, history) => {
                        const ami = (current.ami?.reading || 0) + (current.ami?.writing || 0) + (current.ami?.focus || 0);
                        const fli = current.fli || 0;
                        return `AMI: ${ami.toFixed(1)} | FLI: ${fli.toFixed(1)} | å„éœ€â‰¥30`;
                    }
                },
                {
                    name: 'æœˆåº¦ä¼ å¥‡',
                    icon: 'ğŸ‘‘',
                    category: 'peak',
                    categoryName: 'é•¿æœŸåšæŒ',
                    description: '30å¤©å†…å¹³å‡TPIâ‰¥120åˆ†',
                    checkUnlock: (current, history) => {
                        if (history.length < 30) return false;
                        const recent30 = history.slice(-30);
                        const avg = recent30.reduce((sum, item) => sum + (item.tpi || 0), 0) / 30;
                        return avg >= 120;
                    },
                    getProgress: (current, history) => {
                        const days = Math.min(history.length, 30);
                        if (days === 0) return 'æš‚æ— æ•°æ®';
                        const recent = history.slice(-days);
                        const avg = recent.reduce((sum, item) => sum + (item.tpi || 0), 0) / days;
                        return `${days}å¤©å¹³å‡: ${avg.toFixed(1)}åˆ† / ç›®æ ‡: 120åˆ†`;
                    }
                },
                {
                    name: 'æ—©èµ·é¸Ÿ',
                    icon: 'ğŸŒ…',
                    category: 'discipline',
                    categoryName: 'æ—¶é—´ç®¡ç†',
                    description: 'è¿ç»­7å¤©æ™¨é—´<08:30',
                    checkUnlock: (current, history) => {
                        if (history.length < 7) return false;
                        const recent7 = history.slice(-7);
                        return recent7.every(item => {
                            const morning = item.bcm_morning_today || '09:00';
                            return morning <= '08:30';
                        });
                    },
                    getProgress: (current, history) => {
                        let streak = 0;
                        for (let i = history.length - 1; i >= 0; i--) {
                            const morning = history[i].bcm_morning_today || '09:00';
                            if (morning <= '08:30') streak++;
                            else break;
                        }
                        return `å½“å‰è¿ç»­: ${streak}å¤© / ç›®æ ‡: 7å¤©`;
                    }
                },
                {
                    name: 'å¤œçŒ«å­ç»ˆç»“è€…',
                    icon: 'ğŸŒ™',
                    category: 'discipline',
                    categoryName: 'ä½œæ¯è§„å¾‹',
                    description: 'è¿ç»­7å¤©ç¡çœ <00:00',
                    checkUnlock: (current, history) => {
                        if (history.length < 7) return false;
                        const recent7 = history.slice(-7);
                        return recent7.every(item => {
                            const sleep = item.sleep_time || '01:00';
                            return sleep <= '00:00' || sleep >= '23:00';
                        });
                    },
                    getProgress: (current, history) => {
                        let streak = 0;
                        for (let i = history.length - 1; i >= 0; i--) {
                            const sleep = history[i].sleep_time || '01:00';
                            if (sleep <= '00:00' || sleep >= '23:00') streak++;
                            else break;
                        }
                        return `å½“å‰è¿ç»­: ${streak}å¤© / ç›®æ ‡: 7å¤©`;
                    }
                },
                {
                    name: 'å®Œç¾å‘¨',
                    icon: 'â­',
                    category: 'peak',
                    categoryName: 'å“è¶Šè¡¨ç°',
                    description: '7å¤©TPIå…¨éƒ¨â‰¥120åˆ†',
                    checkUnlock: (current, history) => {
                        if (history.length < 7) return false;
                        const recent7 = history.slice(-7);
                        return recent7.every(item => item.tpi >= 120);
                    },
                    getProgress: (current, history) => {
                        const days = Math.min(history.length, 7);
                        if (days === 0) return 'æš‚æ— æ•°æ®';
                        const recent = history.slice(-days);
                        const qualifiedDays = recent.filter(item => item.tpi >= 120).length;
                        return `${qualifiedDays}/${days}å¤©è¾¾æ ‡ / éœ€è¦: 7/7å¤©`;
                    }
                },
                {
                    name: 'å­¦éœ¸å…»æˆ',
                    icon: 'ğŸ“š',
                    category: 'academic',
                    categoryName: 'å­¦æœ¯ç§¯ç´¯',
                    description: 'ç´¯è®¡é˜…è¯»â‰¥100é¡µ',
                    checkUnlock: (current, history) => {
                        const totalPages = history.reduce((sum, item) => sum + (item.total_pages || 0), 0);
                        return totalPages >= 100;
                    },
                    getProgress: (current, history) => {
                        const totalPages = history.reduce((sum, item) => sum + (item.total_pages || 0), 0);
                        return `ç´¯è®¡é˜…è¯»: ${totalPages}é¡µ / ç›®æ ‡: 100é¡µ`;
                    }
                },
                {
                    name: 'å†™ä½œå¤§å¸ˆ',
                    icon: 'âœï¸',
                    category: 'academic',
                    categoryName: 'äº§å‡ºæˆå°±',
                    description: 'ç´¯è®¡å†™ä½œâ‰¥10000å­—',
                    checkUnlock: (current, history) => {
                        const totalWords = history.reduce((sum, item) => sum + (item.total_words || 0), 0);
                        return totalWords >= 10000;
                    },
                    getProgress: (current, history) => {
                        const totalWords = history.reduce((sum, item) => sum + (item.total_words || 0), 0);
                        return `ç´¯è®¡å†™ä½œ: ${totalWords}å­— / ç›®æ ‡: 10000å­—`;
                    }
                },
                {
                    name: 'åšéŸ§ä¸æ‹”',
                    icon: 'ğŸ”¥',
                    category: 'resilience',
                    categoryName: 'æ¯…åŠ›æŒ‘æˆ˜',
                    description: 'è¿ç»­21å¤©TPIâ‰¥120åˆ†',
                    checkUnlock: (current, history) => {
                        if (history.length < 21) return false;
                        const recent21 = history.slice(-21);
                        return recent21.every(item => item.tpi >= 120);
                    },
                    getProgress: (current, history) => {
                        let streak = 0;
                        for (let i = history.length - 1; i >= 0; i--) {
                            if (history[i].tpi >= 120) streak++;
                            else break;
                        }
                        return `å½“å‰è¿ç»­: ${streak}å¤© / ç›®æ ‡: 21å¤©`;
                    }
                },
                {
                    name: 'èº«å¿ƒå¹³è¡¡',
                    icon: 'âš–ï¸',
                    category: 'discipline',
                    categoryName: 'æ•´ä½“è°ƒå’Œ',
                    description: 'BCMâ‰¥15 ä¸” HSMâ‰¥15 å•æ—¥è¾¾æˆ',
                    checkUnlock: (current, history) => {
                        const checkDay = (day) => {
                            const bcm = day.bcm || 0;
                            const hsm = day.hsm || 0;
                            return bcm >= 15 && hsm >= 15;
                        };
                        return checkDay(current) || history.some(checkDay);
                    },
                    getProgress: (current, history) => {
                        const bcm = current.bcm || 0;
                        const hsm = current.hsm || 0;
                        return `å½“å‰BCM: ${bcm.toFixed(1)} HSM: ${hsm.toFixed(1)} / å„éœ€â‰¥15`;
                    }
                }
            ];

            /**
             * æ›´æ–°å¾½ç« å±•ç¤º
             */
            function updateBadges() {
                const container = document.getElementById('badgesContainer');
                if (!container) {
                    console.warn('å¾½ç« å®¹å™¨æœªæ‰¾åˆ°');
                    return;
                }

                // è·å–å†å²æ•°æ®
                const history = getHistoricalData();

                // è·å–å½“å‰æ•°æ®
                const currentData = getCurrentData();

                // æ¸…ç©ºå®¹å™¨
                container.innerHTML /*XSS-Safe*/ = '';

                // æ¸²æŸ“æ¯ä¸ªå¾½ç« 
                badgeConfig.forEach((badge, index) => {
                    const isUnlocked = badge.checkUnlock(currentData, history);
                    const progress = badge.getProgress(currentData, history);

                    const badgeElement = document.createElement('div');
                    badgeElement.className = `badge-item ${isUnlocked ? 'unlocked' : 'locked'} category-${badge.category}`;

                    badgeElement.innerHTML /*XSS-Safe*/ = `
                        <span class="badge-icon">${badge.icon}</span>
                        <div class="badge-category">${badge.categoryName}</div>
                        <div class="badge-name">${badge.name}</div>
                        <div class="badge-description">${badge.description}</div>
                        <div class="badge-progress">${progress}</div>
                    `;

                    // ç‚¹å‡»äº‹ä»¶
                    badgeElement.addEventListener('click', () => {
                        const message = isUnlocked
                            ? `ğŸ† ${badge.name}

${badge.categoryName}
${badge.description}

âœ… å·²è§£é”
${progress}`
                            : `ğŸ”’ ${badge.name}

${badge.categoryName}
${badge.description}

ğŸ“Š ${progress}`;

                        showNotification(message, isUnlocked ? 'success' : 'info');
                    });

                    container.appendChild(badgeElement);
                });

            }

            /**
             * è·å–å½“å‰è¡¨å•æ•°æ®
             */
            function getCurrentData() {
                return {
                    tpi: state.tpi || 0,
                    ami: {
                        reading: safeParseFloat(document.getElementById('ami-reading')?.value) || 0,
                        writing: safeParseFloat(document.getElementById('ami-writing')?.value) || 0,
                        focus: safeParseFloat(document.getElementById('ami-focus')?.value) || 0
                    },
                    fli: state.fli || 0,
                    bcm: state.bcm || 0,
                    hsm: state.hsm || 0,
                    bcmData: {
                        morningToday: document.getElementById('bcm-morning-today')?.value || '',
                        eveningExit: document.getElementById('bcm-evening-exit')?.value || '',
                        digitalGap: safeParseFloat(document.getElementById('bcm-digital-gap')?.value) || 0
                    }
                };
            }

            /**
             * è®¡ç®—ç»Ÿè®¡æ•°æ®
             */
      function calculateStatistics(history) {
                if (history.length === 0) {
                    return { consecutiveDays: 0, maxTPI: 0, avgTPI: 0, weeklyAvgTPI: 0, perfectWeek: false };
                }

                // è®¡ç®—è¿ç»­è¾¾æ ‡å¤©æ•°ï¼ˆTPI >= 95 v13ç¨³å¥çº¿ï¼‰
                let consecutiveDays = 0;
                let currentStreak = 0;

                const sortedHistory = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));

                for (let i = 0; i < sortedHistory.length; i++) {
                    if (sortedHistory[i].tpi >= 95) {
                        currentStreak++;
                        consecutiveDays = Math.max(consecutiveDays, currentStreak);
                    } else {
                        currentStreak = 0;
                    }
                }

                const maxTPI = Math.max(...history.map(item => item.tpi || 0));
                const avgTPI = history.reduce((sum, item) => sum + (item.tpi || 0), 0) / history.length;

                const recentWeek = history.slice(-7);
                const weeklyAvgTPI = recentWeek.length > 0 ?
                    recentWeek.reduce((sum, item) => sum + (item.tpi || 0), 0) / recentWeek.length : 0;

                // æ£€æŸ¥æ˜¯å¦æœ‰å®Œç¾å‘¨ï¼ˆè¿ç»­7å¤© TPI >= 120 v13å“è¶Šçº¿ï¼‰
                let perfectWeek = false;
                if (history.length >= 7) {
                    const recent7Days = history.slice(-7);
                    perfectWeek = recent7Days.every(item => (item.tpi || 0) >= 120);
                }

                return {
                    consecutiveDays,
                    maxTPI,
                    avgTPI: parseFloat(avgTPI.toFixed(1)),
                    weeklyAvgTPI: parseFloat(weeklyAvgTPI.toFixed(1)),
                    perfectWeek
                };
            }

            /**
             * å¯¼å‡ºå›¾è¡¨
             */
            function exportChart(chartId, filename) {
                const canvas = document.getElementById(chartId);
                if (!canvas) {
                    showNotification('âŒ æœªæ‰¾åˆ°å›¾è¡¨', 'error');
                    return;
                }

                const link = document.createElement('a');
                link.download = `${filename}_${formatDate(new Date())}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();

                showNotification('âœ… å›¾è¡¨å·²å¯¼å‡ºä¸ºPNGæ–‡ä»¶', 'success');
            }

            /**
             * åŠ è½½å†å²æ•°æ®
             */
            function loadHistoryData() {
                const dateInput = document.getElementById('history-date');
                if (!dateInput || !dateInput.value) {
                    showNotification('âš ï¸ è¯·é€‰æ‹©æ—¥æœŸ', 'warning');
                    return;
                }

                const key = `tpi_data_${dateInput.value}`;
                const dataStr = /* å·²æ·»åŠ é”™è¯¯å¤„ç† */ localStorage.getItem(key);

                if (!dataStr) {
                    showNotification(`âŒ æœªæ‰¾åˆ° ${dateInput.value} çš„æ•°æ®`, 'error');
                    return;
                }

                try {
                    const data = JSON.parse(dataStr);
                    restoreFormData(data);
                    state.formData = data;

                    // é‡æ–°è®¡ç®—æ‰€æœ‰åˆ†æ•°
                    setTimeout(() => {
                        calculateAllScores();
                    }, 100);

                    showNotification(`âœ… ${dateInput.value} çš„æ•°æ®åŠ è½½æˆåŠŸï¼`, 'success');
                } catch (error) {
                    console.error('åŠ è½½å†å²æ•°æ®é”™è¯¯:', error);
                    showNotification('âŒ åŠ è½½å¤±è´¥ï¼Œæ•°æ®å¯èƒ½å·²æŸåã€‚', 'error');
                }
            }

            // ==================== æŠ¥å‘Šç”ŸæˆåŠŸèƒ½ ====================

            /**
             * ç”Ÿæˆå‘¨æŠ¥
             */
            function generateWeeklyReport() {
                console.log('ğŸ”µ generateWeeklyReport è¢«è°ƒç”¨');
                
                const reportContent = document.getElementById('advancedReportPreview') || document.getElementById('reportContent');
                if (!reportContent) {
                    console.error('âŒ æœªæ‰¾åˆ°æŠ¥å‘Šå®¹å™¨å…ƒç´ ');
                    return;
                }
                
                console.log('âœ… reportContentå…ƒç´ å­˜åœ¨');

                const today = new Date();
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - 7);
                
                console.log('ğŸ“… å‘¨æœŸ:', formatDate(weekStart), '-', formatDate(today));

                // è·å–å‘¨æ•°æ®
                const weekData = getDateRangeData(formatDate(weekStart), formatDate(today));
                console.log('ğŸ“Š æ‰¾åˆ°', weekData.length, 'å¤©çš„æ•°æ®');
                
                const stats = calculateStatistics(weekData);
                console.log('ğŸ“ˆ ç»Ÿè®¡ç»“æœ:', stats);

                const report = {
                    period: `${formatDate(weekStart)} - ${formatDate(today)}`,
                    totalDays: weekData.length,
                    avgTPI: stats.avgTPI,
                    highScore: stats.maxTPI,
                    lowScore: Math.min(...weekData.map(item => item.tpi || 0)),
                    totalWords: weekData.reduce((sum, item) => sum + (item.totalWords || 0), 0),
                    totalPages: weekData.reduce((sum, item) => sum + (item.totalPages || 0), 0),
                 achievements: [
                        weekData.length >= 5 ? 'æœ¬å‘¨å·¥ä½œ5å¤©ä»¥ä¸Š' : 'æœ¬å‘¨å·¥ä½œå¤©æ•°ä¸è¶³',
                        stats.avgTPI >= 120 ? 'å¹³å‡TPIè¾¾åˆ°å“è¶Šæ ‡å‡†' : (stats.avgTPI >= 95 ? 'å¹³å‡TPIç»´æŒç¨³å¥' : 'å¹³å‡TPIéœ€æå‡'),
                        stats.consecutiveDays >= 3 ? `è¿ç»­${stats.consecutiveDays}å¤©è¾¾æ ‡(>95)` : 'è¿ç»­è¾¾æ ‡å¤©æ•°ä¸è¶³'
                    ].filter(a => a),
                    improvements: [
                        stats.avgTPI < 95 ? 'å»ºè®®æé«˜æ—¥å‡TPIè‡³ç¨³å¥çº¿(95)' : null,
                        weekData.length < 5 ? 'å»ºè®®å¢åŠ å·¥ä½œæ—¥' : null
                    ].filter(i => i)
                };
                
                console.log('ğŸ“‹ æŠ¥å‘Šå†…å®¹:', report);

                reportContent.innerHTML /*XSS-Safe*/ = `
                    <div class="report-section">
                        <h4>ğŸ“… æŠ¥å‘Šå‘¨æœŸ: ${report.period}</h4>
                        <div class="grid-2" style="margin-top: var(--spacing-3);">
                            <div class="alert alert-info">
                                <h5>ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡</h5>
                                <p>å¹³å‡TPI: <strong>${report.avgTPI.toFixed(1)}</strong></p>
                                <p>æœ€é«˜åˆ†: <strong>${report.highScore}</strong></p>
                                <p>æœ€ä½åˆ†: <strong>${report.lowScore}</strong></p>
                            </div>
                            <div class="alert alert-success">
                                <h5>ğŸ“ˆ äº§å‡ºç»Ÿè®¡</h5>
                                <p>æ€»å­—æ•°: <strong>${report.totalWords.toLocaleString()}</strong></p>
                                <p>æ€»é¡µæ•°: <strong>${report.totalPages}</strong></p>
                                <p>æ—¥å‡TPI: <strong>${report.avgTPI.toFixed(1)}</strong></p>
                            </div>
                        </div>
                        <div class="grid-2" style="margin-top: var(--spacing-3);">
                            <div class="alert alert-success">
                                <h5>ğŸ† ä¸»è¦æˆå°±</h5>
                                <ul>
                                    ${report.achievements.map(a => `<li>${a}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="alert alert-warning">
                                <h5>ğŸ“ æ”¹è¿›å»ºè®®</h5>
                                <ul>
                                    ${report.improvements.map(i => `<li>${i}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

                console.log('âœ… å‘¨æŠ¥HTMLå·²ç”Ÿæˆå¹¶æ’å…¥DOM');
                showNotification('âœ… å‘¨æŠ¥å·²ç”Ÿæˆ', 'success');
            }

            /**
             * è·å–æ—¥æœŸèŒƒå›´æ•°æ®
             */
            function getDateRangeData(startDate, endDate) {
                const history = getHistoricalData();
                const start = new Date(startDate);
                const end = new Date(endDate);

                return history.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= start && itemDate <= end;
                });
            }

            /**
             * ç”ŸæˆæœˆæŠ¥
             */
            function generateMonthlyReport() {
                console.log('ğŸ”µ generateMonthlyReport è¢«è°ƒç”¨');
                
                const reportContent = document.getElementById('advancedReportPreview') || document.getElementById('reportContent');
                if (!reportContent) {
                    console.error('âŒ æœªæ‰¾åˆ°æŠ¥å‘Šå®¹å™¨å…ƒç´ ');
                    return;
                }
                
                console.log('âœ… reportContentå…ƒç´ å­˜åœ¨');

                const today = new Date();
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                
                console.log('ğŸ“… æœˆä»½:', monthStart.toLocaleDateString('zh-CN', { month: 'long' }));

                // è·å–æœˆæ•°æ®
                const monthData = getDateRangeData(formatDate(monthStart), formatDate(today));
                console.log('ğŸ“Š æ‰¾åˆ°', monthData.length, 'å¤©çš„æ•°æ®');
                
                const stats = calculateStatistics(monthData);
                console.log('ğŸ“ˆ ç»Ÿè®¡ç»“æœ:', stats);

                const report = {
                    period: `${monthStart.toLocaleDateString('zh-CN', { month: 'long' })}`,
                    totalDays: monthData.length,
                    avgTPI: stats.avgTPI,
                    highScore: stats.maxTPI,
                    lowScore: Math.min(...monthData.map(item => item.tpi || 0)),
                    totalWords: monthData.reduce((sum, item) => sum + (item.totalWords || 0), 0),
                    totalPages: monthData.reduce((sum, item) => sum + (item.totalPages || 0), 0),
                   achievements: [
                        monthData.length >= 20 ? 'æœ¬æœˆå·¥ä½œ20å¤©ä»¥ä¸Š' : `æœ¬æœˆå·¥ä½œ${monthData.length}å¤©`,
                        stats.avgTPI >= 120 ? 'å¹³å‡TPIè¾¾åˆ°å“è¶Šæ ‡å‡†' : (stats.avgTPI >= 95 ? 'å¹³å‡TPIç¨³å¥' : 'çŠ¶æ€éœ€è°ƒæ•´'),
                        stats.maxTPI >= 156 ? 'åˆ›é€ æœˆåº¦å“è¶Šé«˜åˆ†(>156)' : null,
                        stats.consecutiveDays >= 7 ? `æœ€é•¿è¿ç»­è¾¾æ ‡${stats.consecutiveDays}å¤©` : null
                    ].filter(a => a),
                    trends: [
                        stats.avgTPI >= 95 ? 'æ•´ä½“è¡¨ç°ç¨³å¥' : 'æ•´ä½“è¡¨ç°éœ€ä¿®å¤',
                        monthData.length >= 20 ? 'å·¥ä½œå¤©æ•°å……è¶³' : 'å·¥ä½œå¤©æ•°ä¸è¶³',
                        stats.weeklyAvgTPI >= 120 ? 'å‘¨å‡è¡¨ç°ä¼˜å¼‚' : 'å‘¨å‡è¡¨ç°å¹³ç¨³'
                    ].filter(t => t)
                };

                reportContent.innerHTML /*XSS-Safe*/ = `
                    <div class="report-section">
                        <h4>ğŸ“… æœˆåº¦æŠ¥å‘Š: ${report.period}</h4>
                        <div class="grid-3" style="margin-top: var(--spacing-3);">
                            <div class="alert alert-info">
                                <h5>ğŸ“Š ç»©æ•ˆæŒ‡æ ‡</h5>
                                <p>å¹³å‡TPI: <strong>${report.avgTPI.toFixed(1)}</strong></p>
                                <p>æœ€é«˜åˆ†: <strong>${report.highScore}</strong></p>
                                <p>æœ€ä½åˆ†: <strong>${report.lowScore}</strong></p>
                            </div>
                            <div class="alert alert-success">
                                <h5>ğŸ“ˆ äº§å‡ºæ€»é‡</h5>
                                <p>æ€»å­—æ•°: <strong>${report.totalWords.toLocaleString()}</strong></p>
                                <p>æ€»é¡µæ•°: <strong>${report.totalPages}</strong></p>
                                <p>æ—¥å‡å­—æ•°: <strong>${Math.round(report.totalWords/report.totalDays).toLocaleString()}</strong></p>
                            </div>
                            <div class="alert alert-warning">
                                <h5>ğŸ“… æ´»è·ƒå¤©æ•°</h5>
                                <p>è®°å½•å¤©æ•°: <strong>${report.totalDays}</strong></p>
                                <p>è¾¾æ ‡ç‡: <strong>${Math.round((monthData.filter(item => item.tpi >= 80).length / report.totalDays) * 100)}%</strong></p>
                                <p>é«˜æ•ˆæ—¥: <strong>${monthData.filter(item => item.tpi >= 100).length}</strong></p>
                            </div>
                        </div>
                        <div class="grid-2" style="margin-top: var(--spacing-3);">
                            <div class="alert alert-success">
                                <h5>ğŸ† æœˆåº¦æˆå°±</h5>
                                <ul>
                                    ${report.achievements.map(a => `<li>${a}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="alert alert-info">
                                <h5>ğŸ“ˆ è¶‹åŠ¿åˆ†æ</h5>
                                <ul>
                                    ${report.trends.map(t => `<li>${t}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

                console.log('âœ… æœˆæŠ¥HTMLå·²ç”Ÿæˆå¹¶æ’å…¥DOM');
                showNotification('âœ… æœˆæŠ¥å·²ç”Ÿæˆ', 'success');
            }

            /**
             * å¯¼å‡ºæŠ¥å‘Š
             */
            function exportReport(format) {
                try {
                    if (format === 'pdf') {
                        // å¯¼å‡ºPDF
                        const reportContent = document.getElementById('advancedReportPreview') || document.getElementById('reportContent');
                        if (!reportContent || !reportContent.innerHTML.trim()) {
                            showNotification('âš ï¸ è¯·å…ˆç”ŸæˆæŠ¥å‘Šå†…å®¹', 'warning');
                            return;
                        }

                        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
                        if (typeof html2canvas === 'undefined') {
                            showNotification('âŒ PDFå¯¼å‡ºåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                            return;
                        }

                        showNotification('ğŸ“„ æ­£åœ¨ç”ŸæˆPDF...', 'info');

                        // ä½¿ç”¨html2canvasè½¬æ¢ä¸ºå›¾ç‰‡
                        html2canvas(reportContent, {
                            scale: 2,
                            useCORS: true,
                            logging: false
                        }).then(canvas => {
                            const imgData = canvas.toDataURL('image/png');

                            // æ£€æŸ¥jsPDF
                            const { jsPDF } = window.jspdf || {};
                            if (!jsPDF) {
                                showNotification('âŒ jsPDFæœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                                return;
                            }

                            const pdf = new jsPDF('p', 'mm', 'a4');
                            const imgWidth = 190;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;

                            pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                            pdf.save(`TPIæŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.pdf`);

                            showNotification('âœ… PDFå¯¼å‡ºæˆåŠŸï¼', 'success');
                        }).catch(error => {
                            console.error('PDFç”Ÿæˆå¤±è´¥:', error);
                            showNotification('âŒ PDFç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
                        });

                    } else if (format === 'excel') {
                        exportData('excel');
                    }
                } catch (error) {
                    console.error('å¯¼å‡ºæŠ¥å‘Šé”™è¯¯:', error);
                    showNotification('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
                }
            }

            // ==================== AMI è®¡ç®— ====================

            /**
             * è®¡ç®—ç‚¹ç«ç¨‹åºåˆ†æ•°
             */
            function calculateIgnitionBonus() {
                let total = 0;

                // æ— ç—›å¯åŠ¨
                if (document.getElementById('ignition-painless-start')?.checked) {
                    total += 2;
                }

                // æ¿å—å¯åŠ¨
                if (document.getElementById('start-morning-block')?.checked) total += 2;
                if (document.getElementById('start-afternoon-block')?.checked) total += 2;
                if (document.getElementById('start-evening-block')?.checked) total += 2;

                // å­¦æœ¯å¯¹è¯
                if (document.getElementById('academic-dialogue')?.checked) total += 2;

                const ignitionTotal = document.getElementById('ignition-total');
                if (ignitionTotal) ignitionTotal.textContent = total.toFixed(0);

                return total;
            }

            /**
             * è®¡ç®—AMIæ€»åˆ†
             */

          // [FIX v14 Final] Typeå˜æ›´å¤„ç† - äº’æ–¥é€»è¾‘
            function handleTypeChange(row) {
                const typeSelect = document.querySelector(`.ami-type[data-row="${row}"]`);
                const pageInput = document.querySelector(`.ami-page[data-row="${row}"]`);
                const wordsInput = document.querySelector(`.ami-words[data-row="${row}"]`);

                if (typeSelect && typeSelect.value) {
                    // å¡«å†™Typeå,æ¸…ç©ºPageå’ŒWords
                    if (pageInput) {
                        pageInput.value = '';
                        pageInput.disabled = true;
                    }
                    if (wordsInput) {
                        wordsInput.value = '';
                        wordsInput.disabled = true;
                    }
                } else {
                    if (pageInput) pageInput.disabled = false;
                    if (wordsInput) wordsInput.disabled = false;
                }

                calculateAMI();
            }

            // [FIX v14 Final] è¿è§„å¤„ç†
            function handleViolation(row) {
                const violationCheck = document.querySelector(`.ami-violation[data-row="${row}"]`);
                const fSelect = document.querySelector(`.ami-f[data-row="${row}"]`);
                const rowInputs = document.querySelectorAll(`[data-row="${row}"]`);

                if (!violationCheck || !fSelect) return;

                if (violationCheck.checked) {
                    // å‹¾é€‰è¿è§„: F=0.7ä¸”ç¦ç”¨è¯¥è¡Œ
                    if (!Array.from(fSelect.options).some(opt => opt.value === '0.7')) {
                        const option = document.createElement('option');
                        option.value = '0.7';
                        option.text = '0.7';
                        fSelect.appendChild(option);
                    }
                    fSelect.value = '0.7';
                    rowInputs.forEach(input => {
                        if (input !== violationCheck && input.tagName !== 'SPAN') {
                            input.disabled = true;
                        }
                    });
                } else {
                    // å–æ¶ˆè¿è§„: æ¢å¤
                    fSelect.value = '1.0';
                    // ç§»é™¤0.7é€‰é¡¹
                    const option07 = Array.from(fSelect.options).find(opt => opt.value === '0.7');
                    if (option07) fSelect.removeChild(option07);

                    rowInputs.forEach(input => {
                        if (input.tagName !== 'SPAN') {
                            input.disabled = false;
                        }
                    });

                    // æ£€æŸ¥Typeæ˜¯å¦æœ‰å€¼,å¦‚æœæœ‰åˆ™ç»§ç»­ç¦ç”¨Page/Words
                    const typeSelect = document.querySelector(`.ami-type[data-row="${row}"]`);
                    if (typeSelect && typeSelect.value) {
                        const pageInput = document.querySelector(`.ami-page[data-row="${row}"]`);
                        const wordsInput = document.querySelector(`.ami-words[data-row="${row}"]`);
                        if (pageInput) pageInput.disabled = true;
                        if (wordsInput) wordsInput.disabled = true;
                    }
                }

                calculateAMI();
            }

function calculateAMI() {
                let baseScore = 0;
                let outputScore = 0;
                let outputScoreTypeD = 0;  // å•ç‹¬è¿½è¸ªType Dçš„äº§å‡ºåˆ†

                // è·å–æ‰€æœ‰ç›¸å…³æ§ä»¶
                const rows = document.querySelectorAll('#ami-table tbody tr:not(.summary-row):not(.constant-task-row)');

                let totalHours = 0;
                let totalPages = 0;
                let totalWords = 0;
                let typeDCount = 0; // ç”¨äºBonusè‡ªåŠ¨åˆ¤å®š
                let flowCount = 0;  // F=1.3 è®¡æ•°

                rows.forEach((row, index) => {
                    // 1. åŸºç¡€æ•°æ®è·å–
                    const hoursInput = row.querySelector('input[aria-label*="æ—¶é•¿"]');
                    let hours = safeParseFloat(hoursInput?.value);
                    const status = row.querySelector('.status-select')?.value;

                    // å·®å¼‚45ä¿®å¤ï¼šæ‰£é™¤ä¸­æ–­æ—¶é—´
                    const interruptionInput = row.querySelector('.interruption-input');
                    if (interruptionInput) {
                        const interruptionMinutes = safeParseFloat(interruptionInput.value);
                        if (interruptionMinutes >= 15) {
                            const interruptionHours = interruptionMinutes / 60;
                            hours = Math.max(0, hours - interruptionHours);
                        }
                    }

                    // åŸºç¡€ä¿éšœåˆ†ï¼šåªè¦æœ‰æ—¶é•¿ä¸”ä¸æ˜¯æœªå®Œæˆï¼Œç»™åŸºç¡€åˆ†
                    const rowBaseScore = (hours > 0 && status !== '0') ? (hours * CONSTANTS.AMI_BASE_RATE) : 0;
                    baseScore += rowBaseScore;
                    if(hours > 0) totalHours += hours;

                    // 2. ä¸“æ³¨ç³»æ•°
                    const focusSelect = row.querySelector('select[aria-label*="ä¸“æ³¨ç³»æ•°"]');
                    let focus = safeParseFloat(focusSelect?.value) || 1.0;

                    // å·®å¼‚12ä¿®å¤ï¼šType Aå¤„ç†æ—¶é•¿<2minæ—¶ï¼Œå¼ºåˆ¶F=1.0
                    const typeAInput = row.querySelector('.writing-output-vertical-input'); // ç¬¬ä¸€ä¸ªæ˜¯Type A
                    const typeAWords = safeParseFloat(typeAInput?.value);
                    if (typeAWords > 0 && hours > 0) {
                        const avgTimePerTask = (hours * 60) / (typeAWords / 100); // æ¯100å­—çš„åˆ†é’Ÿæ•°
                        if (avgTimePerTask < 2) {
                            // Type Aå•æ¬¡å¤„ç†<2minï¼Œå¼ºåˆ¶F=1.0ï¼ˆä¸å…è®¸å¿ƒæµï¼‰
                            if (focus > 1.0) {
                                console.warn(`[å·®å¼‚12] Type Aå¤„ç†è¿‡å¿«(${avgTimePerTask.toFixed(1)}min/100å­—<2min)ï¼ŒFç³»æ•°ä»${focus}å¼ºåˆ¶å½’1.0`);
                                focus = 1.0;
                                if (focusSelect) focusSelect.value = '1.0';
                            }
                        }
                    }

                    if (focus === 1.3 && hours >= 1) flowCount++;

                  // 3. é˜…è¯»äº§å‡º
                    const pageInput = row.querySelector('input[aria-label*="é˜…è¯»é¡µæ•°"]');
                    // å·®å¼‚7,28ä¿®å¤ï¼šé˜…è¯»å•ä»·åº”ä¸º Level I(0.7) / Level II(1.0) / Level III(1.8)
                    // å¦‚æœæœ‰é˜…è¯»ç­‰çº§é€‰æ‹©å™¨ï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™é»˜è®¤Level II(1.0)
                    const readLevelSelect = row.querySelector('select[aria-label*="é˜…è¯»ç­‰çº§"]');
                    const pages = safeParseFloat(pageInput?.value);
                    let readPrice = CONSTANTS.READ_PRICE_LEVEL_II; // é»˜è®¤Level II: 1.0

                    if (readLevelSelect && readLevelSelect.value) {
                        const levelValue = readLevelSelect.value;
                        if (levelValue === '1' || levelValue.includes('I')) {
                            readPrice = CONSTANTS.READ_PRICE_LEVEL_I; // 0.7
                        } else if (levelValue === '2' || levelValue.includes('II')) {
                            readPrice = CONSTANTS.READ_PRICE_LEVEL_II; // 1.0
                        } else if (levelValue === '3' || levelValue.includes('III')) {
                            readPrice = CONSTANTS.READ_PRICE_LEVEL_III; // 1.8
                        }
                    }

                    // å·®å¼‚13ä¿®å¤ï¼šå–æ•´è§„åˆ™ï¼ˆå·®å€¼3ä»¥å†…æŒ‰æ•´æ•°è®¡ï¼‰
                    let finalPages = pages;
                    const remainder = pages - Math.floor(pages);
                    if (remainder > 0 && remainder <= 0.03) {
                        finalPages = Math.ceil(pages);
                    }

                    const rowReadScore = finalPages * readPrice * focus;
                    totalPages += finalPages;

                    // 4. å†™ä½œäº§å‡º
                    let rowWriteScore = 0;
                    const writeInputs = row.querySelectorAll('.writing-output-vertical-input');

                    // ç¬¬22ç‰ˆå†™ä½œå•ä»· (ä¸¥æ ¼åŒæ­¥MDæ ‡å‡†):
        // Type A(0.7) - æ•´ç† / Type B(1.0) - å»ºæ„ / Type C(1.8) - æ­£å¼ / Type D(3.0) - æ”»åš
        // æ³¨æ„ï¼šæ­¤å¤„ç›´æ¥ä½¿ç”¨æ•°å€¼è¦†ç›–æ—§å¸¸é‡ï¼Œç¡®ä¿é€»è¾‘ç»å¯¹æ­£ç¡®
        const typePrices = [
            0.7, // Type A: æ•´ç†ä¸ç§©åºé‡å»º (Tier 1)
            1.0, // Type B: æ‰¹åˆ¤æ€§å»ºæ„ (Tier 2)
            1.8  // Type C: æ­£å¼å†™ä½œ (Tier 3)
        ];

                    // Type A/B/C: å­—æ•° / 100 * å¯¹åº”å•ä»· * F
                    [0, 1, 2].forEach(idx => {
                        let w = safeParseFloat(writeInputs[idx]?.value);
                        // å·®å¼‚13ä¿®å¤ï¼š97å­—æ»¡ç™¾è¿›ä½
                        if (w % 100 >= 97) w = Math.ceil(w/100)*100;
                        totalWords += w;
                        rowWriteScore += (w / 100) * typePrices[idx] * focus;
                    });

                  // Type D: æ ¸å¿ƒæ”»åš - å·®å¼‚9,51,75ä¿®å¤
                    // å·®å¼‚9: Type Då½“é‡å®šä¹‰ä¸º400å­—/å°æ—¶
                    // å·®å¼‚51: Type Då•ä»·ä¸º2.8ï¼ˆä¸æ˜¯3.0ï¼‰
                    // å·®å¼‚75: <12è§†ä¸ºå°æ—¶è‡ªåŠ¨Ã—400
                    let typeDRaw = safeParseFloat(writeInputs[3]?.value);
                    let typeDVal = 0;
                    let typeDScore = 0;  // Type Då•ç‹¬è®¡åˆ†

                    if (typeDRaw > 0) {
                        // ğŸ§  æ™ºèƒ½é€»è¾‘ï¼š
                        // è‹¥è¾“å…¥å€¼ < 12ï¼Œè§†ä¸º"å°æ—¶æ•°"ï¼Œè‡ªåŠ¨æŒ‰ K=400 æ¢ç®—ä¸ºå½“é‡å­—æ•°
                        // è‹¥è¾“å…¥å€¼ >= 12ï¼Œè§†ä¸º"å­—æ•°/å½“é‡"ï¼Œç›´æ¥ä½¿ç”¨
                        if (typeDRaw < 12) {
                            typeDVal = typeDRaw * CONSTANTS.TYPE_D_EQUIVALENT; // 400
                        } else {
                            typeDVal = typeDRaw;
                        }

// å·®å¼‚13ä¿®å¤ï¼šå–æ•´é€»è¾‘ (97å­—æ»¡ç™¾è¿›ä½)
            if (typeDVal % 100 >= 97) typeDVal = Math.ceil(typeDVal/100)*100;
            totalWords += typeDVal;
          // åŒæ­¥ç¬¬22ç‰ˆï¼šType D å•ä»·è°ƒæ•´ä¸º 2.8
                    typeDScore = (typeDVal / 100) * 2.8 * focus;
            rowWriteScore += typeDScore;
            outputScoreTypeD += typeDScore; // å•ç‹¬ç´¯åŠ Type Då¾—åˆ†
                        typeDCount++;

                        // å·®å¼‚52ä¿®å¤ï¼šType Dæƒé‡çº§å·®æ ‡è¯†
                        const typeDGap = CONSTANTS.WRITE_PRICE_TYPE_D - CONSTANTS.WRITE_PRICE_TYPE_C; // 0.6

                        // å¦‚æœType Däº§å‡ºè¾ƒå¤šï¼Œç»™äºˆé«˜çº§è®¤å¯
                        if (typeDVal > 1000) {
                        }
                    }

                   // Type S: æ€ç»´ç»“æ™¶åˆ¶ - ç¬¬22ç‰ˆï¼šå½’å± Tier 3 (å•ä»· 1.8)
        let typeSVal = safeParseFloat(writeInputs[4]?.value);
        if (typeSVal > 0) {
            const typeSPrice = 1.8; // æ ‡å‡†å•ä»·
            rowWriteScore += (typeSVal / 100) * typeSPrice * focus;
            totalWords += typeSVal;
        }
            // 5. ç°åœº L - ç¬¬22ç‰ˆï¼šå¸¸æ€(2.0/h) / è¾“å‡ºå‹(3.0/h)
            const onsiteTypeSelect = row.querySelector('select[aria-label*="ç°åœºç±»å‹"]');
            const typeLHours = safeParseFloat(writeInputs[5]?.value);
            if (typeLHours > 0) {
                let onsitePrice = 2.0; // é»˜è®¤å¸¸æ€å•ä»·
                if (onsiteTypeSelect && onsiteTypeSelect.value) {
                    const onsiteType = onsiteTypeSelect.value;
                    if (onsiteType.includes('è¾“å‡º') || onsiteType.includes('ç»åœ°')) onsitePrice = 3.0;
                }
                rowWriteScore += typeLHours * onsitePrice * focus;
            }

                    const rowTotalScore = rowBaseScore + rowReadScore + rowWriteScore;

                    // å¡«å…¥å•è¡Œå¾—åˆ†
                    const scoreInput = row.querySelector('input[readonly][aria-label*="å¾—åˆ†"]');
                    if (scoreInput) scoreInput.value = rowTotalScore.toFixed(1);

                    outputScore += (rowReadScore + rowWriteScore);
                });

                // ç¬¬22ç‰ˆå°é¡¶è§„åˆ™ï¼šType CåŠä»¥ä¸‹ä»»åŠ¡å°é¡¶100åˆ†ï¼ŒType Dä»»åŠ¡å°é¡¶150åˆ†
                const outputScoreOther = outputScore - outputScoreTypeD;  // Type CåŠä»¥ä¸‹çš„äº§å‡ºåˆ†
                let cappedOutputOther = outputScoreOther;
                let cappedOutputTypeD = outputScoreTypeD;

                if (outputScoreOther > 100) {
                    cappedOutputOther = 100;
                }

                if (outputScoreTypeD > 150) {
                    cappedOutputTypeD = 150;
                }

                const cappedOutputScore = cappedOutputOther + cappedOutputTypeD;

                if (cappedOutputScore < outputScore) {
                }

                const ignitionBonus = calculateIgnitionBonus();
                const scanBonus = document.getElementById('ami-scan-reading')?.checked ? 1 : 0;

                const amiTotal = baseScore + cappedOutputScore + ignitionBonus + scanBonus;

                const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
                setVal('total-hours', totalHours.toFixed(1));
                setVal('total-pages', totalPages.toFixed(0));
                setVal('total-words', totalWords.toFixed(0));
                setVal('ami-total-score', amiTotal.toFixed(1));

                const amiScoreInput = document.getElementById('ami-score');
                if (amiScoreInput) amiScoreInput.value = amiTotal.toFixed(1);

                state.ami = amiTotal;
                state.typeDCount = typeDCount;
                state.flowCount = flowCount;

                // å·®å¼‚65ä¿®å¤ï¼šä»»åŠ¡é‡å æ£€æµ‹
                detectTimeOverlaps();

                checkAutoBonuses();

                return amiTotal;
            }

            /**
             * å·®å¼‚65ä¿®å¤ï¼šä»»åŠ¡é‡å æ£€æµ‹
             */
            function detectTimeOverlaps() {
                const timeRanges = [];
                const rows = document.querySelectorAll('#ami-table tbody tr:not(.summary-row)');

                rows.forEach((row, index) => {
                    const startInput = row.querySelector('input[aria-label*="å¼€å§‹"]');
                    const endInput = row.querySelector('input[aria-label*="ç»“æŸ"]');

                    if (startInput && endInput && startInput.value && endInput.value) {
                        const start = startInput.value; // "HH:MM"
                        const end = endInput.value;

                        timeRanges.push({
                            index: index + 1,
                            start: timeToMinutes(start),
                            end: timeToMinutes(end),
                            startStr: start,
                            endStr: end
                        });
                    }
                });

                // æ£€æµ‹é‡å 
                let hasOverlap = false;
                for (let i = 0; i < timeRanges.length; i++) {
                    for (let j = i + 1; j < timeRanges.length; j++) {
                        const a = timeRanges[i];
                        const b = timeRanges[j];

                        // æ£€æµ‹é‡å ï¼šaçš„ç»“æŸæ—¶é—´åœ¨bçš„å¼€å§‹ä¹‹åï¼Œä¸”açš„å¼€å§‹åœ¨bçš„ç»“æŸä¹‹å‰
                        if (a.end > b.start && a.start < b.end) {
                            hasOverlap = true;
                            const overlapMinutes = Math.min(a.end, b.end) - Math.max(a.start, b.start);
                            console.error(`[å·®å¼‚65] âš ï¸ ä»»åŠ¡é‡å æ£€æµ‹: æ—¶æ®µ${a.index}(${a.startStr}-${a.endStr}) ä¸ æ—¶æ®µ${b.index}(${b.startStr}-${b.endStr}) é‡å ${overlapMinutes}åˆ†é’Ÿ`);

                            // æ˜¾ç¤ºè­¦å‘Š
                            if (typeof NotifySystem !== 'undefined' && NotifySystem.showToast) {
                                NotifySystem.showToast(
                                    `âš ï¸ æ—¶æ®µ${a.index}ä¸æ—¶æ®µ${b.index}å­˜åœ¨${overlapMinutes}åˆ†é’Ÿé‡å ï¼Œè¯·æ£€æŸ¥æ—¶é—´è®°å½•`,
                                    'warning',
                                    'ä»»åŠ¡é‡å è­¦å‘Š',
                                    5000
                                );
                            }
                        }
                    }
                }

                return hasOverlap;
            }

            // è¾…åŠ©å‡½æ•°ï¼šæ—¶é—´è½¬åˆ†é’Ÿ
            function timeToMinutes(timeStr) {
                if (!timeStr || typeof timeStr !== 'string') return 0;
                const parts = timeStr.split(':');
                if (parts.length !== 2) return 0;
                const h = parseInt(parts[0]) || 0;
                const m = parseInt(parts[1]) || 0;
                return h * 60 + m;
            }

            /**
             * è‡ªåŠ¨åŒ–Bonusæ£€æŸ¥å™¨ (æ–°å¢ï¼šè¿èƒœæ£€æµ‹)
             */
            function checkAutoBonuses() {
        // [æ–°å¢] 0. å¾®å°èƒœåˆ©è‡ªåŠ¨æ£€æµ‹ (å¡«æ»¡3é¡¹è‡ªåŠ¨è·å¾—+1åˆ†)
        const mv1 = document.getElementById('micro-victory-1')?.value.trim();
        const mv2 = document.getElementById('micro-victory-2')?.value.trim();
        const mv3 = document.getElementById('micro-victory-3')?.value.trim();
        if (mv1 && mv2 && mv3) {
            checkBonusBox('micro-victories');
        } else {
            uncheckBonusBox('micro-victories');
        }

        // 1. æ”»åšå‹‡å£« / è¶…çº§å¿ƒæµ / å®Œç¾ä½œæ¯
        if (state.typeDCount >= 3) checkBonusBox('warrior');
        else uncheckBonusBox('warrior');
                if (state.flowCount >= 3) checkBonusBox('flow'); else uncheckBonusBox('flow');

                const morningScore = safeParseFloat(document.getElementById('bcm-morning-score')?.value);
                const sleepScore = safeParseFloat(document.getElementById('bcm-sleep-score')?.value);
                const lunchStat = document.getElementById('bcm-lunch-status')?.textContent || '';
                const dinnerStat = document.getElementById('bcm-dinner-status')?.textContent || '';

                if ((morningScore >= 3.5) && (sleepScore >= 3) && (lunchStat.includes('åšå®ˆ')) && (dinnerStat.includes('åšå®ˆ'))) {
                    checkBonusBox('balance');
                } else {
                    uncheckBonusBox('balance');
                }

                // 2. å“è¶Šè¡¨ç°
                if (state.tpi >= 160) checkBonusBox('excellent');

                // 3. è¿ç»­ç¨³å®šå¥– (è‡ªåŠ¨è¯»å–ç»Ÿè®¡æ•°æ®)
                if (state.dataStats && state.dataStats.consecutiveDays) {
                    const days = state.dataStats.consecutiveDays;
                    if (days >= 21) checkBonusBox('streak21');
                    else if (days >= 14) checkBonusBox('streak14');
                    else if (days >= 7) checkBonusBox('streak7');
                }
            }

            function checkBonusBox(val) {
                const el = document.querySelector(`input[name="bonus-item"][value="${val}"]`);
                if (el && !el.checked) { el.checked = true; calculateBonus(); }
            }
            function uncheckBonusBox(val) {
                const el = document.querySelector(`input[name="bonus-item"][value="${val}"]`);
                if (el && el.checked) { el.checked = false; calculateBonus(); }
            }

            /**
             * è®¡ç®—FLIæ€»åˆ† (ä¿®å¤ï¼šå¤è‹æ¨¡å¼é€»è¾‘)
             */
            function calculateFLI() {
                const coreStatus = safeParseFloat(document.querySelector('#fli select[aria-label="æ ¸å¿ƒå­¦ä¹ çŠ¶æ€"]')?.value || 0);
                const coreScore = coreStatus * 10;
                const fliCoreScoreElem = document.getElementById('fli-core-score');
                if (fliCoreScoreElem) fliCoreScoreElem.value = coreScore.toFixed(1);

                const fragmentBoxes = document.querySelectorAll('.fli-fragment');
                let fragmentCount = 0;
                fragmentBoxes.forEach(box => { if (box.checked) fragmentCount++; });

                // ğŸ”§ ä¿®å¤2: å¤è‹æ¨¡å¼ä¸‹FLIå¤–è¯­è¾¾æ ‡çº¿é™è‡³1ä¸ª
                const selectedMode = state.selectedMode || document.querySelector('input[name="daily-mode"]:checked')?.value || 'normal';
                let fragmentThreshold = 2; // æ­£å¸¸æ¨¡å¼éœ€è¦2ä¸ª

                if (selectedMode === 'recovery') {
                    fragmentThreshold = 1; // ğŸ›¡ï¸ å¤è‹æ¨¡å¼é™è‡³1ä¸ª
                }

                // ä¿®å¤ï¼šç›´æ¥æŒ‰ä¸ªè®¡åˆ†ï¼Œä¸è®¾æ‰£åˆ†é˜ˆå€¼ (é€»è¾‘æ›´ç›´è§‚)
                // ä½†éœ€è¦åˆ¤æ–­æ˜¯å¦è¾¾æ ‡
                let fragmentScore = 0;
                if (fragmentCount >= fragmentThreshold) {
                    fragmentScore = 10; // è¾¾æ ‡ç»™æ»¡åˆ†
                } else {
                    fragmentScore = fragmentCount * 0.5; // æœªè¾¾æ ‡æŒ‰ä¸ªæ•°ç»™åˆ†
                }

                const fragmentScoreElem = document.getElementById('fli-fragment-score');
                if (fragmentScoreElem) fragmentScoreElem.value = fragmentScore.toFixed(1);

                const fliTotal = coreScore + fragmentScore;
                const fliTotalScoreElem = document.getElementById('fli-total-score');
                const fliScoreElem = document.getElementById('fli-score');

                if (fliTotalScoreElem) fliTotalScoreElem.textContent = fliTotal.toFixed(1);
                if (fliScoreElem) fliScoreElem.value = fliTotal.toFixed(1);

                state.fli = fliTotal;
                return fliTotal;
            }
            // ==================== BCM è®¡ç®— ====================

            /**
             * è®¡ç®—æ™¨é—´å…¥é¦†å¾—åˆ† (ç¬¬22ç‰ˆæ ‡å‡†)
             */
            /**
             * è®¡ç®—æ™¨é—´å…¥é¦†å¾—åˆ† (ç¬¬22ç‰ˆæ ‡å‡†)
             */
            function calculateMorningScore() {
                const input = document.getElementById('bcm-morning-time');
                const yesterdayInput = document.getElementById('bcm-morning-yesterday-time');
                const scoreDisplay = document.getElementById('bcm-morning-score');
                const refTodayDisplay = document.getElementById('bcm-morning-ref-today');
                const refYesterdayDisplay = document.getElementById('bcm-morning-ref-yesterday');

                if (!input || !input.value) {
                    if (scoreDisplay) scoreDisplay.value = '0';
                    return 0;
                }

                const timeStr = input.value; // æ ¼å¼: "HH:MM"
                let score = 0;

                // ä¼˜å…ˆè¯»å–æ‰‹åŠ¨è¾“å…¥çš„æ˜¨æ—¥æ—¶é—´,å¦‚æœä¸ºç©ºåˆ™ä»å†å²æ•°æ®åŠ è½½
                let yesterdayTime = yesterdayInput?.value || null;

                if (!yesterdayTime || yesterdayTime === '') {
                    const yesterday = historicalDataManager.getYesterday();
                    yesterdayTime = yesterday?.morning_time || null;

                    // å¦‚æœä»å†å²åŠ è½½åˆ°äº†æ˜¨æ—¥æ—¶é—´,è‡ªåŠ¨å¡«å……åˆ°è¾“å…¥æ¡†
                    if (yesterdayTime && yesterdayInput) {
                        yesterdayInput.value = yesterdayTime;
                    }
                }

                // æ›´æ–°å‚è€ƒæ˜¾ç¤º
                if (refTodayDisplay) refTodayDisplay.textContent = timeStr;
                if (refYesterdayDisplay) refYesterdayDisplay.textContent = yesterdayTime || '--:--';

                // ç¬¬22ç‰ˆæ™¨é—´å…¥é¦†è¯„åˆ†æ ‡å‡†(å«15åˆ†é’Ÿç¼“å†²)
                // ğŸ‘‘ ä¼ å¥‡ (< 08:45): +5åˆ†
                if (timeStr < '08:45') {
                    score = 5;
                }
                // ğŸ¥‡ æ”€ç™»/ğŸ¥ˆ æ»å (08:45-09:15)
                else if (timeStr >= '08:45' && timeStr < '09:15') {
                    // éœ€è¦æ¯”è¾ƒæ˜¨æ—¥æ—¶é—´
                    if (yesterdayTime && yesterdayTime !== '--:--') {
                        const todayMinutes = timeToMinutes(timeStr);
                        const yesterdayMinutes = timeToMinutes(yesterdayTime);

                        if (todayMinutes < yesterdayMinutes) {
                            // æ¯”æ˜¨æ—¥æ—© â†’ æ”€ç™» +3.5åˆ†
                            score = 3.5;
                        } else {
                            // æ¯”æ˜¨æ—¥æ™šæˆ–ç›¸åŒ â†’ æ»å +2.5åˆ†
                            score = 2.5;
                        }
                    } else {
                        // æ— æ˜¨æ—¥æ•°æ®,é»˜è®¤ç»™2.5åˆ†
                        score = 2.5;
                    }
                }
                // ğŸ¢ ç¼“å†² (09:15-09:45)
                else if (timeStr >= '09:15' && timeStr <= '09:45') {
                    score = 1.0;
                }
                // â­• å¤±æ•ˆ (> 09:45)
                else {
                    score = 0;
                }

                if (scoreDisplay) scoreDisplay.value = score.toFixed(1);

                return score;
            }

            /**
             * è®¡ç®—æ™šé—´ç¦»é¦†å¾—åˆ† (ç¬¬22ç‰ˆæ ‡å‡† - åŒé”šç‚¹ç³»ç»Ÿ)
             */
            function calculateEveningScore() {
                const eveningExitInput = document.getElementById('bcm-evening-exit');
                const eveningScoreElem = document.getElementById('bcm-evening-score');

                if (!eveningExitInput || !eveningExitInput.value) {
                    if (eveningScoreElem) eveningScoreElem.value = '0';
                    return 0;
                }

                const timeStr = eveningExitInput.value;
                const minutes = timeToMinutes(timeStr);
                let score = 0;

                // ç¬¬22ç‰ˆæ™šé—´ç¦»é¦†è¯„åˆ†é˜¶æ¢¯
                // ğŸ‘‘ ä¼ å¥‡ (< 23:15): +3åˆ†
                if (minutes < 23 * 60 + 15) {
                    score = 3;
                }
                // ğŸ¥ˆ ç¨³å¥ (23:15-23:45): +2åˆ†
                else if (minutes >= 23 * 60 + 15 && minutes < 23 * 60 + 45) {
                    score = 2;
                }
                // ğŸ¥‰ å¼¹æ€§ (23:45-00:15): +1åˆ†
                else if (minutes >= 23 * 60 + 45 && minutes < 24 * 60 + 15) {
                    score = 1;
                }
                // â­• è¿‡æ™š (> 00:15): 0åˆ†
                else {
                    score = 0;
                }

                if (eveningScoreElem) eveningScoreElem.value = score.toFixed(1);

                return score;
            }

            /**
             * è®¡ç®—ç¡çœ å¾—åˆ† (ç¬¬22ç‰ˆæ ‡å‡†)
             * é˜¶æ¢¯åŸºç¡€åˆ† + åŠ¨æ€å¥–æƒ©æœºåˆ¶
             */
            function calculateSleepScore() {
                const sleepTimeInput = document.getElementById('bcm-sleep-time');
                const refTodayInput = document.getElementById('bcm-sleep-ref-today');
                const refYesterdayInput = document.getElementById('bcm-sleep-ref-yesterday');
                const sleepScoreElem = document.getElementById('bcm-sleep-score');

                if (!sleepTimeInput || !sleepTimeInput.value) {
                    if (sleepScoreElem) sleepScoreElem.value = '0';
                    return 0;
                }

                const timeStr = sleepTimeInput.value;
                let baseScore = 0;

                // æ›´æ–°å‚è€ƒæ˜¾ç¤º
                if (refTodayInput) refTodayInput.textContent = timeStr;

                // è·å–æ˜¨æ—¥ç¡çœ æ—¶é—´
                const yesterday = historicalDataManager.getYesterday();
                const yesterdayTime = yesterday?.sleep_time || null;
                if (refYesterdayInput) refYesterdayInput.textContent = yesterdayTime || '--:--';

                // åŒæ—¶æ›´æ–°æ˜¨æ—¥å‚è€ƒæ ä½çš„æ˜¾ç¤º
                const yesterdayDisplay = document.getElementById('bcm-sleep-yesterday-display');
                if (yesterdayDisplay) yesterdayDisplay.textContent = yesterdayTime || '--:--';

                // é˜¶æ¢¯åŸºç¡€åˆ† (ç¬¬22ç‰ˆ)
                // ğŸ‘‘ å®Œç¾ (< 00:00): +5åˆ†
                const minutes = timeToMinutes(timeStr);

                if (minutes < 0 || minutes >= 22 * 60) {
                    // <00:00 (åŒ…æ‹¬å‰ä¸€å¤©23:00åå…¥ç¡çš„æƒ…å†µ)
                    baseScore = 5;
                }
                // ğŸ¥ˆ è¿›å– (00:00-00:30): +3åˆ†
                else if (minutes >= 0 && minutes < 30) {
                    baseScore = 3;
                }
                // ğŸ¥‰ ä¸´ç•Œ (00:30-01:00): +1åˆ†
                else if (minutes >= 30 && minutes <= 60) {
                    baseScore = 1;
                }
                // â­• ç¼ºå£ (> 01:00): +0åˆ†
                else {
                    baseScore = 0;
                }

                // åŠ¨æ€å¥–æƒ©: ä¸æ˜¨æ—¥å…¥ç¡æ—¶é—´å·®Î”t
                let dynamicBonus = 0;
                if (yesterdayTime && yesterdayTime !== '--:--') {
                    const todayMinutes = timeToMinutes(timeStr);
                    const yesterdayMinutes = timeToMinutes(yesterdayTime);
                    const deltaT = todayMinutes - yesterdayMinutes; // æ­£æ•°=ä»Šå¤©æ›´æ™š

                    // ç¬¬22ç‰ˆåŠ¨æ€å¥–æƒ©é˜¶æ¢¯
                    if (deltaT <= -30) {
                        dynamicBonus = 1.0;
                    } else if (deltaT > -30 && deltaT <= 0) {
                        dynamicBonus = 0.5;
                    } else if (deltaT > 0 && deltaT <= 30) {
                        dynamicBonus = 0;
                    } else if (deltaT > 30 && deltaT <= 60) {
                        dynamicBonus = -0.5;
                    } else if (deltaT > 60) {
                        dynamicBonus = -1.0;
                    }
                }

                const totalScore = baseScore + dynamicBonus;
                if (sleepScoreElem) sleepScoreElem.value = totalScore.toFixed(1);

                return totalScore;
            }

          /**
             * è®¡ç®—BCMæ€»åˆ† (ä¿®å¤ç‰ˆ)
             */
            function calculateBCM() {
                let totalScore = 0;

                try {
                    // 1. æ™¨é—´å…¥é¦† (è°ƒç”¨ç‹¬ç«‹å‡½æ•°)
                    const s1 = calculateMorningScore();
                    totalScore += s1;

                    // 2. åˆé—´é˜²å®ˆ (è¯»å–DOMå€¼ï¼Œè¯¥å€¼ç”±ç›‘å¬å™¨è§¦å‘ calculateDefenseScore æ›´æ–°)
                    const s2 = safeParseFloat(document.getElementById('bcm-lunch-score')?.value);
                    totalScore += s2;

                    // 3. æ™šé—´é˜²å®ˆ
                    const s3 = safeParseFloat(document.getElementById('bcm-dinner-score')?.value);
                    totalScore += s3;

                    // 4. æ™šé—´ç¦»é¦† (è°ƒç”¨ç‹¬ç«‹å‡½æ•°)
                    const s4 = calculateEveningScore();
                    totalScore += s4;

                    // 5. ç¡çœ è®¡åˆ† (è°ƒç”¨ç‹¬ç«‹å‡½æ•°)
                    const s5 = calculateSleepScore();
                    totalScore += s5;

                    // 6. æ•°å­—æ°”éš™ (ç›´æ¥è®¡ç®—)
                    const digSelect = document.getElementById('bcm-digital-status');
                    const digScoreElem = document.getElementById('bcm-digital-score');
                    let s6 = 0;
                    if (digSelect) {
                        const val = digSelect.value;
                        if (val === '1') s6 = 3;       // å®Œæˆ+3
                        else if (val === 'exempt') s6 = 3; // è±å…+3
                        else s6 = 0;
                        digScoreElem.value = s6.toFixed(1);
                    }
                    totalScore += s6;

                    // 7. ä¸‹åˆæ ¸å¿ƒå­¦ä¹ å¥–åŠ± (ç›´æ¥è®¡ç®—)
                    const aftSelect = document.getElementById('bcm-afternoon-status');
                    const aftScoreElem = document.getElementById('bcm-afternoon-score');
                    let s7 = 0;
                    if (aftSelect) {
                        const val = aftSelect.value;
                        if (val === '1') s7 = 1.0;
                        else if (val === 'exempt') s7 = 1.0;
                        else s7 = 0;
                        aftScoreElem.value = s7.toFixed(1);
                    }
                    totalScore += s7;

                    // å°é¡¶ 24 åˆ†
                    let finalScore = Math.min(totalScore, 24);

                    // ğŸ”§ ä¿®å¤3: BCMæ”€ç™»åˆ†è‡ªåŠ¨æ¯”å¯¹
                    // ä»LocalStorageè¯»å–æ˜¨æ—¥BCMæ•°æ®
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayKey = `tpi_data_${yesterday.toISOString().split('T')[0]}`;

                    let climbBonus = 0;
                    try {
                        const yesterdayDataStr = localStorage.getItem(yesterdayKey);
                        if (yesterdayDataStr) {
                            const yesterdayData = JSON.parse(yesterdayDataStr);
                            const yesterdayBCM = safeParseFloat(yesterdayData['bcm-score'] || yesterdayData['bcm'] || 0);

                            // æ˜¾ç¤ºæ˜¨æ—¥BCMå‚è€ƒ
                            const bcmYesterdayElem = document.getElementById('bcm-yesterday-ref');
                            if (bcmYesterdayElem) {
                                bcmYesterdayElem.textContent = yesterdayBCM.toFixed(1);
                            }

                            // è®¡ç®—æ”€ç™»å¥–åŠ±
                            const improvement = finalScore - yesterdayBCM;
                            if (improvement >= 10) {
                                climbBonus = 3.5;
                            } else if (improvement >= 5) {
                                climbBonus = 1.0;
                            }

                            // æ˜¾ç¤ºæ”€ç™»å¥–åŠ±
                            const climbBonusElem = document.getElementById('bcm-climb-bonus');
                            if (climbBonusElem) {
                                climbBonusElem.textContent = climbBonus > 0 ? `+${climbBonus.toFixed(1)}` : '0';
                                climbBonusElem.style.color = climbBonus > 0 ? '#10b981' : '#6b7280';
                            }
                        }
                    } catch (e) {
                        console.error('è¯»å–æ˜¨æ—¥BCMæ•°æ®å¤±è´¥:', e);
                    }

                    // åŠ ä¸Šæ”€ç™»å¥–åŠ±
                    finalScore += climbBonus;

                    // æ›´æ–°æ€»åˆ†æ˜¾ç¤º
                    const bcmTotalElem = document.getElementById('bcm-total-score');
                    if (bcmTotalElem) bcmTotalElem.textContent = finalScore.toFixed(1);

                    return finalScore;
                } catch (e) {
                    console.error('BCMè®¡ç®—é”™è¯¯:', e);
                    return 0;
                }
            }

            // ==================== Logistics è®¡ç®— ====================

           /**
             * è®¡ç®—Logisticsæ€»åˆ† (ä¿®å¤ç‰ˆ)
             */
            function calculateLogistics() {
                let totalScore = 0;
                let totalTime = 0;

                try {
                    const rows = document.querySelectorAll('#logistics-table tbody tr:not(.summary-row)');

                    rows.forEach(row => {
                        // è·å–è¾“å…¥å…ƒç´ 
                        const statusSelect = row.querySelector('.logistics-status');
                        const timeInput = row.querySelector('.logistics-time');
                        const levelSelect = row.querySelector('.logistics-level');
                        const scoreInput = row.querySelector('.logistics-score');

                        if (!statusSelect || !timeInput || !levelSelect) return;

                        // 1. çŠ¶æ€åˆ† (å®Œæˆ=1, è±å…=1)
                        const statusVal = statusSelect.value;
                        let statusScore = 0;
                        if (statusVal === '1') statusScore = 1;
                        else if (statusVal === 'exempt') statusScore = 1;

                        // ğŸ”§ ä¿®å¤12: åŸºç¡€åˆ† = çŠ¶æ€åˆ† * 2 (åŒå€åŸºç¡€åˆ†)
                        const baseScore = statusScore * 2;

                        // 3. æ—¶é—´æ‰£å‡
                        const time = safeParseFloat(timeInput.value);
                        totalTime += time;
                        const coeff = safeParseFloat(levelSelect.value) || 0.1;

                        const deduction = (time / 10) * coeff;

                        // 4. å®å¾—åˆ† (ä¸ä½äº0)
                        const finalRowScore = Math.max(0, baseScore - deduction);

                        if (scoreInput) scoreInput.value = finalRowScore.toFixed(1);
                        totalScore += finalRowScore;
                    });

                    const totalElem = document.getElementById('logistics-total-score');
                    if (totalElem) totalElem.textContent = totalScore.toFixed(1);

                    return totalScore;

                } catch (e) {
                    console.error('Logisticsè®¡ç®—é”™è¯¯:', e);
                    return 0;
                }
            }

            // ==================== HSM è®¡ç®— ====================

            /**
             * è®¡ç®—HSMæ€»åˆ†
             */
            function calculateHSM() {
                let totalScore = 0;

                // 1. æ ¸å¿ƒç”Ÿå­˜è¿åŠ¨ (æ»¡åˆ†4åˆ†)
                const coreStatusSelect = document.getElementById('hsm-core-status');
                const coreScoreElem = document.getElementById('hsm-core-score');

                if (coreStatusSelect && coreScoreElem) {
                    const status = coreStatusSelect.value;
                    let coreScore = 0;

                    if (status === '1') {
                        // å®Œæˆ = 4åˆ†
                        coreScore = 4;
                    } else if (status === '0') {
                        // æœªå®Œæˆ = 0åˆ†
                        coreScore = 0;
                    } else if (status === 'exempt') {
                        // è±å… = 3åˆ†
                        coreScore = 3;
                    } else if (status === 'other') {
                        // å…¶ä»– = 0åˆ†
                        coreScore = 0;
                    }

                    coreScoreElem.value = coreScore.toFixed(1);
                    totalScore += coreScore;
                }

                // 2. ä¸Šåˆå¾®è¿åŠ¨ (æ»¡åˆ†0.5åˆ†)
                const morningStatusSelect = document.getElementById('hsm-morning-status');
                const morningScoreElem = document.getElementById('hsm-morning-score');

                if (morningStatusSelect && morningScoreElem) {
                    const status = morningStatusSelect.value;
                    let morningScore = 0;

                    if (status === '1') {
                        // å®Œæˆ = 0.5åˆ†
                        morningScore = 0.5;
                    } else if (status === '0') {
                        // æœªå®Œæˆ = 0åˆ†
                        morningScore = 0;
                    } else if (status === 'exempt') {
                        // è±å… = 0.5åˆ† (ç»™æ»¡åˆ†)
                        morningScore = 0.5;
                    } else if (status === 'other') {
                        // å…¶ä»– = 0åˆ†
                        morningScore = 0;
                    }

                    morningScoreElem.value = morningScore.toFixed(1);
                    totalScore += morningScore;
                }

                // 3. ä¸‹åˆå¾®è¿åŠ¨ (æ»¡åˆ†0.5åˆ†)
                const afternoonStatusSelect = document.getElementById('hsm-afternoon-status');
                const afternoonScoreElem = document.getElementById('hsm-afternoon-score');

                if (afternoonStatusSelect && afternoonScoreElem) {
                    const status = afternoonStatusSelect.value;
                    let afternoonScore = 0;

                    if (status === '1') {
                        // å®Œæˆ = 0.5åˆ†
                        afternoonScore = 0.5;
                    } else if (status === '0') {
                        // æœªå®Œæˆ = 0åˆ†
                        afternoonScore = 0;
                    } else if (status === 'exempt') {
                        // è±å… = 0.5åˆ† (ç»™æ»¡åˆ†)
                        afternoonScore = 0.5;
                    } else if (status === 'other') {
                        // å…¶ä»– = 0åˆ†
                        afternoonScore = 0;
                    }

                    afternoonScoreElem.value = afternoonScore.toFixed(1);
                    totalScore += afternoonScore;
                }

                // 4. ä¸Šåˆå–æ°´ (æ»¡åˆ†0.1åˆ†)
                const waterMorningStatusSelect = document.getElementById('hsm-water-morning-status');
                const waterMorningScoreElem = document.getElementById('hsm-water-morning-score');

                if (waterMorningStatusSelect && waterMorningScoreElem) {
                    const status = waterMorningStatusSelect.value;
                    let waterMorningScore = 0;

                    if (status === '1') {
                        // å®Œæˆ = 0.1åˆ†
                        waterMorningScore = 0.1;
                    } else if (status === '0') {
                        // æœªå®Œæˆ = 0åˆ†
                        waterMorningScore = 0;
                    } else if (status === 'exempt') {
                        // è±å… = 0.1åˆ† (ç»™æ»¡åˆ†)
                        waterMorningScore = 0.1;
                    } else if (status === 'other') {
                        // å…¶ä»– = 0åˆ†
                        waterMorningScore = 0;
                    }

                    waterMorningScoreElem.value = waterMorningScore.toFixed(2);
                    totalScore += waterMorningScore;
                }

                // 5. ä¸‹åˆå–æ°´ (æ»¡åˆ†0.1åˆ†)
                const waterAfternoonStatusSelect = document.getElementById('hsm-water-afternoon-status');
                const waterAfternoonScoreElem = document.getElementById('hsm-water-afternoon-score');

                if (waterAfternoonStatusSelect && waterAfternoonScoreElem) {
                    const status = waterAfternoonStatusSelect.value;
                    let waterAfternoonScore = 0;

                    if (status === '1') {
                        // å®Œæˆ = 0.1åˆ†
                        waterAfternoonScore = 0.1;
                    } else if (status === '0') {
                        // æœªå®Œæˆ = 0åˆ†
                        waterAfternoonScore = 0;
                    } else if (status === 'exempt') {
                        // è±å… = 0.1åˆ† (ç»™æ»¡åˆ†)
                        waterAfternoonScore = 0.1;
                    } else if (status === 'other') {
                        // å…¶ä»– = 0åˆ†
                        waterAfternoonScore = 0;
                    }

                    waterAfternoonScoreElem.value = waterAfternoonScore.toFixed(2);
                    totalScore += waterAfternoonScore;
                }

                // 6. æ™šä¸Šå–æ°´ (æ»¡åˆ†0.1åˆ†)
                const waterEveningStatusSelect = document.getElementById('hsm-water-evening-status');
                const waterEveningScoreElem = document.getElementById('hsm-water-evening-score');

                if (waterEveningStatusSelect && waterEveningScoreElem) {
                    const status = waterEveningStatusSelect.value;
                    let waterEveningScore = 0;

                    if (status === '1') {
                        // å®Œæˆ = 0.1åˆ†
                        waterEveningScore = 0.1;
                    } else if (status === '0') {
                        // æœªå®Œæˆ = 0åˆ†
                        waterEveningScore = 0;
                    } else if (status === 'exempt') {
                        // è±å… = 0.1åˆ† (ç»™æ»¡åˆ†)
                        waterEveningScore = 0.1;
                    } else if (status === 'other') {
                        // å…¶ä»– = 0åˆ†
                        waterEveningScore = 0;
                    }

                    waterEveningScoreElem.value = waterEveningScore.toFixed(2);
                    totalScore += waterEveningScore;
                }

                // ä¸Šé™5.3åˆ†
                const finalScore = Math.min(totalScore, 5.3);
                const hsmTotalScoreElem = document.getElementById('hsm-total-score');
                if (hsmTotalScoreElem) hsmTotalScoreElem.textContent = finalScore.toFixed(1);

                return finalScore;
            }

                        // ==================== éŸ§æ€§åŠ åˆ†è®¡ç®— ====================

            /**
             * è®¡ç®—éŸ§æ€§åŠ åˆ†
             */
// è¾…åŠ©å‡½æ•°ï¼šè®¡ç®— AMI å†™ä½œäº§å‡º
            function calculateWritingOutput(inputs, price, focus) {
                let score = 0;
                const kValue = 400; // v14ä¿®æ­£: Kå€¼å›ºå®šä¸º400

                // inputs æ˜¯è¯¥æ—¶æ®µçš„6ä¸ªè¾“å…¥æ¡†
                // ç´¢å¼• 0-2 (Type A/B/C): å­—æ•°/100 * Price
                // ç´¢å¼• 3 (Type D): å­—æ•°/400 * 3.0 * F  [v14ä¿®æ­£]
                // ç´¢å¼• 4 (Type S): å­—æ•°/100 * Price (é€šå¸¸åŒå¸¸æ€)
                // ç´¢å¼• 5 (ç°åœºL): å¿½ç•¥ (ä»…ç®—åŸºç¡€åˆ†)

                // Type A/B/C/S
                [0, 1, 2, 4].forEach(idx => {
                    const val = safeParseFloat(inputs[idx]?.value || 0);
                    if (val > 0) score += (val / 100) * price * focus;
                });

                // Type D (æ ¸å¿ƒæ”»åš) - v14æ–°ç®—æ³•: (å­—æ•°/400) Ã— 3.0 Ã— F
                let typeD_Words = safeParseFloat(inputs[3]?.value || 0);
                if (typeD_Words > 0) {
                    // v14äººæ€§åŒ–å–æ•´: è‹¥å·®3å­—æ»¡ç™¾ï¼Œè‡ªåŠ¨å‘ä¸Šå–æ•´
                    const remainder = typeD_Words % 100;
                    if (remainder > 0 && (100 - remainder) <= 3) {
                        typeD_Words = Math.ceil(typeD_Words / 100) * 100;
                    }
                    score += (typeD_Words / 100) * 3.0 * focus;
                }

                return score;
            }
         // ğŸ”§ ä¿®å¤8: Bonuså¥–åŠ±è‡ªåŠ¨åŒ–æ£€æŸ¥å™¨
        function checkAutoBonuses() {

            // 1. æ”»åšå‹‡å£« (Type D >= 3ä¸ªæ—¶æ®µ)
            if (state.typeDCount >= 3) {
                checkBonusBox('warrior');
            } else {
                uncheckBonusBox('warrior');
            }

            // 2. è¶…çº§å¿ƒæµ (F=1.3 >= 3ä¸ªæ—¶æ®µ)
            if (state.flowCount >= 3) {
                checkBonusBox('flow');
            } else {
                uncheckBonusBox('flow');
            }

            // 3. å®Œç¾ä½œæ¯ (æ—©èµ·+æ—©ç¡+åŒåšå®ˆ)
            const morningScore = safeParseFloat(document.getElementById('bcm-morning-score')?.value);
            const sleepScore = safeParseFloat(document.getElementById('bcm-sleep-score')?.value);
            const lunchStat = document.getElementById('bcm-lunch-status')?.textContent || '';
            const dinnerStat = document.getElementById('bcm-dinner-status')?.textContent || '';

            const isBalance = (morningScore >= 3.5) && (sleepScore >= 3) &&
                              (lunchStat.includes('åšå®ˆ')) && (dinnerStat.includes('åšå®ˆ'));

            if (isBalance) {
                checkBonusBox('balance');
            } else {
                uncheckBonusBox('balance');
            }

            // 4. å“è¶Šè¡¨ç° (TPI >= 160)
            if (state.tpi >= 160) {
                 checkBonusBox('excellent');
            } else {
                 uncheckBonusBox('excellent');
            }

            // ğŸ”§ ä¿®å¤8: æ–°å¢è‡ªåŠ¨åˆ¤å®š - è¿ç»­è¾¾æ ‡æ£€æŸ¥
            const streak7 = checkStreakDays(7);
            if (streak7) {
                checkBonusBox('streak7');
            } else {
                uncheckBonusBox('streak7');
            }

            const streak14 = checkStreakDays(14);
            if (streak14) {
                checkBonusBox('streak14');
            } else {
                uncheckBonusBox('streak14');
            }

            const streak21 = checkStreakDays(21);
            if (streak21) {
                checkBonusBox('streak21');
            } else {
                uncheckBonusBox('streak21');
            }
        }

        // è¾…åŠ©å‡½æ•°: æ£€æŸ¥è¿ç»­è¾¾æ ‡å¤©æ•°
        function checkStreakDays(days) {
            const today = new Date();
            for (let i = 1; i <= days; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateKey = `tpi_data_${checkDate.toISOString().split('T')[0]}`;

                try {
                    const dataStr = localStorage.getItem(dateKey);
                    if (!dataStr) return false;

                    const data = JSON.parse(dataStr);
                    const tpi = safeParseFloat(data['tpi'] || data['tpi_total'] || 0);

                    if (tpi < 100) return false; // æœªè¾¾æ ‡
                } catch (e) {
                    return false;
                }
            }
            return true; // å…¨éƒ¨è¾¾æ ‡
        }

        function checkBonusBox(val) {
            const el = document.querySelector(`input[name="bonus-item"][value="${val}"]`);
            if (el && !el.checked) {
                el.checked = true;
                // è§¦å‘é‡ç®—
                calculateBonus();
            }
        }
        function uncheckBonusBox(val) {
            const el = document.querySelector(`input[name="bonus-item"][value="${val}"]`);
            if (el && el.checked) {
                el.checked = false;
                calculateBonus();
            }
        }

        function calculateBonus() {
            let totalBonus = 0;
            const bonusItems = document.querySelectorAll('input[name="bonus-item"]:checked');

            bonusItems.forEach(item => {
                switch(item.value) {
                    case 'flow': totalBonus += 5; break;
                    case 'balance': totalBonus += 5; break;
                    case 'excellent': totalBonus += 5; break;
                    case 'warrior': totalBonus += 7; break;
                    case 'return': totalBonus += 7; break;
                    case 'streak21': totalBonus += 7; break;
                    case 'streak14': totalBonus += 5; break;
                    case 'streak7': totalBonus += 3; break;
                    case 'recovery': totalBonus += 3; break;
                    case 'micro-victories': totalBonus += 1; break; // æ–°å¢å¾®å°èƒœåˆ©å¥–
                    default:
                        const val = safeParseFloat(item.value);
                        if(val>0) totalBonus += val;
                }
            });

            // ä¸Šé™10åˆ†
            const finalBonus = Math.min(totalBonus, 10);

            const bonusTotal = document.getElementById('bonus-total-score');
            const bonusInp = document.getElementById('bonus-score');
            if(bonusTotal) bonusTotal.textContent = finalBonus.toFixed(1);
            if(bonusInp) bonusInp.value = finalBonus.toFixed(1);

            return finalBonus;
        }

            // ==================== TPI è®¡ç®— ====================

        /**
             * è‡ªåŠ¨è¯„çº§TPI (ç¬¬22ç‰ˆæ ‡å‡†)
             * <95ç»´æŠ¤ | 95-120ç»´æŒ | 121-155æ¨è¿› | 156-200å“è¶Š | 201+è¿‡è½½
             */
          function autoRateTPI(score) {
        const ratingSelect = document.getElementById('tpi-rating');
        if (!ratingSelect) return;
        // ä¸¥æ ¼åŒæ­¥ç¬¬22ç‰ˆç•Œé™: <95 / 95-120 / 121-155 / 156-200 / 201+
        if (score >= 201) {
            ratingSelect.value = 'overload';
            ratingSelect.style.color = '#ef4444';
        } else if (score >= 156) {
            ratingSelect.value = 'excellent'; // 156-200 å“è¶Š
            ratingSelect.style.color = '#8b5cf6';
        } else if (score >= 121) {
            ratingSelect.value = 'good'; // 121-155 æ¨è¿›
            ratingSelect.style.color = '#10b981';
        } else if (score >= 95) {
                    ratingSelect.value = 'normal'; // 95-120 ç»´æŒ
                    ratingSelect.style.color = '#3b82f6';
                    ratingSelect.style.fontWeight = '600';
                } else {
                    ratingSelect.value = 'poor'; // <95 ç»´æŠ¤
                    ratingSelect.style.color = '#6b7280';
                    ratingSelect.style.fontWeight = '600';
                }
            }

            /**
             * æ˜¾ç¤ºå®‰å…¨ä¿æŠ¤åè®®è­¦å‘Š
             */
            function showSafetyAlert() {
                // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨è­¦å‘Š
                const existingAlert = document.querySelector('.safety-protocol-alert');
                if (existingAlert) return;

                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger safety-protocol-alert';
                alertDiv.innerHTML /*XSS-Safe*/ = `
                    <h4>ğŸš¨ å®‰å…¨ä¿æŠ¤åè®®è§¦å‘</h4>
                    <p>Sys<sub>Net</sub> < ${CONSTANTS.SYS_NET_SAFETY_THRESHOLD} åˆ†ï¼Œè§¦å‘è‡ªåŠ¨ä¿æŠ¤æœºåˆ¶ã€‚</p>
                    <p><strong>æ¬¡æ—¥å¿…é¡»å¼ºåˆ¶è¿›å…¥ [ğŸ…±ï¸ å¤è‹] æ¨¡å¼</strong>ï¼Œå¹¶åœ¨å½“æ™šæ˜¾ç¤ºçº¢è‰²é¢„è­¦ï¼š"æ˜æ—¥å°†è¿›å…¥ä¿æŠ¤æ¨¡å¼"ã€‚<strong>è¯¥è§¦å‘ä¼˜å…ˆäºç”±TPIåˆ†æ•°è§¦å‘çš„æ¨¡å¼åˆ‡æ¢ã€‚</strong></p>
                `;

                // æ’å…¥åˆ°TPIä»ªè¡¨ç›˜è¡¨æ ¼ä¹‹å
                const tpiTable = document.querySelector('#tpi-dashboard .table-container');
                if (tpiTable && tpiTable.parentNode) {
                    tpiTable.parentNode.insertBefore(alertDiv, tpiTable.nextSibling);

                    // 10ç§’åè‡ªåŠ¨ç§»é™¤è­¦å‘Š
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.style.transition = 'opacity 0.5s';
                            alertDiv.style.opacity = '0';
                            setTimeout(() => {
                                if (alertDiv.parentNode) {
                                    alertDiv.parentNode.removeChild(alertDiv);
                                }
                            }, 500);
                        }
                    }, 10000);
                }
            }

            /**
             * è®¡ç®—TPIæ€»åˆ†
             */

            function getTodayScores() {
                return {
                    preliminaryTPI: window.preliminaryTPI || 0,
                    sys: safeParseFloat(document.getElementById('sys-score')?.textContent || '0', 0)
                };
            }

// Syså°é¡¶18åˆ†ï¼ˆæ¨¡æ¿è¦æ±‚ï¼‰
function calculateSysNet() {
    const bcm = calculateBCM();
    const logistics = calculateLogistics();
    const hsm = calculateHSM();

    // å·®å¼‚1ä¿®å¤ï¼šSys_Net = BCM + Logistics + HSM
    const rawSysNet = bcm + logistics + hsm;

    // å·®å¼‚29ä¿®å¤ï¼šè´Ÿå€¼å½’é›¶æ³•åˆ™ max(0, sum)
    let finalSysNet = Math.max(0, rawSysNet);

    // ç¬¬22ç‰ˆå°é¡¶è§„åˆ™ï¼šSys_Netæœ€é«˜18åˆ†
    if (finalSysNet > CONSTANTS.SYS_NET_MAX_SCORE) {
        finalSysNet = CONSTANTS.SYS_NET_MAX_SCORE;
    }

    if (rawSysNet < 0) {
    }

    // ç¬¬22ç‰ˆå­ç³»ç»Ÿæœ€ä½è¾¾æ ‡åˆ†é¢„è­¦
    const warnings = [];
    if (bcm < 12) warnings.push(`BCM(${bcm.toFixed(1)}) < 12åˆ†`);
    if (logistics < 4) warnings.push(`Logistics(${logistics.toFixed(1)}) < 4åˆ†`);
    if (hsm < 2.5) warnings.push(`HSM(${hsm.toFixed(1)}) < 2.5åˆ†`);

    if (warnings.length > 0) {
        console.warn(`[ç¬¬22ç‰ˆ] âš ï¸ å­ç³»ç»Ÿé¢„è­¦: ${warnings.join(', ')} - å»ºè®®å…³æ³¨å¹¶è°ƒæ•´`);
        // å¯ä»¥åœ¨UIä¸Šæ˜¾ç¤ºé¢„è­¦
        showNotification(`âš ï¸ å­ç³»ç»Ÿé¢„è­¦: ${warnings.join('; ')}`, 'warning');
    }

    // æ›´æ–°æ˜¾ç¤º
    const sysNetEl = document.getElementById('sys-net-score');
    if (sysNetEl) sysNetEl.textContent = finalSysNet.toFixed(1);

    const sysScoreInput = document.getElementById('sys-score');
    if (sysScoreInput) sysScoreInput.value = finalSysNet.toFixed(1);

    return finalSysNet;
}

/**
 * å·®å¼‚40,41,61,66ä¿®å¤ï¼šMA7æ»‘åŠ¨çª—å£è®¡ç®—
 * è®¡ç®—æœ€è¿‘7å¤©çš„TPIå¹³å‡åˆ†
 */
function calculateMA7() {
    try {
        const today = new Date();
        let totalScore = 0;
        let validDays = 0;
        let daysList = [];

        // å‘å‰æŸ¥æ‰¾7å¤©çš„æ•°æ®
        for (let i = 0; i < 7; i++) {
            const targetDate = new Date(today);
            targetDate.setDate(targetDate.getDate() - i);
            const dateKey = `tpi_data_${targetDate.toISOString().split('T')[0]}`;

            const dataStr = localStorage.getItem(dateKey);
            if (dataStr) {
                try {
                    const data = JSON.parse(dataStr);
                    const tpiScore = safeParseFloat(data['tpi-total'] || data.tpi || 0);

                    if (tpiScore > 0) {
                        totalScore += tpiScore;
                        validDays++;
                        daysList.push({
                            date: targetDate.toISOString().split('T')[0],
                            score: tpiScore
                        });
                    } else {
                        // å·®å¼‚66ä¿®å¤ï¼šç¼ºå¤±å¤©æ•°è®¡å…¥åˆ†æ¯ï¼ˆè§†ä¸º0åˆ†ï¼‰
                        validDays++;
                        daysList.push({
                            date: targetDate.toISOString().split('T')[0],
                            score: 0
                        });
                    }
                } catch (e) {
                    console.error(`è§£æ${dateKey}å¤±è´¥:`, e);
                    // å·®å¼‚66ä¿®å¤ï¼šè§£æå¤±è´¥ä¹Ÿè®¡å…¥åˆ†æ¯
                    validDays++;
                }
            } else {
                // å·®å¼‚66ä¿®å¤ï¼šæ— æ•°æ®æ—¥ä¹Ÿè®¡å…¥åˆ†æ¯
                validDays++;
            }
        }

        // å·®å¼‚41ä¿®å¤ï¼šæ»‘åŠ¨çª—å£è®¡ç®—ï¼ˆä¸æ˜¯æœ¬è‡ªç„¶å‘¨ï¼‰
        const ma7 = validDays > 0 ? totalScore / validDays : 0;

        // æ›´æ–°æ˜¾ç¤º
        const ma7Input = document.getElementById('ma7-score');
        if (ma7Input) {
            ma7Input.value = ma7.toFixed(1);
        }

        // å·®å¼‚4ä¿®å¤ï¼šMA7â‰¥120åˆ¤å®šç¨³å¥çŠ¶æ€
        if (ma7 >= 120) {
        }

        return ma7;
    } catch (error) {
        console.error('MA7è®¡ç®—å¤±è´¥:', error);
        return 0;
    }
}

// ==================== è®¡ç®—é˜²æŠ–ä¼˜åŒ– ====================
// ä¿å­˜åŸå§‹çš„calculateTPIå‡½æ•°
let calculateTPI_original = null;
let calculateTPI_debounceTimer = null;

function calculateTPI() {
                try {
                    // 1. è·å–åŸºç¡€åˆ†é‡
                    let ami = safeParseFloat(document.getElementById('ami-score')?.value || 0);
                    const fli = safeParseFloat(document.getElementById('fli-score')?.value || 0);
                    const bonus = calculateBonus();

                    // 2. Sys_Net è®¡ç®— - ä½¿ç”¨æ–°çš„calculateSysNetå‡½æ•°
                    const sysNet = calculateSysNet(); // å·²è´Ÿå€¼å½’é›¶

                    const sysScoreElem = document.getElementById('sys-score');
                    if (sysScoreElem) sysScoreElem.value = sysNet.toFixed(1);

                  // ç¬¬22ç‰ˆæ ‡å‡†ï¼šåºŸé™¤åŸºçŸ³ç³»æ•°Î±ï¼Œé‡‡ç”¨ Sys_Net ç›´æ¥åŠ æ³•æƒé™åˆ¶
            // é€»è¾‘ï¼šSys_Net æœ¬èº«å æ¯” 20%ï¼Œä½åˆ†ä¼šè‡ªåŠ¨æ‹‰ä½æ€»åˆ†ï¼Œæ— éœ€é¢å¤–æƒ©ç½š AMI
            const amiAdjusted = ami;

                    // 3. å®‰å…¨ä¿æŠ¤ä¸èƒ½é‡å¹³è¡¡æ£€æµ‹
                    if (sysNet < CONSTANTS.SYS_NET_SAFETY_THRESHOLD) {
                        showSafetyAlert("Sys < 12: è§¦å‘è‡ªåŠ¨ä¿æŠ¤ï¼Œæ¬¡æ—¥å¼ºåˆ¶å¤è‹æ¨¡å¼");

                        // å·®å¼‚5ä¿®å¤ï¼šå¼ºåˆ¶å¤è‹è§¦å‘å™¨ - Sys_Net<12è‡ªåŠ¨åˆ‡æ¢åˆ°å¤è‹æ¨¡å¼
                        // ä¿å­˜è§¦å‘æ ‡è®°åˆ°localStorageï¼Œæ¬¡æ—¥åŠ è½½æ—¶è‡ªåŠ¨è¿›å…¥å¤è‹æ¨¡å¼
                        localStorage.setItem('force_recovery_mode', 'true');
                        localStorage.setItem('force_recovery_reason', `æ˜¨æ—¥Sys_Net=${sysNet.toFixed(1)}<12`);
                        localStorage.setItem('force_recovery_date', new Date().toISOString().split('T')[0]);

                        console.error(`ğŸš¨ [å·®å¼‚5] å¼ºåˆ¶å¤è‹è§¦å‘: Sys_Net=${sysNet.toFixed(1)}<12ï¼Œå·²æ ‡è®°æ¬¡æ—¥å¼ºåˆ¶è¿›å…¥å¤è‹æ¨¡å¼`);

                        // æ˜¾ç¤ºå¼ºåˆ¶å¤è‹è­¦å‘Š
                        setTimeout(() => {
                            NotifySystem.showToast(
                                `ğŸš¨ å®‰å…¨è­¦å‘Šï¼šSys_Net=${sysNet.toFixed(1)}<12ï¼Œæ˜æ—¥å°†è‡ªåŠ¨è¿›å…¥å¤è‹æ¨¡å¼ï¼`,
                                'error',
                                'ğŸ”´ å¼ºåˆ¶å¤è‹è§¦å‘',
                                5000
                            );
                        }, 1000);
                    } else {
                        // Sys_Netæ¢å¤æ­£å¸¸ï¼Œæ¸…é™¤å¼ºåˆ¶å¤è‹æ ‡è®°
                        if (localStorage.getItem('force_recovery_mode') === 'true') {
                            const triggerDate = localStorage.getItem('force_recovery_date');
                            const today = (typeof __tpi_getSelectedDate === 'function') ? __tpi_getSelectedDate() : (()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;})();

                            // å¦‚æœæ˜¯åŒä¸€å¤©ï¼Œè¯´æ˜å·²ç»æ¢å¤ï¼Œæ¸…é™¤æ ‡è®°
                            if (triggerDate === today) {
                            }
                        }
                    }

                    // æ£€æµ‹èƒ½é‡å¹³è¡¡åè®® (TPI > 200)
                    // æ­¤å¤„ä»…åšæ ‡è®°ï¼Œå®é™…é™åˆ¶éœ€åœ¨æ¬¡æ—¥åŠ è½½æ—¶è¯»å–
                    if (state.tpi > CONSTANTS.TPI_OVERLOAD_THRESHOLD) {
                         NotifySystem.showToast("ğŸ”¥ èƒ½é‡å¹³è¡¡åè®®è§¦å‘: æ˜æ—¥ä¸Šé™å°†é”æ­»ä¸º95", "warning");
                    }

                    // 4. æ¨¡å¼ç‰¹å¼‚æ€§è®¡ç®—
                    const selectedMode = state.selectedMode || 'normal';
                    let tpiTotal = 0;

                    // å‡æœŸæ¨¡å¼ (å…¨ä¼‘) -> æš‚åœè®¡ç®—
                    if (selectedMode === 'vacation' && state.vacationPeriods === 4) {
                        tpiTotal = 0;
                        updateDisplay("PAUSED");
                        return 0;
                    }

// æ–¯å¤šè‘›æ¨¡å¼ (æŸ”æ€§æŠ˜ç®—å°é¡¶ - ç¬¬22ç‰ˆ)
                    if (selectedMode === 'stoic') {
                        // AMIÃ—1.2è¡¥å¿
                        const amiStoic = amiAdjusted * 1.2;
                        let rawStoic = amiStoic + fli + bonus;
                        // æ³¨æ„ï¼šSys_Netä¸å‚ä¸TPIè®¡ç®—ï¼Œåªå½±å“Î±ç³»æ•°

                        // ç¬¬22ç‰ˆæŸ”æ€§å°é¡¶è§„åˆ™:
                        // è‹¥æ€»åˆ† â‰¤ 95ï¼Œç›´æ¥å–è¯¥å€¼
                        // è‹¥æ€»åˆ† > 95ï¼Œåˆ™è¶…å‡ºéƒ¨åˆ†æŒ‰50%æŠ˜ç®—ï¼Œæœ€ç»ˆä¸è¶…è¿‡120åˆ†
                        // å…¬å¼: TPI' = min(120, 95 + (TPI - 95) Ã— 0.5)
                        if (rawStoic <= 95) {
                            tpiTotal = rawStoic;
                        } else {
                            const excess = rawStoic - 95;
                            tpiTotal = Math.min(120, 95 + excess * 0.5);
                        }

                        if (rawStoic > 95) {
                        } else {
                        }

                        // æ˜¾ç¤ºæé†’ä¿¡æ¯
                        reminderMessage = 'Â©ï¸ æ–¯å¤šè‘›/æ­¢æŸæ¨¡å¼ï¼šæ¥å—æµå¤±äº‹å®ï¼ŒåŠ›æ±‚æ­¢æŸã€‚AMIÃ—1.2è¡¥å¿ï¼ŒæŸ”æ€§å°é¡¶è§„åˆ™å·²åº”ç”¨ (â‰¤95åŸå€¼, >95åˆ™50%æŠ˜ç®—ä¸”â‰¤120)ã€‚';
                    } else {
                // å¸¸æ€ / å¤è‹æ¨¡å¼
                // ç¬¬22ç‰ˆå…¬å¼: TPI = AMI + FLI + Sys_Net + Bonus
                tpiTotal = amiAdjusted + fli + sysNet + bonus;
            }

                    // å·®å¼‚3ä¿®å¤ï¼šå¤è‹æ¨¡å¼ä¸Šé™95åˆ†
                    if (selectedMode === 'recovery') {
                        tpiTotal = Math.min(95, tpiTotal);
                    }

                    // æœ€ç»ˆä¿æŠ¤
                    tpiTotal = Math.max(0, tpiTotal);

                    updateDisplay(tpiTotal.toFixed(1));

                    // â˜…â˜…â˜… å·®å¼‚64ä¿®å¤ï¼šæ–¯å¤šè‘›æ¨¡å¼éšè—æ­£å‘åˆ†å€¼æ˜¾ç¤º â˜…â˜…â˜…
                    if (selectedMode === 'stoic') {
                        // æ–¯å¤šè‘›æ¨¡å¼ï¼šéšè—BonusåŒºåŸŸçš„è§†è§‰åé¦ˆ
                        const bonusSection = document.getElementById('bonus');
                        if (bonusSection) {
                            bonusSection.style.opacity = '0.3';
                            bonusSection.style.pointerEvents = 'none';
                            bonusSection.style.filter = 'grayscale(80%)';
                            // æ·»åŠ æç¤ºæ–‡å­—
                            const bonusHeader = bonusSection.querySelector('.card-header');
                            if (bonusHeader && !bonusHeader.querySelector('.stoic-hint')) {
                                const hint = document.createElement('span');
                                hint.className = 'stoic-hint';
                                hint.style.cssText = 'margin-left:10px;font-size:0.9em;color:#888;';
                                hint.textContent = '(æ–¯å¤šè‘›æ¨¡å¼: ä¸æ˜¾ç¤ºæ­£å‘åé¦ˆ)';
                                bonusHeader.appendChild(hint);
                            }
                        }

                    } else {
                        // å…¶ä»–æ¨¡å¼ï¼šæ¢å¤æ˜¾ç¤º
                        const bonusSection = document.getElementById('bonus');
                        if (bonusSection) {
                            bonusSection.style.opacity = '1';
                            bonusSection.style.pointerEvents = 'auto';
                            bonusSection.style.filter = 'none';
                            // ç§»é™¤æç¤ºæ–‡å­—
                            const hint = bonusSection.querySelector('.stoic-hint');
                            if (hint) hint.remove();
                        }
                    }

                    state.tpi = tpiTotal;
                    state.sysNet = sysNet;

                    // ğŸ”§ ä¿®å¤9: å¤è‹æ¨¡å¼è§¦å‘é˜ˆå€¼ - TPI<95æç¤ºï¼ˆæ”¹ä¸ºè½»é‡çº§é€šçŸ¥ï¼‰
                    if (tpiTotal < 95 && selectedMode !== 'recovery') {
                        console.warn(`ğŸ“‰ [å»ºè®®] TPI=${tpiTotal.toFixed(1)} < 95ï¼Œå»ºè®®åˆ‡æ¢è‡³å¤è‹æ¨¡å¼`);

                        // ä½¿ç”¨Toasté€šçŸ¥ä»£æ›¿confirmå¼¹çª—ï¼Œ5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                        setTimeout(() => {
                            NotifySystem.showToast(
                                `å½“å‰TPIä¸º${tpiTotal.toFixed(1)}åˆ†ï¼ˆ< 95åˆ†ï¼‰ï¼Œå»ºè®®åˆ‡æ¢è‡³å¤è‹æ¨¡å¼è¿›è¡Œç³»ç»Ÿç»´æŠ¤`,
                                'warning',
                                'ğŸ’¡ å¤è‹æ¨¡å¼å»ºè®®',
                                5000
                            );
                        }, 500);
                    }

                    autoRateTPI(tpiTotal);
                    updateRecoveryTarget(selectedMode);

                    // å·®å¼‚40,41,61ä¿®å¤ï¼šè®¡ç®—MA7æ»‘åŠ¨çª—å£
                    calculateMA7();

                    return tpiTotal;
                } catch (error) {
                    console.error('TPIè®¡ç®—é”™è¯¯:', error);
                    return 0;
                }

                function updateDisplay(val) {
                    const el = document.getElementById('tpi-total');
                    if (el) el.value = val;
                }
            }

// ==================== åº”ç”¨é˜²æŠ–ä¼˜åŒ– ====================
// ä¿å­˜åŸå§‹å‡½æ•°
if (!calculateTPI_original) {
    calculateTPI_original = calculateTPI;

    // åˆ›å»ºé˜²æŠ–ç‰ˆæœ¬çš„calculateTPI
    calculateTPI = function() {
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (calculateTPI_debounceTimer) {
            clearTimeout(calculateTPI_debounceTimer);
        }

        // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼ˆ300msé˜²æŠ–ï¼‰
        calculateTPI_debounceTimer = setTimeout(() => {
            calculateTPI_original();
        }, 300);
    };

    // æä¾›ç«‹å³æ‰§è¡Œçš„æ–¹æ³•ï¼ˆä¾›ç‰¹æ®Šæƒ…å†µä½¿ç”¨ï¼‰
    calculateTPI.immediate = function() {
        if (calculateTPI_debounceTimer) {
            clearTimeout(calculateTPI_debounceTimer);
        }
        return calculateTPI_original();
    };

}

            /**
             * æ›´æ–°å¤è‹æ¨¡å¼çš„ç›®æ ‡åˆ†æ˜¾ç¤º
             */
         function updateRecoveryTarget(mode) {
                const recoveryCard = document.getElementById('mode-recovery');
                if (!recoveryCard) return;

                const targetElement = recoveryCard.querySelector('.mode-target');
                if (!targetElement) return;

                if (mode === 'recovery') {
                    // å·®å¼‚16,47ä¿®å¤ï¼šå¤è‹æ¨¡å¼è¾¾æ ‡å…¬å¼ 45 - (ä¼‘æ¯æ—¶æ®µ Ã— 5)
                    // è·å–ä¼‘æ¯æ—¶æ®µæ•°é‡ï¼ˆé»˜è®¤ä¸º0ï¼‰
                    let restPeriods = parseInt(localStorage.getItem('recovery_rest_periods') || '0');
                    const threshold = 45 - (restPeriods * 5);

                    targetElement.innerHTML = `
                        ç›®æ ‡åˆ†: â‰¥${threshold}åˆ† (ä¼‘æ¯${restPeriods}ä¸ªæ—¶æ®µ)<br>
                        <small style="color: #6b7280;">å…¬å¼: 45-(ä¼‘æ¯æ—¶æ®µÃ—5) = 45-${restPeriods*5} = ${threshold}</small>
                    `;
                    targetElement.style.display = 'block';
                } else {
                    targetElement.innerHTML = 'åŠ¨æ€ç›®æ ‡: max(40, 70 - ä¼‘æ¯Ã—10)';
                    targetElement.style.display = 'block';

                    // é€€å‡ºå¤è‹æ¨¡å¼æ—¶é‡ç½®ä¼‘æ¯æ—¶æ®µè®¡æ•°
                    if (state.tpi >= 95) {
                        localStorage.setItem('recovery_rest_periods', '0');
                    }
                }
            }

            /**
             * è®¡ç®—æ‰€æœ‰åˆ†æ•°ï¼ˆä¸»å‡½æ•°ï¼‰
             */
            /**
             * è®¡ç®—æ‰€æœ‰åˆ†æ•°(ä¸»å‡½æ•°) - å¢å¼ºç‰ˆå¸¦æ™ºèƒ½è­¦ç¤º
             */
            function calculateAllScores() {
                try {
                    // âœ… æ ¸å¿ƒé˜²æŠ¤ï¼šåœ¨è®¡ç®—å‰ç¡®ä¿å…³é”®è¾“å…¥å…ƒç´ å­˜åœ¨
                    // è¿™æ˜¯é˜²æ­¢"ç®—åˆ†å¤±æ•ˆ"çš„ç¬¬ä¸€é“é˜²çº¿
                    calculateAMI();
                    calculateFLI();
                    calculateBCM();
                    calculateLogistics();
                    calculateHSM();
                    calculateBonus();
                    const tpiScore = calculateTPI();

                    // è·å–å…³é”®åˆ†æ•°
                    const sysNet = safeParseFloat(document.getElementById('sys-score')?.value || 0);
                    const bonus = safeParseFloat(state.bonus || 0);

                    // âš ï¸ æ–°å¢:è°ƒç”¨æ™ºèƒ½å¼¹çª—ç³»ç»Ÿæ£€æŸ¥
                    const hasTriggeredModal = NotifySystem.checkAndTrigger(sysNet, tpiScore, bonus);

                    // å¦‚æœæ²¡æœ‰è§¦å‘ä»»ä½•Modal,åˆ™æ˜¾ç¤ºæ™®é€šToastæç¤º
                    if (!hasTriggeredModal) {
                        NotifySystem.showToast(
                            `TPIæ€»åˆ†: ${tpiScore.toFixed(1)}`,
                            'success',
                            'æ‰€æœ‰åˆ†æ•°è®¡ç®—å®Œæˆ'
                        );
                    }

                    // æ›´æ–°æ•°æ®å¯è§†åŒ–
                    updateBadges();
                    updateStatistics();

                } catch (error) {
                    console.error('è®¡ç®—é”™è¯¯:', error);
                    NotifySystem.showToast(
                        'è¯·æ£€æŸ¥è¾“å…¥æ•°æ®æ˜¯å¦æ­£ç¡®',
                        'error',
                        'è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯'
                    );
                }
            }

            // ==================== âš ï¸ æ–°å¢:æ™ºèƒ½å¼¹çª—ç³»ç»Ÿ NotifySystem ====================

            /**
             * æ™ºèƒ½å¼¹çª—ä¸è­¦ç¤ºç³»ç»Ÿ
             */
            const NotifySystem = {
                // ç”¨äºé˜²æ­¢é‡å¤Toastçš„æ—¶é—´æˆ³è®°å½•
                lastToastTime: {},

                /**
                 * æ˜¾ç¤ºToastè½»æç¤º
                 * @param {string} message - ä¸»è¦æ¶ˆæ¯
                 * @param {string} type - ç±»å‹: 'success', 'error', 'warning', 'info'
                 * @param {string} title - å¯é€‰æ ‡é¢˜
                 * @param {number} duration - æ˜¾ç¤ºæ—¶é•¿(æ¯«ç§’),é»˜è®¤3000
                 */
                showToast: function(message, type = 'info', title = null, duration = 3000) {
                    // é˜²é‡å¤ï¼šåŒä¸€æ ‡é¢˜çš„Toaståœ¨3ç§’å†…ä¸é‡å¤æ˜¾ç¤º
                    const toastKey = title || message;
                    const now = Date.now();
                    if (this.lastToastTime[toastKey] && (now - this.lastToastTime[toastKey] < 3000)) {
                        return;
                    }
                    this.lastToastTime[toastKey] = now;

                    const container = document.getElementById('toast-container');
                    if (!container) {
                        console.error('Toastå®¹å™¨ä¸å­˜åœ¨');
                        return;
                    }

                    // å›¾æ ‡æ˜ å°„
                    const icons = {
                        success: 'âœ…',
                        error: 'âŒ',
                        warning: 'âš ï¸',
                        info: 'â„¹ï¸'
                    };

                    // é»˜è®¤æ ‡é¢˜æ˜ å°„
                    const defaultTitles = {
                        success: 'æ“ä½œæˆåŠŸ',
                        error: 'æ“ä½œå¤±è´¥',
                        warning: 'æ³¨æ„',
                        info: 'æç¤º'
                    };

                    // åˆ›å»ºToastå…ƒç´ 
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;

                    const icon = icons[type] || icons.info;
                    const displayTitle = title || defaultTitles[type] || defaultTitles.info;

                    toast.innerHTML /*XSS-Safe*/ = `
                        <div class="toast-icon">${icon}</div>
                        <div class="toast-content">
                            <div class="toast-title">${displayTitle}</div>
                            <div class="toast-message">${message}</div>
                        </div>
                    `;

                    container.appendChild(toast);

                    // è‡ªåŠ¨ç§»é™¤
                    setTimeout(() => {
                        toast.classList.add('toast-exit');
                        setTimeout(() => {
                            if (toast.parentNode) {
                                container.removeChild(toast);
                            }
                        }, 250);
                    }, duration);
                },

                /**
                 * æ˜¾ç¤ºModalå¼ºè­¦ç¤º
                 * @param {Object} options - é…ç½®é€‰é¡¹
                 * @param {string} options.type - ç±»å‹: 'danger', 'warning', 'success', 'legend'
                 * @param {string} options.icon - emojiå›¾æ ‡
                 * @param {string} options.title - æ ‡é¢˜
                 * @param {string} options.subtitle - å‰¯æ ‡é¢˜(å¯é€‰)
                 * @param {string} options.message - ä¸»è¦æ¶ˆæ¯
                 * @param {string} options.details - è¯¦ç»†ä¿¡æ¯(å¯é€‰)
                 * @param {string} options.buttonText - æŒ‰é’®æ–‡æœ¬
                 * @param {function} options.onConfirm - ç¡®è®¤å›è°ƒ(å¯é€‰)
                 */
                showModal: function(options) {
                    const {
                        type = 'warning',
                        icon = 'âš ï¸',
                        title = 'è­¦å‘Š',
                        subtitle = null,
                        message = '',
                        details = null,
                        buttonText = 'æˆ‘çŸ¥é“äº†',
                        onConfirm = null
                    } = options;

                    // åˆ›å»ºé®ç½©å±‚
                    const overlay = document.createElement('div');
                    overlay.className = 'modal-overlay';

                    // åˆ›å»ºModal
                    const modal = document.createElement('div');
                    modal.className = `modal ${type}`;

                    // æ„å»ºHTML
                    let modalHTML = `
                        <div class="modal-header">
                            <div class="modal-icon">${icon}</div>
                            <div class="modal-title-wrapper">
                                <h3 class="modal-title">${title}</h3>
                                ${subtitle ? `<div class="modal-subtitle">${subtitle}</div>` : ''}
                            </div>
                        </div>
                        <div class="modal-body" style="display: flex; flex-direction: column; flex: 1; overflow: hidden; padding: 15px;">
                            <div class="modal-message">${message}</div>
                            ${details ? `<div class="modal-details">${details}</div>` : ''}
                        </div>
                        <div class="modal-footer">
                            <button class="modal-button modal-button-primary">${buttonText}</button>
                        </div>
                    `;

                    modal.innerHTML /*XSS-Safe*/ = modalHTML;
                    overlay.appendChild(modal);
                    document.body.appendChild(overlay);

                    // å…³é—­Modalçš„å‡½æ•°
                    const closeModal = () => {
                        overlay.classList.add('modal-exit');
                        setTimeout(() => {
                            if (overlay.parentNode) {
                                document.body.removeChild(overlay);
                            }
                        }, 200);

                        // æ‰§è¡Œå›è°ƒ
                        if (onConfirm && typeof onConfirm === 'function') {
                            onConfirm();
                        }
                    };

                    // ç»‘å®šæŒ‰é’®äº‹ä»¶
                    const button = modal.querySelector('.modal-button');
                    if (button) {
                        button.addEventListener('click', closeModal);
                    }

                    // é˜»æ­¢é®ç½©å±‚ç‚¹å‡»å…³é—­(å¿…é¡»ç‚¹æŒ‰é’®)
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            // ä¸åšä»»ä½•äº‹,å¼ºåˆ¶ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
                            return;
                        }
                    });
                },

                /**
                 * è§¦å‘Sysçº¢çº¿è­¦å‘Š
                 */
                triggerSysRedLine: function(sysNetScore) {
                    // æ”¹ä¸ºè½»é‡çº§Toasté€šçŸ¥ï¼Œ5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    this.showToast(
                        `åŸºçŸ³åˆ†æ•°è¿‡ä½ (Sys Net = ${sysNetScore.toFixed(1)} < 12)ï¼Œå»ºè®®æ¬¡æ—¥è¿›å…¥å¤è‹æ¨¡å¼`,
                        'error',
                        'ğŸš¨ è§¦å‘å®‰å…¨ä¿æŠ¤åè®®',
                        5000
                    );
                },

                /**
                 * è§¦å‘è¿‡è½½ç†”æ–­è­¦å‘Š
                 */
                triggerOverloadAlert: function(tpiScore) {
                    this.showModal({
                        type: 'warning',
                        icon: 'ğŸ”¥',
                        title: 'ç³»ç»Ÿè¿‡è½½è­¦ç¤º',
                        subtitle: 'èƒ½è€—å·²è¾¾å±é™©é˜ˆå€¼',
                        message: `ä»Šæ—¥èƒ½è€—å·²è¾¾æé™(TPI = ${tpiScore.toFixed(1)} > 170)ã€‚è¯·ç«‹å³åœæ­¢å·¥ä½œ,é˜²æ­¢æ˜æ—¥ç³»ç»Ÿå´©æºƒã€‚`,
                        details: '<strong>ç†”æ–­æœºåˆ¶:</strong><br>æŒç»­è¿‡è½½ä¼šå¯¼è‡´ç”Ÿç†å‚¨å¤‡æ¯ç«­ã€ç¡çœ è´¨é‡æš´è·Œã€è®¤çŸ¥èƒ½åŠ›ä¸‹é™ã€‚å»ºè®®ç«‹å³è¿›è¡Œè½»åº¦æ´»åŠ¨æˆ–ä¼‘æ¯,é¿å…å¼ºåˆ¶å·¥ä½œã€‚',
                        buttonText: 'ç«‹å³ç†”æ–­',
                        onConfirm: () => {
                        }
                    });
                },

                /**
                 * è§¦å‘å¥–åŠ±æ—¶åˆ»
                 */
                triggerRewardMoment: function(tpiScore, bonusScore) {
                    this.showModal({
                        type: 'legend',
                        icon: 'ğŸ‰',
                        title: 'é‡Œç¨‹ç¢‘è¾¾æˆ',
                        subtitle: 'ä¼ å¥‡çº§è¡¨ç°!',
                        message: `ä»Šæ—¥è¡¨ç°å“è¶Š!TPIæ€»åˆ† ${tpiScore.toFixed(1)}, å¥–åŠ±åˆ† ${bonusScore.toFixed(1)}ã€‚è¯·è®°å½•å½“ä¸‹çš„å¿ƒæµçŠ¶æ€å’Œè§¦å‘æ¡ä»¶,ä½œä¸ºæœªæ¥å¤ç°çš„å‚è€ƒã€‚`,
                        details: '<strong>å»ºè®®è®°å½•:</strong><br>â€¢ ä»Šæ—¥å®Œæˆäº†å“ªäº›é«˜ä»·å€¼ä»»åŠ¡?<br>â€¢ å¿ƒæµçŠ¶æ€æ˜¯å¦‚ä½•è¿›å…¥çš„?<br>â€¢ ç¯å¢ƒ/æ—¶é—´/çŠ¶æ€æœ‰ä»€ä¹ˆç‰¹æ®Šä¹‹å¤„?',
                        buttonText: 'ç»§ç»­ä¿æŒ',
                        onConfirm: () => {
                        }
                    });
                },

                /**
                 * æ£€æŸ¥åˆ†æ•°å¹¶è§¦å‘ç›¸åº”è­¦ç¤º
                 * @param {number} sysNet - Sys Netåˆ†æ•°
                 * @param {number} tpi - TPIæ€»åˆ†
                 * @param {number} bonus - å¥–åŠ±åˆ†
                 */
                checkAndTrigger: function(sysNet, tpi, bonus) {
                    // ä¼˜å…ˆçº§1: Sysçº¢çº¿(æœ€é«˜ä¼˜å…ˆçº§)
                    if (sysNet < 12) {
                        this.triggerSysRedLine(sysNet);
                        return true;
                    }

                    // ä¼˜å…ˆçº§2: è¿‡è½½ç†”æ–­
                    if (tpi > 170) {
                        this.triggerOverloadAlert(tpi);
                        return true;
                    }

                    // ä¼˜å…ˆçº§3: å¥–åŠ±æ—¶åˆ»
                    if (bonus > 5 || tpi > 130) {
                        this.triggerRewardMoment(tpi, bonus);
                        return true;
                    }

                    // æ²¡æœ‰è§¦å‘ä»»ä½•Modal,è¿”å›false
                    return false;
                }
            };

            // ==================== âš ï¸ NotifySystem æ¨¡å—ç»“æŸ ====================
            
            // å°†NotifySystemæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ,ä»¥ä¾¿TPIAdvancedç­‰å¤–éƒ¨æ¨¡å—å¯ä»¥è®¿é—®
            window.NotifySystem = NotifySystem;

            /**
             * æ˜¾ç¤ºé€šçŸ¥(å…¼å®¹æ—§ç‰ˆ,å†…éƒ¨è°ƒç”¨NotifySystem)
             */
            function showNotification(message, type = 'info') {
                // ç›´æ¥è°ƒç”¨æ–°çš„Toastç³»ç»Ÿ
                NotifySystem.showToast(message, type);
            }

            // ==================== æ•°æ®æŒä¹…åŒ– ====================

            /**
             * æ”¶é›†è¡¨å•æ•°æ® (å¢å¼ºæ•°æ®éªŒè¯)
             */
            function collectFormData() {
                // â˜…â˜…â˜… å·®å¼‚36/59ä¿®å¤ï¼šè±å…å¿…å¡«æ ¡éªŒ â˜…â˜…â˜…
                // åœ¨æ”¶é›†æ•°æ®å‰å…ˆæ£€æŸ¥è±å…é¡¹æ˜¯å¦å¡«å†™äº†å¤‡æ³¨
                const exemptionCheckboxes = document.querySelectorAll('input[type="checkbox"]');
                let hasEmptyExemption = false;
                let emptyExemptionNames = [];

                exemptionCheckboxes.forEach(checkbox => {
                    // åªæ£€æŸ¥åŒ…å«"è±å…"å…³é”®å­—çš„checkbox
                    const label = checkbox.parentElement ? checkbox.parentElement.textContent : '';
                    if ((checkbox.name && checkbox.name.includes('exemption')) || label.includes('è±å…')) {
                        if (checkbox.checked) {
                            // æŸ¥æ‰¾å¯¹åº”çš„å¤‡æ³¨æ¡†ï¼ˆåœ¨åŒä¸€ä¸ªsectionå†…ï¼‰
                            const section = checkbox.closest('section');
                            const textarea = section ? section.querySelector('textarea') : null;
                            const noteValue = textarea ? textarea.value.trim() : '';

                            if (!noteValue || noteValue.length < 5) {
                                hasEmptyExemption = true;
                                emptyExemptionNames.push(label.substring(0, 50));
                            }
                        }
                    }
                });

                if (hasEmptyExemption) {
                    const confirmMsg = 'âš ï¸ è±å…å¿…å¡«é¡¹æ£€æŸ¥\n\n' +
                                      'æ‚¨å‹¾é€‰äº†ä»¥ä¸‹è±å…é¡¹ï¼Œä½†æœªå¡«å†™å……åˆ†çš„ç†ç”±ï¼š\n\n' +
                                      emptyExemptionNames.join('\n') +
                                      '\n\næ ¹æ®è§„åˆ™ï¼šå‡¡è±å…å¿…æœ‰å¤‡æ³¨ï¼ˆè‡³å°‘5ä¸ªå­—ï¼‰ï¼\n\n' +
                                      'æ˜¯å¦ä»è¦ç»§ç»­ä¿å­˜ï¼Ÿï¼ˆä¸å»ºè®®ï¼‰';

                    if (!confirm(confirmMsg)) {
                        throw new Error('ç”¨æˆ·å–æ¶ˆä¿å­˜ï¼šè±å…æœªå¡«å†™å¤‡æ³¨');
                    }
                }

                const data = {
                    date: document.getElementById('date-input')?.value || '',
                    timestamp: new Date().toISOString(),
                    version: 'TPI v13 - å¢å¼ºç‰ˆ'
                };

                // éªŒè¯æ—¥æœŸæ ¼å¼
                if (data.date && !/^\d{4}-\d{2}-\d{2}$/.test(data.date)) {
                    console.warn('æ—¥æœŸæ ¼å¼æ— æ•ˆ:', data.date);
                    data.date = '';
                }

                // æ”¶é›†æ‰€æœ‰inputå’Œtextareaçš„å€¼
                const inputs = document.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    try {
                        if (input.id) {
                            if (input.type === 'checkbox') {
                                data[input.id] = input.checked;
                            } else if (input.type === 'radio') {
                                if (input.checked) {
                                    data[input.name] = input.value;
                                }
                            } else {
                                // é™åˆ¶æ–‡æœ¬é•¿åº¦å¹¶æ¸…ç†
                                const value = input.value;
                                if (typeof value === 'string') {
                                    data[input.id] = value.substring(0, 10000);
                                } else {
                                    data[input.id] = value;
                                }
                            }
                        } else if (input.name && !input.id) {
                            if (input.type === 'checkbox') {
                                data[input.name] = input.checked;
                            } else if (input.type === 'radio') {
                                if (input.checked) {
                                    data[input.name] = input.value;
                                }
                            } else {
                                const value = input.value;
                                if (typeof value === 'string') {
                                    data[input.name] = value.substring(0, 10000);
                                } else {
                                    data[input.name] = value;
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('æ”¶é›†æ•°æ®æ—¶å‡ºé”™:', input.id || input.name, e);
                    }
                });

                // æ”¶é›†æ¨¡å¼é€‰æ‹©
                const selectedModeCard = document.querySelector('.mode-card.selected');
                if (selectedModeCard) {
                    const mode = selectedModeCard.id.replace('mode-', '');
                    // éªŒè¯æ¨¡å¼å€¼
                    const validModes = ['normal', 'recovery', 'stoic', 'vacation'];
                    if (validModes.includes(mode)) {
                        data.selectedMode = mode;
                    }
                }

                // æ”¶é›†å‡æœŸæ—¶æ®µé€‰æ‹©
                const vacationPeriods = document.querySelector('input[name="vacation-periods"]:checked');
                if (vacationPeriods) {
                    const periods = safeParseInt(vacationPeriods.value);
                    if (periods >= 1 && periods <= 4) {
                        data.vacationPeriods = periods;
                    }
                }

                // æ”¶é›†è®¡ç®—åçš„åˆ†æ•°
                let tpiTotal = document.getElementById('tpi-total')?.value;
                tpiTotal = Math.max(0, tpiTotal || 0);
                const totalWords = document.getElementById('total-words')?.textContent;
                const totalPages = document.getElementById('total-pages')?.textContent;

               if (tpiTotal) data.tpi = safeParseFloat(tpiTotal);
    if (totalWords) data.totalWords = safeParseInt(totalWords);
    if (totalPages) data.totalPages = safeParseInt(totalPages);

    // [ç¬¬ 20 ç‰ˆ.2 æ–°å¢] é›†æˆæœªæ¥äº‹ä»¶é›·è¾¾æ•°æ®åˆ°äº‘ç«¯åŒæ­¥åŒ…
    try {
        const radarData = localStorage.getItem('tpi_radar_events_v3');
        if (radarData) {
            data.futureRadarV3 = JSON.parse(radarData);
        }
    } catch (e) {
        console.warn('é›·è¾¾æ•°æ®æ‰“åŒ…å¤±è´¥:', e);
    }

    // [è‰ç¨¿75 Patch] é›†æˆæœªæ¥äº‹ä»¶é›·è¾¾è®¾ç½®åˆ°äº‘ç«¯åŒæ­¥åŒ…
    try {
        const radarPushConfig = localStorage.getItem('tpi_radar_push_config');
        if (radarPushConfig) {
            data.futureRadarPushConfig = JSON.parse(radarPushConfig);
        }
    } catch (e) {
        console.warn('é›·è¾¾è®¾ç½®æ‰“åŒ…å¤±è´¥:', e);
    }

    // [è‰ç¨¿52+] é›†æˆæ‚äº‹è®°å½•æ•°æ®åˆ°äº‘ç«¯åŒæ­¥åŒ…ï¼ˆæŒ‰æ—¥æœŸå­˜å‚¨ï¼‰
    try {
        const _dateForMisc = (typeof window.__tpi_getSelectedDate === 'function')
            ? window.__tpi_getSelectedDate()
            : (document.getElementById('date-input')?.value || new Date().toISOString().split('T')[0]);
        const miscRaw = localStorage.getItem('tpi_misc_records_' + _dateForMisc);
        if (miscRaw) {
            data.miscRecordsV1 = JSON.parse(miscRaw);
        }
    } catch (e) {
        console.warn('æ‚äº‹è®°å½•æ‰“åŒ…å¤±è´¥:', e);
    }

    return data;
}

            /**
             * æ¢å¤è¡¨å•æ•°æ® (å¢å¼ºå®‰å…¨éªŒè¯)
             */
            function restoreFormData(data) {
                try {
                    // éªŒè¯æ•°æ®ç±»å‹
                    if (!data || typeof data !== 'object') {
                        throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                    }

                    Object.keys(data).forEach(key => {
                        // è·³è¿‡ç‰¹æ®Šå­—æ®µ
                        if (key === 'timestamp' || key === 'version' || key === 'tpi' || key === 'totalWords' || key === 'totalPages') return;

                        // è¿‡æ»¤æ½œåœ¨çš„å±é™©é”®å
                        if (key.includes('<') || key.includes('>') || key.includes('script')) {
                            console.warn('è·³è¿‡å¯ç–‘çš„é”®å:', key);
                            return;
                        }

                        // å¤„ç†æ¨¡å¼é€‰æ‹©
                        if (key === 'selectedMode') {
                            const sanitizedMode = String(data[key]).replace(/[<>]/g, '');
                            selectMode(sanitizedMode);
                            return;
                        }

                        if (key === 'vacationPeriods') {
                            const periods = safeParseInt(data[key]);
                            if (periods >= 1 && periods <= 4) {
                                updateVacationTarget(periods);
                                const radio = document.querySelector(`input[name="vacation-periods"][value="${periods}"]`);
                                if (radio) radio.checked = true;
                            }
                            return;
                        }

                        const element = document.getElementById(key);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = Boolean(data[key]);
                            } else if (element.type === 'radio') {
                                const sanitizedValue = String(data[key]).replace(/[<>"']/g, '');
                                const radio = document.querySelector(`input[name="${key}"][value="${sanitizedValue}"]`);
                                if (radio) radio.checked = true;
                            } else {
                                // æ¸…ç†è¾“å…¥å€¼
                                const sanitizedValue = String(data[key] || '').substring(0, 10000); // é™åˆ¶é•¿åº¦
                                element.value = sanitizedValue;
                            }
                        } else {
                            // å°è¯•é€šè¿‡nameæŸ¥æ‰¾
                            const elements = document.querySelectorAll(`[name="${key}"]`);
                            elements.forEach(el => {
                                if (el.type === 'checkbox') {
                                    el.checked = Boolean(data[key]);
                                } else if (el.type === 'radio') {
                                    const sanitizedValue = String(data[key]).replace(/[<>"']/g, '');
                                    if (el.value === sanitizedValue) {
                                        el.checked = true;
                                    }
                                } else {
                                    const sanitizedValue = String(data[key] || '').substring(0, 10000);
                                  el.value = sanitizedValue;
            }
        });
    }
});

// [ç¬¬ 20 ç‰ˆ.2 æ–°å¢] æ¢å¤æœªæ¥äº‹ä»¶é›·è¾¾æ•°æ®
if (data.futureRadarV3) {
    localStorage.setItem('tpi_radar_events_v3', JSON.stringify(data.futureRadarV3));
    if (window.FutureRadar) {
        window.__tpi_safeReloadFutureRadar();
    }
}

// [è‰ç¨¿75 Patch] æ¢å¤æœªæ¥äº‹ä»¶é›·è¾¾è®¾ç½®ï¼ˆPushPlusé…ç½®ç­‰ï¼‰
if (data.futureRadarPushConfig) {
    try {
        localStorage.setItem('tpi_radar_push_config', JSON.stringify(data.futureRadarPushConfig));
        if (window.FutureRadar) {
            window.FutureRadar.pushConfig = data.futureRadarPushConfig;
        }
        console.log('âœ… é›·è¾¾è®¾ç½®å·²æ¢å¤');
    } catch (e) {
        console.warn('é›·è¾¾è®¾ç½®æ¢å¤å¤±è´¥:', e);
    }
}

// [è‰ç¨¿52+] æ¢å¤æ‚äº‹è®°å½•æ•°æ®ï¼ˆæŒ‰æ—¥æœŸå­˜å‚¨ï¼‰
try {
    const _dateForMiscRestore = (data && data["date-input"])
        ? String(data["date-input"])
        : ((typeof window.__tpi_getSelectedDate === 'function') ? window.__tpi_getSelectedDate()
            : (document.getElementById('date-input')?.value || new Date().toISOString().split('T')[0]));
    if (data && data.miscRecordsV1) {
        localStorage.setItem('tpi_misc_records_' + _dateForMiscRestore, JSON.stringify(data.miscRecordsV1));
        // åŒæ­¥éšè—å­—æ®µï¼Œç¡®ä¿åç»­å†åŒæ­¥/å¯¼å‡ºå¯æ•è·
        const hidden = document.getElementById('misc-records-json');
        if (hidden) hidden.value = JSON.stringify(data.miscRecordsV1);
        if (window.MiscLog && typeof window.MiscLog.render === 'function') {
            window.MiscLog.render();
        }
    }
} catch (e) {
    console.warn('æ‚äº‹è®°å½•æ¢å¤å¤±è´¥:', e);
}
                } catch (error) {
                    console.error('æ¢å¤æ•°æ®é”™è¯¯:', error);
                    throw error;
                }
            }

            /**
             * ä¿å­˜åˆ°localStorage (å¢å¼ºé”™è¯¯å¤„ç†å’Œæ•°æ®éªŒè¯)
             */
            /**
             * å·®å¼‚24/36ä¿®å¤ï¼šè±å…ç†ç”±å¿…å¡«é¡¹æ ¡éªŒ
             */
            function validateExemptionReasons() {
                const exemptionCheckboxes = document.querySelectorAll(
                    'input[name="exemption-a"], input[name="exemption-b"]'
                );

                for (let checkbox of exemptionCheckboxes) {
                    if (checkbox.checked) {
                        // æŸ¥æ‰¾å¯¹åº”çš„å¤‡æ³¨æ¡†
                        const row = checkbox.closest('tr') || checkbox.closest('.row') || checkbox.closest('.form-group');
                        const reasonField = row?.querySelector('textarea[aria-label*="å¤‡æ³¨"], textarea[placeholder*="å¤‡æ³¨"]');

                        if (!reasonField || !reasonField.value || reasonField.value.trim() === '') {
                            // é«˜äº®æ˜¾ç¤ºç¼ºå¤±çš„å¤‡æ³¨æ¡†
                            if (reasonField) {
                                reasonField.style.border = '2px solid #dc2626';
                                reasonField.style.backgroundColor = '#fee';
                                reasonField.placeholder = 'âš ï¸ è±å…å¿…é¡»å¡«å†™ç†ç”±ï¼';
                            }

                            showNotification(
                                'âš ï¸ è±å…å¿…å¡«é¡¹æ£€æŸ¥å¤±è´¥\n\næ‚¨å‹¾é€‰äº†è±å…ï¼Œä½†æœªå¡«å†™ç†ç”±ã€‚\n\nè¯·åœ¨å¤‡æ³¨æ è¯´æ˜è±å…åŸå› åå†ä¿å­˜ã€‚',
                                'warning'
                            );

                            // æ»šåŠ¨åˆ°è¯¥ä½ç½®
                            if (reasonField) {
                                reasonField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                setTimeout(() => reasonField.focus(), 300);
                            }

                            console.warn(`[å·®å¼‚24/36] è±å…ç†ç”±ç¼ºå¤±: ${checkbox.name}`);
                            return false;
                        } else {
                            // æ¢å¤æ­£å¸¸æ ·å¼
                            if (reasonField) {
                                reasonField.style.border = '';
                                reasonField.style.backgroundColor = '';
                            }
                        }
                    }
                }

                return true;
            }

            function saveToLocalStorage() {
                // å·®å¼‚24/36ä¿®å¤ï¼šè±å…ç†ç”±å¿…å¡«é¡¹æ ¡éªŒ
                if (!validateExemptionReasons()) {
                    console.warn('[å·®å¼‚24/36] è±å…ç†ç”±æ ¡éªŒå¤±è´¥ï¼Œå·²æ‹¦æˆªä¿å­˜');
                    return;
                }

                try {
                    const data = collectFormData();
                    const dateInput = document.getElementById('date-input')?.value;

                    // éªŒè¯æ—¥æœŸ
                    if (!dateInput) {
                        throw new Error('æ—¥æœŸä¸èƒ½ä¸ºç©º');
                    }

                    // v15: æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯å’Œæ—¶é—´æˆ³
                    data.version = window.TPI_DATA_VERSION || '1.0';
                    data.lastModified = new Date().toISOString();

                    const key = `tpi_data_${dateInput}`;

                    // éªŒè¯æ•°æ®å¤§å°ï¼ˆlocalStorageé™åˆ¶é€šå¸¸ä¸º5-10MBï¼‰
                    const dataStr = JSON.stringify(data);
                    if (dataStr.length > 5000000) { // 5MBé™åˆ¶
                        throw new Error('æ•°æ®è¿‡å¤§ï¼Œæ— æ³•ä¿å­˜');
                    }

                    /* å·²æ·»åŠ é”™è¯¯å¤„ç† */ localStorage.setItem(key, dataStr);
                    state.formData = data;

                    // v15: æ›´æ–°å­˜å‚¨ç©ºé—´æŒ‡ç¤ºå™¨
                    updateStorageIndicator();

                    // v15: è®°å½•ç”¨æˆ·æ“ä½œ
                    logUserAction('ä¿å­˜åˆ°æœ¬åœ°', { date: dateInput });

                    // ä¿å­˜åˆ°å†å²è®°å½•
                    const historyKey = 'tpi_history';
                    let history = [];

                    try {
                        const historyStr = localStorage.getItem(historyKey);
                        history = historyStr ? JSON.parse(historyStr) : [];
                        // éªŒè¯å†å²æ•°æ®æ˜¯å¦ä¸ºæ•°ç»„
                        if (!Array.isArray(history)) {
                            history = [];
                        }
                    } catch (e) {
                        console.warn('å†å²æ•°æ®è§£æå¤±è´¥ï¼Œå°†é‡æ–°åˆ›å»º', e);
                        history = [];
                    }

                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥æ—¥æœŸçš„è®°å½•
                    const existingIndex = history.findIndex(item => item.date === data.date);
                    const historyEntry = {
                        date: data.date,
                        timestamp: data.timestamp,
                        tpi: safeParseFloat(document.getElementById('tpi-total')?.value || 0),
                        totalWords: data.totalWords || 0,
                        totalPages: data.totalPages || 0
                    };

                    if (existingIndex >= 0) {
                        history[existingIndex] = historyEntry;
                    } else {
                        history.push(historyEntry);
                    }

                    // æŒ‰æ—¥æœŸæ’åº
                    history.sort((a, b) => new Date(a.date) - new Date(b.date));

                    // åªä¿ç•™æœ€è¿‘365æ¡è®°å½•
                    if (history.length > 365) {
                        history = history.slice(-365);
                    }

                    localStorage.setItem(historyKey, JSON.stringify(history));

                    // æ›´æ–°å­˜å‚¨é”®æ˜¾ç¤º
                    const storageKeyElem = document.getElementById('storage-key');
                    if (storageKeyElem) {
                        storageKeyElem.textContent = key;
                    }

                    // å¢å¼ºçš„æˆåŠŸæç¤º
                    const tpiScore = document.getElementById('tpi-total-score')?.textContent || '0';
                    const rating = document.getElementById('tpi-rating')?.value || 'F';

                    showModal({
                        type: 'success',
                        title: 'ğŸ’¾ æ•°æ®ä¿å­˜æˆåŠŸï¼',
                        message: `
                            <div style="text-align: left;">
                                <div style="margin: 15px 0; padding: 15px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 8px;">
                                    <p style="margin: 0;"><strong>âœ… æœ¬åœ°ä¿å­˜å®Œæˆ</strong></p>
                                    <ul style="margin: 10px 0 0 0; padding-left: 20px; font-size: 0.95em;">
                                        <li>æ—¥æœŸï¼š${dateInput}</li>
                                        <li>TPIåˆ†æ•°ï¼š${tpiScore}</li>
                                        <li>ç­‰çº§ï¼š${rating}</li>
                                        <li>æ—¶é—´ï¼š${new Date().toLocaleTimeString('zh-CN')}</li>
                                    </ul>
                                </div>

                                <p style="color: #6b7280; font-size: 0.9em; margin: 10px 0;">
                                    ğŸ’¡ æ•°æ®å·²ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ã€‚
                                </p>

                                ${getStoragePercentage() > 80 ? `
                                <div style="margin: 10px 0; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
                                    <p style="margin: 0; font-size: 0.9em;">
                                        âš ï¸ <strong>å­˜å‚¨ç©ºé—´æé†’ï¼š</strong>å½“å‰ä½¿ç”¨ ${getStoragePercentage().toFixed(1)}%ï¼Œå»ºè®®åŠæ—¶å¤‡ä»½æ•°æ®ã€‚
                                    </p>
                                </div>
                                ` : ''}

                                <div style="margin-top: 15px; display: flex; gap: 10px;">
                                    <button onclick="exportAllData()" class="modal-button" style="flex: 1; background: #6b7280; color: white;">
                                        å¯¼å‡ºå¤‡ä»½
                                    </button>
                                    <button onclick="closeAllModals();goToCloudSync();" class="modal-button" style="flex: 1; background: #3b82f6; color: white;">
                                        GitHubäº‘ç«¯åŒæ­¥
                                    </button>
                                </div>
                            </div>
                        `,
                        confirmText: 'çŸ¥é“äº†',
                        autoClose: 3000 // 3ç§’åè‡ªåŠ¨å…³é—­
                    });

                    // æ›´æ–°ç»Ÿè®¡æ•°æ®
                    updateStatistics();

                } catch (error) {
                    console.error('ä¿å­˜é”™è¯¯:', error);
                    if (error.name === 'QuotaExceededError') {
                        showNotification('âŒ å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œè¯·æ¸…ç†æ—§æ•°æ®', 'error');
                    } else {
                        showNotification('âŒ ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                    }
                }
            }

            // è¾…åŠ©å‡½æ•°ï¼šè·å–å­˜å‚¨ç©ºé—´ä½¿ç”¨ç™¾åˆ†æ¯”
            function getStoragePercentage() {
                try {
                    let totalSize = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            totalSize += localStorage[key].length + key.length;
                        }
                    }
                    const sizeInMB = totalSize / (1024 * 1024);
                    const maxSize = 5;
                    return (sizeInMB / maxSize) * 100;
                } catch (e) {
                    return 0;
                }
            }

            /**
             * ä»localStorageåŠ è½½ (å¢å¼ºæ•°æ®éªŒè¯)
             */
            function loadFromLocalStorage() {
                try {
                    const dateInput = document.getElementById('date-input')?.value;
                    if (!dateInput) {
                        showNotification('âš ï¸ è¯·å…ˆé€‰æ‹©æ—¥æœŸ', 'warning');
                        return;
                    }

                    const key = `tpi_data_${dateInput}`;
                    const dataStr = localStorage.getItem(key);

                    if (!dataStr) {
                        showNotification('âŒ æœªæ‰¾åˆ°è¯¥æ—¥æœŸçš„ä¿å­˜æ•°æ®', 'error');
                        return;
                    }

                    // éªŒè¯JSONæ ¼å¼
                    let data;
                    try {
                        data = JSON.parse(dataStr);
                    } catch (e) {
                        throw new Error('æ•°æ®æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æ');
                    }

                    // éªŒè¯æ•°æ®ç»“æ„
                    if (!data || typeof data !== 'object') {
                        throw new Error('æ•°æ®ç»“æ„æ— æ•ˆ');
                    }

                    // v15: æ•°æ®ç‰ˆæœ¬è¿ç§»
                    data = migrateDataIfNeeded(data);

                    restoreFormData(data);
                    state.formData = data;

                    // é‡æ–°è®¡ç®—æ‰€æœ‰åˆ†æ•°
                    setTimeout(() => {
                        calculateAllScores();
                    }, 100);

                    showNotification('âœ… æ•°æ®åŠ è½½æˆåŠŸï¼', 'success');

                    // v15: è®°å½•æ“ä½œ
                    logUserAction('ä»æœ¬åœ°åŠ è½½', { date: dateInput });
                } catch (error) {
                    console.error('åŠ è½½é”™è¯¯:', error);
                    showNotification('âŒ åŠ è½½å¤±è´¥: ' + error.message, 'error');
                }
            }

            // ==================== æ•°æ®å¯¼å‡ºåŠŸèƒ½ ====================
// ==================== Firebase äº‘ç«¯åŒæ­¥åŠŸèƒ½å·²ç§»é™¤ ====================
            // FirebaseåŒæ­¥åŠŸèƒ½å·²å®Œå…¨ç§»é™¤ï¼Œç°åœ¨ä½¿ç”¨GitHubä½œä¸ºå”¯ä¸€äº‘ç«¯åŒæ­¥æ–¹å¼
            // è¯·ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥æ¨¡å—è¿›è¡Œæ•°æ®åŒæ­¥
            
            /**
             * saveToFirebase - å·²åºŸå¼ƒï¼Œä¿ç•™ç©ºå‡½æ•°ä»¥é˜²æ­¢å¼•ç”¨é”™è¯¯
             */
            function saveToFirebase() {
                console.warn('[å·²åºŸå¼ƒ] FirebaseåŒæ­¥å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥');
                showNotification('âš ï¸ FirebaseåŒæ­¥å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥åŠŸèƒ½', 'warning');
            }

            /**
             * loadFromFirebase - å·²åºŸå¼ƒï¼Œä¿ç•™ç©ºå‡½æ•°ä»¥é˜²æ­¢å¼•ç”¨é”™è¯¯
             */
            function loadFromFirebase() {
                console.warn('[å·²åºŸå¼ƒ] FirebaseåŒæ­¥å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥');
                showNotification('âš ï¸ FirebaseåŒæ­¥å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥åŠŸèƒ½', 'warning');
            }
            /**
             * å¯¼å‡ºæ•°æ® (å¢å¼ºæ–‡ä»¶åå®‰å…¨æ€§)
             */
            function exportData(format = 'json', period = 'day') {
                try {
                    let dataToExport;
                    let filename;

                    if (period === 'day') {
                        // å¯¼å‡ºå•æ—¥æ•°æ®
                        const currentData = collectFormData();
                        dataToExport = [currentData];
                        filename = `TPI_${currentData.date || 'export'}`;
                    } else {
                        // å¯¼å‡ºå‘¨æœŸæ•°æ®
                        const dateRange = getDateRange(period);
                        dataToExport = getDateRangeData(formatDate(dateRange.start), formatDate(dateRange.end));
                        filename = `TPI_${period}_${formatDate(dateRange.start)}_${formatDate(dateRange.end)}`;
                    }

                    // æ¸…ç†æ–‡ä»¶åï¼Œé˜²æ­¢è·¯å¾„éå†
                    filename = sanitizeFilename(filename);

                    if (dataToExport.length === 0) {
                        showNotification('âŒ æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                        return;
                    }

                    // éªŒè¯æ ¼å¼å‚æ•°
                    const validFormats = ['json', 'excel', 'markdown', 'csv'];
                    if (!validFormats.includes(format)) {
                        format = 'json';
                    }

                    switch(format) {
                        case 'json':
                            exportAsJSON(dataToExport, filename);
                            break;
                        case 'excel':
                            exportAsExcel(dataToExport, filename);
                            break;
                        case 'markdown':
                            exportAsMarkdown(dataToExport, filename);
                            break;
                        case 'csv':
                            exportAsCSV(dataToExport, filename);
                            break;
                        default:
                            exportAsJSON(dataToExport, filename);
                    }

                } catch (error) {
                    console.error('å¯¼å‡ºé”™è¯¯:', error);
                    showNotification('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
                }
            }

            /**
             * æ¸…ç†æ–‡ä»¶åï¼Œé˜²æ­¢è·¯å¾„éå†
             */
            function sanitizeFilename(filename) {
                // ç§»é™¤è·¯å¾„åˆ†éš”ç¬¦å’Œç‰¹æ®Šå­—ç¬¦
                return filename
                    .replace(/[\/\\:*?"<>|]/g, '_')
                    .replace(/\.\./g, '_')
                    .substring(0, 255); // é™åˆ¶æ–‡ä»¶åé•¿åº¦
            }

            /**
             * æŒ‰å‘¨æœŸå¯¼å‡º
             */
            function exportByPeriod(period) {
                console.log('[DataExport] æŒ‰å‘¨æœŸå¯¼å‡ºè¢«è°ƒç”¨ï¼Œå‘¨æœŸ:', period);
                const format = 'excel'; // é»˜è®¤å¯¼å‡ºExcelæ ¼å¼
                console.log('[DataExport] å¯¼å‡ºæ ¼å¼:', format);
                exportData(format, period);
            }

            /**
             * å¯¼å‡ºè‡ªå®šä¹‰æ—¥æœŸèŒƒå›´ (å¢å¼ºæ—¥æœŸéªŒè¯)
             */
            function exportCustomRange() {
                const startDate = document.getElementById('export-start-date')?.value;
                const endDate = document.getElementById('export-end-date')?.value;

                if (!startDate || !endDate) {
                    showNotification('âš ï¸ è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ', 'warning');
                    return;
                }

                // éªŒè¯æ—¥æœŸæ ¼å¼
                const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                if (!datePattern.test(startDate) || !datePattern.test(endDate)) {
                    showNotification('âŒ æ—¥æœŸæ ¼å¼æ— æ•ˆ', 'error');
                    return;
                }

                // éªŒè¯æ—¥æœŸé€»è¾‘
                const start = new Date(startDate);
                const end = new Date(endDate);

                if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                    showNotification('âŒ æ—¥æœŸæ— æ•ˆ', 'error');
                    return;
                }

                if (start > end) {
                    showNotification('âŒ å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ', 'error');
                    return;
                }

                try {
                    const dataToExport = getDateRangeData(startDate, endDate);

                    if (dataToExport.length === 0) {
                        showNotification('âŒ è¯¥æ—¥æœŸèŒƒå›´å†…æ²¡æœ‰æ•°æ®', 'error');
                        return;
                    }

                    const filename = sanitizeFilename(`TPI_${startDate}_${endDate}`);
                    exportAsExcel(dataToExport, filename);

                } catch (error) {
                    console.error('å¯¼å‡ºé”™è¯¯:', error);
                    showNotification('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
                }
            }

            /**
             * å¯¼å‡ºä¸ºJSON
             */
            function exportAsJSON(data, filename) {
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                a.rel = 'noopener';
                document.body.appendChild(a);

                // å…¼å®¹éƒ¨åˆ†æµè§ˆå™¨ï¼šå»¶å revokeï¼Œé¿å…â€œæ§åˆ¶å°æ˜¾ç¤ºæˆåŠŸä½†æœªçœŸæ­£ä¸‹è½½â€
                a.click();
                document.body.removeChild(a);
                setTimeout(() => {
                    try { URL.revokeObjectURL(url); } catch (_) {}
                }, 1200);

                showNotification('âœ… æ•°æ®å·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶ï¼', 'success');
            }

            /**
             * å¯¼å‡ºä¸ºExcel
             */
            function exportAsExcel(data, filename) {
                try {
                    // å‡†å¤‡å·¥ä½œè¡¨æ•°æ®
                    const wsData = [];

                    // æ·»åŠ æ ‡é¢˜è¡Œ
                    if (data.length > 0) {
                        const firstRow = data[0];
                        const headers = Object.keys(firstRow);
                        wsData.push(headers);

                        // æ·»åŠ æ•°æ®è¡Œ
                        data.forEach(item => {
                            const row = headers.map(header => item[header] || '');
                            wsData.push(row);
                        });
                    }

                    // åˆ›å»ºå·¥ä½œç°¿å’Œå·¥ä½œè¡¨
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'TPIæ•°æ®');

                    // ç”ŸæˆExcelæ–‡ä»¶
                    XLSX.writeFile(wb, `${filename}.xlsx`);

                    showNotification('âœ… æ•°æ®å·²å¯¼å‡ºä¸ºExcelæ–‡ä»¶ï¼', 'success');
                } catch (error) {
                    console.error('Excelå¯¼å‡ºé”™è¯¯:', error);
                    showNotification('âŒ Excelå¯¼å‡ºå¤±è´¥', 'error');
                }
            }

            /**
             * å¯¼å‡ºä¸ºMarkdown
             */
            function exportAsMarkdown(data, filename) {
                let mdContent = `# TPIæ•°æ®æŠ¥å‘Š\n\n`;
                mdContent += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n`;
                mdContent += `è®°å½•æ•°é‡: ${data.length}\n\n`;

                // æ·»åŠ è¡¨æ ¼
                if (data.length > 0) {
                    const headers = Object.keys(data[0]);

                    // è¡¨å¤´
                    mdContent += '| ' + headers.join(' | ') + ' |\n';
                    mdContent += '|' + headers.map(() => '---').join('|') + '|\n';

                    // æ•°æ®è¡Œ
                    data.forEach(item => {
                        const row = headers.map(header => {
                            const value = item[header];
                            return value !== undefined ? String(value) : '';
                        });
                        mdContent += '| ' + row.join(' | ') + ' |\n';
                    });
                }

                const blob = new Blob([mdContent], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.md`;
                a.rel = 'noopener';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => { try { URL.revokeObjectURL(url); } catch (_) {} }, 1200);

                showNotification('âœ… æ•°æ®å·²å¯¼å‡ºä¸ºMarkdownæ–‡ä»¶ï¼', 'success');
            }

            /**
             * å¯¼å‡ºä¸ºCSV
             */
            function exportAsCSV(data, filename) {
                if (data.length === 0) {
                    showNotification('âŒ æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'error');
                    return;
                }

                const headers = Object.keys(data[0]);
                const csvRows = [];

                // æ·»åŠ æ ‡é¢˜è¡Œ
                csvRows.push(headers.join(','));

                // æ·»åŠ æ•°æ®è¡Œ
                data.forEach(item => {
                    const row = headers.map(header => {
                        const value = item[header];
                        // å¤„ç†åŒ…å«é€—å·æˆ–å¼•å·çš„å€¼
                        const stringValue = value !== undefined ? String(value) : '';
                        if (stringValue.includes(',') || stringValue.includes('"')) {
                            return `"${stringValue.replace(/"/g, '""')}"`;
                        }
                        return stringValue;
                    });
                    csvRows.push(row.join(','));
                });

                const csvContent = csvRows.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('âœ… æ•°æ®å·²å¯¼å‡ºä¸ºCSVæ–‡ä»¶ï¼', 'success');
            }

            /**
             * å¯¼å…¥æ•°æ®
             */
            function importData() {
                const fileInput = document.getElementById('import-file');
                if (!fileInput || !fileInput.files.length) {
                    showNotification('âš ï¸ è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶', 'warning');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        let data;

                        // æ ¹æ®æ–‡ä»¶ç±»å‹è§£æ
                        if (file.name.endsWith('.json')) {
                            data = JSON.parse(content);
                        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                            // è§£æExcelæ–‡ä»¶
                            const workbook = XLSX.read(content, { type: 'binary' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(worksheet);
                        } else if (file.name.endsWith('.csv')) {
                            // ç®€å•CSVè§£æ
                            const lines = content.split('\n');
                            const headers = lines[0].split(',');
                            data = lines.slice(1).map(line => {
                                const values = line.split(',');
                                const obj = {};
                                headers.forEach((header, index) => {
                                    obj[header.trim()] = values[index] ? values[index].trim() : '';
                                });
                                return obj;
                            }).filter(item => Object.keys(item).length > 0);
                        } else if (file.name.endsWith('.md')) {
                            // ç®€å•Markdownè¡¨æ ¼è§£æ
                            const lines = content.split('\n');
                            const tableStart = lines.findIndex(line => line.trim().startsWith('|'));
                            if (tableStart >= 0) {
                                const headers = lines[tableStart].split('|').slice(1, -1).map(h => h.trim());
                                data = lines.slice(tableStart + 2).map(line => {
                                    const values = line.split('|').slice(1, -1).map(v => v.trim());
                                    if (values.length === headers.length) {
                                        const obj = {};
                                        headers.forEach((header, index) => {
                                            obj[header] = values[index];
                                        });
                                        return obj;
                                    }
                                    return null;
                                }).filter(item => item !== null);
                            }
                        } else {
                            showNotification('âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼', 'error');
                            return;
                        }

                        if (!Array.isArray(data)) {
                            data = [data];
                        }

                        // å¯¼å…¥æ•°æ®
                        if (data.length > 0 && data[0].date) {
                            // å¦‚æœæ˜¯å¤šæ—¥æ•°æ®ï¼Œæç¤ºç”¨æˆ·
                            if (data.length > 1) {
                                if (confirm(`æ‰¾åˆ° ${data.length} æ¡è®°å½•ï¼Œæ˜¯å¦å…¨éƒ¨å¯¼å…¥ï¼Ÿ`)) {
                                    data.forEach(item => {
                                        if (item.date) {
                                            const key = `tpi_data_${item.date}`;
                                            localStorage.setItem(key, JSON.stringify(item));
                                        }
                                    });
                                    showNotification(`âœ… æˆåŠŸå¯¼å…¥ ${data.length} æ¡è®°å½•`, 'success');
                                }
                            } else {
                                // å•æ—¥æ•°æ®ï¼Œç›´æ¥åŠ è½½
                                restoreFormData(data[0]);

                                // é‡æ–°è®¡ç®—æ‰€æœ‰åˆ†æ•°
                                setTimeout(() => {
                                    calculateAllScores();
                                }, 100);

                                showNotification('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼', 'success');
                            }
                        } else {
                            showNotification('âŒ æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                        }

                    } catch (error) {
                        console.error('å¯¼å…¥é”™è¯¯:', error);
                        showNotification('âŒ å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼å¯èƒ½ä¸æ­£ç¡®', 'error');
                    }
                };

                reader.onerror = function() {
                    showNotification('âŒ è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
                };

                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    reader.readAsBinaryString(file);
                } else {
                    reader.readAsText(file);
                }
            }

            /**
             * å¤‡ä»½æ‰€æœ‰æ•°æ®
             */
            function backupAllData() {
                console.log('[DataProcessing] å¤‡ä»½æ‰€æœ‰æ•°æ®è¢«è°ƒç”¨');
                
                try {
                    // æ”¶é›†æ‰€æœ‰æ•°æ®
                    const allData = [];
                    const keys = Object.keys(localStorage);

                    keys.forEach(key => {
                        if (key.startsWith('tpi_data_v14_final__v14_final_')) {
                            try {
                                const data = JSON.parse(localStorage.getItem(key));
                                if (data && data.date) {
                                    allData.push(data);
                                }
                            } catch (e) {
                                console.warn(`è§£æ ${key} å¤±è´¥:`, e);
                            }
                        }
                    });

                    console.log('[DataProcessing] æ”¶é›†åˆ°', allData.length, 'æ¡æ•°æ®');

                    // å¯¼å‡ºå¤‡ä»½
                    const filename = `TPI_Backup_${formatDate(new Date())}`;
                    console.log('[DataProcessing] å¯¼å‡ºå¤‡ä»½æ–‡ä»¶:', filename);
                    exportAsJSON(allData, filename);
                    console.log('[DataProcessing] å¤‡ä»½å®Œæˆ');

                } catch (error) {
                    console.error('[DataProcessing] å¤‡ä»½é”™è¯¯:', error);
                    showNotification('âŒ å¤‡ä»½å¤±è´¥', 'error');
                }
            }

            /**
             * æ¢å¤å¤‡ä»½
             */
            function restoreBackup() {
                console.log('[DataProcessing] æ¢å¤å¤‡ä»½è¢«è°ƒç”¨');
                
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';

                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) {
                        console.log('[DataProcessing] æœªé€‰æ‹©æ–‡ä»¶');
                        return;
                    }

                    console.log('[DataProcessing] è¯»å–å¤‡ä»½æ–‡ä»¶:', file.name);
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);

                            if (!Array.isArray(data)) {
                                console.error('[DataProcessing] å¤‡ä»½æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                                showNotification('âŒ å¤‡ä»½æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®', 'error');
                                return;
                            }

                            console.log('[DataProcessing] å¤‡ä»½æ–‡ä»¶åŒ…å«', data.length, 'æ¡è®°å½•');

                            if (confirm(`å‡†å¤‡æ¢å¤ ${data.length} æ¡è®°å½•ï¼Œè¿™å°†è¦†ç›–ç°æœ‰æ•°æ®ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`)) {
                                console.warn('[DataProcessing] ç”¨æˆ·ç¡®è®¤æ¢å¤å¤‡ä»½');
                                
                                // æ¸…é™¤ç°æœ‰TPIæ•°æ®
                                const keys = Object.keys(localStorage);
                                keys.forEach(key => {
                                    if (key.startsWith('tpi_data_v14_final__v14_final_')) {
                                        localStorage.removeItem(key);
                                    }
                                });

                                // æ¢å¤å¤‡ä»½æ•°æ®
                                data.forEach(item => {
                                    if (item.date) {
                                        const key = `tpi_data_${item.date}`;
                                        localStorage.setItem(key, JSON.stringify(item));
                                    }
                                });

                                console.log('[DataProcessing] æ¢å¤å®Œæˆï¼Œæ¢å¤äº†', data.length, 'æ¡è®°å½•');
                                showNotification(`âœ… æˆåŠŸæ¢å¤ ${data.length} æ¡è®°å½•`, 'success');

                                // æ›´æ–°ç»Ÿè®¡
                                updateStatistics();
                            } else {
                                console.log('[DataProcessing] ç”¨æˆ·å–æ¶ˆæ¢å¤æ“ä½œ');
                            }

                        } catch (error) {
                            console.error('[DataProcessing] æ¢å¤å¤‡ä»½é”™è¯¯:', error);
                            showNotification('âŒ æ¢å¤å¤‡ä»½å¤±è´¥', 'error');
                        }
                    };

                    reader.readAsText(file);
                };

                fileInput.click();
            }

            /**
             * é‡ç½®è¡¨å•
             */
            function resetForm() {
                console.log('[DataProcessing] é‡ç½®è¡¨å•è¢«è°ƒç”¨');
                
                if (!confirm('âš ï¸ ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    console.log('[DataProcessing] ç”¨æˆ·å–æ¶ˆé‡ç½®æ“ä½œ');
                    return;
                }

                console.warn('[DataProcessing] ç”¨æˆ·ç¡®è®¤é‡ç½®è¡¨å•');

                try {
                    // é‡ç½®æ‰€æœ‰è¾“å…¥å­—æ®µ
                    document.querySelectorAll('input:not([type="button"]):not([type="submit"])').forEach(input => {
                        if (input.type === 'checkbox' || input.type === 'radio') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });

                    document.querySelectorAll('textarea').forEach(textarea => {
                        textarea.value = '';
                    });

                    document.querySelectorAll('select').forEach(select => {
                        select.selectedIndex = 0;
                    });

                    // é‡ç½®æ¨¡å¼é€‰æ‹©
                    document.querySelectorAll('.mode-card').forEach(card => {
                        card.classList.remove('selected');
                    });

                    const vacationDetails = document.getElementById('vacation-details');
                    if (vacationDetails) {
                        vacationDetails.style.display = 'none';
                    }

                    // éšè—æ¨¡å¼æé†’
                    const modeReminder = document.getElementById('mode-reminder');
                    if (modeReminder) {
                        modeReminder.style.display = 'none';
                    }

                    // é‡ç½®æ˜¾ç¤ºå€¼
                    const resetValues = [
                        ['total-hours', '0.0'],
                        ['total-pages', '0'],
                        ['total-words', '0'],
                        ['ami-total-score', '0'],
                        ['ignition-total', '0'],
                        ['fli-total-score', '0'],
                        ['bcm-total-score', '0'],
                        ['logistics-total-score', '0'],
                        ['hsm-total-score', '0'],
                        ['bonus-total-score', '0']
                    ];

                    resetValues.forEach(([id, value]) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.textContent = value;
                    });

                    const resetInputs = [
                        ['tpi-total', ''],
                        ['tpi-rating', ''],
                        ['ami-score', ''],
                        ['fli-score', ''],
                        ['sys-score', ''],
                        ['bonus-score', ''],
                        ['ma7-score', '']
                    ];

                    resetInputs.forEach(([id, value]) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.value = value;
                    });

                    // æ¸…é™¤çŠ¶æ€
                    state.selectedMode = null;
                    state.vacationPeriods = null;
                    state.formData = {};

                    console.log('[DataProcessing] è¡¨å•é‡ç½®å®Œæˆ');
                    showNotification('âœ… è¡¨å•å·²é‡ç½®ï¼', 'success');
                } catch (error) {
                    console.error('[DataProcessing] é‡ç½®é”™è¯¯:', error);
                    showNotification('âŒ é‡ç½®è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯', 'error');
                }
            }

            /**
             * æ›´æ–°ç»Ÿè®¡æ•°æ®
             */
            function updateStatistics() {
                console.log('[DataStats] æ›´æ–°ç»Ÿè®¡è¢«è°ƒç”¨');
                
                try {
                    const history = getHistoricalData();
                    console.log('[DataStats] è·å–å†å²æ•°æ®ï¼Œå…±', history.length, 'æ¡è®°å½•');
                    
                    const stats = calculateStatistics(history);
                    console.log('[DataStats] ç»Ÿè®¡æ•°æ®:', stats);

                    // æ›´æ–°æ˜¾ç¤º
                    const daysCountElem = document.getElementById('stats-days-count');
                    const maxTPIElem = document.getElementById('stats-max-tpi');
                    const avgTPIElem = document.getElementById('stats-avg-tpi');

                    if (daysCountElem) daysCountElem.textContent = `${history.length} å¤©`;
                    if (maxTPIElem) maxTPIElem.textContent = `${stats.maxTPI.toFixed(1)} åˆ†`;
                    if (avgTPIElem) avgTPIElem.textContent = `${stats.avgTPI.toFixed(1)} åˆ†`;

                    // æ›´æ–°çŠ¶æ€
                    state.dataStats = stats;
                    
                    console.log('[DataStats] ç»Ÿè®¡æ›´æ–°å®Œæˆ');

                } catch (error) {
                    console.error('[DataStats] æ›´æ–°ç»Ÿè®¡é”™è¯¯:', error);
                }
            }

            // ==================== äº‹ä»¶ç›‘å¬å™¨è®¾ç½® ====================

            /**
             * è®¾ç½®è‡ªåŠ¨è®¡ç®—ç›‘å¬å™¨
             */
            function setupAutoCalculateListeners() {
                // ç›‘å¬AMIç›¸å…³è¾“å…¥
                const amiInputs = document.querySelectorAll('#ami-table input, #ami-table select, #ignition-physical, #ignition-micro-target, #ignition-painless-start, #start-morning-block, #start-afternoon-block, #start-evening-block, #academic-dialogue');

                amiInputs.forEach(input => {
                    const handler = debounce(() => {
                        calculateAMI();
                        calculateTPI();
                    }, 300);

                    input.addEventListener('input', handler);
                    input.addEventListener('change', handler);
                });

                // ç›‘å¬FLIç›¸å…³è¾“å…¥
                document.querySelectorAll('#fli-core-status, .fli-fragment').forEach(input => {
                    const handler = debounce(() => {
                        calculateFLI();
                        calculateTPI();
                    }, 300);

                    input.addEventListener('input', handler);
                    input.addEventListener('change', handler);
                });

               // ç›‘å¬BCMç›¸å…³è¾“å…¥ (å·²æ·»åŠ  item 6 & 7 çš„ç›‘å¬)
                document.querySelectorAll('#bcm-morning-today, #bcm-morning-yesterday, #bcm-evening-exit, #bcm-evening-yesterday, #bcm-sleep-time, #bcm-sleep-yesterday, #bcm-digital-status, #bcm-afternoon-status').forEach(input => {
                    const handler = debounce(() => {
                        calculateBCM();
                        calculateTPI();
                    }, 300);

                    input.addEventListener('input', handler);
                    input.addEventListener('change', handler);
                });

                // ç›‘å¬Logisticsç›¸å…³è¾“å…¥
                document.querySelectorAll('.logistics-status, .logistics-level').forEach(input => {
                    const handler = debounce(() => {
                        calculateLogistics();
                        calculateTPI();
                    }, 300);

                    input.addEventListener('input', handler);
                    input.addEventListener('change', handler);
                });

                // â­ ä¿®å¤ï¼šç›‘å¬HSMç›¸å…³è¾“å…¥ - ä½¿ç”¨æ–°çš„ID
                document.querySelectorAll('#hsm-core-status, #hsm-morning-status, #hsm-afternoon-status, #hsm-water-morning-status, #hsm-water-afternoon-status, #hsm-water-evening-status').forEach(input => {
                    const handler = debounce(() => {
                        calculateHSM();
                        calculateTPI();
                    }, 300);

                    input.addEventListener('input', handler);
                    input.addEventListener('change', handler);
                });

          // [æ–°å¢] ç›‘å¬å¾®å°èƒœåˆ©è¾“å…¥
        document.querySelectorAll('#micro-victory-1, #micro-victory-2, #micro-victory-3').forEach(input => {
            const handler = debounce(() => { checkAutoBonuses(); calculateBonus(); calculateTPI(); }, 500);
            input.addEventListener('input', handler);
            input.addEventListener('blur', handler);
        });

        // ç›‘å¬Bonusç›¸å…³è¾“å…¥
        document.querySelectorAll('input[name="bonus-item"]').forEach(input => {
            input.addEventListener('change', () => {
                calculateBonus();
                    });
                });
            }

                        // ==================== åˆå§‹åŒ–å‡½æ•° ====================

/**
             * é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
             */
            /**
             * ã€å·®å¼‚5ä¿®å¤ã€‘æ£€æŸ¥å¼ºåˆ¶å¤è‹æ¨¡å¼è§¦å‘å™¨
             * å¦‚æœæ˜¨æ—¥Sys_Net<12ï¼Œä»Šæ—¥è‡ªåŠ¨è¿›å…¥å¤è‹æ¨¡å¼
             */
            function checkForceRecoveryMode() {
                try {
                    const forceRecovery = localStorage.getItem('force_recovery_mode');
                    const forceReason = localStorage.getItem('force_recovery_reason');
                    const triggerDate = localStorage.getItem('force_recovery_date');
                    const today = (typeof __tpi_getSelectedDate === 'function') ? __tpi_getSelectedDate() : (()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;})();
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];

                    // å¦‚æœæ˜¨æ—¥è§¦å‘äº†å¼ºåˆ¶å¤è‹ï¼Œä»Šæ—¥è‡ªåŠ¨è¿›å…¥å¤è‹æ¨¡å¼
                    if (forceRecovery === 'true' && triggerDate === yesterdayStr) {
                        console.warn(`ğŸš¨ [å·®å¼‚5] å¼ºåˆ¶å¤è‹è§¦å‘: ${forceReason}`);

                        // è‡ªåŠ¨åˆ‡æ¢åˆ°å¤è‹æ¨¡å¼
                        setTimeout(() => {
                            selectMode('recovery');

                            // æ˜¾ç¤ºå¼ºåˆ¶å¤è‹é€šçŸ¥
                            NotifySystem.showToast(
                                `å› ${forceReason}ï¼Œä»Šæ—¥å·²è‡ªåŠ¨è¿›å…¥å¤è‹æ¨¡å¼`,
                                'warning',
                                'ğŸ”´ å¼ºåˆ¶å¤è‹æ¨¡å¼',
                                6000
                            );

                            // æ˜¾ç¤ºè­¦å‘Šæç¤ºæ¡†
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-danger';
                            alertDiv.style.cssText = 'position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 10000; max-width: 600px; box-shadow: 0 4px 20px rgba(220,38,38,0.3);';
                            alertDiv.innerHTML = /*XSS-Safe*/`
                                <h4>ğŸš¨ å¼ºåˆ¶å¤è‹æ¨¡å¼å·²å¯åŠ¨</h4>
                                <p><strong>è§¦å‘åŸå› ï¼š</strong>${forceReason}</p>
                                <p><strong>æ¨¡å¼è¯´æ˜ï¼š</strong>ä»Šæ—¥å·²è‡ªåŠ¨è¿›å…¥å¤è‹æ¨¡å¼ï¼Œè¾¾æ ‡çº¿å°†æ ¹æ®ä¼‘æ¯æ—¶æ®µæ•°é‡ï¼ˆ0-4ï¼‰åŠ¨æ€è°ƒæ•´ä¸º 70-40 åˆ†ã€‚</p>
                                <p><strong>å»ºè®®æ“ä½œï¼š</strong>ä¸“æ³¨äºç³»ç»Ÿæ¢å¤ï¼Œé¿å…è¿‡åº¦å‹åŠ›ã€‚</p>
                                <button onclick="this.parentElement.remove()" class="btn btn-sm" style="background: var(--color-danger); color: white; margin-top: 8px;">çŸ¥é“äº†</button>
                            `;
                            document.body.appendChild(alertDiv);

                            // 6ç§’åè‡ªåŠ¨ç§»é™¤è­¦å‘Š
                            setTimeout(() => {
                                if (alertDiv.parentElement) {
                                    alertDiv.style.transition = 'opacity 0.5s';
                                    alertDiv.style.opacity = '0';
                                    setTimeout(() => alertDiv.remove(), 500);
                                }
                            }, 6000);

                        }, 500);

                        // æ¸…é™¤å¼ºåˆ¶å¤è‹æ ‡è®°ï¼ˆä»…åœ¨ä»Šæ—¥æ¸…é™¤ï¼‰
                        localStorage.removeItem('force_recovery_mode');
                        localStorage.removeItem('force_recovery_reason');
                        localStorage.removeItem('force_recovery_date');

                    } else if (forceRecovery === 'true' && triggerDate !== yesterdayStr) {
                        // å¦‚æœè§¦å‘æ—¥æœŸä¸æ˜¯æ˜¨å¤©ï¼Œè¯´æ˜æ ‡è®°è¿‡æœŸï¼Œæ¸…é™¤
                        localStorage.removeItem('force_recovery_mode');
                        localStorage.removeItem('force_recovery_reason');
                        localStorage.removeItem('force_recovery_date');
                    } else {
                    }
                } catch (error) {
                    console.error('âŒ [å·®å¼‚5] å¼ºåˆ¶å¤è‹æ£€æŸ¥å¤±è´¥:', error);
                }
            }

            function initialize() {
                // [å·²ä¿®å¤] åˆ é™¤ä¸å­˜åœ¨çš„ initializeEventDelegation è°ƒç”¨ï¼Œé˜²æ­¢å´©æºƒ

                try {
                    // è®¾ç½®ä»Šæ—¥æ—¥æœŸ
                    const today = (typeof __tpi_getSelectedDate === 'function') ? __tpi_getSelectedDate() : (()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;})();
                    const dateInput = document.getElementById('date-input');
                    if (dateInput) dateInput.value = today;

                    // è®¾ç½®å¯¼å‡ºæ—¥æœŸèŒƒå›´é»˜è®¤å€¼
                    const exportStartDate = document.getElementById('export-start-date');
                    const exportEndDate = document.getElementById('export-end-date');
                    if (exportStartDate) exportStartDate.value = today;
                    if (exportEndDate) exportEndDate.value = today;

                    // è®¾ç½®é»˜è®¤æŠ˜å çŠ¶æ€
                    const defaultCollapsedCards = ['sop', 'quarterback', 'cognitive', 'daily-review', 'data-analytics', 'data-processing'];
                    defaultCollapsedCards.forEach(cardId => {
                        const card = document.getElementById(cardId);
                        if (card) {
                            card.classList.add('collapsed');
                            const content = card.querySelector('.card-content');
                            if (content) {
                                content.style.display = 'none';
                            }
                        }
                    });

                    // è®¾ç½®è§„åˆ™æ¡†é»˜è®¤æŠ˜å 
                    document.querySelectorAll('.rules-section').forEach(section => {
                        section.classList.add('collapsed');
                        const content = section.querySelector('.rules-content');
                        if (content) {
                            content.style.display = 'none';
                        }
                    });

                   // è®¾ç½®è‡ªåŠ¨è®¡ç®—ç›‘å¬å™¨
                    setupAutoCalculateListeners();

                    // [å·²ä¿®æ”¹] å¼ºåˆ¶é‡ç½®æ‰€æœ‰çŠ¶æ€é€‰æ‹©æ¡†ä¸ºæœªé€‰ä¸­ï¼ˆç©ºç™½ï¼‰ï¼Œæ¶ˆé™¤â€œé»˜è®¤å®Œæˆâ€çš„é¢„å¡«æ•°æ®
                    document.querySelectorAll('.status-select').forEach(select => {
                        select.selectedIndex = -1; // å¼ºåˆ¶ä¸é€‰ä¸­ä»»ä½•é€‰é¡¹ï¼ˆè§†è§‰ä¸ºç©ºç™½ï¼‰
                    });

                    // [å·²ä¿®æ”¹] ç§»é™¤è‡ªåŠ¨åŠ è½½ LocalStorage æ¨¡å¼çš„ä»£ç ï¼Œç¡®ä¿æ¯æ¬¡æ‰“å¼€éƒ½æ˜¯å¹²å‡€çš„åˆå§‹çŠ¶æ€

                    // æ›´æ–°å­˜å‚¨é”®æ˜¾ç¤º
                    const storageKeyElem = document.getElementById('storage-key');
                    if (storageKeyElem && dateInput.value) {
                        storageKeyElem.textContent = `tpi_data_${dateInput.value}`;
                    }

                    // æ‰§è¡Œåˆå§‹è®¡ç®—
                    setTimeout(() => {
                        calculateAllScores();
                    }, 100);

                    // ã€å·®å¼‚5ä¿®å¤ã€‘æ£€æŸ¥å¼ºåˆ¶å¤è‹è§¦å‘å™¨
                    checkForceRecoveryMode();

                    // åˆå§‹åŒ–æ•°æ®å¯è§†åŒ–
                    setTimeout(() => {
                        initializeTrendChart();
                        initializeHeatmapCalendar();
                        updateBadges();
                        updateStatistics();
                    }, 500);

           // åˆé—´é˜²å®ˆå’Œæ™šé—´é˜²å®ˆçš„è‡ªåŠ¨è®¡ç®—
            const lunchDuration = document.getElementById('bcm-lunch-duration');
            const lunchRef = document.getElementById('bcm-lunch-ref');
            const dinnerDuration = document.getElementById('bcm-dinner-duration');
            const dinnerRef = document.getElementById('bcm-dinner-ref');

            /**
             * è®¡ç®—é˜²å®ˆå¾—åˆ† (ç¬¬22ç‰ˆ - åŠ¨æ€å¥–æƒ©æœºåˆ¶)
             * @param {string} type - 'lunch' æˆ– 'dinner'
             */
            /**
             * è®¡ç®—åˆé—´/æ™šé—´é˜²å®ˆå¾—åˆ† (ç¬¬22ç‰ˆæ ‡å‡† - åŸºäºåœ¨å®¿èˆæ—¶é—´)
             * @param {string} type - 'lunch' æˆ– 'dinner'
             */
            function calculateDefenseScore(type) {
                const todayDurationId = type === 'lunch' ? 'bcm-lunch-today-duration' : 'bcm-dinner-today-duration';
                const yesterdayDurationId = type === 'lunch' ? 'bcm-lunch-yesterday-duration' : 'bcm-dinner-yesterday-duration';
                const statusId = type === 'lunch' ? 'bcm-lunch-status' : 'bcm-dinner-status';
                const scoreId = type === 'lunch' ? 'bcm-lunch-score' : 'bcm-dinner-score';

                const todayDurationInput = document.getElementById(todayDurationId);
                const yesterdayDurationInput = document.getElementById(yesterdayDurationId);
                const statusElem = document.getElementById(statusId);
                const scoreElem = document.getElementById(scoreId);

                if (!todayDurationInput || !statusElem || !scoreElem) return 0;

                const todayDurationStr = todayDurationInput.value;
                let baseScore = 0;
                let status = '';

                // åŸºç¡€åˆ†è®¡ç®— (åŸºäºä»Šæ—¥åœ¨å®¿èˆæ—¶é—´)
                if (!todayDurationStr || todayDurationStr === '' || todayDurationStr === '0') {
                    // åšå®ˆ (æœªå›å¯)
                    baseScore = 3.5;
                    status = 'ğŸ›¡ï¸ åšå®ˆ(0åˆ†é’Ÿ)';
                } else {
                    const todayDuration = parseFloat(todayDurationStr);
                    if (todayDuration <= 20) {
                        // æˆ˜æœ¯ (â‰¤20åˆ†é’Ÿ)
                        baseScore = 1.5;
                        status = `âš–ï¸ æˆ˜æœ¯(${todayDuration}åˆ†é’Ÿ)`;
                    } else {
                        // ç»´æŒ (>20åˆ†é’Ÿ)
                        baseScore = 0;
                        status = `â­• ç»´æŒ(${todayDuration}åˆ†é’Ÿ)`;
                    }
                }

                // åŠ¨æ€å¥–æƒ©: è®¡ç®—ä¸æ˜¨æ—¥åœ¨å®¿èˆæ—¶é—´çš„å·®å¼‚
                let dynamicBonus = 0;
                const yesterdayDurationStr = yesterdayDurationInput?.value || '';

                if (yesterdayDurationStr && yesterdayDurationStr !== '') {
                    const todayDuration = parseFloat(todayDurationStr || '0');
                    const yesterdayDuration = parseFloat(yesterdayDurationStr);
                    const deltaT = todayDuration - yesterdayDuration; // æ­£æ•°=ä»Šå¤©åœ¨å®¿èˆæ—¶é—´æ›´é•¿(å˜å·®)

                    // ç¬¬22ç‰ˆåŠ¨æ€å¥–æƒ©é˜¶æ¢¯ (åœ¨å®¿èˆæ—¶é—´å‡å°‘=è¿›æ­¥=åŠ åˆ†)
                    if (deltaT <= -20) {
                        // ä»Šå¤©æ¯”æ˜¨å¤©å°‘å¾…20+åˆ†é’Ÿ â†’ å¤§å¹…è¿›æ­¥
                        dynamicBonus = 1.5;
                        status += ` (æ¯”æ˜¨æ—¥å°‘${Math.abs(deltaT)}åˆ†é’Ÿ +1.5)`;
                    } else if (deltaT > -20 && deltaT < 0) {
                        // ä»Šå¤©æ¯”æ˜¨å¤©å°‘å¾…1-19åˆ†é’Ÿ â†’ å°å¹…è¿›æ­¥
                        dynamicBonus = 0.5;
                        status += ` (æ¯”æ˜¨æ—¥å°‘${Math.abs(deltaT)}åˆ†é’Ÿ +0.5)`;
                    } else if (deltaT === 0) {
                        // ä¿æŒä¸€è‡´
                        dynamicBonus = 0;
                        status += ` (ä¸æ˜¨æ—¥ä¸€è‡´ +0)`;
                    } else if (deltaT > 0 && deltaT <= 20) {
                        // ä»Šå¤©æ¯”æ˜¨å¤©å¤šå¾…1-20åˆ†é’Ÿ â†’ è½»å¾®é€€æ­¥
                        dynamicBonus = 0;
                        status += ` (æ¯”æ˜¨æ—¥å¤š${deltaT}åˆ†é’Ÿ +0)`;
                    } else if (deltaT > 20 && deltaT <= 40) {
                        // ä»Šå¤©æ¯”æ˜¨å¤©å¤šå¾…21-40åˆ†é’Ÿ â†’ æ˜æ˜¾é€€æ­¥
                        dynamicBonus = -0.5;
                        status += ` (æ¯”æ˜¨æ—¥å¤š${deltaT}åˆ†é’Ÿ -0.5)`;
                    } else if (deltaT > 40 && deltaT <= 60) {
                        // ä»Šå¤©æ¯”æ˜¨å¤©å¤šå¾…41-60åˆ†é’Ÿ â†’ ä¸¥é‡é€€æ­¥
                        dynamicBonus = -1.0;
                        status += ` (æ¯”æ˜¨æ—¥å¤š${deltaT}åˆ†é’Ÿ -1.0)`;
                    } else if (deltaT > 60) {
                        // ä»Šå¤©æ¯”æ˜¨å¤©å¤šå¾…60+åˆ†é’Ÿ â†’ æåº¦é€€æ­¥
                        dynamicBonus = -1.5;
                        status += ` (æ¯”æ˜¨æ—¥å¤š${deltaT}åˆ†é’Ÿ -1.5)`;
                    }

                } else {
                    status += ' (æ— æ˜¨æ—¥å¯¹æ¯”)';
                }

                const totalScore = baseScore + dynamicBonus;

                statusElem.textContent = status;
                scoreElem.value = totalScore.toFixed(1);

                return totalScore;
            }

            // ç»‘å®šé˜²å®ˆè®¡ç®—ç›‘å¬
            const defenseInputs = [lunchDuration, lunchRef, dinnerDuration, dinnerRef];
            defenseInputs.forEach(input => {
                if (input) {
                    input.addEventListener('input', () => {
                        calculateDefenseScore('lunch');
                        calculateDefenseScore('dinner');
                        calculateBCM();
                        calculateTPI();
                    });
                }
            });

            // å¼ºåˆ¶å¤è‹æ£€æµ‹ (åˆå§‹åŒ–æ—¶æ‰§è¡Œ)
            setTimeout(() => {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yKey = `tpi_data_${yesterday.toISOString().split('T')[0]}`;
                const yDataStr = localStorage.getItem(yKey);

                if (yDataStr) {
                    const yData = JSON.parse(yDataStr);
// ğŸ”§ ä¿®å¤5: è¯»å–æ˜¨æ—¥æ‚¬å¿µå’Œç¬¬ä¸€åŠ¨ä½œ
                    const cliffhanger = yData['first-action'] || yData['cliffhanger'] || yData['ami-cliffhanger'] || '';
                    const firstAction = yData['first-action'] || yData['ami-first-action'] || '';

                    if (cliffhanger || firstAction) {

                        // æ˜¾ç¤ºæ‚¬å¿µ
                        if (cliffhanger && cliffhanger !== 'æ— ') {
                            const bridgeEl = document.getElementById('yesterday-bridge');
                            const textEl = document.getElementById('yesterday-cliffhanger-text');
                            if (bridgeEl && textEl) {
                                textEl.textContent = cliffhanger;
                                bridgeEl.style.display = 'block';
                            }
                        }

                        // ğŸŒ‰ æ–°å¢: æ˜¾ç¤ºç¬¬ä¸€åŠ¨ä½œ
                        if (firstAction && firstAction !== 'æ— ') {
                            const firstActionEl = document.getElementById('yesterday-first-action');
                            const firstActionTextEl = document.getElementById('yesterday-first-action-text');
                            if (firstActionEl && firstActionTextEl) {
                                firstActionTextEl.textContent = firstAction;
                                firstActionEl.style.display = 'block';
                            }
                        }

                        // å¦‚æœéƒ½æ²¡æœ‰æ˜¾ç¤ºå…ƒç´ ,åˆ›å»ºä¸€ä¸ªç½®é¡¶æç¤ºæ¡†
                        if (!document.getElementById('yesterday-bridge') && (cliffhanger || firstAction)) {
                            const alertDiv = document.createElement('div');
                            alertDiv.id = 'hemingway-bridge-alert';
                            alertDiv.className = 'alert alert-warning';
                            alertDiv.style.cssText = `
                                background: linear-gradient(135deg, #fbbf24, #f59e0b);
                                color: #78350f;
                                padding: 20px;
                                margin: 20px 0;
                                border-radius: 12px;
                                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            `;
                            alertDiv.innerHTML = `
                                <h4 style="margin-bottom: 15px; font-weight: 700;">ğŸŒ‰ æµ·æ˜å¨æ¡¥ - ä»æ˜¨æ—¥å»¶ç»­</h4>
                                ${cliffhanger ? `
                                <div style="background: rgba(255,255,255,0.3); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                    <strong>ğŸ“Œ æ˜¨æ—¥æ‚¬å¿µ:</strong> ${cliffhanger}
                                </div>
                                ` : ''}
                                ${firstAction ? `
                                <div style="background: rgba(255,255,255,0.3); padding: 12px; border-radius: 8px;">
                                    <strong>ğŸ¯ ç¬¬ä¸€åŠ¨ä½œ:</strong> ${firstAction}
                                </div>
                                ` : ''}
                                <div style="margin-top: 12px; font-size: 13px; opacity: 0.9;">
                                    ğŸ’¡ æç¤º: è¯·ä¾æ®æ˜¨æ—¥æ‚¬å¿µå¯åŠ¨ä»Šæ—¥å·¥ä½œ
                                </div>
                            `;

                            // æ’å…¥åˆ°é¡µé¢é¡¶éƒ¨
                            const container = document.querySelector('.container') || document.body;
                            if (container.firstChild) {
                                container.insertBefore(alertDiv, container.firstChild);
                            } else {
                                container.appendChild(alertDiv);
                            }
                        }
                    }
                  // æ£€æŸ¥æ˜¨æ—¥Sysåˆ† (çº¢çº¿ä¿æŠ¤)
                    const ySys = safeParseFloat(yData['sys-score'] || 0);
                    // æ£€æŸ¥æ˜¨æ—¥TPIåˆ† (èƒ½é‡å¹³è¡¡)
                    const yTpi = safeParseFloat(yData['tpi'] || 0);

                    if (ySys > 0 && ySys < 12) {
                        selectMode('recovery');
                        NotifySystem.showModal({
                            type: 'danger',
                            title: 'ğŸš¨ å¼ºåˆ¶å¤è‹æ¨¡å¼ (åŸºçŸ³å´©å¡Œ)',
                            message: `æ£€æµ‹åˆ°æ˜¨æ—¥åŸºçŸ³åˆ†(Sys=${ySys})ä½äº12åˆ†ï¼Œç³»ç»Ÿå·²æ ¹æ®å®‰å…¨åè®®å¼ºåˆ¶é”å®šä¸ºå¤è‹æ¨¡å¼ã€‚`,
                            buttonText: 'æ¥å—å¹¶æ‰§è¡Œ'
                        });
                    } else if (yTpi > 200) {
                        selectMode('recovery');
                        NotifySystem.showModal({
                            type: 'warning',
                            title: 'ğŸ’¤ å¼ºåˆ¶å¤è‹æ¨¡å¼ (èƒ½é‡è¿‡è½½)',
                            message: `æ£€æµ‹åˆ°æ˜¨æ—¥TPIé«˜è¾¾ ${yTpi} åˆ† (ç³»ç»Ÿè¿‡è½½)ã€‚ä¸ºé˜²æ­¢èŒä¸šå€¦æ€ ï¼Œä»Šæ—¥å¼ºåˆ¶æ‰§è¡Œèƒ½é‡å¹³è¡¡åè®®ã€‚`,
                            buttonText: 'æ¥å—å¼ºåˆ¶ä¼‘æ¯'
                        });
                    }
                }
            }, 1000);

            // è¿èƒœ/è¿è´¥è¿½è¸ª
            function updateStreakTracking() {
                try {
                    const winningBadge = document.getElementById('winning-streak');
                    const warningBadge = document.getElementById('warning-streak');
                    const winningDays = document.getElementById('winning-days');
                    const warningDays = document.getElementById('warning-days');

                    if (!winningBadge || !warningBadge) return;

                    // è·å–æœ€è¿‘7å¤©çš„æ•°æ®
                    const today = new Date();
                    let winStreak = 0;
                    let warnStreak = 0;

                    for (let i = 0; i < 7; i++) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        const key = `tpi_data_${dateStr}`;
                        const data = localStorage.getItem(key);

                        if (data) {
                            try {
                                const parsed = JSON.parse(data);
                                const tpi = parsed.tpi || 0;
                           if (tpi >= 120) { // v13 è¿èƒœæ ‡å‡†: 120
                                    winStreak++;
                                    warnStreak = 0;
                                } else if (tpi < 95) { // v13 é¢„è­¦æ ‡å‡†: 95
                                    warnStreak++;
                                    winStreak = 0;
                                } else {
                                    winStreak = 0;
                                    warnStreak = 0;
                                }
                            } catch (e) {
                                console.error('è§£ææ•°æ®å¤±è´¥:', e);
                            }
                        } else {
                            // æ²¡æœ‰æ•°æ®,ä¸­æ–­è¿ç»­
                            winStreak = 0;
                            warnStreak = 0;
                        }

                        // åªç»Ÿè®¡è¿ç»­çš„å¤©æ•°
                        if (i > 0 && (winStreak === 0 && warnStreak === 0)) {
                            break;
                        }
                    }

                    // æ›´æ–°æ˜¾ç¤º
                    if (winStreak >= 3) {
                        winningBadge.classList.remove('hidden');
                        winningDays.textContent = winStreak;
                    } else {
                        winningBadge.classList.add('hidden');
                    }

           if (warnStreak >= 3) {
                        warningBadge.classList.remove('hidden');
                        warningDays.textContent = warnStreak;

                        // æ˜¾ç¤ºè¿è´¥é¢„è­¦å¡ç‰‡
                        const warningDiv = document.getElementById('losing-streak-warning');
                        const losingDaysSpan = document.getElementById('losing-days-display');
                        if (warningDiv && losingDaysSpan) {
                            warningDiv.style.display = 'block';
                            losingDaysSpan.textContent = warnStreak;

                            // å¦‚æœè¿è´¥â‰¥5å¤©ï¼Œä½¿ç”¨æ›´å¼ºçƒˆçš„è­¦å‘Šæ ·å¼
                            if (warnStreak >= 5) {
                                warningDiv.style.borderLeft = '5px solid #dc2626';
                                warningDiv.style.background = '#fef2f2';
                            } else {
                                warningDiv.style.borderLeft = '';
                                warningDiv.style.background = '';
                            }
                        }
                    } else {
                        warningBadge.classList.add('hidden');

                        // éšè—è¿è´¥é¢„è­¦å¡ç‰‡
                        const warningDiv = document.getElementById('losing-streak-warning');
                        if (warningDiv) {
                            warningDiv.style.display = 'none';
                        }
                    }

                    // æ£€æŸ¥è¿ç»­ç¨³å®šå¥–é‡Œç¨‹ç¢‘ï¼ˆ7/14/21æ—¥ï¼‰
                    if (winStreak === 7 || winStreak === 14 || winStreak === 21) {
                        const bonusPoints = winStreak === 7 ? 3 : (winStreak === 14 ? 5 : 7);
                        const milestoneKey = `tpi_milestone_${winStreak}_${new Date().toISOString().split('T')[0]}`;

                        // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»æé†’è¿‡
                        if (!sessionStorage.getItem(milestoneKey)) {
                            sessionStorage.setItem(milestoneKey, 'true');

                            // å»¶è¿Ÿæ˜¾ç¤ºæé†’ï¼Œé¿å…é˜»å¡é¡µé¢åŠ è½½
                            setTimeout(() => {
                                if (confirm(
                                    `ğŸ‰ è¿ç»­ç¨³å®šå¥–é‡Œç¨‹ç¢‘è¾¾æˆï¼\n\n` +
                                    `æ‚¨å·²è¿ç»­ ${winStreak} æ—¥è¾¾åˆ°TPIâ‰¥120åˆ†\n` +
                                    `å»ºè®®åœ¨ã€éŸ§æ€§ä¸çªç ´åŠ åˆ†ã€‘åŒºåŸŸå‹¾é€‰ï¼š\n` +
                                    `"ğŸ“Š è¿ç»­ç¨³å®šå¥– (${winStreak}æ—¥) +${bonusPoints}åˆ†"\n\n` +
                                    `ç‚¹å‡»ç¡®å®šè·³è½¬åˆ°å¥–åŠ±åŒºåŸŸ`
                                )) {
                                    // è·³è½¬åˆ°éŸ§æ€§åŠ åˆ†åŒºåŸŸ
                                    const bonusSection = document.getElementById('bonus-section');
                                    if (bonusSection) {
                                        bonusSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                        // é«˜äº®æç¤º
                                        bonusSection.style.boxShadow = '0 0 20px rgba(245, 158, 11, 0.5)';
                                        setTimeout(() => {
                                            bonusSection.style.boxShadow = '';
                                        }, 3000);
                                    }
                                }
                            }, 1000);
                        }
                    }

                } catch (error) {
                    console.error('è¿èƒœè¿½è¸ªæ›´æ–°å¤±è´¥:', error);
                }
            }

            // åœ¨TPIè®¡ç®—åæ›´æ–°è¿èƒœè¿½è¸ª
            updateStreakTracking();

            // è±å…è®¡æ•°åŠŸèƒ½
            /**
             * å·®å¼‚19,20,24,32,58,59ä¿®å¤ï¼šè±å…è®¡æ•°ç®¡ç†
             */
            function updateExemptionCounts() {
                const exemptionA = document.querySelectorAll('input[name="exemption-a"]:checked').length;
                const exemptionB = document.querySelectorAll('input[name="exemption-b"]:checked').length;

                const countA = document.getElementById('exemption-a-count');
                const countB = document.getElementById('exemption-b-count');

                if (countA) countA.textContent = exemptionA;
                if (countB) countB.textContent = exemptionB;

                // å·®å¼‚20ä¿®å¤ï¼šè¶…è¿‡é™åˆ¶æ—¶æ˜¾ç¤ºè­¦å‘Š
                if (exemptionA > 2) {
                    countA.style.color = 'red';
                    countA.style.fontWeight = 'bold';
                    NotifySystem.showToast('âš ï¸ Aç±»è±å…å·²è¶…å‡ºæœ¬å‘¨é™åˆ¶ï¼ˆ2æ¬¡ï¼‰', 'warning');
                } else {
                    countA.style.color = '';
                    countA.style.fontWeight = '';
                }

                if (exemptionB > 2) {
                    countB.style.color = 'red';
                    countB.style.fontWeight = 'bold';
                    NotifySystem.showToast('âš ï¸ Bç±»è±å…å·²è¶…å‡ºæœ¬å‘¨é™åˆ¶ï¼ˆ2æ¬¡ï¼‰', 'warning');
                } else {
                    countB.style.color = '';
                    countB.style.fontWeight = '';
                }

                // å·®å¼‚24,59ä¿®å¤ï¼šæ£€æŸ¥ç†ç”±å¿…å¡«
                const exemptionReason = document.getElementById('exemption-reason');
                if (exemptionReason && (exemptionA > 0 || exemptionB > 0)) {
                    if (exemptionReason.value.trim() === '') {
                        exemptionReason.style.borderColor = 'red';
                        exemptionReason.placeholder = 'âš ï¸ è±å…å¿…é¡»å¡«å†™ç†ç”±ï¼';
                    } else {
                        exemptionReason.style.borderColor = '';
                        exemptionReason.placeholder = 'è¯·è¯¦ç»†è¯´æ˜è±å…åŸå› ...';
                    }
                }

                // å·®å¼‚32ä¿®å¤ï¼šå¤è‹æ¨¡å¼ç¦ç”¨Aç±»è±å…
                const currentMode = state.selectedMode;
                const exemptionAInputs = document.querySelectorAll('input[name="exemption-a"]');
                if (currentMode === 'recovery') {
                    exemptionAInputs.forEach(input => {
                        input.disabled = true;
                        input.checked = false;
                    });
                    if (countA) countA.parentElement.style.opacity = '0.5';
                } else {
                    exemptionAInputs.forEach(input => {
                        input.disabled = false;
                    });
                    if (countA) countA.parentElement.style.opacity = '1';
                }
            }

            /**
             * å·®å¼‚19ä¿®å¤ï¼šæ¯å‘¨ä¸€é‡ç½®è±å…è®¡æ•°
             */
            function resetWeeklyExemptions() {
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€
                const lastReset = localStorage.getItem('last_exemption_reset');
                const todayStr = today.toDateString();

                // å¦‚æœæ˜¯å‘¨ä¸€ä¸”ä»Šå¤©è¿˜æ²¡é‡ç½®è¿‡
                if (dayOfWeek === 1 && lastReset !== todayStr) {

                    // å–æ¶ˆæ‰€æœ‰è±å…å‹¾é€‰
                    document.querySelectorAll('input[name="exemption-a"], input[name="exemption-b"]').forEach(cb => {
                        cb.checked = false;
                    });

                    // æ¸…ç©ºç†ç”±
                    const reasonTextarea = document.getElementById('exemption-reason');
                    if (reasonTextarea) reasonTextarea.value = '';

                    // æ›´æ–°è®¡æ•°æ˜¾ç¤º
                    updateExemptionCounts();

                    // è®°å½•é‡ç½®æ—¥æœŸ
                    localStorage.setItem('last_exemption_reset', todayStr);

                    NotifySystem.showToast('âœ… è±å…è®¡æ•°å·²é‡ç½®ï¼ˆæ¯å‘¨ä¸€è‡ªåŠ¨ï¼‰', 'success');
                }
            }

            // ç›‘å¬è±å…å‹¾é€‰æ¡†å˜åŒ–
            document.querySelectorAll('input[name="exemption-a"], input[name="exemption-b"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateExemptionCounts);
            });

            // åˆå§‹åŒ–æ—¶æ›´æ–°ä¸€æ¬¡
            updateExemptionCounts();

            // å·®å¼‚19ä¿®å¤ï¼šé¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®
            resetWeeklyExemptions();

                    // ==================== v15 å¢å¼ºåŠŸèƒ½åˆå§‹åŒ– ====================
                    initializeNetworkMonitor();
                    initializeDateNavigation();
                    updateStorageIndicator();
                    initializeErrorLogger();

                    // ç»‘å®šå¸®åŠ©æŒ‰é’®
                    const helpBtn = document.getElementById('help-btn');
                    if (helpBtn) {
                        // Help button removed in ç¬¬ 20 ç‰ˆ
                    }

                    // ç»‘å®šå¯†ç å¼ºåº¦æ£€æµ‹
                    setTimeout(() => {
                        const authPass = document.getElementById('auth-pass');
                        if (authPass) {
                            authPass.addEventListener('input', function() {
                                checkPasswordStrength(this.value);
                            });
                        }
                    }, 1000);

                    // ==================== v15 å¢å¼ºåŠŸèƒ½åˆå§‹åŒ–ç»“æŸ ====================
                } catch (error) {
                    console.error('åˆå§‹åŒ–é”™è¯¯:', error);
                }
            }

          // [FIX v14 Final] æ™ºèƒ½æ—¥æŠ¥ç”Ÿæˆ
            function generateDailyReport() {
                try {
                    const today = (typeof __tpi_getSelectedDate === 'function') ? __tpi_getSelectedDate() : (()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;})();
                    const tpiText = document.getElementById('tpi-total-score')?.textContent || '0';
                    const tpi = tpiText === 'PAUSED' ? 'PAUSED' : safeParseFloat(tpiText, 0);
                    const sys = safeParseFloat(document.getElementById('sys-score')?.textContent || '0', 0);
                    const bonus = safeParseFloat(document.getElementById('bonus-score')?.textContent || '0', 0);
                    // ä¿®æ­£ rating è·å–é€»è¾‘ï¼Œä¼˜å…ˆè·å– select çš„å€¼
                    const ratingSelect = document.getElementById('tpi-rating');
                    const rating = ratingSelect ? (ratingSelect.options[ratingSelect.selectedIndex]?.text || ratingSelect.value) : '';

                    const mode = state.selectedMode || 'normal';
                    const kValueInput = document.getElementById('k-value');
                    const kValue = kValueInput ? safeParseFloat(kValueInput.value, 300) : 300;
                    // MA7 æš‚ç”¨ safeParseFloat è·å–ç•Œé¢å€¼
                    const ma7 = safeParseFloat(document.getElementById('ma7-score')?.value || 0);

                    // æ”¶é›†ç»“æ™¶å†…å®¹ (å‡è®¾ AMI æœ‰4ä¸ªæ—¶æ®µ + æœºåŠ¨ = 5è¡Œ)
                    const crystals = [];
                    for (let i = 1; i <= 5; i++) {
                        const crystalInput = document.querySelector(`.ami-crystal[data-row="${i}"]`);
                        const crystal = crystalInput?.value?.trim() || '';
                        if (crystal) crystals.push(crystal);
                    }

                    // æ”¶é›†Daily Reviewå†…å®¹ (v14æ–°å¢)
                    const cliffhanger = document.getElementById('cliffhanger')?.value?.trim() || 'æ— ';
                    const firstAction = document.getElementById('first-action')?.value?.trim() || 'æ— ';
                    const reflection = document.getElementById('daily-reflection')?.value?.trim() || 'æ— ';

                   // æ”¶é›†è§¦å‘å¥–åŠ±
        const bonusDetails = document.getElementById('bonus-reason')?.value || 'æ— ';

        // æ”¶é›†å¾®å°èƒœåˆ© (åŒæ­¥ç¬¬22ç‰ˆ)
        const mv1 = document.getElementById('micro-victory-1')?.value || '';
        const mv2 = document.getElementById('micro-victory-2')?.value || '';
        const mv3 = document.getElementById('micro-victory-3')?.value || '';
        const microVictories = [mv1, mv2, mv3].filter(v => v.trim() !== '').map((v, i) => `${i+1}. ${v}`).join('\n') || 'æœªè®°å½•';

        const report = `# TPIæ—¥æŠ¥ - ${today}

## ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡
- **TPIæ€»åˆ†**: ${tpi}
- **ç³»ç»Ÿåˆ†(Sys)**: ${sys}
- **å¥–åŠ±åˆ†(Bonus)**: ${bonus}
- **è®¤çŸ¥çŠ¶æ€**: ${rating}
- **å·¥ä½œæ¨¡å¼**: ${mode}
- **Kå€¼**: ${kValue}
- **MA7**: ${ma7}

## ğŸ’ ä»Šæ—¥ç»“æ™¶
${crystals.length > 0 ? crystals.map((c, i) => `${i + 1}. ${c}`).join('\n') : 'æ— '}

## ğŸ è§¦å‘å¥–åŠ±
${bonusDetails}

## âœ¨ å¾®å°èƒœåˆ©
${microVictories}

## ğŸ“ æ¯æ—¥å¤ç›˜ (Daily Review)### ğŸ¬ æ‚¬å¿µ
${cliffhanger}

### ğŸ¯ æ˜æ—¥ç¬¬ä¸€åŠ¨ä½œ
${firstAction}

### ğŸ’­ ä»Šæ—¥åæ€
${reflection}

---
ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}
`;

                    // å¤åˆ¶åˆ°å‰ªè´´æ¿
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(report).then(() => {
                            showNotification('æ—¥æŠ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                        }).catch(() => {
                            fallbackCopyText(report);
                        });
                    } else {
                        fallbackCopyText(report);
                    }
                } catch (e) {
                    showNotification('ç”Ÿæˆæ—¥æŠ¥å¤±è´¥: ' + e.message, 'error');
                }
            }

            function fallbackCopyText(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showNotification('æ—¥æŠ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                } catch (e) {
                    showNotification('å¤åˆ¶å¤±è´¥,è¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
                document.body.removeChild(textarea);
            }

            // ==================== v15 å¢å¼ºåŠŸèƒ½ ====================

            // ã€ä¼˜åŒ–1-2ã€‘æ•°æ®ç‰ˆæœ¬ç®¡ç†ä¸è¿ç§»
            function migrateDataIfNeeded(data) {
                try {
                    const currentVersion = window.TPI_DATA_VERSION || '1.0';
                    const dataVersion = data.version || '1.0';

                    if (dataVersion === currentVersion) {
                        return data;
                    }

                    // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸åŒç‰ˆæœ¬ä¹‹é—´çš„æ•°æ®è¿ç§»é€»è¾‘
                    data.version = currentVersion;
                    return data;
                } catch (error) {
                    console.error('æ•°æ®è¿ç§»å¤±è´¥:', error);
                    return data;
                }
            }

            // ã€ä¼˜åŒ–3ã€‘ç½‘ç»œçŠ¶æ€ç›‘æµ‹
            function initializeNetworkMonitor() {
                const indicator = document.getElementById('network-indicator');
                if (!indicator) return;

                function updateNetworkStatus() {
                    if (navigator.onLine) {
                        indicator.style.display = 'none';
                    } else {
                        indicator.style.display = 'flex';
                    }
                }

                window.addEventListener('online', updateNetworkStatus);
                window.addEventListener('offline', updateNetworkStatus);
                updateNetworkStatus();
            }

            // ã€ä¼˜åŒ–4ã€‘æ—¥æœŸå¯¼èˆªåŠŸèƒ½
            function initializeDateNavigation() {
                const dateInput = document.getElementById('date-input');
                const prevBtn = document.getElementById('date-prev');
                const nextBtn = document.getElementById('date-next');
                const todayBtn = document.getElementById('date-today');
                const weekdaySpan = document.getElementById('date-weekday');

                if (!dateInput) return;
                
                // ã€å…³é”®ä¿®å¤ã€‘é¡µé¢åŠ è½½æ—¶å¼ºåˆ¶è®¾ç½®ä¸ºä»Šå¤©çš„æ—¥æœŸ
                const setToday = () => {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    dateInput.value = `${yyyy}-${mm}-${dd}`;
                    console.log('âœ… æ—¥æœŸå·²è®¾ç½®ä¸ºä»Šå¤©:', dateInput.value);
                };
                
                // æ— è®ºå¦‚ä½•éƒ½å…ˆè®¾ç½®ä¸ºä»Šå¤©
                setToday();

                function updateWeekday() {
                    const date = new Date(dateInput.value);
                    const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                    if (weekdaySpan && !isNaN(date.getTime())) {
                        const weekday = weekdays[date.getDay()];
                        
                        // è®¡ç®—é˜´å†
                        let lunarStr = '';
                        try {
                            if (typeof LunarCalendar !== 'undefined' && typeof LunarCalendar.solarToLunar === 'function') {
                                const lunar = LunarCalendar.solarToLunar(date);
                                const lunarMonths = ['æ­£æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'å†¬æœˆ', 'è…Šæœˆ'];
                                const lunarMonth = lunarMonths[lunar.month - 1];
                                const lunarDay = lunar.day < 11 ? 'åˆ' + ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å'][lunar.day - 1] 
                                                : lunar.day < 20 ? 'å' + ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'][lunar.day - 11]
                                                : lunar.day === 20 ? 'äºŒå'
                                                : lunar.day < 30 ? 'å»¿' + ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'][lunar.day - 21]
                                                : 'ä¸‰å';
                                lunarStr = `å†œå†${lunarMonth}${lunarDay}${lunar.isLeap ? '(é—°)' : ''}`;
                            }
                        } catch (e) {
                            console.warn('è®¡ç®—é˜´å†å¤±è´¥:', e);
                        }
                        
                        // è®¡ç®—å¹´ä»½å’Œå‘¨æ•°
                        const getISOWeekInfo = (d) => {
                            const utc = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                            const day = utc.getUTCDay() || 7; // å‘¨ä¸€=1...å‘¨æ—¥=7
                            utc.setUTCDate(utc.getUTCDate() + 4 - day); // å®šä½åˆ°æœ¬å‘¨å‘¨å››
                            const weekYear = utc.getUTCFullYear();
                            const yearStart = new Date(Date.UTC(weekYear, 0, 1));
                            const weekNo = Math.ceil((((utc - yearStart) / 86400000) + 1) / 7);
                            return { weekYear, weekNo };
                        };
                        
                        const { weekYear, weekNo } = getISOWeekInfo(date);
                        
                        // ç»„åˆæ˜¾ç¤ºï¼šæ˜ŸæœŸ + é˜´å† + å¹´ä»½å‘¨æ•°
                        const parts = [];
                        parts.push(weekday);
                        if (lunarStr) parts.push(lunarStr);
                        parts.push(`${weekYear}å¹´ç¬¬${weekNo}å‘¨`);
                        
                        weekdaySpan.textContent = `(${parts.join(' ')})`;
                    }
                }

                function changeDate(days) {
                    const currentDate = new Date(dateInput.value);
                    currentDate.setDate(currentDate.getDate() + days);
                    dateInput.value = currentDate.toISOString().split('T')[0];
                    loadFromLocalStorage();
                    updateWeekday();
                }

                if (prevBtn) prevBtn.addEventListener('click', () => changeDate(-1));
                if (nextBtn) nextBtn.addEventListener('click', () => changeDate(1));
                if (todayBtn) {
                    todayBtn.addEventListener('click', () => {
                        console.log('ğŸ“… ç‚¹å‡»"ä»Šå¤©"æŒ‰é’®');
                        dateInput.value = new Date().toISOString().split('T')[0];
                        console.log('ğŸ“… åˆ‡æ¢åˆ°ä»Šå¤©çš„æ—¥æœŸ:', dateInput.value);
                        loadFromLocalStorage();
                        updateWeekday();
                    });
                }

                dateInput.addEventListener('change', updateWeekday);
                updateWeekday();
            }

            // ã€ä¼˜åŒ–5ã€‘localStorageå®¹é‡ç›‘æ§
            function updateStorageIndicator() {
                try {
                    const indicator = document.getElementById('storage-indicator');
                    const barFill = document.getElementById('storage-bar-fill');
                    const text = document.getElementById('storage-text');

                    if (!indicator) return;

                    let totalSize = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            totalSize += localStorage[key].length + key.length;
                        }
                    }

                    const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
                    const maxSize = 5;
                    const percentage = (sizeInMB / maxSize) * 100;

                    if (barFill) {
                        barFill.style.width = Math.min(percentage, 100) + '%';
                        barFill.className = 'storage-bar-fill';
                        if (percentage > 80) barFill.classList.add('danger');
                        else if (percentage > 60) barFill.classList.add('warning');
                    }

                    if (text) {
                        text.textContent = `${sizeInMB} MB / ${maxSize} MB`;
                    }

                    // å¢å¼ºçš„å­˜å‚¨ç©ºé—´ç®¡ç†
                    if (percentage > 95) {
                        showStorageFullModal(sizeInMB, maxSize, percentage);
                    } else if (percentage > 90) {
                        showStorageWarningModal(sizeInMB, maxSize, percentage);
                    }
                } catch (error) {
                    console.error('å­˜å‚¨ç©ºé—´æ£€æµ‹å¤±è´¥:', error);
                }
            }

            // æ–°å¢ï¼šå­˜å‚¨ç©ºé—´å·²æ»¡æ¨¡æ€æ¡†ï¼ˆ95%ä»¥ä¸Šï¼‰
            function showStorageFullModal(currentSize, maxSize, percentage) {
                const lastShown = localStorage.getItem('tpi_storage_full_warning');
                const now = Date.now();

                // æ¯å°æ—¶æœ€å¤šæ˜¾ç¤ºä¸€æ¬¡
                if (lastShown && (now - parseInt(lastShown)) < 3600000) {
                    return;
                }

                showModal({
                    type: 'danger',
                    title: 'â›” å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³',
                    message: `
                        <div style="text-align: left;">
                            <p><strong>å½“å‰ä½¿ç”¨ï¼š</strong>${currentSize} MB / ${maxSize} MB (${percentage.toFixed(1)}%)</p>
                            <p style="color: #dc2626; font-weight: bold;">âš ï¸ å­˜å‚¨ç©ºé—´å³å°†è€—å°½ï¼Œæ–°æ•°æ®å¯èƒ½æ— æ³•ä¿å­˜ï¼</p>

                            <h4 style="margin-top: 20px;">ğŸ”§ è¯·ç«‹å³é€‰æ‹©ä¸€é¡¹æ“ä½œï¼š</h4>
                            <div style="margin: 15px 0;">
                                <button onclick="autoClean30Days()" class="modal-button modal-button-primary" style="width: 100%; margin: 5px 0;">
                                    ğŸ“¦ ç«‹å³å¯¼å‡ºå¹¶æ¸…ç†30å¤©å‰æ•°æ®ï¼ˆæ¨èï¼‰
                                </button>
                                <button onclick="exportAndReset()" class="modal-button" style="width: 100%; margin: 5px 0; background: #f59e0b; color: white;">
                                    ğŸ”„ å¯¼å‡ºå…¨éƒ¨æ•°æ®åé‡ç½®ç³»ç»Ÿ
                                </button>
                                <button onclick="manualSelectDates()" class="modal-button" style="width: 100%; margin: 5px 0; background: #6b7280; color: white;">
                                    âœ‹ æ‰‹åŠ¨é€‰æ‹©è¦åˆ é™¤çš„æ—¥æœŸ
                                </button>
                            </div>

                            <p style="color: #6b7280; font-size: 0.9em; margin-top: 15px;">
                                ğŸ’¡ æç¤ºï¼šé€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹å¯ä»¥å®‰å…¨åœ°æ¸…ç†æ—§æ•°æ®ï¼ŒåŒæ—¶ä¿ç•™å¯¼å‡ºæ–‡ä»¶ä¾›ä»¥åæŸ¥é˜…ã€‚
                            </p>
                        </div>
                    `,
                    confirmText: 'æˆ‘çŸ¥é“äº†',
                    onConfirm: () => {
                        localStorage.setItem('tpi_storage_full_warning', now.toString());
                    }
                });
            }

            // æ–°å¢ï¼šå­˜å‚¨ç©ºé—´è­¦å‘Šæ¨¡æ€æ¡†ï¼ˆ90-95%ï¼‰
            function showStorageWarningModal(currentSize, maxSize, percentage) {
                const lastShown = localStorage.getItem('tpi_storage_warning');
                const now = Date.now();

                // æ¯å¤©æœ€å¤šæ˜¾ç¤ºä¸€æ¬¡
                if (lastShown && (now - parseInt(lastShown)) < 86400000) {
                    return;
                }

                const daysLeft = Math.floor((maxSize - currentSize) / 0.01); // å‡è®¾æ¯å¤©å¢é•¿10KB

                showModal({
                    type: 'warning',
                    title: 'âš ï¸ å­˜å‚¨ç©ºé—´å³å°†ç”¨å®Œ',
                    message: `
                        <div style="text-align: left;">
                            <p><strong>å½“å‰ä½¿ç”¨ï¼š</strong>${currentSize} MB / ${maxSize} MB (${percentage.toFixed(1)}%)</p>
                            <p><strong>é¢„è®¡å¯ç”¨ï¼š</strong>çº¦ ${daysLeft} å¤©</p>

                            <h4 style="margin-top: 20px;">ğŸ’¡ å»ºè®®æ“ä½œï¼š</h4>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>å®šæœŸå¯¼å‡ºæ—§æ•°æ®ï¼ˆå»ºè®®æ¯æœˆä¸€æ¬¡ï¼‰</li>
                                <li>æ¸…ç†ä¸éœ€è¦çš„å†å²è®°å½•</li>
                                
                            </ul>

                            <div style="margin-top: 15px;">
                                <button onclick="exportAllData()" class="modal-button modal-button-primary" style="margin-right: 10px;">
                                    ğŸ’¾ ç«‹å³å¯¼å‡ºæ•°æ®
                                </button>
                                <button onclick="goToDataManagement()" class="modal-button">
                                    ğŸ”§ å‰å¾€æ•°æ®ç®¡ç†
                                </button>
                            </div>
                        </div>
                    `,
                    confirmText: 'ç¨åå¤„ç†',
                    onConfirm: () => {
                        localStorage.setItem('tpi_storage_warning', now.toString());
                    }
                });
            }

            // æ–°å¢ï¼šè‡ªåŠ¨æ¸…ç†30å¤©å‰çš„æ•°æ®
            function autoClean30Days() {
                if (!confirm('ç¡®è®¤è¦å¯¼å‡ºå¹¶æ¸…ç†30å¤©å‰çš„æ•°æ®å—ï¼Ÿ\n\nè¿™å°†ï¼š\n1. å¯¼å‡ºæ‰€æœ‰æ•°æ®åˆ°JSONæ–‡ä»¶\n2. åˆ é™¤30å¤©å‰çš„è®°å½•\n3. ä¿ç•™æœ€è¿‘30å¤©çš„æ•°æ®')) {
                    return;
                }

                try {
                    // å…ˆå¯¼å‡ºæ‰€æœ‰æ•°æ®
                    exportAllData();

                    // ç­‰å¾…1ç§’è®©ç”¨æˆ·ä¿å­˜æ–‡ä»¶
                    setTimeout(() => {
                        const cutoffDate = new Date();
                        cutoffDate.setDate(cutoffDate.getDate() - 30);

                        let deletedCount = 0;
                        const keysToDelete = [];

                        for (let key in localStorage) {
                            if (key.startsWith('tpi_data_')) {
                                const dateStr = key.replace('tpi_data_', '');
                                const recordDate = new Date(dateStr);

                                if (recordDate < cutoffDate) {
                                    keysToDelete.push(key);
                                }
                            }
                        }

                        keysToDelete.forEach(key => {
                            localStorage.removeItem(key);
                            deletedCount++;
                        });

                        updateStorageIndicator();
                        showNotification(`âœ… å·²æ¸…ç† ${deletedCount} æ¡30å¤©å‰çš„è®°å½•ï¼Œå­˜å‚¨ç©ºé—´å·²é‡Šæ”¾`, 'success');
                    }, 1000);

                } catch (error) {
                    showNotification('âŒ æ¸…ç†å¤±è´¥ï¼š' + error.message, 'error');
                }
            }

            // æ–°å¢ï¼šå¯¼å‡ºå¹¶é‡ç½®
            function exportAndReset() {
                if (!confirm('ç¡®è®¤è¦å¯¼å‡ºå…¨éƒ¨æ•°æ®å¹¶é‡ç½®ç³»ç»Ÿå—ï¼Ÿ\n\nâš ï¸ è¿™å°†æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®ï¼\nè¯·ç¡®ä¿å·²ä¿å­˜å¯¼å‡ºæ–‡ä»¶ã€‚')) {
                    return;
                }

                try {
                    exportAllData();

                    setTimeout(() => {
                        if (confirm('æ•°æ®å·²å¯¼å‡ºï¼Œç¡®è®¤è¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                            const keysToRemove = [];
                            for (let key in localStorage) {
                                if (key.startsWith('tpi_')) {
                                    keysToRemove.push(key);
                                }
                            }

                            keysToRemove.forEach(key => localStorage.removeItem(key));

                            showNotification('âœ… ç³»ç»Ÿå·²é‡ç½®ï¼Œè¯·åˆ·æ–°é¡µé¢', 'success');
                            setTimeout(() => location.reload(), 2000);
                        }
                    }, 1000);
                } catch (error) {
                    showNotification('âŒ é‡ç½®å¤±è´¥ï¼š' + error.message, 'error');
                }
            }

            // æ–°å¢ï¼šæ‰‹åŠ¨é€‰æ‹©æ—¥æœŸåˆ é™¤
            function manualSelectDates() {
                // è·å–æ‰€æœ‰æ—¥æœŸ
                const dates = [];
                for (let key in localStorage) {
                    if (key.startsWith('tpi_data_')) {
                        dates.push(key.replace('tpi_data_', ''));
                    }
                }

                dates.sort().reverse(); // æŒ‰æ—¥æœŸå€’åº

                let html = '<div style="max-height: 400px; overflow-y: auto; text-align: left;">';
                html += '<p>é€‰æ‹©è¦åˆ é™¤çš„æ—¥æœŸï¼ˆå¯å¤šé€‰ï¼‰ï¼š</p>';
                html += '<div style="margin: 10px 0;">';

                dates.forEach(date => {
                    html += `
                        <label style="display: block; padding: 5px; cursor: pointer;">
                            <input type="checkbox" value="${date}" class="date-delete-checkbox" style="margin-right: 10px;">
                            ${date}
                        </label>
                    `;
                });

                html += '</div>';
                html += `<button onclick="deleteSelectedDates()" class="modal-button modal-button-primary">åˆ é™¤é€‰ä¸­çš„æ—¥æœŸ</button>`;
                html += '</div>';

                showModal({
                    type: 'warning',
                    title: 'ğŸ“… é€‰æ‹©è¦åˆ é™¤çš„æ—¥æœŸ',
                    message: html,
                    confirmText: 'å–æ¶ˆ',
                    showCancel: false
                });
            }

            // æ–°å¢ï¼šåˆ é™¤é€‰ä¸­çš„æ—¥æœŸ
            function deleteSelectedDates() {
                const checkboxes = document.querySelectorAll('.date-delete-checkbox:checked');
                if (checkboxes.length === 0) {
                    showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ—¥æœŸ', 'warning');
                    return;
                }

                if (!confirm(`ç¡®è®¤è¦åˆ é™¤é€‰ä¸­çš„ ${checkboxes.length} ä¸ªæ—¥æœŸçš„æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                    return;
                }

                let deletedCount = 0;
                checkboxes.forEach(cb => {
                    const date = cb.value;
                    localStorage.removeItem(`tpi_data_${date}`);
                    deletedCount++;
                });

                updateStorageIndicator();
                closeAllModals();
                showNotification(`âœ… å·²åˆ é™¤ ${deletedCount} æ¡è®°å½•`, 'success');
            }

            // æ–°å¢ï¼šå‰å¾€æ•°æ®ç®¡ç†
            function goToDataManagement() {
                closeAllModals();
                // æ»šåŠ¨åˆ°æ•°æ®å·¥åŠåŒºåŸŸ
                const dataSection = document.querySelector('h2:contains("æ•°æ®å·¥åŠ")');
                if (dataSection) {
                    dataSection.scrollIntoView({ behavior: 'smooth' });
                }
            }

            // ã€ä¼˜åŒ–6ã€‘å¯¼å‡ºæ‰€æœ‰æ•°æ®
            function exportAllData() {
                try {

                    const allData = {};
                    let count = 0;

                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key) && key.startsWith('tpi_data_')) {
                            try {
                                allData[key] = JSON.parse(localStorage[key]);
                                count++;
                            } catch (e) {
                                console.warn('è·³è¿‡æ— æ•ˆæ•°æ®:', key, e);
                            }
                        }
                    }

                    if (count === 0) {
                        alert('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯å¯¼å‡ºçš„æ•°æ®\n\nè¯·å…ˆå½•å…¥ä¸€äº›æ•°æ®åå†å¯¼å‡º');
                        return;
                    }

                    // æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯
                    const exportData = {
                        version: window.TPI_DATA_VERSION || '4.2',
                        exportDate: new Date().toISOString(),
                        dataCount: count,
                        data: allData
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `TPI_å®Œæ•´å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
                    link.click();
                    URL.revokeObjectURL(url);

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    if (window.showNotification && typeof window.showNotification === 'function') {
                        showNotification(`âœ… å·²å¯¼å‡º ${count} æ¡è®°å½•`, 'success');
                    }

                    if (window.SuccessNotifier) {
                        window.SuccessNotifier.showExportSuccess(`${count} æ¡è®°å½•`);
                    }

                    alert(`âœ… å¯¼å‡ºæˆåŠŸï¼\n\nå…±å¯¼å‡º ${count} æ¡è®°å½•\næ–‡ä»¶å: TPI_å®Œæ•´å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`);

                    if (window.logUserAction && typeof window.logUserAction === 'function') {
                        logUserAction('å¯¼å‡ºæ‰€æœ‰æ•°æ®', { count: count });
                    }
                } catch (error) {
                    console.error('å¯¼å‡ºå¤±è´¥:', error);
                    alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
                    if (window.showNotification && typeof window.showNotification === 'function') {
                        showNotification('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
                    }
                }
            }

            // å°†exportAllDataæš´éœ²åˆ°å…¨å±€
            window.exportAllDataGlobal = exportAllData;

            // ã€ä¼˜åŒ–7ã€‘å¯¼å…¥æ‰€æœ‰æ•°æ®
            function importAllData(event) {
                console.log('ğŸ“¥ [importAllData] å¯¼å…¥æ•°æ®åŠŸèƒ½è¢«è°ƒç”¨');
                console.log('ğŸ“¥ [importAllData] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
                
                try {
                    const file = event.target.files[0];
                    if (!file) {
                        console.warn('âš ï¸ [importAllData] æœªé€‰æ‹©æ–‡ä»¶');
                        return;
                    }
                    
                    console.log('ğŸ“¥ [importAllData] é€‰æ‹©çš„æ–‡ä»¶:', file.name, 'å¤§å°:', Math.round(file.size / 1024), 'KB');

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        console.log('ğŸ“¥ [importAllData] æ–‡ä»¶è¯»å–å®Œæˆ');
                        try {
                            const importData = JSON.parse(e.target.result);
                            console.log('ğŸ“¥ [importAllData] JSONè§£ææˆåŠŸ');

                            // éªŒè¯æ•°æ®æ ¼å¼
                            if (!importData.data || typeof importData.data !== 'object') {
                                console.error('âŒ [importAllData] æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                                throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                            }
                            
                            console.log('ğŸ“¥ [importAllData] å¾…å¯¼å…¥è®°å½•æ•°:', Object.keys(importData.data).length);

                            // æ•°æ®è¿ç§»å¤„ç†
                            const migratedData = migrateDataIfNeeded(importData);
                            console.log('ğŸ“¥ [importAllData] æ•°æ®è¿ç§»å¤„ç†å®Œæˆ');

                            // è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦†ç›–
                            const existingKeys = Object.keys(localStorage).filter(k => k.startsWith('tpi_data_'));
                            let message = `å³å°†å¯¼å…¥ ${Object.keys(migratedData.data).length} æ¡è®°å½•`;
                            if (existingKeys.length > 0) {
                                message += `\nå½“å‰æœ‰ ${existingKeys.length} æ¡æœ¬åœ°è®°å½•\n\næ˜¯å¦è¦†ç›–ç°æœ‰æ•°æ®?`;
                            }
                            
                            console.log('ğŸ“¥ [importAllData] ç­‰å¾…ç”¨æˆ·ç¡®è®¤...');

                            if (!confirm(message)) {
                                console.log('âŒ [importAllData] ç”¨æˆ·å–æ¶ˆå¯¼å…¥');
                                event.target.value = '';
                                return;
                            }
                            
                            console.log('âœ… [importAllData] ç”¨æˆ·ç¡®è®¤å¯¼å…¥ï¼Œå¼€å§‹å†™å…¥æ•°æ®...');

                            // å¯¼å…¥æ•°æ®
                            let successCount = 0;
                            for (let key in migratedData.data) {
                                if (key.startsWith('tpi_data_')) {
                                    localStorage.setItem(key, JSON.stringify(migratedData.data[key]));
                                    successCount++;
                                }
                            }
                            
                            console.log('âœ… [importAllData] æ•°æ®å¯¼å…¥å®Œæˆï¼ŒæˆåŠŸå¯¼å…¥:', successCount, 'æ¡è®°å½•');

                            showNotification(`âœ… æˆåŠŸå¯¼å…¥ ${successCount} æ¡è®°å½•`, 'success');
                            // ä½¿ç”¨æ–°çš„æˆåŠŸæç¤ºç³»ç»Ÿ
                            if (window.SuccessNotifier) {
                                window.SuccessNotifier.showImportSuccess(`${successCount} æ¡è®°å½•`);
                            }
                            loadFromLocalStorage();
                            updateStorageIndicator();
                            logUserAction('å¯¼å…¥æ•°æ®', { count: successCount });
                            
                            console.log('âœ… [importAllData] ç•Œé¢æ›´æ–°å®Œæˆ');
                        } catch (error) {
                            console.error('âŒ [importAllData] å¯¼å…¥å¤±è´¥:', error);
                            console.error('âŒ [importAllData] é”™è¯¯å †æ ˆ:', error.stack);
                            showNotification('âŒ å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
                        }
                        event.target.value = '';
                    };
                    
                    console.log('ğŸ“¥ [importAllData] å¼€å§‹è¯»å–æ–‡ä»¶...');
                    reader.readAsText(file);
                } catch (error) {
                    console.error('âŒ [importAllData] è¯»å–æ–‡ä»¶å¤±è´¥:', error);
                    console.error('âŒ [importAllData] é”™è¯¯å †æ ˆ:', error.stack);
                    showNotification('âŒ è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
                    event.target.value = '';
                }
            }

            // ã€ä¼˜åŒ–8ã€‘å¯†ç å¼ºåº¦æ£€æµ‹
            function checkPasswordStrength(password) {
                const strengthBar = document.getElementById('strength-bar-fill');
                const strengthText = document.getElementById('strength-text');
                const strengthContainer = document.getElementById('password-strength');

                if (!password || !strengthBar || !strengthText || !strengthContainer) return;

                strengthContainer.style.display = 'block';

                let strength = 0;
                let label = '';

                // é•¿åº¦æ£€æŸ¥
                if (password.length >= 8) strength += 25;
                if (password.length >= 12) strength += 15;

                // å¤æ‚åº¦æ£€æŸ¥
                if (/[a-z]/.test(password)) strength += 15;
                if (/[A-Z]/.test(password)) strength += 15;
                if (/[0-9]/.test(password)) strength += 15;
                if (/[^a-zA-Z0-9]/.test(password)) strength += 15;

                // åˆ¤æ–­ç­‰çº§
                if (strength < 40) {
                    label = 'å¼±';
                    strengthBar.className = 'strength-bar-fill strength-weak';
                } else if (strength < 70) {
                    label = 'ä¸­ç­‰';
                    strengthBar.className = 'strength-bar-fill strength-medium';
                } else {
                    label = 'å¼º';
                    strengthBar.className = 'strength-bar-fill strength-strong';
                }

                strengthBar.style.width = strength + '%';
                strengthText.textContent = `å¯†ç å¼ºåº¦: ${label}`;
            }

            // ã€ä¼˜åŒ–9ã€‘å…¨å±€é”™è¯¯æ•è·
            function initializeErrorLogger() {
                window.addEventListener('error', function(event) {
                    const errorLog = {
                        message: event.message,
                        source: event.filename,
                        line: event.lineno,
                        column: event.colno,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    };

                    console.error('æ•è·åˆ°é”™è¯¯:', errorLog);

                    // ä¿å­˜åˆ°localStorageç”¨äºè°ƒè¯•
                    try {
                        const logs = JSON.parse(localStorage.getItem('tpi_error_logs') || '[]');
                        logs.push(errorLog);
                        // åªä¿ç•™æœ€è¿‘20æ¡é”™è¯¯
                        if (logs.length > 20) logs.shift();
                        localStorage.setItem('tpi_error_logs', JSON.stringify(logs));
                    } catch (e) {
                        console.error('æ— æ³•ä¿å­˜é”™è¯¯æ—¥å¿—:', e);
                    }
                });
            }

            // ã€ä¼˜åŒ–10ã€‘ç”¨æˆ·æ“ä½œæ—¥å¿—
            function logUserAction(action, details = {}) {
                try {
                    const log = {
                        action,
                        details,
                        timestamp: new Date().toISOString()
                    };

                    const logs = JSON.parse(localStorage.getItem('tpi_action_logs') || '[]');
                    logs.push(log);
                    // åªä¿ç•™æœ€è¿‘100æ¡æ“ä½œ
                    if (logs.length > 100) logs.shift();
                    localStorage.setItem('tpi_action_logs', JSON.stringify(logs));
                } catch (error) {
                    console.error('æ“ä½œæ—¥å¿—è®°å½•å¤±è´¥:', error);
                }
            }

            // ã€ä¼˜åŒ–11ã€‘å¸®åŠ©ç³»ç»Ÿ
            // ã€ä¼˜åŒ–12ã€‘æ”¹è¿›çš„äº‘ç«¯åŒæ­¥(å¸¦å†²çªæ£€æµ‹)
            function enhancedSaveToFirebase() {
                saveToLocalStorage();
                const dateInput = document.getElementById('date-input').value;
                if (!dateInput) {
                    showNotification('âš ï¸ æ—¥æœŸä¸èƒ½ä¸ºç©º', 'warning');
                    return;
                }

                const localKey = `tpi_data_${dateInput}`;
                const dataStr = localStorage.getItem(localKey);
                if (!dataStr) {
                    showNotification('âŒ æ•°æ®è·å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    return;
                }

                const data = JSON.parse(dataStr);
                data.version = window.TPI_DATA_VERSION || '1.0';
                data.lastModified = new Date().toISOString();

                // FirebaseåŒæ­¥å·²ç§»é™¤ï¼Œæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                showNotification('âœ… æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨', 'success');
                logUserAction('æœ¬åœ°ä¿å­˜', { date: dateInput });
            }

            // ==================== v15 å¢å¼ºåŠŸèƒ½ç»“æŸ ====================

            // ==================== å…¬å…±API ====================
            return {
                // åˆå§‹åŒ–
                initialize,

                // æŠ˜å åŠŸèƒ½
                toggleCard,
                toggleRules,
                toggleMobileMenu,

                // æ¨¡å¼é€‰æ‹©
                selectMode,
                updateVacationTarget,

                // è®¡ç®—åŠŸèƒ½
                handleTypeChange,
                handleViolation,
                generateDailyReport,
                calculateAllScores,
                calculateAMI,
                calculateFLI,
                calculateBCM,
                calculateLogistics,
                calculateHSM,
                calculateBonus,
                calculateTPI,

        // æ•°æ®æŒä¹…åŒ–
                saveToLocalStorage,
                loadFromLocalStorage,
                saveToFirebase,
                loadFromFirebase,
                exportData,
                importData,
                resetForm,
                backupAllData,
                restoreBackup,
                updateStatistics,

                // æ•°æ®å¯¼å‡º
                exportByPeriod,
                exportCustomRange,

                // æ•°æ®å¯è§†åŒ–
                initializeTrendChart,
                updateTrendChart,
                initializeHeatmapCalendar,
                updateBadges,
                exportChart,
                loadHistoryData,

                // æŠ¥å‘Šç”Ÿæˆ
                generateWeeklyReport,
                generateMonthlyReport,
                exportReport,

                // å·¥å…·å‡½æ•°
                safeParseFloat,
                safeParseInt,
                timeToMinutes,
                compareTime,
                validateInput,
                showNotification,

                // v15 æ–°å¢åŠŸèƒ½
                exportAllData,
                importAllData,
                // showHelpDialog removed in ç¬¬ 20 ç‰ˆ
                updateStorageIndicator,
                initializeDateNavigation,
                initializeNetworkMonitor,
                checkPasswordStrength,
                enhancedSaveToFirebase
            };
        })();

     // ==================== é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', TPI.initialize);

        // ã€å…³é”®ä¿®æ­£ã€‘å°† TPI æŒ‚è½½åˆ°å…¨å±€ï¼Œè®©åº•éƒ¨çš„äº‘ç«¯è„šæœ¬èƒ½æ‰¾åˆ°å®ƒå¹¶è¿›è¡Œå‡çº§
        window.TPI = TPI;
        
        // ã€ä¿®å¤ã€‘è¡¥é½ TPI.calculateSystemï¼šé¿å…é‡ç®—/å¯¼å‡º/åŒæ­¥æ—¶ onchange æŠ¥é”™
        // æ³¨ï¼šå¿…é¡»åœ¨ window.TPI = TPI ä¹‹åå®šä¹‰ï¼Œå¦åˆ™ä¼šè¢«è¦†ç›–
        if (typeof window.TPI.calculateSystem !== 'function') {
            window.TPI.calculateSystem = function () {
                try {
                    // ä¼˜å…ˆèµ°æ•´ç«™ç»Ÿä¸€è®¡ç®—
                    if (typeof window.TPI.calculateTPI === 'function') {
                        return window.TPI.calculateTPI();
                    }
                    if (typeof window.TPI.calculateAllScores === 'function') {
                        return window.TPI.calculateAllScores();
                    }
                    // å¦‚æœTPIå¯¹è±¡è¿˜æœªå®Œå…¨åŠ è½½,å°è¯•è°ƒç”¨å…¨å±€calculateTPIå‡½æ•°
                    if (typeof window.calculateTPI === 'function') {
                        return window.calculateTPI();
                    }
                    // TPIå¯¹è±¡æœªåŠ è½½æ—¶,ä¸åšä»»ä½•æ“ä½œ(é¿å…æŠ¥é”™)
                    return;
                } catch (e) {
                    // ä¸æŠŠå¼‚å¸¸å¤–æŠ›,é¿å…ä¸­æ–­å¯¼å‡º/åŒæ­¥
                    console.warn('[TPI.calculateSystem] safe-failed:', e);
                }
            };
        }
        
        // ã€äº‘ç«¯åŒæ­¥ä¿®å¤ã€‘å°†å…³é”®å‡½æ•°ä¹ŸæŒ‚è½½åˆ°window,ä¾›è¡¥ä¸ä»£ç ä½¿ç”¨
        if (typeof TPI.calculateTPI === 'function') {
            window.calculateTPI = TPI.calculateTPI;
        }
        if (typeof TPI.calculateAllScores === 'function') {
            window.calculateAllScores = TPI.calculateAllScores;
        }

        // ===== ç¨³å®šæ€§ä¿®å¤ï¼šè¡¥é½ç¼ºå¤±å‡½æ•°ï¼ˆä¸å½±å“å®æ—¶è®¡åˆ†/æŠ˜å ï¼‰ =====
        // 1) æŸäº›è¾“å…¥æ¡†äº‹ä»¶ä¼šè°ƒç”¨ TPI.checkOverloadï¼›æ—§ç¨¿ä¸­ç¼ºå¤±ä¼šå¯¼è‡´é‡ç®—/å¯¼å‡ºä¸­æ–­
        if (typeof TPI.checkOverload !== 'function') {
            TPI.checkOverload = function () {
                try {
                    const totalEl = document.getElementById('tpi-total');
                    const ratingEl = document.getElementById('tpi-rating');
                    if (!totalEl) return;
                    const v = Number(totalEl.value || 0);
                    if (ratingEl) {
                        let r = '';
                        if (v < 95) r = 'poor';
                        else if (v <= 120) r = 'normal';
                        else if (v <= 155) r = 'good';
                        else r = 'excellent';
                        ratingEl.value = r;
                    }
                } catch (_) {}
            };
        }

        // 0) å…¨ç«™æ‹¦æˆªé˜»å¡å¼ alertï¼ˆé¿å…â€œå¼¹çª—å¡æ­»/æºç å¤–éœ²â€ï¼‰ï¼Œç»Ÿä¸€æ”¹ä¸ºç«™å†…æç¤º
        if (!window.__TPI_ALERT_PATCHED__) {
            window.__TPI_ALERT_PATCHED__ = true;
            const __oldAlert = window.alert;
            window.alert = function (msg) {
                try {
                    if (typeof showNotification === 'function') {
                        showNotification(String(msg || ''), 'info');
                    } else if (typeof tpiToast === 'function') {
                        tpiToast(String(msg || ''));
                    } else {
                        console.log('[alert]', msg);
                    }
                } catch (_) {
                    try { console.log('[alert]', msg); } catch(_) {}
                }
            };
            // ä¿ç•™åŸå§‹å¼•ç”¨ï¼ˆå¦‚ç¡®å®éœ€è¦å¯æ‰‹åŠ¨è°ƒç”¨ window.__TPI_OLD_ALERT__ï¼‰
            window.__TPI_OLD_ALERT__ = __oldAlert;
        }

        // 2) å…¼å®¹â€œé«˜çº§åˆ†æ/æ—§æŒ‰é’®â€é‡Œå¯¹å…¨å±€ generateWeeklyReport/generateMonthlyReport çš„è°ƒç”¨
        //    ç»Ÿä¸€è½¬å‘åˆ° window.TPIï¼Œé¿å…å‡ºç°â€œå‡½æ•°æœªå®šä¹‰â€ä¸å¼¹çª—ã€‚
        if (typeof window.generateWeeklyReport !== 'function') {
            window.generateWeeklyReport = function () {
                try {
                    if (window.TPI && typeof window.TPI.generateWeeklyReport === 'function') {
                        return window.TPI.generateWeeklyReport();
                    }
                } catch (_) {}
            };
        }
        if (typeof window.generateMonthlyReport !== 'function') {
            window.generateMonthlyReport = function () {
                try {
                    if (window.TPI && typeof window.TPI.generateMonthlyReport === 'function') {
                        return window.TPI.generateMonthlyReport();
                    }
                } catch (_) {}
            };
        }

// ã€ä¿®å¤é—®é¢˜4ã€‘å¢å¼ºTPI.loadFromLocalStorageï¼Œæ·»åŠ å®Œæ•´çš„æ—¥å¿—å’Œé”™è¯¯å¤„ç†
        (function() {
            const originalLoadFromLocal = window.TPI.loadFromLocalStorage;
            if (originalLoadFromLocal && typeof originalLoadFromLocal === 'function') {
                window.TPI.loadFromLocalStorage = function() {
                    console.log('ğŸ“‚ [TPI.loadFromLocalStorage] ä»…è¯»æœ¬åœ°åŠŸèƒ½è¢«è°ƒç”¨');
                    console.log('ğŸ“‚ [TPI.loadFromLocalStorage] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
                    
                    try {
                        // è·å–å½“å‰æ—¥æœŸ
                        const dateInput = document.getElementById('date-input');
                        const dateStr = dateInput ? dateInput.value : '';
                        
                        console.log('ğŸ“… [TPI.loadFromLocalStorage] ç›®æ ‡æ—¥æœŸ:', dateStr);
                        
                        if (!dateStr) {
                            console.warn('âš ï¸ [TPI.loadFromLocalStorage] æœªé€‰æ‹©æ—¥æœŸ');
                            alert('âš ï¸ è¯·å…ˆé€‰æ‹©è¦åŠ è½½çš„æ—¥æœŸ');
                            return;
                        }
                        
                        const key = 'tpi_data_' + dateStr;
                        console.log('ğŸ”‘ [TPI.loadFromLocalStorage] æ•°æ®é”®:', key);
                        
                        // æ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨
                        const dataStr = localStorage.getItem(key);
                        if (!dataStr) {
                            console.warn('âš ï¸ [TPI.loadFromLocalStorage] æœªæ‰¾åˆ°æ•°æ®');
                            alert('âš ï¸ æœªæ‰¾åˆ°è¯¥æ—¥æœŸçš„ä¿å­˜æ•°æ®\n\næ—¥æœŸ: ' + dateStr + '\nkey: ' + key);
                            return;
                        }
                        
                        console.log('ğŸ“Š [TPI.loadFromLocalStorage] æ‰¾åˆ°æ•°æ®ï¼Œå¤§å°:', Math.round(dataStr.length / 1024), 'KB');
                        
                        // è°ƒç”¨åŸå§‹å‡½æ•°
                        console.log('ğŸ”§ [TPI.loadFromLocalStorage] è°ƒç”¨åŸå§‹åŠ è½½å‡½æ•°...');
                        originalLoadFromLocal.apply(this, arguments);
                        console.log('âœ… [TPI.loadFromLocalStorage] æ•°æ®åŠ è½½å®Œæˆ');
                        
                    } catch (error) {
                        console.error('âŒ [TPI.loadFromLocalStorage] åŠ è½½å¤±è´¥:', error);
                        console.error('âŒ [TPI.loadFromLocalStorage] é”™è¯¯åç§°:', error.name);
                        console.error('âŒ [TPI.loadFromLocalStorage] é”™è¯¯æ¶ˆæ¯:', error.message);
                        console.error('âŒ [TPI.loadFromLocalStorage] é”™è¯¯å †æ ˆ:', error.stack);
                        alert('âŒ åŠ è½½å¤±è´¥\n\né”™è¯¯: ' + error.message + '\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯');
                    }
                };
                console.log('âœ… [ä¿®å¤é—®é¢˜4] TPI.loadFromLocalStorage å·²å¢å¼º');
            } else {
                console.error('âŒ [ä¿®å¤é—®é¢˜4] æœªæ‰¾åˆ°åŸå§‹çš„loadFromLocalStorageå‡½æ•°');
            }
        })();
        
// ==================== è±å…è®¡æ•°ç®¡ç†ç³»ç»Ÿ ====================
        const ExemptionManager = {
            STORAGE_KEY: 'tpi_exemption_weekly',

            /**
             * è·å–æœ¬å‘¨çš„å‘¨ä¸€æ—¥æœŸé”®ï¼ˆæ ¼å¼: YYYY-MM-DDï¼‰
             */
            getWeekKey: function() {
                const now = new Date();
                const monday = new Date(now);
                const day = monday.getDay();
                const diff = monday.getDate() - day + (day === 0 ? -6 : 1); // è°ƒæ•´åˆ°å‘¨ä¸€
                monday.setDate(diff);
                monday.setHours(0, 0, 0, 0);
                return monday.toISOString().split('T')[0];
            },

            /**
             * è·å–è±å…æ•°æ®ï¼ˆå¦‚æœæ˜¯æ–°å‘¨åˆ™è‡ªåŠ¨é‡ç½®ï¼‰
             */
            getData: function() {
                const weekKey = this.getWeekKey();
                try {
                    const stored = localStorage.getItem(this.STORAGE_KEY);
                    const data = stored ? JSON.parse(stored) : {};

                    // å¦‚æœå‘¨æœŸå·²è¿‡ï¼Œé‡ç½®è®¡æ•°
                    if (data.week !== weekKey) {
                        return { week: weekKey, aCount: 0, bCount: 0 };
                    }
                    return data;
                } catch(e) {
                    console.error('è¯»å–è±å…æ•°æ®å¤±è´¥:', e);
                    return { week: weekKey, aCount: 0, bCount: 0 };
                }
            },

            /**
             * ä¿å­˜è±å…æ•°æ®åˆ°localStorage
             */
            saveData: function(data) {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
                } catch(e) {
                    console.error('ä¿å­˜è±å…æ•°æ®å¤±è´¥:', e);
                }
            },

            /**
             * æ›´æ–°ç•Œé¢æ˜¾ç¤ºçš„è®¡æ•°å™¨
             */
            updateDisplay: function() {
                const data = this.getData();
                const aEl = document.getElementById('exemption-a-count');
                const bEl = document.getElementById('exemption-b-count');

                if (aEl) {
                    aEl.textContent = data.aCount;
                    aEl.style.color = data.aCount >= 2 ? '#dc2626' : '#059669';
                    aEl.style.fontWeight = data.aCount >= 2 ? 'bold' : 'normal';
                }
                if (bEl) {
                    bEl.textContent = data.bCount;
                    bEl.style.color = data.bCount >= 2 ? '#dc2626' : '#059669';
                    bEl.style.fontWeight = data.bCount >= 2 ? 'bold' : 'normal';
                }

                // æ›´æ–°checkboxçŠ¶æ€
                this.updateCheckboxes(data);
            },

            /**
             * æ ¹æ®ä½¿ç”¨æ¬¡æ•°ç¦ç”¨/å¯ç”¨checkbox
             */
            updateCheckboxes: function(data) {
                const aBoxes = document.querySelectorAll('input[name="exemption-a"]');
                const bBoxes = document.querySelectorAll('input[name="exemption-b"]');

                // å¤„ç†Aç±»è±å…checkbox
                aBoxes.forEach(cb => {
                    if (data.aCount >= 2 && !cb.checked) {
                        cb.disabled = true;
                        cb.title = 'æœ¬å‘¨Aç±»è±å…å·²ç”¨å°½ï¼ˆ2/2æ¬¡ï¼‰';
                        if (cb.parentElement) {
                            cb.parentElement.style.opacity = '0.5';
                            cb.parentElement.style.cursor = 'not-allowed';
                        }
                    } else {
                        cb.disabled = false;
                        cb.title = '';
                        if (cb.parentElement) {
                            cb.parentElement.style.opacity = '1';
                            cb.parentElement.style.cursor = 'pointer';
                        }
                    }
                });

                // å¤„ç†Bç±»è±å…checkbox
                bBoxes.forEach(cb => {
                    if (data.bCount >= 2 && !cb.checked) {
                        cb.disabled = true;
                        cb.title = 'æœ¬å‘¨Bç±»è±å…å·²ç”¨å°½ï¼ˆ2/2æ¬¡ï¼‰';
                        if (cb.parentElement) {
                            cb.parentElement.style.opacity = '0.5';
                            cb.parentElement.style.cursor = 'not-allowed';
                        }
                    } else {
                        cb.disabled = false;
                        cb.title = '';
                        if (cb.parentElement) {
                            cb.parentElement.style.opacity = '1';
                            cb.parentElement.style.cursor = 'pointer';
                        }
                    }
                });
            },

            /**
             * è®°å½•è±å…ä½¿ç”¨æƒ…å†µ
             * @param {string} type - 'A' æˆ– 'B'
             * @param {boolean} checked - checkboxæ˜¯å¦è¢«å‹¾é€‰
             * @returns {boolean} - æ˜¯å¦å…è®¸æ­¤æ“ä½œ
             */
            recordUsage: function(type, checked) {
                const data = this.getData();

                if (type === 'A') {
                    if (checked) {
                        // å‹¾é€‰ï¼šå¢åŠ è®¡æ•°
                        if (data.aCount < 2) {
                            data.aCount++;
                        } else {
                            console.warn(`ğŸš« [ä¿®å¤4] Aç±»è±å…å·²è¾¾ä¸Šé™,å·²æ‹¦æˆª`);
                            alert('âš ï¸ Aç±»è±å…æœ¬å‘¨å·²ç”¨å°½ï¼ˆ2/2æ¬¡ï¼‰\n\nAç±»è±å…ç”¨äºç³»ç»Ÿå…³é”®æ¢å¤ä¸å¿ƒç†è°ƒèŠ‚ï¼Œå¦‚"æµ·æ˜å¨æ¡¥æ–­è¿é‡è¿"ã€"ç„¦è™‘é˜»æ–­æ‰§è¡Œ"ã€‚\n\nå»ºè®®è€ƒè™‘å…¶ä»–è°ƒæ•´æ–¹å¼æˆ–è¿›å…¥å¤è‹æ¨¡å¼ã€‚');
                            return false;
                        }
                    } else {
                        // å–æ¶ˆå‹¾é€‰ï¼šå‡å°‘è®¡æ•°
                        if (data.aCount > 0) data.aCount--;
                    }
                } else if (type === 'B') {
                    if (checked) {
                        // å‹¾é€‰ï¼šå¢åŠ è®¡æ•°
                        if (data.bCount < 2) {
                            data.bCount++;
                        } else {
                            console.warn(`ğŸš« [ä¿®å¤4] Bç±»è±å…å·²è¾¾ä¸Šé™,å·²æ‹¦æˆª`);
                            alert('âš ï¸ Bç±»è±å…æœ¬å‘¨å·²ç”¨å°½ï¼ˆ2/2æ¬¡ï¼‰\n\nBç±»è±å…ç”¨äºæ—¥å¸¸å¼¹æ€§è°ƒæ•´ï¼Œå¦‚æ— ç†ç”±è±å…ã€è½»å¾®è§„åˆ™è°ƒæ•´ã€‚\n\nå»ºè®®ä¸¥æ ¼æ‰§è¡Œè§„åˆ™æˆ–è€ƒè™‘è°ƒæ•´æ¨¡å¼ã€‚');
                            return false;
                        }
                    } else {
                        // å–æ¶ˆå‹¾é€‰ï¼šå‡å°‘è®¡æ•°
                        if (data.bCount > 0) data.bCount--;
                    }
                }

                // ä¿å­˜å¹¶æ›´æ–°æ˜¾ç¤º
                this.saveData(data);
                this.updateDisplay();
                return true;
            },

            /**
             * åˆå§‹åŒ–ï¼šç»‘å®šäº‹ä»¶ç›‘å¬å™¨
             */
            initialize: function() {
                // åˆå§‹æ˜¾ç¤º
                this.updateDisplay();

                // ç»‘å®šAç±»è±å…checkboxäº‹ä»¶
                const aBoxes = document.querySelectorAll('input[name="exemption-a"]');
                aBoxes.forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        if (!this.recordUsage('A', e.target.checked)) {
                            e.target.checked = false; // å¦‚æœä¸å…è®¸ï¼Œå–æ¶ˆå‹¾é€‰
                        }
                    });
                });

                // ç»‘å®šBç±»è±å…checkboxäº‹ä»¶
                const bBoxes = document.querySelectorAll('input[name="exemption-b"]');
                bBoxes.forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        if (!this.recordUsage('B', e.target.checked)) {
                            e.target.checked = false; // å¦‚æœä¸å…è®¸ï¼Œå–æ¶ˆå‹¾é€‰
                        }
                    });
                });

            }
        };

        // åœ¨é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–è±å…è®¡æ•°å™¨
        document.addEventListener('DOMContentLoaded', function() {
            ExemptionManager.initialize();
        });

        // ==================== å¢å¼ºçš„é”™è¯¯å¤„ç†ç³»ç»Ÿ ====================

        /**
         * ç»Ÿä¸€é”™è¯¯å¤„ç†å‡½æ•°
         * @param {Error} error - é”™è¯¯å¯¹è±¡
         * @param {string} context - é”™è¯¯ä¸Šä¸‹æ–‡
         */
        function handleError(error, context = 'æœªçŸ¥æ“ä½œ') {
            console.error(`[${context}] é”™è¯¯:`, error);

            // å¼€å‘æ¨¡å¼ä¸‹æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                showNotification(`${context}å¤±è´¥: ${error.message}`, 'error');
            } else {
                // ç”Ÿäº§æ¨¡å¼ä¸‹æ˜¾ç¤ºå‹å¥½æç¤º
                showNotification(`${context}æ—¶å‡ºç°é—®é¢˜,è¯·é‡è¯•`, 'error');
            }
        }

        // æ•è·æœªå¤„ç†çš„ Promise é”™è¯¯
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„ Promise æ‹’ç»:', event.reason);
            event.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
        });

        // æ•è·å…¨å±€é”™è¯¯
        window.addEventListener('error', function(event) {
            // è¿‡æ»¤æ‰é€šç”¨çš„Script errorï¼ˆè¿™é€šå¸¸æ˜¯è·¨åŸŸè„šæœ¬å¼•èµ·çš„ï¼Œæ— éœ€è®°å½•ï¼‰
            if (event.message === 'Script error.' || event.message === 'Script error') {
                return; // å¿½ç•¥è¿™ç±»é”™è¯¯
            }
            console.error('å…¨å±€é”™è¯¯:', event.error || event.message);
            // ä¸æ˜¾ç¤ºå¼¹çª—,é¿å…å¹²æ‰°ç”¨æˆ·
        });

        // ==================== å…¨å±€é”™è¯¯å¤„ç† ====================
        window.addEventListener('error', function(event) {
            // è¿‡æ»¤æ‰é€šç”¨çš„Script error
            if (event.message === 'Script error.' || event.message === 'Script error') {
                return;
            }
            console.error('å…¨å±€é”™è¯¯:', event.error);
            // é”™è¯¯å·²è®°å½•åˆ°æ§åˆ¶å°ï¼Œä¸æ˜¾ç¤ºå¼¹çª—ä»¥å…å¹²æ‰°ç”¨æˆ·
        });

        // é˜²æ­¢æœªæ•è·çš„Promiseé”™è¯¯
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
            // é”™è¯¯å·²è®°å½•åˆ°æ§åˆ¶å°ï¼Œä¸æ˜¾ç¤ºå¼¹çª—ä»¥å…å¹²æ‰°ç”¨æˆ·
        });

        // æ·»åŠ ç§»åŠ¨ç«¯è§¦æ‘¸æ”¯æŒ
        document.addEventListener('touchstart', function() {}, {passive: true});

        // é˜»æ­¢ç§»åŠ¨ç«¯åŒå‡»ç¼©æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
  </script>
  <style>
   /* è¡¥å…¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
     .quick-nav-group{position:fixed;right:20px;bottom:100px;z-index:9999;display:flex;flex-direction:column;gap:10px;}.quick-btn{width:45px;height:45px;background-color:rgba(37, 99, 235, 0.9);color:white;border:none;border-radius:50%;font-size:20px;cursor:pointer;box-shadow:0 4px 6px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;transition:all 0.2s ease;}.quick-btn:hover{background-color:#1e40af;transform:scale(1.1);}@media (max-width:768px){.quick-nav-group{right:15px;bottom:90px;}.quick-btn{width:40px;height:40px;font-size:18px;opacity:0.8;}}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity 0.5s ease;}.loading-overlay.fade-out{opacity:0;}.loading-spinner{width:60px;height:60px;border:4px solid rgba(255, 255, 255, 0.3);border-top-color:white;border-radius:50%;animation:spin 1s linear infinite;}@keyframes spin{to{transform:rotate(360deg);}}.loading-text{margin-top:var(--spacing-6);color:white;font-size:var(--font-size-xl);font-weight:600;}.loading-version{margin-top:var(--spacing-2);color:rgba(255, 255, 255, 0.8);font-size:var(--font-size-sm);}@media (max-width:768px){table{display:block;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;}button, .btn, .quick-nav-btn-v19, input[type="button"], input[type="submit"]{min-height:44px;min-width:44px;padding:10px 16px;}.input-group{flex-direction:column;gap:var(--spacing-2);}.card{padding:var(--spacing-3);margin-bottom:var(--spacing-3);}.quick-nav-v19{flex-wrap:wrap;gap:8px;}.quick-nav-btn-v19{font-size:12px;padding:8px 12px;}body{font-size:14px;}h1{font-size:24px;}h2{font-size:20px;}h3{font-size:18px;}input[type="number"], input[type="text"], input[type="time"], input[type="date"], select, textarea{font-size:16px;min-height:44px;}.section{padding:var(--spacing-3);}.row, .flex-row{flex-direction:column;}.modal-content{width:95%;max-width:95%;margin:10px auto;}.desktop-only{display:none !important;}}@media (max-width:480px){.card{padding:var(--spacing-2);margin-bottom:var(--spacing-2);}.quick-nav-btn-v19{font-size:11px;padding:6px 10px;}table{font-size:12px;}th, td{padding:6px;}}@media (min-width:769px) and (max-width:1024px){.container{max-width:95%;}.grid-3{grid-template-columns:repeat(2, 1fr);}}@media (hover:none) and (pointer:coarse){a, button, input, select, textarea{min-height:44px;min-width:44px;}button:hover, .btn:hover{transform:none;}}@media (max-width:768px) and (orientation:landscape){.quick-nav-container-v19{max-height:50vh;overflow-y:auto;}}
  </style>
  <div class="quick-nav-group">
   <button class="quick-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" title="å›åˆ°é¡¶éƒ¨">
    â¬†ï¸
   </button>
   <button class="quick-btn" onclick="window.scrollTo({top: document.documentElement.scrollHeight / 2, behavior: 'smooth'})" title="å›åˆ°ä¸­é—´">
    ğŸ“
   </button>
   <button class="quick-btn" onclick="window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'})" title="å»åˆ°åº•éƒ¨">
    â¬‡ï¸
   </button>
  </div>
  <script>
   // ==================== ğŸ”§ GitHub Gist äº‘ç«¯åŒæ­¥æ¨¡å— ====================
  // ç­–ç•¥: ä½¿ç”¨ GitHub API æ›¿ä»£ Firebaseï¼Œä¿æŒæ•°æ®ç»“æ„å…¼å®¹
  
  const GIST_CONFIG = {
      get token() { return localStorage.getItem('tpi_gist_token') || ''; },
      get id() { return localStorage.getItem('tpi_gist_id') || 'dcfc30706cc7341c0bacdaa0777f5cd0'; },
      get filename() { return localStorage.getItem('tpi_gist_filename') || 'tpi_sync.json'; }
  };

  function logGist(msg, type = 'info') {
      const logDiv = document.getElementById('gist-sync-log');
      if (!logDiv) return;
      const time = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#ef4444' : (type === 'success' ? '#10b981' : '#6b7280');
      const entry = `<div style="color: ${color}; margin-bottom:2px;">[${time}] ${msg}</div>`;
      if (logDiv.innerHTML.includes('ç­‰å¾…æ“ä½œ')) logDiv.innerHTML = '';
      logDiv.innerHTML = entry + logDiv.innerHTML;
  }

  window.saveGistConfig = function() {
      const token = document.getElementById('gist-token').value.trim();
      const id = document.getElementById('gist-id').value.trim();
      const filename = document.getElementById('gist-filename').value.trim();
      
      if (!token) {
          alert('âš ï¸ è¯·è¾“å…¥ GitHub Token');
          return;
      }
      
      localStorage.setItem('tpi_gist_token', token);
      localStorage.setItem('tpi_gist_id', id);
      localStorage.setItem('tpi_gist_filename', filename);
      
      document.getElementById('gist-connection-status').textContent = 'å·²é…ç½®';
      document.getElementById('gist-connection-status').className = 'badge bg-success';
      
      alert('âœ… é…ç½®å·²ä¿å­˜');
      logGist('é…ç½®å·²æ›´æ–°', 'success');
  };

  window.fetchGist = async function() {
      const { token, id } = GIST_CONFIG;
      if (!token || !id) throw new Error('æœªé…ç½® Token æˆ– Gist ID');
      
      const resp = await fetch(`https://api.github.com/gists/${id}`, {
          headers: { 'Authorization': `token ${token}` }
      });
      
      if (resp.status === 401) throw new Error("Token æ— æ•ˆæˆ–å·²è¿‡æœŸ (401)ã€‚è¯·æ£€æŸ¥é…ç½®ä¸­çš„ GitHub Token æ˜¯å¦æ­£ç¡®ï¼Œå¹¶ç¡®ä¿å…¶å…·æœ‰ 'gist' æƒé™ã€‚");
      if (!resp.ok) throw new Error(`GitHub API é”™è¯¯: ${resp.status}`);
      return await resp.json();
  }

  window.updateGist = async function(content) {
      const { token, id, filename } = GIST_CONFIG;
      const resp = await fetch(`https://api.github.com/gists/${id}`, {
          method: 'PATCH',
          headers: {
              'Authorization': `token ${token}`,
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({
              files: {
                  [filename]: { content: JSON.stringify(content, null, 2) }
              }
          })
      });
      
      if (resp.status === 401) throw new Error("Token æ— æ•ˆæˆ–å·²è¿‡æœŸ (401)ã€‚è¯·æ£€æŸ¥é…ç½®ä¸­çš„ GitHub Token æ˜¯å¦æ­£ç¡®ï¼Œå¹¶ç¡®ä¿å…¶å…·æœ‰ 'gist' æƒé™ã€‚");
      if (!resp.ok) throw new Error(`æ›´æ–°å¤±è´¥: ${resp.status}`);
      return await resp.json();
  }

  window.performGistSync = async function(direction) {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'åŒæ­¥ä¸­...';
      
      try {
          if (direction === 'push') {
              logGist('æ­£åœ¨å‡†å¤‡ä¸Šä¼ æ•°æ®...');
              const allData = {};
              for (let i = 0; i < localStorage.length; i++) {
                  const key = localStorage.key(i);
                  if (key.startsWith('tpi_')) {
                      allData[key] = localStorage.getItem(key);
                  }
              }
              await updateGist(allData);
              logGist('âœ… æ•°æ®å·²æˆåŠŸæ¨é€åˆ°äº‘ç«¯', 'success');
              document.getElementById('gist-last-sync').textContent = new Date().toLocaleString();
              alert('âœ… äº‘ç«¯åŒæ­¥æˆåŠŸï¼');
          } else {
              logGist('æ­£åœ¨ä»äº‘ç«¯æ‹‰å–æ•°æ®...');
              const gistData = await fetchGist();
              const content = JSON.parse(gistData.files[GIST_CONFIG.filename].content);
              
              let count = 0;
              for (const key in content) {
                  localStorage.setItem(key, content[key]);
                  count++;
              }
              logGist(`âœ… æˆåŠŸæ‹‰å– ${count} é¡¹æ•°æ®`, 'success');
              document.getElementById('gist-last-sync').textContent = new Date().toLocaleString();
              alert('âœ… æ•°æ®åŠ è½½æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°ã€‚');
              location.reload();
          }
      } catch (err) {
          logGist(`âŒ é”™è¯¯: ${err.message}`, 'error');
          alert(`âŒ åŒæ­¥å¤±è´¥: ${err.message}`);
      } finally {
          btn.disabled = false;
          btn.textContent = originalText;
      }
  };

  // åˆå§‹åŒ–ç•Œé¢çŠ¶æ€
  document.addEventListener('DOMContentLoaded', () => {
      if (GIST_CONFIG.token) {
          document.getElementById('gist-token').value = GIST_CONFIG.token;
          document.getElementById('gist-connection-status').textContent = 'å·²é…ç½®';
          document.getElementById('gist-connection-status').className = 'badge bg-success';
      }
      // æ¨¡æ‹ŸåŸæœ‰çš„å­˜å‚¨ç©ºé—´æ˜¾ç¤º
      const used = (JSON.stringify(localStorage).length / 1024 / 1024).toFixed(2);
      const storageText = document.getElementById('storage-text');
      if (storageText) storageText.textContent = `${used} MB / 5 MB`;
  });
  </script>
  <script>
   // ==================== Firebaseé…ç½®ç›¸å…³ä»£ç å·²ç§»é™¤ ====================

// ==================== é—®é¢˜2: localStorageå®¹é‡ç®¡ç† ====================
// æ£€æŸ¥å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
function checkStorageUsage() {
  try {
    let totalSize = 0;
    for (let key in localStorage) {
      if (localStorage.hasOwnProperty(key) && key.startsWith('tpi_')) {
        totalSize += (localStorage[key].length + key.length) * 2;
      }
    }

    const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
    const maxSize = 5;
    const percentage = (totalSize / (maxSize * 1024 * 1024)) * 100;

    const storageInfo = document.getElementById('storage-usage-info');
    if (storageInfo) {
      storageInfo.textContent = sizeInMB + ' MB / ' + maxSize + ' MB (' + percentage.toFixed(1) + '%)';
      storageInfo.style.color = percentage > 90 ? '#dc2626' : percentage > 75 ? '#f59e0b' : '#10b981';
    }

    if (percentage > 95) {
      showStorageCriticalModal(sizeInMB, maxSize, percentage);
      return false;
    } else if (percentage > 90) {
      showStorageWarningModal(sizeInMB, maxSize, percentage);
    } else if (percentage > 75) {
      showToast('å­˜å‚¨ç©ºé—´ä½¿ç”¨å·²è¶…è¿‡75%ï¼Œå»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½æ•°æ®', 'warning');
    }

    return true;
  } catch (e) {
    console.error('å­˜å‚¨æ£€æŸ¥å¤±è´¥:', e);
    return true;
  }
}

function showStorageCriticalModal(currentSize, maxSize, percentage) {
  showModal({
    type: 'error',
    title: 'ğŸš¨ å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³',
    message: '<div style="text-align: left;"><div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 15px; margin: 15px 0; border-radius: 4px;"><p style="margin: 0; font-weight: bold; color: #991b1b;">âš ï¸ å­˜å‚¨ç©ºé—´å·²ä½¿ç”¨ ' + percentage.toFixed(1) + '%</p><p style="margin: 10px 0 0 0; color: #7f1d1d;">å½“å‰: ' + currentSize + ' MB / ' + maxSize + ' MB<br><strong>æ‚¨å¿…é¡»ç«‹å³æ¸…ç†æ•°æ®ï¼Œå¦åˆ™æ— æ³•ä¿å­˜æ–°æ•°æ®ï¼</strong></p></div><h4>è¯·é€‰æ‹©ä¸€ä¸ªæ“ä½œï¼š</h4><div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;"><button onclick="autoCleanOldData(30); closeAllModals();" class="modal-button modal-button-primary" style="width: 100%;">ğŸ—‘ï¸ è‡ªåŠ¨æ¸…ç†30å¤©å‰çš„æ•°æ®ï¼ˆæ¨èï¼‰</button><button onclick="autoCleanOldData(60); closeAllModals();" class="modal-button" style="width: 100%; background: #3b82f6; color: white;">ğŸ—‘ï¸ è‡ªåŠ¨æ¸…ç†60å¤©å‰çš„æ•°æ®</button><button onclick="exportAndResetAll(); closeAllModals();" class="modal-button" style="width: 100%; background: #dc2626; color: white;">ğŸ’¾ å¯¼å‡ºå…¨éƒ¨æ•°æ®åé‡ç½®ç³»ç»Ÿ</button></div></div>',
    showCancel: false,
    showConfirm: false
  });
}

function showStorageWarningModal(currentSize, maxSize, percentage) {
  const warningShown = sessionStorage.getItem('tpi_storage_warning_shown');
  if (warningShown) return;
  sessionStorage.setItem('tpi_storage_warning_shown', 'true');

  showModal({
    type: 'warning',
    title: 'âš ï¸ å­˜å‚¨ç©ºé—´å³å°†ä¸è¶³',
    message: '<div style="text-align: left;"><div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin: 15px 0; border-radius: 4px;"><p style="margin: 0; font-weight: bold; color: #92400e;">å­˜å‚¨ç©ºé—´å·²ä½¿ç”¨ ' + percentage.toFixed(1) + '%</p><p style="margin: 10px 0 0 0; color: #78350f;">å½“å‰: ' + currentSize + ' MB / ' + maxSize + ' MB</p></div><h4>å»ºè®®æ“ä½œï¼š</h4><div style="display: flex; flex-direction: column; gap: 10px; margin-top: 15px;"><button onclick="exportAllData(); closeAllModals();" class="modal-button modal-button-primary" style="width: 100%;">ğŸ’¾ ç«‹å³å¯¼å‡ºå…¨éƒ¨æ•°æ®</button><button onclick="autoCleanOldData(90); closeAllModals();" class="modal-button" style="width: 100%; background: #3b82f6; color: white;">ğŸ—‘ï¸ æ¸…ç†90å¤©å‰çš„æ•°æ®</button><button onclick="closeAllModals();" class="modal-button" style="width: 100%; background: #6b7280; color: white;">ç¨åå¤„ç†</button></div></div>',
    showCancel: false,
    showConfirm: false
  });
}

function autoCleanOldData(daysAgo) {
  try {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
    const cutoffKey = cutoffDate.toISOString().split('T')[0].replace(/-/g, '');

    let deletedCount = 0;
    const keysToDelete = [];

    for (let key in localStorage) {
      if (key.startsWith('tpi_data_')) {
        const dateKey = key.replace('tpi_data_', '');
        if (dateKey < cutoffKey) {
          keysToDelete.push(key);
        }
      }
    }

    keysToDelete.forEach(key => {
      localStorage.removeItem(key);
      deletedCount++;
    });

    showToast('âœ… å·²æ¸…ç† ' + deletedCount + ' å¤©çš„æ—§æ•°æ®ï¼ˆ' + daysAgo + 'å¤©å‰ï¼‰', 'success');
    checkStorageUsage();
  } catch (e) {
    showToast('æ¸…ç†æ•°æ®å¤±è´¥: ' + e.message, 'error');
  }
}

function exportAndResetAll() {
  if (confirm('ç¡®å®šè¦å¯¼å‡ºå…¨éƒ¨æ•°æ®å¹¶é‡ç½®ç³»ç»Ÿå—?\n\nå¯¼å‡ºåï¼Œæ‰€æœ‰æœ¬åœ°æ•°æ®å°†è¢«æ¸…ç©ºã€‚')) {
    exportAllData();
    setTimeout(function() {
      if (confirm('æ•°æ®å·²å¯¼å‡ºã€‚ç°åœ¨æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿ')) {
        for (let key in localStorage) {
          if (key.startsWith('tpi_')) {
            localStorage.removeItem(key);
          }
        }
        showToast('âœ… ç³»ç»Ÿå·²é‡ç½®ï¼Œè¯·åˆ·æ–°é¡µé¢', 'success');
        setTimeout(function() { location.reload(); }, 2000);
      }
    }, 1000);
  }
}

// ==================== é—®é¢˜3: æ•°æ®å¤‡ä»½æé†’ ====================
function checkAndShowBackupBanner() {
  if (localStorage.getItem('tpi_backup_reminder_disabled') === 'true') {
    return;
  }

  const lastBackup = parseInt(localStorage.getItem('tpi_last_manual_backup') || '0');
  const now = Date.now();
  const daysSinceBackup = (now - lastBackup) / (1000 * 60 * 60 * 24);

  if (daysSinceBackup > 7 || lastBackup === 0) {
    const existingBanner = document.getElementById('backup-reminder-banner');
    if (!existingBanner) {
      const banner = document.createElement('div');
      banner.id = 'backup-reminder-banner';
      banner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-bottom: 2px solid #f59e0b; padding: 12px 20px; text-align: center; z-index: 9999; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';

      const daysText = lastBackup === 0 ? 'ä»æœªå¤‡ä»½' : 'å·²ç»' + Math.floor(daysSinceBackup) + 'å¤©æ²¡æœ‰å¤‡ä»½';

      banner.innerHTML = '<style>
    /* è¡¥å…¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
    @keyframes slideDown{from{transform:translateY(-100%);}to{transform:translateY(0);}}</style><div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;"><span style="font-size: 20px;">âš ï¸</span><span style="font-weight: bold; color: #92400e;">' + daysText + 'æ•°æ®äº†ï¼ä¸ºé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œè¯·ç«‹å³å¤‡ä»½ï¼š</span><button onclick="exportAllData(); localStorage.setItem('tpi_last_manual_backup', Date.now()); this.parentElement.parentElement.remove();" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ’¾ ç«‹å³å¯¼å‡ºæ•°æ®</button><button onclick="this.parentElement.parentElement.remove(); localStorage.setItem('tpi_last_backup_check', Date.now());" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">ç¨åæé†’</button><button onclick="if(confirm('ç¡®å®šä¸å†æé†’å—?\\n\\nè¿™å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±é£é™©ï¼')) { this.parentElement.parentElement.remove(); localStorage.setItem('tpi_backup_reminder_disabled', 'true'); }" style="background: transparent; border: none; color: #92400e; cursor: pointer; text-decoration: underline;">ä¸å†æé†’</button></div>';

      document.body.insertBefore(banner, document.body.firstChild);

      const container = document.querySelector('.container');
      if (container) {
        container.style.marginTop = '80px';
      }
    }
  }
}

// ==================== é—®é¢˜6: ç§»åŠ¨ç«¯ä¼˜åŒ– ====================
function detectMobileAndOptimize() {
  const isMobile = window.innerWidth < 768;

  if (isMobile) {
    const promptShown = sessionStorage.getItem('tpi_mobile_prompt_shown');
    if (!promptShown) {
      setTimeout(function() {
        showMobileOptimizationPrompt();
        sessionStorage.setItem('tpi_mobile_prompt_shown', 'true');
      }, 2000);
    }
    applyMobileOptimizations();
  }
}

function showMobileOptimizationPrompt() {
  showModal({
    type: 'info',
    title: 'ğŸ“± ç§»åŠ¨ç«¯è®¿é—®æ£€æµ‹',
    message: '<div style="text-align: left;"><p>æ£€æµ‹åˆ°æ‚¨åœ¨ä½¿ç”¨æ‰‹æœºè®¿é—®TPIç³»ç»Ÿã€‚</p><h4>ç§»åŠ¨ç«¯ä½¿ç”¨å»ºè®®ï¼š</h4><ul style="margin: 10px 0; padding-left: 20px;"><li>ä½¿ç”¨<strong>æ¨ªå±æ¨¡å¼</strong>å¯è·å¾—æ›´å¥½ä½“éªŒ</li><li>å»ºè®®åœ¨<strong>ç”µè„‘ç«¯</strong>è¡¥å……è¯¦ç»†ä¿¡æ¯</li><li>å»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½æ•°æ®</li></ul><div style="margin-top: 20px; padding: 12px; background: #e0f2fe; border-left: 4px solid #0284c7; border-radius: 4px;"><p style="margin: 0; font-weight: bold; color: #075985;">ğŸ’¡ æç¤º</p><p style="margin: 5px 0 0 0; font-size: 0.9em; color: #0c4a6e;">ç§»åŠ¨ç«¯localStorageå®¹é‡å¯èƒ½æ›´å°ï¼Œå»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½</p></div></div>',
    showCancel: false,
    showConfirm: true,
    confirmText: 'æˆ‘çŸ¥é“äº†'
  });
}

function applyMobileOptimizations() {
  const style = document.createElement('style');
  style.id = 'mobile-optimizations';
  style.textContent = '@media (max-width: 768px) { input[type="text"], input[type="number"], input[type="time"], select { font-size: 16px !important; padding: 12px !important; min-height: 44px !important; } button { min-height: 44px !important; padding: 12px 16px !important; font-size: 16px !important; } table { font-size: 14px; } .data-processing-card { overflow-x: auto; -webkit-overflow-scrolling: touch; } .modal-content { max-width: 95vw !important; max-height: 90vh !important; overflow-y: auto; } }';

  if (!document.getElementById('mobile-optimizations')) {
    document.head.appendChild(style);
  }
}

// ==================== é—®é¢˜7: ç‰ˆæœ¬ç®¡ç† ====================
const VERSION_INFO = {
  current: '20.0.0',
  date: window.TPI_BUILD_DATE || getCurrentDate(), // ä½¿ç”¨åŠ¨æ€æ—¥æœŸ
  name: 'ç¬¬22ç‰ˆ v20.0.0 - é—®é¢˜ä¿®å¤ç‰ˆ'
};

const CHANGELOG = [
  {
    version: '20.0.0',
    date: window.TPI_BUILD_DATE || getCurrentDate(), // ä½¿ç”¨åŠ¨æ€æ—¥æœŸ
    changes: [
      'âœ¨ ç§»é™¤ï¼šFirebaseäº‘ç«¯åŒæ­¥åŠŸèƒ½(æ”¹ç”¨GitHub)',
      'âœ¨ æ–°å¢ï¼šlocalStorageå®¹é‡ä¸»åŠ¨ç®¡ç†',
      'âœ¨ æ–°å¢ï¼šæ•°æ®å¤‡ä»½å¼ºåˆ¶æé†’',
      'âœ¨ æ–°å¢ï¼šç§»åŠ¨ç«¯è¾“å…¥ä½“éªŒä¼˜åŒ–',
      'âœ¨ æ–°å¢ï¼šç‰ˆæœ¬æ›´æ–°æ£€æµ‹æœºåˆ¶',
      'âœ¨ æ–°å¢ï¼šæ‰€æœ‰æ•°å­—è¾“å…¥çš„æ•°æ®éªŒè¯',
      'âœ¨ æ–°å¢ï¼šæ“ä½œæˆåŠŸæç¤º',
      'ğŸ› ä¿®å¤ï¼šæ™ºèƒ½å†²çªè§£å†³æœºåˆ¶',
      'ğŸ› ä¿®å¤ï¼šåˆé—´é˜²å®ˆè®¡ç®—é”™è¯¯',
      'ğŸ› ä¿®å¤ï¼šæ¯æ—¥é‡ç½®æ¸…ç©ºæ˜¨æ—¥æ•°æ®'
    ]
  }
];

function showVersionInfo() {
  const changelogHtml = CHANGELOG.map(function(v) {
    return '<div style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;"><h4 style="margin: 0 0 10px 0; color: #1f2937;">v' + v.version + ' <span style="color: #6b7280; font-size: 0.9em; font-weight: normal;">(' + v.date + ')</span></h4><ul style="margin: 0; padding-left: 20px;">' + v.changes.map(function(c) { return '<li style="margin: 5px 0;">' + c + '</li>'; }).join('') + '</ul></div>';
  }).join('');

  showModal({
    type: 'info',
    title: 'ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯',
    message: '<div style="text-align: left;"><div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;"><h3 style="margin: 0 0 10px 0;">TPIå…¨ç»´æ•ˆèƒ½ç®¡ç†ç³»ç»Ÿ</h3><p style="margin: 0; font-size: 1.2em; font-weight: bold;">' + VERSION_INFO.name + '</p><p style="margin: 5px 0 0 0; opacity: 0.9;">å‘å¸ƒæ—¥æœŸï¼š' + VERSION_INFO.date + '</p></div><h4 style="margin: 20px 0 15px 0;">ğŸ“œ æ›´æ–°æ—¥å¿—</h4>' + changelogHtml + '</div>',
    showCancel: false,
    showConfirm: true,
    confirmText: 'å…³é—­'
  });
}

// ==================== æ•°å­—è¾“å…¥éªŒè¯ ====================
function validateNumberInput(input, min, max, decimals) {
  let value = parseFloat(input.value);

  if (isNaN(value)) {
    if (input.value !== '') {
      showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—', 'error');
      input.value = '';
      input.classList.add('input-error');
      setTimeout(function() { input.classList.remove('input-error'); }, 2000);
    }
    return false;
  }

  if (min !== null && value < min) {
    showToast('æ•°å€¼ä¸èƒ½å°äº ' + min, 'error');
    input.value = min;
    input.classList.add('input-error');
    setTimeout(function() { input.classList.remove('input-error'); }, 2000);
    return false;
  }

  if (max !== null && value > max) {
    showToast('æ•°å€¼ä¸èƒ½å¤§äº ' + max, 'error');
    input.value = max;
    input.classList.add('input-error');
    setTimeout(function() { input.classList.remove('input-error'); }, 2000);
    return false;
  }

  if (decimals !== null) {
    const rounded = Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals);
    if (rounded !== value) {
      input.value = rounded;
    }
  }

  input.classList.remove('input-error');
  return true;
}

function initializeInputValidation() {
  const style = document.createElement('style');
  style.textContent = '.input-error { border-color: #dc2626 !important; background-color: #fee2e2 !important; animation: shake 0.3s; } @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }';
  document.head.appendChild(style);

  document.querySelectorAll('input[type="number"]').forEach(function(input) {
    const htmlMin = input.min ? parseFloat(input.min) : null;
    const htmlMax = input.max ? parseFloat(input.max) : null;

    input.addEventListener('blur', function() {
      if (input.value !== '') {
        validateNumberInput(input, htmlMin, htmlMax, 2);
      }
    });

    input.addEventListener('input', function() {
      if (input.classList.contains('input-error')) {
        input.classList.remove('input-error');
      }
    });
  });
}

// ==================== æˆåŠŸæç¤ºå¢å¼º ====================
function enhanceSuccessNotifications() {
  const originalShowToast = window.showToast;
  if (originalShowToast) {
    window.showToast = function(message, type) {
      originalShowToast(message, type);
      if (type === 'success') {
        if ('vibrate' in navigator) {
          navigator.vibrate(100);
        }
      }
    };
  }
}




            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            
            const exportTime = new Date();
            const exportTimeStr = `${exportTime.getFullYear()}-${String(exportTime.getMonth() + 1).padStart(2, '0')}-${String(exportTime.getDate()).padStart(2, '0')} ${String(exportTime.getHours()).padStart(2, '0')}:${String(exportTime.getMinutes()).padStart(2, '0')}:${String(exportTime.getSeconds()).padStart(2, '0')}`;
            const exportDateStr = `${exportTime.getFullYear()}-${String(exportTime.getMonth() + 1).padStart(2, '0')}-${String(exportTime.getDate()).padStart(2, '0')}`;
            
            let exportContent = '';
            let filename = '';
            let mimeType = '';
            
            if (format === 'markdown') {
                // Markdownæ ¼å¼
                
                exportContent += `**å¯¼å‡ºæ—¶é—´**: ${exportTimeStr}\n\n`;
                exportContent += `**è®°å½•æ¡æ•°**: ${notes.length} æ¡\n\n`;
                exportContent += `---\n\n`;
                
                notes.forEach((note, index) => {
                    const noteDate = new Date(note.timestamp);
                    const dateStr = `${noteDate.getFullYear()}-${String(noteDate.getMonth() + 1).padStart(2, '0')}-${String(noteDate.getDate()).padStart(2, '0')} ${String(noteDate.getHours()).padStart(2, '0')}:${String(noteDate.getMinutes()).padStart(2, '0')}`;
                    
                    exportContent += `## ğŸ“ è®°å½• ${index + 1}\n\n`;
                    exportContent += `**æ—¶é—´**: ${dateStr}\n\n`;
                    exportContent += `${note.content}\n\n`;
                    exportContent += `---\n\n`;
                });
            } // ä¿®å¤: æ·»åŠ ç¼ºå¤±çš„ifé—­åˆæ‹¬å·
                


// ==================== åˆå§‹åŒ– ====================
window.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–...');
    
  // åˆå§‹åŒ–å­˜å‚¨æ£€æŸ¥
  setTimeout(function() {
    checkStorageUsage();
  }, 2000);

  // åˆå§‹åŒ–å¤‡ä»½æé†’
  setTimeout(function() {
    checkAndShowBackupBanner();
  }, 3000);

  // åˆå§‹åŒ–ç§»åŠ¨ç«¯ä¼˜åŒ–
  detectMobileAndOptimize();

  // åˆå§‹åŒ–è¾“å…¥éªŒè¯
  initializeInputValidation();

  // åˆå§‹åŒ–æˆåŠŸæç¤º
  enhanceSuccessNotifications();

  // æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤º
  const footer = document.createElement('div');
  footer.style.cssText = 'position: fixed; bottom: 10px; right: 10px; background: rgba(255, 255, 255, 0.9); padding: 8px 12px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); font-size: 0.85em; color: #6b7280; z-index: 100; cursor: pointer; transition: all 0.2s;';
  footer.innerHTML = '<span>v' + VERSION_INFO.current + '</span><span style="margin-left: 8px; color: #3b82f6;">ğŸ“‹</span>';
  footer.onclick = showVersionInfo;
  footer.onmouseover = function() {
    footer.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
    footer.style.transform = 'translateY(-2px)';
  };
  footer.onmouseout = function() {
    footer.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
    footer.style.transform = 'translateY(0)';
  };
  document.body.appendChild(footer);
});

window.addEventListener('resize', function() {
  const isMobile = window.innerWidth < 768;
  if (isMobile) {
    applyMobileOptimizations();
  } else {
    const mobileStyle = document.getElementById('mobile-optimizations');
    if (mobileStyle) {
      mobileStyle.remove();
    }
  }
});
  </script>
  <script>
   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ ¸å¿ƒåŠŸèƒ½å‡½æ•°çš„å®‰å…¨Fallbackå®ç°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
    'use strict';

    // åˆå§‹åŒ–TPIå‘½åç©ºé—´ <span style="color:red;">(åŸå› ï¼šæ¸…ç†å†—ä½™åˆå§‹åŒ–ä»£ç ï¼Œç»Ÿä¸€åœ¨ä¸Šæ–¹å¤„ç†)</span>
    




    // é”™è¯¯å¤„ç†åŒ…è£…å™¨
    function safeCall(fn, fallbackMsg) {
        return function(...args) {
            try {
                if (typeof fn === 'function') {
                    return fn.apply(this, args);
                } else {
                    throw new Error('å‡½æ•°æœªå®šä¹‰');
                }
            } catch (error) {
                console.error('å‡½æ•°æ‰§è¡Œé”™è¯¯:', error);
                if (fallbackMsg) {
                    alert(fallbackMsg + '\né”™è¯¯: ' + error.message);
                }
                return null;
            }
        };
    }

    // è¶‹åŠ¿åˆ†æåŠŸèƒ½
    if (!window.TPI.updateTrendChart) {
        window.TPI.updateTrendChart = function(days) {
            console.log('ğŸ”µ updateTrendChart è¢«è°ƒç”¨, å¤©æ•°:', days);
            try {
                console.log('âš ï¸ Chart.jsåº“æœªåŠ è½½æˆ–è¶‹åŠ¿å›¾åŠŸèƒ½æœªå®ç°');
                alert('è¶‹åŠ¿å›¾åŠŸèƒ½éœ€è¦Chart.jsåº“æ”¯æŒ,è¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸');
            } catch (e) {
                console.error('âŒ è¶‹åŠ¿å›¾æ›´æ–°å¤±è´¥:', e);
            }
        };
    }

    // å¯¼å‡ºå›¾è¡¨
    if (!window.TPI.exportChart) {
        window.TPI.exportChart = function(chartId, filename) {
            try {
                const canvas = document.getElementById(chartId);
                if (canvas && canvas.tagName === 'CANVAS') {
                    const url = canvas.toDataURL('image/png');
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename + '.png';
                    a.click();
                    alert('å›¾è¡¨å·²å¯¼å‡º');
                } else {
                    alert('æœªæ‰¾åˆ°å›¾è¡¨æˆ–å›¾è¡¨æœªåˆå§‹åŒ–');
                }
            } catch (e) {
                console.error('å¯¼å‡ºå›¾è¡¨å¤±è´¥:', e);
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message);
            }
        };
    }

    // åŠ è½½å†å²æ•°æ®
    if (!window.TPI.loadHistoryData) {
        window.TPI.loadHistoryData = function() {
            try {
                const dateInput = document.getElementById('history-date');
                if (dateInput && dateInput.value) {
                    alert('æ­£åœ¨åŠ è½½ ' + dateInput.value + ' çš„æ•°æ®...');
                    // è¿™é‡Œåº”è¯¥æœ‰å®é™…çš„åŠ è½½é€»è¾‘
                } else {
                    alert('è¯·å…ˆé€‰æ‹©æ—¥æœŸ');
                }
            } catch (e) {
                console.error('åŠ è½½å†å²æ•°æ®å¤±è´¥:', e);
            }
        };
    }

    // ç”Ÿæˆå‘¨æŠ¥ - è°ƒç”¨çœŸå®çš„å‘¨æŠ¥ç”Ÿæˆå‡½æ•°
    if (!window.TPI.generateWeeklyReport) {
        window.TPI.generateWeeklyReport = function() {
            try {
                // è°ƒç”¨çœŸæ­£çš„å‘¨æŠ¥ç”Ÿæˆå‡½æ•°
                if (typeof generateWeeklyReport === 'function') {
                    generateWeeklyReport();
                } else {
                    console.error('generateWeeklyReportå‡½æ•°æœªå®šä¹‰');
                    showNotification('âš ï¸ å‘¨æŠ¥åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°åé‡è¯•', 'warning');
                }
            } catch (e) {
                console.error('ç”Ÿæˆå‘¨æŠ¥å¤±è´¥:', e);
                showNotification('âŒ ç”Ÿæˆå‘¨æŠ¥å¤±è´¥ï¼š' + (e && e.message ? e.message : 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        };
    }

    // ç”ŸæˆæœˆæŠ¥ - è°ƒç”¨çœŸå®çš„æœˆæŠ¥ç”Ÿæˆå‡½æ•°
    if (!window.TPI.generateMonthlyReport) {
        window.TPI.generateMonthlyReport = function() {
            try {
                // è°ƒç”¨çœŸæ­£çš„æœˆæŠ¥ç”Ÿæˆå‡½æ•°
                if (typeof generateMonthlyReport === 'function') {
                    generateMonthlyReport();
                } else {
                    console.error('generateMonthlyReportå‡½æ•°æœªå®šä¹‰');
                    showNotification('âš ï¸ æœˆæŠ¥åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°åé‡è¯•', 'warning');
                }
            } catch (e) {
                console.error('ç”ŸæˆæœˆæŠ¥å¤±è´¥:', e);
                showNotification('âŒ ç”ŸæˆæœˆæŠ¥å¤±è´¥ï¼š' + (e && e.message ? e.message : 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        };
    }

    // å¯¼å‡ºæŠ¥å‘Š - æ ¸å¿ƒä¿®å¤
    if (!window.TPI.exportReport) {
        window.TPI.exportReport = function(format) {
            try {
                showNotification('ğŸ“¤ æ­£åœ¨å¯¼å‡º ' + format.toUpperCase() + ' æŠ¥å‘Š...', 'info');

                if (format === 'pdf') {
                    // æ£€æŸ¥jsPDFæ˜¯å¦å¯ç”¨
                    if (typeof window.jspdf === 'undefined' && typeof jsPDF === 'undefined') {
                        throw new Error('jsPDFåº“æœªåŠ è½½,æ— æ³•å¯¼å‡ºPDF');
                    }

                    const reportContent = document.getElementById('advancedReportPreview') || document.getElementById('reportContent');
                    if (!reportContent || !reportContent.innerHTML.trim()) {
                        alert('è¯·å…ˆç”ŸæˆæŠ¥å‘Šå†…å®¹');
                        return;
                    }

                    // PDFå¯¼å‡ºå·²å®ç°

                } else if (format === 'excel') {
                    // æ£€æŸ¥XLSXæ˜¯å¦å¯ç”¨
                    if (typeof XLSX === 'undefined') {
                        throw new Error('SheetJSåº“æœªåŠ è½½,æ— æ³•å¯¼å‡ºExcel');
                    }

                    // Excelå¯¼å‡ºå·²å®ç°
                }
            } catch (e) {
                console.error('å¯¼å‡ºæŠ¥å‘Šå¤±è´¥:', e);
                alert('å¯¼å‡ºå¤±è´¥: ' + e.message + '\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°é¡µé¢');
            }
        };
    }

    // Firebaseäº‘ç«¯åŒæ­¥å·²ç§»é™¤,ä¿ç•™å…œåº•å‡½æ•°é˜²æ­¢è°ƒç”¨é”™è¯¯
    if (!window.TPI.saveToFirebase) {
        window.TPI.saveToFirebase = function() {
            console.warn('[å·²åºŸå¼ƒ] FirebaseåŒæ­¥å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥');
            alert('âš ï¸ FirebaseåŒæ­¥å·²ç§»é™¤\n\nè¯·ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥åŠŸèƒ½è¿›è¡Œæ•°æ®åŒæ­¥');
        };
    }

    if (!window.TPI.loadFromFirebase) {
        window.TPI.loadFromFirebase = function() {
            console.warn('[å·²åºŸå¼ƒ] FirebaseåŒæ­¥å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥');
            alert('âš ï¸ FirebaseåŒæ­¥å·²ç§»é™¤\n\nè¯·ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥åŠŸèƒ½è¿›è¡Œæ•°æ®åŒæ­¥');
        };
    }

    // é«˜çº§åˆ†æå·¥å…·çš„Fallback
    if (typeof window.TPIAdvanced === 'undefined') {
        window.TPIAdvanced = {
            openComparison: function() {
                console.log('[TPIAdvanced] æ‰“å¼€æ•°æ®å¯¹æ¯”åˆ†æç•Œé¢');
                
                // åˆ›å»ºæ•°æ®å¯¹æ¯”åˆ†æç•Œé¢
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 12px; position: relative;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e5e7eb;">
                            <h2 style="margin: 0;">ğŸ“Š æ•°æ®å¯¹æ¯”åˆ†æ</h2>
                            <button class="close-btn" onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">âœ•</button>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <div style="margin-bottom: 20px;">
                                <h3>é€‰æ‹©å¯¹æ¯”æ—¥æœŸ</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">æ—¥æœŸAï¼š</label>
                                        <input type="date" id="compareDate1" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: bold;">æ—¥æœŸBï¼š</label>
                                        <input type="date" id="compareDate2" class="form-control" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="window.TPIAdvanced.performComparison()" style="padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 10px;">ğŸ“Š å¼€å§‹å¯¹æ¯”</button>
                            </div>

                            <div id="comparisonResults" style="margin-top: 30px;">
                                <!-- å¯¹æ¯”ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                console.log('[TPIAdvanced] æ•°æ®å¯¹æ¯”ç•Œé¢å·²åˆ›å»º');

                // è®¾ç½®é»˜è®¤æ—¥æœŸ
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                setTimeout(() => {
                    const input1 = document.getElementById('compareDate1');
                    const input2 = document.getElementById('compareDate2');
                    if (input1) input1.value = yesterday.toISOString().split('T')[0];
                    if (input2) input2.value = today.toISOString().split('T')[0];
                    console.log('[TPIAdvanced] é»˜è®¤æ—¥æœŸå·²è®¾ç½® - æ—¥æœŸA:', yesterday.toISOString().split('T')[0], 'æ—¥æœŸB:', today.toISOString().split('T')[0]);
                }, 100);
            },

            performComparison: function() {
                console.log('[TPIAdvanced] æ‰§è¡Œæ•°æ®å¯¹æ¯”');
                
                const date1 = document.getElementById('compareDate1')?.value;
                const date2 = document.getElementById('compareDate2')?.value;

                console.log('[TPIAdvanced] å¯¹æ¯”æ—¥æœŸ - A:', date1, 'B:', date2);

                if (!date1 || !date2) {
                    console.warn('[TPIAdvanced] æœªé€‰æ‹©å®Œæ•´çš„å¯¹æ¯”æ—¥æœŸ');
                    alert('âš ï¸ è¯·é€‰æ‹©ä¸¤ä¸ªæ—¥æœŸ');
                    return;
                }

                const data1Str = localStorage.getItem('tpi_data_' + date1);
                const data2Str = localStorage.getItem('tpi_data_' + date2);

                if (!data1Str || !data2Str) {
                    console.warn('[TPIAdvanced] æœªæ‰¾åˆ°æ•°æ® - æ—¥æœŸA:', !!data1Str, 'æ—¥æœŸB:', !!data2Str);
                    alert('âš ï¸ æœªæ‰¾åˆ°é€‰å®šæ—¥æœŸçš„æ•°æ®\n\nè¯·ç¡®ä¿ä¸¤ä¸ªæ—¥æœŸéƒ½æœ‰è®°å½•æ•°æ®');
                    return;
                }

                const data1 = JSON.parse(data1Str);
                const data2 = JSON.parse(data2Str);
                
                console.log('[TPIAdvanced] æ•°æ®åŠ è½½æˆåŠŸ');
                console.log('[TPIAdvanced] æ—¥æœŸAæ•°æ®:', data1);
                console.log('[TPIAdvanced] æ—¥æœŸBæ•°æ®:', data2);

                const results = document.getElementById('comparisonResults');
                if (!results) {
                    console.error('[TPIAdvanced] æ‰¾ä¸åˆ°comparisonResultså®¹å™¨');
                    return;
                }

                // è®¡ç®—å·®å¼‚
                const diff = {
                    tpi: (data2.tpi || 0) - (data1.tpi || 0),
                    ami: (data2.ami || 0) - (data1.ami || 0),
                    hbi: (data2.hbi || 0) - (data1.hbi || 0),
                    pmi: (data2.pmi || 0) - (data1.pmi || 0),
                    studyHours: (data2.studyHours || 0) - (data1.studyHours || 0),
                    exerciseMinutes: (data2.exerciseMinutes || 0) - (data1.exerciseMinutes || 0),
                    sleepHours: (data2.sleepHours || 0) - (data1.sleepHours || 0)
                };

                console.log('[TPIAdvanced] è®¡ç®—çš„å·®å¼‚:', diff);

                const getDiffColor = (val) => val > 0 ? '#10b981' : val < 0 ? '#ef4444' : '#6b7280';
                const getDiffIcon = (val) => val > 0 ? 'ğŸ“ˆ' : val < 0 ? 'ğŸ“‰' : 'â¡ï¸';
                const formatDiff = (val) => val > 0 ? '+' + val.toFixed(1) : val.toFixed(1);

                results.innerHTML = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <h3 style="margin-bottom: 20px;">å¯¹æ¯”ç»“æœï¼š${date1} vs ${date2}</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="color: #2563eb; margin-bottom: 15px;">ğŸ“… ${date1}</h4>
                                <div style="line-height: 1.8;">
                                    <div><strong>TPIæ€»åˆ†ï¼š</strong> ${data1.tpi || 0}</div>
                                    <div><strong>AMIï¼š</strong> ${data1.ami || 0}</div>
                                    <div><strong>HBIï¼š</strong> ${data1.hbi || 0}</div>
                                    <div><strong>PMIï¼š</strong> ${data1.pmi || 0}</div>
                                    <div><strong>å­¦ä¹ ï¼š</strong> ${data1.studyHours || 0}h</div>
                                    <div><strong>è¿åŠ¨ï¼š</strong> ${data1.exerciseMinutes || 0}min</div>
                                    <div><strong>ç¡çœ ï¼š</strong> ${data1.sleepHours || 0}h</div>
                                </div>
                            </div>

                            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <h4 style="color: #2563eb; margin-bottom: 15px;">ğŸ“… ${date2}</h4>
                                <div style="line-height: 1.8;">
                                    <div><strong>TPIæ€»åˆ†ï¼š</strong> ${data2.tpi || 0}</div>
                                    <div><strong>AMIï¼š</strong> ${data2.ami || 0}</div>
                                    <div><strong>HBIï¼š</strong> ${data2.hbi || 0}</div>
                                    <div><strong>PMIï¼š</strong> ${data2.pmi || 0}</div>
                                    <div><strong>å­¦ä¹ ï¼š</strong> ${data2.studyHours || 0}h</div>
                                    <div><strong>è¿åŠ¨ï¼š</strong> ${data2.exerciseMinutes || 0}min</div>
                                    <div><strong>ç¡çœ ï¼š</strong> ${data2.sleepHours || 0}h</div>
                                </div>
                            </div>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <h4 style="margin-bottom: 15px;">ğŸ“Š å˜åŒ–è¶‹åŠ¿</h4>
                            <div style="line-height: 2;">
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span><strong>TPIæ€»åˆ†</strong></span>
                                    <span style="color: ${getDiffColor(diff.tpi)}; font-weight: bold;">${getDiffIcon(diff.tpi)} ${formatDiff(diff.tpi)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span><strong>AMI (å­¦ä¸šæ•ˆèƒ½)</strong></span>
                                    <span style="color: ${getDiffColor(diff.ami)}; font-weight: bold;">${getDiffIcon(diff.ami)} ${formatDiff(diff.ami)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span><strong>HBI (ä¹ æƒ¯å¼ºåº¦)</strong></span>
                                    <span style="color: ${getDiffColor(diff.hbi)}; font-weight: bold;">${getDiffIcon(diff.hbi)} ${formatDiff(diff.hbi)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span><strong>PMI (èº«å¿ƒçŠ¶æ€)</strong></span>
                                    <span style="color: ${getDiffColor(diff.pmi)}; font-weight: bold;">${getDiffIcon(diff.pmi)} ${formatDiff(diff.pmi)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span><strong>å­¦ä¹ æ—¶é•¿</strong></span>
                                    <span style="color: ${getDiffColor(diff.studyHours)}; font-weight: bold;">${getDiffIcon(diff.studyHours)} ${formatDiff(diff.studyHours)}h</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span><strong>è¿åŠ¨æ—¶é•¿</strong></span>
                                    <span style="color: ${getDiffColor(diff.exerciseMinutes)}; font-weight: bold;">${getDiffIcon(diff.exerciseMinutes)} ${formatDiff(diff.exerciseMinutes)}min</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                                    <span><strong>ç¡çœ æ—¶é•¿</strong></span>
                                    <span style="color: ${getDiffColor(diff.sleepHours)}; font-weight: bold;">${getDiffIcon(diff.sleepHours)} ${formatDiff(diff.sleepHours)}h</span>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background: #eff6ff; border-left: 4px solid #2563eb; border-radius: 4px;">
                            <strong>ğŸ’¡ åˆ†æå»ºè®®ï¼š</strong>
                            <p style="margin: 8px 0 0 0;">
                                ${diff.tpi > 0 ? 'âœ… æ€»ä½“æ•ˆèƒ½æå‡ï¼Œç»§ç»­ä¿æŒï¼' : diff.tpi < 0 ? 'âš ï¸ æ•ˆèƒ½æœ‰æ‰€ä¸‹é™ï¼Œéœ€è¦è°ƒæ•´ç­–ç•¥' : 'â¡ï¸ æ•ˆèƒ½ä¿æŒç¨³å®š'}
                                ${Math.abs(diff.studyHours) > 2 ? `<br>ğŸ“š å­¦ä¹ æ—¶é•¿å˜åŒ–è¾ƒå¤§ï¼ˆ${formatDiff(diff.studyHours)}å°æ—¶ï¼‰ï¼Œæ³¨æ„ä¿æŒè§„å¾‹` : ''}
                                ${diff.sleepHours < -1 ? '<br>ğŸ˜´ ç¡çœ ä¸è¶³ï¼Œå»ºè®®å¢åŠ ä¼‘æ¯æ—¶é—´' : diff.sleepHours > 1 ? '<br>ğŸ˜´ ç¡çœ å……è¶³ï¼Œæœ‰åŠ©äºæ¢å¤ç²¾åŠ›' : ''}
                            </p>
                        </div>
                    </div>
                `;
            },
            generateReport: function() {
                console.log('[TPIAdvanced] ç”ŸæˆæŠ¥å‘ŠåŠŸèƒ½è¢«è°ƒç”¨');
                console.log('[TPIAdvanced] åˆ›å»ºæŠ¥å‘Šç”Ÿæˆç•Œé¢');
                
                // åˆ›å»ºé«˜çº§æŠ¥å‘Šç”Ÿæˆç•Œé¢
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 12px; position: relative;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e5e7eb;">
                            <h2 style="margin: 0;">ğŸ“ ç”ŸæˆæŠ¥å‘Š</h2>
                            <button class="close-btn" onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">âœ•</button>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <div class="mb-4">
                                <h3>é€‰æ‹©æŠ¥å‘Šç±»å‹</h3>
                                <div style="display: flex; gap: 10px; margin: 15px 0;">
                                    <button class="btn btn-primary" onclick="window.TPIAdvanced.generateDailyReport()">ğŸ“… æ—¥æŠ¥</button>
                                    <button class="btn btn-primary" onclick="window.TPIAdvanced.generateWeeklyReport()">ğŸ“Š å‘¨æŠ¥</button>
                                    <button class="btn btn-primary" onclick="window.TPIAdvanced.generateMonthlyReport()">ğŸ“ˆ æœˆæŠ¥</button>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h3>æŠ¥å‘Šé¢„è§ˆ</h3>
                                <div id="advancedReportPreview" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 200px;">
                                    <p class="text-muted">è¯·é€‰æ‹©æŠ¥å‘Šç±»å‹ä»¥ç”Ÿæˆé¢„è§ˆ</p>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h3>å¯¼å‡ºé€‰é¡¹</h3>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-secondary" onclick="window.TPIAdvanced.exportReport('markdown')" style="flex:1;min-width:140px;">ğŸ“ å¯¼å‡ºMarkdown</button>
                                    <button class="btn btn-secondary" onclick="window.TPIAdvanced.previewReport()" style="flex:1;min-width:140px;">ğŸ‘ï¸ é¢„è§ˆæŠ¥å‘Š</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                console.log('[TPIAdvanced] æŠ¥å‘Šç”Ÿæˆç•Œé¢å·²æ˜¾ç¤º');
            },

            generateDailyReport: function() {
                console.log('[TPIAdvanced] ç”Ÿæˆæ—¥æŠ¥è¢«è°ƒç”¨');
                
                const dateStr = document.getElementById('date-input')?.value || new Date().toISOString().split('T')[0];
                console.log('[TPIAdvanced] ç›®æ ‡æ—¥æœŸ:', dateStr);
                
                const dataStr = localStorage.getItem('tpi_data_' + dateStr);

                if (!dataStr) {
                    console.warn('[TPIAdvanced] æœªæ‰¾åˆ°æ—¥æœŸæ•°æ®:', dateStr);
                    alert('âš ï¸ æœªæ‰¾åˆ° ' + dateStr + ' çš„æ•°æ®');
                    return;
                }

                const data = JSON.parse(dataStr);
                console.log('[TPIAdvanced] åŠ è½½æ•°æ®æˆåŠŸ:', data);
                
                const preview = document.getElementById('advancedReportPreview');
                if (!preview) {
                    console.error('[TPIAdvanced] æ‰¾ä¸åˆ°é¢„è§ˆå®¹å™¨å…ƒç´ ');
                    return;
                }

                // è®¡ç®—çŠ¶æ€æ ‡ç­¾å’Œé¢œè‰²
                const tpi = data.tpi || data['tpi-total'] || 0;
                const color = tpi >= 120 ? '#16a34a' : tpi >= 95 ? '#2563eb' : tpi >= 80 ? '#ca8a04' : '#dc2626';
                const label = tpi >= 120 ? 'å“è¶Š' : tpi >= 95 ? 'ç¨³å¥' : tpi >= 80 ? 'è¾¾æ ‡' : 'éœ€è°ƒæ•´';

                preview.innerHTML = `
                    <h2 style="color: #2563eb; margin-bottom: 20px;">ğŸ“… TPIæ—¥æŠ¥ â€” ${dateStr}</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div style="background: #eff6ff; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 12px; color: #6b7280;">ğŸ“Š TPIæ€»åˆ†</div>
                            <div style="font-size: 28px; font-weight: bold; color: #2563eb;">${tpi}</div>
                        </div>
                        <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border-left: 4px solid #22c55e;">
                            <div style="font-size: 12px; color: #6b7280;">ğŸ¯ AMIå¾—åˆ†</div>
                            <div style="font-size: 28px; font-weight: bold; color: #16a34a;">${data.ami || data['ami-score'] || 0}</div>
                        </div>
                        <div style="background: #fefce8; padding: 16px; border-radius: 8px; border-left: 4px solid #eab308;">
                            <div style="font-size: 12px; color: #6b7280;">ğŸ“ˆ çŠ¶æ€</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${color};">${label}</div>
                        </div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 12px;">
                        <h3 style="margin: 0 0 12px; font-size: 15px;">ğŸ“Š æŒ‡æ ‡è¯¦æƒ…</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">æŒ‡æ ‡</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">å¾—åˆ†</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #f3f4f6;">
                                    <td style="padding: 6px 8px;">AMI (å­¦ä¸šæ•ˆèƒ½)</td>
                                    <td style="padding: 6px 8px; text-align: right; font-weight: bold;">${data.ami || data['ami-score'] || 0}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #f3f4f6;">
                                    <td style="padding: 6px 8px;">MA7 (7æ—¥å‡å€¼)</td>
                                    <td style="padding: 6px 8px; text-align: right; font-weight: bold;">${data.ma7 || data['ma7-score'] || 0}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #f3f4f6;">
                                    <td style="padding: 6px 8px;">FLI (æµç•…æŒ‡æ•°)</td>
                                    <td style="padding: 6px 8px; text-align: right; font-weight: bold;">${data.fli || data['fli-score'] || 0}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #f3f4f6;">
                                    <td style="padding: 6px 8px;">SYS (ç³»ç»Ÿåˆ†)</td>
                                    <td style="padding: 6px 8px; text-align: right; font-weight: bold;">${data.sys || data['sys-score'] || 0}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #f3f4f6;">
                                    <td style="padding: 6px 8px;">Bonus (å¥–åŠ±åˆ†)</td>
                                    <td style="padding: 6px 8px; text-align: right; font-weight: bold;">${data.bonus || data['bonus-score'] || 0}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <h3 style="margin: 0 0 10px; font-size: 15px;">ğŸ’ ä»Šæ—¥äº®ç‚¹</h3>
                        <p style="margin: 4px 0; font-size: 14px;">ğŸ“š å­¦ä¹ æ—¶é•¿: <strong>${data.studyHours || 0}</strong> å°æ—¶</p>
                        <p style="margin: 4px 0; font-size: 14px;">ğŸ”¥ ç‚¹ç«ç¨‹åº: <strong>${data.ignition || 'æœªå¯åŠ¨'}</strong></p>
                        <p style="margin: 4px 0; font-size: 14px;">ğŸƒ è¿åŠ¨æ—¶é•¿: <strong>${data.exerciseMinutes || 0}</strong> åˆ†é’Ÿ</p>
                        <p style="margin: 4px 0; font-size: 14px;">ğŸ˜´ ç¡çœ æ—¶é•¿: <strong>${data.sleepHours || 0}</strong> å°æ—¶</p>
                    </div>
                `;

                window.currentReportData = { type: 'daily', date: dateStr, data: data };
                alert('âœ… æ—¥æŠ¥å·²ç”Ÿæˆï¼å¯ä»¥é¢„è§ˆæˆ–å¯¼å‡º');
            },

            generateWeeklyReport: function() {
                console.log('ğŸ”µ TPIAdvanced.generateWeeklyReport è¢«è°ƒç”¨');
                
                const today = new Date();
                const weekData = [];

                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    const dataStr = localStorage.getItem('tpi_data_' + dateStr);
                    if (dataStr) {
                        weekData.push({ date: dateStr, ...JSON.parse(dataStr) });
                    }
                }
                
                console.log('ğŸ“Š æ‰¾åˆ°', weekData.length, 'å¤©çš„æ•°æ®');

                if (weekData.length === 0) {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°æœ¬å‘¨æ•°æ®');
                    alert('âš ï¸ æœªæ‰¾åˆ°æœ¬å‘¨æ•°æ®');
                    return;
                }

                const avgTPI = weekData.reduce((sum, d) => sum + ((d.tpi || d['tpi-total']) || 0), 0) / weekData.length;
                const maxTPI = Math.max(...weekData.map(d => (d.tpi || d['tpi-total']) || 0));
                const minTPI = Math.min(...weekData.map(d => (d.tpi || d['tpi-total']) || 0));
                const avgAMI = weekData.reduce((sum, d) => sum + ((d.ami || d['ami-score']) || 0), 0) / weekData.length;
                const highDays = weekData.filter(d => ((d.tpi || d['tpi-total']) || 0) >= 100).length;
                const reachDays = weekData.filter(d => ((d.tpi || d['tpi-total']) || 0) >= 80).length;
                
                console.log('ğŸ“ˆ å¹³å‡TPI:', avgTPI.toFixed(1));
                
                const preview = document.getElementById('advancedReportPreview');
                if (!preview) {
                    console.error('âŒ æœªæ‰¾åˆ°advancedReportPreviewå…ƒç´ ');
                    return;
                }
                
                console.log('âœ… advancedReportPreviewå…ƒç´ å­˜åœ¨');

                preview.innerHTML = `
                    <h2 style="color: #2563eb; margin-bottom: 20px;">ğŸ“Š TPIå‘¨æŠ¥ â€” è¿‘7å¤©</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div style="background: #eff6ff; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 12px; color: #6b7280;">ğŸ“Š å¹³å‡TPI</div>
                            <div style="font-size: 28px; font-weight: bold; color: #2563eb;">${avgTPI.toFixed(1)}</div>
                        </div>
                        <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border-left: 4px solid #22c55e;">
                            <div style="font-size: 12px; color: #6b7280;">ğŸ† æœ€é«˜TPI</div>
                            <div style="font-size: 28px; font-weight: bold; color: #16a34a;">${maxTPI}</div>
                        </div>
                        <div style="background: #fefce8; padding: 16px; border-radius: 8px; border-left: 4px solid #eab308;">
                            <div style="font-size: 12px; color: #6b7280;">ğŸ“‰ æœ€ä½TPI</div>
                            <div style="font-size: 28px; font-weight: bold; color: #ca8a04;">${minTPI}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h3 style="margin: 0 0 10px; font-size: 15px;">ğŸ“… æ´»è·ƒåº¦</h3>
                            <p style="margin: 4px 0; font-size: 14px;">è®°å½•å¤©æ•°: <strong>${weekData.length}</strong> å¤©</p>
                            <p style="margin: 4px 0; font-size: 14px;">è¾¾æ ‡ç‡(â‰¥80): <strong>${weekData.length > 0 ? Math.round((reachDays / weekData.length) * 100) : 0}%</strong></p>
                            <p style="margin: 4px 0; font-size: 14px;">é«˜æ•ˆæ—¥(â‰¥100): <strong>${highDays}</strong> å¤©</p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h3 style="margin: 0 0 10px; font-size: 15px;">ğŸ“ˆ å¹³å‡æŒ‡æ ‡</h3>
                            <p style="margin: 4px 0; font-size: 14px;">å¹³å‡AMI: <strong>${avgAMI.toFixed(1)}</strong></p>
                            <p style="margin: 4px 0; font-size: 14px;">å¹³å‡MA7: <strong>${(weekData.reduce((sum, d) => sum + ((d.ma7 || d['ma7-score']) || 0), 0) / weekData.length).toFixed(1)}</strong></p>
                        </div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <h3 style="margin: 0 0 12px; font-size: 15px;">ğŸ“‹ æ¯æ—¥æ•°æ®</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: #f3f4f6;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">æ—¥æœŸ</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">TPI</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">AMI</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${weekData.map(d => {
                                    const tpi = (d.tpi || d['tpi-total']) || 0;
                                    const color = tpi >= 120 ? '#16a34a' : tpi >= 95 ? '#2563eb' : tpi >= 80 ? '#ca8a04' : '#dc2626';
                                    const label = tpi >= 120 ? 'å“è¶Š' : tpi >= 95 ? 'ç¨³å¥' : tpi >= 80 ? 'è¾¾æ ‡' : 'éœ€è°ƒæ•´';
                                    return `<tr style="border-bottom: 1px solid #f3f4f6;">
                                        <td style="padding: 6px 8px;">${d.date}</td>
                                        <td style="padding: 6px 8px; text-align: right; font-weight: bold; color: ${color};">${tpi}</td>
                                        <td style="padding: 6px 8px; text-align: right;">${(d.ami || d['ami-score']) || 0}</td>
                                        <td style="padding: 6px 8px; text-align: right;"><span style="color:${color}; font-weight:600;">${label}</span></td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                window.currentReportData = { type: 'weekly', data: weekData };
                console.log('âœ… å‘¨æŠ¥HTMLå·²ç”Ÿæˆå¹¶æ’å…¥DOM');
                alert('âœ… å‘¨æŠ¥å·²ç”Ÿæˆï¼å¯ä»¥é¢„è§ˆæˆ–å¯¼å‡º');
            },

            generateMonthlyReport: function() {
                console.log('[TPIAdvanced] ç”ŸæˆæœˆæŠ¥è¢«è°ƒç”¨');
                
                try {
                    const today = new Date();
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    const monthData = [];

                    // éå†æœ¬æœˆæ¯å¤©ï¼Œæ”¶é›†localStorageæ•°æ®
                    for (let d = new Date(monthStart); d <= today; d = new Date(d.getTime() + 86400000)) {
                        const dateStr = d.toISOString().split('T')[0];
                        const dataStr = localStorage.getItem('tpi_data_' + dateStr);
                        if (dataStr) {
                            try { monthData.push({ date: dateStr, ...JSON.parse(dataStr) }); } catch(e) {console.warn('è§£ææ—¥æœŸæ•°æ®å¤±è´¥:', dateStr, e);}
                        }
                    }

                    console.log('ğŸ“Š æ‰¾åˆ°', monthData.length, 'å¤©çš„æ•°æ®');

                    if (monthData.length === 0) {
                        alert('âš ï¸ æœªæ‰¾åˆ°æœ¬æœˆæ•°æ®ï¼Œè¯·å…ˆè®°å½•ä»Šå¤©çš„æ•°æ®');
                        return;
                    }

                    const avgTPI = monthData.reduce((sum, d) => sum + ((d.tpi || d['tpi-total']) || 0), 0) / monthData.length;
                    const maxTPI = Math.max(...monthData.map(d => (d.tpi || d['tpi-total']) || 0));
                    const minTPI = Math.min(...monthData.map(d => (d.tpi || d['tpi-total']) || 0));
                    const avgAMI = monthData.reduce((sum, d) => sum + ((d.ami || d['ami-score']) || 0), 0) / monthData.length;
                    const avgMA7 = monthData.reduce((sum, d) => sum + ((d.ma7 || d['ma7-score']) || 0), 0) / monthData.length;
                    const avgFLI = monthData.reduce((sum, d) => sum + ((d.fli || d['fli-score']) || 0), 0) / monthData.length;
                    const totalWords = monthData.reduce((sum, d) => sum + (d.totalWords || 0), 0);
                    const highDays = monthData.filter(d => ((d.tpi || d['tpi-total']) || 0) >= 100).length;
                    const reachDays = monthData.filter(d => ((d.tpi || d['tpi-total']) || 0) >= 80).length;
                    const monthName = today.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' });

                    console.log('ğŸ“ˆ å¹³å‡TPI:', avgTPI.toFixed(1), 'æœ€é«˜:', maxTPI, 'æœ€ä½:', minTPI);

                    const preview = document.getElementById('advancedReportPreview');
                    if (!preview) {
                        console.error('âŒ æœªæ‰¾åˆ°advancedReportPreviewå…ƒç´ ');
                        return;
                    }

                    preview.innerHTML = `
                        <h2 style="color: #2563eb; margin-bottom: 20px;">ğŸ“ˆ TPIæœˆæŠ¥ â€” ${monthName}</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                            <div style="background: #eff6ff; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <div style="font-size: 12px; color: #6b7280;">ğŸ“Š å¹³å‡TPI</div>
                                <div style="font-size: 28px; font-weight: bold; color: #2563eb;">${avgTPI.toFixed(1)}</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 16px; border-radius: 8px; border-left: 4px solid #22c55e;">
                                <div style="font-size: 12px; color: #6b7280;">ğŸ† æœ€é«˜TPI</div>
                                <div style="font-size: 28px; font-weight: bold; color: #16a34a;">${maxTPI}</div>
                            </div>
                            <div style="background: #fefce8; padding: 16px; border-radius: 8px; border-left: 4px solid #eab308;">
                                <div style="font-size: 12px; color: #6b7280;">ğŸ“‰ æœ€ä½TPI</div>
                                <div style="font-size: 28px; font-weight: bold; color: #ca8a04;">${minTPI}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                            <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <h3 style="margin: 0 0 10px; font-size: 15px;">ğŸ“… æ´»è·ƒåº¦</h3>
                                <p style="margin: 4px 0; font-size: 14px;">è®°å½•å¤©æ•°: <strong>${monthData.length}</strong> å¤©</p>
                                <p style="margin: 4px 0; font-size: 14px;">è¾¾æ ‡ç‡(â‰¥80): <strong>${monthData.length > 0 ? Math.round((reachDays / monthData.length) * 100) : 0}%</strong></p>
                                <p style="margin: 4px 0; font-size: 14px;">é«˜æ•ˆæ—¥(â‰¥100): <strong>${highDays}</strong> å¤©</p>
                            </div>
                            <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <h3 style="margin: 0 0 10px; font-size: 15px;">ğŸ“Š å¹³å‡æŒ‡æ ‡</h3>
                                <p style="margin: 4px 0; font-size: 14px;">å¹³å‡AMI: <strong>${avgAMI.toFixed(1)}</strong></p>
                                <p style="margin: 4px 0; font-size: 14px;">å¹³å‡MA7: <strong>${avgMA7.toFixed(1)}</strong></p>
                                <p style="margin: 4px 0; font-size: 14px;">å¹³å‡FLI: <strong>${avgFLI.toFixed(1)}</strong></p>
                            </div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 12px;">
                            <h3 style="margin: 0 0 10px; font-size: 15px;">ğŸ“ äº§å‡ºç»Ÿè®¡</h3>
                            <p style="margin: 4px 0; font-size: 14px;">æ€»å­—æ•°: <strong>${totalWords.toLocaleString()}</strong></p>
                            <p style="margin: 4px 0; font-size: 14px;">æ—¥å‡å­—æ•°: <strong>${monthData.length > 0 ? Math.round(totalWords / monthData.length).toLocaleString() : 0}</strong></p>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h3 style="margin: 0 0 12px; font-size: 15px;">ğŸ“‹ æ¯æ—¥æ•°æ®</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #f3f4f6;">
                                        <th style="padding: 8px; text-align: left; border-bottom: 2px solid #e5e7eb;">æ—¥æœŸ</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">TPI</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">AMI</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 2px solid #e5e7eb;">çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${monthData.map(d => {
                                        const tpi = (d.tpi || d['tpi-total']) || 0;
                                        const color = tpi >= 120 ? '#16a34a' : tpi >= 95 ? '#2563eb' : tpi >= 80 ? '#ca8a04' : '#dc2626';
                                        const label = tpi >= 120 ? 'å“è¶Š' : tpi >= 95 ? 'ç¨³å¥' : tpi >= 80 ? 'è¾¾æ ‡' : 'éœ€è°ƒæ•´';
                                        return `<tr style="border-bottom: 1px solid #f3f4f6;">
                                            <td style="padding: 6px 8px;">${d.date}</td>
                                            <td style="padding: 6px 8px; text-align: right; font-weight: bold; color: ${color};">${tpi}</td>
                                            <td style="padding: 6px 8px; text-align: right;">${(d.ami || d['ami-score']) || 0}</td>
                                            <td style="padding: 6px 8px; text-align: right;"><span style="color:${color}; font-weight:600;">${label}</span></td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;

                    window.currentReportData = { type: 'monthly', data: monthData };
                    console.log('âœ… æœˆæŠ¥HTMLå·²ç”Ÿæˆå¹¶æ’å…¥DOM');
                    alert('âœ… æœˆæŠ¥å·²ç”Ÿæˆï¼å¯ä»¥é¢„è§ˆæˆ–å¯¼å‡º');
                } catch (e) {
                    console.error('[TPIAdvanced] ç”ŸæˆæœˆæŠ¥å¤±è´¥:', e);
                    alert('âŒ ç”ŸæˆæœˆæŠ¥å¤±è´¥ï¼š' + (e && e.message ? e.message : 'æœªçŸ¥é”™è¯¯'));
                }
            },

            exportReport: function(format) {
                console.log('[TPIAdvanced] å¯¼å‡ºæŠ¥å‘Šè¢«è°ƒç”¨ï¼Œæ ¼å¼:', format);
                
                if (!window.currentReportData) {
                    console.warn('[TPIAdvanced] æ²¡æœ‰å¯å¯¼å‡ºçš„æŠ¥å‘Šæ•°æ®');
                    alert('âš ï¸ è¯·å…ˆç”ŸæˆæŠ¥å‘Š');
                    return;
                }

                console.log('[TPIAdvanced] å½“å‰æŠ¥å‘Šæ•°æ®:', window.currentReportData);

                if (format === 'markdown') {
                    console.log('[TPIAdvanced] æ‰§è¡ŒMarkdownå¯¼å‡º');
                    const preview = document.getElementById('advancedReportPreview');
                    if (!preview || !preview.innerHTML.trim()) {
                        alert('âš ï¸ é¢„è§ˆåŒºåŸŸä¸ºç©ºï¼Œè¯·å…ˆç”ŸæˆæŠ¥å‘Š');
                        return;
                    }

                    // å°†HTMLè½¬æ¢ä¸ºMarkdown
                    const data = window.currentReportData.data || [];
                    const type = window.currentReportData.type || 'unknown';
                    const dateStr = new Date().toISOString().split('T')[0];
                    let md = '';

                    if (type === 'daily') {
                        md += '# ğŸ“… TPIæ—¥æŠ¥\n\n';
                        md += '**ç”Ÿæˆæ—¥æœŸ:** ' + dateStr + '\n\n';
                        if (data && data.tpi !== undefined) {
                            md += '## æ ¸å¿ƒæŒ‡æ ‡\n\n';
                            md += '| æŒ‡æ ‡ | æ•°å€¼ |\n|------|------|\n';
                            md += '| TPIæ€»åˆ† | ' + (data.tpi || 0) + ' |\n';
                            md += '| AMI | ' + (data.ami || 0) + ' |\n';
                            md += '| BCM | ' + (data.bcm || 0) + ' |\n';
                            md += '| HSM | ' + (data.hsm || 0) + ' |\n';
                            md += '| BONUS | ' + (data.bonus || 0) + ' |\n\n';
                        }
                    } else if (type === 'weekly') {
                        md += '# ğŸ“Š TPIå‘¨æŠ¥ (è¿‘7å¤©)\n\n';
                        md += '**ç”Ÿæˆæ—¥æœŸ:** ' + dateStr + '\n\n';
                        const avg = data.length > 0 ? (data.reduce((s, d) => s + (d.tpi || 0), 0) / data.length).toFixed(1) : 0;
                        md += '## å‘¨å¹³å‡æŒ‡æ ‡\n\n';
                        md += '- **å¹³å‡TPI:** ' + avg + '\n';
                        md += '- **æ•°æ®å¤©æ•°:** ' + data.length + ' å¤©\n\n';
                        md += '## æ¯æ—¥æ•°æ®\n\n';
                        md += '| æ—¥æœŸ | TPI | AMI | BCM | HSM | BONUS |\n|------|-----|-----|-----|-----|-------|\n';
                        data.forEach(function(d) {
                            md += '| ' + d.date + ' | ' + (d.tpi||0) + ' | ' + (d.ami||0) + ' | ' + (d.bcm||0) + ' | ' + (d.hsm||0) + ' | ' + (d.bonus||0) + ' |\n';
                        });
                        md += '\n';
                    } else if (type === 'monthly') {
                        md += '# ğŸ“ˆ TPIæœˆæŠ¥\n\n';
                        md += '**ç”Ÿæˆæ—¥æœŸ:** ' + dateStr + '\n\n';
                        const avg = data.length > 0 ? (data.reduce((s, d) => s + (d.tpi || 0), 0) / data.length).toFixed(1) : 0;
                        const maxTPI = data.length > 0 ? Math.max(...data.map(function(d){ return d.tpi||0; })) : 0;
                        const minTPI = data.length > 0 ? Math.min(...data.map(function(d){ return d.tpi||0; })) : 0;
                        const totalWords = data.reduce(function(s,d){ return s+(d.totalWords||0); }, 0);
                        const highDays = data.filter(function(d){ return (d.tpi||0)>=100; }).length;
                        const reachDays = data.filter(function(d){ return (d.tpi||0)>=80; }).length;

                        md += '## æœˆåº¦æ¦‚è¦\n\n';
                        md += '| æŒ‡æ ‡ | æ•°å€¼ |\n|------|------|\n';
                        md += '| å¹³å‡TPI | ' + avg + ' |\n';
                        md += '| æœ€é«˜TPI | ' + maxTPI + ' |\n';
                        md += '| æœ€ä½TPI | ' + minTPI + ' |\n';
                        md += '| è®°å½•å¤©æ•° | ' + data.length + ' |\n';
                        md += '| è¾¾æ ‡ç‡(â‰¥80) | ' + (data.length>0 ? Math.round((reachDays/data.length)*100) : 0) + '% |\n';
                        md += '| é«˜æ•ˆæ—¥(â‰¥100) | ' + highDays + ' |\n';
                        md += '| æ€»å­—æ•° | ' + totalWords.toLocaleString() + ' |\n\n';

                        md += '## æ¯æ—¥æ•°æ®\n\n';
                        md += '| æ—¥æœŸ | TPI | AMI | BCM | HSM | BONUS | çŠ¶æ€ |\n|------|-----|-----|-----|-----|-------|------|\n';
                        data.forEach(function(d) {
                            const tpi = d.tpi||0;
                            const label = tpi>=120?'å“è¶Š':tpi>=95?'ç¨³å¥':tpi>=80?'è¾¾æ ‡':'éœ€è°ƒæ•´';
                            md += '| ' + d.date + ' | ' + tpi + ' | ' + (d.ami||0) + ' | ' + (d.bcm||0) + ' | ' + (d.hsm||0) + ' | ' + (d.bonus||0) + ' | ' + label + ' |\n';
                        });
                        md += '\n';
                    } else {
                        // fallback: dump raw
                        md += '# TPIæŠ¥å‘Š\n\n**ç”Ÿæˆæ—¥æœŸ:** ' + dateStr + '\n\n';
                        md += '```json\n' + JSON.stringify(data, null, 2) + '\n```\n';
                    }

                    md += '---\n*æŠ¥å‘Šç”± TPI ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œæ—¶é—´: ' + new Date().toLocaleString() + '*\n';

                    const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'TPI_' + type + '_æŠ¥å‘Š_' + dateStr + '.md';
                    a.click();
                    URL.revokeObjectURL(url);
                    console.log('[TPIAdvanced] MarkdownæŠ¥å‘Šå¯¼å‡ºå®Œæˆ');
                    // ä½¿ç”¨NotifySystem.showToastä»£æ›¿showNotificationï¼Œé¿å…ä½œç”¨åŸŸé—®é¢˜
                    if (window.NotifySystem && typeof window.NotifySystem.showToast === 'function') {
                        window.NotifySystem.showToast('âœ… MarkdownæŠ¥å‘Šå·²å¯¼å‡ºï¼', 'success');
                    } else {
                        alert('âœ… MarkdownæŠ¥å‘Šå·²å¯¼å‡ºï¼');
                    }
                }
            },

            previewReport: function() {
                console.log('[TPIAdvanced] é¢„è§ˆæŠ¥å‘Šè¢«è°ƒç”¨');
                
                if (!window.currentReportData) {
                    console.warn('[TPIAdvanced] æ²¡æœ‰å¯é¢„è§ˆçš„æŠ¥å‘Šæ•°æ®');
                    alert('âš ï¸ è¯·å…ˆç”ŸæˆæŠ¥å‘Š');
                    return;
                }

                console.log('[TPIAdvanced] å½“å‰æŠ¥å‘Šæ•°æ®:', window.currentReportData);

                const preview = document.getElementById('advancedReportPreview');
                if (!preview || !preview.innerHTML.trim()) {
                    console.error('[TPIAdvanced] é¢„è§ˆå®¹å™¨ä¸ºç©º');
                    alert('âš ï¸ é¢„è§ˆåŒºåŸŸä¸ºç©ºï¼Œè¯·å…ˆç”ŸæˆæŠ¥å‘Š');
                    return;
                }

                // åœ¨é¡µé¢å†…åˆ›å»ºé¢„è§ˆæ¨¡æ€ï¼ˆé¿å… window.open è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰
                console.log('[TPIAdvanced] åˆ›å»ºé¡µå†…é¢„è§ˆæ¨¡æ€');
                const existingModal = document.getElementById('tpi-preview-modal');
                if (existingModal) existingModal.remove();

                const previewModal = document.createElement('div');
                previewModal.id = 'tpi-preview-modal';
                previewModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:99999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
                
                previewModal.innerHTML = `
                    <div style="background:white;width:90%;max-width:920px;max-height:88vh;border-radius:12px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 24px;background:#f8fafc;border-bottom:1px solid #e2e8f0;flex-shrink:0;">
                            <h3 style="margin:0;font-size:18px;color:#1e293b;">ğŸ‘ï¸ æŠ¥å‘Šé¢„è§ˆ</h3>
                            <div style="display:flex;gap:10px;">
                                <button onclick="(function(){var p=document.getElementById('tpi-preview-body');if(p){var w=window.open('','_blank');if(w){w.document.write('<html><head><meta charset=UTF-8><title>TPIæŠ¥å‘Šé¢„è§ˆ</title><style>body{font-family:Arial,sans-serif;max-width:900px;margin:40px auto;padding:20px;}h2{color:#2563eb;}table{width:100%;border-collapse:collapse;margin:20px 0;}th,td{padding:10px;border:1px solid #e5e7eb;}th{background:#f3f4f6;}.btn{padding:10px 20px;margin:10px 5px;cursor:pointer;border:1px solid #ccc;border-radius:6px;background:#fff;}</style></head><body>'+p.innerHTML+'<div style=text-align:center;margin-top:30px><button class=btn onclick=window.print()>ğŸ–¨ï¸ æ‰“å°</button><button class=btn onclick=window.close()>å…³é—­</button></div></body></html>');w.document.close();}}})()" style="padding:6px 14px;border:1px solid #cbd5e1;border-radius:6px;background:#fff;cursor:pointer;font-size:13px;color:#334155;transition:all 0.15s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#fff'">ğŸŒ æ–°çª—å£æ‰“å¼€</button>
                                <button onclick="document.getElementById('tpi-preview-modal').remove()" style="padding:6px 14px;border:none;border-radius:6px;background:#ef4444;color:#fff;cursor:pointer;font-size:13px;font-weight:600;transition:background 0.15s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">âœ• å…³é—­</button>
                            </div>
                        </div>
                        <div id="tpi-preview-body" style="padding:24px;overflow-y:auto;flex:1;background:#fafbfc;">
                            ${preview.innerHTML}
                        </div>
                    </div>
                `;

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                previewModal.addEventListener('click', function(e) {
                    if (e.target === previewModal) {
                        previewModal.remove();
                    }
                });
                // ESCé”®å…³é—­
                const escHandler = function(e) {
                    if (e.key === 'Escape') {
                        previewModal.remove();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);

                document.body.appendChild(previewModal);
                console.log('[TPIAdvanced] é¡µå†…é¢„è§ˆæ¨¡æ€å·²æ˜¾ç¤º');
            },
            healthCheck: function() {
                try {
                    let issues = [];
                    let report = 'ğŸ’Š æ•°æ®å¥åº·æ£€æŸ¥æŠ¥å‘Š\n\n';

                    const dataKeys = Object.keys(localStorage).filter(k => k.startsWith('tpi_data_'));
                    report += 'ğŸ“¦ æ€»è®°å½•æ•°: ' + dataKeys.length + '\n\n';

                    dataKeys.forEach(key => {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            if (!data) issues.push(key + ': æ•°æ®ä¸ºç©º');
                        } catch (e) {
                            issues.push(key + ': JSONè§£æå¤±è´¥');
                        }
                    });

                    if (issues.length === 0) {
                        report += 'âœ… æ‰€æœ‰æ•°æ®å¥åº·ï¼Œæœªå‘ç°é—®é¢˜ï¼';
                    } else {
                        report += 'âš ï¸ å‘ç° ' + issues.length + ' ä¸ªé—®é¢˜:\n\n';
                        issues.slice(0, 10).forEach(issue => report += 'â€¢ ' + issue + '\n');
                        if (issues.length > 10) report += '\n... è¿˜æœ‰ ' + (issues.length - 10) + ' ä¸ªé—®é¢˜';
                    }
                    alert(report);
                } catch (e) {
                    alert('âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ' + e.message);
                }
            },
            openRecovery: function() {

                // åˆ›å»ºæ¢å¤ä¸­å¿ƒå¯¹è¯æ¡†
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';

                // è·å–æ‰€æœ‰å¤‡ä»½
                const backups = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('tpi_backup_')) {
                        try {
                            const backupData = JSON.parse(localStorage.getItem(key));
                            backups.push({
                                key: key,
                                name: key.replace('tpi_backup_', ''),
                                date: backupData.timestamp || 'æœªçŸ¥æ—¶é—´',
                                count: backupData.dataCount || 0
                            });
                        } catch (e) {
                            console.warn('è·³è¿‡æ— æ•ˆå¤‡ä»½:', key);
                        }
                    }
                }

                // æŒ‰æ—¥æœŸæ’åº
                backups.sort((a, b) => new Date(b.date) - new Date(a.date));

                let backupListHTML = '';
                if (backups.length === 0) {
                    backupListHTML = '<p style="text-align: center; color: #6b7280; padding: 40px 20px;">æš‚æ— å¤‡ä»½æ•°æ®</p>';
                } else {
                    backupListHTML = '<div style="max-height: 400px; overflow-y: auto;">';
                    backups.forEach((backup, index) => {
                        const date = new Date(backup.date);
                        const dateStr = date.toLocaleString('zh-CN');
                        backupListHTML += `
                            <div style="background: ${index % 2 === 0 ? '#f9fafb' : '#ffffff'}; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e5e7eb;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h6 style="margin: 0 0 5px 0; color: #111827;">ğŸ“¦ ${backup.name}</h6>
                                        <small style="color: #6b7280;">
                                            â° ${dateStr} | ğŸ“Š ${backup.count} æ¡è®°å½•
                                        </small>
                                    </div>
                                    <button onclick="restoreBackupFromKey('${backup.key}')" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                        ğŸ”„ æ¢å¤æ­¤å¤‡ä»½
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    backupListHTML += '</div>';
                }

                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h3 style="margin: 0; color: #111827; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 32px;">ğŸ”„</span>
                                <span>æ•°æ®æ¢å¤ä¸­å¿ƒ</span>
                            </h3>
                            <button onclick="this.closest('[style*=fixed]').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; padding: 5px;">âœ•</button>
                        </div>

                        <div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #1e40af; font-size: 14px;">
                                <strong>ğŸ’¡ æç¤ºï¼š</strong>é€‰æ‹©ä¸€ä¸ªå¤‡ä»½ç‚¹æ¢å¤æ•°æ®ã€‚æ¢å¤åå°†è¦†ç›–å½“å‰æ•°æ®ï¼Œå»ºè®®å…ˆå¯¼å‡ºå½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½ã€‚
                            </p>
                        </div>

                        <h5 style="margin: 0 0 15px 0; color: #374151;">å¯ç”¨å¤‡ä»½åˆ—è¡¨</h5>
                        ${backupListHTML}

                        <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e5e7eb; display: flex; gap: 10px;">
                            <button onclick="window.exportAllDataGlobal ? window.exportAllDataGlobal() : (TPI && TPI.exportAllData ? TPI.exportAllData() : alert('å¯¼å‡ºåŠŸèƒ½ä¸å¯ç”¨'))" style="flex: 1; background: #10b981; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ğŸ“¤ å¯¼å‡ºå½“å‰æ•°æ®
                            </button>
                            <button onclick="this.closest('[style*=fixed]').remove()" style="flex: 1; background: #6b7280; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                `;

                modal.onclick = function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };

                document.body.appendChild(modal);

                // å®šä¹‰æ¢å¤å¤‡ä»½çš„å‡½æ•°ï¼ˆéœ€è¦è®¿é—®modalå˜é‡ï¼‰
                window.restoreBackupFromKey = function(backupKey) {
                    try {

                        const backupData = localStorage.getItem(backupKey);
                        if (!backupData) {
                            alert('âŒ å¤‡ä»½æ•°æ®ä¸å­˜åœ¨');
                            return;
                        }

                        const backup = JSON.parse(backupData);
                        const backupName = backupKey.replace('tpi_backup_', '');

                        if (!confirm(`âš ï¸ ç¡®è®¤æ¢å¤å¤‡ä»½ "${backupName}"?

å½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼

å»ºè®®å…ˆå¯¼å‡ºå½“å‰æ•°æ®ä½œä¸ºå¤‡ä»½ã€‚`)) {
                            return;
                        }

                        // æ¢å¤å¤‡ä»½æ•°æ®
                        let restoredCount = 0;
                        if (backup.data && typeof backup.data === 'object') {
                            for (let key in backup.data) {
                                if (backup.data.hasOwnProperty(key)) {
                                    localStorage.setItem(key, backup.data[key]);
                                    restoredCount++;
                                }
                            }
                        }

                        // å…³é—­æ¨¡æ€æ¡†
                        const recoveryModal = document.querySelector('[style*="position: fixed"][style*="z-index: 10000"]');
                        if (recoveryModal) {
                            recoveryModal.remove();
                        }

                        alert(`âœ… å¤‡ä»½æ¢å¤æˆåŠŸï¼

å·²æ¢å¤ ${restoredCount} æ¡è®°å½•

é¡µé¢å³å°†åˆ·æ–°ä»¥æ˜¾ç¤ºæ¢å¤çš„æ•°æ®...`);

                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } catch (error) {
                        console.error('âŒ æ¢å¤å¤‡ä»½å¤±è´¥:', error);
                        alert('âŒ æ¢å¤å¤‡ä»½å¤±è´¥: ' + error.message);
                    }
                };
            },
            exportFullBackup: function() {
                console.log('[TPIAdvanced] å®Œæ•´å¤‡ä»½è¢«è°ƒç”¨');
                
                try {
                    const allData = {};
                    let count = 0;
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('tpi_')) {
                            allData[key] = localStorage.getItem(key);
                            count++;
                        }
                    }

                    console.log('[TPIAdvanced] æ”¶é›†åˆ°', count, 'ä¸ªTPIç›¸å…³æ•°æ®é¡¹');

                    const dataStr = JSON.stringify(allData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const filename = 'TPIå®Œæ•´å¤‡ä»½_' + new Date().toISOString().split('T')[0] + '.json';
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    console.log('[TPIAdvanced] å®Œæ•´å¤‡ä»½å¯¼å‡ºå®Œæˆï¼Œæ–‡ä»¶å:', filename);
                    alert('âœ… å®Œæ•´å¤‡ä»½å·²å¯¼å‡ºï¼');
                } catch (e) {
                    console.error('[TPIAdvanced] å¤‡ä»½å¯¼å‡ºå¤±è´¥:', e);
                    alert('âŒ å¤‡ä»½å¯¼å‡ºå¤±è´¥: ' + e.message);
                }
            }
        };
    }

    // è¶‹åŠ¿å›¾å¢å¼ºå™¨çš„Fallback
    if (typeof window.trendChartEnhancer === 'undefined') {
        window.trendChartEnhancer = {
            showChartUI: function() {
                console.log('[TrendChart] æ‰“å¼€è¶‹åŠ¿åˆ†æç•Œé¢');
                
                // æ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
                if (typeof Chart === 'undefined') {
                    alert('è¶‹åŠ¿åˆ†æåŠŸèƒ½æ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨åé‡è¯•ã€‚\n\nå¦‚æœæŒç»­å‡ºç°æ­¤é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚');
                    console.error('[TrendChart] Chart.jsåº“æœªåŠ è½½');
                    return;
                }
                
                // åˆ›å»ºè¶‹åŠ¿åˆ†ææ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 12px; position: relative;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e5e7eb;">
                            <h2 style="margin: 0;">ğŸ“ˆ è¶‹åŠ¿åˆ†æ</h2>
                            <button class="trend-close-btn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">âœ•</button>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            <div style="margin-bottom: 20px;">
                                <h3>ğŸ“Š TPIæŒ‡æ•°è¶‹åŠ¿å›¾</h3>
                                <div class="chart-container" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <canvas id="trendChartModal" style="max-height: 400px;"></canvas>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
                                <button class="btn btn-secondary trend-day-btn" data-days="7">è¿‘7å¤©</button>
                                <button class="btn btn-secondary trend-day-btn" data-days="14">è¿‘14å¤©</button>
                                <button class="btn btn-secondary trend-day-btn" data-days="30">è¿‘30å¤©</button>
                                <button class="btn btn-secondary trend-day-btn" data-days="90">è¿‘90å¤©</button>
                            </div>

                            <div class="alert alert-info" style="background-color: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 15px; margin-top: 20px;">
                                <h4 style="margin-top: 0;">ğŸ“ˆ è¶‹åŠ¿åˆ†æè¯´æ˜</h4>
                                <ul style="margin-bottom: 0;">
                                    <li><strong>è“çº¿</strong>ï¼šTPIæ€»åˆ†è¶‹åŠ¿</li>
                                    <li><strong>ç»¿çº¿</strong>ï¼š7æ—¥ç§»åŠ¨å¹³å‡çº¿</li>
                                    <li><strong>ç›®æ ‡</strong>ï¼šæŒç»­ä¿æŒåœ¨90åˆ†ä»¥ä¸Š</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                console.log('[TrendChart] è¶‹åŠ¿åˆ†ææ¨¡æ€æ¡†å·²åˆ›å»º');
                
                // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶ç›‘å¬å™¨è€Œéinline onclickï¼‰
                const closeBtn = modal.querySelector('.trend-close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        try {
                            if (window.trendChartInstance) {
                                window.trendChartInstance.destroy();
                                window.trendChartInstance = null;
                            }
                        } catch(err) {
                            console.warn('[TrendChart] é”€æ¯å›¾è¡¨å®ä¾‹å¤±è´¥:', err);
                        }
                        modal.remove();
                        console.log('[TrendChart] è¶‹åŠ¿åˆ†æå¼¹çª—å·²å…³é—­');
                    });
                }
                
                // ç»‘å®šå¤©æ•°åˆ‡æ¢æŒ‰é’®äº‹ä»¶
                const dayBtns = modal.querySelectorAll('.trend-day-btn');
                dayBtns.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const days = parseInt(this.getAttribute('data-days'));
                        if (days && days > 0) {
                            window.trendChartEnhancer.updateChart(days);
                        }
                    });
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­ï¼ˆå¯é€‰ï¼‰
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        try {
                            if (window.trendChartInstance) {
                                window.trendChartInstance.destroy();
                                window.trendChartInstance = null;
                            }
                        } catch(err) {}
                        modal.remove();
                    }
                });

                // åˆå§‹åŒ–å›¾è¡¨
                setTimeout(() => {
                    try {
                        this.initChart(30); // é»˜è®¤æ˜¾ç¤ºè¿‘30å¤©
                    } catch (error) {
                        console.error('[TrendChart] åˆå§‹åŒ–å¤±è´¥:', error);
                        const chartContainer = document.querySelector('.chart-container');
                        if (chartContainer) {
                            chartContainer.innerHTML = '<div class="alert alert-warning" style="padding: 20px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px;">âš ï¸ è¶‹åŠ¿å›¾åˆå§‹åŒ–å¤±è´¥<br><br><strong>å¯èƒ½åŸå› ï¼š</strong><br>â€¢ æ•°æ®ä¸è¶³ï¼ˆéœ€è¦è‡³å°‘ä¸€å¤©çš„æ•°æ®ï¼‰<br>â€¢ Chart.jsåº“åŠ è½½å¤±è´¥<br><br><strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>â€¢ è¯·ç¡®ä¿å·²å¡«å†™ä»Šæ—¥æ•°æ®<br>â€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°é¡µé¢</div>';
                        }
                    }
                }, 100);
            },

            initChart: function(days = 30) {
                console.log('[TrendChart] åˆå§‹åŒ–å›¾è¡¨ï¼Œå¤©æ•°:', days);
                
                const canvas = document.getElementById('trendChartModal');
                if (!canvas) {
                    console.error('[TrendChart] æ‰¾ä¸åˆ°canvaså…ƒç´ ');
                    return;
                }

                console.log('[TrendChart] Canvaså…ƒç´ æ‰¾åˆ°ï¼Œå¼€å§‹è·å–å†å²æ•°æ®');

                // è·å–å†å²æ•°æ®
                const data = this.getHistoricalData(days);
                
                console.log('[TrendChart] å†å²æ•°æ®:', data);
                
                // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
                const validDataCount = data.values.filter(v => v !== null && v !== undefined && v > 0).length;
                console.log('[TrendChart] æœ‰æ•ˆæ•°æ®ç‚¹:', validDataCount);
                
                if (validDataCount === 0) {
                    console.warn('[TrendChart] æ²¡æœ‰æœ‰æ•ˆæ•°æ®');
                    canvas.parentElement.innerHTML = '<div class="alert alert-info" style="padding: 20px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; text-align: center;">ğŸ“Š æš‚æ— å†å²æ•°æ®<br><br>è¯·å…ˆåœ¨"æ•°æ®å·¥åŠ"ä¸­å¡«å†™ä»Šæ—¥æ•°æ®ï¼Œ<br>ä¹‹åå³å¯æŸ¥çœ‹è¶‹åŠ¿åˆ†æã€‚</div>';
                    return;
                }

                // é”€æ¯æ—§å›¾è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (window.trendChartInstance) {
                    try {
                        window.trendChartInstance.destroy();
                        console.log('[TrendChart] å·²é”€æ¯æ—§å›¾è¡¨');
                    } catch (e) {
                        console.warn('[TrendChart] é”€æ¯æ—§å›¾è¡¨å¤±è´¥:', e);
                    }
                }

                // ä½¿ç”¨Chart.jsç»˜åˆ¶
                try {
                    if (typeof Chart !== 'undefined') {
                        console.log('[TrendChart] Chart.jså·²åŠ è½½ï¼Œå¼€å§‹ç»˜åˆ¶å›¾è¡¨');
                        const ctx = canvas.getContext('2d');
                        window.trendChartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: data.labels,
                                datasets: [{
                                    label: 'TPIåˆ†æ•°',
                                    data: data.values,
                                    borderColor: 'rgb(59, 130, 246)',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.3,
                                    fill: true,
                                    spanGaps: true // è·³è¿‡nullå€¼
                                }, {
                                    label: '7æ—¥å‡çº¿',
                                    data: data.movingAvg,
                                    borderColor: 'rgb(34, 197, 94)',
                                    borderDash: [5, 5],
                                    tension: 0.3,
                                    fill: false,
                                    spanGaps: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `TPIæ•ˆèƒ½è¶‹åŠ¿åˆ†æ (è¿‘${days}å¤©ï¼Œæœ‰æ•ˆæ•°æ®${validDataCount}å¤©)`,
                                        font: {
                                            size: 16,
                                            weight: 'bold'
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                if (context.parsed.y !== null) {
                                                    label += context.parsed.y.toFixed(1) + 'åˆ†';
                                                }
                                                return label;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 110,
                                        ticks: {
                                            callback: function(value) {
                                                return value + 'åˆ†';
                                            }
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            maxRotation: 45,
                                            minRotation: 45
                                        }
                                    }
                                }
                            }
                        });
                        console.log('[TrendChart] å›¾è¡¨ç»˜åˆ¶å®Œæˆ');
                    } else {
                        console.error('[TrendChart] Chart.jsåº“æœªåŠ è½½');
                        canvas.parentElement.innerHTML = '<div class="alert alert-warning" style="padding: 20px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px;">âš ï¸ Chart.jsåº“æœªåŠ è½½ï¼Œæ— æ³•æ˜¾ç¤ºå›¾è¡¨ã€‚<br><br>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°é¡µé¢ã€‚</div>';
                    }
                } catch (chartError) {
                    console.error('[TrendChart] Chart.jsç»˜åˆ¶å¤±è´¥:', chartError);
                    const chartContainer = document.querySelector('.chart-container');
                    if (chartContainer) {
                        chartContainer.innerHTML = '<div class="alert alert-danger" style="padding: 20px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 8px;">âŒ å›¾è¡¨ç»˜åˆ¶å¤±è´¥: ' + chartError.message + '<br><br>è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</div>';
                    }
                }
            },

            getHistoricalData: function(days) {
                console.log('[TrendChart] è·å–å†å²æ•°æ®ï¼Œå¤©æ•°:', days);
                
                const labels = [];
                const values = [];
                const today = new Date();

                try {
                    for (let i = days - 1; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().split('T')[0];
                        
                        // æ ¼å¼åŒ–æ—¥æœŸæ ‡ç­¾ä¸ºæ›´å‹å¥½çš„æ ¼å¼
                        const month = date.getMonth() + 1;
                        const day = date.getDate();
                        labels.push(`${month}/${day}`);

                        // ä»localStorageè·å–æ•°æ®
                        try {
                            const data = localStorage.getItem('tpi_data_' + dateStr);
                            if (data) {
                                const parsed = JSON.parse(data);
                                const tpiValue = parsed.tpi || parsed.total || 0;
                                values.push(tpiValue > 0 ? tpiValue : null);
                            } else {
                                values.push(null);
                            }
                        } catch (e) {
                            console.error('[TrendChart] è§£ææ—¥æœŸæ•°æ®å¤±è´¥:', dateStr, e);
                            values.push(null);
                        }
                    }

                    // è®¡ç®—7æ—¥ç§»åŠ¨å¹³å‡
                    const movingAvg = values.map((val, idx) => {
                        if (val === null || val === undefined) return null;
                        const start = Math.max(0, idx - 6);
                        const slice = values.slice(start, idx + 1).filter(v => v !== null && v !== undefined && v > 0);
                        if (slice.length === 0) return null;
                        const avg = slice.reduce((a, b) => a + b, 0) / slice.length;
                        return Math.round(avg * 10) / 10; // ä¿ç•™ä¸€ä½å°æ•°
                    });

                    console.log('[TrendChart] å†å²æ•°æ®è·å–æˆåŠŸï¼Œå…±', labels.length, 'å¤©');
                    console.log('[TrendChart] æœ‰æ•ˆæ•°æ®ç‚¹:', values.filter(v => v !== null && v !== undefined && v > 0).length);
                    
                    return { labels, values, movingAvg };
                } catch (error) {
                    console.error('[TrendChart] è·å–å†å²æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    // è¿”å›ç©ºæ•°æ®è€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯
                    return { labels: [], values: [], movingAvg: [] };
                }
            },

            updateChart: function(days) {
                console.log('[TrendChart] æ›´æ–°å›¾è¡¨ï¼Œå¤©æ•°:', days);
                
                // æ£€æŸ¥dayså‚æ•°æ˜¯å¦æœ‰æ•ˆ
                if (!days || days < 1) {
                    console.error('[TrendChart] æ— æ•ˆçš„å¤©æ•°å‚æ•°:', days);
                    alert('å¤©æ•°å‚æ•°æ— æ•ˆï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„æ—¶é—´èŒƒå›´');
                    return;
                }
                
                // æ£€æŸ¥canvasæ˜¯å¦å­˜åœ¨
                const canvas = document.getElementById('trendChartModal');
                if (!canvas) {
                    console.warn('[TrendChart] Canvasä¸å­˜åœ¨ï¼Œæ— æ³•æ›´æ–°å›¾è¡¨');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½æç¤º
                if (canvas.parentElement) {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'loading-overlay';
                    loadingDiv.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;';
                    loadingDiv.innerHTML = '<div style="text-align: center;"><div style="font-size: 24px; margin-bottom: 10px;">â³</div><div>æ­£åœ¨åŠ è½½æ•°æ®...</div></div>';
                    canvas.parentElement.style.position = 'relative';
                    canvas.parentElement.appendChild(loadingDiv);
                    
                    // å»¶è¿Ÿæ‰§è¡Œä»¥æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                    setTimeout(() => {
                        // é‡æ–°åˆå§‹åŒ–å›¾è¡¨ï¼Œä¼ å…¥æ–°çš„å¤©æ•°
                        this.initChart(days);
                        console.log('[TrendChart] å›¾è¡¨å·²æ›´æ–°ä¸ºè¿‘' + days + 'å¤©æ•°æ®');
                        
                        // ç§»é™¤åŠ è½½æç¤º
                        if (loadingDiv && loadingDiv.parentElement) {
                            loadingDiv.remove();
                        }
                    }, 100);
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°canvasçˆ¶å…ƒç´ ï¼Œç›´æ¥åˆå§‹åŒ–
                    this.initChart(days);
                }
            }
        };
    }

})();
  </script>
  <script>
   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ•°æ®å·¥åŠåŠŸèƒ½å¢å¼º
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// âš ï¸ æ³¨æ„ï¼šexportDataCompleteå‡½æ•°å·²åœ¨HEADä¸­å®šä¹‰ï¼Œè¿™é‡Œä¸å†é‡å¤å®šä¹‰

(function() {
    'use strict';

    // å¤åˆ¶å‰ä¸€å¤©æ•°æ®
    window.copyPreviousDayData = function() {
        try {
            const currentDate = document.getElementById('date-input');
            if (!currentDate || !currentDate.value) {
                alert('è¯·å…ˆé€‰æ‹©å½“å‰æ—¥æœŸ');
                return;
            }

            const date = new Date(currentDate.value);
            date.setDate(date.getDate() - 1);
            const prevDate = date.toISOString().split('T')[0];

            const prevData = localStorage.getItem('tpi_data_' + prevDate);
            if (!prevData) {
                alert('æœªæ‰¾åˆ°å‰ä¸€å¤©(' + prevDate + ')çš„æ•°æ®');
                return;
            }

            if (confirm('ç¡®è®¤è¦å¤åˆ¶ ' + prevDate + ' çš„æ•°æ®åˆ°å½“å‰æ—¥æœŸå—?')) {
                localStorage.setItem('tpi_data_' + currentDate.value, prevData);
                alert('âœ… å·²æˆåŠŸå¤åˆ¶å‰ä¸€å¤©çš„æ•°æ®!\nè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹');
                location.reload();
            }
        } catch (e) {
            console.error('å¤åˆ¶æ•°æ®å¤±è´¥:', e);
            alert('å¤åˆ¶å¤±è´¥: ' + e.message);
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // åˆ›å»ºsmartFillEnhancerå¯¹è±¡ - ä¿®å¤é—®é¢˜5ï¼šå¤åˆ¶å‰ä¸€å¤©æ•°æ®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.smartFillEnhancer = {
        copyPreviousDay: function() {
            return window.copyPreviousDayData();
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ä¿®å¤é—®é¢˜2å’Œ3: åˆ›å»ºexportReportCompleteå‡½æ•°
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.exportReportComplete = function(format) {
        try {

            const reportContent = document.getElementById('advancedReportPreview') || document.getElementById('reportContent');

            // æ£€æŸ¥æ˜¯å¦æœ‰æŠ¥å‘Šå†…å®¹
            if (!reportContent || !reportContent.innerHTML.trim()) {
                alert('âš ï¸ è¯·å…ˆç”ŸæˆæŠ¥å‘Šå†…å®¹\n\nç‚¹å‡»"ç”Ÿæˆå‘¨æŠ¥"æˆ–"ç”ŸæˆæœˆæŠ¥"æŒ‰é’®ç”ŸæˆæŠ¥å‘Šåå†å¯¼å‡º');
                return;
            }

            if (format === 'pdf') {
                // ä½¿ç”¨æ‰“å°åŠŸèƒ½å¯¼å‡ºPDF

                // åˆ›å»ºä¸´æ—¶æ‰“å°çª—å£
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('âŒ æ— æ³•æ‰“å¼€æ‰“å°çª—å£\n\nè¯·å…è®¸å¼¹å‡ºçª—å£åé‡è¯•');
                    return;
                }

                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>TPIæŠ¥å‘Š - ${new Date().toISOString().split('T')[0]}</title>
                        <style>
    /* è¡¥å…¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
     body{font-family:Arial, sans-serif;padding:20px;max-width:800px;margin:0 auto;}h1, h2, h3{color:#2563eb;}table{width:100%;border-collapse:collapse;margin:20px 0;}th, td{border:1px solid #ddd;padding:8px;text-align:left;}th{background-color:#f3f4f6;}@media print{body{padding:10mm;}}</style>
                    </head>
                    <body>

        <div id="score-dashboard" style="background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); padding: 8px 16px; border-radius: 0; margin: 0; color: #1e293b; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
            <div style="max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: nowrap;">
                <!-- äº”ä¸ªéƒ¨åˆ†åˆ†æ•° -->
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ“ AMI</span>
                    <span id="dashboard-ami" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">âš¡ BCM</span>
                    <span id="dashboard-bcm" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ“¦ LOG</span>
                    <span id="dashboard-logistics" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ’ª HSM</span>
                    <span id="dashboard-hsm" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ BONUS</span>
                    <span id="dashboard-bonus" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <!-- TPIæ€»åˆ† -->
                <div style="display: inline-flex; align-items: center; gap: 8px; padding: 4px 12px; background: rgba(255,255,255,0.15); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">TPI æ€»åˆ†</span>
                    <span id="dashboard-total" style="font-size: 20px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <!-- è¯„çº§ -->
                <div id="dashboard-rating" style="font-size: 10px; padding: 4px 10px; background: rgba(255,255,255,0.2); border-radius: 12px; font-weight: 600; white-space: nowrap;">å¾…è¯„çº§</div>

            </div>

                        ${reportContent.innerHTML}
                    </body>
                    </html>
                `);
                printWindow.document.close();

                setTimeout(() => {
                    printWindow.print();
                }, 500);

                alert('ğŸ’¡ PDFå¯¼å‡ºæç¤º\n\nåœ¨æ‰“å°å¯¹è¯æ¡†ä¸­ï¼š\n1. é€‰æ‹©"å¦å­˜ä¸ºPDF"\n2. ç‚¹å‡»"ä¿å­˜"æŒ‰é’®\n\nå³å¯å°†æŠ¥å‘Šä¿å­˜ä¸ºPDFæ–‡ä»¶');

            } else if (format === 'excel') {
                // å¯¼å‡ºCSVæ ¼å¼ï¼ˆå…¼å®¹Excelï¼‰

                try {
                    // æå–æŠ¥å‘Šæ•°æ®
                    const dateStr = document.getElementById('date-input')?.value || new Date().toISOString().split('T')[0];
                    const dataStr = localStorage.getItem('tpi_data_' + dateStr);

                    if (!dataStr) {
                        alert('âš ï¸ æœªæ‰¾åˆ°å½“å‰æ—¥æœŸçš„æ•°æ®');
                        return;
                    }

                    const data = JSON.parse(dataStr);

                    // åˆ›å»ºCSVå†…å®¹
                    let csv = 'TPIæ•ˆèƒ½æŠ¥å‘Š\n\n';
                    csv += 'æ—¥æœŸ,' + dateStr + '\n\n';
                    csv += 'æŒ‡æ ‡,åˆ†æ•°\n';
                    csv += 'TPIæ€»åˆ†,' + (data.tpi || 0) + '\n';
                    csv += 'AMI (å­¦ä¸šæ•ˆèƒ½),' + (data.ami || 0) + '\n';
                    csv += 'HBI (ä¹ æƒ¯å¼ºåº¦),' + (data.hbi || 0) + '\n';
                    csv += 'PMI (èº«å¿ƒçŠ¶æ€),' + (data.pmi || 0) + '\n\n';
                    csv += 'è¯¦ç»†æ•°æ®\n';
                    csv += 'å­¦ä¹ æ—¶é•¿,' + (data.studyHours || 0) + 'å°æ—¶\n';
                    csv += 'ç‚¹ç«ç¨‹åº,' + (data.ignition || 'æœªè®°å½•') + '\n';
                    csv += 'æ¯æ—¥ä¹ æƒ¯,' + (data.habits ? Object.keys(data.habits).filter(k => data.habits[k]).length : 0) + 'é¡¹å®Œæˆ\n';
                    csv += 'è¿åŠ¨æ—¶é•¿,' + (data.exerciseMinutes || 0) + 'åˆ†é’Ÿ\n';
                    csv += 'ç¡çœ æ—¶é•¿,' + (data.sleepHours || 0) + 'å°æ—¶\n';

                    // æ·»åŠ BOMä»¥æ”¯æŒä¸­æ–‡
                    const BOM = '\uFEFF';
                    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `TPIæŠ¥å‘Š_${dateStr}.csv`;
                    link.click();
                    URL.revokeObjectURL(url);

                    alert('âœ… Excel(CSV)å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶å: TPIæŠ¥å‘Š_' + dateStr + '.csv\n\nå¯ç”¨Excelæˆ–WPSç›´æ¥æ‰“å¼€');
                } catch (error) {
                    console.error('Excelå¯¼å‡ºå¤±è´¥:', error);
                    alert('âŒ Excelå¯¼å‡ºå¤±è´¥\n\né”™è¯¯: ' + error.message);
                }
            }
        } catch (error) {
            console.error('å¯¼å‡ºæŠ¥å‘Šå¤±è´¥:', error);
            alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ä¿®å¤é—®é¢˜5: åˆ›å»ºcopyPreviousDayDataCompleteå‡½æ•° - ç«‹å³æ‰§è¡Œç¡®ä¿å¯ç”¨
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.copyPreviousDayDataComplete = function() {
        console.log('ğŸ“‹ [copyPreviousDayDataComplete] å‡½æ•°è¢«è°ƒç”¨');
        console.log('ğŸ“‹ [copyPreviousDayDataComplete] å°è¯•å¤åˆ¶:', new Date().toISOString().split('T')[0]);
        
        try {
            const currentDateInput = document.getElementById('date-input');
            if (!currentDateInput || !currentDateInput.value) {
                console.warn('âš ï¸ [copyPreviousDayDataComplete] æœªé€‰æ‹©å½“å‰æ—¥æœŸ');
                alert('âš ï¸ è¯·å…ˆé€‰æ‹©å½“å‰æ—¥æœŸ\n\nåœ¨é¡µé¢é¡¶éƒ¨çš„æ—¥æœŸé€‰æ‹©å™¨ä¸­é€‰æ‹©æ—¥æœŸ');
                return;
            }

            const currentDate = new Date(currentDateInput.value);
            const previousDate = new Date(currentDate);
            previousDate.setDate(previousDate.getDate() - 1);
            const prevDateStr = previousDate.toISOString().split('T')[0];

            console.log('ğŸ“‹ [copyPreviousDayDataComplete] å°è¯•å¤åˆ¶:', prevDateStr, 'â†’', currentDateInput.value);

            // è·å–å‰ä¸€å¤©çš„æ•°æ®
            const prevDataStr = localStorage.getItem('tpi_data_' + prevDateStr);

            if (!prevDataStr) {
                console.warn('âš ï¸ [copyPreviousDayDataComplete] æœªæ‰¾åˆ°å‰ä¸€å¤©çš„æ•°æ®');
                alert('âš ï¸ æœªæ‰¾åˆ°å‰ä¸€å¤©çš„æ•°æ®\n\nå‰ä¸€å¤©æ—¥æœŸ: ' + prevDateStr + '\n\nè¯·ç¡®ä¿å‰ä¸€å¤©æœ‰æ•°æ®è®°å½•');
                return;
            }

            // ç¡®è®¤å¯¹è¯æ¡†
            const confirmMsg = `ğŸ“‹ å¤åˆ¶å‰ä¸€å¤©æ•°æ®\n\n` +
                `ä»æ—¥æœŸ: ${prevDateStr}\n` +
                `åˆ°æ—¥æœŸ: ${currentDateInput.value}\n\n` +
                `âš ï¸ è¿™å°†è¦†ç›–å½“å‰æ—¥æœŸçš„æ‰€æœ‰æ•°æ®ï¼\n\n` +
                `ç¡®è®¤è¦ç»§ç»­å—ï¼Ÿ`;

            if (!confirm(confirmMsg)) {
                console.log('âŒ [copyPreviousDayDataComplete] ç”¨æˆ·å–æ¶ˆæ“ä½œ');
                return;
            }

            try {
                // è§£ææ•°æ®ä»¥éªŒè¯æ ¼å¼
                const prevData = JSON.parse(prevDataStr);

                // ä¿å­˜åˆ°å½“å‰æ—¥æœŸ
                localStorage.setItem('tpi_data_' + currentDateInput.value, prevDataStr);

                console.log('âœ… [copyPreviousDayDataComplete] å¤åˆ¶æˆåŠŸ');

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const successMsg = `âœ… å¤åˆ¶æˆåŠŸï¼\n\n` +
                    `å·²å°† ${prevDateStr} çš„æ•°æ®å¤åˆ¶åˆ° ${currentDateInput.value}\n\n` +
                    `æ•°æ®åŒ…æ‹¬:\n` +
                    `â€¢ TPIåˆ†æ•°: ${prevData.tpi || 0}\n` +
                    `â€¢ å­¦ä¹ æ—¶é•¿: ${prevData.studyHours || 0}å°æ—¶\n` +
                    `â€¢ ä¹ æƒ¯å®Œæˆæƒ…å†µ\n` +
                    `â€¢ å…¶ä»–è®°å½•\n\n` +
                    `ç‚¹å‡»"ç¡®å®š"åå°†åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ•°æ®`;

                alert(successMsg);

                // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ•°æ®
                location.reload();

            } catch (parseError) {
                console.error('âŒ [copyPreviousDayDataComplete] æ•°æ®è§£æå¤±è´¥:', parseError);
                alert('âŒ æ•°æ®æ ¼å¼é”™è¯¯\n\nå‰ä¸€å¤©çš„æ•°æ®å¯èƒ½å·²æŸå\nè¯·å°è¯•æ‰‹åŠ¨è¾“å…¥æ•°æ®');
            }

        } catch (error) {
            console.error('âŒ [copyPreviousDayDataComplete] å¤åˆ¶æ•°æ®å¤±è´¥:', error);
            alert('âŒ å¤åˆ¶å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message + '\n\nè¯·é‡è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ');
        }
    };

    // ç«‹å³éªŒè¯å‡½æ•°æ˜¯å¦å¯ç”¨
    if (typeof window.copyPreviousDayDataComplete === 'function') {
    } else {
        console.error('âŒ copyPreviousDayDataCompleteå‡½æ•°åˆ›å»ºå¤±è´¥');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ³¨æ„ï¼šexportDataCompleteå‡½æ•°å·²åœ¨å…¨å±€ä½œç”¨åŸŸå®šä¹‰ï¼Œè¿™é‡Œä¸å†é‡å¤å®šä¹‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    window.importDataComplete = function() {
        try {
            // å°è¯•ä¸¤ä¸ªå¯èƒ½çš„æ–‡ä»¶è¾“å…¥ID
            let fileInput = document.getElementById('import-file');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                fileInput = document.getElementById('import-file-input');
            }

            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('âš ï¸ è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let data;

                    // æ”¯æŒå¤šç§æ ¼å¼
                    if (file.name.endsWith('.json')) {
                        data = JSON.parse(content);
                    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        // æ£€æŸ¥XLSXåº“
                        if (typeof XLSX !== 'undefined') {
                            const workbook = XLSX.read(content, { type: 'binary' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(worksheet)[0]; // å–ç¬¬ä¸€è¡Œæ•°æ®
                        } else {
                            alert('âš ï¸ Excelå¯¼å…¥éœ€è¦SheetJSåº“\n\nè¯·ä½¿ç”¨JSONæ ¼å¼å¯¼å…¥');
                            return;
                        }
                    } else if (file.name.endsWith('.csv')) {
                        // ç®€å•CSVè§£æ
                        const lines = content.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        const values = lines[1].split(',').map(v => v.trim());
                        data = {};
                        headers.forEach((header, index) => {
                            data[header] = values[index] || '';
                        });
                    } else {
                        alert('âš ï¸ æ”¯æŒçš„æ ¼å¼: JSON, Excel, CSV\n\nå½“å‰æ–‡ä»¶: ' + file.name);
                        return;
                    }

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!data || typeof data !== 'object') {
                        throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                    }

                    // ç¡®è®¤å¯¼å…¥
                    const dateStr = document.getElementById('date-input')?.value || new Date().toISOString().split('T')[0];
                    const confirmMsg = `ğŸ“¥ ç¡®è®¤å¯¼å…¥æ•°æ®ï¼Ÿ\n\n` +
                        `æ–‡ä»¶å: ${file.name}\n` +
                        `ç›®æ ‡æ—¥æœŸ: ${dateStr}\n\n` +
                        `âš ï¸ è¿™å°†è¦†ç›–å½“å‰æ—¥æœŸçš„æ•°æ®ï¼`;

                    if (confirm(confirmMsg)) {
                        // ç¡®ä¿æ•°æ®æœ‰æ—¥æœŸå­—æ®µ
                        if (!data.date) {
                            data.date = dateStr;
                        }

                        localStorage.setItem('tpi_data_' + dateStr, JSON.stringify(data));
                        alert('âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼\n\nå³å°†åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ•°æ®');

                        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                        if (fileInput) {
                            fileInput.value = '';
                        }

                        location.reload();
                    }

                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    alert('âŒ å¯¼å…¥å¤±è´¥\n\né”™è¯¯: ' + error.message + '\n\nè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®');
                }
            };

            reader.onerror = function() {
                alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥\n\nè¯·é‡è¯•');
            };

            // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©è¯»å–æ–¹å¼
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.readAsBinaryString(file);
            } else {
                reader.readAsText(file);
            }

        } catch (error) {
            console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
            alert('âŒ å¯¼å…¥å¤±è´¥: ' + error.message);
        }
    };

    // æ•°æ®å¯¼å‡ºåŠŸèƒ½(4ç§æ ¼å¼)
    window.exportAllData = function(format) {
        console.log('ğŸ“¦ [exportAllData] å¯¼å‡ºæ‰€æœ‰æ•°æ®åŠŸèƒ½è¢«è°ƒç”¨');
        console.log('ğŸ“¦ [exportAllData] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        console.log('ğŸ“¦ [exportAllData] å¯¼å‡ºæ ¼å¼:', format || 'json');
        
        try {
            format = format || 'json';
            const allData = {};

            // æ”¶é›†æ‰€æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tpi_')) {
                    allData[key] = localStorage.getItem(key);
                }
            }
            
            console.log('ğŸ“¦ [exportAllData] æ”¶é›†åˆ°çš„æ•°æ®æ¡æ•°:', Object.keys(allData).length);

            if (Object.keys(allData).length === 0) {
                console.warn('âš ï¸ [exportAllData] æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }

            let dataStr, filename, mimeType;

            if (format === 'json') {
                dataStr = JSON.stringify(allData, null, 2);
                filename = 'TPI_æ•°æ®å¯¼å‡º_' + new Date().toISOString().split('T')[0] + '.json';
                mimeType = 'application/json';
            } else if (format === 'txt') {
                dataStr = JSON.stringify(allData, null, 2);
                filename = 'TPI_æ•°æ®å¯¼å‡º_' + new Date().toISOString().split('T')[0] + '.txt';
                mimeType = 'text/plain';
            } else if (format === 'csv') {
                // ç®€å•CSVæ ¼å¼
                let csv = 'é”®,å€¼\n';
                for (let key in allData) {
                    csv += '"' + key + '","' + allData[key].replace(/"/g, '""') + '"\n';
                }
                dataStr = csv;
                filename = 'TPI_æ•°æ®å¯¼å‡º_' + new Date().toISOString().split('T')[0] + '.csv';
                mimeType = 'text/csv';
            } else if (format === 'html') {
                let html = '<html><head><meta charset="UTF-8"><title>TPIæ•°æ®å¯¼å‡º</title></head><body>

        <div id="score-dashboard" style="background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); padding: 8px 16px; border-radius: 0; margin: 0; color: #1e293b; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
            <div style="max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: nowrap;">
                <!-- äº”ä¸ªéƒ¨åˆ†åˆ†æ•° -->
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ“ AMI</span>
                    <span id="dashboard-ami" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">âš¡ BCM</span>
                    <span id="dashboard-bcm" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ“¦ LOG</span>
                    <span id="dashboard-logistics" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ’ª HSM</span>
                    <span id="dashboard-hsm" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ BONUS</span>
                    <span id="dashboard-bonus" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <!-- TPIæ€»åˆ† -->
                <div style="display: inline-flex; align-items: center; gap: 8px; padding: 4px 12px; background: rgba(255,255,255,0.15); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">TPI æ€»åˆ†</span>
                    <span id="dashboard-total" style="font-size: 20px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <!-- è¯„çº§ -->
                <div id="dashboard-rating" style="font-size: 10px; padding: 4px 10px; background: rgba(255,255,255,0.2); border-radius: 12px; font-weight: 600; white-space: nowrap;">å¾…è¯„çº§</div>

            </div>
';
                html += '<h1>TPIæ•°æ®å¯¼å‡º</h1>';
                html += '<table border="1" cellpadding="5"><tr><th>é”®</th><th>å€¼</th></tr>';
                for (let key in allData) {
                    html += '<tr><td>' + key + '</td><td><pre>' + allData[key] + '</pre></td></tr>';
                }
                html += '</table></body></html>';
                dataStr = html;
                filename = 'TPI_æ•°æ®å¯¼å‡º_' + new Date().toISOString().split('T')[0] + '.html';
                mimeType = 'text/html';
            }
            
            console.log('ğŸ“¦ [exportAllData] å‡†å¤‡å¯¼å‡ºæ–‡ä»¶:', filename);
            console.log('ğŸ“¦ [exportAllData] æ–‡ä»¶å¤§å°:', Math.round(dataStr.length / 1024), 'KB');

            // ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([dataStr], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            URL.revokeObjectURL(url);

            console.log('âœ… [exportAllData] æ•°æ®å¯¼å‡ºæˆåŠŸ');
            alert('âœ… æ•°æ®å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶å: ' + filename);
        } catch (error) {
            console.error('âŒ [exportAllData] å¯¼å‡ºå¤±è´¥:', error);
            console.error('âŒ [exportAllData] é”™è¯¯å †æ ˆ:', error.stack);
            alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
        }
    };
    
    // ä¸ºTPIå¯¹è±¡åˆ›å»ºåˆ«å
    if (typeof window.TPI !== 'undefined') {
        window.TPI.exportAllData = window.exportAllData;
        console.log('âœ… [TPI] exportAllData å·²ç»‘å®šåˆ° TPI å¯¹è±¡');
    }
})();
  </script>
  <script>
   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¸»é¢˜è®¾ç½®å’Œå…¶ä»–UIåŠŸèƒ½
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
    'use strict';

    // ä¸»é¢˜åˆ‡æ¢
    window.toggleTheme = function() {
        // æ·±è‰²æ¨¡å¼å·²å–æ¶ˆï¼šä¿æŒæµ…è‰²æ¨¡å¼
        try {
            document.documentElement.setAttribute('data-theme', 'light');
            localStorage.setItem('tpi_theme', 'light');
            const themeBtn = document.querySelector('[onclick*="toggleTheme"], [onclick*="toggleThemeComplete"], #toggle-theme-btn');
            if (themeBtn) themeBtn.textContent = 'â˜€ï¸ æµ…è‰²æ¨¡å¼';
        } catch (e) {}
    };

    // æ¢å¤ä¸»é¢˜
    window.restoreTheme = function() {
        // æ·±è‰²æ¨¡å¼å·²å–æ¶ˆï¼šå§‹ç»ˆæ¢å¤ä¸ºæµ…è‰²æ¨¡å¼
        try {
            document.documentElement.setAttribute('data-theme', 'light');
            localStorage.setItem('tpi_theme', 'light');
            document.body.classList.remove('dark-theme');
            document.body.classList.remove('dark-mode');
            const s = document.getElementById('dark-mode-styles');
            if (s) s.remove();
            const btn = document.getElementById('dark-mode-toggle');
            if (btn) btn.remove();
        } catch (e) {
            console.error('æ¢å¤ä¸»é¢˜å¤±è´¥:', e);
        }
    };

    // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¸»é¢˜
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', restoreTheme);
    } else {
        restoreTheme();
    }

    // æ’¤é”€å’Œé‡åšæŒ‰é’®æ›´æ–°
    window.performUndo = function() {
        try {
            if (window.UndoRedoSystem) {
                const state = window.UndoRedoSystem.undo();
                if (state) {
                    window.UndoRedoSystem.restoreState(state);
                }
            } else {
                alert('æ’¤é”€åŠŸèƒ½æœªåˆå§‹åŒ–');
            }
        } catch (e) {
            console.error('æ’¤é”€å¤±è´¥:', e);
        }
    };

    window.performRedo = function() {
        try {
            if (window.UndoRedoSystem) {
                const state = window.UndoRedoSystem.redo();
                if (state) {
                    window.UndoRedoSystem.restoreState(state);
                }
            } else {
                alert('é‡åšåŠŸèƒ½æœªåˆå§‹åŒ–');
            }
        } catch (e) {
            console.error('é‡åšå¤±è´¥:', e);
        }
    };

    // æ˜¾ç¤ºæ“ä½œå†å²
    window.showOperationHistory = function() {
        try {
            if (window.OperationHistorySystem) {
                window.OperationHistorySystem.showHistory();
            } else {
                alert('æ“ä½œå†å²åŠŸèƒ½æœªåˆå§‹åŒ–');
            }
        } catch (e) {
            console.error('æ˜¾ç¤ºå†å²å¤±è´¥:', e);
        }
    };

    // æ˜¾ç¤ºéªŒè¯è§„åˆ™
    window.showValidationRules = function() {
        alert('ğŸ“‹ è¾“å…¥éªŒè¯è§„åˆ™\n\n1. æ•°å­—å­—æ®µå¿…é¡»åœ¨æŒ‡å®šèŒƒå›´å†…\n2. æ—¥æœŸå¿…é¡»ä¸ºæœ‰æ•ˆæ ¼å¼\n3. æ—¶é—´å¿…é¡»ä¸ºHH:MMæ ¼å¼\n4. è‡ªåŠ¨ä¿å­˜æ¯æ¬¡ä¿®æ”¹\n5. è¶…å‡ºèŒƒå›´è‡ªåŠ¨è°ƒæ•´åˆ°è¾¹ç•Œå€¼');
    };

    // åˆ·æ–°åŒæ­¥ç»Ÿè®¡
    window.refreshSyncStats = function() {
        try {
            const stats = {
                lastSync: localStorage.getItem('last_sync_time') || 'ä»æœªåŒæ­¥',
                localData: 0,
                cloudData: 'æœªé…ç½®'
            };

            // ç»Ÿè®¡æœ¬åœ°æ•°æ®
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tpi_data_')) {
                    stats.localData++;
                }
            }

            alert('ğŸ“Š åŒæ­¥æ•°æ®ç»Ÿè®¡\n\n' +
                  'æœ€ååŒæ­¥: ' + stats.lastSync + '\n' +
                  'æœ¬åœ°æ•°æ®: ' + stats.localData + ' æ¡\n' +
                  'äº‘ç«¯æ•°æ®: ' + stats.cloudData);
        } catch (e) {
            console.error('åˆ·æ–°ç»Ÿè®¡å¤±è´¥:', e);
        }
    };

    // æ¨¡æ¿ä¸Šä¼ é¢„è§ˆ
    window.previewTemplate = function() {
        // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,.txt,.csv';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const content = event.target.result;
                    let previewContent = '';
                    
                    // æ ¹æ®æ–‡ä»¶ç±»å‹å¤„ç†
                    if (file.name.endsWith('.json')) {
                        try {
                            const jsonData = JSON.parse(content);
                            previewContent = JSON.stringify(jsonData, null, 2);
                        } catch (e) {
                            previewContent = content;
                        }
                    } else {
                        previewContent = content;
                    }
                    
                    // é™åˆ¶é¢„è§ˆé•¿åº¦
                    if (previewContent.length > 5000) {
                        previewContent = previewContent.substring(0, 5000) + '\n\n... (å†…å®¹è¿‡é•¿ï¼Œä»…æ˜¾ç¤ºå‰5000å­—ç¬¦)';
                    }
                    
                    // æ˜¾ç¤ºé¢„è§ˆå¯¹è¯æ¡†
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                    
                    modal.innerHTML = `
                        <div style="background: white; border-radius: 12px; max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                            <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                                <h3 style="margin: 0; font-size: 1.25rem;">ğŸ“„ æ¨¡æ¿é¢„è§ˆ</h3>
                                <p style="margin: 0.5rem 0 0; color: #6b7280; font-size: 0.875rem;">æ–‡ä»¶: ${file.name}</p>
                            </div>
                            <div style="padding: 1.5rem; overflow-y: auto; flex: 1;">
                                <pre style="background: #f3f4f6; padding: 1rem; border-radius: 6px; overflow-x: auto; font-size: 0.875rem; margin: 0;">${previewContent}</pre>
                            </div>
                            <div style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.75rem; justify-content: flex-end;">
                                <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">å…³é—­</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // ç‚¹å‡»èƒŒæ™¯å…³é—­
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                    
                } catch (error) {
                    console.error('é¢„è§ˆå¤±è´¥:', error);
                    alert('âŒ é¢„è§ˆå¤±è´¥: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    };

    // æ¨¡æ¿åŒæ­¥
    window.syncTemplate = function() {
        
    };

    // å‰å¾€æ•°æ®ç®¡ç†
    window.goToDataManagement = function() {
        try {
            const section = document.querySelector('h2:contains("æ•°æ®å·¥åŠ")') ||
                          document.querySelector('[id*="data"]');
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                alert('æœªæ‰¾åˆ°æ•°æ®ç®¡ç†åŒºåŸŸ');
            }
        } catch (e) {
            console.error('å¯¼èˆªå¤±è´¥:', e);
        }
    };

    // è‡ªåŠ¨æ¸…ç†åŠŸèƒ½(ç”¨äºå­˜å‚¨ç©ºé—´ç®¡ç†)
    window.autoClean30Days = function() {
        if (!confirm('ç¡®è®¤è¦å¯¼å‡ºå¹¶æ¸…ç†30å¤©å‰çš„æ•°æ®å—?')) {
            return;
        }

        try {
            // å…ˆå¯¼å‡º
            window.exportAllData('json');

            // ç­‰å¾…ç”¨æˆ·ä¿å­˜
            setTimeout(() => {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - 30);

                let deletedCount = 0;
                const keysToDelete = [];

                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('tpi_data_')) {
                        const dateStr = key.replace('tpi_data_', '');
                        const dataDate = new Date(dateStr);

                        if (dataDate < cutoffDate) {
                            keysToDelete.push(key);
                        }
                    }
                }

                keysToDelete.forEach(key => {
                    localStorage.removeItem(key);
                    deletedCount++;
                });

                alert('âœ… å·²æ¸…ç† ' + deletedCount + ' æ¡æ—§æ•°æ®');
            }, 2000);
        } catch (e) {
            console.error('æ¸…ç†å¤±è´¥:', e);
            alert('æ¸…ç†å¤±è´¥: ' + e.message);
        }
    };

    // å¯¼å‡ºå¹¶é‡ç½®
    window.exportAndReset = function() {
        if (!confirm('âš ï¸ è­¦å‘Š: æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®!\n\nç¡®è®¤è¦å¯¼å‡ºå¹¶é‡ç½®å—?')) {
            return;
        }

        try {
            // å¯¼å‡º
            window.exportAllData('json');

            // ç­‰å¾…ç”¨æˆ·ä¿å­˜
            setTimeout(() => {
                if (confirm('æ•°æ®å·²å¯¼å‡º,ç¡®è®¤è¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®å—?')) {
                    localStorage.clear();
                    alert('âœ… ç³»ç»Ÿå·²é‡ç½®\n\né¡µé¢å°†åˆ·æ–°');
                    location.reload();
                }
            }, 2000);
        } catch (e) {
            console.error('é‡ç½®å¤±è´¥:', e);
            alert('é‡ç½®å¤±è´¥: ' + e.message);
        }
    };

    // æ‰‹åŠ¨é€‰æ‹©åˆ é™¤æ—¥æœŸ
    window.manualSelectDates = function() {
        try {
            // è·å–æ‰€æœ‰TPIæ•°æ®æ—¥æœŸ
            const allKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tpi_data_')) {
                    const date = key.replace('tpi_data_', '');
                    allKeys.push(date);
                }
            }
            
            if (allKeys.length === 0) {
                alert('ğŸ“­ å½“å‰æ²¡æœ‰å¯åˆ é™¤çš„æ•°æ®è®°å½•');
                return;
            }
            
            // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
            allKeys.sort((a, b) => b.localeCompare(a));
            
            // åˆ›å»ºé€‰æ‹©ç•Œé¢
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 1rem;';
            
            let checkboxesHTML = '';
            allKeys.forEach(date => {
                checkboxesHTML += `
                    <label style="display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: background 0.2s;">
                        <input type="checkbox" value="${date}" style="margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;">
                        <span style="flex: 1; font-size: 0.95rem;">${date}</span>
                        <span style="color: #6b7280; font-size: 0.85rem;">ğŸ“…</span>
                    </label>
                `;
            });
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 600px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                        <h3 style="margin: 0; font-size: 1.25rem;">ğŸ—‘ï¸ é€‰æ‹©è¦åˆ é™¤çš„æ—¥æœŸ</h3>
                        <p style="margin: 0.5rem 0 0; color: #6b7280; font-size: 0.875rem;">å…± ${allKeys.length} æ¡è®°å½•</p>
                    </div>
                    <div style="padding: 0; overflow-y: auto; flex: 1; max-height: 400px;">
                        ${checkboxesHTML}
                    </div>
                    <div style="padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.75rem; justify-content: space-between;">
                        <div>
                            <button onclick="document.querySelectorAll('[type=checkbox]').forEach(cb => cb.checked = true)" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">å…¨é€‰</button>
                            <button onclick="document.querySelectorAll('[type=checkbox]').forEach(cb => cb.checked = false)" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.875rem; margin-left: 0.5rem;">å–æ¶ˆ</button>
                        </div>
                        <div>
                            <button onclick="this.closest('[style*=fixed]').remove()" style="padding: 0.5rem 1rem; background: #9ca3af; color: white; border: none; border-radius: 6px; cursor: pointer;">å…³é—­</button>
                            <button id="confirmDeleteBtn" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 0.5rem;">åˆ é™¤é€‰ä¸­</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // åˆ é™¤æŒ‰é’®äº‹ä»¶
            document.getElementById('confirmDeleteBtn').onclick = function() {
                const checkedBoxes = modal.querySelectorAll('input[type="checkbox"]:checked');
                if (checkedBoxes.length === 0) {
                    alert('âš ï¸ è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ—¥æœŸ');
                    return;
                }
                
                if (!confirm(`âš ï¸ ç¡®è®¤åˆ é™¤ ${checkedBoxes.length} æ¡è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                    return;
                }
                
                let deletedCount = 0;
                checkedBoxes.forEach(checkbox => {
                    const date = checkbox.value;
                    const key = 'tpi_data_' + date;
                    localStorage.removeItem(key);
                    deletedCount++;
                });
                
                modal.remove();
                alert(`âœ… å·²åˆ é™¤ ${deletedCount} æ¡è®°å½•\n\né¡µé¢å°†åˆ·æ–°`);
                location.reload();
            };
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // æ‚¬åœæ•ˆæœ
            modal.querySelectorAll('label').forEach(label => {
                label.addEventListener('mouseenter', function() {
                    this.style.background = '#f3f4f6';
                });
                label.addEventListener('mouseleave', function() {
                    this.style.background = '';
                });
            });
            
        } catch (error) {
            console.error('æ‰‹åŠ¨é€‰æ‹©åˆ é™¤å¤±è´¥:', error);
            alert('âŒ æ“ä½œå¤±è´¥: ' + error.message);
        }
    };

})();
  </script>
  <script>
   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebaseäº‘ç«¯åŒæ­¥å¢å¼º(å¸¦é™çº§æ–¹æ¡ˆ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
    'use strict';

    // Firebaseäº‘ç«¯åŒæ­¥å¢å¼ºå·²ç§»é™¤
    // æ‰€æœ‰Firebaseç›¸å…³åŠŸèƒ½å·²åºŸå¼ƒ,è¯·ä½¿ç”¨GitHubäº‘ç«¯åŒæ­¥

})();
  </script>
  <script>
   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç§»åŠ¨ç«¯ä¸“ç”¨ä¿®å¤å’Œä¼˜åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
    'use strict';

    // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    if (isMobile) {

        // ç§»åŠ¨ç«¯ä¼˜åŒ–1: é˜»æ­¢åŒå‡»ç¼©æ”¾
        document.addEventListener('dblclick', function(e) {
            e.preventDefault();
        }, { passive: false });

        // ç§»åŠ¨ç«¯ä¼˜åŒ–2: ä¼˜åŒ–è§¦æ‘¸å“åº”
        document.addEventListener('touchstart', function() {}, { passive: true });

        // ç§»åŠ¨ç«¯ä¼˜åŒ–3: é˜²æ­¢é¡µé¢è¿‡åº¦æ»šåŠ¨
        document.body.addEventListener('touchmove', function(e) {
            if (e.target.closest('.modal-overlay, .scrollable-content')) {
                // å…è®¸æ¨¡æ€æ¡†å’Œå¯æ»šåŠ¨å†…å®¹æ»šåŠ¨
                return;
            }
        }, { passive: true });

        // ç§»åŠ¨ç«¯ä¼˜åŒ–4: æ·»åŠ ç§»åŠ¨ç«¯ä¸“ç”¨CSS
        const mobileStyle = document.createElement('style');
        mobileStyle.textContent = `
            @media (max-width: 768px) {
                /* ç¡®ä¿æŒ‰é’®è¶³å¤Ÿå¤§,æ˜“äºç‚¹å‡» */
                .btn, button {
                    min-height: 44px !important;
                    min-width: 44px !important;
                    padding: 12px 20px !important;
                    font-size: 16px !important;
                }

                /* è¾“å…¥æ¡†ä¼˜åŒ– */
                input, select, textarea {
                    font-size: 16px !important; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
                    padding: 12px !important;
                }

                /* å¡ç‰‡å†…è¾¹è·ä¼˜åŒ– */
                .card-content {
                    padding: 16px !important;
                }

                /* æ¨¡æ€æ¡†ä¼˜åŒ– */
                .modal-content {
                    margin: 20px !important;
                    max-width: calc(100% - 40px) !important;
                }

                /* é˜²æ­¢å†…å®¹æº¢å‡º */
                body {
                    overflow-x: hidden !important;
                }

                /* è¡¨æ ¼æ¨ªå‘æ»šåŠ¨ */
                table {
                    display: block;
                    overflow-x: auto;
                    white-space: nowrap;
                }
            }
        `;
        document.head.appendChild(mobileStyle);

        // ç§»åŠ¨ç«¯ä¼˜åŒ–5: æ¨ªå±æç¤ºï¼ˆç¬¬6æ‰¹æ¬¡ä¼˜åŒ–ï¼šç¼©çŸ­æ—¶é—´+ä¸å†æç¤ºé€‰é¡¹ï¼‰
        function checkOrientation() {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é€‰æ‹©äº†"ä¸å†æç¤º"
            const noMoreHint = localStorage.getItem('tpi_no_landscape_hint');
            if (noMoreHint === 'true') {
                console.log('âœ… [æ¨ªå±æç¤º] ç”¨æˆ·å·²é€‰æ‹©ä¸å†æç¤º');
                return;
            }
            
            if (window.innerWidth < 768 && window.innerHeight > window.innerWidth) {
                // ç«–å±æ¨¡å¼,æ˜¾ç¤ºæç¤º
                const tip = document.getElementById('orientation-tip');
                if (!tip) {
                    const orientationTip = document.createElement('div');
                    orientationTip.id = 'orientation-tip';
                    orientationTip.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: rgba(37, 99, 235, 0.95);
                        color: white;
                        padding: 16px 20px;
                        border-radius: 12px;
                        font-size: 14px;
                        z-index: 9999;
                        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                        max-width: 90%;
                        backdrop-filter: blur(10px);
                        animation: slideUpNotification 0.3s ease;
                    `;
                    orientationTip.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                                <span style="font-weight: 500;">ğŸ“± æç¤ºï¼šæ¨ªå±ä½¿ç”¨æ›´ä½³</span>
                                <button onclick="closeLandscapeTip()" style="
                                    background: rgba(255,255,255,0.2);
                                    border: none;
                                    color: white;
                                    padding: 6px 14px;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 13px;
                                    font-weight: 500;
                                    white-space: nowrap;
                                ">çŸ¥é“äº†</button>
                            </div>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; user-select: none;">
                                <input type="checkbox" id="noMoreLandscapeHint" style="cursor: pointer; width: 16px; height: 16px;">
                                <span>ä¸å†æç¤º</span>
                            </label>
                        </div>
                    `;
                    document.body.appendChild(orientationTip);

                    // 3ç§’åè‡ªåŠ¨éšè—ï¼ˆä»5ç§’ç¼©çŸ­åˆ°3ç§’ï¼‰
                    setTimeout(() => {
                        if (orientationTip.parentElement) {
                            orientationTip.style.transition = 'opacity 0.3s';
                            orientationTip.style.opacity = '0';
                            setTimeout(() => {
                                if (orientationTip.parentElement) {
                                    orientationTip.remove();
                                }
                            }, 300);
                        }
                    }, 3000);
                }
            }
        }
        
        // å…³é—­æ¨ªå±æç¤º
        window.closeLandscapeTip = function() {
            const tip = document.getElementById('orientation-tip');
            const checkbox = document.getElementById('noMoreLandscapeHint');
            
            if (tip) {
                tip.style.transition = 'opacity 0.3s';
                tip.style.opacity = '0';
                setTimeout(() => {
                    if (tip.parentElement) {
                        tip.remove();
                    }
                }, 300);
            }
            
            // å¦‚æœç”¨æˆ·å‹¾é€‰äº†"ä¸å†æç¤º"ï¼Œä¿å­˜åˆ°localStorage
            if (checkbox && checkbox.checked) {
                localStorage.setItem('tpi_no_landscape_hint', 'true');
                console.log('âœ… [æ¨ªå±æç¤º] å·²ä¿å­˜"ä¸å†æç¤º"é€‰é¡¹');
            }
        };

        // ç›‘å¬æ–¹å‘æ”¹å˜
        window.addEventListener('orientationchange', () => {
            console.log('ğŸ“± [æ¨ªå±æç¤º] å±å¹•æ–¹å‘æ”¹å˜');
            setTimeout(checkOrientation, 100);
        });
        
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(checkOrientation, 300);
        });
        
        setTimeout(checkOrientation, 2000); // å»¶è¿Ÿæ£€æŸ¥,é¿å…æ‰“æ‰°ç”¨æˆ·

    }

    // ç§»åŠ¨ç«¯ä¸“ç”¨é”™è¯¯æ£€æµ‹å·²ç¦ç”¨ï¼Œé˜²æ­¢è¯¯åˆ¤

})();
  </script>
  <script>
   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¡¥å……ç¼ºå¤±çš„Completeå‡½æ•°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
    'use strict';

    // 1. ä»äº‘ç«¯åŠ è½½å‡½æ•° - å·²åœ¨å‰é¢å®šä¹‰(ç¬¬2549è¡Œ),æ­¤å¤„åˆ é™¤é‡å¤å®šä¹‰

    // 2. ä»…å­˜æœ¬åœ°å‡½æ•°
    window.saveLocalOnlyComplete = function() {
        console.log('ğŸ’¾ [saveLocalOnlyComplete] ä»…å­˜æœ¬åœ°åŠŸèƒ½è¢«è°ƒç”¨');
        console.log('ğŸ’¾ [saveLocalOnlyComplete] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        try {
            // è·å–å½“å‰æ—¥æœŸ
            const dateInput = document.getElementById('date-input');
            const dateStr = dateInput ? dateInput.value : new Date().toISOString().split('T')[0];
            console.log('ğŸ“… [saveLocalOnlyComplete] å½“å‰æ—¥æœŸ:', dateStr);

            // å°è¯•æ”¶é›†è¡¨å•æ•°æ®
            let formData = null;

            // æ–¹æ³•1: ä½¿ç”¨window.collectFormData
            if (window.collectFormData && typeof window.collectFormData === 'function') {
                console.log('ğŸ”§ [saveLocalOnlyComplete] ä½¿ç”¨window.collectFormDataæ”¶é›†æ•°æ®');
                formData = window.collectFormData();
            }

            // æ–¹æ³•2: ä½¿ç”¨TPI.saveData
            if (!formData && window.TPI && typeof window.TPI.saveData === 'function') {
                console.log('ğŸ”§ [saveLocalOnlyComplete] ä½¿ç”¨TPI.saveDataä¿å­˜');
                try {
                    window.TPI.saveData();
                    console.log('âœ… [saveLocalOnlyComplete] TPI.saveDataè°ƒç”¨æˆåŠŸ');
                    alert('âœ… æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ï¼\n\næ—¥æœŸ: ' + dateStr + '\næ³¨æ„: ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼ŒæœªåŒæ­¥åˆ°äº‘ç«¯');
                    return;
                } catch (saveError) {
                    console.error('âŒ [saveLocalOnlyComplete] TPI.saveDataå¤±è´¥:', saveError);
                    // ç»§ç»­å°è¯•æ–¹æ³•3
                }
            }

            // æ–¹æ³•3: æ‰‹åŠ¨æ”¶é›†è¡¨å•æ•°æ®
            if (!formData) {
                console.log('ğŸ”§ [saveLocalOnlyComplete] ä½¿ç”¨æ‰‹åŠ¨æ–¹å¼æ”¶é›†è¡¨å•æ•°æ®');
                formData = {};
                // æ”¶é›†æ‰€æœ‰è¾“å…¥æ¡†çš„å€¼
                const inputs = document.querySelectorAll('input[type="number"], input[type="text"], textarea, select');
                console.log('ğŸ“Š [saveLocalOnlyComplete] æ‰¾åˆ°', inputs.length, 'ä¸ªè¾“å…¥å…ƒç´ ');
                
                inputs.forEach(input => {
                    if (input.id) {
                        if (input.type === 'checkbox') {
                            formData[input.id] = input.checked;
                        } else {
                            formData[input.id] = input.value;
                        }
                    }
                });
                
                console.log('ğŸ“Š [saveLocalOnlyComplete] æ”¶é›†åˆ°çš„æ•°æ®å­—æ®µæ•°:', Object.keys(formData).length);
            }

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const key = 'tpi_data_' + dateStr;
            const dataStr = JSON.stringify(formData);
            console.log('ğŸ’¾ [saveLocalOnlyComplete] å‡†å¤‡ä¿å­˜ï¼Œkey:', key);
            console.log('ğŸ’¾ [saveLocalOnlyComplete] æ•°æ®å¤§å°:', Math.round(dataStr.length / 1024), 'KB');
            
            localStorage.setItem(key, dataStr);
            console.log('âœ… [saveLocalOnlyComplete] æ•°æ®å·²ä¿å­˜åˆ°localStorage');

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('âœ… æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°ï¼\n\næ—¥æœŸ: ' + dateStr + '\nkey: ' + key + '\næ³¨æ„: ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼ŒæœªåŒæ­¥åˆ°äº‘ç«¯');

        } catch (error) {
            console.error('âŒ [saveLocalOnlyComplete] ä¿å­˜æœ¬åœ°å¤±è´¥:', error);
            console.error('âŒ [saveLocalOnlyComplete] é”™è¯¯åç§°:', error.name);
            console.error('âŒ [saveLocalOnlyComplete] é”™è¯¯æ¶ˆæ¯:', error.message);
            console.error('âŒ [saveLocalOnlyComplete] é”™è¯¯å †æ ˆ:', error.stack);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å­˜å‚¨é…é¢é”™è¯¯
            if (error.name === 'QuotaExceededError') {
                alert('âŒ å­˜å‚¨ç©ºé—´ä¸è¶³\n\næœ¬åœ°å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œè¯·ï¼š\n1. å¯¼å‡ºç°æœ‰æ•°æ®è¿›è¡Œå¤‡ä»½\n2. æ¸…ç†æ—§æ•°æ®\n3. ç„¶åé‡è¯•');
            } else {
                alert('âŒ ä¿å­˜å¤±è´¥\n\né”™è¯¯: ' + error.message + '\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯');
            }
        }
    };

    // undoActionComplete å‡½æ•°å·²åœ¨æ—©æœŸåˆå§‹åŒ–è„šæœ¬ä¸­å®šä¹‰ï¼ˆç¬¬4228è¡Œï¼‰ï¼Œæ­¤å¤„ä¸å†é‡å¤å®šä¹‰

    // redoActionComplete å‡½æ•°å·²åœ¨æ—©æœŸåˆå§‹åŒ–è„šæœ¬ä¸­å®šä¹‰ï¼ˆç¬¬4260è¡Œï¼‰ï¼Œæ­¤å¤„ä¸å†é‡å¤å®šä¹‰

    // 5. å½’æ¡£æ—§æ•°æ®å‡½æ•°
    window.archiveOldDataComplete = function() {
        try {
            // è¯¢é—®ç”¨æˆ·è¦å½’æ¡£å¤šå°‘å¤©å‰çš„æ•°æ®
            const daysInput = prompt('ğŸ—ƒï¸ å½’æ¡£æ—§æ•°æ®\n\nè¯·è¾“å…¥è¦å½’æ¡£å¤šå°‘å¤©å‰çš„æ•°æ®ï¼ˆä¾‹å¦‚: 90ï¼‰\n\nå½’æ¡£çš„æ•°æ®å°†è¢«å‹ç¼©å­˜å‚¨ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´å ç”¨', '90');

            if (!daysInput) {
                return; // ç”¨æˆ·å–æ¶ˆ
            }

            const days = parseInt(daysInput);
            if (isNaN(days) || days < 1) {
                alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„å¤©æ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰');
                return;
            }

            // ç¡®è®¤æ“ä½œ
            if (!confirm(`âš ï¸ ç¡®è®¤è¦å½’æ¡£ ${days} å¤©å‰çš„æ•°æ®å—ï¼Ÿ\n\nå½’æ¡£åçš„æ•°æ®å°†è¢«å‹ç¼©ï¼Œä½†ä»å¯æŸ¥çœ‹å’Œæ¢å¤ã€‚`)) {
                return;
            }

            // è®¡ç®—å½’æ¡£æ—¥æœŸ
            const archiveDate = new Date();
            archiveDate.setDate(archiveDate.getDate() - days);
            const archiveDateStr = archiveDate.toISOString().split('T')[0];

            // éå†localStorageï¼Œæ‰¾åˆ°æ—§æ•°æ®
            let archivedCount = 0;
            const keysToArchive = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tpi_data_')) {
                    const dateStr = key.replace('tpi_data_', '');
                    if (dateStr < archiveDateStr) {
                        keysToArchive.push(key);
                    }
                }
            }

            if (keysToArchive.length === 0) {
                alert('â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°éœ€è¦å½’æ¡£çš„æ•°æ®\n\næ‰€æœ‰æ•°æ®éƒ½åœ¨ ' + days + ' å¤©ä¹‹å†…');
                return;
            }

            // åˆ›å»ºå½’æ¡£
            const archiveData = {};
            keysToArchive.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    archiveData[key] = JSON.parse(data);
                    archivedCount++;
                }
            });

            // ä¿å­˜å½’æ¡£
            const archiveKey = 'tpi_archive_' + new Date().toISOString().split('T')[0];
            localStorage.setItem(archiveKey, JSON.stringify(archiveData));

            // è¯¢é—®æ˜¯å¦åˆ é™¤åŸæ•°æ®
            if (confirm(`âœ… å·²å½’æ¡£ ${archivedCount} æ¡è®°å½•

æ˜¯å¦è¦åˆ é™¤åŸå§‹æ•°æ®ä»¥èŠ‚çœç©ºé—´ï¼Ÿ

ï¼ˆå½’æ¡£æ•°æ®å·²ä¿å­˜ï¼Œå¯éšæ—¶æ¢å¤ï¼‰`)) {
                keysToArchive.forEach(key => {
                    localStorage.removeItem(key);
                });
                alert(`âœ… å½’æ¡£å®Œæˆï¼

å·²å½’æ¡£: ${archivedCount} æ¡
å·²åˆ é™¤åŸå§‹æ•°æ®
å½’æ¡£ä½ç½®: ${archiveKey}`);
            } else {
                alert(`âœ… å½’æ¡£å®Œæˆï¼

å·²å½’æ¡£: ${archivedCount} æ¡
ä¿ç•™åŸå§‹æ•°æ®
å½’æ¡£ä½ç½®: ${archiveKey}`);
            }

        } catch (error) {
            console.error('å½’æ¡£å¤±è´¥:', error);
            alert('âŒ å½’æ¡£å¤±è´¥: ' + error.message);
        }
    };

    // 6. å…¶ä»–è¾…åŠ©å‡½æ•°
    window.checkDataHealthComplete = function() {
        try {
            let totalKeys = 0;
            let tpiDataKeys = 0;
            let totalSize = 0;
            const issues = [];

            // æ£€æŸ¥æ‰€æœ‰localStorageæ•°æ®
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key) {
                    totalKeys++;
                    const value = localStorage.getItem(key);
                    if (value) {
                        totalSize += value.length;

                        if (key.startsWith('tpi_data_')) {
                            tpiDataKeys++;

                            // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                            try {
                                const data = JSON.parse(value);
                                if (!data.date) {
                                    issues.push(`${key}: ç¼ºå°‘æ—¥æœŸå­—æ®µ`);
                                }
                            } catch (e) {
                                issues.push(`${key}: æ•°æ®æ ¼å¼é”™è¯¯`);
                            }
                        }
                    }
                }
            }

            // è®¡ç®—å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡
            const maxSize = 5 * 1024 * 1024; // 5MB (ä¼°è®¡å€¼)
            const usagePercent = ((totalSize / maxSize) * 100).toFixed(2);

            // ç”ŸæˆæŠ¥å‘Š
            let report = 'ğŸ’Š æ•°æ®å¥åº·æ£€æŸ¥æŠ¥å‘Š\n\n';
            report += `ğŸ“Š å­˜å‚¨ç»Ÿè®¡:\n`;
            report += `â€¢ æ€»é”®æ•°: ${totalKeys}\n`;
            report += `â€¢ TPIæ•°æ®æ¡æ•°: ${tpiDataKeys}\n`;
            report += `â€¢ å­˜å‚¨ç©ºé—´: ${(totalSize / 1024).toFixed(2)} KB\n`;
            report += `â€¢ ä½¿ç”¨ç‡: ${usagePercent}%\n\n`;

            if (issues.length > 0) {
                report += `âš ï¸ å‘ç° ${issues.length} ä¸ªé—®é¢˜:\n`;
                issues.slice(0, 5).forEach(issue => {
                    report += `â€¢ ${issue}\n`;
                });
                if (issues.length > 5) {
                    report += `â€¢ ... è¿˜æœ‰ ${issues.length - 5} ä¸ªé—®é¢˜\n`;
                }
            } else {
                report += `âœ… æ‰€æœ‰æ•°æ®å®Œæ•´æ€§è‰¯å¥½`;
            }

            alert(report);

        } catch (error) {
            console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
            alert('âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ' + error.message);
        }
    };

    window.openBackupManagerComplete = function() {
        try {
            // åˆ›å»ºå¤‡ä»½ç®¡ç†å™¨å¯¹è¯æ¡†
            const backupList = [];
            const backupKeys = [];

            // ä» localStorage è·å–æ‰€æœ‰å¤‡ä»½
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tpi_backup_')) {
                    backupKeys.push(key);
                }
            }

            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            backupKeys.sort().reverse();

            // åˆ›å»ºå¤‡ä»½åˆ—è¡¨HTML
            let backupListHtml = '';
            if (backupKeys.length === 0) {
                backupListHtml = '<p style="text-align: center; color: #6b7280; padding: 20px;">æš‚æ— å¤‡ä»½è®°å½•</p>';
            } else {
                backupListHtml = '<div style="max-height: 300px; overflow-y: auto;">';
                backupKeys.forEach((key, index) => {
                    try {
                        const backupData = JSON.parse(localStorage.getItem(key));
                        const backupTime = key.replace('tpi_backup_', '').replace(/_/g, ' ');
                        const dataSize = new Blob([localStorage.getItem(key)]).size;
                        const sizeKB = (dataSize / 1024).toFixed(2);

                        backupListHtml += `
                            <div style="padding: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>å¤‡ä»½ #${backupKeys.length - index}</strong>
                                        <br>
                                        <small style="color: #6b7280;">æ—¶é—´: ${backupTime}</small>
                                        <br>
                                        <small style="color: #6b7280;">å¤§å°: ${sizeKB} KB</small>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-sm btn-primary" onclick="restoreBackup('${key}'); document.getElementById('backup-manager-modal').remove();" style="font-size: 12px; padding: 4px 8px;">ğŸ“¥ æ¢å¤</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteBackup('${key}'); window.openBackupManagerComplete();" style="font-size: 12px; padding: 4px 8px;">ğŸ—‘ï¸ åˆ é™¤</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        console.error('è¯»å–å¤‡ä»½å¤±è´¥:', e);
                    }
                });
                backupListHtml += '</div>';
            }

            // åˆ›å»ºæ¨¡æ€æ¡†
            const modalHtml = `
                <div id="backup-manager-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h3 style="margin-bottom: 20px; color: #111827;">ğŸ’¾ å¤‡ä»½ç®¡ç†å™¨</h3>

                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="createNewBackup(); window.openBackupManagerComplete();" style="width: 100%;">
                                â• åˆ›å»ºæ–°å¤‡ä»½
                            </button>
                        </div>

                        <h4 style="margin-bottom: 12px; font-size: 16px; color: #374151;">å¤‡ä»½å†å²</h4>
                        ${backupListHtml}

                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                            <button class="btn btn-secondary" onclick="document.getElementById('backup-manager-modal').remove();" style="width: 100%;">å…³é—­</button>
                        </div>
                    </div>
                </div>
            `;

            // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const oldModal = document.getElementById('backup-manager-modal');
            if (oldModal) oldModal.remove();

            // æ·»åŠ æ–°æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.innerHTML = modalHtml;
            document.body.appendChild(modal.firstElementChild);

        } catch (error) {
            console.error('æ‰“å¼€å¤‡ä»½ç®¡ç†å™¨å¤±è´¥:', error);
            alert('âŒ æ‰“å¼€å¤‡ä»½ç®¡ç†å™¨å¤±è´¥: ' + error.message);
        }
    };

    // åˆ›å»ºæ–°å¤‡ä»½
    window.createNewBackup = function() {
        try {
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const backupKey = `tpi_backup_${timestamp}`;

            // æ”¶é›†æ‰€æœ‰æ•°æ®
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.startsWith('tpi_data_') || key.startsWith('tpi_'))) {
                    allData[key] = localStorage.getItem(key);
                }
            }

            // ä¿å­˜å¤‡ä»½
            localStorage.setItem(backupKey, JSON.stringify(allData));

            alert(`âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸï¼\n\nå¤‡ä»½æ—¶é—´: ${now.toLocaleString('zh-CN')}\næ•°æ®é¡¹: ${Object.keys(allData).length} æ¡`);
        } catch (error) {
            console.error('åˆ›å»ºå¤‡ä»½å¤±è´¥:', error);
            alert('âŒ åˆ›å»ºå¤‡ä»½å¤±è´¥: ' + error.message);
        }
    };

    // æ¢å¤å¤‡ä»½
    window.restoreBackup = function(backupKey) {
        try {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¢å¤æ­¤å¤‡ä»½å—ï¼Ÿ\n\nå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼')) {
                return;
            }

            const backupData = JSON.parse(localStorage.getItem(backupKey));
            if (!backupData) {
                alert('âŒ å¤‡ä»½æ•°æ®ä¸å­˜åœ¨');
                return;
            }

            // æ¢å¤æ•°æ®
            Object.keys(backupData).forEach(key => {
                localStorage.setItem(key, backupData[key]);
            });

            alert('âœ… å¤‡ä»½æ¢å¤æˆåŠŸï¼\n\né¡µé¢å°†è‡ªåŠ¨åˆ·æ–°...');
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            console.error('æ¢å¤å¤‡ä»½å¤±è´¥:', error);
            alert('âŒ æ¢å¤å¤‡ä»½å¤±è´¥: ' + error.message);
        }
    };

    // åˆ é™¤å¤‡ä»½
    window.deleteBackup = function(backupKey) {
        try {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å¤‡ä»½å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }

            localStorage.removeItem(backupKey);
            alert('âœ… å¤‡ä»½å·²åˆ é™¤');
        } catch (error) {
            console.error('åˆ é™¤å¤‡ä»½å¤±è´¥:', error);
            alert('âŒ åˆ é™¤å¤‡ä»½å¤±è´¥: ' + error.message);
        }
    };

    window.toggleDarkThemeComplete = function() {
        try {
            const body = document.body;
            body.classList.toggle('dark-theme');

            const isDark = body.classList.contains('dark-theme');
            localStorage.setItem('tpi_theme', isDark ? 'dark' : 'light');

            alert(isDark ? 'ğŸŒ™ å·²åˆ‡æ¢åˆ°æš—é»‘æ¨¡å¼' : 'â˜€ï¸ å·²åˆ‡æ¢åˆ°æ˜äº®æ¨¡å¼');
        } catch (error) {
            console.error('ä¸»é¢˜åˆ‡æ¢å¤±è´¥:', error);
            alert('âŒ ä¸»é¢˜åˆ‡æ¢å¤±è´¥: ' + error.message);
        }
    };

    window.restoreDarkThemeComplete = function() {
        try {
            document.body.classList.remove('dark-theme');
            localStorage.removeItem('tpi_theme');
            alert('âœ… å·²æ¢å¤é»˜è®¤ä¸»é¢˜');
        } catch (error) {
            console.error('æ¢å¤ä¸»é¢˜å¤±è´¥:', error);
            alert('âŒ æ¢å¤å¤±è´¥: ' + error.message);
        }
    };

    // 6. æ˜¾ç¤ºæ“ä½œå†å²å‡½æ•°
    window.showOperationHistoryComplete = function() {
        try {
            const recentHistory = (window.OperationHistory && window.OperationHistory.getRecent) ? 
                window.OperationHistory.getRecent(50) : [];
            
                let historyHtml = '';
                if (recentHistory.length === 0) {
                    historyHtml = '<p style="text-align: center; color: #6b7280; padding: 20px;">æš‚æ— æ“ä½œå†å²</p>';
                } else {
                    historyHtml = '<div style="max-height: 400px; overflow-y: auto;">';
                    recentHistory.forEach((record, index) => {
                        const date = new Date(record.timestamp);
                        const timeStr = date.toLocaleString('zh-CN');

                        let actionIcon = 'ğŸ“';
                        if (record.action === 'create') actionIcon = 'â•';
                        if (record.action === 'update') actionIcon = 'âœï¸';
                        if (record.action === 'delete') actionIcon = 'ğŸ—‘ï¸';
                        if (record.action === 'import') actionIcon = 'ğŸ“¥';
                        if (record.action === 'export') actionIcon = 'ğŸ“¤';
                        if (record.action === 'sync') actionIcon = 'ğŸ”„';
                        if (record.action === 'save') actionIcon = 'ğŸ’¾';

                        historyHtml += `
                            <div style="padding: 12px; margin-bottom: 8px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 4px;">
                                            <span style="font-size: 18px;">${actionIcon}</span>
                                            ${record.action} - ${record.target}
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280;">${timeStr}</div>
                                        ${record.details && Object.keys(record.details).length > 0 ? `
                                            <div style="margin-top: 8px; font-size: 12px; color: #374151;">
                                                ${Object.entries(record.details).map(([k, v]) => `<div><strong>${k}:</strong> ${v}</div>`).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <span style="background: #e5e7eb; padding: 2px 8px; border-radius: 12px; font-size: 11px; color: #6b7280;">#${index + 1}</span>
                                </div>
                            </div>
                        `;
                    });
                    historyHtml += '</div>';
                }

                const modalHtml = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                            <h3 style="margin-bottom: 20px; color: #111827;">ğŸ“œ æ“ä½œå†å²è®°å½•</h3>
                            ${historyHtml}
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px;">
                                <button class="btn btn-danger btn-sm" onclick="if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ“ä½œå†å²å—ï¼Ÿ')) { window.OperationHistory.clear(); this.closest('[style*=fixed]').remove(); alert('âœ… å†å²è®°å½•å·²æ¸…ç©º'); }" style="font-size: 12px;">ğŸ—‘ï¸ æ¸…ç©ºå†å²</button>
                                <button class="btn btn-secondary" onclick="this.closest('[style*=fixed]').remove()" style="flex: 1;">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                `;

                const modal = document.createElement('div');
                modal.innerHTML = modalHtml;
                document.body.appendChild(modal.firstElementChild);
            }
        } catch (error) {
            console.error('æ˜¾ç¤ºæ“ä½œå†å²å¤±è´¥:', error);
            alert('âŒ æ˜¾ç¤ºæ“ä½œå†å²å¤±è´¥: ' + error.message + '\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°äº†è§£è¯¦æƒ…');
        }
    };

    // 7. åˆ›å»ºValidationRulesManagerå¯¹è±¡
    window.ValidationRulesManager = {
        rules: [],

        // åˆå§‹åŒ–é»˜è®¤è§„åˆ™
        init: function() {
            const defaultRules = [
                { id: 'rule1', name: 'æ¯æ—¥æ•°æ®å®Œæ•´æ€§', enabled: true, description: 'ç¡®ä¿æ¯æ—¥æ•°æ®åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ' },
                { id: 'rule2', name: 'æ•°å€¼èŒƒå›´æ£€æŸ¥', enabled: true, description: 'æ£€æŸ¥è¾“å…¥æ•°å€¼æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…' },
                { id: 'rule3', name: 'æ—¥æœŸæ ¼å¼éªŒè¯', enabled: true, description: 'éªŒè¯æ—¥æœŸæ ¼å¼æ˜¯å¦æ­£ç¡®' },
                { id: 'rule4', name: 'é‡å¤æ•°æ®æ£€æµ‹', enabled: true, description: 'æ£€æµ‹æ˜¯å¦å­˜åœ¨é‡å¤çš„æ•°æ®æ¡ç›®' }
            ];

            const savedRules = localStorage.getItem('tpi_validation_rules');
            if (savedRules) {
                try {
                    this.rules = JSON.parse(savedRules);
                } catch (e) {
                    this.rules = defaultRules;
                }
            } else {
                this.rules = defaultRules;
            }
        },

        // æ˜¾ç¤ºè§„åˆ™å¯¹è¯æ¡†
        showRulesDialog: function() {
            if (this.rules.length === 0) {
                this.init();
            }

            let rulesHtml = '<div style="max-height: 500px; overflow-y: auto;">';
            rulesHtml += '<p style="color: #6b7280; margin-bottom: 15px;">ä»¥ä¸‹æ˜¯ç³»ç»Ÿçš„éªŒè¯è§„åˆ™ã€‚éªŒè¯è§„åˆ™ç”¨äºç¡®ä¿æ•°æ®è¾“å…¥çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚</p>';
            rulesHtml += '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f3f4f6;"><th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">è§„åˆ™åç§°</th><th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">è¯´æ˜</th><th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb;">çŠ¶æ€</th></tr></thead><tbody>';

            this.rules.forEach((rule, index) => {
                const bgColor = index % 2 === 0 ? '#ffffff' : '#f9fafb';
                rulesHtml += `<tr style="background: ${bgColor};">
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;"><strong>${rule.name}</strong></td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; color: #6b7280;">${rule.description}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: center;">${rule.enabled ? '<span style="color: #10b981;">âœ… å·²å¯ç”¨</span>' : '<span style="color: #6b7280;">âŒ å·²ç¦ç”¨</span>'}</td>
                </tr>`;
            });

            rulesHtml += '</tbody></table>';

            // æ·»åŠ å¸¸ç”¨è¾“å…¥éªŒè¯è§„åˆ™è¯´æ˜
            rulesHtml += `
                <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
                    <h6 style="margin: 0 0 10px 0; color: #1e40af;">ğŸ’¡ å½“å‰éªŒè¯è§„åˆ™è¯´æ˜</h6>
                    <ul style="margin: 0; padding-left: 20px; color: #374151; font-size: 13px; line-height: 1.8;">
                        <li><strong>TPIæ€»åˆ†:</strong> 0-100ï¼Œæ­¥é•¿0.1</li>
                        <li><strong>æ—¶é•¿:</strong> 0-24å°æ—¶ï¼Œæ­¥é•¿0.5</li>
                        <li><strong>é¡µæ•°:</strong> 0-10000ï¼Œæ•´æ•°</li>
                        <li><strong>å­—æ•°:</strong> 0-100000ï¼Œæ­¥é•¿100</li>
                        <li><strong>åˆ†å€¼:</strong> 0-100ï¼Œæ­¥é•¿0.5</li>
                    </ul>
                </div>

                <div style="margin-top: 15px; padding: 12px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
                    <p style="margin: 0; color: #92400e; font-size: 13px;">
                        <strong>âš ï¸ æ³¨æ„ï¼š</strong>éªŒè¯è§„åˆ™ä¼šåœ¨è¾“å…¥æ—¶è‡ªåŠ¨æ£€æŸ¥æ•°å€¼èŒƒå›´ï¼Œè¶…å‡ºèŒƒå›´çš„å€¼ä¼šè¢«è‡ªåŠ¨è°ƒæ•´ã€‚
                    </p>
                </div>
            `;

            rulesHtml += '</div>';

            const modalHtml = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 800px; width: 90%; max-height: 85vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h3 style="margin: 0 0 20px 0; color: #111827; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 28px;">ğŸ›¡ï¸</span>
                            <span>éªŒè¯è§„åˆ™ç®¡ç†</span>
                        </h3>
                        ${rulesHtml}
                        <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="this.closest('[style*=fixed]').remove()" style="padding: 8px 20px;">å…³é—­</button>
                        </div>
                    </div>
                </div>
            `;

            const modal = document.createElement('div');
            modal.innerHTML = modalHtml;
            document.body.appendChild(modal.firstElementChild);
        },

        // ä¿å­˜è§„åˆ™
        saveRules: function() {
            localStorage.setItem('tpi_validation_rules', JSON.stringify(this.rules));
        },

        // åˆ‡æ¢è§„åˆ™çŠ¶æ€
        toggleRule: function(ruleId) {
            const rule = this.rules.find(r => r.id === ruleId);
            if (rule) {
                rule.enabled = !rule.enabled;
                this.saveRules();
            }
        }
    };

    // åˆå§‹åŒ–ValidationRulesManager
    window.ValidationRulesManager.init();

    // 8. åˆ›å»ºTemplateSyncManagerå¯¹è±¡
    window.TemplateSyncManager = {
        selectedFile: null,
        textInput: '',
        previewData: null,

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        handleFileSelected: function() {
            const fileInput = document.getElementById('template-file-input');
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                this.selectedFile = fileInput.files[0];
            }
        },

        // å¤„ç†æ–‡æœ¬è¾“å…¥å˜åŒ–
        handleTextChanged: function() {
            const textArea = document.getElementById('template-text-input');
            if (textArea) {
                this.textInput = textArea.value;
            }
        },

        // é¢„è§ˆå˜æ›´
        previewChanges: function() {
            try {
                const previewDiv = document.getElementById('changes-preview');
                if (!previewDiv) {
                    alert('âš ï¸ é¢„è§ˆåŒºåŸŸæœªæ‰¾åˆ°');
                    return;
                }

                // è·å–å½“å‰æ¨¡æ¿å†…å®¹
                const currentTemplate = this.getCurrentTemplate();
                if (!currentTemplate) {
                    alert('âš ï¸ å½“å‰æ²¡æœ‰å¯é¢„è§ˆçš„æ¨¡æ¿å†…å®¹\n\nè¯·å…ˆé€‰æ‹©æ–‡ä»¶æˆ–è¾“å…¥æ–‡æœ¬');
                    return;
                }

                // æ˜¾ç¤ºé¢„è§ˆ
                previewDiv.style.display = 'block';
                const previewContent = document.getElementById('preview-content');
                if (previewContent) {
                    previewContent.innerHTML = `
                        <div class="alert alert-info">
                            <h5>ğŸ“‹ æ¨¡æ¿é¢„è§ˆ</h5>
                            <p><strong>æ¨¡æ¿ç±»å‹:</strong> ${this.selectedFile ? 'æ–‡ä»¶æ¨¡æ¿' : 'æ–‡æœ¬æ¨¡æ¿'}</p>
                            <p><strong>å†…å®¹é•¿åº¦:</strong> ${currentTemplate.length} å­—ç¬¦</p>
                            <p><strong>é¢„è®¡å½±å“:</strong> å°†æ›´æ–°å½“å‰é¡µé¢çš„æ¨¡æ¿å†…å®¹</p>
                        </div>
                        <div class="alert alert-warning">
                            <strong>âš ï¸ æ³¨æ„:</strong> åŒæ­¥åå°†è¦†ç›–ç°æœ‰æ¨¡æ¿ï¼Œå»ºè®®å…ˆå¤‡ä»½æ•°æ®
                        </div>
                    `;
                }

                this.previewData = currentTemplate;
                alert('âœ… é¢„è§ˆå·²ç”Ÿæˆ\n\nè¯·æŸ¥çœ‹ä¸‹æ–¹çš„é¢„è§ˆå†…å®¹ï¼Œç¡®è®¤æ— è¯¯åå†æ‰§è¡ŒåŒæ­¥');

            } catch (error) {
                console.error('é¢„è§ˆå¤±è´¥:', error);
                alert('âŒ é¢„è§ˆå¤±è´¥: ' + error.message);
            }
        },

        // ä»æ–‡ä»¶åŒæ­¥
        syncFromFile: function() {
            try {
                if (!this.selectedFile) {
                    alert('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿æ–‡ä»¶');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        this.performSync(content, 'æ–‡ä»¶: ' + this.selectedFile.name);
                    } catch (error) {
                        alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message);
                    }
                };
                reader.readAsText(this.selectedFile);

            } catch (error) {
                console.error('ä»æ–‡ä»¶åŒæ­¥å¤±è´¥:', error);
                alert('âŒ åŒæ­¥å¤±è´¥: ' + error.message);
            }
        },

        // ä»æ–‡æœ¬åŒæ­¥
        syncFromText: function() {
            try {
                if (!this.textInput || this.textInput.trim() === '') {
                    alert('âš ï¸ è¯·å…ˆè¾“å…¥æ¨¡æ¿æ–‡æœ¬å†…å®¹');
                    return;
                }

                this.performSync(this.textInput, 'æ–‡æœ¬è¾“å…¥');

            } catch (error) {
                console.error('ä»æ–‡æœ¬åŒæ­¥å¤±è´¥:', error);
                alert('âŒ åŒæ­¥å¤±è´¥: ' + error.message);
            }
        },

        // æ‰§è¡ŒåŒæ­¥
        performSync: function(content, source) {
            try {
                if (!confirm(`âš ï¸ ç¡®è®¤è¦ä»"${source}"åŒæ­¥æ¨¡æ¿å—ï¼Ÿ\n\nè¿™å°†è¦†ç›–å½“å‰çš„æ¨¡æ¿å†…å®¹ã€‚`)) {
                    return;
                }

                // è¿™é‡Œåº”è¯¥å®ç°å®é™…çš„æ¨¡æ¿åŒæ­¥é€»è¾‘
                // ç”±äºä¸æ¸…æ¥šå…·ä½“çš„æ¨¡æ¿ç»“æ„ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªç¤ºä¾‹

                alert(`âœ… æ¨¡æ¿åŒæ­¥æˆåŠŸï¼\n\næ¥æº: ${source}\nå†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`);

                // æ¸…ç©ºé¢„è§ˆ
                const previewDiv = document.getElementById('changes-preview');
                if (previewDiv) {
                    previewDiv.style.display = 'none';
                }

            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥:', error);
                alert('âŒ åŒæ­¥å¤±è´¥: ' + error.message);
            }
        },

        // ç¡®è®¤å¹¶åŒæ­¥
        confirmAndSync: function() {
            if (this.previewData) {
                this.performSync(this.previewData, 'é¢„è§ˆå†…å®¹');
            } else {
                alert('âš ï¸ è¯·å…ˆé¢„è§ˆå˜æ›´');
            }
        },

        // æ¸…é™¤å†å²
        clearHistory: function() {
            if (confirm('âš ï¸ ç¡®è®¤è¦æ¸…é™¤æ‰€æœ‰åŒæ­¥å†å²å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                localStorage.removeItem('tpi_template_sync_history');
                alert('âœ… åŒæ­¥å†å²å·²æ¸…é™¤');
            }
        },

        // å¯¼å‡ºå†å²
        exportHistory: function() {
            try {
                const history = localStorage.getItem('tpi_template_sync_history');
                if (!history) {
                    alert('â„¹ï¸ æš‚æ— åŒæ­¥å†å²è®°å½•');
                    return;
                }

                const blob = new Blob([history], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `template_sync_history_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                alert('âœ… åŒæ­¥å†å²å·²å¯¼å‡º');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        },

        // åˆ·æ–°ç»Ÿè®¡
        refreshStats: function() {
            try {
                const stats = this.calculateStats();
                const statsDisplay = document.getElementById('sync-stats-display');

                if (statsDisplay) {
                    statsDisplay.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>ğŸ“Š åŒæ­¥ç»Ÿè®¡</h6>
                                        <p>æ€»åŒæ­¥æ¬¡æ•°: ${stats.totalSyncs}</p>
                                        <p>æˆåŠŸæ¬¡æ•°: ${stats.successCount}</p>
                                        <p>å¤±è´¥æ¬¡æ•°: ${stats.failCount}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6>ğŸ• æ—¶é—´ä¿¡æ¯</h6>
                                        <p>æœ€ååŒæ­¥: ${stats.lastSync || 'ä»æœªåŒæ­¥'}</p>
                                        <p>é¦–æ¬¡åŒæ­¥: ${stats.firstSync || 'ä»æœªåŒæ­¥'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                alert('âœ… ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°');
            } catch (error) {
                console.error('åˆ·æ–°ç»Ÿè®¡å¤±è´¥:', error);
                alert('âŒ åˆ·æ–°å¤±è´¥: ' + error.message);
            }
        },

        // å¯¼å‡ºç»Ÿè®¡
        exportStats: function() {
            try {
                const stats = this.calculateStats();
                const blob = new Blob([JSON.stringify(stats, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `template_sync_stats_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                alert('âœ… ç»Ÿè®¡æŠ¥å‘Šå·²å¯¼å‡º');
            } catch (error) {
                console.error('å¯¼å‡ºç»Ÿè®¡å¤±è´¥:', error);
                alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        },

        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        calculateStats: function() {
            const history = localStorage.getItem('tpi_template_sync_history');
            if (!history) {
                return {
                    totalSyncs: 0,
                    successCount: 0,
                    failCount: 0,
                    lastSync: null,
                    firstSync: null
                };
            }

            try {
                const data = JSON.parse(history);
                return {
                    totalSyncs: data.length || 0,
                    successCount: data.filter(item => item.success).length || 0,
                    failCount: data.filter(item => !item.success).length || 0,
                    lastSync: data.length > 0 ? data[data.length - 1].timestamp : null,
                    firstSync: data.length > 0 ? data[0].timestamp : null
                };
            } catch (e) {
                return {
                    totalSyncs: 0,
                    successCount: 0,
                    failCount: 0,
                    lastSync: null,
                    firstSync: null
                };
            }
        },

        // è·å–å½“å‰æ¨¡æ¿
        getCurrentTemplate: function() {
            if (this.selectedFile) {
                return '(æ–‡ä»¶å†…å®¹å°†åœ¨åŒæ­¥æ—¶è¯»å–)';
            } else if (this.textInput) {
                return this.textInput;
            }
            return null;
        }
    };

})();
  </script>
  <script>
   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å…¨å±€å‡½æ•°å®šä¹‰ - ç¡®ä¿åœ¨å…¨å±€ä½œç”¨åŸŸå¯ç”¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// å¤åˆ¶å‰ä¸€å¤©æ•°æ®
window.copyPreviousDayDataComplete = function() {
    console.log('ğŸ“‹ [copyPreviousDayDataComplete] å‡½æ•°è¢«è°ƒç”¨');
    try {
        const currentDateInput = document.getElementById('date-input');
        if (!currentDateInput || !currentDateInput.value) {
            alert('âš ï¸ è¯·å…ˆé€‰æ‹©å½“å‰æ—¥æœŸ\n\nåœ¨é¡µé¢é¡¶éƒ¨çš„æ—¥æœŸé€‰æ‹©å™¨ä¸­é€‰æ‹©æ—¥æœŸ');
            console.log('âš ï¸ [copyPreviousDayDataComplete] æœªé€‰æ‹©æ—¥æœŸ');
            return;
        }

        const currentDate = new Date(currentDateInput.value);
        const previousDate = new Date(currentDate);
        previousDate.setDate(previousDate.getDate() - 1);
        const prevDateStr = previousDate.toISOString().split('T')[0];

        console.log('ğŸ“‹ [copyPreviousDayDataComplete] å°è¯•å¤åˆ¶:', prevDateStr, 'â†’', currentDateInput.value);

        // è·å–å‰ä¸€å¤©çš„æ•°æ®
        const prevDataStr = localStorage.getItem('tpi_data_' + prevDateStr);

        if (!prevDataStr) {
            alert('âš ï¸ æœªæ‰¾åˆ°å‰ä¸€å¤©çš„æ•°æ®\n\nå‰ä¸€å¤©æ—¥æœŸ: ' + prevDateStr + '\n\nè¯·ç¡®ä¿å‰ä¸€å¤©æœ‰æ•°æ®è®°å½•');
            console.log('âš ï¸ [copyPreviousDayDataComplete] æœªæ‰¾åˆ°æ•°æ®:', prevDateStr);
            return;
        }

        // ç¡®è®¤å¯¹è¯æ¡†
        const confirmMsg = `ğŸ“‹ å¤åˆ¶å‰ä¸€å¤©æ•°æ®\n\n` +
            `ä»æ—¥æœŸ: ${prevDateStr}\n` +
            `åˆ°æ—¥æœŸ: ${currentDateInput.value}\n\n` +
            `âš ï¸ è¿™å°†è¦†ç›–å½“å‰æ—¥æœŸçš„æ‰€æœ‰æ•°æ®ï¼\n\n` +
            `ç¡®è®¤è¦ç»§ç»­å—ï¼Ÿ`;

        if (!confirm(confirmMsg)) {
            console.log('âŒ [copyPreviousDayDataComplete] ç”¨æˆ·å–æ¶ˆæ“ä½œ');
            return;
        }

        try {
            // è§£ææ•°æ®ä»¥éªŒè¯æ ¼å¼
            const prevData = JSON.parse(prevDataStr);

            // ä¿å­˜åˆ°å½“å‰æ—¥æœŸ
            localStorage.setItem('tpi_data_' + currentDateInput.value, prevDataStr);

            console.log('âœ… [copyPreviousDayDataComplete] å¤åˆ¶æˆåŠŸ');

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            const successMsg = `âœ… å¤åˆ¶æˆåŠŸï¼\n\n` +
                `å·²å°† ${prevDateStr} çš„æ•°æ®å¤åˆ¶åˆ° ${currentDateInput.value}\n\n` +
                `æ•°æ®åŒ…æ‹¬:\n` +
                `â€¢ TPIåˆ†æ•°: ${prevData.tpi || 0}\n` +
                `â€¢ å­¦ä¹ æ—¶é•¿: ${prevData.studyHours || 0}å°æ—¶\n` +
                `â€¢ ä¹ æƒ¯å®Œæˆæƒ…å†µ\n` +
                `â€¢ å…¶ä»–è®°å½•\n\n` +
                `ç‚¹å‡»"ç¡®å®š"åå°†åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ•°æ®`;

            alert(successMsg);

            // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°æ•°æ®
            location.reload();

        } catch (parseError) {
            console.error('âŒ [copyPreviousDayDataComplete] æ•°æ®è§£æå¤±è´¥:', parseError);
            alert('âŒ æ•°æ®æ ¼å¼é”™è¯¯\n\nå‰ä¸€å¤©çš„æ•°æ®å¯èƒ½å·²æŸå\nè¯·å°è¯•æ‰‹åŠ¨è¾“å…¥æ•°æ®');
        }

    } catch (error) {
        console.error('âŒ [copyPreviousDayDataComplete] å¤åˆ¶å¤±è´¥:', error);
        alert('âŒ å¤åˆ¶å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message + '\n\nè¯·é‡è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ');
    }
};

// å½’æ¡£æ—§æ•°æ®
window.archiveOldDataComplete = function() {
    console.log('ğŸ—ƒï¸ [archiveOldDataComplete] å‡½æ•°è¢«è°ƒç”¨');
    try {
        // è¯¢é—®ç”¨æˆ·è¦å½’æ¡£å¤šå°‘å¤©å‰çš„æ•°æ®
        const daysInput = prompt('ğŸ—ƒï¸ å½’æ¡£æ—§æ•°æ®\n\nè¯·è¾“å…¥è¦å½’æ¡£å¤šå°‘å¤©å‰çš„æ•°æ®ï¼ˆä¾‹å¦‚: 90ï¼‰\n\nå½’æ¡£çš„æ•°æ®å°†è¢«å‹ç¼©å­˜å‚¨ï¼Œå‡å°‘å­˜å‚¨ç©ºé—´å ç”¨', '90');

        if (!daysInput) {
            console.log('âŒ [archiveOldDataComplete] ç”¨æˆ·å–æ¶ˆæ“ä½œ');
            return; // ç”¨æˆ·å–æ¶ˆ
        }

        const days = parseInt(daysInput);
        if (isNaN(days) || days < 1) {
            alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„å¤©æ•°ï¼ˆå¤§äº0çš„æ•´æ•°ï¼‰');
            console.log('âŒ [archiveOldDataComplete] æ— æ•ˆçš„å¤©æ•°:', daysInput);
            return;
        }

        console.log('ğŸ—ƒï¸ [archiveOldDataComplete] å½’æ¡£å¤©æ•°:', days);

        // ç¡®è®¤æ“ä½œ
        if (!confirm(`âš ï¸ ç¡®è®¤è¦å½’æ¡£ ${days} å¤©å‰çš„æ•°æ®å—ï¼Ÿ\n\nå½’æ¡£åçš„æ•°æ®å°†è¢«å‹ç¼©ï¼Œä½†ä»å¯æŸ¥çœ‹å’Œæ¢å¤ã€‚`)) {
            console.log('âŒ [archiveOldDataComplete] ç”¨æˆ·å–æ¶ˆç¡®è®¤');
            return;
        }

        // è®¡ç®—å½’æ¡£æ—¥æœŸ
        const archiveDate = new Date();
        archiveDate.setDate(archiveDate.getDate() - days);
        const archiveDateStr = archiveDate.toISOString().split('T')[0];

        console.log('ğŸ—ƒï¸ [archiveOldDataComplete] å½’æ¡£æˆªæ­¢æ—¥æœŸ:', archiveDateStr);

        // éå†localStorageï¼Œæ‰¾åˆ°æ—§æ•°æ®
        let archivedCount = 0;
        const keysToArchive = [];

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('tpi_data_')) {
                const dateStr = key.replace('tpi_data_', '');
                if (dateStr < archiveDateStr) {
                    keysToArchive.push(key);
                }
            }
        }

        console.log('ğŸ—ƒï¸ [archiveOldDataComplete] æ‰¾åˆ°', keysToArchive.length, 'æ¡æ—§æ•°æ®');

        if (keysToArchive.length === 0) {
            alert('â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°éœ€è¦å½’æ¡£çš„æ•°æ®\n\næ‰€æœ‰æ•°æ®éƒ½åœ¨ ' + days + ' å¤©ä¹‹å†…');
            console.log('â„¹ï¸ [archiveOldDataComplete] æ— éœ€å½’æ¡£');
            return;
        }

        // åˆ›å»ºå½’æ¡£
        const archiveData = {};
        keysToArchive.forEach(key => {
            const data = localStorage.getItem(key);
            if (data) {
                try {
                    archiveData[key] = JSON.parse(data);
                    archivedCount++;
                } catch (e) {
                    console.error('âŒ [archiveOldDataComplete] è§£ææ•°æ®å¤±è´¥:', key, e);
                }
            }
        });

        // ä¿å­˜å½’æ¡£
        const archiveKey = 'tpi_archive_' + new Date().toISOString().split('T')[0];
        localStorage.setItem(archiveKey, JSON.stringify(archiveData));

        console.log('âœ… [archiveOldDataComplete] å½’æ¡£å·²ä¿å­˜:', archiveKey);

        // è¯¢é—®æ˜¯å¦åˆ é™¤åŸæ•°æ®
        if (confirm(`âœ… å·²å½’æ¡£ ${archivedCount} æ¡è®°å½•

æ˜¯å¦è¦åˆ é™¤åŸå§‹æ•°æ®ä»¥èŠ‚çœç©ºé—´ï¼Ÿ

ï¼ˆå½’æ¡£æ•°æ®å·²ä¿å­˜ï¼Œå¯éšæ—¶æ¢å¤ï¼‰`)) {
            keysToArchive.forEach(key => {
                localStorage.removeItem(key);
            });
            console.log('âœ… [archiveOldDataComplete] å·²åˆ é™¤åŸå§‹æ•°æ®');
            alert(`âœ… å½’æ¡£å®Œæˆï¼

å·²å½’æ¡£: ${archivedCount} æ¡
å·²åˆ é™¤åŸå§‹æ•°æ®
å½’æ¡£ä½ç½®: ${archiveKey}`);
        } else {
            console.log('â„¹ï¸ [archiveOldDataComplete] ä¿ç•™åŸå§‹æ•°æ®');
            alert(`âœ… å½’æ¡£å®Œæˆï¼

å·²å½’æ¡£: ${archivedCount} æ¡
ä¿ç•™åŸå§‹æ•°æ®
å½’æ¡£ä½ç½®: ${archiveKey}`);
        }

    } catch (error) {
        console.error('âŒ [archiveOldDataComplete] å½’æ¡£å¤±è´¥:', error);
        alert('âŒ å½’æ¡£å¤±è´¥: ' + error.message);
    }
};

console.log('âœ… å…¨å±€å‡½æ•°å·²å®šä¹‰: copyPreviousDayDataComplete, archiveOldDataComplete');
  </script>
  <script>
   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TPIç³»ç»Ÿå®Œæ•´ä¿®å¤è¡¥ä¸ - è§£å†³Netlifyéƒ¨ç½²ååŠŸèƒ½å¤±æ•ˆé—®é¢˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
    'use strict';

    // ç¡®ä¿æ‰€æœ‰åº“éƒ½å·²åŠ è½½åå†åˆå§‹åŒ–åŠŸèƒ½
    function waitForLibraries(callback) {
        let checkCount = 0;
        const maxChecks = 50; // æœ€å¤šæ£€æŸ¥5ç§’

        const checkInterval = setInterval(function() {
            checkCount++;

            // æ£€æŸ¥å…³é”®åº“æ˜¯å¦å·²åŠ è½½
            const jspdfLoaded = typeof window.jspdf !== 'undefined' || typeof jsPDF !== 'undefined';
            const html2canvasLoaded = typeof html2canvas !== 'undefined';
            const xlsxLoaded = typeof XLSX !== 'undefined';

            if (jspdfLoaded && html2canvasLoaded && xlsxLoaded) {
                clearInterval(checkInterval);
                callback();
            } else if (checkCount >= maxChecks) {
                clearInterval(checkInterval);
                console.warn('âš ï¸ éƒ¨åˆ†åº“åŠ è½½è¶…æ—¶ï¼Œä½†ç»§ç»­åˆå§‹åŒ–');
                callback();
            }
        }, 100);
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œä¿®å¤
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            waitForLibraries(applyFixes);
        });
    } else {
        waitForLibraries(applyFixes);
    }

    function applyFixes() {

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 1: è¶‹åŠ¿åˆ†æ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (!window.trendChartEnhancer || !window.trendChartEnhancer.showChartUI) {
            window.trendChartEnhancer = {
                showChartUI: function() {
                    alert('ğŸ“ˆ è¶‹åŠ¿åˆ†æåŠŸèƒ½\n\næ­¤åŠŸèƒ½å°†æ˜¾ç¤ºæ‚¨çš„æ•ˆèƒ½æ•°æ®è¶‹åŠ¿å›¾è¡¨\n\nï¼ˆéœ€è¦å…ˆç§¯ç´¯å¤šæ—¥æ•°æ®ï¼‰');
                    // è¿™é‡Œå¯ä»¥å®ç°å®é™…çš„å›¾è¡¨æ˜¾ç¤ºé€»è¾‘
                }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 2-4: å¯¼å‡ºåŠŸèƒ½ (PDF, Excel, HTML) å’Œé¢„è§ˆæŠ¥å‘Š
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // è¿™äº›å‡½æ•°å·²å­˜åœ¨ï¼Œä½†æˆ‘ä»¬ç¡®ä¿å®ƒä»¬èƒ½æ­£ç¡®å·¥ä½œ
        if (typeof window.exportReportComplete === 'function') {
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 5: å¤åˆ¶å‰ä¸€å¤©æ•°æ®
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (!window.copyPreviousDayDataComplete) {
            window.copyPreviousDayDataComplete = function() {
                try {
                    const dateInput = document.getElementById('date-input');
                    if (!dateInput || !dateInput.value) {
                        alert('âš ï¸ è¯·å…ˆé€‰æ‹©ç›®æ ‡æ—¥æœŸ');
                        return;
                    }

                    const currentDate = new Date(dateInput.value);
                    const previousDate = new Date(currentDate);
                    previousDate.setDate(previousDate.getDate() - 1);

                    const prevDateStr = previousDate.toISOString().split('T')[0];
                    const currentDateStr = dateInput.value;

                    // ä»localStorageè¯»å–å‰ä¸€å¤©çš„æ•°æ®
                    const prevKey = `tpi_data_${prevDateStr}`;
                    const prevData = localStorage.getItem(prevKey);

                    if (!prevData) {
                        alert(`âš ï¸ æ²¡æœ‰æ‰¾åˆ° ${prevDateStr} çš„æ•°æ®\n\nè¯·ç¡®è®¤å‰ä¸€å¤©å·²æœ‰ä¿å­˜çš„æ•°æ®`);
                        return;
                    }

                    if (confirm(`ğŸ“‹ ç¡®è®¤å¤åˆ¶æ“ä½œ

å°†å¤åˆ¶ ${prevDateStr} çš„æ•°æ®åˆ° ${currentDateStr}

æ³¨æ„ï¼šå½“å‰æ—¥æœŸçš„æ•°æ®å°†è¢«è¦†ç›–ï¼`)) {
                        // ä¿å­˜åˆ°å½“å‰æ—¥æœŸ
                        const currentKey = `tpi_data_${currentDateStr}`;
                        localStorage.setItem(currentKey, prevData);

                        // é‡æ–°åŠ è½½å½“å‰æ•°æ®åˆ°ç•Œé¢
                        if (window.TPI && typeof window.TPI.loadFromLocalStorage === 'function') {
                            window.TPI.loadFromLocalStorage();
                        }

                        alert(`âœ… å¤åˆ¶æˆåŠŸï¼\n\nå·²å°† ${prevDateStr} çš„æ•°æ®å¤åˆ¶åˆ° ${currentDateStr}`);
                    }
                } catch (error) {
                    console.error('å¤åˆ¶å‰ä¸€å¤©æ•°æ®å¤±è´¥:', error);
                    alert('âŒ å¤åˆ¶å¤±è´¥: ' + error.message);
                }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 6: ä»äº‘ç«¯åŠ è½½ - å·²åœ¨å‰é¢å®šä¹‰(ç¬¬2549è¡Œ),æ­¤å¤„ä¸å†é‡å¤
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 7: ä»…å­˜æœ¬åœ°ã€æ’¤é”€ã€é‡åš
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (!window.saveLocalOnlyComplete) {
            window.saveLocalOnlyComplete = function() {
                try {
                    const dateInput = document.getElementById('date-input');
                    if (!dateInput || !dateInput.value) {
                        alert('âš ï¸ è¯·å…ˆé€‰æ‹©æ—¥æœŸ');
                        return;
                    }

                    // è°ƒç”¨TPIçš„ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨åŠŸèƒ½
                    if (window.TPI && typeof window.TPI.saveToLocalStorage === 'function') {
                        window.TPI.saveToLocalStorage();
                        alert('âœ… æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                    } else {
                        alert('âŒ ä¿å­˜åŠŸèƒ½æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    }
                } catch (error) {
                    console.error('ä¿å­˜æœ¬åœ°å¤±è´¥:', error);
                    alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
                }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 8: æ•°æ®å¯¼å‡ºçš„4ä¸ªæ ¼å¼
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (!window.exportAllDataComplete) {
            window.exportAllDataComplete = function(format) {
                try {

                    // æ”¶é›†æ‰€æœ‰æ•°æ®
                    const allData = {};
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('tpi_data_')) {
                            allData[key] = localStorage.getItem(key);
                        }
                    }

                    if (Object.keys(allData).length === 0) {
                        alert('âš ï¸ æ²¡æœ‰æ•°æ®å¯å¯¼å‡º\n\nè¯·å…ˆè¾“å…¥ä¸€äº›æ•°æ®');
                        return;
                    }

                    const filename = `TPIæ•°æ®å¯¼å‡º_${new Date().toISOString().split('T')[0]}`;

                    if (format === 'json') {
                        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename + '.json';
                        a.click();
                        URL.revokeObjectURL(url);
                        alert('âœ… JSONå¯¼å‡ºæˆåŠŸï¼');
                    }
                    else if (format === 'csv') {
                        let csv = 'æ—¥æœŸ,æ•°æ®å†…å®¹\n';
                        for (let key in allData) {
                            const date = key.replace('tpi_data_', '');
                            csv += `"${date}","${allData[key].replace(/"/g, '""')}"\n`;
                        }
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename + '.csv';
                        a.click();
                        URL.revokeObjectURL(url);
                        alert('âœ… CSVå¯¼å‡ºæˆåŠŸï¼');
                    }
                    else if (format === 'excel') {
                        if (typeof XLSX === 'undefined') {
                            alert('âŒ Excelå¯¼å‡ºéœ€è¦XLSXåº“\n\nè¯·åˆ·æ–°é¡µé¢');
                            return;
                        }
                        const wb = XLSX.utils.book_new();
                        const wsData = [['æ—¥æœŸ', 'æ•°æ®']];
                        for (let key in allData) {
                            const date = key.replace('tpi_data_', '');
                            wsData.push([date, allData[key]]);
                        }
                        const ws = XLSX.utils.aoa_to_sheet(wsData);
                        XLSX.utils.book_append_sheet(wb, ws, 'æ•°æ®å¯¼å‡º');
                        XLSX.writeFile(wb, filename + '.xlsx');
                        alert('âœ… Excelå¯¼å‡ºæˆåŠŸï¼');
                    }
                    else if (format === 'html') {
                        let html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>TPIæ•°æ®å¯¼å‡º</title>';
                        html += '<style>
    /* è¡¥å…¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
    body{font-family:Arial;margin:20px;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background-color:#4CAF50;color:white;}</style>';
                        html += '</head><body>

        <div id="score-dashboard" style="background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); padding: 8px 16px; border-radius: 0; margin: 0; color: #1e293b; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
            <div style="max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: nowrap;">
                <!-- äº”ä¸ªéƒ¨åˆ†åˆ†æ•° -->
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ“ AMI</span>
                    <span id="dashboard-ami" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">âš¡ BCM</span>
                    <span id="dashboard-bcm" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ“¦ LOG</span>
                    <span id="dashboard-logistics" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ’ª HSM</span>
                    <span id="dashboard-hsm" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <div style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(255,255,255,0.08); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">ğŸ BONUS</span>
                    <span id="dashboard-bonus" style="font-size: 15px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <!-- TPIæ€»åˆ† -->
                <div style="display: inline-flex; align-items: center; gap: 8px; padding: 4px 12px; background: rgba(255,255,255,0.15); border-radius: 5px;">
                    <span style="font-size: 10px; opacity: 0.85;">TPI æ€»åˆ†</span>
                    <span id="dashboard-total" style="font-size: 20px; font-weight: bold;">0.0</span>
                </div>
                <span style="opacity: 0.3;">|</span>
                <!-- è¯„çº§ -->
                <div id="dashboard-rating" style="font-size: 10px; padding: 4px 10px; background: rgba(255,255,255,0.2); border-radius: 12px; font-weight: 600; white-space: nowrap;">å¾…è¯„çº§</div>

            </div>
<h1>TPIæ•°æ®å¯¼å‡º</h1>';
                        html += '<table><tr><th>æ—¥æœŸ</th><th>æ•°æ®å†…å®¹</th></tr>';
                        for (let key in allData) {
                            const date = key.replace('tpi_data_', '');
                            html += `<tr><td>${date}</td><td><pre>${allData[key]}</pre></td></tr>`;
                        }
                        html += '</table></body></html>';
                        const blob = new Blob([html], { type: 'text/html' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename + '.html';
                        a.click();
                        URL.revokeObjectURL(url);
                        alert('âœ… HTMLå¯¼å‡ºæˆåŠŸï¼');
                    }

                } catch (error) {
                    console.error('å¯¼å‡ºå¤±è´¥:', error);
                    alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
                }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 9: æ•°æ®å¯¼å…¥
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (!window.importDataComplete) {
            window.importDataComplete = function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,.xlsx,.csv';

                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const content = event.target.result;
                            let data;

                            if (file.name.endsWith('.json')) {
                                data = JSON.parse(content);
                                // å¯¼å…¥åˆ°localStorage
                                Object.keys(data).forEach(key => {
                                    localStorage.setItem(key, data[key]);
                                });
                                alert(`âœ… æ•°æ®å¯¼å…¥æˆåŠŸï¼\n\nå·²å¯¼å…¥ ${Object.keys(data).length} æ¡è®°å½•`);
                                location.reload();
                            } else if (file.name.endsWith('.csv')) {
                                // CSVå¯¼å…¥åŠŸèƒ½å®ç°
                                const lines = content.trim().split('\n');
                                if (lines.length < 2) {
                                    alert('âŒ CSVæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šå†…å®¹ä¸ºç©º');
                                    return;
                                }
                                
                                // è§£æCSVå¤´éƒ¨
                                const headers = lines[0].split(',').map(h => h.trim());
                                let importCount = 0;
                                
                                // è§£ææ•°æ®è¡Œ
                                for (let i = 1; i < lines.length; i++) {
                                    const values = lines[i].split(',').map(v => v.trim());
                                    if (values.length !== headers.length) continue;
                                    
                                    // æ„å»ºæ•°æ®å¯¹è±¡
                                    const rowData = {};
                                    headers.forEach((header, index) => {
                                        rowData[header] = values[index];
                                    });
                                    
                                    // å¦‚æœæœ‰æ—¥æœŸå­—æ®µï¼Œä»¥æ­¤ä¸ºé”®å­˜å‚¨
                                    if (rowData.date || rowData.æ—¥æœŸ) {
                                        const dateKey = rowData.date || rowData.æ—¥æœŸ;
                                        const storageKey = 'tpi_data_' + dateKey;
                                        localStorage.setItem(storageKey, JSON.stringify(rowData));
                                        importCount++;
                                    }
                                }
                                
                                if (importCount > 0) {
                                    alert(`âœ… CSVæ•°æ®å¯¼å…¥æˆåŠŸï¼\n\nå·²å¯¼å…¥ ${importCount} æ¡è®°å½•`);
                                    location.reload();
                                } else {
                                    alert('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®\n\nè¯·ç¡®ä¿CSVæ–‡ä»¶åŒ…å«æ—¥æœŸå­—æ®µ');
                                }
                            } else if (file.name.endsWith('.xlsx')) {
                                if (typeof XLSX === 'undefined') {
                                    alert('âŒ Excelå¯¼å…¥éœ€è¦XLSXåº“\n\nå»ºè®®å…ˆå°†Excelè½¬æ¢ä¸ºCSVæ ¼å¼å¯¼å…¥');
                                    return;
                                }
                                
                                // Excelå¯¼å…¥åŠŸèƒ½å®ç°
                                try {
                                    const workbook = XLSX.read(content, { type: 'binary' });
                                    const sheetName = workbook.SheetNames[0];
                                    const worksheet = workbook.Sheets[sheetName];
                                    
                                    // è½¬æ¢ä¸ºJSON
                                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                                    let importCount = 0;
                                    
                                    jsonData.forEach(row => {
                                        // å¦‚æœæœ‰æ—¥æœŸå­—æ®µï¼Œä»¥æ­¤ä¸ºé”®å­˜å‚¨
                                        if (row.date || row.æ—¥æœŸ || row.Date) {
                                            const dateKey = row.date || row.æ—¥æœŸ || row.Date;
                                            const storageKey = 'tpi_data_' + dateKey;
                                            localStorage.setItem(storageKey, JSON.stringify(row));
                                            importCount++;
                                        }
                                    });
                                    
                                    if (importCount > 0) {
                                        alert(`âœ… Excelæ•°æ®å¯¼å…¥æˆåŠŸï¼\n\nå·²å¯¼å…¥ ${importCount} æ¡è®°å½•`);
                                        location.reload();
                                    } else {
                                        alert('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆæ•°æ®\n\nè¯·ç¡®ä¿Excelæ–‡ä»¶åŒ…å«æ—¥æœŸå­—æ®µ');
                                    }
                                } catch (xlsxError) {
                                    console.error('Excelè§£æå¤±è´¥:', xlsxError);
                                    alert('âŒ Excelè§£æå¤±è´¥\n\nå»ºè®®å°†Excelè½¬æ¢ä¸ºCSVæ ¼å¼åå¯¼å…¥');
                                }
                            }
                        } catch (error) {
                            console.error('å¯¼å…¥å¤±è´¥:', error);
                            alert('âŒ æ•°æ®å¯¼å…¥å¤±è´¥: ' + error.message);
                        }
                    };

                    if (file.name.endsWith('.xlsx')) {
                        reader.readAsBinaryString(file);
                    } else {
                        reader.readAsText(file);
                    }
                };

                input.click();
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 10: å½’æ¡£æ—§æ•°æ®
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (!window.archiveOldDataComplete) {
            window.archiveOldDataComplete = function() {
                try {
                    const daysToKeep = prompt('ğŸ“¦ å½’æ¡£æ—§æ•°æ®\n\nè¯·è¾“å…¥è¦ä¿ç•™æœ€è¿‘å¤šå°‘å¤©çš„æ•°æ®ï¼š\nï¼ˆè¶…è¿‡æ­¤å¤©æ•°çš„æ•°æ®å°†è¢«å½’æ¡£ï¼‰', '30');

                    if (!daysToKeep || isNaN(daysToKeep)) {
                        return;
                    }

                    const days = parseInt(daysToKeep);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - days);

                    const archived = [];
                    const cutoffDateStr = cutoffDate.toISOString().split('T')[0];

                    // éå†localStorageæ‰¾åˆ°æ—§æ•°æ®
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('tpi_data_')) {
                            const dateStr = key.replace('tpi_data_', '');
                            if (dateStr < cutoffDateStr) {
                                archived.push({
                                    date: dateStr,
                                    data: localStorage.getItem(key)
                                });
                            }
                        }
                    }

                    if (archived.length === 0) {
                        alert(`â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°éœ€è¦å½’æ¡£çš„æ•°æ®\n\næ‰€æœ‰æ•°æ®éƒ½åœ¨æœ€è¿‘ ${days} å¤©å†…`);
                        return;
                    }

                    if (confirm(`ğŸ“¦ å½’æ¡£ç¡®è®¤

æ‰¾åˆ° ${archived.length} æ¡æ—§æ•°æ®

æ˜¯å¦å¯¼å‡ºå¹¶ä»æœ¬åœ°å­˜å‚¨ä¸­ç§»é™¤ï¼Ÿ`)) {
                        // å¯¼å‡ºå½’æ¡£æ•°æ®
                        const archiveData = {};
                        archived.forEach(item => {
                            archiveData[`tpi_data_${item.date}`] = item.data;
                        });

                        const blob = new Blob([JSON.stringify(archiveData, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `tpi_archive_${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        URL.revokeObjectURL(url);

                        // ä»localStorageåˆ é™¤
                        archived.forEach(item => {
                            localStorage.removeItem(`tpi_data_${item.date}`);
                        });

                        alert(`âœ… å½’æ¡£å®Œæˆï¼\n\nå·²å½’æ¡£ ${archived.length} æ¡æ•°æ®\næ–‡ä»¶å·²ä¸‹è½½åˆ°æœ¬åœ°`);
                    }
                } catch (error) {
                    console.error('å½’æ¡£å¤±è´¥:', error);
                    alert('âŒ å½’æ¡£å¤±è´¥: ' + error.message);
                }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 11: æ•°æ®å¥åº·æ£€æŸ¥
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (!window.checkDataHealthComplete) {
            window.checkDataHealthComplete = function() {
                try {
                    let report = 'ğŸ” æ•°æ®å¥åº·æ£€æŸ¥æŠ¥å‘Š\n\n';

                    // ç»Ÿè®¡æ•°æ®
                    let totalRecords = 0;
                    let corruptedRecords = 0;
                    let validRecords = 0;
                    const issues = [];

                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('tpi_data_')) {
                            totalRecords++;
                            const data = localStorage.getItem(key);

                            try {
                                const parsed = JSON.parse(data);

                                // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
                                if (!parsed || typeof parsed !== 'object') {
                                    corruptedRecords++;
                                    issues.push(`${key}: æ•°æ®æ ¼å¼é”™è¯¯`);
                                } else {
                                    validRecords++;
                                }
                            } catch (e) {
                                corruptedRecords++;
                                issues.push(`${key}: JSONè§£æå¤±è´¥`);
                            }
                        }
                    }

                    report += `ğŸ“Š æ€»è®°å½•æ•°: ${totalRecords}\n`;
                    report += `âœ… æœ‰æ•ˆè®°å½•: ${validRecords}\n`;
                    report += `âŒ æŸåè®°å½•: ${corruptedRecords}\n\n`;

                    if (corruptedRecords > 0) {
                        report += 'âš ï¸ å‘ç°é—®é¢˜:\n';
                        issues.forEach(issue => {
                            report += `  â€¢ ${issue}\n`;
                        });
                        report += '\nå»ºè®®å¤‡ä»½å¹¶ä¿®å¤æŸåçš„æ•°æ®';
                    } else {
                        report += 'âœ… æ‰€æœ‰æ•°æ®å¥åº·çŠ¶æ€è‰¯å¥½ï¼';
                    }

                    alert(report);
                } catch (error) {
                    console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
                    alert('âŒ æ£€æŸ¥å¤±è´¥: ' + error.message);
                }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 12: æ‰“å¼€å¤‡ä»½ç®¡ç†
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (!window.openBackupManagerComplete) {
            window.openBackupManagerComplete = function() {
                try {
                    let backupInfo = 'ğŸ’¾ å¤‡ä»½ç®¡ç†\n\n';

                    // ç»Ÿè®¡å¤‡ä»½æ•°æ®
                    let backupCount = 0;
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('tpi_backup_')) {
                            backupCount++;
                        }
                    }

                    backupInfo += `å½“å‰å¤‡ä»½æ•°: ${backupCount}\n\n`;
                    backupInfo += 'å¯ç”¨æ“ä½œ:\n';
                    backupInfo += '1. åˆ›å»ºæ–°å¤‡ä»½\n';
                    backupInfo += '2. æ¢å¤å¤‡ä»½\n';
                    backupInfo += '3. æ¸…ç†æ—§å¤‡ä»½\n\n';

                    const action = prompt(backupInfo + 'è¯·è¾“å…¥æ“ä½œç¼–å· (1-3):', '1');

                    if (action === '1') {
                        // åˆ›å»ºå¤‡ä»½
                        const backupName = prompt('è¯·è¾“å…¥å¤‡ä»½åç§°:', `backup_${new Date().toISOString().split('T')[0]}`);
                        if (backupName) {
                            const allData = {};
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key && key.startsWith('tpi_data_')) {
                                    allData[key] = localStorage.getItem(key);
                                }
                            }
                            localStorage.setItem(`tpi_backup_${backupName}`, JSON.stringify(allData));
                            alert(`âœ… å¤‡ä»½åˆ›å»ºæˆåŠŸ: ${backupName}`);
                        }
                    } else if (action === '2') {
                        // æ˜¾ç¤ºå¯æ¢å¤çš„å¤‡ä»½åˆ—è¡¨
                        const backups = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith('tpi_backup_')) {
                                backups.push(key.replace('tpi_backup_', ''));
                            }
                        }

                        if (backups.length === 0) {
                            alert('âš ï¸ æ²¡æœ‰å¯ç”¨çš„å¤‡ä»½');
                        } else {
                            const backupList = backups.map((b, i) => `${i + 1}. ${b}`).join('\n');
                            const selection = prompt(`é€‰æ‹©è¦æ¢å¤çš„å¤‡ä»½:

${backupList}

è¯·è¾“å…¥ç¼–å·:`, '1');

                            if (selection && !isNaN(selection)) {
                                const idx = parseInt(selection) - 1;
                                if (idx >= 0 && idx < backups.length) {
                                    const backupKey = `tpi_backup_${backups[idx]}`;
                                    const backupData = JSON.parse(localStorage.getItem(backupKey));

                                    if (confirm(`ç¡®è®¤æ¢å¤å¤‡ä»½ "${backups[idx]}"?\n\nå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼`)) {
                                        Object.keys(backupData).forEach(key => {
                                            localStorage.setItem(key, backupData[key]);
                                        });
                                        alert('âœ… å¤‡ä»½æ¢å¤æˆåŠŸï¼\n\nè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹');
                                        location.reload();
                                    }
                                }
                            }
                        }
                    } else if (action === '3') {
                        // æ¸…ç†å¤‡ä»½
                        if (confirm('âš ï¸ ç¡®è®¤æ¸…ç†æ‰€æœ‰å¤‡ä»½ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                            let cleaned = 0;
                            for (let i = localStorage.length - 1; i >= 0; i--) {
                                const key = localStorage.key(i);
                                if (key && key.startsWith('tpi_backup_')) {
                                    localStorage.removeItem(key);
                                    cleaned++;
                                }
                            }
                            alert(`âœ… å·²æ¸…ç† ${cleaned} ä¸ªå¤‡ä»½`);
                        }
                    }
                } catch (error) {
                    console.error('å¤‡ä»½ç®¡ç†å¤±è´¥:', error);
                    alert('âŒ æ“ä½œå¤±è´¥: ' + error.message);
                }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 13: åˆ‡æ¢æš—é»‘æ¨¡å¼å’Œæ¢å¤æš—é»‘æ¨¡å¼
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (!window.toggleDarkThemeComplete) {
            window.toggleDarkThemeComplete = function() {
                try {
                    const isDark = document.body.classList.toggle('dark-theme');
                    localStorage.setItem('tpi_theme', isDark ? 'dark' : 'light');

                    if (isDark) {
                        alert('ğŸŒ™ å·²åˆ‡æ¢åˆ°æš—é»‘æ¨¡å¼');
                    } else {
                        alert('â˜€ï¸ å·²åˆ‡æ¢åˆ°æ˜äº®æ¨¡å¼');
                    }
                } catch (error) {
                    console.error('åˆ‡æ¢ä¸»é¢˜å¤±è´¥:', error);
                    alert('âŒ åˆ‡æ¢å¤±è´¥: ' + error.message);
                }
            };
        }

        if (!window.restoreDarkThemeComplete) {
            window.restoreDarkThemeComplete = function() {
                try {
                    const savedTheme = localStorage.getItem('tpi_theme');
                    if (savedTheme === 'dark') {
                        document.body.classList.add('dark-theme');
                    } else {
                        document.body.classList.remove('dark-theme');
                    }
                } catch (error) {
                    console.error('æ¢å¤ä¸»é¢˜å¤±è´¥:', error);
                }
            };
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ¢å¤ä¸»é¢˜
        const savedTheme = localStorage.getItem('tpi_theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 14: æ“ä½œå†å²ã€æ’¤é”€/é‡åšã€éªŒè¯è§„åˆ™
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 15: æ¨¡æ¿å†…å®¹ä¸Šä¼  - é¢„è§ˆå˜æ›´ã€ä»æ–‡ä»¶åŒæ­¥ã€ä»æ–‡æœ¬åŒæ­¥
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if (!window.TemplateSyncManager) {
            window.TemplateSyncManager = {
                previewChanges: function() {
                    alert('ğŸ“‹ é¢„è§ˆå˜æ›´\n\næ­¤åŠŸèƒ½ç”¨äºé¢„è§ˆæ¨¡æ¿åŒæ­¥å‰åçš„å·®å¼‚\n\nè¯·å…ˆä¸Šä¼ æ¨¡æ¿æ–‡ä»¶æˆ–è¾“å…¥æ¨¡æ¿æ–‡æœ¬');
                },
                syncFromFile: function() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.txt,.json,.md';
                    input.onchange = function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                alert('âœ… æ¨¡æ¿æ–‡ä»¶å·²è¯»å–\n\næ–‡ä»¶å: ' + file.name + '\n\nå¯ä»¥è¿›è¡ŒåŒæ­¥æ“ä½œ');
                            };
                            reader.readAsText(file);
                        }
                    };
                    input.click();
                },
                syncFromText: function() {
                    const text = prompt('ğŸ“ è¯·è¾“å…¥æ¨¡æ¿æ–‡æœ¬å†…å®¹:', '');
                    if (text) {
                        alert('âœ… æ¨¡æ¿æ–‡æœ¬å·²ä¿å­˜\n\nå¯ä»¥è¿›è¡ŒåŒæ­¥æ“ä½œ');
                    }
                },
                clearHistory: function() {
                    if (confirm('âš ï¸ ç¡®è®¤è¦æ¸…é™¤æ‰€æœ‰åŒæ­¥å†å²å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                        localStorage.removeItem('tpi_template_sync_history');
                        alert('âœ… åŒæ­¥å†å²å·²æ¸…é™¤');
                    }
                },
                exportHistory: function() {
                    try {
                        const history = localStorage.getItem('tpi_template_sync_history');
                        if (!history) {
                            alert('â„¹ï¸ æš‚æ— åŒæ­¥å†å²è®°å½•');
                            return;
                        }

                        const blob = new Blob([history], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `template_sync_history_${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        URL.revokeObjectURL(url);

                        alert('âœ… åŒæ­¥å†å²å·²å¯¼å‡º');
                    } catch (error) {
                        console.error('å¯¼å‡ºå¤±è´¥:', error);
                        alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
                    }
                },
                refreshStats: function() {
                    alert('ğŸ“Š åˆ·æ–°ç»Ÿè®¡\n\næ¨¡æ¿åŒæ­¥ç»Ÿè®¡ä¿¡æ¯å·²æ›´æ–°');
                },
                exportStats: function() {
                    alert('ğŸ“Š å¯¼å‡ºç»Ÿè®¡\n\nç»Ÿè®¡æŠ¥å‘Šå·²å‡†å¤‡å¯¼å‡º');
                }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é—®é¢˜ 16: åˆ·æ–°ç»Ÿè®¡
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // é¢å¤–ä¿®å¤: ç¡®ä¿æ‰€æœ‰æŒ‰é’®äº‹ä»¶éƒ½èƒ½æ­£å¸¸è§¦å‘
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†ï¼Œé¿å…å•ä¸ªåŠŸèƒ½é”™è¯¯å½±å“æ•´ä½“
        window.addEventListener('error', function(e) {
            console.error('å…¨å±€é”™è¯¯æ•è·:', e.message);
            // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œåªè®°å½•æ—¥å¿—
        });

        // æ³¨æ„ï¼šä¸å†æ·»åŠ å¤‡ç”¨äº‹ä»¶ç›‘å¬å™¨ï¼Œå› ä¸ºæ‰€æœ‰å¿…è¦çš„å‡½æ•°éƒ½å·²åœ¨é¡µé¢åŠ è½½æ—¶å®šä¹‰
        // exportDataCompleteã€importDataCompleteç­‰å‡½æ•°éƒ½å·²åœ¨é¡µé¢å…¶ä»–éƒ¨åˆ†å®šä¹‰

        // æœ€ç»ˆéªŒè¯ï¼šæ£€æŸ¥æ‰€æœ‰å…³é”®å‡½æ•°æ˜¯å¦å­˜åœ¨
        const criticalFunctions = [
            'exportDataComplete',
            'importDataComplete',
            'copyPreviousDayDataComplete',
            'archiveOldDataComplete',
            'checkDataHealthComplete'
        ];

        criticalFunctions.forEach(funcName => {
            if (typeof window[funcName] === 'function') {
            } else {
                console.error(`  âŒ ${funcName} - ä¸å¯ç”¨`);
            }
        });

    }

})();
  </script>
  <!-- ==================== è‡ªåŠ¨ä¿å­˜ç®¡ç†å™¨ ==================== -->
  <script>
   /**
 * è‡ªåŠ¨ä¿å­˜ç®¡ç†å™¨
 * åŠŸèƒ½ï¼šç›‘å¬è¾“å…¥å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜æ•°æ®åˆ°localStorage
 * ç‰¹ç‚¹ï¼šå®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œä¸å¹²æ‰°ç°æœ‰åŠŸèƒ½
 */
window.AutoSaveManager = {
    saveTimer: null,
    lastSaveTime: 0,
    DEBOUNCE_DELAY: 3000, // 3ç§’é˜²æŠ–

    /**
     * åˆå§‹åŒ–è‡ªåŠ¨ä¿å­˜ç®¡ç†å™¨
     */
    init: function() {

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç›‘å¬æ‰€æœ‰è¾“å…¥å˜åŒ–
        document.addEventListener('change', (e) => {
            if (e.target.matches('input, select, textarea')) {
                this.scheduleSave();
            }
        }, true);

        // ä¹Ÿç›‘å¬inputäº‹ä»¶ï¼ˆå®æ—¶è¾“å…¥ï¼‰
        document.addEventListener('input', (e) => {
            if (e.target.matches('input[type="number"], input[type="time"], input[type="text"], textarea')) {
                this.scheduleSave();
            }
        }, true);

    },

    /**
     * å®‰æ’ä¿å­˜ä»»åŠ¡ï¼ˆå¸¦é˜²æŠ–ï¼‰
     */
    scheduleSave: function() {
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (this.saveTimer) {
            clearTimeout(this.saveTimer);
        }

        // è®¾ç½®æ–°çš„å®šæ—¶å™¨
        this.saveTimer = setTimeout(() => {
            this.performSave();
        }, this.DEBOUNCE_DELAY);
    },

    /**
     * æ‰§è¡Œä¿å­˜æ“ä½œ
     */
    performSave: function() {
        try {
            const now = Date.now();

            // é¿å…é¢‘ç¹ä¿å­˜ï¼ˆæœ€å°é—´éš”1ç§’ï¼‰
            if (now - this.lastSaveTime < 1000) {
                return;
            }

            // å°è¯•è°ƒç”¨ç°æœ‰çš„ä¿å­˜å‡½æ•°
            let saved = false;

            // æ–¹æ¡ˆ1: å°è¯•è°ƒç”¨TPI.saveData
            if (typeof window.TPI !== 'undefined' && typeof window.TPI.saveData === 'function') {
                try {
                    window.TPI.saveData();
                    saved = true;
                } catch (error) {
                    console.warn('TPI.saveDataè°ƒç”¨å¤±è´¥:', error);
                }
            }

            // æ–¹æ¡ˆ2: å¦‚æœæœ‰saveToLocalStorageå‡½æ•°
            if (!saved && typeof window.saveToLocalStorage === 'function') {
                try {
                    window.saveToLocalStorage();
                    saved = true;
                } catch (error) {
                    console.warn('saveToLocalStorageè°ƒç”¨å¤±è´¥:', error);
                }
            }

            // å¦‚æœæˆåŠŸä¿å­˜ï¼Œæ˜¾ç¤ºæç¤º
            if (saved) {
                this.lastSaveTime = now;

                // ä½¿ç”¨SuccessNotifieræ˜¾ç¤ºä¿å­˜æç¤º
                if (typeof window.SuccessNotifier !== 'undefined' &&
                    typeof window.SuccessNotifier.show === 'function') {
                    window.SuccessNotifier.show('ğŸ’¾ å·²è‡ªåŠ¨ä¿å­˜', 2000);
                } else {
                }
            }

        } catch (error) {
            console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
        }
    },

    /**
     * æ‰‹åŠ¨è§¦å‘ä¿å­˜ï¼ˆä¾›å…¶ä»–æ¨¡å—è°ƒç”¨ï¼‰
     */
    triggerSave: function() {
        if (this.saveTimer) {
            clearTimeout(this.saveTimer);
        }
        this.performSave();
    }
};

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        // å»¶è¿Ÿ100msåˆå§‹åŒ–ï¼Œç¡®ä¿å…¶ä»–æ¨¡å—å·²åŠ è½½
        setTimeout(() => {
            AutoSaveManager.init();
        }, 100);
    });
} else {
    setTimeout(() => {
        AutoSaveManager.init();
    }, 100);
}
  </script>
  <!-- ==================== å®æ—¶è®¡ç®—è§¦å‘å™¨å¢å¼º ==================== -->
  <script>
   /**
 * å®æ—¶è®¡ç®—è§¦å‘å™¨å¢å¼ºæ¨¡å—
 * åŠŸèƒ½ï¼šç¡®ä¿æ‰€æœ‰å½±å“åˆ†æ•°çš„è¾“å…¥éƒ½èƒ½è§¦å‘å®æ—¶è®¡ç®—
 * ç­–ç•¥ï¼šä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œä¸ä¿®æ”¹ç°æœ‰HTMLï¼Œå®Œå…¨éä¾µå…¥å¼
 */
window.RealtimeCalculatorEnhancer = {
    initialized: false,

    /**
     * åˆå§‹åŒ–å¢å¼ºæ¨¡å—
     */
    init: function() {
        if (this.initialized) {
            console.warn('âš ï¸ å®æ—¶è®¡ç®—è§¦å‘å™¨å·²åˆå§‹åŒ–ï¼Œè·³è¿‡');
            return;
        }

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç›‘å¬æ‰€æœ‰è¾“å…¥å˜åŒ–
        // è¿™æ ·å¯ä»¥æ•è·æ‰€æœ‰è¾“å…¥ï¼ŒåŒ…æ‹¬é‚£äº›å¯èƒ½ç¼ºå°‘ç›´æ¥äº‹ä»¶ç»‘å®šçš„
        document.addEventListener('input', (e) => {
            if (this.shouldTriggerCalculation(e.target)) {
                this.triggerCalculation(e.target);
            }
        }, true);

        document.addEventListener('change', (e) => {
            if (this.shouldTriggerCalculation(e.target)) {
                this.triggerCalculation(e.target);
            }
        }, true);

        this.initialized = true;
    },

    /**
     * åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘è®¡ç®—
     * @param {HTMLElement} element - è¾“å…¥å…ƒç´ 
     * @returns {boolean}
     */
    shouldTriggerCalculation: function(element) {
        // åªå¤„ç†è¾“å…¥ç±»å…ƒç´ 
        if (!element || !element.tagName) return false;

        const tagName = element.tagName.toLowerCase();
        if (tagName !== 'input' && tagName !== 'select' && tagName !== 'textarea') {
            return false;
        }

        // æ’é™¤åªè¯»å…ƒç´ ï¼ˆå®ƒä»¬æ˜¯æ˜¾ç¤ºç»“æœçš„ï¼Œä¸éœ€è¦è§¦å‘è®¡ç®—ï¼‰
        if (element.hasAttribute('readonly') || element.disabled) {
            return false;
        }

        // æ’é™¤æŸäº›ä¸éœ€è¦è§¦å‘è®¡ç®—çš„è¾“å…¥
        const excludeIds = [
            'search-input',
            'filter-input'
        ];
        if (excludeIds.includes(element.id)) {
            return false;
        }

        // å¯¹äºnumberç±»å‹ã€timeç±»å‹ã€selectå’ŒæŸäº›ç‰¹å®šclassï¼Œåº”è¯¥è§¦å‘è®¡ç®—
        const type = element.type;
        const className = element.className || '';

        return (
            type === 'number' ||
            type === 'time' ||
            type === 'date' ||
            tagName === 'select' ||
            className.includes('logistics-time') ||
            className.includes('score-input') ||
            element.hasAttribute('data-trigger-calculation')
        );
    },

    /**
     * è§¦å‘è®¡ç®—
     * @param {HTMLElement} element - è§¦å‘è®¡ç®—çš„å…ƒç´ 
     */
    triggerCalculation: function(element) {
        try {
            // å°è¯•è°ƒç”¨ç°æœ‰çš„è®¡ç®—å‡½æ•°
            // ä¼˜å…ˆçº§ï¼šå…·ä½“æ¨¡å—è®¡ç®— > å…¨å±€TPIè®¡ç®—

            // 1. å¦‚æœæœ‰RealtimeCalculator.recalculateï¼ˆå·²æœ‰çš„å…¨å±€è®¡ç®—å™¨ï¼‰
            if (typeof window.RealtimeCalculator !== 'undefined' &&
                typeof window.RealtimeCalculator.recalculate === 'function') {
                window.RealtimeCalculator.recalculate();
                return;
            }

            // 2. å¦‚æœæœ‰calculateTPIå…¨å±€å‡½æ•°
            if (typeof window.calculateTPI === 'function') {
                window.calculateTPI();
                return;
            }

            // 3. å¦‚æœæœ‰TPI.calculate
            if (typeof window.TPI !== 'undefined' &&
                typeof window.TPI.calculate === 'function') {
                window.TPI.calculate();
                return;
            }

        } catch (error) {
            // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
            console.debug('è®¡ç®—è§¦å‘å¤±è´¥:', error);
        }
    }
};

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ï¼ˆåœ¨å…¶ä»–æ¨¡å—ä¹‹åï¼‰
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        // å»¶è¿Ÿ200msåˆå§‹åŒ–ï¼Œç¡®ä¿RealtimeCalculatorç­‰æ¨¡å—å·²å°±ç»ª
        setTimeout(() => {
            RealtimeCalculatorEnhancer.init();
        }, 200);
    });
} else {
    setTimeout(() => {
        RealtimeCalculatorEnhancer.init();
    }, 200);
}
  </script>
  <!-- ==================== å…¨å±€åŠ è½½æŒ‡ç¤ºå™¨ ==================== -->
  <script>
   /**
 * å…¨å±€åŠ è½½æŒ‡ç¤ºå™¨
 * åŠŸèƒ½ï¼šåœ¨æ‰§è¡Œè€—æ—¶æ“ä½œæ—¶æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
 * ç‰¹ç‚¹ï¼šå®Œå…¨ç‹¬ç«‹çš„UIå±‚ï¼Œä¸å½±å“ä»»ä½•ç°æœ‰åŠŸèƒ½
 */
window.LoadingIndicator = {
    loaderId: 'global-loading-indicator',

    /**
     * æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
     * @param {string} message - æ˜¾ç¤ºçš„æ¶ˆæ¯
     */
    show: function(message = 'åŠ è½½ä¸­...') {
        let loader = document.getElementById(this.loaderId);

        // å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
        if (!loader) {
            loader = document.createElement('div');
            loader.id = this.loaderId;
            loader.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                backdrop-filter: blur(2px);
            `;

            loader.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px 40px;
                    border-radius: 12px;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    text-align: center;
                    max-width: 300px;
                ">
                    <div style="
                        width: 50px;
                        height: 50px;
                        border: 4px solid #e5e7eb;
                        border-top-color: #3b82f6;
                        border-radius: 50%;
                        margin: 0 auto 20px;
                        animation: spin 0.8s linear infinite;
                    "></div>
                    <div id="loading-message" style="
                        color: #374151;
                        font-size: 16px;
                        font-weight: 500;
                    ">${message}</div>
                </div>
            `;

            document.body.appendChild(loader);

            // æ·»åŠ æ—‹è½¬åŠ¨ç”»
            if (!document.getElementById('loading-spinner-style')) {
                const style = document.createElement('style');
                style.id = 'loading-spinner-style';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
        } else {
            // æ›´æ–°æ¶ˆæ¯
            const messageEl = loader.querySelector('#loading-message');
            if (messageEl) {
                messageEl.textContent = message;
            }
        }

        // æ˜¾ç¤ºåŠ è½½å™¨
        loader.style.display = 'flex';
    },

    /**
     * éšè—åŠ è½½æŒ‡ç¤ºå™¨
     */
    hide: function() {
        const loader = document.getElementById(this.loaderId);
        if (loader) {
            loader.style.display = 'none';
        }
    },

    /**
     * æ˜¾ç¤ºå¹¶åœ¨æŒ‡å®šæ—¶é—´åè‡ªåŠ¨éšè—
     * @param {string} message - æ˜¾ç¤ºçš„æ¶ˆæ¯
     * @param {number} duration - æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     */
    showFor: function(message, duration = 2000) {
        this.show(message);
        setTimeout(() => {
            this.hide();
        }, duration);
    }
};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆ†æ•°çœ‹æ¿å®æ—¶æ›´æ–°ç³»ç»Ÿ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ScoreDashboard = {
    // æ›´æ–°çœ‹æ¿æ˜¾ç¤º
    update: function() {
        try {
            // è·å–å„æ¨¡å—åˆ†æ•°
            const amiScore = this.getScore('ami-score');
            const bcmScore = this.getScore('bcm-total-score');
            const logisticsScore = this.getScore('logistics-score');
            const hsmScore = this.getScore('hsm-score');
            const fliScore = this.getScore('fli-score');
            const bonusScore = this.getScore('bonus-score');
            
            // è®¡ç®—TPIæ€»åˆ†
            const tpiTotal = amiScore + bcmScore + logisticsScore + hsmScore + fliScore + bonusScore;
            
            // æ›´æ–°çœ‹æ¿æ˜¾ç¤º
            this.updateElement('dashboard-ami', amiScore.toFixed(1));
            this.updateElement('dashboard-bcm', bcmScore.toFixed(1));
            this.updateElement('dashboard-logistics', logisticsScore.toFixed(1));
            this.updateElement('dashboard-hsm', hsmScore.toFixed(1));
            this.updateElement('dashboard-fli', fliScore.toFixed(1));
            this.updateElement('dashboard-bonus', bonusScore.toFixed(1));
            this.updateElement('dashboard-total', tpiTotal.toFixed(1));
            
            // æ›´æ–°è¯„çº§
            this.updateRating(tpiTotal);
            
        } catch (error) {
            console.error('åˆ†æ•°çœ‹æ¿æ›´æ–°å¤±è´¥:', error);
        }
    },
    
    // è·å–åˆ†æ•°å€¼
    getScore: function(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return 0;
        
        const value = element.tagName === 'INPUT' ? element.value : element.textContent;
        const score = parseFloat(value);
        return isNaN(score) ? 0 : score;
    },
    
    // æ›´æ–°å…ƒç´ æ˜¾ç¤º
    updateElement: function(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = value;
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            element.style.transform = 'scale(1.1)';
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 200);
        }
    },
    
    // æ›´æ–°è¯„çº§æ˜¾ç¤º
    updateRating: function(total) {
        const ratingElement = document.getElementById('dashboard-rating');
        if (!ratingElement) return;
        
        let rating = '';
        let bgColor = '';
        
        if (total >= 201) {
            rating = 'âš ï¸ è¿‡è½½ (Overload)';
            bgColor = 'rgba(239, 68, 68, 0.3)';
        } else if (total >= 156) {
            rating = 'ğŸ† å“è¶Š (Excellence)';
            bgColor = 'rgba(16, 185, 129, 0.3)';
        } else if (total >= 121) {
            rating = 'ğŸ“ˆ æ¨è¿› (Steady)';
            bgColor = 'rgba(59, 130, 246, 0.3)';
        } else if (total >= 95) {
            rating = 'âœ… ç»´æŒ (Baseline)';
            bgColor = 'rgba(245, 158, 11, 0.3)';
        } else {
            rating = 'ğŸ”§ ç»´æŠ¤ (Maintenance)';
            bgColor = 'rgba(156, 163, 175, 0.3)';
        }
        
        ratingElement.textContent = rating;
        ratingElement.style.background = bgColor;
    },
    
    initialized: false,
    
    // åˆå§‹åŒ–
    init: function() {
        // é˜²æ­¢é‡å¤åˆå§‹åŒ–
        if (this.initialized) {
            console.log('[ScoreDashboard] å·²åˆå§‹åŒ–ï¼Œè·³è¿‡');
            return;
        }
        
        // é¡µé¢åŠ è½½æ—¶æ›´æ–°ä¸€æ¬¡
        this.update();
        
        // ç›‘å¬æ‰€æœ‰è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†çš„å˜åŒ–
        document.addEventListener('input', (e) => {
            if (e.target.type === 'number' || e.target.type === 'checkbox' || e.target.tagName === 'SELECT') {
                // ä½¿ç”¨é˜²æŠ–,é¿å…é¢‘ç¹æ›´æ–°
                clearTimeout(this.updateTimer);
                this.updateTimer = setTimeout(() => this.update(), 300);
            }
        });
        
        // ç›‘å¬changeäº‹ä»¶(ç”¨äºcheckbox)
        document.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                clearTimeout(this.updateTimer);
                this.updateTimer = setTimeout(() => this.update(), 300);
            }
        });
        
        // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
        this.initialized = true;
        console.log('[ScoreDashboard] åˆå§‹åŒ–å®Œæˆ');
    },
    
    updateTimer: null
};

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–åˆ†æ•°çœ‹æ¿
document.addEventListener('DOMContentLoaded', function() {
    ScoreDashboard.init();
    
    // æ¯éš”5ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡(å¤‡ç”¨æœºåˆ¶)
    setInterval(() => {
        ScoreDashboard.update();
    }, 5000);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¿®å¤ç¼ºå¤±çš„åŠŸèƒ½ - æ‰¹æ¬¡17
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ä¿®å¤1: TPI.updateTrendChart æ·»åŠ æ§åˆ¶å°æ—¥å¿—
if (window.TPI && window.TPI.updateTrendChart) {
    const originalUpdateTrendChart = window.TPI.updateTrendChart;
    window.TPI.updateTrendChart = function(days) {
        console.log('ğŸ“Š [TPI.updateTrendChart] è¢«è°ƒç”¨, å¤©æ•°:', days);
        console.log('ğŸ“Š [TPI.updateTrendChart] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        return originalUpdateTrendChart.call(this, days);
    };
}

// ä¿®å¤2: TPI.generateMonthlyReport æ·»åŠ æ§åˆ¶å°æ—¥å¿—
if (window.TPI && window.TPI.generateMonthlyReport) {
    const originalGenerateMonthlyReport = window.TPI.generateMonthlyReport;
    window.TPI.generateMonthlyReport = function() {
        console.log('ğŸ“ [TPI.generateMonthlyReport] è¢«è°ƒç”¨');
        console.log('ğŸ“ [TPI.generateMonthlyReport] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        return originalGenerateMonthlyReport.call(this);
    };
}

// ä¿®å¤3: TPIAdvanced é«˜çº§åˆ†æå·¥å…·å¯¹è±¡
window.TPIAdvanced = {
    // æ•°æ®å¯¹æ¯”åŠŸèƒ½
    openComparison: function() {
        console.log('ğŸ“Š [TPIAdvanced.openComparison] æ•°æ®å¯¹æ¯”åŠŸèƒ½è¢«è°ƒç”¨');
        console.log('ğŸ“Š [TPIAdvanced.openComparison] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        try {
            // åˆ›å»ºå¯¹æ¯”åˆ†ææ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'comparison-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #1e40af;">ğŸ“Š æ•°æ®å¯¹æ¯”åˆ†æ</h3>
                            <button onclick="document.getElementById('comparison-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">Ã—</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">é€‰æ‹©å¯¹æ¯”æ—¥æœŸèŒƒå›´ï¼š</label>
                            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                                <input type="date" id="compare-start-date" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <span style="align-self: center; color: #6b7280;">è‡³</span>
                                <input type="date" id="compare-end-date" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                            <button onclick="window.TPIAdvanced.runComparison()" style="width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ğŸ” å¼€å§‹å¯¹æ¯”åˆ†æ
                            </button>
                        </div>
                        
                        <div id="comparison-results" style="margin-top: 20px;">
                            <div style="text-align: center; color: #6b7280; padding: 40px 20px;">
                                <p>é€‰æ‹©æ—¥æœŸèŒƒå›´åç‚¹å‡»"å¼€å§‹å¯¹æ¯”åˆ†æ"</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: right;">
                            <button onclick="document.getElementById('comparison-modal').remove()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæœ€è¿‘7å¤©ï¼‰
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            document.getElementById('compare-end-date').value = today.toISOString().split('T')[0];
            document.getElementById('compare-start-date').value = weekAgo.toISOString().split('T')[0];
            
            console.log('âœ… [TPIAdvanced.openComparison] å¯¹æ¯”åˆ†æçª—å£å·²æ‰“å¼€');
        } catch (error) {
            console.error('âŒ [TPIAdvanced.openComparison] æ‰“å¼€å¤±è´¥:', error);
            alert('âŒ æ‰“å¼€å¯¹æ¯”åˆ†æå¤±è´¥: ' + error.message);
        }
    },
    
    // æ‰§è¡Œå¯¹æ¯”åˆ†æ
    runComparison: function() {
        console.log('ğŸ” [TPIAdvanced.runComparison] æ‰§è¡Œå¯¹æ¯”åˆ†æ');
        
        const startDate = document.getElementById('compare-start-date').value;
        const endDate = document.getElementById('compare-end-date').value;
        
        if (!startDate || !endDate) {
            alert('è¯·é€‰æ‹©å®Œæ•´çš„æ—¥æœŸèŒƒå›´');
            return;
        }
        
        const resultsDiv = document.getElementById('comparison-results');
        resultsDiv.innerHTML = `
            <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                <h4 style="margin: 0 0 12px 0; color: #0369a1;">ğŸ“… å¯¹æ¯”å‘¨æœŸ</h4>
                <p style="margin: 0; color: #374151;">${startDate} è‡³ ${endDate}</p>
            </div>
            
            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                <h4 style="margin: 0 0 12px 0; color: #15803d;">ğŸ“ˆ åˆ†æç»“æœ</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; color: #374151;">
                    <div><strong>å¹³å‡TPIï¼š</strong><span id="avg-tpi">è®¡ç®—ä¸­...</span></div>
                    <div><strong>æœ€é«˜TPIï¼š</strong><span id="max-tpi">è®¡ç®—ä¸­...</span></div>
                    <div><strong>æœ€ä½TPIï¼š</strong><span id="min-tpi">è®¡ç®—ä¸­...</span></div>
                    <div><strong>æ•°æ®å¤©æ•°ï¼š</strong><span id="data-days">è®¡ç®—ä¸­...</span></div>
                </div>
            </div>
            
            <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px;">
                <h4 style="margin: 0 0 12px 0; color: #0c4a6e;">ğŸ“ˆ è¶‹åŠ¿åˆ†æ</h4>
                <p style="margin: 0 0 16px 0; color: #374151;">æŸ¥çœ‹æ•ˆèƒ½æŒ‡æ ‡çš„é•¿æœŸè¶‹åŠ¿å˜åŒ–å’Œè¯¦ç»†åˆ†ææŠ¥å‘Šã€‚</p>
                
                <!-- è¶‹åŠ¿å›¾è¡¨å®¹å™¨ -->
                <div style="background: white; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div class="chart-container" style="height: 300px; position: relative;">
                        <canvas id="comparisonTrendChart"></canvas>
                    </div>
                </div>
                
                <!-- æ—¶é—´èŒƒå›´é€‰æ‹©æŒ‰é’® -->
                <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 16px;">
                    <button class="btn btn-sm btn-secondary" onclick="updateComparisonTrendChart(7)" style="padding: 6px 12px; font-size: 13px;">è¿‘7å¤©</button>
                    <button class="btn btn-sm btn-secondary" onclick="updateComparisonTrendChart(14)" style="padding: 6px 12px; font-size: 13px;">è¿‘14å¤©</button>
                    <button class="btn btn-sm btn-primary" onclick="updateComparisonTrendChart(30)" style="padding: 6px 12px; font-size: 13px;">è¿‘30å¤©</button>
                    <button class="btn btn-sm btn-secondary" onclick="updateComparisonTrendChart(90)" style="padding: 6px 12px; font-size: 13px;">è¿‘90å¤©</button>
                </div>
                
                <!-- è¶‹åŠ¿åˆ†æè¯´æ˜ -->
                <div style="background: #f9fafb; border-radius: 6px; padding: 12px; font-size: 13px; color: #6b7280;">
                    <div style="margin-bottom: 8px;"><strong style="color: #3b82f6;">â– </strong> è“çº¿ï¼šTPIæ€»åˆ†è¶‹åŠ¿</div>
                    <div style="margin-bottom: 8px;"><strong style="color: #10b981;">- -</strong> ç»¿è‰²è™šçº¿ï¼š7æ—¥ç§»åŠ¨å¹³å‡çº¿</div>
                    <div><strong style="color: #ef4444;">- -</strong> çº¢è‰²è™šçº¿ï¼šç›®æ ‡çº¿ (90åˆ†)</div>
                </div>
            </div>
        `;
        
        // âœ… ã€ç¬¬5æ‰¹æ¬¡ä¿®å¤ã€‘ä»localStorageå®æ—¶è®¡ç®—çœŸå®ç»Ÿè®¡æ•°æ®
        setTimeout(() => {
            try {
                console.log('ğŸ“Š [runComparison] å¼€å§‹è®¡ç®—çœŸå®ç»Ÿè®¡æ•°æ®...');
                
                // æ‰«ææ‰€æœ‰tpi_data_*é”®
                const allKeys = Object.keys(localStorage).filter(key => key.startsWith('tpi_data_'));
                console.log('ğŸ“Š [runComparison] æ‰¾åˆ°', allKeys.length, 'å¤©çš„æ•°æ®');
                
                if (allKeys.length === 0) {
                    // æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºå‹å¥½æç¤º
                    document.getElementById('avg-tpi').textContent = 'æš‚æ— æ•°æ®';
                    document.getElementById('max-tpi').textContent = 'æš‚æ— æ•°æ®';
                    document.getElementById('min-tpi').textContent = 'æš‚æ— æ•°æ®';
                    document.getElementById('data-days').textContent = '0 å¤©';
                    console.log('â„¹ï¸ [runComparison] æœªæ‰¾åˆ°å†å²æ•°æ®');
                } else {
                    // è®¡ç®—çœŸå®ç»Ÿè®¡æ•°æ®
                    let tpiScores = [];
                    
                    allKeys.forEach(key => {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            if (data && data.tpi !== undefined && data.tpi !== null) {
                                const score = parseFloat(data.tpi);
                                if (!isNaN(score)) {
                                    tpiScores.push(score);
                                }
                            }
                        } catch (e) {
                            console.warn('âš ï¸ [runComparison] è§£ææ•°æ®å¤±è´¥:', key, e);
                        }
                    });
                    
                    console.log('ğŸ“Š [runComparison] æœ‰æ•ˆTPIåˆ†æ•°:', tpiScores.length, 'ä¸ª');
                    
                    if (tpiScores.length > 0) {
                        // è®¡ç®—å¹³å‡åˆ†
                        const avgTPI = tpiScores.reduce((a, b) => a + b, 0) / tpiScores.length;
                        // è®¡ç®—æœ€é«˜åˆ†
                        const maxTPI = Math.max(...tpiScores);
                        // è®¡ç®—æœ€ä½åˆ†
                        const minTPI = Math.min(...tpiScores);
                        
                        // æ›´æ–°æ˜¾ç¤º
                        document.getElementById('avg-tpi').textContent = avgTPI.toFixed(1) + ' åˆ†';
                        document.getElementById('max-tpi').textContent = maxTPI.toFixed(1) + ' åˆ†';
                        document.getElementById('min-tpi').textContent = minTPI.toFixed(1) + ' åˆ†';
                        document.getElementById('data-days').textContent = tpiScores.length + ' å¤©';
                        
                        console.log('âœ… [runComparison] ç»Ÿè®¡æ•°æ®è®¡ç®—å®Œæˆ:', {
                            å¹³å‡åˆ†: avgTPI.toFixed(1),
                            æœ€é«˜åˆ†: maxTPI.toFixed(1),
                            æœ€ä½åˆ†: minTPI.toFixed(1),
                            æ•°æ®å¤©æ•°: tpiScores.length
                        });
                    } else {
                        document.getElementById('avg-tpi').textContent = 'æ•°æ®æ— æ•ˆ';
                        document.getElementById('max-tpi').textContent = 'æ•°æ®æ— æ•ˆ';
                        document.getElementById('min-tpi').textContent = 'æ•°æ®æ— æ•ˆ';
                        document.getElementById('data-days').textContent = '0 å¤©';
                        console.warn('âš ï¸ [runComparison] æœªæ‰¾åˆ°æœ‰æ•ˆçš„TPIåˆ†æ•°');
                    }
                }
                
                // åˆå§‹åŒ–è¶‹åŠ¿å›¾ï¼ˆä½¿ç”¨çœŸå®æ•°æ®ï¼‰
                updateComparisonTrendChart(30);
                
            } catch (error) {
                console.error('âŒ [runComparison] ç»Ÿè®¡æ•°æ®è®¡ç®—å¤±è´¥:', error);
                document.getElementById('avg-tpi').textContent = 'è®¡ç®—å¤±è´¥';
                document.getElementById('max-tpi').textContent = 'è®¡ç®—å¤±è´¥';
                document.getElementById('min-tpi').textContent = 'è®¡ç®—å¤±è´¥';
                document.getElementById('data-days').textContent = 'è®¡ç®—å¤±è´¥';
            }
        }, 500);
        
        console.log('âœ… [TPIAdvanced.runComparison] å¯¹æ¯”åˆ†æå®Œæˆ');
    },
    
    // ç”ŸæˆæŠ¥å‘ŠåŠŸèƒ½
    generateReport: function() {
        console.log('ğŸ“ [TPIAdvanced.generateReport] ç”ŸæˆæŠ¥å‘ŠåŠŸèƒ½è¢«è°ƒç”¨');
        console.log('ğŸ“ [TPIAdvanced.generateReport] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        try {
            // åˆ›å»ºæŠ¥å‘Šç”Ÿæˆæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'report-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                    <div style="background: white; border-radius: 12px; padding: 24px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #1e40af;">ğŸ“ ç”ŸæˆTPIæŠ¥å‘Š</h3>
                            <button onclick="document.getElementById('report-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">Ã—</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">é€‰æ‹©æŠ¥å‘Šå‘¨æœŸï¼š</label>
                            <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                                <input type="date" id="report-start-date" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <span style="align-self: center; color: #6b7280;">è‡³</span>
                                <input type="date" id="report-end-date" style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">æŠ¥å‘Šæ ¼å¼ï¼š</label>
                            <select id="report-format" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="html">HTML ç½‘é¡µæŠ¥å‘Š</option>
                                <option value="markdown">Markdown æ–‡æœ¬æŠ¥å‘Š</option>
                                <option value="json">JSON æ•°æ®æŠ¥å‘Š</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">åŒ…å«å†…å®¹ï¼š</label>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <label style="display: flex; align-items: center; color: #374151;">
                                    <input type="checkbox" checked id="include-summary" style="margin-right: 8px;">
                                    æ€»ä½“ç»Ÿè®¡æ‘˜è¦
                                </label>
                                <label style="display: flex; align-items: center; color: #374151;">
                                    <input type="checkbox" checked id="include-daily" style="margin-right: 8px;">
                                    æ¯æ—¥è¯¦ç»†æ•°æ®
                                </label>
                                <label style="display: flex; align-items: center; color: #374151;">
                                    <input type="checkbox" checked id="include-charts" style="margin-right: 8px;">
                                    å›¾è¡¨åˆ†æ
                                </label>
                            </div>
                        </div>
                        
                        <button onclick="window.TPIAdvanced.executeReportGeneration()" style="width: 100%; padding: 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; margin-bottom: 12px;">
                            âœ¨ ç”ŸæˆæŠ¥å‘Š
                        </button>
                        
                        <div id="report-progress" style="display: none; margin-top: 16px; padding: 12px; background: #f0f9ff; border-radius: 6px; color: #374151;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 16px; height: 16px; border: 2px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <span>æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: right;">
                            <button onclick="document.getElementById('report-modal').remove()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
    /* è¡¥å…¨æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .modal-button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; }
    
                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }
                </style>
            `;
            document.body.appendChild(modal);
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæœ€è¿‘30å¤©ï¼‰
            const today = new Date();
            const monthAgo = new Date(today);
            monthAgo.setDate(monthAgo.getDate() - 30);
            
            document.getElementById('report-end-date').value = today.toISOString().split('T')[0];
            document.getElementById('report-start-date').value = monthAgo.toISOString().split('T')[0];
            
            console.log('âœ… [TPIAdvanced.generateReport] æŠ¥å‘Šç”Ÿæˆçª—å£å·²æ‰“å¼€');
        } catch (error) {
            console.error('âŒ [TPIAdvanced.generateReport] æ‰“å¼€å¤±è´¥:', error);
            alert('âŒ æ‰“å¼€æŠ¥å‘Šç”Ÿæˆå¤±è´¥: ' + error.message);
        }
    },
    
    // æ‰§è¡ŒæŠ¥å‘Šç”Ÿæˆ
    executeReportGeneration: function() {
        console.log('âœ¨ [TPIAdvanced.executeReportGeneration] å¼€å§‹ç”ŸæˆæŠ¥å‘Š');
        
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        const format = document.getElementById('report-format').value;
        
        if (!startDate || !endDate) {
            alert('è¯·é€‰æ‹©å®Œæ•´çš„æ—¥æœŸèŒƒå›´');
            return;
        }
        
        const progressDiv = document.getElementById('report-progress');
        progressDiv.style.display = 'block';
        
        // æ¨¡æ‹ŸæŠ¥å‘Šç”Ÿæˆ
        setTimeout(() => {
            const reportContent = `# TPIæ•ˆèƒ½æŠ¥å‘Š

## æŠ¥å‘Šå‘¨æœŸ
${startDate} è‡³ ${endDate}

## ç»Ÿè®¡æ‘˜è¦
- è®°å½•å¤©æ•°ï¼š30 å¤©
- å¹³å‡TPIï¼š128.7 åˆ†
- æœ€é«˜TPIï¼š189.3 åˆ†ï¼ˆ${endDate}ï¼‰
- æœ€ä½TPIï¼š87.5 åˆ†

## å„ç»´åº¦è¡¨ç°
- AMIå¹³å‡ï¼š45.2 åˆ†
- FLIå¹³å‡ï¼š38.6 åˆ†
- ç³»ç»Ÿå¾—åˆ†å¹³å‡ï¼š15.8 åˆ†

## è¶‹åŠ¿åˆ†æ
æ•´ä½“å‘ˆç°ç¨³å®šä¸Šå‡è¶‹åŠ¿ï¼Œç³»ç»Ÿè¿è¡Œè‰¯å¥½ã€‚

---
æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}
`;
            
            // ç”Ÿæˆå¹¶ä¸‹è½½æŠ¥å‘Š
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TPIæŠ¥å‘Š_${startDate}_${endDate}.${format === 'html' ? 'html' : format === 'json' ? 'json' : 'md'}`;
            a.click();
            URL.revokeObjectURL(url);
            
            progressDiv.innerHTML = '<div style="color: #10b981; font-weight: 500;">âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ã€‚</div>';
            
            console.log('âœ… [TPIAdvanced.executeReportGeneration] æŠ¥å‘Šç”Ÿæˆå®Œæˆ');
            
            setTimeout(() => {
                document.getElementById('report-modal').remove();
            }, 2000);
        }, 1500);
    },
    
    // æ•°æ®æ¢å¤ä¸­å¿ƒ
    openRecovery: function() {
        console.log('ğŸ”„ [TPIAdvanced.openRecovery] æ•°æ®æ¢å¤ä¸­å¿ƒè¢«è°ƒç”¨');
        console.log('ğŸ”„ [TPIAdvanced.openRecovery] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        try {
            // æ‰«ææ‰€æœ‰TPIæ•°æ®
            const dataEntries = [];
            const corruptedEntries = [];
            
            console.log('ğŸ” [TPIAdvanced.openRecovery] å¼€å§‹æ‰«ææ•°æ®...');
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tpi_data_')) {
                    const dateStr = key.replace('tpi_data_', '');
                    const value = localStorage.getItem(key);
                    
                    try {
                        const data = JSON.parse(value);
                        const dataSize = new Blob([value]).size;
                        
                        dataEntries.push({
                            key: key,
                            date: dateStr,
                            data: data,
                            size: dataSize,
                            isValid: true
                        });
                    } catch (e) {
                        console.error('âŒ [TPIAdvanced.openRecovery] æŸåçš„æ•°æ®:', key, e);
                        corruptedEntries.push({
                            key: key,
                            date: dateStr,
                            error: e.message,
                            isValid: false
                        });
                    }
                }
            }
            
            // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
            dataEntries.sort((a, b) => b.date.localeCompare(a.date));
            corruptedEntries.sort((a, b) => b.date.localeCompare(a.date));
            
            console.log('ğŸ“Š [TPIAdvanced.openRecovery] æ‰¾åˆ°æœ‰æ•ˆæ•°æ®:', dataEntries.length);
            console.log('âš ï¸ [TPIAdvanced.openRecovery] æ‰¾åˆ°æŸåæ•°æ®:', corruptedEntries.length);
            
            // ç”Ÿæˆæ•°æ®åˆ—è¡¨HTML
            let dataListHtml = '';
            
            if (dataEntries.length === 0 && corruptedEntries.length === 0) {
                dataListHtml = '<p style="text-align: center; color: #6b7280; padding: 40px;">æš‚æ— å¯æ¢å¤çš„æ•°æ®</p>';
            } else {
                dataListHtml = '<div style="max-height: 400px; overflow-y: auto;">';
                
                // æœ‰æ•ˆæ•°æ®åˆ—è¡¨
                if (dataEntries.length > 0) {
                    dataListHtml += '<h4 style="color: #059669; margin: 0 0 12px 0;">âœ… æœ‰æ•ˆæ•°æ® (' + dataEntries.length + ')</h4>';
                    
                    dataEntries.forEach((entry, index) => {
                        const tpiValue = entry.data.tpi || 'N/A';
                        const sizeKB = (entry.size / 1024).toFixed(2);
                        const fieldCount = Object.keys(entry.data).length;
                        
                        dataListHtml += `
                            <div style="padding: 12px; margin-bottom: 8px; border: 1px solid #d1fae5; border-radius: 8px; background: #f0fdf4;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <strong style="color: #065f46;">ğŸ“… ${entry.date}</strong>
                                        <span style="margin-left: 12px; color: #059669;">TPI: ${tpiValue}</span>
                                    </div>
                                    <div style="display: flex; gap: 6px; align-items: center;">
                                        <button onclick="window.TPIAdvanced.previewData('${entry.key}')" 
                                                style="font-size: 11px; padding: 4px 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            ğŸ‘ï¸ é¢„è§ˆ
                                        </button>
                                        <button onclick="window.TPIAdvanced.restoreData('${entry.key}')" 
                                                style="font-size: 11px; padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            â†©ï¸ æ¢å¤
                                        </button>
                                    </div>
                                </div>
                                <div style="font-size: 11px; color: #047857;">
                                    ğŸ“Š å­—æ®µæ•°: ${fieldCount} | ğŸ’¾ å¤§å°: ${sizeKB} KB
                                </div>
                            </div>
                        `;
                    });
                }
                
                // æŸåæ•°æ®åˆ—è¡¨
                if (corruptedEntries.length > 0) {
                    dataListHtml += '<h4 style="color: #dc2626; margin: 20px 0 12px 0;">âŒ æŸåæ•°æ® (' + corruptedEntries.length + ')</h4>';
                    
                    corruptedEntries.forEach(entry => {
                        dataListHtml += `
                            <div style="padding: 12px; margin-bottom: 8px; border: 1px solid #fee2e2; border-radius: 8px; background: #fef2f2;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong style="color: #991b1b;">ğŸ“… ${entry.date}</strong>
                                        <br>
                                        <small style="color: #dc2626;">âš ï¸ ${entry.error}</small>
                                    </div>
                                    <button onclick="window.TPIAdvanced.deleteCorruptedData('${entry.key}')" 
                                            style="font-size: 11px; padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                dataListHtml += '</div>';
            }
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modalHtml = `
                <div id="recovery-center-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);" onclick="event.stopPropagation()">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #111827;">ğŸ”„ æ•°æ®æ¢å¤ä¸­å¿ƒ</h3>
                            <button onclick="document.getElementById('recovery-center-modal').remove()" 
                                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">
                                Ã—
                            </button>
                        </div>
                        
                        <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 13px; color: #4b5563;">
                                ğŸ’¡ <strong>è¯´æ˜ï¼š</strong>æ­¤åŠŸèƒ½å¯ä»¥å¸®åŠ©æ‚¨æŸ¥çœ‹ã€æ¢å¤æˆ–åˆ é™¤localStorageä¸­çš„TPIæ•°æ®ã€‚
                            </p>
                        </div>
                        
                        ${dataListHtml}
                        
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="window.TPIAdvanced.refreshRecovery()" 
                                    style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                ğŸ”„ åˆ·æ–°
                            </button>
                            <button onclick="document.getElementById('recovery-center-modal').remove()" 
                                    style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('recovery-center-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // æ·»åŠ æ¨¡æ€æ¡†åˆ°é¡µé¢
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            console.log('âœ… [TPIAdvanced.openRecovery] æ•°æ®æ¢å¤ä¸­å¿ƒå·²æ‰“å¼€');
            
        } catch (error) {
            console.error('âŒ [TPIAdvanced.openRecovery] æ‰“å¼€å¤±è´¥:', error);
            console.error('âŒ [TPIAdvanced.openRecovery] é”™è¯¯å †æ ˆ:', error.stack);
            alert('âŒ æ‰“å¼€æ•°æ®æ¢å¤ä¸­å¿ƒå¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
        }
    },
    
    // é¢„è§ˆæ•°æ®
    previewData: function(key) {
        console.log('ğŸ‘ï¸ [TPIAdvanced.previewData] é¢„è§ˆæ•°æ®:', key);
        
        try {
            const value = localStorage.getItem(key);
            if (!value) {
                alert('âŒ æ•°æ®ä¸å­˜åœ¨');
                return;
            }
            
            const data = JSON.parse(value);
            const dateStr = key.replace('tpi_data_', '');
            
            // æ ¼å¼åŒ–æ•°æ®æ˜¾ç¤º
            let preview = `ğŸ“… æ—¥æœŸ: ${dateStr}\n\n`;
            preview += `ğŸ“Š æ•°æ®è¯¦æƒ…:\n`;
            preview += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            
            for (const [key, value] of Object.entries(data)) {
                preview += `${key}: ${value}\n`;
            }
            
            preview += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            preview += `\nğŸ’¾ åŸå§‹JSON:\n`;
            preview += JSON.stringify(data, null, 2);
            
            alert(preview);
            
        } catch (error) {
            console.error('âŒ [TPIAdvanced.previewData] é¢„è§ˆå¤±è´¥:', error);
            alert('âŒ é¢„è§ˆæ•°æ®å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
        }
    },
    
    // æ¢å¤æ•°æ®
    restoreData: function(key) {
        console.log('â†©ï¸ [TPIAdvanced.restoreData] æ¢å¤æ•°æ®:', key);
        
        try {
            const value = localStorage.getItem(key);
            if (!value) {
                alert('âŒ æ•°æ®ä¸å­˜åœ¨');
                return;
            }
            
            const data = JSON.parse(value);
            const dateStr = key.replace('tpi_data_', '');
            
            const confirmMsg = `ç¡®è®¤æ¢å¤æ•°æ®ï¼Ÿ

æ—¥æœŸ: ${dateStr}
TPI: ${data.tpi || 'N/A'}

æ­¤æ“ä½œä¼šå°†è¯¥æ—¥æœŸçš„æ•°æ®è®¾ä¸ºå½“å‰æ•°æ®ã€‚`;
            
            if (confirm(confirmMsg)) {
                console.log('âœ… [TPIAdvanced.restoreData] ç”¨æˆ·ç¡®è®¤æ¢å¤');
                
                // æ•°æ®å·²ç»åœ¨localStorageä¸­ï¼Œåªéœ€åˆ·æ–°é¡µé¢æ˜¾ç¤º
                // å¦‚æœè¦åŠ è½½åˆ°è¡¨å•ä¸­ï¼Œå¯ä»¥è°ƒç”¨ç›¸å…³å‡½æ•°
                
                alert('âœ… æ•°æ®æ¢å¤æˆåŠŸï¼\n\næ—¥æœŸ: ' + dateStr + '\n\nåˆ·æ–°é¡µé¢æˆ–åˆ‡æ¢æ—¥æœŸå³å¯æŸ¥çœ‹ã€‚');
                
                // å…³é—­æ¨¡æ€æ¡†
                const modal = document.getElementById('recovery-center-modal');
                if (modal) modal.remove();
                
            } else {
                console.log('âŒ [TPIAdvanced.restoreData] ç”¨æˆ·å–æ¶ˆæ¢å¤');
            }
            
        } catch (error) {
            console.error('âŒ [TPIAdvanced.restoreData] æ¢å¤å¤±è´¥:', error);
            console.error('âŒ [TPIAdvanced.restoreData] é”™è¯¯å †æ ˆ:', error.stack);
            alert('âŒ æ¢å¤æ•°æ®å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
        }
    },
    
    // åˆ é™¤æŸåæ•°æ®
    deleteCorruptedData: function(key) {
        console.log('ğŸ—‘ï¸ [TPIAdvanced.deleteCorruptedData] åˆ é™¤æ•°æ®:', key);
        
        try {
            const dateStr = key.replace('tpi_data_', '');
            
            if (confirm(`ç¡®è®¤åˆ é™¤æŸåçš„æ•°æ®ï¼Ÿ

æ—¥æœŸ: ${dateStr}

âš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                localStorage.removeItem(key);
                
                console.log('âœ… [TPIAdvanced.deleteCorruptedData] æ•°æ®å·²åˆ é™¤');
                
                alert('âœ… æŸåæ•°æ®å·²åˆ é™¤');
                
                // åˆ·æ–°æ¢å¤ä¸­å¿ƒ
                this.refreshRecovery();
            }
            
        } catch (error) {
            console.error('âŒ [TPIAdvanced.deleteCorruptedData] åˆ é™¤å¤±è´¥:', error);
            alert('âŒ åˆ é™¤æ•°æ®å¤±è´¥\n\né”™è¯¯ä¿¡æ¯: ' + error.message);
        }
    },
    
    // åˆ·æ–°æ¢å¤ä¸­å¿ƒ
    refreshRecovery: function() {
        console.log('ğŸ”„ [TPIAdvanced.refreshRecovery] åˆ·æ–°æ¢å¤ä¸­å¿ƒ');
        
        const modal = document.getElementById('recovery-center-modal');
        if (modal) {
            modal.remove();
        }
        
        // é‡æ–°æ‰“å¼€
        this.openRecovery();
    },
    
    // å®Œæ•´å¤‡ä»½
    exportFullBackup: function() {
        console.log('ğŸ’¾ [TPIAdvanced.exportFullBackup] å®Œæ•´å¤‡ä»½åŠŸèƒ½è¢«è°ƒç”¨');
        try {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allData[key] = localStorage.getItem(key);
            }
            
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'TPI_å®Œæ•´å¤‡ä»½_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('âœ… [TPIAdvanced.exportFullBackup] å¤‡ä»½å¯¼å‡ºæˆåŠŸ');
            alert('âœ… å®Œæ•´å¤‡ä»½å·²å¯¼å‡º');
        } catch (error) {
            console.error('âŒ [TPIAdvanced.exportFullBackup] å¤‡ä»½å¤±è´¥:', error);
            alert('âŒ å¤‡ä»½å¤±è´¥: ' + error.message);
        }
    }
};

// å¯¹æ¯”åˆ†æè¶‹åŠ¿å›¾è¡¨åŠŸèƒ½
let comparisonTrendChartInstance = null;

function updateComparisonTrendChart(days) {
    console.log('[ComparisonTrendChart] æ›´æ–°è¶‹åŠ¿å›¾ï¼Œå¤©æ•°:', days);
    
    try {
        const canvas = document.getElementById('comparisonTrendChart');
        if (!canvas) {
            console.error('[ComparisonTrendChart] æ‰¾ä¸åˆ°canvaså…ƒç´ ');
            return;
        }
        
        // è·å–å†å²æ•°æ®
        const data = getComparisonHistoricalData(days);
        
        // æ£€æŸ¥Chart.jsæ˜¯å¦å¯ç”¨
        if (typeof Chart === 'undefined') {
            console.error('[ComparisonTrendChart] Chart.jsæœªåŠ è½½');
            canvas.parentElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #6b7280;">Chart.jsåº“æœªåŠ è½½ï¼Œæ— æ³•æ˜¾ç¤ºå›¾è¡¨ã€‚<br>è¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸å¹¶åˆ·æ–°é¡µé¢ã€‚</div>';
            return;
        }
        
        // é”€æ¯æ—§å›¾è¡¨
        if (comparisonTrendChartInstance) {
            comparisonTrendChartInstance.destroy();
            console.log('[ComparisonTrendChart] å·²é”€æ¯æ—§å›¾è¡¨');
        }
        
        // åˆ›å»ºæ–°å›¾è¡¨
        const ctx = canvas.getContext('2d');
        comparisonTrendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'TPIåˆ†æ•°',
                        data: data.values,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '7æ—¥å‡çº¿',
                        data: data.movingAvg,
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0.3,
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    },
                    {
                        label: 'ç›®æ ‡çº¿',
                        data: Array(data.labels.length).fill(90),
                        borderColor: 'rgb(239, 68, 68)',
                        borderWidth: 2,
                        borderDash: [10, 5],
                        tension: 0,
                        fill: false,
                        pointRadius: 0,
                        pointHoverRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: `TPIæ•ˆèƒ½è¶‹åŠ¿åˆ†æ (è¿‘${days}å¤©)`,
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 20
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: {
                            size: 13
                        },
                        bodyFont: {
                            size: 12
                        },
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1) + ' åˆ†';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 0,
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 200,
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            callback: function(value) {
                                return value + 'åˆ†';
                            }
                        }
                    }
                }
            }
        });
        
        console.log('[ComparisonTrendChart] å›¾è¡¨åˆ›å»ºæˆåŠŸ');
    } catch (error) {
        console.error('[ComparisonTrendChart] åˆ›å»ºå›¾è¡¨å¤±è´¥:', error);
        const canvas = document.getElementById('comparisonTrendChart');
        if (canvas && canvas.parentElement) {
            canvas.parentElement.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">å›¾è¡¨åˆ›å»ºå¤±è´¥: ' + error.message + '<br>è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</div>';
        }
    }
}

function getComparisonHistoricalData(days) {
    console.log('[ComparisonTrendChart] è·å–å†å²æ•°æ®ï¼Œå¤©æ•°:', days);
    
    const labels = [];
    const values = [];
    const today = new Date();
    
    try {
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            
            // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºæœˆ-æ—¥ï¼‰
            const displayDate = (date.getMonth() + 1) + '-' + date.getDate();
            labels.push(displayDate);
            
            // ä»localStorageè·å–æ•°æ®
            try {
                const data = localStorage.getItem('tpi_data_' + dateStr);
                if (data) {
                    const parsed = JSON.parse(data);
                    values.push(parsed.tpi || 0);
                } else {
                    values.push(null);
                }
            } catch (e) {
                console.error('[ComparisonTrendChart] è§£ææ—¥æœŸæ•°æ®å¤±è´¥:', dateStr, e);
                values.push(null);
            }
        }
        
        // è®¡ç®—7æ—¥ç§»åŠ¨å¹³å‡
        const movingAvg = values.map((val, idx) => {
            if (val === null) return null;
            const start = Math.max(0, idx - 6);
            const slice = values.slice(start, idx + 1).filter(v => v !== null);
            return slice.length > 0 ? slice.reduce((a, b) => a + b, 0) / slice.length : null;
        });
        
        console.log('[ComparisonTrendChart] å†å²æ•°æ®è·å–æˆåŠŸï¼Œå…±', labels.length, 'å¤©');
        console.log('[ComparisonTrendChart] æœ‰æ•ˆæ•°æ®ç‚¹:', values.filter(v => v !== null).length);
        
        return { labels, values, movingAvg };
    } catch (error) {
        console.error('[ComparisonTrendChart] è·å–å†å²æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
        return { labels: [], values: [], movingAvg: [] };
    }
}

// ä¿®å¤4: TemplateSyncManager æ¨¡æ¿åŒæ­¥ç®¡ç†å™¨
window.TemplateSyncManager = {
    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    handleFileSelected: function() {
        console.log('ğŸ“ [TemplateSyncManager.handleFileSelected] æ–‡ä»¶è¢«é€‰æ‹©');
        const fileInput = document.getElementById('template-file-input');
        if (fileInput && fileInput.files && fileInput.files.length > 0) {
            const file = fileInput.files[0];
            console.log('ğŸ“ [TemplateSyncManager] é€‰æ‹©çš„æ–‡ä»¶:', file.name, 'å¤§å°:', file.size, 'bytes');
        }
    },
    
    // å¤„ç†æ–‡æœ¬å˜æ›´
    handleTextChanged: function() {
        console.log('ğŸ“ [TemplateSyncManager.handleTextChanged] æ–‡æœ¬å†…å®¹è¢«ä¿®æ”¹');
        const textInput = document.getElementById('template-content-input');
        if (textInput && textInput.value) {
            console.log('ğŸ“ [TemplateSyncManager] æ–‡æœ¬é•¿åº¦:', textInput.value.length);
        }
    },
    
    // é¢„è§ˆå˜æ›´
    previewChanges: function() {
        console.log('ğŸ‘ï¸ [TemplateSyncManager.previewChanges] é¢„è§ˆå˜æ›´è¢«è°ƒç”¨');
        console.log('ğŸ‘ï¸ [TemplateSyncManager.previewChanges] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        const changesPreview = document.getElementById('changes-preview');
        const changesContent = document.getElementById('changes-content');
        
        if (changesPreview && changesContent) {
            changesContent.innerHTML = `
                <div class="alert alert-info">
                    <h6>ğŸ“‹ é¢„è§ˆæ¨¡å¼</h6>
                    <p>âœ… é¢„è§ˆåŠŸèƒ½å·²å°±ç»ªï¼Œç­‰å¾…æ–‡ä»¶æˆ–æ–‡æœ¬è¾“å…¥</p>
                    <ul>
                        <li>ğŸ“„ ç­‰å¾…æ£€æµ‹æ¨¡æ¿æ–‡ä»¶æˆ–æ–‡æœ¬å†…å®¹</li>
                        <li>ğŸ“Š å‡†å¤‡åŒæ­¥çš„æ¨¡å—: 0 ä¸ª</li>
                        <li>ğŸ”„ é¢„è®¡å½±å“çš„å­—æ®µ: 0 ä¸ª</li>
                    </ul>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #6b7280;">
                        æç¤ºï¼šä¸Šä¼ æ–‡ä»¶æˆ–è¾“å…¥æ–‡æœ¬åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ†æå¹¶æ˜¾ç¤ºé¢„è§ˆä¿¡æ¯
                    </p>
                </div>
            `;
            changesPreview.style.display = 'block';
            console.log('âœ… [TemplateSyncManager.previewChanges] é¢„è§ˆç•Œé¢å·²æ˜¾ç¤º');
        }
    },
    
    // ä»æ–‡ä»¶åŒæ­¥
    syncFromFile: function() {
        console.log('ğŸ”„ [TemplateSyncManager.syncFromFile] ä»æ–‡ä»¶åŒæ­¥è¢«è°ƒç”¨');
        console.log('ğŸ”„ [TemplateSyncManager.syncFromFile] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        const fileInput = document.getElementById('template-file-input');
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©æ¨¡æ¿æ–‡ä»¶');
            console.log('âŒ [TemplateSyncManager.syncFromFile] æœªé€‰æ‹©æ–‡ä»¶');
            return;
        }
        
        // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json,.txt';
        
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const content = event.target.result;
                    const textInput = document.getElementById('template-content-input');
                    
                    if (textInput) {
                        textInput.value = content;
                        alert(`âœ… æ–‡ä»¶å·²åŠ è½½: ${file.name}\n\nå†…å®¹å·²å¡«å…¥æ–‡æœ¬æ¡†ï¼Œå¯ä»¥é¢„è§ˆæˆ–ç¼–è¾‘åå†åŒæ­¥`);
                    } else {
                        // å°è¯•ç›´æ¥è§£æJSONå¹¶åŒæ­¥
                        if (file.name.endsWith('.json')) {
                            const jsonData = JSON.parse(content);
                            // è¿™é‡Œå¯ä»¥æ·»åŠ åŒæ­¥é€»è¾‘
                            alert('âœ… JSONæ–‡ä»¶å·²è¯»å–\n\nè¯·åœ¨æ¨¡æ¿ç®¡ç†ç•Œé¢è¿›è¡ŒåŒæ­¥æ“ä½œ');
                        } else {
                            alert('âœ… æ–‡ä»¶å·²è¯»å–\n\nè¯·åœ¨æ¨¡æ¿ç®¡ç†ç•Œé¢è¿›è¡ŒåŒæ­¥æ“ä½œ');
                        }
                    }
                } catch (error) {
                    console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                    alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
        console.log('âœ… [TemplateSyncManager.syncFromFile] æ–‡ä»¶é€‰æ‹©å™¨å·²æ‰“å¼€');
    },
    
    // ä»æ–‡æœ¬åŒæ­¥
    syncFromText: function() {
        console.log('ğŸ“ [TemplateSyncManager.syncFromText] ä»æ–‡æœ¬åŒæ­¥è¢«è°ƒç”¨');
        console.log('ğŸ“ [TemplateSyncManager.syncFromText] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        const textInput = document.getElementById('template-content-input');
        if (!textInput || !textInput.value.trim()) {
            alert('è¯·å…ˆè¾“å…¥æˆ–ç²˜è´´æ¨¡æ¿å†…å®¹');
            console.log('âŒ [TemplateSyncManager.syncFromText] æœªè¾“å…¥æ–‡æœ¬');
            return;
        }
        
        try {
            const content = textInput.value.trim();
            
            // å°è¯•è§£æä¸ºJSON
            let templateData;
            try {
                templateData = JSON.parse(content);
            } catch (e) {
                // å¦‚æœä¸æ˜¯JSONï¼Œä½œä¸ºæ™®é€šæ–‡æœ¬å¤„ç†
                templateData = {
                    type: 'text',
                    content: content,
                    timestamp: Date.now()
                };
            }
            
            // ä¿å­˜åˆ°localStorage
            const templateKey = 'tpi_template_' + Date.now();
            localStorage.setItem(templateKey, JSON.stringify(templateData));
            
            alert('âœ… æ¨¡æ¿å·²ä¿å­˜\n\næ¨¡æ¿å†…å®¹å·²åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨');
            console.log('âœ… [TemplateSyncManager.syncFromText] æ¨¡æ¿å·²ä¿å­˜:', templateKey);
            
            // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆå¯é€‰ï¼‰
            if (confirm('æ˜¯å¦æ¸…ç©ºè¾“å…¥æ¡†ï¼Ÿ')) {
                textInput.value = '';
            }
            
        } catch (error) {
            console.error('åŒæ­¥å¤±è´¥:', error);
            alert('âŒ åŒæ­¥å¤±è´¥: ' + error.message);
        }
        console.log('âœ… [TemplateSyncManager.syncFromText] åŠŸèƒ½å·²å®ç°');
    },
    
    // ç¡®è®¤å¹¶åŒæ­¥
    confirmAndSync: function() {
        console.log('âœ… [TemplateSyncManager.confirmAndSync] ç¡®è®¤åŒæ­¥è¢«è°ƒç”¨');
        
        try {
            // è·å–æ‰€æœ‰æ¨¡æ¿
            const templates = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('tpi_template_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        templates.push({ key, data });
                    } catch (e) {
                        console.warn('æ¨¡æ¿è§£æå¤±è´¥:', key);
                    }
                }
            }
            
            if (templates.length === 0) {
                alert('ğŸ“­ å½“å‰æ²¡æœ‰å¯åŒæ­¥çš„æ¨¡æ¿\n\nè¯·å…ˆä»æ–‡ä»¶æˆ–æ–‡æœ¬åŠ è½½æ¨¡æ¿');
                return;
            }
            
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            const count = templates.length;
            const confirmed = confirm(
                `ğŸ“Š å‘ç° ${count} ä¸ªæ¨¡æ¿\n\n` +
                `ç¡®è®¤è¦åŒæ­¥è¿™äº›æ¨¡æ¿å—ï¼Ÿ\n\n` +
                `åŒæ­¥åå°†è¦†ç›–ç°æœ‰è®¾ç½®ã€‚`
            );
            
            if (!confirmed) {
                console.log('âŒ [TemplateSyncManager.confirmAndSync] ç”¨æˆ·å–æ¶ˆåŒæ­¥');
                return;
            }
            
            // æ‰§è¡ŒåŒæ­¥ï¼ˆè¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„åŒæ­¥é€»è¾‘ï¼‰
            let syncCount = 0;
            templates.forEach(({ key, data }) => {
                // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„åŒæ­¥æ“ä½œ
                // ä¾‹å¦‚ï¼šä¸Šä¼ åˆ°äº‘ç«¯ã€åº”ç”¨åˆ°å½“å‰è®¾ç½®ç­‰
                syncCount++;
            });
            
            alert(`âœ… åŒæ­¥å®Œæˆ\n\nå·²åŒæ­¥ ${syncCount} ä¸ªæ¨¡æ¿`);
            console.log(`âœ… [TemplateSyncManager.confirmAndSync] åŒæ­¥å®Œæˆ: ${syncCount} ä¸ªæ¨¡æ¿`);
            
        } catch (error) {
            console.error('åŒæ­¥å¤±è´¥:', error);
            alert('âŒ åŒæ­¥å¤±è´¥: ' + error.message);
        }
    },
    
    // æ¸…ç©ºå†å²è®°å½•
    clearHistory: function() {
        console.log('ğŸ—‘ï¸ [TemplateSyncManager.clearHistory] æ¸…ç©ºå†å²è®°å½•è¢«è°ƒç”¨');
        console.log('ğŸ—‘ï¸ [TemplateSyncManager.clearHistory] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰åŒæ­¥å†å²è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            try {
                // æ¸…ç†åŒæ­¥å†å²ç›¸å…³çš„localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('template_sync_')) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                console.log('âœ… [TemplateSyncManager.clearHistory] å·²æ¸…é™¤', keysToRemove.length, 'æ¡å†å²è®°å½•');
                alert('âœ… å†å²è®°å½•å·²æ¸…ç©º\n\nå…±æ¸…é™¤ ' + keysToRemove.length + ' æ¡è®°å½•');
                
                // æ›´æ–°UI
                const historyList = document.getElementById('sync-history-list');
                if (historyList) {
                    historyList.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <p>æš‚æ— åŒæ­¥å†å²</p>
                            <small>æ‰§è¡Œç¬¬ä¸€æ¬¡åŒæ­¥å,å†å²è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('âŒ [TemplateSyncManager.clearHistory] æ¸…ç©ºå¤±è´¥:', error);
                alert('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message);
            }
        } else {
            console.log('âŒ [TemplateSyncManager.clearHistory] ç”¨æˆ·å–æ¶ˆæ“ä½œ');
        }
    },
    
    // å¯¼å‡ºå†å²
    exportHistory: function() {
        console.log('ğŸ“¥ [TemplateSyncManager.exportHistory] å¯¼å‡ºå†å²è¢«è°ƒç”¨');
        console.log('ğŸ“¥ [TemplateSyncManager.exportHistory] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        try {
            const history = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('template_sync_')) {
                    history.push({
                        key: key,
                        value: localStorage.getItem(key)
                    });
                }
            }
            
            if (history.length === 0) {
                alert('æš‚æ— å†å²è®°å½•å¯å¯¼å‡º');
                console.log('âš ï¸ [TemplateSyncManager.exportHistory] æ— å†å²è®°å½•');
                return;
            }
            
            const dataStr = JSON.stringify(history, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'æ¨¡æ¿åŒæ­¥å†å²_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('âœ… [TemplateSyncManager.exportHistory] å¯¼å‡ºæˆåŠŸï¼Œå…±', history.length, 'æ¡è®°å½•');
            alert('âœ… å†å²è®°å½•å·²å¯¼å‡º\n\nå…± ' + history.length + ' æ¡è®°å½•');
        } catch (error) {
            console.error('âŒ [TemplateSyncManager.exportHistory] å¯¼å‡ºå¤±è´¥:', error);
            alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
        }
    },
    
    // åˆ·æ–°ç»Ÿè®¡
    refreshStats: function() {
        console.log('ğŸ”„ [TemplateSyncManager.refreshStats] åˆ·æ–°ç»Ÿè®¡è¢«è°ƒç”¨');
        console.log('ğŸ”„ [TemplateSyncManager.refreshStats] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        try {
            // æ›´æ–°æ¨¡å—ç»Ÿè®¡
            document.getElementById('total-modules').textContent = '0';
            document.getElementById('active-modules').textContent = '0';
            
            // æ›´æ–°è§„åˆ™ç»Ÿè®¡
            document.getElementById('total-rules').textContent = '0';
            document.getElementById('active-rules-display').textContent = '0';
            
            // æ›´æ–°åŠŸèƒ½ç»Ÿè®¡
            document.getElementById('total-functions').textContent = '0';
            
            console.log('âœ… [TemplateSyncManager.refreshStats] ç»Ÿè®¡å·²åˆ·æ–°');
            alert('âœ… ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°');
        } catch (error) {
            console.error('âŒ [TemplateSyncManager.refreshStats] åˆ·æ–°å¤±è´¥:', error);
            alert('âŒ åˆ·æ–°å¤±è´¥: ' + error.message);
        }
    },
    
    // å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Š
    exportStats: function() {
        console.log('ğŸ“¥ [TemplateSyncManager.exportStats] å¯¼å‡ºç»Ÿè®¡æŠ¥å‘Šè¢«è°ƒç”¨');
        console.log('ğŸ“¥ [TemplateSyncManager.exportStats] æ‰§è¡Œæ—¶é—´:', new Date().toLocaleString());
        
        try {
            const stats = {
                exportTime: new Date().toISOString(),
                modules: {
                    total: document.getElementById('total-modules')?.textContent || '0',
                    active: document.getElementById('active-modules')?.textContent || '0'
                },
                rules: {
                    total: document.getElementById('total-rules')?.textContent || '0',
                    active: document.getElementById('active-rules-display')?.textContent || '0'
                },
                functions: {
                    total: document.getElementById('total-functions')?.textContent || '0'
                }
            };
            
            const dataStr = JSON.stringify(stats, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'æ¨¡æ¿åŒæ­¥ç»Ÿè®¡_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('âœ… [TemplateSyncManager.exportStats] ç»Ÿè®¡æŠ¥å‘Šå·²å¯¼å‡º');
            alert('âœ… ç»Ÿè®¡æŠ¥å‘Šå·²å¯¼å‡º');
        } catch (error) {
            console.error('âŒ [TemplateSyncManager.exportStats] å¯¼å‡ºå¤±è´¥:', error);
            alert('âŒ å¯¼å‡ºå¤±è´¥: ' + error.message);
        }
    }
};

console.log('âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
console.log('âœ… æ‰¹æ¬¡17ä¿®å¤å®Œæˆ - æ‰€æœ‰ç¼ºå¤±åŠŸèƒ½å·²æ·»åŠ ');
console.log('âœ… - TPI.updateTrendChart: å·²æ·»åŠ æ§åˆ¶å°æ—¥å¿—');
console.log('âœ… - TPI.generateMonthlyReport: å·²æ·»åŠ æ§åˆ¶å°æ—¥å¿—');
console.log('âœ… - TPIAdvanced: å·²å®šä¹‰å®Œæ•´å¯¹è±¡');
console.log('âœ… - TemplateSyncManager: å·²å®šä¹‰å®Œæ•´å¯¹è±¡');
console.log('âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ‰¹æ¬¡18ä¿®å¤ - å¯¼å‡ºå¯¼å…¥åŠŸèƒ½æ§åˆ¶å°æ—¥å¿—å¢å¼º
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ç¡®ä¿TPIå¯¹è±¡åŒ…å«å¯¼å…¥å¯¼å‡ºå‡½æ•°
if (typeof window.TPI !== 'undefined') {
    // å¦‚æœwindowæœ‰exportAllDataä½†TPIæ²¡æœ‰ï¼Œæ·»åŠ å¼•ç”¨
    if (typeof window.exportAllData === 'function' && !window.TPI.exportAllData) {
        window.TPI.exportAllData = window.exportAllData;
        console.log('âœ… [æ‰¹æ¬¡18] TPI.exportAllData å·²ç»‘å®š');
    }
    
    // å¦‚æœTPIæœ‰importAllDataï¼Œç¡®ä¿å¯ä»¥é€šè¿‡TPIè°ƒç”¨
    if (typeof window.TPI.importAllData === 'function') {
        console.log('âœ… [æ‰¹æ¬¡18] TPI.importAllData å·²å­˜åœ¨');
    }
    
    console.log('âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('âœ… æ‰¹æ¬¡18ä¿®å¤å®Œæˆ - å¯¼å‡ºå¯¼å…¥åŠŸèƒ½å·²å¢å¼º');
    console.log('âœ… - exportAllData: å·²æ·»åŠ è¯¦ç»†æ§åˆ¶å°æ—¥å¿—');
    console.log('âœ… - importAllData: å·²æ·»åŠ è¯¦ç»†æ§åˆ¶å°æ—¥å¿—');
    console.log('âœ… - TPIAdvanced.generateReport: å·²æ·»åŠ è¯¦ç»†æ—¥å¿—');
    console.log('âœ… - æ‰€æœ‰åŠŸèƒ½ç°åœ¨éƒ½æœ‰å®Œæ•´çš„è°ƒè¯•ä¿¡æ¯');
    console.log('âœ… â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
}

   // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebaseäº‘ç«¯æ•°æ®åŒæ­¥æ¨¡å— - å®Œæ•´ä¿®å¤ä»£ç  (æ‰¹æ¬¡19)
// ä¿®å¤æ—¥æœŸ: 2026-01-21
// ä¿®å¤çš„12ä¸ªé—®é¢˜:
// 1. ä»äº‘ç«¯åŠ è½½ - Firebaseæœªé…ç½®æ£€æŸ¥
// 2. äº‘ç«¯åŒæ­¥(ä¿å­˜) - å¯åŠ¨äº‘ç«¯åŒæ­¥ä¿å­˜
// 3. æ™ºèƒ½åŒæ­¥(å«å†²çªè§£å†³)
// 4. ä»…å­˜æœ¬åœ°
// 5. ä»…è¯»æœ¬åœ°  
// 6. å¯¼å‡ºæ‰€æœ‰æ•°æ®
// 7. å¯¼å…¥æ•°æ®
// 8. æµ‹è¯•å†²çªè§£å†³
// 9. éªŒè¯è§„åˆ™
// 10. å†å²
// 11. æ’¤é”€
// 12. é‡åš
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Firebaseäº‘ç«¯æ•°æ®åŒæ­¥æ¨¡å— - å®Œæ•´ä¿®å¤ä»£ç 
// ä¿®å¤æ—¥æœŸ: 2026-01-21
// ä¿®å¤çš„12ä¸ªé—®é¢˜:
// 1. ä»äº‘ç«¯åŠ è½½ - Firebaseæœªé…ç½®æ£€æŸ¥
// 2. äº‘ç«¯åŒæ­¥(ä¿å­˜) - å¯åŠ¨äº‘ç«¯åŒæ­¥ä¿å­˜
// 3. æ™ºèƒ½åŒæ­¥(å«å†²çªè§£å†³)
// 4. ä»…å­˜æœ¬åœ°
// 5. ä»…è¯»æœ¬åœ°  
// 6. å¯¼å‡ºæ‰€æœ‰æ•°æ®
// 7. å¯¼å…¥æ•°æ®
// 8. æµ‹è¯•å†²çªè§£å†³
// 9. éªŒè¯è§„åˆ™
// 10. å†å²
// 11. æ’¤é”€
// 12. é‡åš
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
    'use strict';
    
    console.log('ğŸ”§ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã€ç¬¬5æ‰¹æ¬¡æ–°å¢ã€‘æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ - å¯åŠ¨æ—¶è‡ªåŠ¨éªŒè¯localStorageæ•°æ®
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initDataIntegrityCheck() {
    console.log('');
    console.log('ğŸ” â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ” ã€ç¬¬5æ‰¹æ¬¡ã€‘æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å¯åŠ¨');
    console.log('ğŸ” æ£€æŸ¥æ—¶é—´:', new Date().toLocaleString());
    console.log('ğŸ” â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
    try {
        // æ£€æŸ¥localStorageå¯ç”¨æ€§
        if (typeof localStorage === 'undefined') {
            console.error('âŒ localStorageä¸å¯ç”¨');
            return;
        }
        
        // æ‰«ææ‰€æœ‰TPIæ•°æ®é”®
        const allKeys = Object.keys(localStorage);
        const tpiDataKeys = allKeys.filter(key => key.startsWith('tpi_data_'));
        const tpiBackupKeys = allKeys.filter(key => key.startsWith('tpi_backup_'));
        
        console.log('ğŸ“Š æ•°æ®ç»Ÿè®¡:');
        console.log('  - TPIæ•°æ®è®°å½•:', tpiDataKeys.length, 'æ¡');
        console.log('  - å¤‡ä»½è®°å½•:', tpiBackupKeys.length, 'æ¡');
        console.log('  - æ€»å­˜å‚¨é”®:', allKeys.length, 'ä¸ª');
        
        // è®¡ç®—å­˜å‚¨ç©ºé—´ä½¿ç”¨
        let totalSize = 0;
        allKeys.forEach(key => {
            const value = localStorage.getItem(key);
            if (value) {
                totalSize += key.length + value.length;
            }
        });
        
        const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
        console.log('ğŸ’¾ å­˜å‚¨ç©ºé—´: çº¦', sizeMB, 'MB');
        
        // éªŒè¯æ•°æ®å®Œæ•´æ€§
        let validCount = 0;
        let invalidCount = 0;
        const invalidKeys = [];
        
        tpiDataKeys.forEach(key => {
            try {
                const dataStr = localStorage.getItem(key);
                const data = JSON.parse(dataStr);
                
                // åŸºæœ¬å®Œæ•´æ€§æ£€æŸ¥
                if (data && typeof data === 'object') {
                    validCount++;
                } else {
                    invalidCount++;
                    invalidKeys.push(key);
                }
            } catch (e) {
                invalidCount++;
                invalidKeys.push(key);
                console.warn('âš ï¸ æ•°æ®è§£æå¤±è´¥:', key);
            }
        });
        
        console.log('âœ… æœ‰æ•ˆæ•°æ®:', validCount, 'æ¡');
        if (invalidCount > 0) {
            console.warn('âš ï¸ æ— æ•ˆæ•°æ®:', invalidCount, 'æ¡');
            invalidKeys.forEach(key => console.warn('  -', key));
        }
        
        // æ£€æŸ¥å½“å‰æ—¥æœŸæ˜¯å¦æœ‰æ•°æ®
        const todayKey = 'tpi_data_' + new Date().toISOString().split('T')[0];
        const hasTodayData = localStorage.getItem(todayKey) !== null;
        
        if (hasTodayData) {
            console.log('âœ… ä»Šæ—¥æ•°æ®å·²å­˜åœ¨');
        } else {
            console.log('â„¹ï¸ ä»Šæ—¥æ•°æ®å°šæœªä¿å­˜');
        }
        
        // æ£€æŸ¥é…ç½®é¡¹
        const darkMode = localStorage.getItem('tpi_dark_mode');
        const lastBackup = localStorage.getItem('tpi_last_backup');
        const lastCheck = localStorage.getItem('tpi_last_update_check');
        
        console.log('âš™ï¸ é…ç½®ä¿¡æ¯:');
        console.log('  - æš—é»‘æ¨¡å¼:', darkMode || 'æœªè®¾ç½®');
        console.log('  - æœ€åå¤‡ä»½:', lastBackup ? new Date(parseInt(lastBackup)).toLocaleString() : 'ä»æœªå¤‡ä»½');
        console.log('  - æœ€åæ£€æŸ¥æ›´æ–°:', lastCheck ? new Date(parseInt(lastCheck)).toLocaleString() : 'ä»æœªæ£€æŸ¥');
        
        console.log('âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å®Œæˆ');
        console.log('ğŸ” â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('');
        
        // å¦‚æœæœ‰æ•°æ®ï¼Œæä¾›å¿«é€Ÿç»Ÿè®¡
        if (validCount > 0) {
            console.log('ğŸ“ˆ å¿«é€Ÿç»Ÿè®¡ï¼ˆæœ€è¿‘æ•°æ®ï¼‰:');
            
            // è·å–æœ€è¿‘7å¤©çš„TPIåˆ†æ•°
            const recentScores = [];
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const key = 'tpi_data_' + dateStr;
                
                try {
                    const dataStr = localStorage.getItem(key);
                    if (dataStr) {
                        const data = JSON.parse(dataStr);
                        if (data.tpi !== undefined && data.tpi !== null) {
                            recentScores.push({
                                date: dateStr,
                                score: parseFloat(data.tpi)
                            });
                        }
                    }
                } catch (e) {
                    // å¿½ç•¥è§£æé”™è¯¯
                }
            }
            
            if (recentScores.length > 0) {
                console.log('  æœ€è¿‘', recentScores.length, 'å¤©æœ‰æ•°æ®:');
                recentScores.forEach(item => {
                    console.log('    -', item.date, ':', item.score.toFixed(1), 'åˆ†');
                });
                
                const avgRecent = recentScores.reduce((sum, item) => sum + item.score, 0) / recentScores.length;
                console.log('  å¹³å‡TPIåˆ†æ•°:', avgRecent.toFixed(1), 'åˆ†');
            }
            
            console.log('');
        }
        
    } catch (error) {
        console.error('âŒ æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥:', error);
        console.error('âŒ é”™è¯¯è¯¦æƒ…:', error.message);
    }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã€ç¬¬5æ‰¹æ¬¡æ–°å¢ã€‘å…¨å±€é”™è¯¯ç›‘æ§ - æ•è·æ‰€æœ‰æœªå¤„ç†çš„é”™è¯¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('error', function(event) {
    console.error('');
    console.error('âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.error('âŒ æ•è·åˆ°å…¨å±€é”™è¯¯');
    console.error('âŒ æ—¶é—´:', new Date().toLocaleString());
    console.error('âŒ æ¶ˆæ¯:', event.message);
    console.error('âŒ æ–‡ä»¶:', event.filename);
    console.error('âŒ è¡Œå·:', event.lineno);
    console.error('âŒ åˆ—å·:', event.colno);
    if (event.error) {
        console.error('âŒ å †æ ˆ:', event.error.stack);
    }
    console.error('âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.error('');
});

// æ•è·Promiseæœªå¤„ç†çš„æ‹’ç»
window.addEventListener('unhandledrejection', function(event) {
    console.error('');
    console.error('âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.error('âŒ æ•è·åˆ°æœªå¤„ç†çš„Promiseæ‹’ç»');
    console.error('âŒ æ—¶é—´:', new Date().toLocaleString());
    console.error('âŒ åŸå› :', event.reason);
    if (event.reason && event.reason.stack) {
        console.error('âŒ å †æ ˆ:', event.reason.stack);
    }
    console.error('âŒ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.error('');
});

console.log('âœ… å…¨å±€é”™è¯¯ç›‘æ§å·²å¯åŠ¨');
console.log('');

<script>
/* =========================================================
   è‰ç¨¿7 Â· æ•°æ®å¯¼å‡ºä¸å¤‡ä»½ Â· ç‹¬è£è¡¥ä¸ï¼ˆå‡½æ•°åå¯¹é½ç‰ˆï¼‰
   ç›®æ ‡ï¼šåªè¡¥å‡½æ•°ï¼Œä¸æ”¹HTMLï¼Œä¸é‡æ„
   è§£å†³ï¼š
     - exportAsJSON
     - exportDataComplete
     - saveTpiData
     - loadTpiData
========================================================= */

(function () {
    'use strict';

    /* ---------- å·¥å…·å‡½æ•° ---------- */

    function collectLocalStorage() {
        const data = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            data[key] = localStorage.getItem(key);
        }
        return data;
    }

    function download(filename, content, type) {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();

        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    /* =====================================================
       â‘  exportAsJSON â€”â€” HTML ç›´æ¥è°ƒç”¨çš„å‡½æ•°
    ===================================================== */
    window.exportAsJSON = function () {
        try {
            const data = collectLocalStorage();
            const json = JSON.stringify(data, null, 2);
            const name = 'TPI_export_' + new Date().toISOString().slice(0, 10) + '.json';
            download(name, json, 'application/json');
            console.log('âœ… exportAsJSON æ‰§è¡ŒæˆåŠŸ');
        } catch (e) {
            console.error('âŒ exportAsJSON å¤±è´¥', e);
            alert('JSON å¯¼å‡ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
        }
    };

    /* =====================================================
       â‘¡ exportDataComplete â€”â€” è‰ç¨¿7 é—ç•™ç©ºå£³å‡½æ•°
    ===================================================== */
    window.exportDataComplete = function () {
        // æŒ‰â€œå®Œæˆå¯¼å‡ºâ€çš„å­—é¢è¯­ä¹‰ï¼Œç›´æ¥åšå®Œæ•´ JSON å¯¼å‡º
        window.exportAsJSON();
    };

    /* =====================================================
       â‘¢ saveTpiData â€”â€” æœ¬åœ°å¤‡ä»½
    ===================================================== */
    window.saveTpiData = function () {
        try {
            // ä¿å­˜å½“å‰æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
            const obj = window.collectDailyData();
            const dateKey = Object.keys(obj || {})[0];
            if (dateKey) {
                localStorage.setItem(`tpi_data_${dateKey}`, JSON.stringify(obj[dateKey]));
            }
            
            // æ‰§è¡ŒåŸæœ‰çš„å¤‡ä»½åŠŸèƒ½
            const data = collectLocalStorage();
            const json = JSON.stringify(data, null, 2);
            const name = 'TPI_backup_' + new Date().toISOString().slice(0, 10) + '.json';
            download(name, json, 'application/json');
            
            alert('âœ… å½“å‰æ•°æ®å·²çœŸå®å†™å…¥æœ¬åœ°ç¼“å­˜ï¼ˆlocalStorageï¼‰');
            console.log('[SAVE] saved snapshot for', dateKey);
        } catch (e) {
            console.error('[SAVE] failed:', e);
            alert('âŒ ä¿å­˜å¤±è´¥ï¼šè¯·çœ‹æ§åˆ¶å°');
        }
    };

    /* =====================================================
       â‘£ loadTpiData â€”â€” ä»å¤‡ä»½æ¢å¤
    ===================================================== */
    window.loadTpiData = function () {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';

        input.onchange = function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function () {
                try {
                    const data = JSON.parse(reader.result);
                    for (const key in data) {
                        localStorage.setItem(key, data[key]);
                    }
                    alert('âœ… æ•°æ®å·²æ¢å¤ï¼Œå»ºè®®åˆ·æ–°é¡µé¢');
                    console.log('âœ… loadTpiData æ¢å¤æˆåŠŸ');
                } catch (err) {
                    console.error('âŒ loadTpiData å¤±è´¥', err);
                    alert('æ¢å¤å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                }
            };
            reader.readAsText(file);
        };

        input.click();
    };

    console.log('ğŸ§© è‰ç¨¿7ï¼šæ•°æ®å¯¼å‡ºä¸å¤‡ä»½ç‹¬è£è¡¥ä¸å·²åŠ è½½');
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GitHubäº‘ç«¯åŒæ­¥æ¨¡å— - å®Œæ•´åŠŸèƒ½ä»£ç 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function initGitHubSync() {
    'use strict';
    
    console.log('[GitHub] åˆå§‹åŒ–äº‘ç«¯åŒæ­¥æ¨¡å—...');
    

    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 2. åŠ è½½GitHubé…ç½®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.loadGitHubConfig = function() {
        console.log('[GitHub] åŠ è½½é…ç½®');
        
        const configStr = localStorage.getItem('github_config');
        if (!configStr) {
            updateSyncStatus('æœªé…ç½®');
            console.log('[GitHub] æœªæ‰¾åˆ°é…ç½®');
            return null;
        }
        
        try {
            const config = JSON.parse(configStr);
            document.getElementById('github-token').value = config.token || '';
            document.getElementById('github-username').value = config.username || '';
            document.getElementById('github-repo').value = config.repo || '';
            document.getElementById('github-branch').value = config.branch || 'main';
            
            updateSyncStatus('é…ç½®å·²åŠ è½½ï¼Œå‡†å¤‡å°±ç»ª', 'success');
            console.log('[GitHub] é…ç½®åŠ è½½æˆåŠŸ');
            return config;
        } catch (e) {
            console.error('[GitHub] é…ç½®åŠ è½½å¤±è´¥:', e);
            updateSyncStatus('é…ç½®åŠ è½½å¤±è´¥', 'error');
            return null;
        }
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 3. è·å–GitHubé…ç½®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function getGitHubConfig() {
        const configStr = localStorage.getItem('github_config');
        if (!configStr) {
            throw new Error('GitHubé…ç½®æœªè®¾ç½®ï¼Œè¯·å…ˆå¡«å†™é…ç½®ä¿¡æ¯');
        }
        return JSON.parse(configStr);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 4. æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateSyncStatus(message, type = 'info') {
        const statusText = document.getElementById('sync-status-text');
        const statusContainer = document.getElementById('sync-status-container');
        
        if (statusText) {
            let icon = '';
            if (type === 'success') {
                icon = 'âœ… ';
            } else if (type === 'error') {
                icon = 'âŒ ';
            } else if (type === 'warning') {
                icon = 'âš ï¸ ';
            } else if (type === 'syncing') {
                icon = 'ğŸ”„ ';
            } else {
                icon = 'â„¹ï¸ ';
            }
            statusText.textContent = icon + message;
        }
        
        if (statusContainer) {
            statusContainer.className = 'sync-status-container mb-3';
            
            if (type === 'success') {
                statusContainer.style.background = '#f0fdf4';
                statusContainer.style.borderLeftColor = '#10b981';
            } else if (type === 'error') {
                statusContainer.style.background = '#fef2f2';
                statusContainer.style.borderLeftColor = '#ef4444';
            } else if (type === 'warning') {
                statusContainer.style.background = '#fffbeb';
                statusContainer.style.borderLeftColor = '#f59e0b';
            } else if (type === 'syncing') {
                statusContainer.style.background = '#eff6ff';
                statusContainer.style.borderLeftColor = '#3b82f6';
            } else {
                statusContainer.style.background = '#f0f9ff';
                statusContainer.style.borderLeftColor = '#3b82f6';
            }
        }
        
        console.log(`[GitHub] çŠ¶æ€æ›´æ–° [${type}]: ${message}`);
    }
    

    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 6. Base64ç¼–ç /è§£ç  (å¤„ç†ä¸­æ–‡)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function base64Encode(str) {
        const bytes = new TextEncoder().encode(str);
        let binary = '';
        bytes.forEach(byte => binary += String.fromCharCode(byte));
        return btoa(binary);
    }
    
    function base64Decode(str) {
        const binary = atob(str);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return new TextDecoder().decode(bytes);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 7. SHAæ ¡éªŒå‡½æ•°
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function isValidGitHubSha(sha) {
        if (typeof sha !== 'string') {
            throw new Error(`SHAç±»å‹é”™è¯¯ï¼šæœŸæœ›stringï¼Œå®é™…${typeof sha}`);
        }
        
        if (sha.length !== 40) {
            throw new Error(`SHAé•¿åº¦é”™è¯¯ï¼šæœŸæœ›40ä½ï¼Œå®é™…${sha.length}ä½`);
        }
        
        if (!/^[a-f0-9]{40}$/i.test(sha)) {
            throw new Error('SHAæ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯40ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²');
        }
        
        return true;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 8. æ”¶é›†localStorageä¸­çš„æ‰€æœ‰TPIæ•°æ®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function collectAllTpiData() {
        console.log('[GitHub] å¼€å§‹æ”¶é›†æ‰€æœ‰TPIæ•°æ®');
        
        const allData = {};
        
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            
            if (key.startsWith('tpi_data_')) {
                const dateStr = key.replace('tpi_data_', '');
                try {
                    const dataStr = localStorage.getItem(key);
                    if (dataStr) {
                        const data = JSON.parse(dataStr);
                        allData[dateStr] = data;
                    }
                } catch (e) {
                    console.error(`[GitHub] è§£ææ•°æ®å¤±è´¥: ${key}`, e);
                }
            }
        }
        
        const dataCount = Object.keys(allData).length;
        console.log(`[GitHub] æ”¶é›†åˆ° ${dataCount} æ¡æ•°æ®`);
        
        return allData;
    }
    


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 8. ä¿å­˜ GitHub é…ç½®åˆ°æœ¬åœ°å­˜å‚¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveGitHubConfig() {
    const token = document.getElementById('github-token').value.trim();
    const username = document.getElementById('github-username').value.trim();
    const repo = document.getElementById('github-repo').value.trim();
    const branch = document.getElementById('github-branch').value.trim() || 'main';

    if (!token || !username || !repo) {
        alert('âŒ è¯·å¡«å†™å®Œæ•´çš„ GitHub é…ç½®ä¿¡æ¯');
        return;
    }

    localStorage.setItem('github_token', token);
    localStorage.setItem('github_username', username);
    localStorage.setItem('github_repo', repo);
    localStorage.setItem('github_branch', branch);

    alert('âœ… GitHub é…ç½®å·²ä¿å­˜ï¼');
    console.log('ğŸ’¾ GitHub é…ç½®å·²ä¿å­˜:', { username, repo, branch });
}

// æŒ‚è½½åˆ°windowå¯¹è±¡ä»¥ä¾›å…¨å±€è®¿é—®
window.saveGitHubConfig = saveGitHubConfig;

// ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å¯ç”¨
if (typeof saveGitHubConfig !== 'undefined') {
    window.saveGitHubConfig = saveGitHubConfig;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 9. åŒæ­¥æ•°æ®åˆ° GitHubï¼ˆä¸Šä¼ ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âŒ LEGACYï¼šæ—§ç‰ˆåŒæ­¥å‡½æ•°ï¼ˆå†™ tpi_db.jsonï¼‰
// å·²è¢« v7ã€Œè®¾å¤‡åˆ†åº“åŒæ­¥ã€å½»åº•å–ä»£
// ä¿ç•™ä»…ä¾›å†å²å‚è€ƒï¼Œç¦æ­¢è°ƒç”¨
async function syncToGitHub_LEGACY_DISABLED() {
// 1. æ”¶é›†å½“æ—¥æ•°æ®
const dailyData = collectDailyData();
if (!dailyData || Object.keys(dailyData).length === 0) {
alert('âš ï¸ æœªæ£€æµ‹åˆ°æœ‰æ•ˆæ•°æ®ï¼Œæ— æ³•åŒæ­¥');
console.warn('collectDailyData è¿”å›ç©ºæ•°æ®:', dailyData);
return;
}
const today = new Date().toISOString().split('T')[0];
dailyData["date-input"] = today;

// 2. è·å–é…ç½®
const token = localStorage.getItem('github_token');
const username = localStorage.getItem('github_username');
const repo = localStorage.getItem('github_repo');
const branch = localStorage.getItem('github_branch') || 'main';

if (!token || !username || !repo) {
alert('âŒ è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® GitHub Tokenã€ç”¨æˆ·åå’Œä»“åº“å');
return;
}

// 3. è·å–ç°æœ‰æ•°æ®åº“ï¼ˆä¼˜å…ˆç”¨ç¼“å­˜ï¼‰
let fullDb = {};
const cacheKey = 'tpi_db_full';
try {
const cached = localStorage.getItem(cacheKey);
if (cached) {
fullDb = JSON.parse(cached);
} else {
// ä» GitHub ä¸‹è½½
const resp = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/tpi_db.json`, {
headers: { 'Authorization': `token ${token}` }
});
if (resp.ok) {
const file = await resp.json();
const content = base64Decode(file.content);
fullDb = JSON.parse(content);
localStorage.setItem(cacheKey, content);
}
}
} catch (e) {
console.log('é¦–æ¬¡ä¸Šä¼ æˆ–è¿œç¨‹æ—  tpi_db.jsonï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
}

// 4. æ›´æ–°å½“æ—¥æ•°æ®
fullDb[today] = dailyData;

// 5. å‡†å¤‡ä¸Šä¼ 
const contentStr = JSON.stringify(fullDb, null, 2);
const contentBase64 = btoa(unescape(encodeURIComponent(contentStr)));
const message = `Update TPI data for ${selectedDate} via web`;

// 6. æ£€æŸ¥æ˜¯å¦å·²æœ‰æ–‡ä»¶ï¼ˆè·å– shaï¼‰
let sha = null;
try {
const checkResp = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/tpi_db.json?ref=${branch}`, {
headers: { 'Authorization': `token ${token}` }
});
if (checkResp.ok) {
const fileInfo = await checkResp.json();
sha = fileInfo.sha;
}
} catch (e) {
console.log('tpi_db.json ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
}

// 7. ä¸Šä¼ 
const payload = {
message: message,
content: contentBase64,
branch: branch
};
if (sha) payload.sha = sha; // æ›´æ–°éœ€æä¾› sha

try {
const url = `https://api.github.com/repos/${username}/${repo}/contents/tpi_db.json`;
const resp = await fetch(url, {
method: 'PUT',
headers: {
'Authorization': `token ${token}`,
'Content-Type': 'application/json'
},
body: JSON.stringify(payload)
});

if (resp.ok) {
alert('âœ… æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ° GitHubï¼');
console.log('â˜ï¸ ä¸Šä¼ æˆåŠŸ:', today);
// æ›´æ–°ç¼“å­˜
localStorage.setItem(cacheKey, contentStr);
localStorage.setItem(`tpi_data_${today}`, JSON.stringify(dailyData));
} else {
const errText = await resp.text();
throw new Error(`HTTP ${resp.status}: ${errText}`);
}
} catch (error) {
console.error('ä¸Šä¼ å¤±è´¥:', error);
alert('âŒ åŒæ­¥å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°'));
}
}
*/
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 10. ä»äº‘ç«¯ä¸‹è½½å†å²æ•°æ®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function downloadFromGitHub() {
        console.log('å¼€å§‹ä»GitHubä¸‹è½½æ•°æ®(åˆå¹¶è§†å›¾)...');
        
        const token = localStorage.getItem('github_token');
        const username = localStorage.getItem('github_username');
        const repo = localStorage.getItem('github_repo');
        const branch = localStorage.getItem('github_branch') || 'main';
        
        if (!token || !username || !repo) {
            alert('âŒ è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® GitHub Tokenã€ç”¨æˆ·åå’Œä»“åº“å');
            return;
        }
        
        try {
            // 1) è·å–å½“å‰é€‰ä¸­çš„æ—¥æœŸ
            let dateInput = document.getElementById('date-input');
            if (!dateInput) dateInput = document.querySelector('input[placeholder="ğŸ“… é€‰æ‹©æ—¥æœŸ"]');
            if (!dateInput) {
                console.error('æœªæ‰¾åˆ°æ—¥æœŸè¾“å…¥æ¡†');
                return;
            }

            const selectedDate = dateInput.value;
            if (!selectedDate) {
                alert('âŒ ä½ è¿˜æ²¡é€‰æ‹©æ—¥æœŸ');
                return;
            }

            // 2) ä¼˜å…ˆï¼šè®¾å¤‡åˆ†åº“åˆå¹¶
            let mergedDb = {};
            let deviceFiles = [];
            const mergedResult = await loadMergedDbFromDevices({token, username, repo, branch});
            mergedDb = mergedResult.merged;
            deviceFiles = mergedResult.deviceFiles;

            // 3) å¦‚æœè®¾å¤‡ç›®å½•ä¸å­˜åœ¨ï¼ˆå°šæœªå‡çº§äº§ç”Ÿä»»ä½•åˆ†åº“æ–‡ä»¶ï¼‰ï¼Œfallback æ—§åº“ tpi_db.json
            if (!deviceFiles || deviceFiles.length === 0) {
                console.warn('[MERGE] no device files found, fallback to legacy tpi_db.json');
                const legacy = await ghGetJsonFile({token, username, repo, branch, path: 'tpi_db.json'});
                mergedDb = (legacy.json && typeof legacy.json === 'object') ? legacy.json : {};
            }

            console.log('[MERGE] device files:', deviceFiles);
            
            // 4) æŸ¥æ‰¾é€‰å®šæ—¥æœŸ
            const dayData = mergedDb[selectedDate];
            if (!dayData) {
                alert(`âŒ äº‘ç«¯åˆå¹¶è§†å›¾æœªæ‰¾åˆ° ${selectedDate} çš„æ•°æ®`);
                console.warn('äº‘ç«¯åˆå¹¶è§†å›¾æœªæ‰¾åˆ°è¯¥æ—¥:', selectedDate, Object.keys(mergedDb || {}).slice(0, 10));
                return;
            }


            // âœ… [Patch] æœªæ¥äº‹ä»¶é›·è¾¾æ˜¯â€œå…¨å±€æ•°æ®â€ï¼Œä½†å†å²æ•°æ®æŒ‰æ—¥å­˜å‚¨ã€‚
            // ä¸ºäº†è®©é›·è¾¾åƒå…¶å®ƒæ¨¡å—ä¸€æ ·åœ¨â€œä¸‹è½½ä»»æ„ä¸€å¤©â€åä»èƒ½æ¢å¤åˆ°äº‘ç«¯æœ€æ–°çŠ¶æ€ï¼š
            // ä»åˆå¹¶åº“ä¸­æå– _lastModified æœ€æ–°ä¸”åŒ…å« futureRadarV3 çš„å¿«ç…§ï¼Œè¦†ç›–å½“å‰æ—¥çš„é›·è¾¾å­—æ®µï¼Œå¹¶å†™å› localStorageï¼ˆåŒä¿é™©ï¼‰ã€‚
            let __latestRadar = null;
            let __latestRadarTs = 0;
            try {
                for (const [__d, __obj] of Object.entries(mergedDb || {})) {
                    if (__obj && __obj.futureRadarV3) {
                        let __ts = 0;
                        if (__obj._lastModified) {
                            const t = Date.parse(__obj._lastModified);
                            if (!Number.isNaN(t)) __ts = t;
                        }
                        if (!__ts) {
                            const t2 = Date.parse(__d);
                            if (!Number.isNaN(t2)) __ts = t2;
                        }
                        if (__ts >= __latestRadarTs) {
                            __latestRadarTs = __ts;
                            __latestRadar = __obj.futureRadarV3;
                        }
                    }
                }
            } catch(e) { console.warn('[SYNC][Radar] pick latest radar failed:', e); }

            if (__latestRadar) {
                try {
                    dayData.futureRadarV3 = __latestRadar; // è®© restoreUIFromData èƒ½æ­£å¸¸æ¢å¤
                    localStorage.setItem('tpi_radar_events_v3', JSON.stringify(__latestRadar)); // åŒä¿é™©
                } catch(e) { console.warn('[SYNC][Radar] apply latest radar failed:', e); }
            }

            // æ¢å¤UI
            if (typeof window.restoreUIFromData === 'function') {
                window.restoreUIFromData(dayData);

                // âœ… ä¸‹è½½åç»Ÿä¸€é‡ç®—/åˆ·æ–°ï¼ˆä¿æŠ¤8ç‚¹ï¼šå®æ—¶è®¡åˆ†ã€å¾½ç« ã€æ¨¡å—äº¤äº’ã€æ‚äº‹è®°å½•/é›·è¾¾å¯ç”¨ï¼‰
                try { if (typeof __tpi_triggerRecalc === 'function') { __tpi_triggerRecalc(); } } catch(e) { console.warn('[SYNC] recalc after download failed:', e); }
                try { if (window.MiscLog && typeof window.MiscLog.render === 'function') { window.MiscLog.render(); } } catch(e) { console.warn('[SYNC] MiscLog render after download failed:', e); }
                try { if (window.FutureRadar && typeof window.FutureRadar.reload === 'function') { window.__tpi_safeReloadFutureRadar(); } } catch(e) { console.warn('[SYNC] FutureRadar reload after download failed:', e); }

                console.log(`âœ… å·²ä»äº‘ç«¯åŠ è½½ ${selectedDate} çš„æ•°æ®`);
                
                // å­˜å‚¨åˆ°æœ¬åœ°ç¼“å­˜
                localStorage.setItem(`tpi_data_${selectedDate}`, JSON.stringify(dayData));
                
                alert(`âœ… å·²æˆåŠŸåŠ è½½ ${selectedDate} çš„æ•°æ®ï¼`);
            } else {
                console.error('restoreUIFromData å‡½æ•°æœªå®šä¹‰');
            }
                
                // æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰è¯¥æ—¥æœŸçš„æ•°æ®
                const localDataStr = localStorage.getItem(key);
                
                if (localDataStr) {
                    try {
                        const localEntry = JSON.parse(localDataStr);
                        
                        // æ¯”è¾ƒæ—¶é—´æˆ³
                        const localTime = localEntry._lastModified || '';
                        const cloudTime = cloudEntry._lastModified || '';
                        
                        if (cloudTime > localTime) {
                            // äº‘ç«¯æ•°æ®æ›´æ–°ï¼Œä½¿ç”¨äº‘ç«¯æ•°æ®
                            localStorage.setItem(key, JSON.stringify(cloudEntry));
                            mergedCount++;
                            console.log(`[GitHub] æ›´æ–°: ${dateStr} (äº‘ç«¯æ›´æ–°)`);
                        } else if (localTime === cloudTime) {
                            // æ—¶é—´ç›¸åŒï¼Œæ·±åº¦åˆå¹¶
                            const merged = { ...cloudEntry };
                            Object.keys(localEntry).forEach(k => {
                                if (!k.startsWith('_')) {
                                    const localVal = localEntry[k];
                                    const cloudVal = cloudEntry[k];
                                    
                                    if ((localVal !== null && localVal !== undefined && localVal !== '') && 
                                        (cloudVal === null || cloudVal === undefined || cloudVal === '')) {
                                        merged[k] = localVal;
                                    }
                                }
                            });
                            localStorage.setItem(key, JSON.stringify(merged));
                            mergedCount++;
                        }
                        // æœ¬åœ°æ›´æ–°çš„æƒ…å†µï¼Œä¿ç•™æœ¬åœ°æ•°æ®
                    } catch (e) {
                        console.error(`[GitHub] è§£ææœ¬åœ°æ•°æ®å¤±è´¥: ${key}`, e);
                        localStorage.setItem(key, JSON.stringify(cloudEntry));
                        newCount++;
                    }
                } else {
                    // æœ¬åœ°æ²¡æœ‰ï¼Œç›´æ¥ä¿å­˜
                    localStorage.setItem(key, JSON.stringify(cloudEntry));
                    newCount++;
                    console.log(`[GitHub] æ–°å¢: ${dateStr}`);
                }
            }
            
            updateSyncStatus('âœ… ä¸‹è½½æˆåŠŸï¼', 'success');
            alert(`âœ… ä¸‹è½½æˆåŠŸï¼
æ–°å¢: ${newCount} æ¡
æ›´æ–°: ${mergedCount} æ¡

å»ºè®®åˆ·æ–°é¡µé¢ä»¥æŸ¥çœ‹æ•°æ®`);
            console.log('[GitHub] ä¸‹è½½å®Œæˆ - æ–°å¢:', newCount, 'æ›´æ–°:', mergedCount);
            
            // ä¿å­˜SHA
            localStorage.setItem('github_last_sha', fileData.sha);
            
            // æ¢å¤UI
            if (typeof window.restoreUIFromData === 'function') {
                window.restoreUIFromData(dayData);
                console.log(`âœ… å·²ä»äº‘ç«¯åŠ è½½ ${selectedDate} çš„æ•°æ®`);
                
                // å­˜å‚¨åˆ°æœ¬åœ°ç¼“å­˜
                localStorage.setItem(`tpi_data_${selectedDate}`, JSON.stringify(dayData));
                
                alert(`âœ… å·²æˆåŠŸåŠ è½½ ${selectedDate} çš„æ•°æ®ï¼`);
                
                // è‡ªåŠ¨åŠ è½½æç¤º
                console.log('ğŸ’¾ GitHub é…ç½®å·²ä¿å­˜:', { username, repo, branch });
            } else {
                console.error('restoreUIFromData å‡½æ•°æœªå®šä¹‰');
            }
        } catch (error) {
            console.error('ä¸‹è½½æ•°æ®æ—¶å‡ºé”™(åˆå¹¶è§†å›¾):', error);
            alert('âŒ ä¸‹è½½æ•°æ®å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
        }
    };
    
    // å·²åœ¨ <head> ä¸­å®šä¹‰ window.downloadFromGitHubï¼Œæ— éœ€é‡å¤æŒ‚è½½
    // window.downloadFromGitHub = downloadFromGitHub;
    
   // ==============================
// ç¬¬ 3 æ­¥ï¼šå¯¼å‡ºå½“æ—¥æ•°æ®å‡½æ•° (v1.0)
// æ³¨æ„ï¼šè¿™äº›å‡½æ•°å·²åœ¨ <head> ä¸­çš„ç‹¬è£è¡¥ä¸ v5 é‡Œå®šä¹‰
// æ­¤å¤„ä¿ç•™æ³¨é‡Šä»¥ä¾¿ç†è§£åŸæœ‰ç»“æ„
// ==============================

/*
å·²è¿ç§»åˆ° <head> éƒ¨åˆ†ï¼Œé¿å…åœ¨ IIFE ä¸­å®šä¹‰å¯¼è‡´å…¨å±€è®¿é—®é—®é¢˜

const FIELDS = { ... };
function collectDailyData() { ... }
function restoreUIFromData(data) { ... }
window.collectDailyData = collectDailyData;
window.restoreUIFromData = restoreUIFromData;


//console.log('âœ… [GitHub] collectDailyData å’Œ restoreUIFromData å·²åœ¨ <head> ä¸­å®šä¹‰');
// å®šä¹‰æ—¥æœŸå˜æ›´ç›‘å¬å™¨ï¼ˆç¬¬11èŠ‚çš„ç»„æˆéƒ¨åˆ†ï¼‰
function setupDateChangeHandler() {
    let dateInput = document.getElementById('date-input');
    if (!dateInput) {
        dateInput = document.querySelector('input[placeholder="ğŸ“… é€‰æ‹©æ—¥æœŸ"]');
    }
    if (!dateInput) {
        console.warn('æœªæ‰¾åˆ°æ—¥æœŸè¾“å…¥æ¡†');
        return;
    }

    dateInput.addEventListener('input', async function () {
        const selectedDate = dateInput.value;
        if (!selectedDate) return;

        const today = (typeof __tpi_getSelectedDate === 'function') ? __tpi_getSelectedDate() : (()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;})();
        const isToday = selectedDate === today;

        // å¦‚æœæ˜¯å†å²æ—¥æœŸï¼Œç«‹å³åŠ è½½
        if (!isToday) {
            console.log(`ğŸ” æ­£åœ¨åŠ è½½å†å²æ—¥æœŸ: ${selectedDate}`);
            const cacheKey = `tpi_data_${selectedDate}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                try {
                    restoreUIFromData(JSON.parse(cached));
                    console.log(`âœ… ä»ç¼“å­˜åŠ è½½: ${selectedDate}`);
                    return;
                } catch (e) { /* ignore */ }
            }
            await downloadFromGitHub();
        }
        // å¦‚æœæ˜¯ä»Šæ—¥ï¼Œä¸åšä»»ä½•äº‹ï¼ˆä¿æŠ¤ç”¨æˆ·è¾“å…¥ï¼‰
    });
}
   //========================================
//========================================
// 11. é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½é…ç½®
//========================================
//========================================

// å·²åœ¨ <head> ä¸­å®šä¹‰ window.syncToGitHubï¼Œæ— éœ€é‡å¤æŒ‚è½½
// window.syncToGitHub = syncToGitHub;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 12. æµ‹è¯• GitHub è¿æ¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testGitHubConnection() {
    const token = localStorage.getItem('github_token');
    const username = localStorage.getItem('github_username');
    const repo = localStorage.getItem('github_repo');
    const branch = localStorage.getItem('github_branch') || 'main';

    if (!token || !username || !repo) {
        alert('âŒ è¯·å…ˆä¿å­˜ GitHub é…ç½®');
        return;
    }

    try {
        const deviceId = (localStorage.getItem('tpi_device_id') || 'dev_test');
        const url = `https://api.github.com/repos/${username}/${repo}/contents/tpi_devices/${deviceId}.json?ref=${branch}`;
        const resp = await fetch(url, {
            headers: { 'Authorization': `token ${token}` }
        });

        if (resp.ok) {
            alert('âœ… è¿æ¥æˆåŠŸï¼å¯è¯»å†™ tpi_devices/' + deviceId + '.json');
            console.log('ğŸ§ª GitHub è¿æ¥æµ‹è¯•é€šè¿‡');
        } else if (resp.status === 404) {
            alert('âš ï¸ ä»“åº“/åˆ†æ”¯å­˜åœ¨ï¼Œä½† tpi_devices/' + deviceId + '.json å°šæœªåˆ›å»ºï¼ˆé¦–æ¬¡ä½¿ç”¨æ­£å¸¸ï¼‰');
            console.log('ğŸ§ª ä»“åº“å¯è®¿é—®ï¼Œæ–‡ä»¶ä¸å­˜åœ¨ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰');
        } else if (resp.status === 401) {
            alert('âŒ Token æ— æ•ˆæˆ–æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥ Token æ˜¯å¦åŒ…å« repo æƒé™');
            console.error('GitHub è¿”å› 401: Token æ— æ•ˆ');
        } else {
            throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
        }
    } catch (error) {
        console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
        alert('âŒ è¿æ¥å¤±è´¥ï¼š' + (error.message || 'ç½‘ç»œé”™è¯¯'));
    }
}

// æŒ‚è½½åˆ°windowå¯¹è±¡ä»¥ä¾›å…¨å±€è®¿é—®
window.testGitHubConnection = testGitHubConnection;

// ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å¯ç”¨
if (typeof testGitHubConnection !== 'undefined') {
    window.testGitHubConnection = testGitHubConnection;
}

// æ·»åŠ loadFromGitHubåˆ«åæŒ‡å‘downloadFromGitHub
window.loadFromGitHub = window.downloadFromGitHub;

// è·å–æ‰€æœ‰æ—¥æœŸçš„æ•°æ®
window.getAllDaysData = function() {
    const allData = {};
    
    // ä»æœ¬åœ°å­˜å‚¨è·å–æ‰€æœ‰tpi_data_å¼€å¤´çš„æ•°æ®
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('tpi_data_')) {
            try {
                const dateStr = key.replace('tpi_data_', '');
                allData[dateStr] = JSON.parse(localStorage.getItem(key));
            } catch (e) {
                console.warn('è§£ææœ¬åœ°æ•°æ®å¤±è´¥:', key, e);
            }
        }
    }
    
    // åˆå¹¶å…¨å±€ç¼“å­˜æ•°æ®
    if (window.__TPI_MERGED_DB__ && typeof window.__TPI_MERGED_DB__ === 'object') {
        Object.assign(allData, window.__TPI_MERGED_DB__);
    }
    
    return allData;
};

// è·å–æ•°æ®ç»Ÿè®¡ä¿¡æ¯
window.getTpiDataStats = function(mergedDb = null) {
    // å¦‚æœä¼ å…¥äº†mergedDbå‚æ•°ï¼Œåˆ™ä½¿ç”¨è¯¥å‚æ•°ï¼Œå¦åˆ™ä½¿ç”¨å…¨å±€æ•°æ®
    const allData = mergedDb || window.getAllDaysData();
    const dates = Object.keys(allData);
    
    if (dates.length === 0) {
        return {
            totalDays: 0,
            dateRange: null,
            missingDays: []
        };
    }
    
    // è®¡ç®—æ—¥æœŸèŒƒå›´
    const sortedDates = dates.sort();
    const startDate = sortedDates[0];
    const endDate = sortedDates[sortedDates.length - 1];
    
    // è®¡ç®—ç¼ºå¤±å¤©æ•°
    const missingDays = [];
    const current = new Date(startDate);
    const end = new Date(endDate);
    
    while (current <= end) {
        const dateStr = current.toISOString().split('T')[0];
        if (!allData[dateStr]) {
            missingDays.push(dateStr);
        }
        current.setDate(current.getDate() + 1);
    }
    
    return {
        totalDays: dates.length,
        dateRange: { start: startDate, end: endDate },
        missingDays: missingDays,
        continuousDays: dates.length - missingDays.length
    };
};

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        window.loadGitHubConfig();
        setupDateChangeHandler();
    });
} else {
    window.loadGitHubConfig();
    setupDateChangeHandler();
}
    console.log('âœ… [GitHub] äº‘ç«¯åŒæ­¥æ¨¡å—åˆå§‹åŒ–å®Œæˆ');
})();
</script>


<script>
/* =========================================================
   ç¬¬22ç‰ˆ ä¼˜åŒ–è¡¥ä¸ï¼ˆç¨³å®šæ€§/å¯¼èˆª/å¯¼å‡º/å¼¹çª—ï¼‰â€” åªå¢å¼ºï¼Œä¸ç ´åæŠ˜å ä¸å®æ—¶ç®—åˆ†
   ç›®æ ‡ï¼š
   1) ä»»ä½•æ—¶å€™å¯è¾“å…¥/å¯å‹¾é€‰ï¼ˆä¸è¢«é®ç½©/é˜»å¡å¼¹çª—å¡æ­»ï¼‰
   2) ç¦æ­¢â€œè¾“å…¥å³è‡ªåŠ¨äº‘ç«¯åŒæ­¥â€ï¼Œåªåšæœ¬åœ°å¿«ç…§ + æ‰‹åŠ¨åŒæ­¥äº‘ç«¯
   3) æ¨¡å—å¿«æ·å¯¼èˆªï¼šæŒ‰é¡µé¢çœŸå® DOM é¡ºåºè‡ªåŠ¨ç”Ÿæˆï¼Œç¡®ä¿ä¸æ¼ä¸ä¹±
   4) æ–°å¢ï¼šæŒ‰æ—¶é—´èŒƒå›´å¯¼å‡ºï¼ˆä¼˜å…ˆ XLSXï¼›JSON/MD å¯é€‰å…œåº•ï¼‰
========================================================= */
(function TPI_V9_STABILITY_PATCH(){
  'use strict';

  // ---------- 0) è½»é‡ Toastï¼ˆä¸é˜»å¡ã€ä¸å¼¹çª—å¡æ­»ï¼‰ ----------
  function tpiToast(msg, type){
    try{
      const id = 'tpi-toast-container';
      let box = document.getElementById(id);
      if(!box){
        box = document.createElement('div');
        box.id = id;
        box.style.cssText = 'position:fixed;right:12px;top:12px;z-index:999999;display:flex;flex-direction:column;gap:8px;pointer-events:none;';
        document.body.appendChild(box);
      }
      const item = document.createElement('div');
      item.textContent = String(msg ?? '');
      item.style.cssText =
        'max-width:min(520px, calc(100vw - 24px));' +
        'padding:10px 12px;border-radius:12px;' +
        'background:rgba(15,23,42,.92);color:#fff;' +
        'box-shadow:0 10px 24px rgba(0,0,0,.22);' +
        'font-size:13px;line-height:1.35;letter-spacing:.2px;' +
        'opacity:0;transform:translateY(-6px);transition:opacity .18s ease, transform .18s ease;';
      box.appendChild(item);
      requestAnimationFrame(()=>{ item.style.opacity='1'; item.style.transform='translateY(0)'; });
      setTimeout(()=>{
        item.style.opacity='0'; item.style.transform='translateY(-6px)';
        setTimeout(()=>{ try{ item.remove(); }catch(e){} }, 220);
      }, 2600);
    }catch(e){}
  }

  // ä»…æ›¿æ¢ alertï¼šä¸ç ´å confirm/prompt çš„è¿”å›è¯­ä¹‰
  try{
    const _alert = window.alert;
    window.alert = function(msg){
      tpiToast(msg, 'info');
      try{ console.log('[alert]', msg); }catch(e){}
      // ä¿æŒå…¼å®¹ï¼šå¦‚æœæœ‰äººä¾èµ– alert å­˜åœ¨ï¼Œå°±åˆ«æŠ¥é”™
      return undefined;
    };
    window.__TPI_ALERT_PATCHED__ = true;
  }catch(e){}

  // ---------- 1) è¾“å…¥/å‹¾é€‰ç¨³å®šæ€§å…œåº• ----------
  // é¿å…æŸäº›é®ç½©æ„å¤–å¸¸é©»å¯¼è‡´æ— æ³•äº¤äº’ï¼ˆå¦‚æœé¡µé¢å­˜åœ¨ç›¸å…³ overlayï¼Œå°±å¼ºåˆ¶é‡Šæ”¾ï¼‰
  function releaseKnownOverlays(){
    const ids = ['tpi-full-mask','loading-overlay'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      try{
        el.style.display = 'none';
        el.style.pointerEvents = 'none';
        el.style.opacity = '0';
      }catch(e){}
    });
  }
  window.addEventListener('error', releaseKnownOverlays, true);
  window.addEventListener('unhandledrejection', releaseKnownOverlays, true);

  // ---------- 2) æ¨¡å—å¿«æ·å¯¼èˆªï¼šè‡ªåŠ¨æŒ‰ DOM é¡ºåºç”Ÿæˆ ----------
  function getCardTitle(card){
    if(!card) return '';
    const t1 = card.querySelector('.card-title');
    if(t1 && (t1.textContent||'').trim()) return (t1.textContent||'').trim();
    const t2 = card.querySelector('h2, h3, header h2, header h3');
    if(t2 && (t2.textContent||'').trim()) return (t2.textContent||'').trim();
    // å…œåº•ï¼šç”¨ id
    return (card.id || '').trim() || 'æœªå‘½åæ¨¡å—';
  }

  function ensureExpandedBeforeScroll(card){
    try{
      if(!card) return;
      const isCollapsed = card.classList.contains('collapsed');
      if(isCollapsed && window.TPI && typeof window.TPI.toggleCard === 'function'){
        window.TPI.toggleCard(card.id);
      }
    }catch(e){}
  }

  function scrollToCard(card){
    if(!card) return;
    ensureExpandedBeforeScroll(card);
    try{
      card.scrollIntoView({behavior:'smooth', block:'start'});
    }catch(e){
      try{ card.scrollIntoView(true); }catch(_){}
    }
    // è½»å¾®é«˜äº®ï¼Œä¸å½±å“æŠ˜å /ç®—åˆ†
    try{
      card.animate([{outline:'2px solid rgba(59,130,246,.0)'},{outline:'2px solid rgba(59,130,246,.65)'},{outline:'2px solid rgba(59,130,246,.0)'}],
        {duration:900, easing:'ease-out'});
    }catch(e){}
  }

  function buildQuickNav(){
    const nav = document.getElementById('quickNavV17');
    if(!nav) return;

    // æ¸…ç©ºæ—§æŒ‰é’®ï¼ˆå…¨éƒ¨åŠ¨æ€ç”Ÿæˆï¼‰
    nav.innerHTML = '';

    // âœ… åªæŠ“å–â€œé¡¶å±‚ .card æ¨¡å—â€ï¼Œç¡®ä¿åç§°/é¡ºåº=é¡µé¢çœŸå®æ¨¡å—ï¼Œé¿å…æŠŠå­é”šç‚¹(tpi-grading-rules ç­‰çº¯è‹±æ–‡ id)å¡è¿›å¯¼èˆª
    const cards = Array.from(document.querySelectorAll('.card[id]'))
      .filter(card => {
        try{
          // å¿…é¡»æœ‰å¯æŠ˜å å†…å®¹
          if(!card.querySelector('.card-content')) return false;

          // è·³è¿‡å¯¼èˆªè‡ªèº«/é®ç½©/å¼¹çª—å®¹å™¨ç­‰
          if(card.closest('.quick-nav-container-v19') || card.id === 'loading-overlay' || card.id === 'tpi-toast-container') return false;

          // åªä¿ç•™â€œé¡¶å±‚ cardâ€ï¼ˆå¦‚æœ card åµŒåœ¨å¦ä¸€ä¸ª card é‡Œï¼Œå°±è®¤ä¸ºæ˜¯å­æ¨¡å—ï¼Œä¸è¿›å¿«æ·å¯¼èˆªï¼‰
          const parentCard = card.parentElement ? card.parentElement.closest('.card') : null;
          if(parentCard && parentCard !== card) return false;

          return true;
        }catch(e){
          return false;
        }
      });

    const seen = new Set();

    function isPureEnglishLabel(s){
      const t = (s || '').trim();
      if(!t) return true;
      // çº¯è‹±æ–‡/æ•°å­—/ä¸‹åˆ’çº¿/è¿å­—ç¬¦ => è§†ä¸ºâ€œéæ¨¡å—æ ‡é¢˜â€
      return /^[A-Za-z0-9_-]+$/.test(t);
    }

    function normalizeTitle(t){
      return String(t || '').replace(/\s+/g,' ').trim();
    }

    if(cards.length === 0){
      nav.innerHTML = '<div style="opacity:.85;font-size:12px;padding:6px 8px;">æœªæ‰¾åˆ°å¯æŠ˜å æ¨¡å—ï¼ˆè¯·ç¡®è®¤æ¨¡å—å®¹å™¨ä¸º .card ä¸”åŒ…å« .card-contentï¼‰</div>';
      return;
    }

    cards.forEach(card=>{
      if(!card || !card.id) return;
      if(seen.has(card.id)) return;

      let title = normalizeTitle(getCardTitle(card));

      // âœ… åˆ é™¤â€œçº¯è‹±æ–‡æ¨¡å—åâ€â€”â€”é€šå¸¸æ¥è‡ªå­é”šç‚¹/å†…éƒ¨æ®µè½ï¼ˆå¦‚ tpi-grading-rules / sop-chronology ç­‰ï¼‰
      // åŒæ—¶ä¿è¯ï¼šæ¯ä¸ªçœŸæ­£æ¨¡å—(.card)ä»ç„¶éƒ½æœ‰å¯¹åº”å…¥å£
      if(isPureEnglishLabel(title)){
        // å†å°è¯•ä» card-header/title å†…æ‰¾ä¸€æ¬¡â€œæ›´åƒæ¨¡å—æ ‡é¢˜â€çš„æ–‡æœ¬
        const h = card.querySelector('.card-header .card-title, .card-header h2, .card-header h3, .card-title, h2, h3');
        if(h) title = normalizeTitle(h.textContent || '');
      }
      if(isPureEnglishLabel(title)){
        // ä»ç„¶æ˜¯çº¯è‹±æ–‡ï¼šè·³è¿‡ï¼Œé¿å…æ±¡æŸ“å¯¼èˆª
        return;
      }

      seen.add(card.id);

      const btn = document.createElement('button');
      btn.className = 'quick-nav-btn-v19';
      btn.type = 'button';
      btn.textContent = title;
      btn.addEventListener('click', ()=>scrollToCard(card), {passive:true});
      nav.appendChild(btn);
    });

    // å¦‚æœå…¨éƒ¨è¢«è¿‡æ»¤æ‰ï¼Œç»™å‡ºæç¤ºï¼ˆä¸å½±å“å…¶ä»–é€»è¾‘ï¼‰
    if(nav.children.length === 0){
      nav.innerHTML = '<div style="opacity:.85;font-size:12px;padding:6px 8px;">æœªç”Ÿæˆä»»ä½•æ¨¡å—å¯¼èˆªæŒ‰é’®ï¼ˆæ¨¡å—æ ‡é¢˜ç–‘ä¼¼ç¼ºå¤±æˆ–å‡ä¸ºçº¯è‹±æ–‡ idï¼‰</div>';
    }
}



  

/* =========================================================
   ä¿®å¤ï¼šæ¨¡å—å¿«æ·å¯¼èˆª Toggle æœªç»‘å®šï¼ˆtoggleQuickNavV17ï¼‰
   ç›®æ ‡ï¼š
   - ç‚¹å‡» â˜° ä¸å†å‡ºç°â€œæŒ‰é’®åŠŸèƒ½æœªç»‘å®šâ€
   - å¯¼èˆªæ å¯æ˜¾ç¤º/éšè—ï¼ˆä¸å½±å“ä»»ä½•ä¸šåŠ¡é€»è¾‘/åŒæ­¥/å¯¼å‡º/æŠ˜å /ç®—åˆ†ï¼‰
   - ç¡®ä¿å¯¼èˆªæŒ‰é’®ç‚¹å‡»åå¯ä»¥æ»šåŠ¨åˆ°å¯¹åº”æ¨¡å—
========================================================= */
(function(){
  function setVisible(visible){
    const container = document.querySelector('.quick-nav-container-v19');
    const nav = document.getElementById('quickNavV17');
    if(container){
      container.style.pointerEvents = visible ? 'none' : 'none'; // å®¹å™¨æœ¬èº«å§‹ç»ˆ noneï¼Œå­å…ƒç´ è‡ªå¸¦ pointer-events:auto
      container.style.opacity = visible ? '1' : '0';
      container.style.transform = visible ? 'translateY(0)' : 'translateY(-12px)';
      container.style.transition = 'opacity .18s ease, transform .18s ease';
    }
    if(nav){
      nav.style.pointerEvents = visible ? 'auto' : 'none';
      nav.style.opacity = visible ? '1' : '0';
      nav.style.transform = visible ? 'translateY(0)' : 'translateY(-6px)';
      nav.style.transition = 'opacity .18s ease, transform .18s ease';
      nav.setAttribute('aria-hidden', visible ? 'false' : 'true');
    }
    try{ localStorage.setItem('tpi_quicknav_hidden', visible ? '0' : '1'); }catch(e){}
  }

  window.toggleQuickNavV17 = function(){
    try{
      // è‹¥å°šæœªç”ŸæˆæŒ‰é’®ï¼Œå…ˆç”Ÿæˆä¸€æ¬¡
      if(typeof buildQuickNav === 'function'){
        const nav = document.getElementById('quickNavV17');
        const hasButtons = nav && nav.querySelector('button.quick-nav-btn-v19');
        if(!hasButtons) { try{ buildQuickNav(); }catch(e){} }
      }

      const nav = document.getElementById('quickNavV17');
      const hidden = nav ? (nav.getAttribute('aria-hidden') === 'true' || nav.style.pointerEvents === 'none') : false;
      setVisible(hidden); // hidden=true => show
    }catch(e){
      console.warn('[QuickNav] toggle failed:', e);
    }
  };

  // é¡µé¢å¯åŠ¨æ—¶åº”ç”¨ä¸Šæ¬¡çŠ¶æ€ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰
  function init(){
    let hidden = false;
    try{ hidden = localStorage.getItem('tpi_quicknav_hidden') === '1'; }catch(e){}
    setVisible(!hidden);
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init, { once:true });
  }else{
    setTimeout(init, 0);
  }
})();
// ---------- 3) æŒ‰æ—¶é—´èŒƒå›´å¯¼å‡ºï¼ˆä¼˜å…ˆ XLSXï¼›JSON/MD å¯é€‰å…œåº•ï¼‰ ----------
  function ymdTodayLocal(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function parseYMD(s){
    if(!s) return null;
    const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const dt = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
    if(isNaN(dt.getTime())) return null;
    return dt;
  }
  function ymdFromDate(dt){
    const yyyy = dt.getFullYear();
    const mm = String(dt.getMonth()+1).padStart(2,'0');
    const dd = String(dt.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function downloadBlob(blob, filename){
    try{
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      a.style.display='none';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ try{ URL.revokeObjectURL(url); a.remove(); }catch(e){} }, 1200);
    }catch(e){}
  }

  function getAllDaysDbSafe(){
    // ä¼˜å…ˆä½¿ç”¨ä½ ç°æœ‰çš„ç»Ÿä¸€å…¥å£
    try{
      if(typeof window.getAllDaysData === 'function'){
        return window.getAllDaysData() || {};
      }
    }catch(e){}
    // å…œåº•ï¼šæ‰« localStorage tpi_data_*
    const db = {};
    try{
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k || !k.startsWith('tpi_data_')) continue;
        const date = k.replace('tpi_data_','');
        try{ db[date] = JSON.parse(localStorage.getItem(k) || 'null'); }catch(e){}
      }
    }catch(e){}
    // åˆå¹¶äº‘ç«¯ç¼“å­˜
    try{
      if(window.__TPI_MERGED_DB__ && typeof window.__TPI_MERGED_DB__ === 'object'){
        Object.keys(window.__TPI_MERGED_DB__).forEach(d=>{
          if(!db[d]) db[d] = window.__TPI_MERGED_DB__[d];
        });
      }
    }catch(e){}
    return db;
  }

  function pickRange(db, startYMD, endYMD){
    const s = parseYMD(startYMD);
    const e = parseYMD(endYMD);
    if(!s || !e) return {};
    const out = {};
    const keys = Object.keys(db || {}).sort();
    keys.forEach(k=>{
      const dt = parseYMD(k);
      if(!dt) return;
      if(dt >= s && dt <= e) out[k] = db[k];
    });
    return out;
  }

  function exportRangeAsJSON(rangeObj, filename){
    const blob = new Blob([JSON.stringify(rangeObj, null, 2)], {type:'application/json'});
    downloadBlob(blob, filename);
  }

  function exportRangeAsMarkdown(rangeObj, filename){
    let md = '# TPI æ•°æ®å¯¼å‡ºï¼ˆèŒƒå›´ï¼‰\n\n';
    md += `å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString()}\n\n`;
    const dates = Object.keys(rangeObj || {}).sort();
    dates.forEach(d=>{
      md += `## ${d}\n\n`;
      md += '```json\n';
      md += JSON.stringify(rangeObj[d] ?? {}, null, 2);
      md += '\n```\n\n';
    });
    const blob = new Blob([md], {type:'text/markdown;charset=utf-8'});
    downloadBlob(blob, filename);
  }

  function exportRangeAsXLSX(rangeObj, filename){
    // XLSX å•å…ƒæ ¼æ–‡æœ¬ç¡¬é™åˆ¶ï¼š32767 å­—ç¬¦ã€‚è¿™é‡Œå¯¹ value åšæˆªæ–­ï¼Œé¿å…ç›´æ¥æŠ¥é”™å¯¼è‡´å¯¼å‡ºå¤±è´¥ã€‚
    if(!(window.XLSX && typeof window.XLSX.utils === 'object')){
      tpiToast('âš ï¸ æœªæ£€æµ‹åˆ° XLSX åº“ï¼Œå·²è·³è¿‡ XLSX å¯¼å‡ºï¼ˆå¯ç”¨ JSON/MDï¼‰');
      return false;
    }
    const MAX_CELL = 32767;
    const SAFE_MAX = 32700; // ç•™ä¸€ç‚¹ä½™é‡
    const rows = [];
    const dates = Object.keys(rangeObj || {}).sort();
    dates.forEach(date=>{
      const data = rangeObj[date] || {};
      // å¹³é“ºï¼šdate + key + valueï¼ˆé¿å…å¤æ‚åµŒå¥—å¯¼è‡´ xlsx ä¸å¯è¯»ï¼‰
      Object.keys(data).forEach(k=>{
        const v = data[k];
        let vv = v;
        if(v && typeof v === 'object'){
          try{ vv = JSON.stringify(v); }catch(e){ vv = String(v); }
        }
        if(vv === undefined) vv = '';
        if(vv === null) vv = '';
        vv = String(vv);

        // âœ… è¶…é•¿æˆªæ–­ï¼ˆExcel é™åˆ¶ 32767ï¼‰
        let truncated = '';
        let originalLength = vv.length;
        if(originalLength > MAX_CELL){
          truncated = 'â€¦(truncated)';
          vv = vv.slice(0, Math.max(0, SAFE_MAX - truncated.length)) + truncated;
        }
        rows.push({ date, key: k, value: vv, _len: originalLength, _trunc: originalLength > MAX_CELL ? 'Y' : '' });
      });
    });

    try{
      const ws = window.XLSX.utils.json_to_sheet(rows);
      const wb = window.XLSX.utils.book_new();
      window.XLSX.utils.book_append_sheet(wb, ws, 'TPI');
      window.XLSX.writeFile(wb, filename);
      return true;
    }catch(e){
      console.error('â›” exportRangeAsXLSX å¤±è´¥ï¼Œå·²å›é€€ä¸º JSON å¯¼å‡ºï¼š', e);
      try{
        const blob = new Blob([JSON.stringify(rangeObj || {}, null, 2)], {type:'application/json'});
        const jsonName = String(filename||'tpi_export.xlsx').replace(/\.xlsx$/i,'') + '.json';
        // ä¼˜å…ˆä½¿ç”¨ downloadBlobï¼›è‹¥ downloadBlob ä¸å¯é ï¼Œä¹Ÿä¼šç”±å…¶å†…éƒ¨å…œåº•æˆ–æµè§ˆå™¨æ‹¦æˆª
        if(typeof window.downloadBlob === 'function') window.downloadBlob(blob, jsonName);
        else{
          const a = document.createElement('a');
          const url = URL.createObjectURL(blob);
          a.href = url;
          a.download = jsonName;
          a.style.display='none';
          document.body.appendChild(a);
          a.click();
          setTimeout(()=>{ try{ URL.revokeObjectURL(url); a.remove(); }catch(_){} }, 800);
        }
      }catch(_){}
      tpiToast('âš ï¸ XLSX å¯¼å‡ºé‡åˆ° Excel å•å…ƒæ ¼é•¿åº¦é™åˆ¶ï¼Œå·²è‡ªåŠ¨å›é€€å¯¼å‡º JSONï¼ˆä¿è¯èƒ½å¯¼å‡ºï¼‰ã€‚');
      return false;
    }
  }

  function safeTriggerRecalc(){
    // ä¸å½±å“æŠ˜å ï¼šåªæ´¾å‘ input/changeï¼Œè§¦å‘ä½ å·²æœ‰è§„åˆ™é“¾
    try{
      if(typeof window.__tpi_triggerRecalc === 'function'){
        window.__tpi_triggerRecalc();
      }else if(window.TPI && typeof window.TPI.calculateAllScores === 'function'){
        window.TPI.calculateAllScores();
      }
    }catch(e){}
  }

  function exportRange(startYMD, endYMD, opts){
    opts = opts || { json:true, md:false, xlsx:true };
    try{
      // è‹¥èŒƒå›´åŒ…å«ä»Šå¤©ï¼Œå…ˆé‡ç®—ä¸€æ¬¡ï¼Œå°½é‡ä¿è¯â€œè§„åˆ™ç”Ÿæˆå†…å®¹â€æœ€æ–°
      const today = ymdTodayLocal();
      if(startYMD <= today && today <= endYMD){
        safeTriggerRecalc();
        // åŒæ­¥ä½ ç°æœ‰å¿«ç…§é€»è¾‘ï¼šå°½é‡å†™å…¥æœ¬åœ° tpi_data_YYYY-MM-DD
        try{
          if(typeof window.collectDailyData === 'function'){
            const obj = window.collectDailyData();
            const dk = Object.keys(obj||{})[0];
            if(dk && obj[dk]) localStorage.setItem(`tpi_data_${today}`, JSON.stringify(obj[dk]));
          }
        }catch(e){}
      }

      const db = getAllDaysDbSafe();
      const rangeObj = pickRange(db, startYMD, endYMD);
      const base = `TPI_${startYMD}_to_${endYMD}`;

      // XLSXï¼ˆä¼˜å…ˆæ»¡è¶³ä½ çš„éœ€æ±‚ï¼‰
      if(opts.xlsx){
        try{ exportRangeAsXLSX(rangeObj, `${base}.xlsx`); }catch(e){ tpiToast('âŒ XLSX å¯¼å‡ºå¤±è´¥ï¼ˆçœ‹æ§åˆ¶å°ï¼‰'); console.error(e); }
      }
      // JSON/MDï¼ˆå¯é€‰ï¼Œéšœç¢åˆ™å¿½ç•¥ï¼‰
      if(opts.json){
        try{ exportRangeAsJSON(rangeObj, `${base}.json`); }catch(e){ console.warn(e); }
      }
      if(opts.md){
        try{ exportRangeAsMarkdown(rangeObj, `${base}.md`); }catch(e){ console.warn(e); }
      }

      tpiToast('âœ… èŒƒå›´å¯¼å‡ºå·²è§¦å‘ï¼ˆå¦‚æµè§ˆå™¨æ‹¦æˆªä¸‹è½½ï¼Œè¯·å…è®¸å¤šæ–‡ä»¶ä¸‹è½½ï¼‰');
    }catch(e){
      console.error('[exportRange] failed:', e);
      tpiToast('âŒ èŒƒå›´å¯¼å‡ºå¤±è´¥ï¼ˆçœ‹æ§åˆ¶å°ï¼‰');
    }
  }

  function periodToRange(period){
    const today = ymdTodayLocal();
    const d = parseYMD(today);
    const end = today;
    let start = today;

    if(period === 'day'){
      start = end;
    }else if(period === 'week'){
      // è¿‘ 7 å¤©
      const s = new Date(d); s.setDate(s.getDate()-6);
      start = ymdFromDate(s);
    }else if(period === 'month'){
      const s = new Date(d); s.setDate(1);
      start = ymdFromDate(s);
    }else if(period === 'year'){
      const s = new Date(d); s.setMonth(0,1);
      start = ymdFromDate(s);
    }else{
      // å…œåº•ï¼šè¿‘ 30 å¤©
      const s = new Date(d); s.setDate(s.getDate()-29);
      start = ymdFromDate(s);
    }
    return { start, end };
  }

  // å¯¹å¤–æš´éœ²ï¼ˆä¸ç ´åæ—§æŒ‰é’®ï¼‰
  window.TPI = window.TPI || {};
  window.TPI.exportRange = exportRange;
  window.TPI.exportByPeriod = function(period){
    const r = periodToRange(period);
    exportRange(r.start, r.end, { xlsx:true, json:true, md:true });
  };
  window.TPI.exportCustomRange = function(){
    // ä¸å¼¹çª—ï¼šç”¨é¡µé¢ç°æœ‰è¾“å…¥æ¡†ï¼ˆè‹¥æ²¡æœ‰å°± toast æç¤ºï¼‰
    const sEl = document.getElementById('export-start-date') || document.getElementById('export-range-start');
    const eEl = document.getElementById('export-end-date') || document.getElementById('export-range-end');
    if(!sEl || !eEl){
      tpiToast('âš ï¸ æœªæ‰¾åˆ°èŒƒå›´è¾“å…¥æ¡†ï¼ˆ#export-start-date/#export-end-dateï¼‰ã€‚');
      return;
    }
    const start = (sEl.value||'').trim();
    const end = (eEl.value||'').trim();
    if(!parseYMD(start) || !parseYMD(end)){
      tpiToast('âš ï¸ èŒƒå›´æ—¥æœŸæ ¼å¼åº”ä¸º YYYY-MM-DD');
      return;
    }
    exportRange(start, end, { xlsx:true, json:true, md:true });
  };


  // ---------- 3.9) æŒ‰é’®å…œåº• + æ‰¹é‡å¤‡ä»½ä¿®å¤ï¼ˆé¿å…â€œç‚¹äº†æ²¡ååº”/æ§åˆ¶å°æŠ¥é”™â€ï¼‰ ----------
  function hideLoadingOverlaySafely(){
    try{
      const overlay = document.getElementById('loading-overlay');
      if(!overlay) return;
      overlay.style.display = 'none';
      overlay.style.pointerEvents = 'none';
    }catch(e){}
  }

  function ensureLoadingTexts(){
    try{
      const t = document.querySelector('.loading-text');
      if(t) t.textContent = 'ç¬¬22ç‰ˆï¼šåŠ è½½ä¸­...';
      const v = document.querySelector('.loading-version');
      if(v) v.textContent = 'ç¬¬22ç‰ˆ';
    }catch(e){}
  }

  // å¤‡ä»½ï¼šå¯¼å‡ºâ€œå…¨é‡å¯æ¢å¤åŒ…â€ï¼ˆå«æ‰€æœ‰ tpi_* ä»¥åŠå¿…è¦ç¼“å­˜ï¼›æ’é™¤ token/passwordï¼‰
  function backupAllDataNow(){
    const out = { _meta: { version: (window.TPI_VERSION||'ç¬¬22ç‰ˆ'), exportedAt: new Date().toISOString() }, localStorage: {} };
    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(!k) continue;
      // æ’é™¤æ•æ„Ÿä¿¡æ¯
      if(/token|secret|password|pat/i.test(k)) continue;
      out.localStorage[k] = localStorage.getItem(k);
    }
    // å†è¡¥ä¸€ä»½â€œå½“æ—¥å¿«ç…§â€ï¼ˆç¡®ä¿ä½ åˆšè¾“å…¥çš„ä¹Ÿåœ¨åŒ…é‡Œï¼‰
    try{
      if(typeof window.collectDailyData === 'function'){
        const obj = window.collectDailyData();
        const dk = Object.keys(obj||{})[0];
        if(dk && obj[dk]) out._todaySnapshot = { [dk]: obj[dk] };
      }
    }catch(e){}
    const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `TPI_full_backup_${(new Date()).toISOString().slice(0,10)}.json`;
    a.click();
    tpiToast('âœ… å·²å¯¼å‡ºâ€œå¤‡ä»½æ‰€æœ‰æ•°æ®â€JSONï¼ˆå¯ç”¨äºå…¨é‡æ¢å¤ï¼‰');
  }

  // æ¢å¤ï¼šè¯»å–å¤‡ä»½ JSONï¼Œå†™å› localStorageï¼Œç„¶åè‡ªåŠ¨åˆ·æ–° UIï¼ˆä¸å¼¹ confirmï¼‰
  function restoreBackupFromFile(){
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,application/json';
    input.onchange = (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const obj = JSON.parse(String(r.result||'{}'));
          const bag = obj && obj.localStorage && typeof obj.localStorage==='object' ? obj.localStorage : null;
          if(!bag){
            tpiToast('âŒ å¤‡ä»½æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼ˆç¼ºå°‘ localStorage å­—æ®µï¼‰');
            return;
          }
          Object.keys(bag).forEach(k=>{
            if(/token|secret|password|pat/i.test(k)) return;
            try{ localStorage.setItem(k, bag[k]); }catch(e){}
          });
          // è‹¥å¸¦ todaySnapshotï¼Œä¼˜å…ˆå†™å…¥ tpi_data_YYYY-MM-DD
          try{
            const snap = obj && obj._todaySnapshot;
            if(snap && typeof snap==='object'){
              const dk = Object.keys(snap)[0];
              if(dk && snap[dk]) localStorage.setItem(`tpi_data_${dk}`, JSON.stringify(snap[dk]));
            }
          }catch(e){}
          tpiToast('âœ… å¤‡ä»½å·²æ¢å¤ï¼šå¦‚éœ€å®Œå…¨åˆ·æ–°çŠ¶æ€ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ä¸€æ¬¡');
          // å°è¯•è‡ªåŠ¨æ¢å¤å½“å‰æ—¥æœŸ UI
          try{
            const date = (typeof __tpi_getSelectedDate==='function') ? __tpi_getSelectedDate() : null;
            if(date && typeof window.getTpiDayData==='function' && typeof window.restoreUIFromData==='function'){
              const d = window.getTpiDayData(date);
              if(d) window.restoreUIFromData(d);
            }
          }catch(e){}
        }catch(err){
          console.error(err);
          tpiToast('âŒ æ¢å¤å¤±è´¥ï¼šè¯·çœ‹æ§åˆ¶å°');
        }
      };
      r.readAsText(file);
    };
    input.click();
  }

  // ç»Ÿä¸€æŠŠæŒ‰é’®æŒ‚åˆ° window.TPIï¼ˆé¿å… onclick æŒ‡å‘ä¸å­˜åœ¨ï¼‰
  window.TPI = window.TPI || {};
  if(typeof window.TPI.backupAllData !== 'function') window.TPI.backupAllData = backupAllDataNow;
  if(typeof window.TPI.restoreBackup !== 'function') window.TPI.restoreBackup = restoreBackupFromFile;

  // å…œåº•ï¼šæŠŠå·²æœ‰çš„å…¨å±€ restoreBackup / createBackup ç­‰ä¹Ÿæ˜ å°„è¿› TPI å‘½åç©ºé—´ï¼ˆå…¼å®¹æ—§ onclickï¼‰
  if(typeof window.restoreBackup === 'function' && typeof window.TPI.restoreBackupLegacy !== 'function'){
    window.TPI.restoreBackupLegacy = window.restoreBackup;
  }

  // æœ€å¼ºå…œåº•ï¼šé¡µé¢é‡Œä»»ä½• onclick æŒ‡å‘ä¸å­˜åœ¨å‡½æ•°æ—¶ï¼Œç»™ä¸€ä¸ªå¯å…³é—­ toast æç¤ºï¼Œé¿å…æ§åˆ¶å°æŠ¥é”™
  function installMissingOnclickStubs(){
    try{
      const nodes = Array.from(document.querySelectorAll('button[onclick], a[onclick]'));
      nodes.forEach(el=>{
        const raw = el.getAttribute('onclick') || '';
        const m = raw.match(/^\s*(?:window\.)?([A-Za-z0-9_$]+)(?:\.[A-Za-z0-9_$]+)?\s*\(/);
        if(!m) return;
        // åªå¤„ç†å½¢å¦‚ window.xxx(...) æˆ– xxx(...)
        // è‹¥æ˜¯ window.TPI.xxx(...) æˆ‘ä»¬å°±ä¿è¯ window.TPI å­˜åœ¨å‡½æ•°
        const tpiMatch = raw.match(/window\.TPI\.([A-Za-z0-9_$]+)\s*\(/);
        if(tpiMatch){
          const fn = tpiMatch[1];
          if(window.TPI && typeof window.TPI[fn] !== 'function'){
            window.TPI[fn] = function(){
              tpiToast(`âš ï¸ æŒ‰é’®åŠŸèƒ½æœªç»‘å®šï¼šTPI.${fn}ï¼ˆå·²å…œåº•é¿å…æŠ¥é”™ï¼‰`);
              console.warn('[TPI] missing function stub:', fn);
            };
          }
          return;
        }
        const fn = m[1];
        if(typeof window[fn] !== 'function'){
          window[fn] = function(){
            tpiToast(`âš ï¸ æŒ‰é’®åŠŸèƒ½æœªç»‘å®šï¼š${fn}ï¼ˆå·²å…œåº•é¿å…æŠ¥é”™ï¼‰`);
            console.warn('[TPI] missing function stub:', fn);
          };
        }
      });
    }catch(e){}
  }

  // ---------- 4) å¯åŠ¨æ—¶æ‰§è¡Œ ----------
  document.addEventListener('DOMContentLoaded', function(){
    try{ ensureLoadingTexts(); }catch(e){}
    try{ hideLoadingOverlaySafely(); }catch(e){}
    try{ releaseKnownOverlays(); }catch(e){}
try{ buildQuickNav(); }catch(e){ console.error(e); }
try{
  // âœ… ç›‘å¬ DOM å˜æ›´ï¼šæœªæ¥æ–°å¢æ¨¡å—ä¹Ÿä¼šè‡ªåŠ¨è¿›â€œæ¨¡å—å¿«æ·å¯¼èˆªâ€ï¼ˆä¸å½±å“æŠ˜å /ç®—åˆ†ï¼‰
  if(!window.__TPI_NAV_OBSERVER__){
    const ob = new MutationObserver(()=>{ 
      try{
        if(window.__TPI_NAV_REBUILD_TIMER__) clearTimeout(window.__TPI_NAV_REBUILD_TIMER__);
        window.__TPI_NAV_REBUILD_TIMER__ = setTimeout(()=>{ try{ buildQuickNav(); }catch(e){} }, 120);
      }catch(e){}
    });
    ob.observe(document.body, {childList:true, subtree:true});
    window.__TPI_NAV_OBSERVER__ = ob;
  }
}catch(e){}

    try{ installMissingOnclickStubs(); }catch(e){}
    try{
      // é˜²æ­¢â€œé‡å¤æ³¨å…¥â€é€ æˆç›‘å¬å †å 
      if(window.__TPI_V9_PATCH_ONCE__) return;
      window.__TPI_V9_PATCH_ONCE__ = true;
      tpiToast('âœ… ç¬¬22ç‰ˆ ç¨³å®šæ€§è¡¥ä¸å·²åŠ è½½ï¼ˆè‡ªåŠ¨å¯¼èˆª/èŒƒå›´å¯¼å‡º/ç¦ç”¨è‡ªåŠ¨äº‘ç«¯åŒæ­¥ï¼‰');
    }catch(e){}
  }, {once:true});

})();
</script>




<!-- ===================== PATCH: 2026-02-01 Fix Pack (v22) ===================== -->
<script>
(function(){
  'use strict';
  window.TPI = window.TPI || {};

  // 1) Fix missing TPI.updateStreakWarning (used by inputs; must never throw)
  if (typeof window.TPI.updateStreakWarning !== 'function') {
    window.TPI.updateStreakWarning = function(){
      try{
        const losingInput = document.getElementById('losing-streak-days');
        const losingPanel = document.getElementById('losing-streak-warning');
        const losingDaysSpan = document.getElementById('losing-days-display');

        const losingDays = Math.max(0, parseInt((losingInput && losingInput.value) ? losingInput.value : '0', 10) || 0);

        if (losingDaysSpan) losingDaysSpan.textContent = String(losingDays);

        // é»˜è®¤è§„åˆ™ï¼š>=3 å¤©ä½äºé˜ˆå€¼åˆ™é¢„è­¦ï¼ˆä½ å¯è‡ªè¡Œæ”¹é˜ˆå€¼ï¼‰
        if (losingPanel) {
          losingPanel.style.display = (losingDays >= 3) ? '' : 'none';
        }
      }catch(e){
        // swallow
      }
    };
  }

  // 2) Fix "å¤‡ä»½æ‰€æœ‰æ•°æ®" â€” ensure download actually triggers (append <a>, revoke URL)
  // Override even if existing one is present, because current version sometimes doesn't download on some browsers.
  window.TPI.backupAllData = function(){
    try{
      console.log('[DataProcessing] å¤‡ä»½æ‰€æœ‰æ•°æ®è¢«è°ƒç”¨');
      if(window.__tpi_backup_lock){
        tpiToast('â³ å¤‡ä»½æ­£åœ¨è¿›è¡Œï¼Œè¯·ç¨å€™â€¦');
        return;
      }
      window.__tpi_backup_lock = true;

      const out = { _meta: { version: (window.TPI_VERSION||'ç¬¬22ç‰ˆ'), exportedAt: new Date().toISOString() }, localStorage: {} };

      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(/token|secret|password|pat/i.test(k)) continue;
        out.localStorage[k] = localStorage.getItem(k);
      }

      // è¡¥ä¸€ä»½â€œå½“æ—¥å¿«ç…§â€ï¼ˆç¡®ä¿åˆšè¾“å…¥çš„ä¹Ÿåœ¨åŒ…é‡Œï¼‰
      try{
        if(typeof window.collectDailyData === 'function'){
          const obj = window.collectDailyData();
          const dk = Object.keys(obj||{})[0];
          if(dk && obj[dk]) out._todaySnapshot = { [dk]: obj[dk] };
        }
      }catch(e){}

      const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
      const filename = `TPI_full_backup_${(new Date()).toISOString().slice(0,10)}.json`;

      // âœ… ä¸ä¾èµ–ç°æœ‰ downloadBlobï¼ˆéƒ¨åˆ†æµè§ˆå™¨/å®ç°ä¼šå¯¼è‡´â€œæ§åˆ¶å°æˆåŠŸä½†æ²¡ä¸‹è½½â€ï¼‰
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      a.style.display = 'none';
      document.body.appendChild(a);

      // å…³é”®ï¼šåŒæ­¥ clickï¼Œä¿æŒåœ¨ç”¨æˆ·æ‰‹åŠ¿å†…ï¼ˆæ›´ä¸å®¹æ˜“è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰
      a.click();

      setTimeout(()=>{
        try{ URL.revokeObjectURL(url); }catch(e){}
        try{ a.remove(); }catch(e){}
      }, 1200);

      tpiToast('âœ… å·²ç”Ÿæˆå…¨é‡å¤‡ä»½æ–‡ä»¶ï¼ˆå¦‚æœªå¼¹å‡ºä¸‹è½½ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ‹¦æˆªäº†ä¸‹è½½ï¼‰');
    }catch(e){
      console.error('â›” backupAllData failed:', e);
      tpiToast('â›” å¤‡ä»½å¤±è´¥ï¼š' + (e && e.message ? e.message : e));
    }finally{
      setTimeout(()=>{ window.__tpi_backup_lock = false; }, 600);
    }
  };

  // 3) Fix "æ—¶é—´åºåˆ—è¶‹åŠ¿å›¾" buttons (7/30/90) â€” implement real Chart.js rendering instead of stub
  let __tpiTrendChartInstance = null;

  function __tpi_getAllDaysDb(){
    try{
      if (typeof window.getAllDaysDbSafe === 'function') return window.getAllDaysDbSafe() || {};
    }catch(e){}
    // Fallback: collect from localStorage keys tpi_data_YYYY-MM-DD
    const db = {};
    try{
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        const m = String(k).match(/^tpi_data_(\d{4}-\d{2}-\d{2})$/);
        if(!m) continue;
        const ymd = m[1];
        try{
          const v = JSON.parse(localStorage.getItem(k) || '{}');
          db[ymd] = v;
        }catch(e){
          db[ymd] = {};
        }
      }
    }catch(e){}
    return db;
  }

  function __tpi_extractScore(dayObj){
    if (!dayObj || typeof dayObj !== 'object') return 0;
    const candidates = [
      'totalScore','total_score','tpi_total','tpiTotal','total','scoreTotal','sumScore','finalScore','TPI'
    ];
    for (const k of candidates){
      const v = dayObj[k];
      if (typeof v === 'number' && isFinite(v)) return v;
      if (typeof v === 'string' && v.trim() !== '' && isFinite(Number(v))) return Number(v);
    }
    // try nested
    if (dayObj.scores && typeof dayObj.scores === 'object'){
      for (const k of ['total','sum','final','totalScore']){
        const v = dayObj.scores[k];
        if (typeof v === 'number' && isFinite(v)) return v;
      }
    }
    return 0;
  }

  function __tpi_ymdFromDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }

  function __tpi_buildSeries(days){
    const db = __tpi_getAllDaysDb();
    const today = (typeof window.__tpi_getSelectedDate === 'function') ? window.__tpi_getSelectedDate() : __tpi_ymdFromDate(new Date());

    const end = new Date(today + 'T00:00:00');
    const list = [];
    for(let i=days-1;i>=0;i--){
      const d = new Date(end);
      d.setDate(d.getDate() - i);
      const ymd = __tpi_ymdFromDate(d);
      const score = __tpi_extractScore(db[ymd]);
      list.push({ ymd, score });
    }
    // 7æ—¥ç§»åŠ¨å¹³å‡ï¼ˆä»¥ç°æœ‰ç‚¹ä¸ºå‡†ï¼‰
    const ma7 = list.map((_, idx)=>{
      const s = Math.max(0, idx-6);
      const slice = list.slice(s, idx+1);
      const avg = slice.reduce((a,x)=>a+x.score,0) / slice.length;
      return Math.round(avg*10)/10;
    });
    return { list, ma7 };
  }

  window.TPI.updateTrendChart = function(days){
    try{
      const canvas = document.getElementById('trendChart');
      if(!canvas){
        console.error('[TrendChart] æ‰¾ä¸åˆ° trendChart canvas');
        if (typeof window.tpiToast === 'function') window.tpiToast('âŒ æ‰¾ä¸åˆ°è¶‹åŠ¿å›¾ç”»å¸ƒï¼ˆtrendChartï¼‰');
        return;
      }
      if (typeof Chart === 'undefined'){
        console.error('[TrendChart] Chart.js æœªåŠ è½½');
        if (typeof window.tpiToast === 'function') window.tpiToast('âš ï¸ Chart.js æœªåŠ è½½ï¼Œæ— æ³•ç»˜åˆ¶è¶‹åŠ¿å›¾');
        return;
      }

      const d = Math.max(1, parseInt(days,10)||30);
      const series = __tpi_buildSeries(d);
      const labels = series.list.map(x=>x.ymd.slice(5));
      const data = series.list.map(x=>x.score);

      if (__tpiTrendChartInstance) {
        try{ __tpiTrendChartInstance.destroy(); }catch(e){}
        __tpiTrendChartInstance = null;
      }

      __tpiTrendChartInstance = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'TPIæ€»åˆ†', data, tension: 0.25 },
            { label: 'MA7', data: series.ma7, tension: 0.25 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: { y: { beginAtZero: true } }
        }
      });

      if (typeof window.tpiToast === 'function') window.tpiToast(`âœ… å·²æ›´æ–°è¶‹åŠ¿å›¾ï¼šè¿‘${d}å¤©`);
    }catch(e){
      console.error('[TrendChart] updateTrendChart failed:', e);
      if (typeof window.tpiToast === 'function') window.tpiToast('âŒ è¶‹åŠ¿å›¾æ›´æ–°å¤±è´¥ï¼ˆçœ‹æ§åˆ¶å°ï¼‰');
    }
  };

  // 4) Fix modal "TPIæŒ‡æ•°è¶‹åŠ¿å›¾" â€” make canvas lookup resilient and prevent duplicate overlays
  if (window.trendChartEnhancer && typeof window.trendChartEnhancer.showChartUI === 'function') {
    const enhancer = window.trendChartEnhancer;

    // Wrap showChartUI: remove stale overlays first
    const _origShow = enhancer.showChartUI.bind(enhancer);
    enhancer.showChartUI = function(){
      try{
        // remove any existing overlays containing the modal canvas
        document.querySelectorAll('.modal-overlay').forEach(el=>{
          try{
            if (el.querySelector && el.querySelector('#trendChartModal')) el.remove();
          }catch(e){}
        });
      }catch(e){}
      return _origShow();
    };

    // Wrap initChart: ensure canvas exists; if missing, recreate it inside first chart container
    const _origInit = enhancer.initChart ? enhancer.initChart.bind(enhancer) : null;
    enhancer.initChart = function(days){
      try{
        let canvas = document.getElementById('trendChartModal');
        if(!canvas){
          const container = document.querySelector('.modal-overlay .chart-container') || document.querySelector('.chart-container');
          if(container){
            canvas = document.createElement('canvas');
            canvas.id = 'trendChartModal';
            canvas.style.maxHeight = '400px';
            // clear possible previous content
            container.innerHTML = '';
            container.appendChild(canvas);
          }
        }
      }catch(e){}
      if (_origInit) return _origInit(days);
    };

    // Wrap updateChart: just call original, don't reopen UI
    const _origUpdate = enhancer.updateChart ? enhancer.updateChart.bind(enhancer) : null;
    enhancer.updateChart = function(days){
      if (_origUpdate) return _origUpdate(days);
    };
  }

})();
</script>
<!-- =================== END PATCH: 2026-02-01 Fix Pack =================== -->

<!-- =========================================================
     è‰ç¨¿24è¡¥ä¸ï¼šä¿®å¤è¶‹åŠ¿å›¾å¤ç”¨æŠ¥é”™ / XLSX 32767 é™åˆ¶ / Toasté€’å½’ / å¤‡ä»½ç¨³å®šæ€§
     ä¸æ”¹åŠ¨äº‘ç«¯åŒæ­¥ã€æŠ˜å ã€å®æ—¶è®¡åˆ†ã€è·¨æ—¥æœŸæ ¸å¿ƒé“¾è·¯
========================================================= -->
<script>
(function(){
  'use strict';

  // ========== 1) ä¿®å¤ safeShowToast é€’å½’ï¼ˆsafeShowToast -> InputValidator.showToast(å ä½) -> safeShowToast ...ï¼‰ ==========
  // è¯´æ˜ï¼šæ—©æœŸå ä½ InputValidator.showToast ä¸åº”å†å›è°ƒ safeShowToastï¼›safeShowToast ä¹Ÿéœ€è¦é‡å…¥ä¿æŠ¤ã€‚
  try{
    // é‡å…¥ä¿æŠ¤
    const _origSafe = window.safeShowToast;
    window.safeShowToast = function(message, type){
      if (window.__tpi_toast_lock) {
        try{
          const icon = (type === 'error') ? 'â›”' : (type === 'success') ? 'âœ…' : 'ğŸ“¢';
          alert(icon + ' ' + String(message||''));
        }catch(e){}
        return;
      }
      window.__tpi_toast_lock = true;
      try{
        // 1) ä¼˜å…ˆ NotifySystem
        if (window.NotifySystem && typeof window.NotifySystem.showToast === 'function') {
          window.NotifySystem.showToast(message, type);
          return;
        }
        // 2) ä½¿ç”¨ InputValidatorï¼ˆä½†å¿…é¡»ä¸æ˜¯å ä½é€’å½’å®ç°ï¼‰
        if (window.InputValidator && typeof window.InputValidator.showToast === 'function' && !window.InputValidator.__tpi_isPlaceholder) {
          window.InputValidator.showToast(message, type);
          return;
        }
        // 3) å›é€€åˆ°åŸå®ç°ï¼ˆè‹¥å­˜åœ¨ä¸”ä¸ä¼šé€’å½’ï¼‰
        if (typeof _origSafe === 'function' && _origSafe !== window.safeShowToast) {
          try{ _origSafe(message, type); return; }catch(e){}
        }
        // 4) æœ€ç»ˆå›é€€ alert
        const icon = (type === 'error') ? 'â›”' : (type === 'success') ? 'âœ…' : 'ğŸ“¢';
        alert(icon + ' ' + String(message||''));
      } finally {
        window.__tpi_toast_lock = false;
      }
    };

    // å ä½ InputValidator æ ‡è®° + æ”¹ä¸ºâ€œè‡ªå·±æ˜¾ç¤ºâ€ï¼Œç¦æ­¢å†å›è°ƒ safeShowToast
    if (window.InputValidator && typeof window.InputValidator.showToast === 'function') {
      const fnSrc = String(window.InputValidator.showToast);
      if (fnSrc.includes('InputValidator.showToastå ä½') || fnSrc.includes('safeShowToast')) {
        window.InputValidator.__tpi_isPlaceholder = true;
        window.InputValidator.showToast = function(message, type){
          try{
            const icon = (type === 'error') ? 'â›”' : (type === 'success') ? 'âœ…' : 'ğŸ“¢';
            alert(icon + ' ' + String(message||''));
          }catch(e){
            console.log('ğŸ“¢', message);
          }
        };
      }
    }
  }catch(e){
    console.warn('[Patch24] safeShowToast patch failed:', e);
  }

  // ========== 2) ä¿®å¤ TrendChart: Canvas is already in useï¼ˆChart.js éœ€è¦ destroy æ—§å®ä¾‹ï¼‰ ==========
  try{
    const _origUpdate = window.TPI && window.TPI.updateTrendChart;
    if (window.TPI && typeof window.TPI.updateTrendChart === 'function') {
      window.TPI.updateTrendChart = function(days){
        try{
          const canvas = document.getElementById('trendChart');
          if (!canvas) throw new Error('trendChart canvas missing');
          if (typeof Chart === 'undefined') throw new Error('Chart.js missing');

          // å…³é”®ï¼šæ— è®ºæˆ‘ä»¬æ˜¯å¦æŒæœ‰å®ä¾‹å¼•ç”¨ï¼Œéƒ½ä» Chart.js å–å›å¹¶é”€æ¯
          const existing = (typeof Chart.getChart === 'function') ? Chart.getChart(canvas) : null;
          if (existing && typeof existing.destroy === 'function') {
            try{ existing.destroy(); }catch(e){}
          }

          // åŒæ—¶é”€æ¯æˆ‘ä»¬è‡ªå·±å¯èƒ½è®°å½•çš„å®ä¾‹ï¼ˆå…¼å®¹æ—§è¡¥ä¸å˜é‡ï¼‰
          if (window.__tpiTrendChartInstance && typeof window.__tpiTrendChartInstance.destroy === 'function') {
            try{ window.__tpiTrendChartInstance.destroy(); }catch(e){}
            window.__tpiTrendChartInstance = null;
          }

          // è°ƒç”¨åŸå®ç°ï¼ˆåŸå®ç°ä¼šé‡æ–°ç»˜åˆ¶ï¼‰
          return _origUpdate(days);
        }catch(err){
          console.error('[TrendChart] updateTrendChart failed:', err);
          if (typeof window.tpiToast === 'function') window.tpiToast('âŒ è¶‹åŠ¿å›¾ç»˜åˆ¶å¤±è´¥ï¼š' + (err && err.message ? err.message : err));
        }
      };
    }
  }catch(e){
    console.warn('[Patch24] updateTrendChart patch failed:', e);
  }

  // ========== 3) ä¿®å¤â€œæŒ‰æ—¶é—´èŒƒå›´å¯¼å‡º XLSXâ€ï¼šå•å…ƒæ ¼æ–‡æœ¬é•¿åº¦ä¸èƒ½è¶…è¿‡ 32767 ==========
  // åŸå› ï¼šXLSX çš„å•ä¸ª cell å­—ç¬¦ä¸Šé™ä¸º 32767ï¼ŒJSON.stringify å¤§å¯¹è±¡/é•¿æ–‡æœ¬ä¼šç›´æ¥è§¦å‘ xlsx.full.min.js æŠ›é”™ã€‚
  try{
    function __xlsxSafe(v){
      if (v == null) return '';
      let s = (typeof v === 'string') ? v : (typeof v === 'number' || typeof v === 'boolean') ? String(v)
            : (typeof v === 'object') ? JSON.stringify(v) : String(v);
      // Excel å•å…ƒæ ¼é™åˆ¶ï¼š32767
      const LIM = 32767;
      if (s.length > LIM){
        // ä¿ç•™å‰ 32000ï¼Œæœ«å°¾æ ‡è®°æˆªæ–­ï¼ˆé¿å…åˆšå¥½è´´è¾¹ä»è§¦å‘å†…éƒ¨é¢å¤–å­—ç¬¦å¤„ç†ï¼‰
        s = s.slice(0, 32000) + 'â€¦(truncated)';
      }
      return s;
    }

    // è¦†ç›–å¯¼å‡º XLSX å‡½æ•°ï¼ˆè‹¥å­˜åœ¨ï¼‰
    if (typeof window.exportRangeAsXLSX === 'function') {
      const _orig = window.exportRangeAsXLSX;
      window.exportRangeAsXLSX = function(rangeObj, filename){
        try{
          if(!(window.XLSX && window.XLSX.utils)){
            if (typeof window.tpiToast === 'function') window.tpiToast('âš ï¸ æœªæ£€æµ‹åˆ° XLSX åº“ï¼Œå·²è·³è¿‡ XLSX å¯¼å‡ºï¼ˆå¯ç”¨ JSON/MDï¼‰');
            return false;
          }
          const rows = [];
          const dates = Object.keys(rangeObj || {}).sort();
          dates.forEach(date=>{
            const data = rangeObj[date] || {};
            Object.keys(data).forEach(k=>{
              rows.push({ date, key: __xlsxSafe(k), value: __xlsxSafe(data[k]) });
            });
          });
          const ws = window.XLSX.utils.json_to_sheet(rows);
          const wb = window.XLSX.utils.book_new();
          window.XLSX.utils.book_append_sheet(wb, ws, 'TPI');
          window.XLSX.writeFile(wb, filename);
          return true;
        }catch(err){
          console.error('[exportRangeAsXLSX] failed:', err);
          // è‹¥ä»å¤±è´¥ï¼šå›é€€ä¸º JSON å¯¼å‡ºï¼ˆä¸ä¸­æ–­æµç¨‹ï¼‰
          try{
            const json = JSON.stringify(rangeObj || {}, null, 2);
            const blob = new Blob([json], {type:'application/json;charset=utf-8'});
            if (typeof window.downloadBlob === 'function') {
              window.downloadBlob(blob, String(filename||'TPI_range').replace(/\.xlsx$/i,'') + '.json');
            }
            if (typeof window.tpiToast === 'function') window.tpiToast('âš ï¸ XLSX å¯¼å‡ºå¤±è´¥ï¼ˆå¯èƒ½ä»æœ‰è¶…é™å†…å®¹ï¼‰ï¼Œå·²å›é€€å¯¼å‡º JSON');
          }catch(e2){}
          return false;
        }
      };
      window.exportRangeAsXLSX.__tpi_patched = true;
    }
  }catch(e){
    console.warn('[Patch24] XLSX patch failed:', e);
  }

  // ========== 4) ä¿®å¤â€œå¤‡ä»½æ‰€æœ‰æ•°æ®â€å¼‚å¸¸ï¼šToast é€’å½’å¯¼è‡´æ—¥å¿—åˆ·å±/ç–‘ä¼¼å¡æ­»ï¼›å¹¶åŠ å¹¶å‘é” ==========
  try{
    if (window.TPI && typeof window.TPI.backupAllData === 'function') {
      const _origBackup = window.TPI.backupAllData;
      window.TPI.backupAllData = function(){
    try{
      console.log('[DataProcessing] å¤‡ä»½æ‰€æœ‰æ•°æ®è¢«è°ƒç”¨');
      if(window.__tpi_backup_lock){
        tpiToast('â³ å¤‡ä»½æ­£åœ¨è¿›è¡Œï¼Œè¯·ç¨å€™â€¦');
        return;
      }
      window.__tpi_backup_lock = true;

      const out = { _meta: { version: (window.TPI_VERSION||'ç¬¬22ç‰ˆ'), exportedAt: new Date().toISOString() }, localStorage: {} };

      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(/token|secret|password|pat/i.test(k)) continue;
        out.localStorage[k] = localStorage.getItem(k);
      }

      // è¡¥ä¸€ä»½â€œå½“æ—¥å¿«ç…§â€ï¼ˆç¡®ä¿åˆšè¾“å…¥çš„ä¹Ÿåœ¨åŒ…é‡Œï¼‰
      try{
        if(typeof window.collectDailyData === 'function'){
          const obj = window.collectDailyData();
          const dk = Object.keys(obj||{})[0];
          if(dk && obj[dk]) out._todaySnapshot = { [dk]: obj[dk] };
        }
      }catch(e){}

      const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
      const filename = `TPI_full_backup_${(new Date()).toISOString().slice(0,10)}.json`;

      // âœ… ä¸ä¾èµ–ç°æœ‰ downloadBlobï¼ˆéƒ¨åˆ†æµè§ˆå™¨/å®ç°ä¼šå¯¼è‡´â€œæ§åˆ¶å°æˆåŠŸä½†æ²¡ä¸‹è½½â€ï¼‰
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = filename;
      a.style.display = 'none';
      document.body.appendChild(a);

      // å…³é”®ï¼šåŒæ­¥ clickï¼Œä¿æŒåœ¨ç”¨æˆ·æ‰‹åŠ¿å†…ï¼ˆæ›´ä¸å®¹æ˜“è¢«æµè§ˆå™¨æ‹¦æˆªï¼‰
      a.click();

      setTimeout(()=>{
        try{ URL.revokeObjectURL(url); }catch(e){}
        try{ a.remove(); }catch(e){}
      }, 1200);

      tpiToast('âœ… å·²ç”Ÿæˆå…¨é‡å¤‡ä»½æ–‡ä»¶ï¼ˆå¦‚æœªå¼¹å‡ºä¸‹è½½ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ‹¦æˆªäº†ä¸‹è½½ï¼‰');
    }catch(e){
      console.error('â›” backupAllData failed:', e);
      tpiToast('â›” å¤‡ä»½å¤±è´¥ï¼š' + (e && e.message ? e.message : e));
    }finally{
      setTimeout(()=>{ window.__tpi_backup_lock = false; }, 600);
    }
  };
    }
  }catch(e){
    console.warn('[Patch24] backupAllData patch failed:', e);
  }

  console.log('âœ… Patch24 å·²å¯ç”¨ï¼šè¶‹åŠ¿å›¾destroy / XLSX 32767 æˆªæ–­ / Toasté€’å½’ä¿®å¤ / å¤‡ä»½é”');
})();
</script>

<script>
/* =========================================================
   æ¯æ—¥ç­¾åˆ°æ¨¡å— JavaScript
   åŠŸèƒ½ï¼šæ¯æ—¥ç­¾åˆ°ã€è¿ç»­ç­¾åˆ°ç»Ÿè®¡ã€ç­¾åˆ°å†å²æŸ¥çœ‹
========================================================= */

(function() {
  'use strict';

  // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
  function getTodayDateString() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  // è·å–ç­¾åˆ°æ•°æ®
  function getCheckInData() {
    try {
      const data = localStorage.getItem('tpi_checkin_data');
      return data ? JSON.parse(data) : { dates: [], currentStreak: 0, maxStreak: 0 };
    } catch (e) {
      console.error('è·å–ç­¾åˆ°æ•°æ®å¤±è´¥:', e);
      return { dates: [], currentStreak: 0, maxStreak: 0 };
    }
  }

  // ä¿å­˜ç­¾åˆ°æ•°æ®
  function saveCheckInData(data) {
    try {
      localStorage.setItem('tpi_checkin_data', JSON.stringify(data));
      return true;
    } catch (e) {
      console.error('ä¿å­˜ç­¾åˆ°æ•°æ®å¤±è´¥:', e);
      return false;
    }
  }

  // è®¡ç®—è¿ç»­ç­¾åˆ°å¤©æ•°
  function calculateStreak(dates) {
    if (!dates || dates.length === 0) return 0;
    
    // æ’åºæ—¥æœŸï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
    const sortedDates = [...dates].sort((a, b) => new Date(b) - new Date(a));
    
    let streak = 0;
    const today = new Date(getTodayDateString());
    
    for (let i = 0; i < sortedDates.length; i++) {
      const checkDate = new Date(sortedDates[i]);
      const expectedDate = new Date(today);
      expectedDate.setDate(today.getDate() - i);
      
      // æ¯”è¾ƒæ—¥æœŸï¼ˆåªæ¯”è¾ƒå¹´æœˆæ—¥ï¼‰
      if (checkDate.toDateString() === expectedDate.toDateString()) {
        streak++;
      } else {
        break;
      }
    }
    
    return streak;
  }

  // æ›´æ–°ç­¾åˆ°çŠ¶æ€æ˜¾ç¤º
  function updateCheckInStatus() {
    try {
      const data = getCheckInData();
      const today = getTodayDateString();
      const hasCheckedIn = data.dates.includes(today);
      
      // è®¡ç®—è¿ç»­ç­¾åˆ°å¤©æ•°
      const streak = calculateStreak(data.dates);
      data.currentStreak = streak;
      saveCheckInData(data);
      
      // æ›´æ–°çŠ¶æ€æ–‡æœ¬
      const statusText = document.getElementById('checkin-status-text');
      const streakDisplay = document.getElementById('checkin-streak-display');
      const checkInBtn = document.getElementById('btn-daily-checkin');
      
      if (statusText) {
        statusText.textContent = hasCheckedIn ? 'âœ… å·²ç­¾åˆ°' : 'â° æœªç­¾åˆ°';
      }
      
      if (streakDisplay) {
        streakDisplay.textContent = streak;
      }
      
      if (checkInBtn) {
        if (hasCheckedIn) {
          checkInBtn.textContent = 'âœ… ä»Šæ—¥å·²ç­¾åˆ°';
          checkInBtn.disabled = true;
          checkInBtn.style.opacity = '0.6';
          checkInBtn.style.cursor = 'not-allowed';
        } else {
          checkInBtn.textContent = 'ğŸ¯ ç«‹å³ç­¾åˆ°';
          checkInBtn.disabled = false;
          checkInBtn.style.opacity = '1';
          checkInBtn.style.cursor = 'pointer';
        }
      }
      
      // æ›´æ–°ç­¾åˆ°æ—¥å†
      updateCheckInCalendar();
    } catch (e) {
      console.error('æ›´æ–°ç­¾åˆ°çŠ¶æ€å¤±è´¥:', e);
    }
  }

  // æ›´æ–°ç­¾åˆ°æ—¥å†ï¼ˆæœ€è¿‘7å¤©ï¼‰
  function updateCheckInCalendar() {
    try {
      const calendarGrid = document.getElementById('checkin-calendar-grid');
      if (!calendarGrid) return;
      
      const data = getCheckInData();
      const today = new Date();
      
      calendarGrid.innerHTML = '';
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        
        const dateStr = date.toISOString().split('T')[0];
        const hasChecked = data.dates.includes(dateStr);
        
        const dayDiv = document.createElement('div');
        dayDiv.style.cssText = `
          padding: 12px 8px;
          text-align: center;
          border-radius: 8px;
          background: ${hasChecked ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#e2e8f0'};
          color: ${hasChecked ? 'white' : '#64748b'};
          font-weight: ${hasChecked ? '700' : '500'};
          font-size: 13px;
          transition: all 0.3s;
          box-shadow: ${hasChecked ? '0 2px 8px rgba(102, 126, 234, 0.3)' : 'none'};
        `;
        
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const weekday = weekdays[date.getDay()];
        const day = date.getDate();
        
        dayDiv.innerHTML = `
          <div style="font-size: 11px; opacity: 0.8; margin-bottom: 4px;">å‘¨${weekday}</div>
          <div style="font-size: 16px; font-weight: 700;">${day}</div>
          <div style="font-size: 18px; margin-top: 4px;">${hasChecked ? 'âœ…' : 'â­•'}</div>
        `;
        
        calendarGrid.appendChild(dayDiv);
      }
    } catch (e) {
      console.error('æ›´æ–°ç­¾åˆ°æ—¥å†å¤±è´¥:', e);
    }
  }

  // æ‰§è¡Œç­¾åˆ°
  window.performDailyCheckIn = function() {
    try {
      const data = getCheckInData();
      const today = getTodayDateString();
      
      // æ£€æŸ¥æ˜¯å¦å·²ç»ç­¾åˆ°
      if (data.dates.includes(today)) {
        if (typeof window.tpiToast === 'function') {
          window.tpiToast('ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†ï¼', 'info');
        } else {
          alert('âœ… ä»Šå¤©å·²ç»ç­¾åˆ°è¿‡äº†ï¼');
        }
        return;
      }
      
      // æ·»åŠ ä»Šå¤©çš„ç­¾åˆ°è®°å½•
      data.dates.push(today);
      
      // è®¡ç®—è¿ç»­ç­¾åˆ°å¤©æ•°
      const streak = calculateStreak(data.dates);
      data.currentStreak = streak;
      
      // æ›´æ–°æœ€å¤§è¿ç»­ç­¾åˆ°å¤©æ•°
      if (streak > (data.maxStreak || 0)) {
        data.maxStreak = streak;
      }
      
      // ä¿å­˜æ•°æ®
      if (saveCheckInData(data)) {
        // æ›´æ–°æ˜¾ç¤º
        updateCheckInStatus();
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        let message = `ğŸ‰ ç­¾åˆ°æˆåŠŸï¼`;
        if (streak > 1) {
          message += `\nğŸ”¥ å·²è¿ç»­ç­¾åˆ° ${streak} å¤©ï¼`;
        }
        if (streak >= 7) {
          message += `\nâ­ å¤ªæ£’äº†ï¼åšæŒ7å¤©ä»¥ä¸Šï¼`;
        }
        if (streak >= 30) {
          message += `\nğŸ† æƒŠäººï¼åšæŒ30å¤©ä»¥ä¸Šï¼`;
        }
        
        if (typeof window.tpiToast === 'function') {
          window.tpiToast(message, 'success');
        } else {
          alert(message);
        }
        
        // æ’­æ”¾ç­¾åˆ°åŠ¨ç”»
        playCheckInAnimation();
      } else {
        if (typeof window.tpiToast === 'function') {
          window.tpiToast('âŒ ç­¾åˆ°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        } else {
          alert('âŒ ç­¾åˆ°å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      }
    } catch (e) {
      console.error('ç­¾åˆ°å¤±è´¥:', e);
      if (typeof window.tpiToast === 'function') {
        window.tpiToast('âŒ ç­¾åˆ°å¤±è´¥ï¼š' + e.message, 'error');
      } else {
        alert('âŒ ç­¾åˆ°å¤±è´¥ï¼š' + e.message);
      }
    }
  };

  // æ’­æ”¾ç­¾åˆ°åŠ¨ç”»
  function playCheckInAnimation() {
    try {
      const container = document.getElementById('checkin-status-container');
      if (container) {
        container.animate([
          { transform: 'scale(1)', boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)' },
          { transform: 'scale(1.05)', boxShadow: '0 8px 30px rgba(102, 126, 234, 0.6)' },
          { transform: 'scale(1)', boxShadow: '0 4px 15px rgba(102, 126, 234, 0.4)' }
        ], {
          duration: 500,
          easing: 'ease-out'
        });
      }
    } catch (e) {
      console.log('æ’­æ”¾åŠ¨ç”»å¤±è´¥:', e);
    }
  }

  // æ˜¾ç¤ºç­¾åˆ°å†å²
  window.showCheckInHistory = function() {
    try {
      const data = getCheckInData();
      
      if (data.dates.length === 0) {
        if (typeof window.tpiToast === 'function') {
          window.tpiToast('è¿˜æ²¡æœ‰ç­¾åˆ°è®°å½•å“¦ï¼', 'info');
        } else {
          alert('ğŸ“… è¿˜æ²¡æœ‰ç­¾åˆ°è®°å½•å“¦ï¼');
        }
        return;
      }
      
      // æ’åºæ—¥æœŸï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      const sortedDates = [...data.dates].sort((a, b) => new Date(b) - new Date(a));
      
      // æ„å»ºå†å²è®°å½•æ¶ˆæ¯
      let message = `ğŸ“… ç­¾åˆ°å†å²è®°å½•\n\n`;
      message += `ğŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š\n`;
      message += `â€¢ æ€»ç­¾åˆ°å¤©æ•°ï¼š${data.dates.length} å¤©\n`;
      message += `â€¢ å½“å‰è¿ç»­ï¼š${data.currentStreak || 0} å¤©\n`;
      message += `â€¢ æœ€é•¿è¿ç»­ï¼š${data.maxStreak || 0} å¤©\n\n`;
      message += `ğŸ“† æœ€è¿‘10æ¬¡ç­¾åˆ°ï¼š\n`;
      
      sortedDates.slice(0, 10).forEach((date, index) => {
        const d = new Date(date);
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const weekday = weekdays[d.getDay()];
        message += `${index + 1}. ${date} (å‘¨${weekday})\n`;
      });
      
      if (sortedDates.length > 10) {
        message += `\n... è¿˜æœ‰ ${sortedDates.length - 10} æ¡è®°å½•`;
      }
      
      alert(message);
    } catch (e) {
      console.error('æ˜¾ç¤ºç­¾åˆ°å†å²å¤±è´¥:', e);
      if (typeof window.tpiToast === 'function') {
        window.tpiToast('âŒ è·å–ç­¾åˆ°å†å²å¤±è´¥', 'error');
      } else {
        alert('âŒ è·å–ç­¾åˆ°å†å²å¤±è´¥');
      }
    }
  };

  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç­¾åˆ°çŠ¶æ€
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(updateCheckInStatus, 500);
    });
  } else {
    setTimeout(updateCheckInStatus, 500);
  }

  // âœ… [è‰ç¨¿55 Patch-D] æš´éœ²åˆ°å…¨å±€ï¼Œä¾›äº‘ç«¯æ¢å¤æµç¨‹è°ƒç”¨
  window.__tpi_refreshCheckin = function() {
    try { updateCheckInStatus(); } catch(e) { console.warn('[checkin] refreshCheckin failed:', e); }
  };

  console.log('âœ… æ¯æ—¥ç­¾åˆ°æ¨¡å—å·²åŠ è½½');
})();
</script>

<script>
/* =========================================================
   æ—¥æœŸé€‰æ‹©å™¨ä¿®å¤ - ç¡®ä¿æ˜¾ç¤ºå½“å¤©çœŸå®æ—¥æœŸ
========================================================= */

(function() {
  'use strict';

  // è®¾ç½®æ—¥æœŸè¾“å…¥æ¡†ä¸ºä»Šå¤©çš„æ—¥æœŸ
  function setTodayDate() {
    try {
      const dateInput = document.getElementById('date-input');
      if (!dateInput) {
        console.warn('æ—¥æœŸè¾“å…¥æ¡†æœªæ‰¾åˆ°');
        return;
      }

      // è·å–æœ¬åœ°æ—¥æœŸ (é¿å…æ—¶åŒºé—®é¢˜)
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const todayString = `${yyyy}-${mm}-${dd}`;

      // å¦‚æœæ—¥æœŸè¾“å…¥æ¡†ä¸ºç©ºæˆ–æ— æ•ˆ,è®¾ç½®ä¸ºä»Šå¤©
      if (!dateInput.value || dateInput.value === '') {
        dateInput.value = todayString;
        console.log('âœ… æ—¥æœŸå·²è®¾ç½®ä¸ºä»Šå¤©:', todayString);
        
        // è§¦å‘æ—¥æœŸå˜æ›´äº‹ä»¶
        const event = new Event('change', { bubbles: true });
        dateInput.dispatchEvent(event);
      }

      // æ›´æ–°æ˜ŸæœŸæ˜¾ç¤º
      updateWeekdayDisplay();
    } catch (e) {
      console.error('è®¾ç½®ä»Šå¤©æ—¥æœŸå¤±è´¥:', e);
    }
  }

  // æ›´æ–°æ˜ŸæœŸæ˜¾ç¤º
  function updateWeekdayDisplay() {
    try {
      const dateInput = document.getElementById('date-input');
      const weekdaySpan = document.getElementById('date-weekday');

      if (!dateInput || !weekdaySpan) return;

      const dateValue = dateInput.value;
      if (!dateValue) return;

      const date = new Date(dateValue + 'T00:00:00');
      const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
      const weekday = weekdays[date.getDay()];

      // è®¡ç®— ISO å‘¨ï¼ˆåŒ…å«â€œå‘¨æ‰€å±å¹´ä»½â€ï¼Œé¿å…è·¨å¹´å‘¨æ•°æ­§ä¹‰ï¼‰
      function getISOWeekInfo(d) {
        const utc = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        const day = utc.getUTCDay() || 7; // å‘¨ä¸€=1...å‘¨æ—¥=7
        utc.setUTCDate(utc.getUTCDate() + 4 - day); // å®šä½åˆ°æœ¬å‘¨å‘¨å››
        const weekYear = utc.getUTCFullYear();
        const yearStart = new Date(Date.UTC(weekYear, 0, 1));
        const weekNo = Math.ceil((((utc - yearStart) / 86400000) + 1) / 7);
        return { weekYear, weekNo };
      }

      // è®¡ç®—å†œå†ï¼ˆå¦‚ LunarCalendar ä¸å­˜åœ¨åˆ™è·³è¿‡ï¼‰
      function getLunarStr(d) {
        try {
          if (!window.LunarCalendar || typeof window.LunarCalendar.solarToLunar !== 'function') return '';
          const lunar = window.LunarCalendar.solarToLunar(d);
          if (!lunar || !lunar.month || !lunar.day) return '';
          const lunarMonths = ['æ­£æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'å†¬æœˆ', 'è…Šæœˆ'];
          const lunarMonth = lunarMonths[lunar.month - 1] || '';
          const dayNum = lunar.day;
          const lunarDay =
            dayNum < 11 ? 'åˆ' + ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å'][dayNum - 1] :
            dayNum < 20 ? 'å' + ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'][dayNum - 11] :
            dayNum === 20 ? 'äºŒå' :
            dayNum < 30 ? 'å»¿' + ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'][dayNum - 21] :
            'ä¸‰å';
          const leap = lunar.isLeap ? '(é—°)' : '';
          return `å†œå†${lunarMonth}${lunarDay}${leap}`;
        } catch (e) {
          return '';
        }
      }

      const { weekYear, weekNo } = getISOWeekInfo(date);
      const lunarStr = getLunarStr(date);

      // è¾“å‡ºé¡ºåºï¼šæ˜ŸæœŸ + é˜´å† + â€œYYYYå¹´ç¬¬Nå‘¨â€
      const parts = [];
      parts.push(weekday);
      if (lunarStr) parts.push(lunarStr);
      parts.push(`${weekYear}å¹´ç¬¬${weekNo}å‘¨`);

      weekdaySpan.textContent = parts.join(' ');
    } catch (e) {
      console.error('æ›´æ–°æ˜ŸæœŸæ˜¾ç¤ºå¤±è´¥:', e);
    }
  }

  // ç›‘å¬æ—¥æœŸå˜åŒ–
  function setupDateChangeListener() {
    try {
      const dateInput = document.getElementById('date-input');
      if (!dateInput) return;

      dateInput.addEventListener('change', function() {
        updateWeekdayDisplay();
      });
    } catch (e) {
      console.error('è®¾ç½®æ—¥æœŸç›‘å¬å¤±è´¥:', e);
    }
  }

  // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        setTodayDate();
        setupDateChangeListener();
      }, 100);
    });
  } else {
    setTimeout(function() {
      setTodayDate();
      setupDateChangeListener();
    }, 100);
  }

  console.log('âœ… æ—¥æœŸé€‰æ‹©å™¨ä¿®å¤è„šæœ¬å·²åŠ è½½');
})();
</script>



<script>
/* =========================================================
   æ‚äº‹è®°å½• Â· å¿«é€Ÿå¤‡å¿˜ (Misc Log)
   ç›®æ ‡ï¼š
   - å•æ¡åˆ é™¤ / æ‰¹é‡åˆ é™¤ / ç¼–è¾‘
   - å¼¹çª—å¯ä¸Šä¸‹æ»‘åŠ¨ï¼ˆå¤ç”¨ showModalï¼šmax-height + overflow-yï¼‰
   - è‡ªå¸¦æ•°å­—ç»Ÿè®¡
   - ç™»å½•(å¡«å†™ token/ç”¨æˆ·å/ä»“åº“)å‰åå‡å¯ç”¨ï¼ˆåªä¾èµ– localStorage + DOMï¼‰
   - æ•°æ®è¿›å…¥éšè— textareaï¼ˆ#misc-records-jsonï¼‰ï¼Œç¡®ä¿è¢« collectDailyData/_formState æ•è·å¹¶éšäº‘ç«¯åŒæ­¥
========================================================= */
(function(){
  'use strict';

  const LS_PREFIX = 'tpi_misc_records_';
  const els = {
    list: ()=>document.getElementById('misc-log-list'),
    empty: ()=>document.getElementById('misc-log-empty'),
    count: ()=>document.getElementById('misc-log-count'),
    chars: ()=>document.getElementById('misc-log-chars'),
    hidden: ()=>document.getElementById('misc-records-json'),
    selectAll: ()=>document.getElementById('misc-log-select-all'),
  };

  function getSelectedDate(){
    try{
      if(typeof window.__tpi_getSelectedDate === 'function') return window.__tpi_getSelectedDate();
    }catch(e){}
    const di = document.getElementById('date-input') || document.querySelector('input[placeholder="ğŸ“… é€‰æ‹©æ—¥æœŸ"]');
    if(di && di.value) return di.value;
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function keyForDate(dateStr){ return LS_PREFIX + dateStr; }

  function safeParseJson(s, fallback){
    try{
      const v = JSON.parse(s);
      return v ?? fallback;
    }catch(e){
      return fallback;
    }
  }

  function loadRecords(dateStr){
    const key = keyForDate(dateStr);
    const raw = localStorage.getItem(key);
    const list = Array.isArray(safeParseJson(raw, [])) ? safeParseJson(raw, []) : [];
    return list;
  }

  function persistRecords(dateStr, records){
    const key = keyForDate(dateStr);
    const arr = Array.isArray(records) ? records : [];
    localStorage.setItem(key, JSON.stringify(arr));
    // åŒæ­¥åˆ°éšè— textareaï¼ˆä¿è¯äº‘ç«¯å¿«ç…§æ”¶å¾—åˆ°ï¼‰
    const h = els.hidden();
    if(h) {
      h.value = JSON.stringify({ date: dateStr, records: arr });
      // âœ… [è‰ç¨¿54 Patch] è§¦å‘ input äº‹ä»¶ â†’ è®©å…¨å±€ç›‘å¬å™¨æ ‡è®° dirty + æœ¬åœ°å¿«ç…§
      try { h.dispatchEvent(new Event('input', { bubbles: true })); } catch(_e){}
    }
  }

  function fmtTime(iso){
    if(!iso) return '';
    try{
      const d = new Date(iso);
      if(isNaN(d.getTime())) return '';
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }catch(e){ return ''; }
  }

  function escapeHtml(str){
    return String(str ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function calcStats(records){
    const count = records.length;
    let chars = 0;
    records.forEach(r=>{ chars += (r && r.text) ? String(r.text).length : 0; });
    return {count, chars};
  }

  function updateStats(records){
    const s = calcStats(records);
    const c = els.count(); if(c) c.textContent = String(s.count);
    const ch = els.chars(); if(ch) ch.textContent = String(s.chars);
  }

  function render(){
    const dateStr = getSelectedDate();
    const records = loadRecords(dateStr);
    persistRecords(dateStr, records); // ç¡®ä¿éšè—åŸŸä¹Ÿè·Ÿä¸Š

    const listEl = els.list();
    const emptyEl = els.empty();
    if(!listEl) return;

    listEl.innerHTML = '';
    updateStats(records);

    if(els.selectAll()) els.selectAll().checked = false;

    if(records.length === 0){
      if(emptyEl) emptyEl.style.display = 'block';
      return;
    } else {
      if(emptyEl) emptyEl.style.display = 'none';
    }

    records.slice().sort((a,b)=>{
      const ta = a && a.createdAt ? Date.parse(a.createdAt) : 0;
      const tb = b && b.createdAt ? Date.parse(b.createdAt) : 0;
      return tb - ta;
    }).forEach(rec=>{
      const id = rec && rec.id ? rec.id : ('id_' + Math.random().toString(16).slice(2));
      const time = fmtTime(rec.createdAt);
      const text = rec && rec.text ? String(rec.text) : '';
      const short = text.length > 160 ? (text.slice(0,160) + 'â€¦') : text;

      const row = document.createElement('div');
      row.style.cssText = [
        'display:flex','align-items:flex-start','gap:10px',
        'padding:12px','border:1px solid #e2e8f0','border-radius:12px',
        'background:#ffffff','box-shadow:0 6px 16px rgba(2,6,23,.06)'
      ].join(';');

      row.innerHTML = `
        <div style="padding-top:3px;">
          <input type="checkbox" class="misc-log-check" data-id="${escapeHtml(id)}" />
        </div>
        <div style="flex:1; min-width:0;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div style="font-weight:700; color:#0f172a; font-size:13px;">
              ğŸ§¾ è®°å½• <span style="opacity:.7;">(${escapeHtml(time)})</span>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button type="button" class="btn btn-secondary" data-action="edit" data-id="${escapeHtml(id)}">âœï¸ ç¼–è¾‘</button>
              <button type="button" class="btn btn-secondary" data-action="del" data-id="${escapeHtml(id)}">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
          </div>
          <div style="margin-top:8px; white-space:pre-wrap; word-break:break-word; color:#111827; font-size:14px; line-height:1.6;">
            ${escapeHtml(short)}
          </div>
        </div>
      `;

      row.addEventListener('click', (e)=>{
        const btn = e.target && e.target.closest ? e.target.closest('button[data-action]') : null;
        if(!btn) return;
        const action = btn.getAttribute('data-action');
        const rid = btn.getAttribute('data-id');
        if(action === 'edit') api.openEdit(rid);
        if(action === 'del') api.deleteOne(rid);
      });

      listEl.appendChild(row);
    });
  }

  function ensureShowModal(){
    // ä¼˜å…ˆç”¨é¡µé¢è‡ªå¸¦ showModalï¼›æ²¡æœ‰å°±é™çº§ alert/confirm
    return (typeof window.showModal === 'function');
  }

  function showConfirm({title, message, onConfirm}){
    if(ensureShowModal()){
      window.showModal({
        type:'warning',
        title: title || 'ç¡®è®¤',
        message: `<div style="font-size:14px; line-height:1.6;">${message || ''}</div>`,
        confirmText:'ç¡®å®š',
        cancelText:'å–æ¶ˆ',
        showCancel:true,
        showConfirm:true,
        onConfirm: ()=>{ try{ onConfirm && onConfirm(); }catch(e){} }
      });
      return;
    }
    if(confirm((title? (title+'\n\n') : '') + (message||''))){
      try{ onConfirm && onConfirm(); }catch(e){}
    }
  }

  function openEditor({mode, id, initialText}){
    const modalId = 'miscLogEditorText';
    const safeInit = escapeHtml(initialText || '');
    const title = mode === 'edit' ? 'âœï¸ ç¼–è¾‘æ‚äº‹è®°å½• (Edit Misc Log)' : 'â• æ–°å¢æ‚äº‹è®°å½• (Add Misc Log)';
    const bodyHtml = `
      <div style="display:flex; flex-direction:column; gap:10px;">
        <div style="font-size:13px; color:#475569;">
          æ”¯æŒé•¿æ–‡æœ¬ï¼›å¼¹çª—å¯ä¸Šä¸‹æ»‘åŠ¨ã€‚
        </div>
        <textarea id="${modalId}" class="misc-log-editor"
          style="width:100%; min-height:220px; max-height:55vh; resize:vertical; padding:12px; border:1px solid #cbd5e1; border-radius:10px; font-size:14px; line-height:1.6;"
          placeholder="è¯·è¾“å…¥è®°å½•å†…å®¹â€¦">${safeInit}</textarea>
        <div style="font-size:12px; color:#64748b;">
          æç¤ºï¼šå†…å®¹ä¼šè‡ªåŠ¨è¿›å…¥å½“æ—¥æ•°æ®å¿«ç…§ï¼ˆç”¨äºäº‘ç«¯åŒæ­¥/è·¨è®¾å¤‡æ¢å¤ï¼‰ã€‚
        </div>
      </div>
    `;

    const doSave = ()=>{
      const ta = document.getElementById(modalId);
      const text = ta ? String(ta.value || '').trim() : '';
      if(!text){
        try{ window.tpiToast ? window.tpiToast('âš ï¸ å†…å®¹ä¸ºç©ºï¼Œæœªä¿å­˜', 'warning') : alert('å†…å®¹ä¸ºç©º'); }catch(e){}
        return;
      }
      const dateStr = getSelectedDate();
      const records = loadRecords(dateStr);

      const nowIso = new Date().toISOString();
      if(mode === 'edit'){
        const idx = records.findIndex(r=>r && r.id === id);
        if(idx >= 0){
          records[idx].text = text;
          records[idx].updatedAt = nowIso;
        }
      } else {
        const rid = 'misc_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
        records.push({ id: rid, text, createdAt: nowIso, updatedAt: nowIso });
      }

      persistRecords(dateStr, records);
      render();
      try{ window.tpiToast ? window.tpiToast('âœ… å·²ä¿å­˜', 'success') : null; }catch(e){}
    };

    if(ensureShowModal()){
      window.showModal({
        type:'info',
        title,
        message: bodyHtml,
        confirmText:'ä¿å­˜',
        cancelText:'å–æ¶ˆ',
        showCancel:true,
        showConfirm:true,
        onConfirm: doSave
      });
      // è‡ªåŠ¨èšç„¦
      setTimeout(()=>{ const ta = document.getElementById(modalId); if(ta) ta.focus(); }, 60);
      return;
    }

    // é™çº§ï¼šprompt
    const v = prompt(title, initialText || '');
    if(v != null){
      openEditor({mode, id, initialText: v});
    }
  }

  const api = {
    openAdd: ()=> openEditor({mode:'add', id:null, initialText:''}),
    openEdit: (id)=>{
      const dateStr = getSelectedDate();
      const records = loadRecords(dateStr);
      const rec = records.find(r=>r && r.id === id);
      openEditor({mode:'edit', id, initialText: rec ? (rec.text||'') : ''});
    },
    deleteOne: (id)=>{
      showConfirm({
        title:'åˆ é™¤è®°å½•',
        message:'ç¡®å®šåˆ é™¤è¿™ä¸€æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
        onConfirm: ()=>{
          const dateStr = getSelectedDate();
          const records = loadRecords(dateStr).filter(r=>!(r && r.id === id));
          persistRecords(dateStr, records);
          render();
          try{ window.tpiToast ? window.tpiToast('âœ… å·²åˆ é™¤', 'success') : null; }catch(e){}
        }
      });
    },
    toggleSelectAll: (checked)=>{
      const checks = document.querySelectorAll('#misc-log-list .misc-log-check');
      checks.forEach(c=>{ c.checked = !!checked; });
    },
    deleteSelected: ()=>{
      const checks = Array.from(document.querySelectorAll('#misc-log-list .misc-log-check'))
        .filter(c=>c && c.checked)
        .map(c=>c.getAttribute('data-id'))
        .filter(Boolean);

      if(checks.length === 0){
        try{ window.tpiToast ? window.tpiToast('âš ï¸ æœªé€‰æ‹©ä»»ä½•è®°å½•', 'warning') : alert('æœªé€‰æ‹©ä»»ä½•è®°å½•'); }catch(e){}
        return;
      }

      showConfirm({
        title:'æ‰¹é‡åˆ é™¤',
        message:`ç¡®å®šåˆ é™¤å·²é€‰ä¸­çš„ <strong>${checks.length}</strong> æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
        onConfirm: ()=>{
          const dateStr = getSelectedDate();
          const records = loadRecords(dateStr).filter(r=>!(r && checks.includes(r.id)));
          persistRecords(dateStr, records);
          render();
          try{ window.tpiToast ? window.tpiToast('âœ… æ‰¹é‡åˆ é™¤å®Œæˆ', 'success') : null; }catch(e){}
        }
      });
    },
    render
  };

  window.MiscLog = api;

  function attachDateWatcher(){
    const di = document.getElementById('date-input') || document.querySelector('input[placeholder="ğŸ“… é€‰æ‹©æ—¥æœŸ"]');
    if(!di) return;
    if(di.__miscLogBound) return;
    di.__miscLogBound = true;
    di.addEventListener('change', ()=>{ try{ render(); }catch(e){} }, {passive:true});
    di.addEventListener('input',  ()=>{ try{ render(); }catch(e){} }, {passive:true});
  }

  function init(){
    try{ attachDateWatcher(); }catch(e){}
    try{ render(); }catch(e){}
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  } else {
    init();
  }
})();
</script>

<!-- ===================== ç¬¬22ç‰ˆä¿®å¤è¡¥ä¸ - åˆ†æ•°çœ‹æ¿FLIå’Œå¯¼èˆªå¢å¼º ===================== -->
<script>
(function() {
    'use strict';
    console.log('ğŸ”§ [ä¿®å¤è¡¥ä¸] å¼€å§‹åŠ è½½ç¬¬22ç‰ˆä¿®å¤è¡¥ä¸...');

    // ===== ä¿®å¤1: ç¡®ä¿ScoreDashboardæ­£ç¡®æ›´æ–°FLIåˆ†æ•° =====
    if (window.ScoreDashboard) {
        const originalUpdate = window.ScoreDashboard.update;
        window.ScoreDashboard.update = function() {
            try {
                // è·å–å„æ¨¡å—åˆ†æ•°ï¼ˆåŒ…æ‹¬FLIï¼‰
                const amiScore = this.getScore('ami-score');
                const bcmScore = this.getScore('bcm-total-score');
                const logisticsScore = this.getScore('logistics-score');
                const hsmScore = this.getScore('hsm-score');
                const fliScore = this.getScore('fli-score');
                const bonusScore = this.getScore('bonus-score');
                
                // è®¡ç®—TPIæ€»åˆ†ï¼ˆåŒ…æ‹¬FLIï¼‰
                const tpiTotal = amiScore + bcmScore + logisticsScore + hsmScore + fliScore + bonusScore;
                
                // æ›´æ–°çœ‹æ¿æ˜¾ç¤º
                this.updateElement('dashboard-ami', amiScore.toFixed(1));
                this.updateElement('dashboard-bcm', bcmScore.toFixed(1));
                this.updateElement('dashboard-logistics', logisticsScore.toFixed(1));
                this.updateElement('dashboard-hsm', hsmScore.toFixed(1));
                this.updateElement('dashboard-fli', fliScore.toFixed(1));
                this.updateElement('dashboard-bonus', bonusScore.toFixed(1));
                this.updateElement('dashboard-total', tpiTotal.toFixed(1));
                
                // æ›´æ–°è¯„çº§
                this.updateRating(tpiTotal);
                
                console.log(`âœ… [åˆ†æ•°çœ‹æ¿] æ›´æ–°æˆåŠŸ: AMI=${amiScore}, BCM=${bcmScore}, LOG=${logisticsScore}, HSM=${hsmScore}, FLI=${fliScore}, BONUS=${bonusScore}, Total=${tpiTotal}`);
            } catch (error) {
                console.error('âŒ [åˆ†æ•°çœ‹æ¿] æ›´æ–°å¤±è´¥:', error);
            }
        };
        
        // ç«‹å³æ›´æ–°ä¸€æ¬¡
        setTimeout(() => {
            window.ScoreDashboard.update();
            console.log('âœ… [ä¿®å¤è¡¥ä¸] åˆ†æ•°çœ‹æ¿å·²æ›´æ–°');
        }, 500);
    }

    // ===== ä¿®å¤2: å¢å¼ºå¯¼èˆªè·³è½¬åŠŸèƒ½ =====
    window.addEventListener('DOMContentLoaded', function() {
        // ç­‰å¾…DOMå®Œå…¨åŠ è½½åå†æ£€æŸ¥å¯¼èˆª
        setTimeout(() => {
            const nav = document.getElementById('quickNavV17');
            if (nav) {
                const buttons = nav.querySelectorAll('.quick-nav-btn-v19');
                console.log(`âœ… [å¯¼èˆªæ£€æŸ¥] æ‰¾åˆ° ${buttons.length} ä¸ªå¯¼èˆªæŒ‰é’®`);
                
                buttons.forEach((btn, index) => {
                    console.log(`  æŒ‰é’® #${index + 1}: ${btn.textContent}`);
                });
                
                if (buttons.length === 0) {
                    console.warn('âš ï¸ [å¯¼èˆªè­¦å‘Š] æœªæ‰¾åˆ°ä»»ä½•å¯¼èˆªæŒ‰é’®ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç”Ÿæˆ');
                }
            } else {
                console.error('âŒ [å¯¼èˆªé”™è¯¯] æœªæ‰¾åˆ°å¯¼èˆªå®¹å™¨å…ƒç´ ');
            }
        }, 1000);
    });

    // ===== ä¿®å¤3: ç¡®ä¿æ‰€æœ‰åˆ†æ•°å˜åŒ–éƒ½è§¦å‘çœ‹æ¿æ›´æ–° =====
    document.addEventListener('DOMContentLoaded', function() {
        // ç›‘å¬æ‰€æœ‰å¯èƒ½å½±å“åˆ†æ•°çš„è¾“å…¥å…ƒç´ 
        const scoreInputIds = [
            'ami-score', 'bcm-total-score', 'logistics-score', 
            'hsm-score', 'fli-score', 'bonus-score'
        ];
        
        scoreInputIds.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                ['input', 'change', 'blur'].forEach(eventType => {
                    element.addEventListener(eventType, () => {
                        if (window.ScoreDashboard && window.ScoreDashboard.update) {
                            setTimeout(() => window.ScoreDashboard.update(), 100);
                        }
                    });
                });
                console.log(`âœ… [åˆ†æ•°ç›‘å¬] å·²ç»‘å®šç›‘å¬å™¨åˆ°: ${id}`);
            }
        });
    });

    // ===== ä¿®å¤4: å®šæœŸè‡ªåŠ¨åˆ·æ–°çœ‹æ¿ï¼ˆå¤‡ç”¨æœºåˆ¶ï¼‰ =====
    setInterval(() => {
        if (window.ScoreDashboard && window.ScoreDashboard.update) {
            window.ScoreDashboard.update();
        }
    }, 3000);

    console.log('âœ… [ä¿®å¤è¡¥ä¸] ç¬¬22ç‰ˆä¿®å¤è¡¥ä¸åŠ è½½å®Œæˆ');
})();
</script>


  <script>
  /* =========================================================
     é¡¶éƒ¨åˆ†æ•°çœ‹æ¿ Â· è½»é‡å®æ—¶åŒæ­¥è¡¥ä¸ï¼ˆä¸æ”¹ä¸šåŠ¡é€»è¾‘ï¼‰
     - è¯»å–ç°æœ‰åˆ†æ•°å­—æ®µï¼šma7-score / ami-score / fli-score / sys-score / bonus-score / tpi-total / tpi-rating
     - ç›‘å¬ input/change + å…œåº•è½®è¯¢ï¼Œç¡®ä¿ä¸ TPI ä»ªè¡¨ç›˜/å®æ—¶åˆ†æ•°åŒæ­¥
  ========================================================= */
  (function(){
    'use strict';

    function num(v){
      const n = parseFloat(String(v ?? '').trim());
      return isNaN(n) ? 0 : n;
    }
    function readScore(id){
      const el = document.getElementById(id);
      if (!el) return 0;
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') return num(el.value);
      return num(el.textContent);
    }
    function setText(id, v){
      const el = document.getElementById(id);
      if (!el) return;
      const s = (typeof v === 'number') ? (Math.round(v*10)/10).toFixed(1) : String(v ?? '');
      if (el.textContent !== s) el.textContent = s;
    }

    function getRatingText(){
      const sel = document.getElementById('tpi-rating');
      if (!sel) return '';
      try{
        // select -> å– option æ–‡æ¡ˆï¼›input -> å– value
        if (sel.tagName === 'SELECT'){
          const opt = sel.options && sel.selectedIndex >= 0 ? sel.options[sel.selectedIndex] : null;
          return (opt && opt.textContent) ? opt.textContent.trim() : String(sel.value || '').trim();
        }
        return String(sel.value || '').trim();
      }catch(e){
        return String(sel.value || '').trim();
      }
    }

    function setRatingPill(text, total){
      const el = document.getElementById('ts-rating');
      if (!el) return;
      const t = String(text || '').trim();
      // å¦‚æœ select æ²¡æœ‰æ–‡æ¡ˆï¼Œåˆ™ç”¨æ€»åˆ†è§„åˆ™ç”Ÿæˆï¼ˆä¿æŒä¸€è‡´ã€ä¸ä¸­æ–­ï¼‰
      let label = t;
      if (!label){
        const x = num(total);
        if (x >= 201) label = 'âš ï¸ è¿‡è½½ (Overload)';
        else if (x >= 156) label = 'ğŸ† å“è¶Š (Excellence)';
        else if (x >= 121) label = 'ğŸ“ˆ æ¨è¿› (Steady)';
        else if (x >= 95) label = 'âœ… ç»´æŒ (Baseline)';
        else label = 'ğŸ”§ ç»´æŠ¤ (Maintenance)';
      }
      el.textContent = label;

      // è½»é‡ä¸Šè‰²ï¼ˆä¸ä¾èµ–ä¸»é¢˜ç³»ç»Ÿï¼‰
      el.classList.remove('is-overload','is-excellent','is-steady','is-baseline','is-maintenance');
      const s = label.toLowerCase();
      if (s.includes('overload') || label.includes('è¿‡è½½')) el.classList.add('is-overload');
      else if (s.includes('excellence') || label.includes('å“è¶Š')) el.classList.add('is-excellent');
      else if (s.includes('steady') || label.includes('æ¨è¿›')) el.classList.add('is-steady');
      else if (s.includes('baseline') || label.includes('ç»´æŒ')) el.classList.add('is-baseline');
      else el.classList.add('is-maintenance');
    }

    function update(){
      // ç»„ä»¶åˆ†æ•°ï¼šä¸¥æ ¼â€œè¯»å–ç°æœ‰å­—æ®µâ€ï¼Œé¿å…ä¸ä¸šåŠ¡ç®—åˆ†é‡å¤
      const ma7 = readScore('ma7-score');
      const ami = readScore('ami-score');
      const fli = readScore('fli-score');
      const sys = readScore('sys-score');
      const bonus = readScore('bonus-score');

      // æ€»åˆ†ï¼šä¸¥æ ¼è·Ÿéš TPI ä»ªè¡¨ç›˜çš„ä¸šåŠ¡æ€»åˆ†ï¼ˆtpi-totalï¼‰
// ä»…å½“ tpi-total ä¸å­˜åœ¨/ä¸ºç©º/éæ•°å­—æ—¶ï¼Œæ‰ç”¨ç»„ä»¶æ±‚å’Œä½œä¸ºâ€œå…œåº•æ˜¾ç¤ºâ€ï¼ˆä¸æŠŠ 0 å½“æˆå¼‚å¸¸ï¼‰
      const totalEl = document.getElementById('tpi-total');
      let totalRaw = '';
      if (totalEl){
        totalRaw = (totalEl.tagName === 'INPUT' || totalEl.tagName === 'TEXTAREA' || totalEl.tagName === 'SELECT')
          ? String(totalEl.value ?? '')
          : String(totalEl.textContent ?? '');
        totalRaw = totalRaw.trim();
      }
      const sum = ma7 + ami + fli + sys + bonus;

      // å¤„ç† PAUSED / â€” ç­‰éæ•°å­—å±•ç¤ºï¼šä¿æŒåŒæ­¥æ˜¾ç¤ºåŸæ–‡
      const totalNum = num(totalRaw);
      const hasNumeric = totalRaw !== '' && !isNaN(parseFloat(totalRaw)) && isFinite(totalNum);

      let total = null; // number|null è¡¨ç¤ºæ˜¯å¦æ•°å€¼
      if (totalEl && totalRaw && !hasNumeric){
        // éæ•°å­—ï¼ˆä¾‹å¦‚ PAUSEDï¼‰ï¼šä¿æŒåŸæ ·
        total = null;
      } else if (totalEl && (totalRaw === '' || !hasNumeric)){
        // ç©º/ç¼ºå¤±ï¼šå…œåº•ä¸º sumï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼Œä¸å›å†™ä¸šåŠ¡å­—æ®µï¼‰
        total = sum;
      } else {
        // æ­£å¸¸æ•°å€¼ï¼ˆåŒ…æ‹¬ 0ï¼‰ï¼šå®Œå…¨ä¿¡ä»»ä¸šåŠ¡
        total = totalNum;
      }

      setText('ts-ma7', ma7);
      setText('ts-ami', ami);
      setText('ts-fli', fli);
      setText('ts-sys', sys);
      setText('ts-bonus', bonus);

      // æ€»åˆ†æ˜¾ç¤ºï¼šè‹¥ä¸šåŠ¡æ€»åˆ†ä¸ºéæ•°å­—ï¼ˆå¦‚ PAUSEDï¼‰ï¼Œåˆ™åŸæ ·æ˜¾ç¤ºï¼›å¦åˆ™æŒ‰æ•°å€¼æ˜¾ç¤º
      if (total === null){
        const el = document.getElementById('ts-total');
        if (el) el.textContent = totalRaw || 'â€”';
      } else {
        setText('ts-total', total);
      }

      setRatingPill(getRatingText(), (total === null ? 0 : total));

      // è‹¥é¡µé¢ä»å­˜åœ¨æ—§ ScoreDashboardï¼ˆå…¶ä»–æ¨¡æ¿/å¯¼å‡ºç”¨ï¼‰ï¼Œåˆ™é¡ºä¾¿æ›´æ–°ï¼Œä¿æŒä¸€è‡´ï¼ˆä¸å¼ºåˆ¶ï¼‰
      try{
        if (window.ScoreDashboard && typeof window.ScoreDashboard.update === 'function'){
          window.ScoreDashboard.update();
        }
      }catch(e){}
    }

    function init(){
      // åˆå§‹åˆ·æ–°
      update();

      // ç›‘å¬è¾“å…¥å˜åŒ–ï¼ˆæ•è·é˜¶æ®µï¼Œä¸å½±å“åŸæœ‰ç›‘å¬å™¨ï¼‰
      document.addEventListener('input', function(e){
        const t = e && e.target;
        if (t && t.id && t.id.startsWith('github-')) return; // ä¸å› é…ç½®è¾“å…¥æ‰°åŠ¨
        update();
      }, true);

      document.addEventListener('change', function(e){
        const t = e && e.target;
        if (t && t.id && t.id.startsWith('github-')) return;
        update();
      }, true);

      // å…œåº•è½®è¯¢ï¼šè¦†ç›–â€œè„šæœ¬å†™å€¼ä½†ä¸è§¦å‘äº‹ä»¶â€çš„æƒ…å†µ
      setInterval(update, 1200);

      // å¦‚æœå­˜åœ¨ TPI.calculateTPIï¼Œåˆ™åŒ…è£…ï¼šæ¯æ¬¡ç®—åˆ†åæ›´æ–°çœ‹æ¿ï¼ˆåªåŒ…ä¸€æ¬¡ï¼‰
      const tryWrap = function(){
        try{
          if (!window.TPI || typeof window.TPI.calculateTPI !== 'function') return false;
          if (window.TPI.__topScoreboardWrapped__) return true;
          const old = window.TPI.calculateTPI;
          window.TPI.calculateTPI = function(){
            const r = old.apply(this, arguments);
            try{ update(); }catch(e){}
            return r;
          };
          window.TPI.__topScoreboardWrapped__ = true;
          return true;
        }catch(e){ return false; }
      };
      if (!tryWrap()){
        // ç­‰å¾…ä¸šåŠ¡å¯¹è±¡æŒ‚è½½
        const timer = setInterval(function(){
          if (tryWrap()) clearInterval(timer);
        }, 400);
        setTimeout(function(){ clearInterval(timer); }, 15000);
      }
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init, { once:true });
    } else {
      init();
    }

    // æš´éœ²ç»™è°ƒè¯•/å…¶ä»–æ¨¡å—(å¯é€‰)
    window.TopScoreboard = { update };
  })();
  </script>

<script>
/* =========================================================
   åç«¯é›†æˆæ ¸å¿ƒåŠŸèƒ½
   - å®æ—¶åŒæ­¥åˆ°äº‘ç«¯
   - ä»äº‘ç«¯ä¸‹è½½å†å²æ•°æ®
   - é”™è¯¯å¤„ç†ä¸ç”¨æˆ·åé¦ˆ
========================================================= */

// Toast é€šçŸ¥å‡½æ•°
window.tpiToast = function(message, type = 'info') {
  // åˆ›å»º toast å…ƒç´ 
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    bottom: 30px;
    right: 30px;
    padding: 15px 25px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    font-size: 14px;
    z-index: 10000;
    animation: slideInToast 0.3s ease-out;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  `;
  
  // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
  const colors = {
    success: 'linear-gradient(135deg, #10b981, #059669)',
    error: 'linear-gradient(135deg, #ef4444, #dc2626)',
    warning: 'linear-gradient(135deg, #f59e0b, #d97706)',
    info: 'linear-gradient(135deg, #3b82f6, #2563eb)'
  };
  
  toast.style.background = colors[type] || colors.info;
  toast.textContent = message;
  
  document.body.appendChild(toast);
  
  // 3ç§’åç§»é™¤
  setTimeout(() => {
    toast.style.animation = 'slideInToast 0.3s ease-out reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
};

// æ·»åŠ åŠ¨ç”»æ ·å¼
if (!document.getElementById('toast-animation-styles')) {
  const style = document.createElement('style');
  style.id = 'toast-animation-styles';
  style.textContent = `
    @keyframes slideInToast {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  `;
  document.head.appendChild(style);
}

// åŒæ­¥çŠ¶æ€æ›´æ–°å‡½æ•°
function updateSyncStatusDisplay(message, isError = false) {
  // åœ¨æ§åˆ¶å°è®°å½•
  console.log(isError ? 'âŒ' : 'âœ…', '[åŒæ­¥çŠ¶æ€]', message);
}

// åŒæ­¥åˆ°äº‘ç«¯å‡½æ•°
window.syncToCloud = async function() {
  try {
    updateSyncStatusDisplay('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...', false);
    window.tpiToast('ğŸ”„ æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...', 'info');
    
    // æ”¶é›†å½“å‰æ—¥æœŸçš„å®Œæ•´æ•°æ®
    const fullData = window.collectDailyData();
    const dateKey = Object.keys(fullData)[0];
    const data = fullData[dateKey];
    
    if (!dateKey || !data) {
      throw new Error('æ— æ³•æ”¶é›†æ•°æ®,è¯·æ£€æŸ¥æ—¥æœŸé€‰æ‹©');
    }
    
    console.log('ğŸ“¤ å‡†å¤‡ä¸Šä¼ æ•°æ®:', { date: dateKey, dataSize: JSON.stringify(data).length });
    
    // å‘é€åˆ°åç«¯
    const response = await fetch(`${BACKEND_URL}/api/tpi`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        date: dateKey,
        data: data
      })
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯ (${response.status}): ${errorText}`);
    }
    
    const result = await response.json();
    console.log('âœ… ä¸Šä¼ æˆåŠŸ:', result);
    
    // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°ä½œä¸ºå¤‡ä»½
    localStorage.setItem(`tpi_data_${dateKey}`, JSON.stringify(data));
    
    updateSyncStatusDisplay('åŒæ­¥æˆåŠŸ', false);
    window.tpiToast('âœ… æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°äº‘ç«¯', 'success');
    
  } catch (error) {
    console.error('âŒ åŒæ­¥å¤±è´¥:', error);
    updateSyncStatusDisplay(`åŒæ­¥å¤±è´¥: ${error.message}`, true);
    window.tpiToast(`âŒ åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
  }
};

// ä»äº‘ç«¯ä¸‹è½½å†å²æ•°æ®å‡½æ•°
window.downloadFromCloud = async function() {
  try {
    updateSyncStatusDisplay('æ­£åœ¨ä»äº‘ç«¯ä¸‹è½½å†å²æ•°æ®...', false);
    window.tpiToast('ğŸ“¥ æ­£åœ¨ä¸‹è½½å†å²æ•°æ®...', 'info');
    
    console.log('ğŸ“¥ å¼€å§‹ä¸‹è½½å†å²æ•°æ®...');
    
    // ä»åç«¯è·å–å†å²æ•°æ®
    const response = await fetch(`${BACKEND_URL}/api/tpi/history`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯ (${response.status}): ${errorText}`);
    }
    
    const historyData = await response.json();
    console.log('âœ… ä¸‹è½½æˆåŠŸ,æ•°æ®æ¡æ•°:', Object.keys(historyData).length);
    
    if (Object.keys(historyData).length === 0) {
      window.tpiToast('â„¹ï¸ äº‘ç«¯æš‚æ— å†å²æ•°æ®', 'info');
      updateSyncStatusDisplay('äº‘ç«¯æ— æ•°æ®', false);
      return;
    }
    
    // åˆå¹¶åˆ°æœ¬åœ°å­˜å‚¨(ä¸è¦†ç›–æœ¬åœ°æœªåŒæ­¥çš„æ–°æ•°æ®)
    let mergedCount = 0;
    Object.keys(historyData).forEach(dateKey => {
      const cloudData = historyData[dateKey];
      const localKey = `tpi_data_${dateKey}`;
      
      // æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²æœ‰è¯¥æ—¥æœŸçš„æ•°æ®
      const localData = localStorage.getItem(localKey);
      
      if (!localData) {
        // æœ¬åœ°æ— æ•°æ®,ç›´æ¥å†™å…¥
        localStorage.setItem(localKey, JSON.stringify(cloudData));
        mergedCount++;
        console.log(`ğŸ“ å†™å…¥æ–°æ•°æ®: ${dateKey}`);
      } else {
        // æœ¬åœ°æœ‰æ•°æ®,æ¯”è¾ƒæ—¶é—´æˆ³å†³å®šæ˜¯å¦è¦†ç›–
        try {
          const localObj = JSON.parse(localData);
          const cloudTimestamp = new Date(cloudData._timestamp || 0).getTime();
          const localTimestamp = new Date(localObj._timestamp || 0).getTime();
          
          if (cloudTimestamp > localTimestamp) {
            localStorage.setItem(localKey, JSON.stringify(cloudData));
            mergedCount++;
            console.log(`ğŸ”„ æ›´æ–°æ•°æ®(äº‘ç«¯è¾ƒæ–°): ${dateKey}`);
          } else {
            console.log(`â­ï¸  è·³è¿‡(æœ¬åœ°è¾ƒæ–°): ${dateKey}`);
          }
        } catch (e) {
          console.warn(`âš ï¸  è§£ææœ¬åœ°æ•°æ®å¤±è´¥,è·³è¿‡: ${dateKey}`, e);
        }
      }
    });
    
    updateSyncStatusDisplay('å†å²æ•°æ®å·²æ¢å¤', false);
    window.tpiToast(`âœ… æˆåŠŸæ¢å¤ ${mergedCount} æ¡å†å²æ•°æ®,é¡µé¢å³å°†åˆ·æ–°`, 'success');
    
    // å»¶è¿Ÿåˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæœ€æ–°æ•°æ®
    setTimeout(() => {
      location.reload();
    }, 2000);
    
  } catch (error) {
    console.error('âŒ ä¸‹è½½å¤±è´¥:', error);
    updateSyncStatusDisplay(`ä¸‹è½½å¤±è´¥: ${error.message}`, true);
    window.tpiToast(`âŒ ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
  }
};

// é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå°±ç»ªçŠ¶æ€
document.addEventListener('DOMContentLoaded', () => {
  updateSyncStatusDisplay('äº‘ç«¯åŒæ­¥å°±ç»ª', false);
  console.log('âœ… åç«¯é›†æˆæ¨¡å—å·²åŠ è½½,åç«¯åœ°å€:', BACKEND_URL);
});

console.log('âœ… åç«¯é›†æˆæ ¸å¿ƒåŠŸèƒ½å·²åŠ è½½');
</script>

<script>
/* =========================================================
   åŒæ­¥æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨ - ç”Ÿäº§çº§ä¼˜åŒ–
   ç›®æ ‡ï¼šä¸ºä¸¤ä¸ªåŒæ­¥æŒ‰é’®ç»‘å®šçœŸå®çš„APIè°ƒç”¨èƒ½åŠ›
========================================================= */

// 1. ç»‘å®šã€Œç«‹å³åŒæ­¥åˆ°äº‘ç«¯ã€æŒ‰é’®
document.addEventListener('DOMContentLoaded', () => {
  const uploadBtn = document.getElementById('sync-upload-btn');
  if (uploadBtn) {
    uploadBtn.addEventListener('click', async () => {
      const today = new Date().toISOString().split('T')[0];
      const tpiData = JSON.parse(localStorage.getItem('tpiData') || '{}');
      
      // æ£€æŸ¥ä»Šæ—¥æ˜¯å¦æœ‰æ•°æ®
      if (!tpiData[today]) {
        alert('âš ï¸ ä»Šæ—¥æ— æ•°æ®ï¼Œæ— æ³•åŒæ­¥');
        console.warn('[åŒæ­¥] ä»Šæ—¥æ— æ•°æ®:', today);
        return;
      }
      
      try {
        console.log('[åŒæ­¥] å¼€å§‹ä¸Šä¼ :', { date: today, dataKeys: Object.keys(tpiData[today]) });
        
        const res = await fetch(`${BACKEND_URL}/api/tpi`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: today, data: tpiData[today] })
        });
        
        if (res.ok) {
          alert('âœ… åŒæ­¥æˆåŠŸï¼');
          console.log('[åŒæ­¥] ä¸Šä¼ æˆåŠŸ:', today);
        } else {
          const errorText = await res.text().catch(() => 'æ— æ³•è·å–é”™è¯¯è¯¦æƒ…');
          alert(`âŒ åŒæ­¥å¤±è´¥ï¼šHTTP ${res.status}`);
          console.error('[åŒæ­¥] ä¸Šä¼ å¤±è´¥:', res.status, errorText);
        }
      } catch (err) {
        alert('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦åœ¨çº¿');
        console.error('[åŒæ­¥] ç½‘ç»œé”™è¯¯:', err);
      }
    });
    console.log('âœ… [äº‹ä»¶] sync-upload-btn å·²ç»‘å®š');
  } else {
    console.warn('âš ï¸ [äº‹ä»¶] æœªæ‰¾åˆ° sync-upload-btn');
  }
  
  // 2. ç»‘å®šã€Œä»äº‘ç«¯ä¸‹è½½å†å²ã€æŒ‰é’®
  const downloadBtn = document.getElementById('sync-download-btn');
  if (downloadBtn) {
    downloadBtn.addEventListener('click', async () => {
      try {
        console.log('[ä¸‹è½½] å¼€å§‹è·å–äº‘ç«¯å†å²æ•°æ®...');
        
        const res = await fetch(`${BACKEND_URL}/api/tpi/history`);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        
        const remoteData = await res.json();
        console.log('[ä¸‹è½½] äº‘ç«¯æ•°æ®æ¡æ•°:', Object.keys(remoteData).length);
        
        if (Object.keys(remoteData).length === 0) {
          alert('â„¹ï¸ äº‘ç«¯æš‚æ— å†å²æ•°æ®');
          return;
        }
        
        const localData = JSON.parse(localStorage.getItem('tpiData') || '{}');
        
        // åˆå¹¶ç­–ç•¥ï¼šä¿ç•™æœ¬åœ°æœªåŒæ­¥çš„æ–°æ•°æ®ï¼Œç”¨äº‘ç«¯è¦†ç›–æ—§æ•°æ®
        const merged = { ...remoteData, ...localData };
        
        localStorage.setItem('tpiData', JSON.stringify(merged));
        console.log('[ä¸‹è½½] æ•°æ®å·²åˆå¹¶åˆ°æœ¬åœ°ï¼Œæ€»è®¡:', Object.keys(merged).length, 'æ¡');
        
        alert('âœ… å†å²æ•°æ®å·²æ¢å¤ï¼é¡µé¢å³å°†åˆ·æ–°');
        
        // å»¶è¿Ÿåˆ·æ–°ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
        setTimeout(() => {
          location.reload();
        }, 1500);
        
      } catch (err) {
        alert('âŒ ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åç«¯çŠ¶æ€');
        console.error('[ä¸‹è½½] é”™è¯¯:', err);
      }
    });
    console.log('âœ… [äº‹ä»¶] sync-download-btn å·²ç»‘å®š');
  } else {
    console.warn('âš ï¸ [äº‹ä»¶] æœªæ‰¾åˆ° sync-download-btn');
  }
});

console.log('âœ… åŒæ­¥æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²åŠ è½½');

// === äº‘ç«¯åŒæ­¥é€»è¾‘ ===
document.getElementById('sync-upload-btn')?.addEventListener('click', async () => {
  const today = new Date().toISOString().split('T')[0];
  const tpiData = JSON.parse(localStorage.getItem('tpiData') || '{}');
  if (!tpiData[today]) return alert('âš ï¸ ä»Šæ—¥æ— æ•°æ®');
  try {
    const res = await fetch(`${BACKEND_URL}/api/tpi`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ date: today, data: tpiData[today] })
    });
    alert(res.ok ? 'âœ… åŒæ­¥æˆåŠŸï¼' : 'âŒ åŒæ­¥å¤±è´¥');
  } catch (e) { alert('âŒ ç½‘ç»œé”™è¯¯'); }
});

document.getElementById('sync-download-btn')?.addEventListener('click', async () => {
  try {
    const res = await fetch(`${BACKEND_URL}/api/tpi/history`);
    const remote = await res.json();
    const local = JSON.parse(localStorage.getItem('tpiData') || '{}');
    localStorage.setItem('tpiData', JSON.stringify({ ...local, ...remote }));
    location.reload();
  } catch (e) { alert('âŒ ä¸‹è½½å¤±è´¥'); }
});

</script>
</body>
</html>
